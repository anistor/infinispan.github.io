<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]--> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <meta name="generator" content="Asciidoctor 1.5.3"> <meta name="author" content="Manik Surtani, Mircea Markus, Galder ZamarreÃ±o, Pete Muir, and others from the Infinispan community"> <title>Infinispan 8.2 User Guide</title> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"> <style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css"> <style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style> <link rel="canonical" href="http://infinispan.org/docs/stable/user_guide/user_guide.html"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/themes/default/style.min.css"> <link rel="stylesheet" href="../css/css.css"> <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/jstree.min.js"></script> <script src="../js/js.js"></script> </head> <body class="book toc2 toc-left"> <div id="header"> <h1>Infinispan 8.2 User Guide</h1> <div class="details"> <span id="author" class="author">Manik Surtani, Mircea Markus, Galder ZamarreÃ±o, Pete Muir, and others from the Infinispan community</span><br> </div> <div id="toc" class="toc2"> <div id="toctitle">Table of Contents</div> <ul class="sectlevel1"> <li><a href="#configuring_cache">1. Configuring cache</a> <ul class="sectlevel2"> <li><a href="#configuring_cache_declaratively">1.1. Configuring Cache declaratively</a></li> <li><a href="#configuring_cache_programmatically">1.2. Configuring cache programmatically</a> <ul class="sectlevel3"> <li><a href="#configurationbuilder_programmatic_configuration_api">1.2.1. ConfigurationBuilder Programmatic Configuration API</a></li> <li><a href="#advanced_programmatic_configuration">1.2.2. Advanced programmatic configuration</a></li> </ul> </li> <li><a href="#configuration_migration_tools">1.3. Configuration Migration Tools</a></li> <li><a href="#clustered_configuration">1.4. Clustered Configuration</a> <ul class="sectlevel3"> <li><a href="#using_an_external_jgroups_file">1.4.1. Using an external JGroups file</a></li> <li><a href="#use_one_of_the_pre_configured_jgroups_files">1.4.2. Use one of the pre-configured JGroups files</a></li> <li><a href="#further_reading">1.4.3. Further reading</a></li> </ul> </li> </ul> </li> <li><a href="#the_cachemanager_api">2. The CacheManager API</a> <ul class="sectlevel2"> <li><a href="#clustering_information">2.1. Clustering Information</a> <ul class="sectlevel3"> <li><a href="#member_information">2.1.1. Member Information</a></li> <li><a href="#other_methods">2.1.2. Other methods</a></li> </ul> </li> <li><a href="#cluster_executor">2.2. Cluster Executor</a> <ul class="sectlevel3"> <li><a href="#example_dynamically_start_and_stop_clustered_cache">2.2.1. Example: Dynamically Start and Stop Clustered Cache</a></li> </ul> </li> </ul> </li> <li><a href="#the_cache_apis">3. The Cache APIs</a> <ul class="sectlevel2"> <li><a href="#the_cache_interface">3.1. The Cache interface</a> <ul class="sectlevel3"> <li><a href="#performance_concerns_of_certain_map_methods">3.1.1. Performance Concerns of Certain Map Methods</a></li> <li><a href="#mortal_and_immortal_data">3.1.2. Mortal and Immortal Data</a></li> <li><a href="#example_of_using_expiry_and_mortal_data">3.1.3. Example of Using Expiry and Mortal Data</a></li> <li><a href="#putforexternalread_operation">3.1.4. putForExternalRead operation</a></li> </ul> </li> <li><a href="#the_advancedcache_interface">3.2. The AdvancedCache interface</a> <ul class="sectlevel3"> <li><a href="#flags">3.2.1. Flags</a></li> <li><a href="#entry_retrieval">3.2.2. Entry Retrieval</a></li> <li><a href="#custom_interceptors">3.2.3. Custom Interceptors</a></li> </ul> </li> <li><a href="#_Listeners_and_notifications_section">3.3. Listeners and Notifications</a> <ul class="sectlevel3"> <li><a href="#cache_level_notifications">3.3.1. Cache-level notifications</a></li> <li><a href="#cache_manager_level_notifications">3.3.2. Cache manager-level notifications</a></li> <li><a href="#synchronicity_of_events">3.3.3. Synchronicity of events</a></li> </ul> </li> <li><a href="#asynchronous_api">3.4. Asynchronous API</a> <ul class="sectlevel3"> <li><a href="#why_use_such_an_api">3.4.1. Why use such an API?</a></li> <li><a href="#which_processes_actually_happen_asynchronously">3.4.2. Which processes actually happen asynchronously?</a></li> <li><a href="#notifying_futures">3.4.3. Notifying futures</a></li> <li><a href="#further_reading_2">3.4.4. Further reading</a></li> </ul> </li> <li><a href="#invocation_flags">3.5. Invocation Flags</a> <ul class="sectlevel3"> <li><a href="#decoratedcache">3.5.1. DecoratedCache</a></li> <li><a href="#examples">3.5.2. Examples</a></li> </ul> </li> <li><a href="#tree_api_module">3.6. Tree API Module</a> <ul class="sectlevel3"> <li><a href="#what_is_tree_api_about">3.6.1. What is Tree API about?</a></li> <li><a href="#using_the_tree_api">3.6.2. Using the Tree API</a></li> <li><a href="#creating_a_tree_cache">3.6.3. Creating a Tree Cache</a></li> <li><a href="#manipulating_data_in_a_tree_cache">3.6.4. Manipulating data in a Tree Cache</a></li> <li><a href="#common_operations">3.6.5. Common Operations</a></li> <li><a href="#locking_in_the_tree_api">3.6.6. Locking in the Tree API</a></li> <li><a href="#sid-68355037_TreeAPIModule-Listenersfortreecacheevents">3.6.7. Listeners for tree cache events</a></li> </ul> </li> </ul> </li> <li><a href="#eviction_anchor">4. Eviction</a> <ul class="sectlevel2"> <li><a href="#enabling_eviction">4.1. Enabling Eviction</a> <ul class="sectlevel3"> <li><a href="#eviction_strategies">4.1.1. Eviction strategies</a></li> <li><a href="#more_defaults">4.1.2. More defaults</a></li> </ul> </li> <li><a href="#expiration">4.2. Expiration</a> <ul class="sectlevel3"> <li><a href="#difference_between_eviction_and_expiration">4.2.1. Difference between Eviction and Expiration</a></li> </ul> </li> <li><a href="#eviction_examples">4.3. Eviction Examples</a> <ul class="sectlevel3"> <li><a href="#configuration">4.3.1. Configuration</a></li> <li><a href="#default_values">4.3.2. Default values</a></li> <li><a href="#using_expiration">4.3.3. Using expiration</a></li> </ul> </li> <li><a href="#eviction_designs">4.4. Eviction designs</a></li> </ul> </li> <li><a href="#persistence">5. Persistence</a> <ul class="sectlevel2"> <li><a href="#_Data_migration_section">5.1. Data Migration</a></li> <li><a href="#api">5.2. API</a></li> <li><a href="#configuration_2">5.3. Configuration</a></li> <li><a href="#cache-passivation">5.4. Cache Passivation</a> <ul class="sectlevel3"> <li><a href="#cache_loader_behavior_with_passivation_disabled_vs_enabled">5.4.1. Cache Loader Behavior with Passivation Disabled vs Enabled</a></li> </ul> </li> <li><a href="#cache_loaders_and_transactional_caches">5.5. Cache Loaders and transactional caches</a></li> <li><a href="#write_through_and_write_behind_caching">5.6. Write-Through And Write-Behind Caching</a> <ul class="sectlevel3"> <li><a href="#write_through_synchronous">5.6.1. Write-Through (Synchronous)</a></li> <li><a href="#write_behind_asynchronous">5.6.2. Write-Behind (Asynchronous)</a></li> </ul> </li> <li><a href="#filesystem_based_cache_stores">5.7. Filesystem based cache stores</a> <ul class="sectlevel3"> <li><a href="#single_file_store">5.7.1. Single File Store</a></li> <li><a href="#soft_index_file_store">5.7.2. Soft-Index File Store</a></li> </ul> </li> <li><a href="#jdbc_based_cache_loaders">5.8. JDBC based cache loaders</a> <ul class="sectlevel3"> <li><a href="#which_jdbc_cache_loader_should_i_use">5.8.1. Which JDBC cache loader should I use?</a></li> <li><a href="#connection_management_pooling">5.8.2. Connection management (pooling)</a></li> <li><a href="#sample_configurations">5.8.3. Sample configurations</a></li> </ul> </li> <li><a href="#remote_store">5.9. Remote store</a></li> <li><a href="#cluster_cache_loader">5.10. Cluster cache loader</a></li> <li><a href="#custom_cache_store_deployment">5.11. Custom Cache Store deployment</a></li> <li><a href="#command_line_interface_cache_loader">5.12. Command-Line Interface cache loader</a></li> <li><a href="#more_implementations">5.13. More implementations</a></li> </ul> </li> <li><a href="#leveldb_cache_store">6. LevelDB Cache Store</a> <ul class="sectlevel2"> <li><a href="#introduction">6.1. Introduction</a> <ul class="sectlevel3"> <li><a href="#sample_usage">6.1.1. Sample Usage</a></li> </ul> </li> <li><a href="#configuration_4">6.2. Configuration</a> <ul class="sectlevel3"> <li><a href="#sample_programatic_configuration">6.2.1. Sample Programatic Configuration</a></li> <li><a href="#sample_xml_configuration">6.2.2. Sample XML Configuration</a></li> </ul> </li> <li><a href="#additional_references">6.3. Additional References</a></li> </ul> </li> <li><a href="#rest_cache_store">7. REST Cache Store</a> <ul class="sectlevel2"> <li><a href="#introduction_2">7.1. Introduction</a></li> <li><a href="#javadoc">7.2. Javadoc</a></li> <li><a href="#configuration_5">7.3. Configuration</a></li> </ul> </li> <li><a href="#jpa_cache_store">8. JPA Cache Store</a> <ul class="sectlevel2"> <li><a href="#introduction_3">8.1. Introduction</a> <ul class="sectlevel3"> <li><a href="#sample_usage_2">8.1.1. Sample Usage</a></li> </ul> </li> <li><a href="#configuration_6">8.2. Configuration</a> <ul class="sectlevel3"> <li><a href="#sample_programatic_configuration_2">8.2.1. Sample Programatic Configuration</a></li> <li><a href="#sample_xml_configuration_2">8.2.2. Sample XML Configuration</a></li> </ul> </li> <li><a href="#additional_references_2">8.3. Additional References</a></li> <li><a href="#javadoc_2">8.4. Javadoc</a></li> </ul> </li> <li><a href="#transactions">9. Transactions</a> <ul class="sectlevel2"> <li><a href="#configuring_transactions">9.1. Configuring transactions</a></li> <li><a href="#transaction_modes">9.2. Transaction modes</a> <ul class="sectlevel3"> <li><a href="#optimistic_transactions">9.2.1. Optimistic Transactions</a></li> <li><a href="#pessimistic_transactions">9.2.2. Pessimistic Transactions</a></li> <li><a href="#backward_compatibility">9.2.3. Backward compatibility</a></li> <li><a href="#what_do_i_need_pessimistic_or_optimistic_transactions">9.2.4. What do I need - pessimistic or optimistic transactions?</a></li> </ul> </li> <li><a href="#deadlock_detection">9.3. Deadlock detection</a></li> <li><a href="#dealing_with_exceptions">9.4. Dealing with exceptions</a></li> <li><a href="#enlisting_synchronizations">9.5. Enlisting Synchronizations</a></li> <li><a href="#batching">9.6. Batching</a> <ul class="sectlevel3"> <li><a href="#configuring_batching">9.6.1. Configuring batching</a></li> <li><a href="#api_2">9.6.2. API</a></li> <li><a href="#batching_and_jta">9.6.3. Batching and JTA</a></li> </ul> </li> <li><a href="#transaction_recovery">9.7. Transaction recovery</a> <ul class="sectlevel3"> <li><a href="#when_to_use_recovery">9.7.1. When to use recovery</a></li> <li><a href="#how_does_it_work">9.7.2. How does it work</a></li> <li><a href="#configuring_recovery">9.7.3. Configuring recoveryÂ Â Â </a></li> <li><a href="#recovery_cache">9.7.4. Recovery cache</a></li> <li><a href="#integration_with_the_transaction_manager">9.7.5. Integration with the transaction manager</a></li> <li><a href="#reconciliation">9.7.6. Reconciliation</a></li> <li><a href="#want_to_know_more">9.7.7. Want to know more?</a></li> </ul> </li> </ul> </li> <li><a href="#locking_and_concurrency">10. Locking and Concurrency</a> <ul class="sectlevel2"> <li><a href="#locking_implementation_details">10.1. Locking implementation details</a> <ul class="sectlevel3"> <li><a href="#how_it_works_in_clustered_caches">10.1.1. How it works in clustered caches?</a></li> <li><a href="#isolation_levels">10.1.2. Isolation levels</a></li> <li><a href="#the_lockmanager">10.1.3. The LockManager</a></li> <li><a href="#lock_striping">10.1.4. Lock striping</a></li> <li><a href="#concurrency_levels">10.1.5. Concurrency levels</a></li> <li><a href="#consistency">10.1.6. Consistency</a></li> </ul> </li> <li><a href="#data_versioning">10.2. Data Versioning</a> <ul class="sectlevel3"> <li><a href="#simple_versioning">10.2.1. Simple versioning</a></li> <li><a href="#partition_aware_versioning">10.2.2. Partition-aware versioning</a></li> <li><a href="#external_versioning">10.2.3. External versioning</a></li> <li><a href="#tombstones">10.2.4. Tombstones</a></li> <li><a href="#configuration_7">10.2.5. Configuration</a></li> </ul> </li> </ul> </li> <li><a href="#clustering">11. Clustering</a> <ul class="sectlevel2"> <li><a href="#local_mode">11.1. Local Mode</a></li> <li><a href="#replicated_mode">11.2. Replicated Mode</a></li> <li><a href="#invalidation_mode">11.3. Invalidation Mode</a></li> <li><a href="#distribution_mode">11.4. Distribution Mode</a> <ul class="sectlevel3"> <li><a href="#read_consistency">11.4.1. Read consistency</a></li> <li><a href="#hashing_algorithms">11.4.2. Hashing Algorithms</a></li> <li><a href="#initial_cluster_size">11.4.3. Initial cluster size</a></li> <li><a href="#l1_caching">11.4.4. L1 Caching</a></li> <li><a href="#ServerHinting">11.4.5. Server Hinting</a></li> <li><a href="#KeyAffinityService">11.4.6. Key affinity service</a></li> <li><a href="#the_grouping_api">11.4.7. The Grouping API</a></li> </ul> </li> <li><a href="#asynchronous_options">11.5. Asynchronous Options</a> <ul class="sectlevel3"> <li><a href="#asynchronous_communications">11.5.1. Asynchronous Communications</a></li> <li><a href="#replication_queue">11.5.2. Replication Queue</a></li> <li><a href="#asynchronous_api_2">11.5.3. Asynchronous API</a></li> <li><a href="#return_values">11.5.4. Return Values</a></li> </ul> </li> <li><a href="#partition_handling">11.6. Partition handling</a> <ul class="sectlevel3"> <li><a href="#split-brain">11.6.1. Split brain</a></li> <li><a href="#successive-node-failures">11.6.2. Successive nodes stopped</a></li> <li><a href="#partition-handling-configuration">11.6.3. Configuration for partition handling functionality</a></li> <li><a href="#partition-handling-monitoring">11.6.4. Monitoring and administration</a></li> </ul> </li> </ul> </li> <li><a href="#local_mode_cache">12. Local mode cache</a> <ul class="sectlevel2"> <li><a href="#performance">12.1. Performance</a></li> </ul> </li> <li><a href="#marshalling">13. Marshalling</a> <ul class="sectlevel2"> <li><a href="#the_role_of_jboss_marshalling">13.1. The Role Of JBoss Marshalling</a></li> <li><a href="#support_for_non_serializable_objects">13.2. Support For Non-Serializable Objects</a> <ul class="sectlevel3"> <li><a href="#store_as_binary">13.2.1. Store As Binary</a></li> </ul> </li> <li><a href="#advanced_configuration">13.3. Advanced Configuration</a> <ul class="sectlevel3"> <li><a href="#troubleshooting">13.3.1. Troubleshooting</a></li> </ul> </li> <li><a href="#plugging_infinispan_with_user_defined_externalizers">13.4. Plugging Infinispan With User Defined Externalizers</a> <ul class="sectlevel3"> <li><a href="#benefits_of_externalizers">13.4.1. Benefits of Externalizers</a></li> <li><a href="#user_friendly_externalizers">13.4.2. User Friendly Externalizers</a></li> <li><a href="#advanced_externalizers">13.4.3. Advanced Externalizers</a></li> </ul> </li> </ul> </li> <li><a href="#server_modules">14. Server Modules</a> <ul class="sectlevel2"> <li><a href="#why_client_server">14.1. Why Client-Server?</a></li> <li><a href="#why_use_embedded_mode">14.2. Why use embedded mode?</a></li> <li><a href="#server_modules_2">14.3. Server Modules</a></li> <li><a href="#using_hot_rod_server">14.4. Using Hot Rod Server</a> <ul class="sectlevel3"> <li><a href="#hot_rod_protocol">14.4.1. Hot Rod Protocol</a></li> <li><a href="#hot_rod_hash_functions">14.4.2. Hot Rod Hash Functions</a></li> <li><a href="#java_hot_rod_client">14.4.3. Java Hot Rod client</a></li> <li><a href="#return_values_2">14.4.4. Return values</a></li> <li><a href="#intelligence">14.4.5. Intelligence</a></li> <li><a href="#request_balancing">14.4.6. Request Balancing</a></li> <li><a href="#sid-68355052">14.4.7. Failover capabilities</a></li> <li><a href="#consistent_concurrent_updates_with_hot_rod_versioned_operations">14.4.8. Consistent Concurrent Updates With Hot Rod Versioned Operations</a></li> <li><a href="#sid-68355104">14.4.9. Interacting With Hot Rod Server From Within Same JVM</a></li> <li><a href="#querying_via_the_java_hot_rod_client">14.4.10. Querying via the Java Hot Rod client</a></li> </ul> </li> <li><a href="#scripting">14.5. Scripting</a> <ul class="sectlevel3"> <li><a href="#installing_scripts">14.5.1. Installing scripts</a></li> <li><a href="#script_metadata">14.5.2. Script metadata</a></li> <li><a href="#script_bindings">14.5.3. Script bindings</a></li> <li><a href="#script_parameters">14.5.4. Script parameters</a></li> <li><a href="#running_scripts_using_the_hot_rod_java_client">14.5.5. Running Scripts using the Hot Rod Java client</a></li> <li><a href="#distributed_execution">14.5.6. Distributed execution</a></li> </ul> </li> <li><a href="#infinispan_rest_server">14.6. Infinispan REST Server</a> <ul class="sectlevel3"> <li><a href="#rest_api">14.6.1. REST API</a></li> <li><a href="#client_side_code">14.6.2. Client side code</a></li> </ul> </li> <li><a href="#using_infinispan_memcached_server">14.7. Using Infinispan Memcached Server</a> <ul class="sectlevel3"> <li><a href="#command_clarifications">14.7.1. Command Clarifications</a></li> <li><a href="#unsupported_features">14.7.2. Unsupported Features</a></li> <li><a href="#talking_to_infinispan_memcached_servers_from_non_java_clients">14.7.3. Talking To Infinispan Memcached Servers From Non-Java Clients</a></li> </ul> </li> <li><a href="#infinispan_websocket_server">14.8. Infinispan WebSocket Server</a> <ul class="sectlevel3"> <li><a href="#javascript_api">14.8.1. Javascript API</a></li> <li><a href="#sample_code">14.8.2. Sample code</a></li> <li><a href="#screencast">14.8.3. Screencast</a></li> <li><a href="#status">14.8.4. Status</a></li> <li><a href="#source">14.8.5. Source</a></li> </ul> </li> </ul> </li> <li><a href="#sid-68355061">15. Querying Infinispan</a> <ul class="sectlevel2"> <li><a href="#the_infinispan_query_module">15.1. The infinispan-query module</a> <ul class="sectlevel3"> <li><a href="#configuration_11">15.1.1. Configuration</a></li> </ul> </li> <li><a href="#simple_example">15.2. Simple example</a> <ul class="sectlevel3"> <li><a href="#notable_differences_with_hibernate_search">15.2.1. Notable differences with Hibernate Search</a></li> <li><a href="#requirements_for_the_key_transformable_and_providedid">15.2.2. Requirements for the Key: @Transformable and @ProvidedId</a></li> </ul> </li> <li><a href="#configuration_12">15.3. Configuration</a> <ul class="sectlevel3"> <li><a href="#configuration_via_xml">15.3.1. Configuration via XML</a></li> <li><a href="#automatic_configuration">15.3.2. Automatic configuration</a></li> <li><a href="#lucene_directory">15.3.3. Lucene Directory</a></li> <li><a href="#using_programmatic_configuration_and_index_mapping">15.3.4. Using programmatic configuration and index mapping</a></li> </ul> </li> <li><a href="#cache_modes_and_managing_indexes">15.4. Cache modes and managing indexes</a> <ul class="sectlevel3"> <li><a href="#local">15.4.1. LOCAL</a></li> <li><a href="#replication">15.4.2. REPLICATION</a></li> <li><a href="#distribution">15.4.3. DISTRIBUTION</a></li> <li><a href="#invalidation">15.4.4. INVALIDATION</a></li> </ul> </li> <li><a href="#sharing_the_index">15.5. Sharing the Index</a></li> <li><a href="#clustering_the_index_in_infinispan">15.6. Clustering the Index in Infinispan</a></li> <li><a href="#rebuilding_the_index">15.7. Rebuilding the Index</a></li> <li><a href="#obtaining_query_statistics">15.8. Obtaining query statistics</a></li> <li><a href="#infinispan_s_query_dsl">15.9. Infinispan&#8217;s Query DSL</a></li> <li><a href="#filtering_operators">15.10. Filtering operators</a> <ul class="sectlevel3"> <li><a href="#filtering_based_on_attributes_of_embedded_entities">15.10.1. Filtering based on attributes of embedded entities</a></li> </ul> </li> <li><a href="#boolean_conditions">15.11. Boolean conditions</a></li> <li><a href="#nested_conditions">15.12. Nested conditions</a></li> <li><a href="#projections">15.13. Projections</a></li> <li><a href="#sorting">15.14. Sorting</a></li> <li><a href="#pagination">15.15. Pagination</a></li> <li><a href="#grouping_and_aggregation">15.16. Grouping and Aggregation</a> <ul class="sectlevel4"> <li><a href="#aggregations">Aggregations</a></li> <li><a href="#evaluation_of_queries_with_grouping_and_aggregation">15.16.2. Evaluation of queries with grouping and aggregation</a></li> </ul> </li> <li><a href="#usage_samples">15.17. Usage samples</a></li> <li><a href="#additional_links">15.18. Additional Links</a></li> <li><a href="#lucene_compatibility">15.19. Lucene compatibility</a></li> <li><a href="#how_to_use_it">15.20. How to use it</a></li> <li><a href="#limitations">15.21. Limitations</a></li> <li><a href="#configuration_13">15.22. Configuration</a></li> <li><a href="#demo">15.23. Demo</a></li> <li><a href="#maven_dependencies">15.24. Maven dependencies</a></li> <li><a href="#using_a_cacheloader">15.25. Using a CacheLoader</a> <ul class="sectlevel3"> <li><a href="#storing_the_index_in_a_database">15.25.1. Storing the index in a database</a></li> <li><a href="#loading_an_existing_lucene_index">15.25.2. Loading an existing Lucene Index</a></li> </ul> </li> <li><a href="#architectural_limitations">15.26. Architectural limitations</a></li> <li><a href="#suggestions_for_optimal_performance">15.27. Suggestions for optimal performance</a> <ul class="sectlevel3"> <li><a href="#jgroups_and_networking_stack">15.27.1. JGroups and networking stack</a></li> <li><a href="#using_a_cachestore">15.27.2. Using a CacheStore</a></li> <li><a href="#apply_standard_lucene_tuning">15.27.3. Apply standard Lucene tuning</a></li> <li><a href="#disable_batching_and_transactions">15.27.4. Disable batching and transactions</a></li> <li><a href="#set_the_right_chunk_size">15.27.5. Set the right chunk size</a></li> <li><a href="#use_dedicated_cache_instances">15.27.6. Use dedicated Cache instances</a></li> </ul> </li> </ul> </li> <li><a href="#map_reduce">16. Map/Reduce</a> <ul class="sectlevel2"> <li><a href="#api_4">16.1. API</a> <ul class="sectlevel3"> <li><a href="#task_timeout">16.1.1. Task timeout</a></li> </ul> </li> <li><a href="#mapper_and_cdi">16.2. Mapper and CDI</a></li> <li><a href="#mapreducetask_distributed_execution">16.3. MapReduceTask distributed execution</a></li> <li><a href="#examples_2">16.4. Examples</a></li> </ul> </li> <li><a href="#streams">17. Streams</a> <ul class="sectlevel2"> <li><a href="#common_stream_operations">17.1. Common stream operations</a> <ul class="sectlevel3"> <li><a href="#key_filtering">17.1.1. Key filtering</a></li> <li><a href="#segment_based_filtering">17.1.2. Segment based filtering</a></li> </ul> </li> <li><a href="#local_invalidation">17.2. Local/Invalidation</a> <ul class="sectlevel3"> <li><a href="#example">17.2.1. Example</a></li> </ul> </li> <li><a href="#distribution_replication">17.3. Distribution/Replication</a> <ul class="sectlevel3"> <li><a href="#rehash_aware">17.3.1. Rehash Aware</a></li> <li><a href="#serialization">17.3.2. Serialization</a></li> <li><a href="#parallel_computation">17.3.3. Parallel Computation</a></li> <li><a href="#task_timeout_2">17.3.4. Task timeout</a></li> <li><a href="#injection">17.3.5. Injection</a></li> <li><a href="#distributed_stream_execution">17.3.6. Distributed Stream execution</a></li> <li><a href="#key_based_rehash_aware_operators">17.3.7. Key based rehash aware operators</a></li> <li><a href="#intermediate_operation_exceptions">17.3.8. Intermediate operation exceptions</a></li> </ul> </li> <li><a href="#examples_3">17.4. Examples</a></li> </ul> </li> <li><a href="#DistributedExecutor">18. Distributed Execution Framework</a> <ul class="sectlevel2"> <li><a href="#distributedcallable_api">18.1. DistributedCallable API</a></li> <li><a href="#callable_and_cdi">18.2. Callable and CDI</a></li> <li><a href="#distributedexecutorservice_distributedtaskbuilder_and_distributedtask_api">18.3. DistributedExecutorService, DistributedTaskBuilder and DistributedTask API</a></li> <li><a href="#distributed_task_failover">18.4. Distributed task failover</a></li> <li><a href="#distributed_task_execution_policy">18.5. Distributed task execution policy</a></li> <li><a href="#examples_4">18.6. Examples</a></li> </ul> </li> <li><a href="#management_tooling">19. Management Tooling</a> <ul class="sectlevel2"> <li><a href="#jmx">19.1. JMX</a> <ul class="sectlevel3"> <li><a href="#understanding_the_exposed_mbeans">19.1.1. Understanding The Exposed MBeans</a></li> <li><a href="#enabling_jmx_statistics">19.1.2. Enabling JMX Statistics</a></li> <li><a href="#multiple_jmx_domains">19.1.3. Multiple JMX Domains</a></li> <li><a href="#registering_mbeans_in_non_default_mbean_servers">19.1.4. Registering MBeans In Non-Default MBean Servers</a></li> <li><a href="#mbeans_added_in_infinispan_5_0">19.1.5. MBeans added in Infinispan 5.0</a></li> </ul> </li> <li><a href="#rhq">19.2. RHQ</a> <ul class="sectlevel3"> <li><a href="#rhq_monitoring_tips">19.2.1. RHQ monitoring tips</a></li> </ul> </li> <li><a href="#hawt_io">19.3. Hawt.io</a></li> <li><a href="#writing_plugins_for_other_management_tools">19.4. Writing plugins for other management tools</a></li> </ul> </li> <li><a href="#cdi_support">20. CDI Support</a> <ul class="sectlevel2"> <li><a href="#maven_dependencies_2">20.1. Maven Dependencies</a></li> <li><a href="#embedded_cache_integration">20.2. Embedded cache integration</a> <ul class="sectlevel3"> <li><a href="#inject_an_embedded_cache">20.2.1. Inject an embedded cache</a></li> <li><a href="#override_the_default_embedded_cache_manager_and_configuration">20.2.2. Override the default embedded cache manager and configuration</a></li> <li><a href="#configure_the_transport_for_clustered_use">20.2.3. Configure the transport for clustered use</a></li> </ul> </li> <li><a href="#remote_cache_integration">20.3. Remote cache integration</a> <ul class="sectlevel3"> <li><a href="#inject_a_remote_cache">20.3.1. Inject a remote cache</a></li> <li><a href="#override_the_default_remote_cache_manager">20.3.2. Override the default remote cache manager</a></li> </ul> </li> <li><a href="#use_a_custom_remote_embedded_cache_manager_for_one_or_more_cache">20.4. Use a custom remote/embedded cache manager for one or more cache</a></li> <li><a href="#use_a_jboss_as_7_configured_cache">20.5. Use a JBoss AS 7 configured cache</a></li> <li><a href="#use_jcache_caching_annotations">20.6. Use JCache caching annotations</a></li> <li><a href="#use_cache_events_and_cdi">20.7. Use Cache events and CDI</a></li> </ul> </li> <li><a href="#_custom_interceptors_chapter">21. Custom Interceptors</a> <ul class="sectlevel2"> <li><a href="#adding_custom_interceptors_declaratively">21.1. Adding custom interceptors declaratively</a></li> <li><a href="#adding_custom_interceptors_programatically">21.2. Adding custom interceptors programatically</a></li> <li><a href="#custom_interceptor_design">21.3. Custom interceptor design</a></li> </ul> </li> <li><a href="#running_infinispan_on_amazon_web_services">22. Running Infinispan on Amazon Web Services</a> <ul class="sectlevel2"> <li><a href="#tcpping_gossiprouter_s3_ping">22.1. TCPPing, GossipRouter, S3_PING</a></li> <li><a href="#gossiprouter">22.2. GossipRouter</a></li> <li><a href="#s3_ping">22.3. S3_PING</a></li> <li><a href="#jdbc_ping">22.4. JDBC_PING</a></li> </ul> </li> <li><a href="#default_values_for_property_based_attributes">23. Default Values For Property Based Attributes</a></li> <li><a href="#_CLI_chapter">24. Command-Line Interface (CLI)</a> <ul class="sectlevel2"> <li><a href="#commands">24.1. Commands</a> <ul class="sectlevel3"> <li><a href="#abort">24.1.1. abort</a></li> <li><a href="#begin">24.1.2. begin</a></li> <li><a href="#cache">24.1.3. cache</a></li> <li><a href="#clearcache">24.1.4. clearcache</a></li> <li><a href="#commit">24.1.5. commit</a></li> <li><a href="#container">24.1.6. container</a></li> <li><a href="#create">24.1.7. create</a></li> <li><a href="#deny">24.1.8. deny</a></li> <li><a href="#disconnect">24.1.9. disconnect</a></li> <li><a href="#encoding">24.1.10. encoding</a></li> <li><a href="#end">24.1.11. end</a></li> <li><a href="#evict">24.1.12. evict</a></li> <li><a href="#get">24.1.13. get</a></li> <li><a href="#grant">24.1.14. grant</a></li> <li><a href="#info">24.1.15. info</a></li> <li><a href="#locate">24.1.16. locate</a></li> <li><a href="#put">24.1.17. put</a></li> <li><a href="#replace">24.1.18. replace</a></li> <li><a href="#roles">24.1.19. roles</a></li> <li><a href="#rollback">24.1.20. rollback</a></li> <li><a href="#site">24.1.21. site</a></li> <li><a href="#start">24.1.22. start</a></li> <li><a href="#stats">24.1.23. stats</a></li> <li><a href="#upgrade">24.1.24. upgrade</a></li> <li><a href="#version">24.1.25. version</a></li> </ul> </li> <li><a href="#data_types">24.2. Data Types</a></li> <li><a href="#time_values">24.3. Time Values</a></li> </ul> </li> <li><a href="#infinispan_for_http_session_clustering_and_caching">25. Infinispan for HTTP session clustering and caching</a> <ul class="sectlevel2"> <li><a href="#jboss_as_and_wildfly">25.1. JBoss AS and WildFly</a></li> <li><a href="#jetty">25.2. Jetty</a></li> <li><a href="#other_application_servers_and_servlet_containers">25.3. Other application servers and servlet containers</a></li> </ul> </li> <li><a href="#integration_with_other_frameworks">26. Integration with other frameworks</a> <ul class="sectlevel2"> <li><a href="#using_infinispan_as_jpa_hibernate_second_level_cache_provider">26.1. Using Infinispan as JPA-Hibernate Second Level Cache Provider</a> <ul class="sectlevel3"> <li><a href="#configuration_14">26.1.1. Configuration</a></li> <li><a href="#default_configuration_explained">26.1.2. Default Configuration Explained</a></li> <li><a href="#jta_transactions_configuration">26.1.3. JTA Transactions Configuration</a></li> <li><a href="#advanced_configuration_2">26.1.4. Advanced Configuration</a></li> <li><a href="#handling_custom_identifiers_types">26.1.5. Handling custom identifiers types</a></li> <li><a href="#integration_with_jboss_application_server">26.1.6. Integration with JBoss Application Server</a></li> <li><a href="#using_infinispan_as_remote_second_level_cache">26.1.7. Using Infinispan as remote Second Level Cache?</a></li> </ul> </li> <li><a href="#implementing_standalone_jpa_jta_hibernate_application_outside_j2ee_server_using_infinispan_2nd_level_cache">26.2. Implementing standalone JPA JTA Hibernate application outside J2EE server using Infinispan 2nd level cache</a> <ul class="sectlevel3"> <li><a href="#jboss_transactions">26.2.1. JBoss Transactions</a></li> <li><a href="#jotm">26.2.2. JOTM</a></li> <li><a href="#bitronix">26.2.3. Bitronix</a></li> <li><a href="#atomikos">26.2.4. Atomikos</a></li> </ul> </li> <li><a href="#infinispan_as_hibernate_2nd_level_cache_in_jboss_as_5_x">26.3. Infinispan as Hibernate 2nd-Level Cache in JBoss AS 5.x</a></li> <li><a href="#using_infinispan_as_a_spring_cache_provider">26.4. Using Infinispan as a Spring Cache provider</a> <ul class="sectlevel3"> <li><a href="#activating_spring_cache_support">26.4.1. Activating Spring Cache support</a></li> <li><a href="#telling_spring_to_use_infinispan_as_its_caching_provider">26.4.2. Telling Spring to use Infinispan as its caching provider</a></li> <li><a href="#adding_caching_to_your_application_code">26.4.3. Adding caching to your application code</a></li> <li><a href="#conclusion">26.4.4. Conclusion</a></li> </ul> </li> <li><a href="#infinispan_modules_for_jboss_as_7_x">26.5. Infinispan modules for JBoss AS 7.x</a></li> </ul> </li> <li><a href="#grid_file_system">27. Grid File System</a> <ul class="sectlevel2"> <li><a href="#webdav_demo">27.1. WebDAV demo</a></li> </ul> </li> <li><a href="#CrossSiteReplication">28. Cross site replication</a> <ul class="sectlevel2"> <li><a href="#sample_deployment">28.1. Sample deployment</a> <ul class="sectlevel3"> <li><a href="#local_cluster_s_jgroups_xml_configuration">28.1.1. Local cluster&#8217;s jgroups .xml configuration</a></li> <li><a href="#relay2_configuration_file">28.1.2. RELAY2 configuration file</a></li> </ul> </li> <li><a href="#data_replication">28.2. Data replication</a> <ul class="sectlevel3"> <li><a href="#non_transactional_caches_2">28.2.1. Non transactional caches</a></li> <li><a href="#transactional_caches">28.2.2. Transactional caches</a></li> </ul> </li> <li><a href="#taking_a_site_offline">28.3. Taking a site offline</a> <ul class="sectlevel3"> <li><a href="#configuration_15">28.3.1. Configuration</a></li> <li><a href="#taking_a_site_back_online">28.3.2. Taking a site back online</a></li> </ul> </li> <li><a href="#state_transfer_between_sites">28.4. State Transfer between sites</a> <ul class="sectlevel3"> <li><a href="#handling_join_leave_nodes">28.4.1. Handling join/leave nodes</a></li> <li><a href="#handling_broken_link_between_sites">28.4.2. Handling broken link between sites</a></li> <li><a href="#system_administrator_operations">28.4.3. System Administrator Operations</a></li> <li><a href="#x-site-st-configuration">28.4.4. Configuration</a></li> </ul> </li> <li><a href="#x-site-reference">28.5. Reference</a></li> </ul> </li> <li><a href="#_Rolling_chapter">29. Rolling upgrades</a> <ul class="sectlevel2"> <li><a href="#rolling_upgrades_for_infinispan_library_embedded_mode">29.1. Rolling upgrades for Infinispan library/embedded mode</a> <ul class="sectlevel3"> <li><a href="#steps">29.1.1. Steps</a></li> </ul> </li> <li><a href="#rolling_upgrades_for_infinispan_servers">29.2. Rolling upgrades for Infinispan Servers</a></li> <li><a href="#steps_2">29.3. Steps</a></li> </ul> </li> <li><a href="#infinispan_command_line_console">30. Infinispan Command-line Console</a> <ul class="sectlevel2"> <li><a href="#what_is_ispncon">30.1. What is ispncon ?</a></li> <li><a href="#installation">30.2. Installation</a></li> <li><a href="#basic_usage">30.3. Basic usage</a></li> <li><a href="#configuration_16">30.4. Configuration</a></li> <li><a href="#cache_operations_2">30.5. Cache operations</a> <ul class="sectlevel3"> <li><a href="#put_2">30.5.1. put</a></li> <li><a href="#get_2">30.5.2. get</a></li> <li><a href="#delete">30.5.3. delete</a></li> <li><a href="#clear">30.5.4. clear</a></li> <li><a href="#exists">30.5.5. exists</a></li> <li><a href="#version_2">30.5.6. version</a></li> </ul> </li> <li><a href="#other_commands">30.6. Other commands</a> <ul class="sectlevel3"> <li><a href="#help">30.6.1. help</a></li> <li><a href="#config">30.6.2. config</a></li> <li><a href="#include">30.6.3. include</a></li> </ul> </li> <li><a href="#interoperability_with_java_clients">30.7. Interoperability with java clients</a> <ul class="sectlevel3"> <li><a href="#over_rest">30.7.1. Over REST</a></li> <li><a href="#over_hot_rod">30.7.2. Over Hot Rod</a></li> <li><a href="#spymemcached_java_client">30.7.3. SpyMemcached Java Client</a></li> </ul> </li> </ul> </li> <li><a href="#using_infinispan_as_a_jsr107_jcache_provider">31. Using Infinispan as a JSR107 (JCache) provider</a> <ul class="sectlevel2"> <li><a href="#dependencies_2">31.1. Dependencies</a></li> <li><a href="#create_a_local_cache">31.2. Create a local cache</a></li> <li><a href="#store_and_retrieve_data">31.3. Store and retrieve data</a></li> <li><a href="#comparing_java_util_concurrent_concurrentmap_and_javax_cache_cache_apis">31.4. Comparing java.util.concurrent.ConcurrentMap and javax.cache.Cache APIs</a></li> <li><a href="#clustering_jcache_instances">31.5. Clustering JCache instances</a></li> </ul> </li> <li><a href="#total_order_based_commit_protocol">32. Total Order based commit protocol</a> <ul class="sectlevel2"> <li><a href="#overview">32.1. Overview</a> <ul class="sectlevel3"> <li><a href="#commit_in_one_phase">32.1.1. Commit in one phase</a></li> <li><a href="#commit_in_two_phases">32.1.2. Commit in two phases</a></li> <li><a href="#transaction_recovery_2">32.1.3. Transaction Recovery</a></li> <li><a href="#total_order_executor_service">32.1.4. Total order executor service</a></li> <li><a href="#state_transfer">32.1.5. State Transfer</a></li> </ul> </li> <li><a href="#configuration_17">32.2. Configuration</a></li> <li><a href="#total_order_support_in_jgroups">32.3. Total Order support in JGroups.</a> <ul class="sectlevel3"> <li><a href="#sequencer">32.3.1. SEQUENCER</a></li> <li><a href="#toa_total_order_anycast">32.3.2. TOA - Total Order Anycast</a></li> </ul> </li> <li><a href="#benchmark_results">32.4. Benchmark results</a></li> </ul> </li> <li><a href="#storing_objects_e_g_arrays_with_custom_equivalence_functions">33. Storing objects (e.g. arrays) with custom Equivalence functions</a> <ul class="sectlevel2"> <li><a href="#the_problem_of_caching_arrays">33.1. The Problem of Caching Arrays</a></li> <li><a href="#old_workaround_wrapper_classes">33.2. Old workaround: Wrapper Classes</a></li> <li><a href="#new_solution_plugging_equivalence_functions">33.3. New solution: Plugging Equivalence functions</a> <ul class="sectlevel3"> <li><a href="#configuring_equivalence_functions">33.3.1. Configuring Equivalence functions</a></li> <li><a href="#byte_array_storage_example">33.3.2. Byte array storage example</a></li> <li><a href="#other_methods_in_equivalence_interface">33.3.3. Other methods in Equivalence interface</a></li> </ul> </li> </ul> </li> <li><a href="#interoperability_between_embedded_and_remote_server_endpoints">34. Interoperability between Embedded and Remote Server Endpoints</a> <ul class="sectlevel2"> <li><a href="#enable_compatibility_mode">34.1. Enable Compatibility Mode</a> <ul class="sectlevel3"> <li><a href="#optional_configuring_compatibility_marshaller">34.1.1. Optional: Configuring Compatibility Marshaller</a></li> </ul> </li> <li><a href="#code_examples">34.2. Code examples</a></li> </ul> </li> <li><a href="#security">35. Security</a> <ul class="sectlevel2"> <li><a href="#embedded_security">35.1. Embedded Security</a> <ul class="sectlevel3"> <li><a href="#embedded_permissions">35.1.1. Embedded Permissions</a></li> <li><a href="#embedded_api">35.1.2. Embedded API</a></li> <li><a href="#embedded_configuration">35.1.3. Embedded Configuration</a></li> </ul> </li> <li><a href="#security_audit">35.2. Security Audit</a></li> <li><a href="#cluster_security">35.3. Cluster security</a></li> </ul> </li> <li><a href="#functional_map_api">36. Functional Map API</a> <ul class="sectlevel2"> <li><a href="#asynchronous_and_lazy">36.1. Asynchronous and Lazy</a></li> <li><a href="#function_transparency">36.2. Function transparency</a></li> <li><a href="#constructing_functional_maps">36.3. Constructing Functional Maps</a></li> <li><a href="#read_only_map_api">36.4. Read-Only Map API</a> <ul class="sectlevel3"> <li><a href="#_read_only_entry_view">36.4.1. Read-Only Entry View</a></li> </ul> </li> <li><a href="#write_only_map_api">36.5. Write-Only Map API</a> <ul class="sectlevel3"> <li><a href="#_write_only_entry_view">36.5.1. Write-Only Entry View</a></li> </ul> </li> <li><a href="#read_write_map_api">36.6. Read-Write Map API</a> <ul class="sectlevel3"> <li><a href="#_read_write_entry_view">36.6.1. Read-Write Entry View</a></li> </ul> </li> <li><a href="#_meta_parameter">36.7. Metadata Parameter Handling</a></li> <li><a href="#_invocation_parameter">36.8. Invocation Parameter</a></li> <li><a href="#_functional_listeners">36.9. Functional Listeners</a> <ul class="sectlevel3"> <li><a href="#write_listeners">36.9.1. Write Listeners</a></li> <li><a href="#read_write_listeners">36.9.2. Read-Write Listeners</a></li> </ul> </li> <li><a href="#marshalling_of_functions">36.10. Marshalling of Functions</a></li> <li><a href="#use_cases_for_functional_api">36.11. Use cases for Functional API</a></li> <li><a href="#declarative_configuration">36.12. Declarative configuration</a></li> <li><a href="#programmatic_configuration">36.13. Programmatic configuration</a></li> </ul> </li> </ul> </div> </div> <div id="content"> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p>Welcome to the official Infinispan user guide. This comprehensive document will guide you through every last detail of Infinispan, however can be a poor starting point if you are new to Infinispan.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> For newbies, starting with the <a href="../getting_started/getting_started.html">Getting Started Guide</a> or one of the <a href="http://www.infinispan.org/documentation">Quickstarts</a> is probably a better bet. </td> </tr> </table> </div> <div class="paragraph"> <p>The <a href="../faqs/faqs.html">Frequently Asked Questions</a> and <a href="../glossary/glossary.html">Glossary</a> are also useful documents to have alongside this user guide.</p> </div> </div> </div> <div class="sect1"> <h2 id="configuring_cache"><a class="anchor" href="#configuring_cache"></a>1. Configuring cache</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan offers both declarative and programmatic configuration.</p> </div> <div class="paragraph"> <p>Declarative configuration comes in a form of XML document that adheres to a provided Infinispan configuration XML <a href="http://www.infinispan.org/schemas/infinispan-config-8.2.xsd">schema</a>.</p> </div> <div class="paragraph"> <p>Every aspect of Infinispan that can be configured declaratively can also be configured programmatically In fact, declarative configuration, behind the scenes, invokes programmatic configuration API as the XML configuration file is being processed. One can even use combination of these approaches. For example, you can read static XML configuration files and at runtime programmatically tune that same configuration. Or you can use a certain static configuration defined in XML as a starting point or template for defining additional configurations in runtime.</p> </div> <div class="paragraph"> <p>There are two main configuration abstractions in Infinispan: <code>global</code> and <code>default</code> sections.</p> </div> <div class="paragraph"> <div class="title">Global configuration</div> <p>Global cache configuration defines global settings shared among all cache instances created by a single <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/manager/EmbeddedCacheManager.html">EmbeddedCacheManager</a>. Shared resources like thread pools, serialization/marshalling settings, transport and network settings, JMX domains are all part of global configuration.</p> </div> <div class="paragraph"> <div class="title">Default configuration</div> <p>Default cache configuration is more specific to actual caching domain itself. It specifies eviction, locking, transaction, clustering, cache store settings etc. The default cache can be retrieved via the <code>CacheManager.getCache()</code> API.</p> </div> <div class="paragraph"> <div class="title">Named caches</div> <p>However, the real power of default cache mechanism comes to light when used in conjunction with <em>named caches</em>. Named caches have the same XML schema as the default cache. Whenever they are specified, named caches inherit settings from the default cache while additional behavior can be specified or overridden. Named caches are retrieved via the <code>CacheManager.getCache(String name)</code> API. Therefore, note that the <em>name</em> attribute of named cache is both mandatory and unique for every named cache specified.</p> </div> <div class="paragraph"> <p>Do not forget to refer to Infinispan configuration <a href="http://docs.jboss.org/infinispan/8.2/configdocs">reference</a> for more details.</p> </div> <div class="sect2"> <h3 id="configuring_cache_declaratively"><a class="anchor" href="#configuring_cache_declaratively"></a>1.1. Configuring Cache declaratively</h3> <div class="paragraph"> <p>One of the major goals of Infinispan is to aim for zero configuration. A simple XML configuration file containing nothing more than a single infinispan element is enough to get you started. The configuration file listed below provides sensible defaults and is perfectly valid.</p> </div> <div class="listingblock"> <div class="title">infinispan.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan</span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>However, that would only give you the most basic, local mode, non-clustered cache. Non-basic configurations are very likely to use customized global and default cache elements.</p> </div> <div class="paragraph"> <p>Declarative configuration is the most common approach to configuring Infinispan cache instances. In order to read XML configuration files one would typically construct an instance of DefaultCacheManager by pointing to an XML file containing Infinispan configuration. Once configuration file is read you can obtain reference to the default cache instance.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager manager = <span class="keyword">new</span> DefaultCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-config-file.xml</span><span class="delimiter">&quot;</span></span>);
Cache defaultCache = manager.getCache();</code></pre> </div> </div> <div class="paragraph"> <p>or any other named instance specified in <code>my-config-file.xml</code>.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Cache someNamedCache = manager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">someNamedCache</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>The name of the default cache is defined in the <code>&lt;cache-container&gt;</code> element of the XML configuration file, and additional caches can be configured using the <code>&lt;local-cache&gt;</code>,<code>&lt;distributed-cache&gt;</code>,<code>&lt;invalidation-cache&gt;</code> or <code>&lt;replicated-cache&gt;</code> elements.</p> </div> <div class="paragraph"> <p>Refer to Infinispan configuration <a href="http://docs.jboss.org/infinispan/8.2/configdocs">reference</a> for more details. If you are using XML editing tools for configuration writing you can use provided Infinispan <a href="http://infinispan.org/schemas/infinispan-config-8.2.xsd">schema</a> to assist you.</p> </div> </div> <div class="sect2"> <h3 id="configuring_cache_programmatically"><a class="anchor" href="#configuring_cache_programmatically"></a>1.2. Configuring cache programmatically</h3> <div class="paragraph"> <p>Programmatic Infinispan configuration is centered around CacheManager and ConfigurationBuilder API. Although every single aspect of Infinispan configuration could be set programmatically, the most usual approach is to create a starting point in a form of XML configuration file and then in runtime, if needed, programmatically tune a specific configuration to suit the use case best.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager manager = <span class="keyword">new</span> DefaultCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-config-file.xml</span><span class="delimiter">&quot;</span></span>);
Cache defaultCache = manager.getCache();</code></pre> </div> </div> <div class="paragraph"> <p>Let assume that a new synchronously replicated cache is to be configured programmatically. First, a fresh instance of Configuration object is created using ConfigurationBuilder helper object, and the cache mode is set to synchronous replication. Finally, the configuration is defined/registered with a manager.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder().clustering().cacheMode(CacheMode.REPL_SYNC).build();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="predefined-type">String</span> newCacheName = <span class="string"><span class="delimiter">&quot;</span><span class="content">repl</span><span class="delimiter">&quot;</span></span>;
manager.defineConfiguration(newCacheName, c);
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = manager.getCache(newCacheName);</code></pre> </div> </div> <div class="paragraph"> <p>The default cache configuration (or any other cache configuration) can be used as a starting point for creation of a new cache. For example, lets say that <code>infinispan-config-file.xml</code> specifies a replicated cache as a default and that a distributed cache is desired with a specific L1 lifespan while at the same time retaining all other aspects of a default cache. Therefore, the starting point would be to read an instance of a default Configuration object and use <code>ConfigurationBuilder</code> to construct and modify cache mode and L1 lifespan on a new <code>Configuration</code> object. As a final step the configuration is defined/registered with a manager.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager manager = <span class="keyword">new</span> DefaultCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-config-file.xml</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">Configuration</span> dcc = manager.getDefaultCacheConfiguration();
<span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder().read(dcc).clustering().cacheMode(CacheMode.DIST_SYNC).l1().lifespan(<span class="integer">60000L</span>).build();
<span class="error">Â </span>
<span class="predefined-type">String</span> newCacheName = <span class="string"><span class="delimiter">&quot;</span><span class="content">distributedWithL1</span><span class="delimiter">&quot;</span></span>;
manager.defineConfiguration(newCacheName, c);
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = manager.getCache(newCacheName);</code></pre> </div> </div> <div class="paragraph"> <p>As long as the based configuration is the default named cache, the previous code works perfectly fine. However, other times the base configuration might be another named cache. So, how can new configurations be defined based on other defined caches? Take the previous example and imagine that instead of taking the default cache as base, a named cache called "replicatedCache" is used as base. The code would look something like this:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager manager = <span class="keyword">new</span> DefaultCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-config-file.xml</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">Configuration</span> rc = manager.getCacheConfiguration(<span class="string"><span class="delimiter">&quot;</span><span class="content">replicatedCache</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder().read(rc).clustering().cacheMode(CacheMode.DIST_SYNC).l1().lifespan(<span class="integer">60000L</span>).build();
<span class="error">Â </span>
<span class="predefined-type">String</span> newCacheName = <span class="string"><span class="delimiter">&quot;</span><span class="content">distributedWithL1</span><span class="delimiter">&quot;</span></span>;
manager.defineConfiguration(newCacheName, c);
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = manager.getCache(newCacheName);</code></pre> </div> </div> <div class="paragraph"> <p>Refer to <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/manager/CacheManager.html">CacheManager</a> , <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/configuration/cache/ConfigurationBuilder.html">ConfigurationBuilder</a> , <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/configuration/cache/Configuration.html">Configuration</a> , and <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/configuration/global/GlobalConfiguration.html">GlobalConfiguration</a> javadocs for more details.</p> </div> <div class="sect3"> <h4 id="configurationbuilder_programmatic_configuration_api"><a class="anchor" href="#configurationbuilder_programmatic_configuration_api"></a>1.2.1. ConfigurationBuilder Programmatic Configuration API</h4> <div class="paragraph"> <p>However, users do not have to first read an XML based configuration and then modify it in runtime; they can start from scratch using only programmatic API. This is where powerful ConfigurationBuilder API comes to shine. The aim of this API is to make it easier to chain coding of configuration options in order to speed up the coding itself and make the configuration more readable. This new configuration can be used for both the global and the cache level configuration. GlobalConfiguration objects are constructed using GlobalConfigurationBuilder while Configuration objects are built using ConfigurationBuilder. Let&#8217;s look at some examples on configuring both global and cache level options with this new API:</p> </div> <div class="paragraph"> <p>One of the most commonly configured global option is the transport layer, where you indicate how an Infinispan node will discover the others:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration globalConfig = <span class="keyword">new</span> GlobalConfigurationBuilder().transport()
        .defaultTransport()
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .clusterName(<span class="string"><span class="delimiter">&quot;</span><span class="content">qa-cluster</span><span class="delimiter">&quot;</span></span>)
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .addProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">configurationFile</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-tcp.xml</span><span class="delimiter">&quot;</span></span>)
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .machineId(<span class="string"><span class="delimiter">&quot;</span><span class="content">qa-machine</span><span class="delimiter">&quot;</span></span>).rackId(<span class="string"><span class="delimiter">&quot;</span><span class="content">qa-rack</span><span class="delimiter">&quot;</span></span>)
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .build();</code></pre> </div> </div> <div class="paragraph"> <p>Sometimes you might also want to enable collection of <a href="http://docs.jboss.org/infinispan/8.2/apidocs/jmxComponents.html">global JMX statistics</a> at cache manager level or get information about the transport. To enable global JMX statistics simply do:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration globalConfig = <span class="keyword">new</span> GlobalConfigurationBuilder()
<span class="error">Â </span> .globalJmxStatistics()
  .enable()
<span class="error">Â </span> .build();</code></pre> </div> </div> <div class="paragraph"> <p>Please note that by not enabling (or by explicitly disabling) global JMX statistics your are just turning off statistics collection. The corresponding MBean is still registered and can be used to manage the cache manager in general, but the statistics attributes do not return meaningful values.</p> </div> <div class="paragraph"> <p>Further options at the global JMX statistics level allows you to configure the cache manager name which comes handy when you have multiple cache managers running on the same system, or how to locate the JMX MBean Server:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration globalConfig = <span class="keyword">new</span> GlobalConfigurationBuilder()
<span class="error">Â </span> .globalJmxStatistics()
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .cacheManagerName(<span class="string"><span class="delimiter">&quot;</span><span class="content">SalesCacheManager</span><span class="delimiter">&quot;</span></span>)
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .mBeanServerLookup(<span class="keyword">new</span> JBossMBeanServerLookup())
<span class="error">Â </span> .build();</code></pre> </div> </div> <div class="paragraph"> <p>Some of the Infinispan features are powered by a group of the thread pool executors which can also be tweaked at this global level. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration globalConfig = <span class="keyword">new</span> GlobalConfigurationBuilder()
<span class="error">Â </span>  .replicationQueueThreadPool()
     .threadPoolFactory(ScheduledThreadPoolExecutorFactory.create())
<span class="error">Â </span> .build();</code></pre> </div> </div> <div class="paragraph"> <p>You can not only configure global, cache manager level, options, but you can also configure cache level options such as the <a href="#_cluster_mode">cluster mode</a>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> config = <span class="keyword">new</span> ConfigurationBuilder()
<span class="error">Â </span> .clustering()
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .cacheMode(CacheMode.DIST_SYNC)
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .sync()
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .l1().lifespan(<span class="integer">25000L</span>)
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .hash().numOwners(<span class="integer">3</span>)
<span class="error">Â </span> .build();</code></pre> </div> </div> <div class="paragraph"> <p>Or you can configure <a href="#_eviction">eviction and expiration settings</a>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> config = <span class="keyword">new</span> ConfigurationBuilder()
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .eviction()
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .maxEntries(<span class="integer">20000</span>).strategy(EvictionStrategy.LIRS).expiration()
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .wakeUpInterval(<span class="integer">5000L</span>)
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .maxIdle(<span class="integer">120000L</span>)
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .build();</code></pre> </div> </div> <div class="paragraph"> <p>An application might also want to interact with an Infinispan cache within the boundaries of JTA and to do that you need to configure the transaction layer and optionally tweak the locking settings. When interacting with transactional caches, you might want to enable recovery to deal with transactions that finished with an heuristic outcome and if you do that, you will often want to enable JMX management and statistics gathering too:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> config = <span class="keyword">new</span> ConfigurationBuilder()
<span class="error">Â </span> .locking()
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .concurrencyLevel(<span class="integer">10000</span>).isolationLevel(IsolationLevel.REPEATABLE_READ)
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .lockAcquisitionTimeout(<span class="integer">12000L</span>).useLockStriping(<span class="predefined-constant">false</span>).writeSkewCheck(<span class="predefined-constant">true</span>)
    .versioning().enable().scheme(VersioningScheme.SIMPLE)
<span class="error">Â </span> .transaction()
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .transactionManagerLookup(<span class="keyword">new</span> GenericTransactionManagerLookup())
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .recovery()
<span class="error">Â </span> .jmxStatistics()
<span class="error">Â </span> .build();</code></pre> </div> </div> <div class="paragraph"> <p>Configuring Infinispan with chained cache stores is simple too:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> config = <span class="keyword">new</span> ConfigurationBuilder()
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .persistence().passivation(<span class="predefined-constant">false</span>)
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .addSingleFileStore().location(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp</span><span class="delimiter">&quot;</span></span>).async().enable()
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .preload(<span class="predefined-constant">false</span>).shared(<span class="predefined-constant">false</span>).threadPoolSize(<span class="integer">20</span>).build();</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="advanced_programmatic_configuration"><a class="anchor" href="#advanced_programmatic_configuration"></a>1.2.2. Advanced programmatic configuration</h4> <div class="paragraph"> <p>The fluent configuration can also be used to configure more advanced or exotic options, such as advanced externalizers:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration globalConfig = <span class="keyword">new</span> GlobalConfigurationBuilder()
<span class="error">Â </span> .serialization()
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .addAdvancedExternalizer(<span class="integer">998</span>, <span class="keyword">new</span> PersonExternalizer())
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .addAdvancedExternalizer(<span class="integer">999</span>, <span class="keyword">new</span> AddressExternalizer())
<span class="error">Â </span> .build();</code></pre> </div> </div> <div class="paragraph"> <p>Or, add custom interceptors:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> config = <span class="keyword">new</span> ConfigurationBuilder()
<span class="error">Â </span> .customInterceptors().addInterceptor()
<span class="error">Â </span><span class="error">Â </span>  .interceptor(<span class="keyword">new</span> FirstInterceptor()).position(InterceptorConfiguration.Position.FIRST)
    .interceptor(<span class="keyword">new</span> LastInterceptor()).position(InterceptorConfiguration.Position.LAST)
    .interceptor(<span class="keyword">new</span> FixPositionInterceptor()).index(<span class="integer">8</span>)
    .interceptor(<span class="keyword">new</span> AfterInterceptor()).after(NonTransactionalLockingInterceptor.class)
    .interceptor(<span class="keyword">new</span> BeforeInterceptor()).before(CallInterceptor.class)
<span class="error">Â </span> .build();</code></pre> </div> </div> <div class="paragraph"> <p>For information on the individual configuration options, please check the <a href="http://docs.jboss.org/infinispan/8.2/configdocs/">configuration guide</a> .</p> </div> </div> </div> <div class="sect2"> <h3 id="configuration_migration_tools"><a class="anchor" href="#configuration_migration_tools"></a>1.3. Configuration Migration Tools</h3> <div class="paragraph"> <p>Infinispan has a number of scripts for importing configurations from other cache and data grid products. Currently we have scripts to import configurations from:</p> </div> <div class="ulist"> <ul> <li> <p>JBoss Cache 3.x</p> </li> <li> <p>EHCache 1.x</p> </li> <li> <p>Oracle Coherence 3.x</p> </li> </ul> </div> <div class="paragraph"> <p>JBoss Cache 3.x itself supports configuration <a href="http://jbosscache.blogspot.com/2008/07/configuration-changes-in-jboss-cache-3.html">migration</a> from previous (2.x) versions, so JBoss Cache 2.x configurations can be migrated indirectly.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> If you wish to help write conversion tools for other caching systems, please contact <a href="https://lists.jboss.org/mailman/listinfo/infinispan-dev">infinispan-dev</a>. </td> </tr> </table> </div> <div class="paragraph"> <p>There is a single scripts for importing configurations: ${INFINISPAN_HOME}/bin/importConfig.sh and an equivalent .BAT script for Windows. Just run it and you should get a help message to assist you with the import:</p> </div> <div class="literalblock"> <div class="content"> <pre>C:\infinispan\bin&gt; importConfig.bat
Missing 'source', cannot proceed
Usage:
importConfig [-source &lt;the file to be transformed&gt;]
[-destination &lt;where to store resulting XML&gt;]
[-type &lt;the type of the source, possible values being: [JBossCache3x, Ehcache1x, Coherence35x] &gt;]</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>C:\infinispan\bin&gt;</pre> </div> </div> <div class="paragraph"> <p>Here is how a JBoss Cache 3.x configuration file is imported:</p> </div> <div class="literalblock"> <div class="content"> <pre>C:\infinispan\bin&gt;importConfig.bat -source in\jbosscache_all.xml -destination out.xml -type JBossCache3x
WARNING! Preload elements cannot be automatically transformed, please do it manually!
WARNING! Please configure cache loader props manually!
WARNING! Singleton store was changed and needs to be configured manually!
IMPORTANT: Please take a look at the generated file for (possible) TODOs about the elements that couldn't be converted automatically!
New configuration file [out.xml] successfully created.
C:\infinispan\bin&gt;</pre> </div> </div> <div class="paragraph"> <p>Please read all warning messages <em>carefully</em> and inspect the generated XML for potential TODO statements that indicate the need for manual intervention. In the case of JBoss Cache 3.x this would usually have to do with custom extensions, such as custom CacheLoaders that cannot be automatically migrated.</p> </div> <div class="paragraph"> <p>For EHCache and Coherence these may also contain suggestions and warnings for configuration options that may not have direct equivalents in Infinispan.</p> </div> </div> <div class="sect2"> <h3 id="clustered_configuration"><a class="anchor" href="#clustered_configuration"></a>1.4. Clustered Configuration</h3> <div class="paragraph"> <p>Infinispan uses <a href="http://www.jgroups.org">JGroups</a> for network communications when in clustered mode. Infinispan ships with <em>pre-configured</em> JGroups stacks that make it easy for you to jump-start a clustered configuration.</p> </div> <div class="sect3"> <h4 id="using_an_external_jgroups_file"><a class="anchor" href="#using_an_external_jgroups_file"></a>1.4.1. Using an external JGroups file</h4> <div class="paragraph"> <p>If you are configuring your cache programmatically, all you need to do is:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration gc = <span class="keyword">new</span> GlobalConfigurationBuilder()
   .transport().defaultTransport()
   .addProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">configurationFile</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups.xml</span><span class="delimiter">&quot;</span></span>)
   .build();</code></pre> </div> </div> <div class="paragraph"> <p>and if you happen to use an XML file to configure Infinispan, just use:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
  <span class="tag">&lt;jgroups&gt;</span>
     <span class="tag">&lt;stack-file</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">external-file</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/jgroups&gt;</span>
Â  <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replicatedCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â Â  <span class="tag">&lt;transport</span> <span class="attribute-name">stack</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">external-file</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replicatedCache</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
Â  <span class="tag">&lt;/cache-container&gt;</span>

Â  ...

<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>In both cases above, Infinispan looks for <em>jgroups.xml</em> first in your classpath, and then for an absolute path name if not found in the classpath.</p> </div> </div> <div class="sect3"> <h4 id="use_one_of_the_pre_configured_jgroups_files"><a class="anchor" href="#use_one_of_the_pre_configured_jgroups_files"></a>1.4.2. Use one of the pre-configured JGroups files</h4> <div class="paragraph"> <p>Infinispan ships with a few different JGroups files (packaged in infinispan-core.jar) which means they will already be on your classpath by default. All you need to do is specify the file name, e.g., instead of <code>jgroups.xml</code> above, specify <code>/default-configs/default-jgroups-tcp.xml</code>.</p> </div> <div class="paragraph"> <p>The configurations available are:</p> </div> <div class="ulist"> <ul> <li> <p>default-jgroups-udp.xml - Uses UDP as a transport, and UDP multicast for discovery. Usually suitable for larger (over 100 nodes) clusters <em>or</em> if you are using <a href="http://community.jboss.org/docs/DOC-14853#replicated">replication or invalidation</a> . Minimises opening too many sockets.</p> </li> <li> <p>default-jgroups-tcp.xml - Uses TCP as a transport and UDP multicast for discovery. Better for smaller clusters (under 100 nodes) <em>only if</em> you are using <a href="http://community.jboss.org/docs/DOC-14853#distribution">distribution</a> , as TCP is more efficient as a point-to-point protocol</p> </li> <li> <p>default-jgroups-ec2.xml - Uses TCP as a transport and <a href="http://community.jboss.org/docs/DOC-15925">S3_PING</a> for discovery. Suitable on <a href="http://aws.amazon.com/ec2/">Amazon EC2</a> nodes where UDP multicast isn&#8217;t available.</p> </li> </ul> </div> <div class="sect4"> <h5 id="tuning_jgroups_settings"><a class="anchor" href="#tuning_jgroups_settings"></a>Tuning JGroups settings</h5> <div class="paragraph"> <p>The settings above can be further tuned without editing the XML files themselves. Passing in certain system properties to your JVM at startup can affect the behaviour of some of these settings. The table below shows you which settings can be configured in this way. E.g.,</p> </div> <div class="listingblock"> <div class="content"> <pre>$ java -cp ... -Djgroups.tcp.port=1234 -Djgroups.tcp.address=10.11.12.13</pre> </div> </div> <table class="tableblock frame-all grid-all spread"> <caption class="title">Table 1. default-jgroups-udp.xml</caption> <colgroup> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> </colgroup> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><em>System Property</em></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><em>Description</em></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><em>Default</em></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><em>Required?</em></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.udp.mcast_addr</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">IP address to use for multicast (both for communications and discovery). Must be a valid <a href="http://compnetworking.about.com/od/workingwithipaddresses/l/aa042400b.htm">Class D</a> IP address, suitable for IP multicast.</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">228.6.7.8</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.udp.mcast_port</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Port to use for multicast socket</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">46655</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.udp.ip_ttl</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the time-to-live (TTL) for IP multicast packets. The value here refers to the number of network hops a packet is allowed to make before it is dropped</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td> </tr> </tbody> </table> <table class="tableblock frame-all grid-all spread"> <caption class="title">Table 2. default-jgroups-tcp.xml</caption> <colgroup> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> </colgroup> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><em>System Property</em></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><em>Description</em></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><em>Default</em></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><em>Required?</em></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.tcp.address</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">IP address to use for the TCP transport.</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">127.0.0.1</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.tcp.port</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Port to use for TCP socket</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">7800</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.udp.mcast_addr</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">IP address to use for multicast (for discovery). Must be a valid <a href="http://compnetworking.about.com/od/workingwithipaddresses/l/aa042400b.htm">Class D</a> IP address, suitable for IP multicast.</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">228.6.7.8</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.udp.mcast_port</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Port to use for multicast socket</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">46655</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.udp.ip_ttl</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the time-to-live (TTL) for IP multicast packets. The value here refers to the number of network hops a packet is allowed to make before it is dropped</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td> </tr> </tbody> </table> <table class="tableblock frame-all grid-all spread"> <caption class="title">Table 3. default-jgroups-ec2.xml</caption> <colgroup> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> </colgroup> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><em>System Property</em></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><em>Description</em></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><em>Default</em></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><em>Required?</em></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.tcp.address</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">IP address to use for the TCP transport.</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">127.0.0.1</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.tcp.port</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Port to use for TCP socket</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">7800</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.s3.access_key</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The Amazon S3 access key used to access an S3 bucket</p></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.s3.secret_access_key</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The Amazon S3 secret key used to access an S3 bucket</p></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.s3.bucket</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Name of the Amazon S3 bucket to use. Must be unique and must already exist</p></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td> </tr> </tbody> </table> </div> </div> <div class="sect3"> <h4 id="further_reading"><a class="anchor" href="#further_reading"></a>1.4.3. Further reading</h4> <div class="paragraph"> <p>JGroups also supports more system property overrides, details of which can be found on this page: <a href="http://community.jboss.org/docs/12352">SystemProps</a></p> </div> <div class="paragraph"> <p>In addition, the JGroups configuration files shipped with Infinispan are intended as a jumping off point to getting something up and running, and working. More often than not though, you will want to fine-tune your JGroups stack further to extract every ounce of performance from your network equipment. For this, your next stop should be the JGroups manual which has a <a href="http://jgroups.org/manual/html/protlist.html">detailed section</a> on configuring each of the protocols you see in a JGroups configuration file.</p> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="the_cachemanager_api"><a class="anchor" href="#the_cachemanager_api"></a>2. The CacheManager API</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan provides the <code>EmbeddedCacheManager</code>, as mentioned in the configuration section, as the API for exposing various operations related to the Infinispan cache container and its supporting elements. This section is to go over some of these pieces as well as when you may need to use them.</p> </div> <div class="sect2"> <h3 id="clustering_information"><a class="anchor" href="#clustering_information"></a>2.1. Clustering Information</h3> <div class="paragraph"> <p>The <code>EmbeddedCacheManager</code> has quite a few methods to provide information as to how the cluster is operating. The following methods only really make sense when being used in a clustered environment (that is when a Transport is configured).</p> </div> <div class="sect3"> <h4 id="member_information"><a class="anchor" href="#member_information"></a>2.1.1. Member Information</h4> <div class="paragraph"> <p>When you are using a cluster it is very important to be able to find information about membership in the cluster including who is the owner of the cluster.</p> </div> <div class="paragraph"> <div class="title"><a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#getMembers--">getMembers</a></div> <p>The getMembers() method returns all of the nodes in the current cluster.</p> </div> <div class="paragraph"> <div class="title"><a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#getCoordinator--">getCoordinator</a></div> <p>The getCoordinator() method will tell you which one of the members is the coordinator of the cluster. For most intents you shouldn&#8217;t need to care who the coordinator is. You can use <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#isCoordinator--">isCoordinator</a> method directly to see if the local node is the coordinator as well.</p> </div> </div> <div class="sect3"> <h4 id="other_methods"><a class="anchor" href="#other_methods"></a>2.1.2. Other methods</h4> <div class="paragraph"> <div class="title"><a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#getTransport--">getTransport</a></div> <p>This method provides you access to the underlying Transport that is used to send messages to other nodes. In most cases a user wouldn&#8217;t ever need to go to this level, but if you want to get Transport specific information (in this case JGroups) you can use this mechanism.</p> </div> <div class="paragraph"> <div class="title"><a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#getStats--">getStats</a></div> <p>The stats provided here are coalesced from all of the active caches in this manager. These stats can be useful to see if there is something wrong going on with your cluster overall.</p> </div> </div> </div> <div class="sect2"> <h3 id="cluster_executor"><a class="anchor" href="#cluster_executor"></a>2.2. Cluster Executor</h3> <div class="paragraph"> <p>The cache manager comes with a nice utility that allows you to execute arbitrary code in the cluster. Note this is unlike the Distributed Execution Service as this requires no Cache to be used. This <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/manager/ClusterExecutor.html">cluster executor</a> can be retrieved by calling executor() of the <code>EmbeddedCacheManager</code>.</p> </div> <div class="paragraph"> <p>This manager was built specifically using Java 8 and such has functional APIs in mind, thus all methods take a functional inteface as an argument. Also since these arguments will be sent to other nodes they need to be serializable. We even used a nice trick to ensure our lambdas are immediately Serializable. That is by having the arguments implement both Serializable and the real argument type (ie. Runnable or Function). The JRE will pick the most specific class when determining which method to invoke, so in that case your lambdas will always be serializable.</p> </div> <div class="paragraph"> <p>Below you will see an example of how to use the new executor.</p> </div> <div class="sect3"> <h4 id="example_dynamically_start_and_stop_clustered_cache"><a class="anchor" href="#example_dynamically_start_and_stop_clustered_cache"></a>2.2.1. Example: Dynamically Start and Stop Clustered Cache</h4> <div class="paragraph"> <p>This example shows how you can use the ClusterExecutor to dynamically start and stop a cache.</p> </div> <div class="sect4"> <h5 id="non_clustered"><a class="anchor" href="#non_clustered"></a>Non-Clustered</h5> <div class="paragraph"> <p>Start start/stop cache in non-clustered mode is simple. You can use <em>EmbeddedCacheManager.defineConfiguration(cacheName, configuration)</em> to define a cache, and then call <em>EmbeddedCacheManager.getCache(cacheName)</em>.</p> </div> <div class="paragraph"> <p>If you don&#8217;t define a specific configuration for the cache and directly call <em>EmbeddedCacheManager.getCache(&#8230;&#8203;)</em> , then a new cache would be created with default configurations.</p> </div> <div class="paragraph"> <p>To stop a cache, call <em>EmbeddedCacheManager.remove(cacheName)</em></p> </div> </div> <div class="sect4"> <h5 id="clustered"><a class="anchor" href="#clustered"></a>Clustered</h5> <div class="paragraph"> <p>To start a clustered cache, you&#8217;ll need to do the above on every clustered node, while making sure the cache mode is clustered, of course.</p> </div> <div class="paragraph"> <p>You can start the cache by calling <em>EmbeddedCacheManager.getCache(&#8230;&#8203;)</em> To do this on every single node though, you could write your own service to do that, or with JMX, or use the ClusterExecutor.</p> </div> <div class="listingblock"> <div class="title">StartCache.java</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">   EmbeddedCacheManager manager = <span class="predefined-constant">null</span>;
   <span class="predefined-type">String</span> cacheName = <span class="string"><span class="delimiter">&quot;</span><span class="content">start-this-cache</span><span class="delimiter">&quot;</span></span>;
   manager.executor().submitConsumer(localManager -&gt; {
         localManager.getCache(cacheName);
         <span class="keyword">return</span> <span class="predefined-constant">null</span>;
      }, (address, value, throwable) -&gt; {
      <span class="keyword">if</span> (throwable != <span class="predefined-constant">null</span>) {
         log.fatal(<span class="string"><span class="delimiter">&quot;</span><span class="content">Cache startup encountered exception on node </span><span class="delimiter">&quot;</span></span> + address, t);
      }
   }).join();</code></pre> </div> </div> <div class="paragraph"> <p>The first argument is a <code>Function</code> that when invoked will pass the <code>EmbeddedCacheManager</code> local to each node. Normally this also allows for a return value to be sent back, but unfortunately a <code>Cache</code> instance is not serializable so we can&#8217;t send that back to the calling node. Thus we have to return null. In this case the second argument <code>TriConsumer</code> would be called back for each node and will contain who this response is from (address), the return value (if there was one, in our case this is always null), and a throwable if a problem occurred. The value and throwable variables will never both be non null. That is if the throwable is non null the value will always be null. Lastly this returns a CompletableFuture that will be complete after all of the node&#8217;s responses have been fully processed.</p> </div> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="the_cache_apis"><a class="anchor" href="#the_cache_apis"></a>3. The Cache APIs</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="the_cache_interface"><a class="anchor" href="#the_cache_interface"></a>3.1. The Cache interface</h3> <div class="paragraph"> <p>Infinispan exposes a simple, <a href="http://jcp.org/en/jsr/detail?id=107">JSR-107</a> compliant <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/Cache.html">Cache</a> interface.</p> </div> <div class="paragraph"> <p>The Cache interface exposes simple methods for adding, retrieving and removing entries, including atomic mechanisms exposed by the JDK&#8217;s ConcurrentMap interface. Based on the cache mode used, invoking these methods will trigger a number of things to happen, potentially even including replicating an entry to a remote node or looking up an entry from a remote node, or potentially a cache store.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> For simple usage, using the Cache API should be no different from using the JDK Map API, and hence migrating from simple in-memory caches based on a Map to Infinispan&#8217;s Cache should be trivial. </td> </tr> </table> </div> <div class="sect3"> <h4 id="performance_concerns_of_certain_map_methods"><a class="anchor" href="#performance_concerns_of_certain_map_methods"></a>3.1.1. Performance Concerns of Certain Map Methods</h4> <div class="paragraph"> <p>Certain methods exposed in Map have certain performance consequences when used with Infinispan, such as <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/Cache.html#size%28%29">size()</a> , <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/Cache.html#values%28%29">values()</a> , <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/Cache.html#keySet%28%29">keySet()</a> and <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/Cache.html#entrySet%28%29">entrySet()</a> . Specific methods on the <code>keySet</code>, <code>values</code> and <code>entrySet</code> are fine for use please see their Javadoc for further details.</p> </div> <div class="paragraph"> <p>Attempting to perform these operations globally would have large performance impact as well as become a scalability bottleneck. As such, these methods should only be used for informational or debugging purposes only.</p> </div> <div class="paragraph"> <p>It should be noted that using certain flags with the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/AdvancedCache.html#withFlags%28org.infinispan.context.Flag&#8230;&#8203;%29">withFlags</a> method can mitigate some of these concerns, please check each method&#8217;s documentation for more details.</p> </div> </div> <div class="sect3"> <h4 id="mortal_and_immortal_data"><a class="anchor" href="#mortal_and_immortal_data"></a>3.1.2. Mortal and Immortal Data</h4> <div class="paragraph"> <p>Further to simply storing entries, Infinispan&#8217;s cache API allows you to attach mortality information to data. For example, simply using <a href="http://docs.oracle.com/javase/6/docs/api/java/util/Map.html#put%28K,%20V%29">put(key, value)</a> would create an <em>immortal</em> entry, i.e., an entry that lives in the cache forever, until it is removed (or evicted from memory to prevent running out of memory). If, however, you put data in the cache using <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/Cache.html#put%28K,%20V,%20long,%20java.util.concurrent.TimeUnit%29">put(key, value, lifespan, timeunit)</a> , this creates a <em>mortal</em> entry, i.e., an entry that has a fixed lifespan and expires after that lifespan.</p> </div> <div class="paragraph"> <p>In addition to <em>lifespan</em> , Infinispan also supports <em>maxIdle</em> as an additional metric with which to determine expiration. Any combination of lifespans or maxIdles can be used.</p> </div> </div> <div class="sect3"> <h4 id="example_of_using_expiry_and_mortal_data"><a class="anchor" href="#example_of_using_expiry_and_mortal_data"></a>3.1.3. Example of Using Expiry and Mortal Data</h4> <div class="paragraph"> <p>See <a href="#_eviction_examples">these examples</a> of using mortal data with Infinispan.</p> </div> </div> <div class="sect3"> <h4 id="putforexternalread_operation"><a class="anchor" href="#putforexternalread_operation"></a>3.1.4. putForExternalRead operation</h4> <div class="paragraph"> <p>Infinispan&#8217;s <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/Cache.html">Cache</a> class contains a different 'put' operation called link:http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/Cache.html#putForExternalRead(K, V)[putForExternalRead] . This operation is particularly useful when Infinispan is used as a temporary cache for data that is persisted elsewhere. Under heavy read scenarios, contention in the cache should not delay the real transactions at hand, since caching should just be an optimization and not something that gets in the way.</p> </div> <div class="paragraph"> <p>To achieve this, putForExternalRead acts as a put call that only operates if the key is not present in the cache, and fails fast and silently if another thread is trying to store the same key at the same time. In this particular scenario, caching data is a way to optimise the system and it&#8217;s not desirable that a failure in caching affects the on-going transaction, hence why failure is handled differently. putForExternalRead is consider to be a fast operation because regardless of whether it&#8217;s successful or not, it doesn&#8217;t wait for any locks, and so returns to the caller promptly.</p> </div> <div class="paragraph"> <p>To understand how to use this operation, let&#8217;s look at basic example. Imagine a cache of Person instances, each keyed by a PersonId , whose data originates in a separate data store. The following code shows the most common pattern of using link:http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/Cache.html#putForExternalRead(K, V)[putForExternalRead] within the context of this example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Id of the person to look up, provided by the application</span>
PersonId id = ...;

<span class="comment">// Get a reference to the cache where person instances will be stored</span>
Cache&lt;PersonId, Person&gt; cache = ...;

<span class="comment">// First, check whether the cache contains the person instance</span>
<span class="comment">// associated with with the given id</span>
Person cachedPerson = cache.get(id);

<span class="keyword">if</span> (cachedPerson == <span class="predefined-constant">null</span>) {
   <span class="comment">// The person is not cached yet, so query the data store with the id</span>
   Person person = dataStore.lookup(id);

   <span class="comment">// Cache the person along with the id so that future requests can</span>
   <span class="comment">// retrieve it from memory rather than going to the data store</span>
   cache.putForExternalRead(id, person);
} <span class="keyword">else</span> {
   <span class="comment">// The person was found in the cache, so return it to the application</span>
   <span class="keyword">return</span> cachedPerson;
}</code></pre> </div> </div> <div class="paragraph"> <p>Please note that link:http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/Cache.html#putForExternalRead(K, V)[putForExternalRead] should never be used as a mechanism to update the cache with a new Person instance originating from application execution (i.e. from a transaction that modifies a Person&#8217;s address). When updating cached values, please use the standard link:http://docs.oracle.com/javase/6/docs/api/java/util/Map.html#put(K, V)[put] operation, otherwise the possibility of caching corrupt data is likely.</p> </div> </div> </div> <div class="sect2"> <h3 id="the_advancedcache_interface"><a class="anchor" href="#the_advancedcache_interface"></a>3.2. The AdvancedCache interface</h3> <div class="paragraph"> <p>In addition to the simple Cache interface, Infinispan offers an <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/AdvancedCache.html">AdvancedCache</a> interface, geared towards extension authors. The AdvancedCache offers the ability to inject custom interceptors, access certain internal components and to apply flags to alter the default behavior of certain cache methods. The following code snippet depicts how an AdvancedCache can be obtained:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">AdvancedCache advancedCache = cache.getAdvancedCache();</code></pre> </div> </div> <div class="sect3"> <h4 id="flags"><a class="anchor" href="#flags"></a>3.2.1. Flags</h4> <div class="paragraph"> <p>Flags are applied to regular cache methods to alter the behavior of certain methods. For a list of all available flags, and their effects, see the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/context/Flag.html">Flag</a> enumeration. Flags are applied using <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/AdvancedCache.html#withFlags%28org.infinispan.context.Flag&#8230;&#8203;%29">AdvancedCache.withFlags()</a> . This builder method can be used to apply any number of flags to a cache invocation, for example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">advancedCache.withFlags(Flag.CACHE_MODE_LOCAL, Flag.SKIP_LOCKING)
<span class="error">Â </span><span class="error">Â </span> .withFlags(Flag.FORCE_SYNCHRONOUS)
<span class="error">Â </span><span class="error">Â </span> .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">world</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="entry_retrieval"><a class="anchor" href="#entry_retrieval"></a>3.2.2. Entry Retrieval</h4> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> This has been deprecated and will be removed in Infinispan 9. You should be using <a href="user_guide.html#_streams">Stream</a>s instead. </td> </tr> </table> </div> <div class="paragraph"> <p>It is possible to retrieve all of the entries stored in a given cache, irrespective of its clustering configuration. These entries are only retrieved through an iterator where each value is only returned one at a time. This is done because of the possible memory constraints of pulling all the values into a single node at the same time.</p> </div> <div class="paragraph"> <p>An <code>EntryIterable</code> is available by invoking the <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/AdvancedCache.html#filterEntries(org.infinispan.filter.KeyValueFilter)">filterEntries</a> method on <code>AdvancedCache</code>. Note you are required to provide a <code>KeyValueFilter</code>, this is to make sure users realize this can be an expensive operation and by filtering entries on the remote side will allow the operation to perform faster and more efficiently. This allows you to iterate over the contents in the cache in a memory sensitive way so out of memory errors should not occur. The size of contents held in memory by the iterator while being processed currently is limited by the state transfer chunk size configuration value.</p> </div> <div class="paragraph"> <p>Once the <code>EntryIterable</code> is retrieved, invocation of the iterator method will immediately start retrieving entries. Note each invocation of the iterator method will start a brand new entry request thus allowing the <code>Iterable</code> to be reused.</p> </div> <div class="paragraph"> <p><code>EntryIterable</code> also implements <code>AutoCloseable</code> so it should be done in a try with resource block to ensure that all resources can be closed properly after invocation.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">KeyValueFilter&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt; filter = ...
try (EntryIterable&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt; iterable = advancedCache.filterEntries(filter)) {
  <span class="keyword">for</span> (CacheEntry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt; entry : iterable) {
     <span class="comment">// Do something</span>
  }
}</code></pre> </div> </div> <div class="sect4"> <h5 id="transactional_aware"><a class="anchor" href="#transactional_aware"></a>Transactional Aware</h5> <div class="paragraph"> <p>The iterators produced will obey the current transaction if there is one when they are generated. Note the transaction they use is the one that is found to be in the thread when <code>filterEntries</code> is first invoked. Thus you should only access this iterator from the same thread or else undefind behavior may occur.</p> </div> <div class="paragraph"> <p>Since we cannot put all entries into the local transaction any entries retrieved using the iterator are not added to the transaction context. This means that the iterator will behave always in a way similar to a Read Committed isolation level even if Repeatable Read is enabled for example. If an entry was previously put in the context it will use this value, including if it was removed, in which case it will not be returned from the iterator.</p> </div> </div> <div class="sect4"> <h5 id="iterator_remove"><a class="anchor" href="#iterator_remove"></a>Iterator remove</h5> <div class="paragraph"> <p>We also do support the remove operation on the iterator. In a non transactional cache this will immediately remove the key from the cache. In a transactional cache this will instead be added to the existing transaction context if there is one otherwise an implicit transaction will be generated for it.</p> </div> </div> <div class="sect4"> <h5 id="value_conversion"><a class="anchor" href="#value_conversion"></a>Value conversion</h5> <div class="paragraph"> <p>While the provided filter can be used to efficiently reduce what entries are returned to the local node, there is also the possibility of providing an optional <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/filter/Converter.html">Converter</a> which will convert the provided value to another object or even type, which is done on the remote side. This is useful to reduce payload size when you may want only a partial view of the object or even an object that is created from it.</p> </div> <div class="paragraph"> <p>In this case we have a converter that can be used to convert a Car instance to instead return one of its wheels as determined by the value passed to the converter when created.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CarWheelConverter</span> <span class="directive">implements</span> Converter&lt;<span class="predefined-type">String</span>, Car, Wheel&gt; {
   <span class="directive">private</span> <span class="directive">final</span> <span class="type">int</span> wheelPosition;

   <span class="directive">public</span> CarWheelConverter(<span class="type">int</span> wheelPosition) {
     <span class="local-variable">this</span>.wheelPosition = wheelPosition;
   }
   <span class="annotation">@Override</span>
   <span class="directive">public</span> Wheel convert(<span class="predefined-type">String</span> key, Car value, Metadata metadata) {
      <span class="keyword">return</span> value.getWheels().wheel(wheelPosition);
   }
}


<span class="keyword">try</span> (CloseableIterable&lt;CacheEntry&lt;<span class="predefined-type">String</span>, Wheel&gt;&gt; iterable = advancedCache.filterEntries(teslaCarFilter).converter(<span class="keyword">new</span> CarWheelConverter(<span class="integer">3</span>)) {
   <span class="keyword">for</span> (CacheEntry&lt;<span class="predefined-type">String</span>, Wheel&gt; entry : iterable) {
      <span class="comment">// Do something with the third wheel of the car</span>
   }
}</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Remember that both the <code>KeyValueFilter</code> and the <code>Converter</code> must either implement <code>Serializable</code> or have a provided Infinispan <code>Externalizer</code> </td> </tr> </table> </div> </div> </div> <div class="sect3"> <h4 id="custom_interceptors"><a class="anchor" href="#custom_interceptors"></a>3.2.3. Custom Interceptors</h4> <div class="paragraph"> <p>The AdvancedCache interface also offers advanced developers a mechanism with which to attach custom interceptors. Custom interceptors allow developers to alter the behavior of the cache API methods, and the AdvancedCache interface allows developers to attach these interceptors programmatically, at run-time. See the AdvancedCache Javadocs for more details.</p> </div> <div class="paragraph"> <p>For more information on writing custom interceptors, see <a href="#_custom_interceptors_chapter">this chapter</a>.</p> </div> </div> </div> <div class="sect2"> <h3 id="_Listeners_and_notifications_section"><a class="anchor" href="#_Listeners_and_notifications_section"></a>3.3. Listeners and Notifications</h3> <div class="paragraph"> <p>Infinispan offers a listener API, where clients can register for and get notified when events take place. This annotation-driven API applies to 2 different levels: cache level events and cache manager level events.</p> </div> <div class="paragraph"> <p>Events trigger a notification which is dispatched to listeners. Listeners are simple <a href="http://en.wikipedia.org/wiki/Plain_Old_Java_Object">POJO</a> s annotated with <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/notifications/Listener.html">@Listener</a> and registered using the methods defined in the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/notifications/Listenable.html">Listenable</a> interface.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Both Cache and CacheManager implement Listenable, which means you can attach listeners to either a cache or a cache manager, to receive either cache-level or cache manager-level notifications. </td> </tr> </table> </div> <div class="paragraph"> <p>For example, the following class defines a listener to print out some information every time a new entry is added to the cache:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Listener</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PrintWhenAdded</span> {

<span class="error">Â </span> <span class="annotation">@CacheEntryCreated</span>
<span class="error">Â </span> <span class="directive">public</span> <span class="type">void</span> print(CacheEntryCreatedEvent event) {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">New entry </span><span class="delimiter">&quot;</span></span> + event.getKey() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> created in the cache</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span> }

}</code></pre> </div> </div> <div class="paragraph"> <p>For more comprehensive examples, please see the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/notifications/Listener.html">Javadocs for @Listener</a>.</p> </div> <div class="sect3"> <h4 id="cache_level_notifications"><a class="anchor" href="#cache_level_notifications"></a>3.3.1. Cache-level notifications</h4> <div class="paragraph"> <p>Cache-level events occur on a per-cache basis, and by default are only raised on nodes where the events occur. Note in a distributed cache these events are only raised on the owners of data being affected. Examples of cache-level events are entries being added, removed, modified, etc. These events trigger notifications to listeners registered to a specific cache.</p> </div> <div class="paragraph"> <p>Please see the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/notifications/cachelistener/annotation/package-summary.html">Javadocs on the org.infinispan.notifications.cachelistener.annotation package</a> for a comprehensive list of all cache-level notifications, and their respective method-level annotations.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Please refer to the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/notifications/cachelistener/annotation/package-summary.html">Javadocs on the org.infinispan.notifications.cachelistener.annotation package</a> for the list of cache-level notifications available in Infinispan. </td> </tr> </table> </div> <div class="sect4"> <h5 id="cluster_listeners"><a class="anchor" href="#cluster_listeners"></a>Cluster Listeners</h5> <div class="paragraph"> <p>The cluster listeners should be used when it is desirable to listen to the cache events on a single node.</p> </div> <div class="paragraph"> <p>To do so all that is required is set to annotate your listener as being clustered.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Listener</span> (clustered = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyClusterListener</span> { .... }</code></pre> </div> </div> <div class="paragraph"> <p>There are some limitations to cluster listeners from a non clustered listener.</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>A cluster listener can only listen to <code>@CacheEntryModified</code>, <code>@CacheEntryCreated</code>, <code>@CacheEntryRemoved</code> and <code>@CacheEntryExpired</code> events. Note this means any other type of event will not be listened to for this listener.</p> </li> <li> <p>Only the post event is sent to a cluster listener, the pre event is ignored.</p> </li> </ol> </div> </div> <div class="sect4"> <h5 id="event_filtering_and_conversion"><a class="anchor" href="#event_filtering_and_conversion"></a>Event filtering and conversion</h5> <div class="paragraph"> <p>All applicable events on the node where the listener is installed will be raised to the listener. It is possible to dynamically filter what events are raised by using a <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/filter/KeyFilter.html">KeyFilter</a> (only allows filtering on keys) or <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/notifications/cachelistener/filter/CacheEventFilter.html">CacheEventFilter</a> (used to filter for keys, old value, old metadata, new value, new metadata, whether command was retried, if the event is before the event (ie. isPre) and also the command type).</p> </div> <div class="paragraph"> <p>The example here shows a simple <code>KeyFilter</code> that will only allow events to be raised when an event modified the entry for the key <code>Only Me</code>.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SpecificKeyFilter</span> <span class="directive">implements</span> KeyFilter&lt;<span class="predefined-type">String</span>&gt; {
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> keyToAccept;

    <span class="directive">public</span> SpecificKeyFilter(<span class="predefined-type">String</span> keyToAccept) {
      <span class="keyword">if</span> (keyToAccept == <span class="predefined-constant">null</span>) {
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">NullPointerException</span>();
      }
      <span class="local-variable">this</span>.keyToAccept = keyToAccept;
    }

    <span class="type">boolean</span> accept(<span class="predefined-type">String</span> key) {
      <span class="keyword">return</span> keyToAccept.equals(key);
    }
}

...
cache.addListener(listener, <span class="keyword">new</span> SpecificKeyFilter(<span class="string"><span class="delimiter">&quot;</span><span class="content">Only Me</span><span class="delimiter">&quot;</span></span>));
...</code></pre> </div> </div> <div class="paragraph"> <p>This can be useful when you want to limit what events you receive in a more efficient manner.</p> </div> <div class="paragraph"> <p>There is also a <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/notifications/cachelistener/filter/CacheEventConverter.html">CacheEventConverter</a> that can be supplied that allows for converting a value to another before raising the event. This can be nice to modularize any code that does value conversions.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> The mentioned filters and converters are especially beneficial when used in conjunction with a Cluster Listener. This is because the filtering and conversion is done on the node where the event originated and not on the node where event is listened to. This can provide benefits of not having to replicate events across the cluster (filter) or even have reduced payloads (converter). </td> </tr> </table> </div> </div> <div class="sect4"> <h5 id="initial_state_events"><a class="anchor" href="#initial_state_events"></a>Initial State Events</h5> <div class="paragraph"> <p>When a listener is installed it will only be notified of events after it is fully installed.</p> </div> <div class="paragraph"> <p>It may be desirable to get the current state of the cache contents upon first registration of listener by having an event generated of type <code>@CacheEntryCreated</code> for each element in the cache. Any additionally generated events during this initial phase will be queued until appropriate events have been raised.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> This only works for clustered listeners at this time. <a href="https://issues.jboss.org/browse/ISPN-4608">ISPN-4608</a> covers adding this for non clustered listeners. </td> </tr> </table> </div> </div> <div class="sect4"> <h5 id="duplicate_events"><a class="anchor" href="#duplicate_events"></a>Duplicate Events</h5> <div class="paragraph"> <p>It is possible in a non transactional cache to receive duplicate events. This is possible when the primary owner of a key goes down while trying to perform a write operation such as a put.</p> </div> <div class="paragraph"> <p>Infinispan internally will rectify the put operation by sending it to the new primary owner for the given key automatically, however there are no guarantees in regards to if the write was first replicated to backups. Thus more than 1 of the following write events (<code>CacheEntryCreatedEvent</code>, <code>CacheEntryModifiedEvent</code> &amp; <code>CacheEntryRemovedEvent</code>) may be sent on a single operation.</p> </div> <div class="paragraph"> <p>If more than one event is generated Infinispan will mark the event that it was generated by a retried command to help the user to know when this occurs without having to pay attention to view changes.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Listener</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyRetryListener</span> {
  <span class="annotation">@CacheEntryModified</span>
  <span class="directive">public</span> <span class="type">void</span> entryModified(CacheEntryModifiedEvent event) {
    <span class="keyword">if</span> (event.isCommandRetried()) {
      <span class="comment">// Do something</span>
    }
  }
}</code></pre> </div> </div> <div class="paragraph"> <p>Also when using a <code>CacheEventFilter</code> or <code>CacheEventConverter</code> the <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/notifications/cachelistener/filter/EventType.html">EventType</a> contains a method <code>isRetry</code> to tell if the event was generated due to retry.</p> </div> </div> </div> <div class="sect3"> <h4 id="cache_manager_level_notifications"><a class="anchor" href="#cache_manager_level_notifications"></a>3.3.2. Cache manager-level notifications</h4> <div class="paragraph"> <p>Cache manager-level events occur on a cache manager. These too are global and cluster-wide, but involve events that affect all caches created by a single cache manager. Examples of cache manager-level events are nodes joining or leaving a cluster, or caches starting or stopping.</p> </div> <div class="paragraph"> <p>Please see the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/notifications/cachemanagerlistener/annotation/package-summary.html">Javadocs on the org.infinispan.notifications.cachemanagerlistener.annotation package</a> for a comprehensive list of all cache manager-level notifications, and their respective method-level annotations.</p> </div> </div> <div class="sect3"> <h4 id="synchronicity_of_events"><a class="anchor" href="#synchronicity_of_events"></a>3.3.3. Synchronicity of events</h4> <div class="paragraph"> <p>By default, all notifications are dispatched in the same thread that generates the event. This means that you <em>must</em> write your listener such that it does not block or do anything that takes too long, as it would prevent the thread from progressing. Alternatively, you could annotate your listener as <em>asynchronous</em> , in which case a separate thread pool will be used to dispatch the notification and prevent blocking the event originating thread. To do this, simply annotate your listener such:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Listener</span> (sync = <span class="predefined-constant">false</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyAsyncListener</span> { .... }</code></pre> </div> </div> <div class="sect4"> <h5 id="asynchronous_thread_pool"><a class="anchor" href="#asynchronous_thread_pool"></a>Asynchronous thread pool</h5> <div class="paragraph"> <p>To tune the thread pool used to dispatch such asynchronous notifications, use the <a href="http://docs.jboss.org/infinispan/8.2/configdocs/infinispan-config-8.2.html"><code>&lt;listener-executor /&gt;</code></a> XML element in your configuration file.</p> </div> </div> </div> </div> <div class="sect2"> <h3 id="asynchronous_api"><a class="anchor" href="#asynchronous_api"></a>3.4. Asynchronous API</h3> <div class="paragraph"> <p>In addition to synchronous API methods like <a href="http://docs.oracle.com/javase/7/docs/api/java/util/Map.html#put%28K,%20V%29">Cache.put()</a> , <a href="http://docs.oracle.com/javase/7/docs/api/java/util/Map.html#remove%28java.lang.Object%29">Cache.remove()</a> , etc., Infinispan also has an asynchronous, non-blocking API where you can achieve the same results in a non-blocking fashion.</p> </div> <div class="paragraph"> <p>These methods are named in a similar fashion to their blocking counterparts, with "Async" appended.Â  E.g., <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/Cache.html#putAsync%28K,%20V%29">Cache.putAsync()</a> , <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/Cache.html#removeAsync%28java.lang.Object%29">Cache.removeAsync()</a> , etc.Â  These asynchronous counterparts return a <a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/Future.html">Future</a> containing the actual result of the operation.</p> </div> <div class="paragraph"> <p>For example, in a cache parameterized as <code>Cache&lt;String, String&gt;</code>, <code>Cache.put(String key, String value)</code> returns a <code>String</code>. <code>Cache.putAsync(String key, String value)</code> would return a <code>Future&lt;String&gt;</code>.</p> </div> <div class="sect3"> <h4 id="why_use_such_an_api"><a class="anchor" href="#why_use_such_an_api"></a>3.4.1. Why use such an API?</h4> <div class="paragraph"> <p>Non-blocking APIs are powerful in that they provide all of the guarantees of synchronous communications - with the ability to handle communication failures and exceptions - with the ease of not having to block until a call completes.Â  This allows you to better harness parallelism in your system.Â  For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Set</span>&lt;<span class="predefined-type">Future</span>&lt;?&gt;&gt; futures = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;<span class="predefined-type">Future</span>&lt;?&gt;&gt;();
futures.add(cache.putAsync(key1, value1)); <span class="comment">// does not block</span>
futures.add(cache.putAsync(key2, value2)); <span class="comment">// does not block</span>
futures.add(cache.putAsync(key3, value3)); <span class="comment">// does not block</span>

<span class="comment">// the remote calls for the 3 puts will effectively be executed</span>
<span class="comment">// in parallel, particularly useful if running in distributed mode</span>
<span class="comment">// and the 3 keys would typically be pushed to 3 different nodes</span>
<span class="comment">// in the cluster</span>

<span class="comment">// check that the puts completed successfully</span>
<span class="keyword">for</span> (<span class="predefined-type">Future</span>&lt;?&gt; f: futures) f.get();</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="which_processes_actually_happen_asynchronously"><a class="anchor" href="#which_processes_actually_happen_asynchronously"></a>3.4.2. Which processes actually happen asynchronously?</h4> <div class="paragraph"> <p>There are 4 things in Infinispan that can be considered to be on the critical path of a typical write operation. These are, in order of cost:</p> </div> <div class="ulist"> <ul> <li> <p>network calls</p> </li> <li> <p>marshalling</p> </li> <li> <p>writing to a cache store (optional)</p> </li> <li> <p>locking</p> </li> </ul> </div> <div class="paragraph"> <p>As of Infinispan 4.0, using the async methods will take the network calls and marshalling off the critical path.Â  For various technical reasons, writing to a cache store and acquiring locks, however, still happens in the caller&#8217;s thread.Â  In future, we plan to take these offline as well.Â  See <a href="http://lists.jboss.org/pipermail/infinispan-dev/2010-January/002219.html">this developer mail list thread</a> about this topic.</p> </div> </div> <div class="sect3"> <h4 id="notifying_futures"><a class="anchor" href="#notifying_futures"></a>3.4.3. Notifying futures</h4> <div class="paragraph"> <p>Strictly, these methods do not return JDK Futures, but rather a sub-interface known as a <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/commons/util/concurrent/NotifyingFuture.html">NotifyingFuture</a> .Â  The main difference is that you can attach a listener to a NotifyingFuture such that you could be notified when the future completes.Â  Here is an example of making use of a notifying future:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">FutureListener futureListener = <span class="keyword">new</span> FutureListener() {

   <span class="directive">public</span> <span class="type">void</span> futureDone(<span class="predefined-type">Future</span> future) {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>   <span class="keyword">try</span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>future.get();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>} <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="comment">// Future did not complete successfully</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Help!</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>}
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>}
};
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
cache.putAsync(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>).attachListener(futureListener);</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="further_reading_2"><a class="anchor" href="#further_reading_2"></a>3.4.4. Further reading</h4> <div class="paragraph"> <p>The Javadocs on the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/Cache.html">Cache</a> interface has some examples on using the asynchronous API, as does <a href="http://infinispan.blogspot.com/2009/05/whats-so-cool-about-asynchronous-api.html">this article</a> by Manik Surtani introducing the API.</p> </div> </div> </div> <div class="sect2"> <h3 id="invocation_flags"><a class="anchor" href="#invocation_flags"></a>3.5. Invocation Flags</h3> <div class="paragraph"> <p>An important aspect of getting the most of Infinispan is the use of per-invocation flags in order to provide specific behaviour to each particular cache call. By doing this, some important optimizations can be implemented potentially saving precious time and network resources. One of the most popular usages of flags can be found right in Cache API, underneath the link:http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/Cache.html#putForExternalRead(K, V)[putForExternalRead()] method which is used to load an Infinispan cache with data read from an external resource. In order to make this call efficient, Infinispan basically calls a normal put operation passing the following flags: <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/context/Flag.html#FAIL_SILENTLY">FAIL_SILENTLY</a> , <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/context/Flag.html#FORCE_ASYNCHRONOUS">FORCE_ASYNCHRONOUS</a> , <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/context/Flag.html#ZERO_LOCK_ACQUISITION_TIMEOUT">ZERO_LOCK_ACQUISITION_TIMEOUT</a></p> </div> <div class="paragraph"> <p>What Infinispan is doing here is effectively saying that when putting data read from external read, it will use an almost-zero lock acquisition time and that if the locks cannot be acquired, it will fail silently without throwing any exception related to lock acquisition. It also specifies that regardless of the cache mode, if the cache is clustered, it will replicate asynchronously and so won&#8217;t wait for responses from other nodes. The combination of all these flags make this kind of operation very efficient, and the efficiency comes from the fact this type of <em>putForExternalRead</em> calls are used with the knowledge that client can always head back to a persistent store of some sorts to retrieve the data that should be stored in memory. So, any attempt to store the data is just a best effort and if not possible, the client should try again if there&#8217;s a cache miss.</p> </div> <div class="sect3"> <h4 id="decoratedcache"><a class="anchor" href="#decoratedcache"></a>3.5.1. DecoratedCache</h4> <div class="paragraph"> <p>Another approach would be to use the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/DecoratedCache.html">DecoratedCache</a> wrapper. This allows you to reuse flags. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">AdvancedCache cache = ...
DecoratedCache strictlyLocal = <span class="keyword">new</span> DecoratedCache(cache, Flag.CACHE_MODE_LOCAL, Flag.SKIP_CACHE_STORE);
strictlyLocal.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">local_1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">only</span><span class="delimiter">&quot;</span></span>);
strictlyLocal.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">local_2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">only</span><span class="delimiter">&quot;</span></span>);
strictlyLocal.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">local_3</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">only</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>This approach makes your code more readable.</p> </div> </div> <div class="sect3"> <h4 id="examples"><a class="anchor" href="#examples"></a>3.5.2. Examples</h4> <div class="paragraph"> <p>If you want to use these or any other flags available, which by the way are described in detail the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/context/Flag.html">Flag enumeration</a> , you simply need to get hold of the advanced cache and add the flags you need via the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/AdvancedCache.html#withFlags(org.infinispan.context.Flag&#8230;&#8203;)">withFlags()</a> method call. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Cache cache = ...
cache.getAdvancedCache()
<span class="error">Â </span><span class="error">Â </span> .withFlags(Flag.SKIP_CACHE_STORE, Flag.CACHE_MODE_LOCAL)
<span class="error">Â </span><span class="error">Â </span> .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">only</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>It&#8217;s worth noting that these flags are only active for the duration of the cache operation. If the same flags need to be used in several invocations, even if they&#8217;re in the same transaction, <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/AdvancedCache.html#withFlags(org.infinispan.context.Flag&#8230;&#8203;)">withFlags()</a> needs to be called repeatedly. Clearly, if the cache operation is to be replicated in another node, the flags are carried over to the remote nodes as well.</p> </div> <div class="sect4"> <h5 id="suppressing_return_values_from_a_put_or_remove"><a class="anchor" href="#suppressing_return_values_from_a_put_or_remove"></a>Suppressing return values from a put() or remove()</h5> <div class="paragraph"> <p>Another very important use case is when you want a write operation such as put() to <em>not</em> return the previous value. To do that, you need to use two flags to make sure that in a distributed environment, no remote lookup is done to potentially get previous value, and if the cache is configured with a cache loader, to avoid loading the previous value from the cache store. You can see these two flags in action in the following example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Cache cache = ...
cache.getAdvancedCache()
<span class="error">Â </span><span class="error">Â </span> .withFlags(Flag.SKIP_REMOTE_LOOKUP, Flag.SKIP_CACHE_LOAD)
<span class="error">Â </span><span class="error">Â </span> .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">only</span><span class="delimiter">&quot;</span></span>)</code></pre> </div> </div> <div class="paragraph"> <p>For more information, please check the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/context/Flag.html">Flag enumeration</a> javadoc.</p> </div> </div> </div> </div> <div class="sect2"> <h3 id="tree_api_module"><a class="anchor" href="#tree_api_module"></a>3.6. Tree API Module</h3> <div class="paragraph"> <p><a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/tree/package-summary.html">Infinispan&#8217;s tree API module</a> offers clients the possibility of storing data using a tree-structure like API. This API is similar to the one <a href="http://docs.jboss.org/jbosscache/3.2.1.GA/apidocs/org/jboss/cache/package-summary.html">provided by JBoss Cache</a>, hence the tree module is perfect for those users wanting to migrate their applications from JBoss Cache to Infinispan, who want to limit changes their codebase as part of the migration. Besides, it&#8217;s important to understand that Infinispan provides this tree API much more efficiently than JBoss Cache did, so if you&#8217;re a user of the tree API in JBoss Cache, you should consider migrating to Infinispan.</p> </div> <div class="sect3"> <h4 id="what_is_tree_api_about"><a class="anchor" href="#what_is_tree_api_about"></a>3.6.1. What is Tree API about?</h4> <div class="paragraph"> <p>The aim of this API is to store information in a hierarchical way. The hierarchy is defined using paths represented as <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/tree/Fqn.html">Fqn or fully qualified names</a> , for example: <em>/this/is/a/fqn/path</em> or <em>/another/path</em> . In the hierarchy, there&#8217;s a special path called root which represents the starting point of all paths and it&#8217;s represented as: <em>/</em></p> </div> <div class="paragraph"> <p>Each FQN path is represented as a node where users can store data using a key/value pair style API (i.e. a Map). For example, in <em>/persons/john</em> , you could store information belonging to John, for example: surname=Smith, birthdate=05/02/1980&#8230;&#8203;etc.</p> </div> <div class="paragraph"> <p>Please remember that users should not use root as a place to store data. Instead, users should define their own paths and store data there. The following sections will delve into the practical aspects of this API.</p> </div> </div> <div class="sect3"> <h4 id="using_the_tree_api"><a class="anchor" href="#using_the_tree_api"></a>3.6.2. Using the Tree API</h4> <div class="sect4"> <h5 id="dependencies"><a class="anchor" href="#dependencies"></a>Dependencies</h5> <div class="paragraph"> <p>For your application to use the tree API, you need to import infinispan-tree.jar which can be located in the Infinispan binary distributions, or you can simply add a dependency to this module in your pom.xml:</p> </div> <div class="listingblock"> <div class="title">pom.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencies&gt;</span>
Â  ...
Â  <span class="tag">&lt;dependency&gt;</span>
Â Â Â  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
Â Â Â  <span class="tag">&lt;artifactId&gt;</span>infinispan-tree<span class="tag">&lt;/artifactId&gt;</span>
Â Â Â  <span class="tag">&lt;version&gt;</span>$put-infinispan-version-here<span class="tag">&lt;/version&gt;</span>
Â  <span class="tag">&lt;/dependency&gt;</span>
Â  ...
<span class="tag">&lt;/dependencies&gt;</span></code></pre> </div> </div> </div> </div> <div class="sect3"> <h4 id="creating_a_tree_cache"><a class="anchor" href="#creating_a_tree_cache"></a>3.6.3. Creating a Tree Cache</h4> <div class="paragraph"> <p>The first step to use the tree API is to actually create a tree cache. To do so, you need to <a href="#_configuring_cache">create an Infinispan Cache as you&#8217;d normally do, and using the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/tree/TreeCacheFactory.html">TreeCacheFactory</a> , create an instance of <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/tree/TreeCache.html">TreeCache</a> . A very important note to remember here is that the Cache instance passed to the factory must be configured with &lt;&lt;_batching, invocation batching</a>. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.config.Configuration</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.tree.TreeCacheFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.tree.TreeCache</span>;
...
Configuration config = <span class="keyword">new</span> <span class="predefined-type">Configuration</span>();
config.setInvocationBatchingEnabled(<span class="predefined-constant">true</span>);
Cache cache = <span class="keyword">new</span> DefaultCacheManager(config).getCache();
TreeCache treeCache = TreeCacheFactory.createTreeCache(cache);</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="manipulating_data_in_a_tree_cache"><a class="anchor" href="#manipulating_data_in_a_tree_cache"></a>3.6.4. Manipulating data in a Tree Cache</h4> <div class="paragraph"> <p>The Tree API effectively provides two ways to interact with the data:</p> </div> <div class="paragraph"> <p>Via <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/tree/TreeCache.html">TreeCache</a> convenience methods: These methods are located within the TreeCache interface and enable users to link:http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/tree/TreeCache.html#put(java.lang.String, K, V)[store] , link:http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/tree/TreeCache.html#get(org.infinispan.tree.Fqn, K)[retrieve] , link:http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/tree/TreeCache.html#move(org.infinispan.tree.Fqn, org.infinispan.tree.Fqn)[move] , link:http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/tree/TreeCache.html#remove(org.infinispan.tree.Fqn, K)[remove] &#8230;&#8203;etc data with a single call that takes the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/tree/Fqn.html">Fqn</a> , in String or Fqn format, and the data involved in the call. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">treeCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">/persons/john</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Smith</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>Or:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.tree.Fqn</span>;
...
Fqn johnFqn = Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons/john</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">Calendar</span> calendar = <span class="predefined-type">Calendar</span>.getInstance();
calendar.set(<span class="integer">1980</span>, <span class="integer">5</span>, <span class="integer">2</span>);
treeCache.put(johnFqn, <span class="string"><span class="delimiter">&quot;</span><span class="content">birthdate</span><span class="delimiter">&quot;</span></span>, calendar.getTime()));</code></pre> </div> </div> <div class="paragraph"> <p>Via <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/tree/Node.html">Node</a> API: It allows finer control over the individual nodes that form the FQN, allowing manipulation of nodes relative to a particular node. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.tree.Node</span>;
...
TreeCache treeCache = ...
Fqn johnFqn = Fqn.fromElements(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">john</span><span class="delimiter">&quot;</span></span>);
Node&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; john = treeCache.getRoot().addChild(johnFqn);
john.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Smith</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>Or:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Node persons = treeCache.getRoot().addChild(Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons</span><span class="delimiter">&quot;</span></span>));
Node&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; john = persons.addChild(Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">john</span><span class="delimiter">&quot;</span></span>));
john.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Smith</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>Or even:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Fqn personsFqn = Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons</span><span class="delimiter">&quot;</span></span>);
Fqn johnFqn = Fqn.fromRelative(personsFqn, Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">john</span><span class="delimiter">&quot;</span></span>));
Node&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; john = treeCache.getRoot().addChild(johnFqn);
john.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Smith</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>A node also provides the ability to access its <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/tree/Node.html#getParent()">parent</a> or <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/tree/Node.html#getChildren()">children</a> . For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Node&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; john = ...
Node persons = john.getParent();</code></pre> </div> </div> <div class="paragraph"> <p>Or:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Set</span>&lt;Node&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;&gt; personsChildren = persons.getChildren();</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="common_operations"><a class="anchor" href="#common_operations"></a>3.6.5. Common Operations</h4> <div class="paragraph"> <p>In the previous section, some of the most used operations, such as addition and retrieval, have been shown. However, there are other important operations that are worth mentioning, such as remove:</p> </div> <div class="paragraph"> <p>You can for example remove an entire node, i.e. <em>/persons/john</em> , using:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">treeCache.removeNode(<span class="string"><span class="delimiter">&quot;</span><span class="content">/persons/john</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>Or remove a child node, i.e. persons that a child of root, via:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">treeCache.getRoot().removeChild(Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons</span><span class="delimiter">&quot;</span></span>));</code></pre> </div> </div> <div class="paragraph"> <p>You can also remove a particular key/value pair in a node:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Node john = treeCache.getRoot().getChild(Fqn.fromElements(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">john</span><span class="delimiter">&quot;</span></span>));
john.remove(<span class="string"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>Or you can remove all data in a node with:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Node john = treeCache.getRoot().getChild(Fqn.fromElements(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">john</span><span class="delimiter">&quot;</span></span>));
john.clearData();</code></pre> </div> </div> <div class="paragraph"> <p>Another important operation supported by Tree API is the ability to move nodes around in the tree. Imagine we have a node called "john" which is located under root node. The following example is going to show how to we can move "john" node to be under "persons" node:</p> </div> <div class="paragraph"> <p>Current tree structure:</p> </div> <div class="listingblock"> <div class="content"> <pre>Â Â  /persons
Â Â  /john</pre> </div> </div> <div class="paragraph"> <p>Moving trees from one FQN to another:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Node john = treeCache.getRoot().addChild(Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">john</span><span class="delimiter">&quot;</span></span>));
Node persons = treeCache.getRoot().getChild(Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons</span><span class="delimiter">&quot;</span></span>));
treeCache.move(john.getFqn(), persons.getFqn());</code></pre> </div> </div> <div class="paragraph"> <p>Final tree structure:</p> </div> <div class="listingblock"> <div class="content"> <pre>   /persons/john</pre> </div> </div> </div> <div class="sect3"> <h4 id="locking_in_the_tree_api"><a class="anchor" href="#locking_in_the_tree_api"></a>3.6.6. Locking in the Tree API</h4> <div class="paragraph"> <p>Understanding when and how locks are acquired when manipulating the tree structure is important in order to maximise the performance of any client application interacting against the tree, while at the same time maintaining consistency.</p> </div> <div class="paragraph"> <p>Locking on the tree API happens on a per node basis. So, if you&#8217;re putting or updating a key/value under a particular node, a write lock is acquired for that node. In such case, no write locks are acquired for parent node of the node being modified, and no locks are acquired for children nodes.</p> </div> <div class="paragraph"> <p>If you&#8217;re adding or removing a node, the parent is not locked for writing. In JBoss Cache, this behaviour was configurable with the default being that parent was not locked for insertion or removal.</p> </div> <div class="paragraph"> <p>Finally, when a node is moved, the node that&#8217;s been moved and any of its children are locked, but also the target node and the new location of the moved node and its children. To understand this better, let&#8217;s look at an example:</p> </div> <div class="paragraph"> <p>Imagine you have a hierarchy like this and we want to move c/ to be underneath b/:</p> </div> <div class="listingblock"> <div class="content"> <pre>Â Â Â Â Â Â Â  /
Â Â Â Â Â  --|--
Â Â Â Â  /Â Â Â Â  \
Â Â Â Â  aÂ Â Â Â  c
Â Â Â Â  |Â Â Â Â  |
Â Â Â Â  bÂ Â Â Â  e
Â Â Â Â  |
Â Â Â Â  d</pre> </div> </div> <div class="paragraph"> <p>The end result would be something like this:</p> </div> <div class="listingblock"> <div class="content"> <pre>Â Â Â Â Â Â Â  /
Â Â Â Â Â Â Â  |Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  aÂ Â Â Â 
Â Â Â Â Â Â Â  |Â Â Â Â 
Â Â Â Â Â Â Â  bÂ Â Â Â 
Â Â Â Â Â  --|--
Â Â Â Â  /Â Â Â Â  \
Â Â Â Â  dÂ Â Â Â  c
Â Â Â Â Â Â Â Â Â Â  |
Â Â Â Â Â Â Â Â Â Â  e</pre> </div> </div> <div class="paragraph"> <p>To make this move, locks would have been acquired on:</p> </div> <div class="ulist"> <ul> <li> <p><em>/a/b</em> - because it&#8217;s the parent underneath which the data will be put</p> </li> <li> <p><em>/c</em> and <em>/c/e</em> - because they&#8217;re the nodes that are being moved</p> </li> <li> <p><em>/a/b/c</em> and <em>/a/b/c/e</em> - because that&#8217;s new target location for the nodes being moved</p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="sid-68355037_TreeAPIModule-Listenersfortreecacheevents"><a class="anchor" href="#sid-68355037_TreeAPIModule-Listenersfortreecacheevents"></a>3.6.7. Listeners for tree cache events</h4> <div class="paragraph"> <p>The current Infinispan listeners have been designed with key/value store notifications in mind, and hence they do not map to tree cache events correctly. Tree cache specific listeners that map directly to tree cache events (i.e. adding a child&#8230;&#8203;etc) are desirable but these are not yet available. If you&#8217;re interested in this type of listeners, please follow <a href="https://issues.jboss.org/browse/ISPN-1935">this issue</a> to find out about any progress in this area.</p> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="eviction_anchor"><a class="anchor" href="#eviction_anchor"></a>4. Eviction</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan supports eviction of entries, such that you do not run out of memory. Eviction is typically used in conjunction with a cache store, so that entries are not permanently lost when evicted, since eviction only removes entries from memory and not from cache stores or the rest of the cluster.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> Passivation is also a popular option when using eviction, so that only a single copy of an entry is maintained - either in memory or in a cache store, but not both. The main benefit of using passivation over a regular cache store is that updates to entries which exist in memory are cheaper since the update doesn&#8217;t need to be made to the cache store as well. </td> </tr> </table> </div> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="fa icon-important" title="Important"></i> </td> <td class="content"> that eviction occurs on a <em>local</em> basis, and is not cluster-wide. Each node runs an eviction thread to analyse the contents of its in-memory container and decide what to evict. Eviction does not take into account the amount of free memory in the JVM as threshold to starts evicting entries. You have to set maxEntries attribute of the eviction element to be greater than zero in order for eviction to be turned on. If maxEntries is too large you can run out of memory. maxEntries attribute will probably take some tuning in each use case. </td> </tr> </table> </div> <div class="sect2"> <h3 id="enabling_eviction"><a class="anchor" href="#enabling_eviction"></a>4.1. Enabling Eviction</h3> <div class="paragraph"> <p>Eviction is configured by adding the <a href="http://docs.jboss.org/infinispan/8.2/configdocs/infinispan-config-8.2.html"><code>&lt;eviction /&gt;</code></a> element to your <code>&lt;*-cache /&gt;</code> configuration sections or using <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/configuration/cache/EvictionConfigurationBuilder.html">EvictionConfigurationBuilder</a> API programmatic approach.</p> </div> <div class="paragraph"> <p>All cache entry are evicted by piggybacking on user threads that are hitting the cache. Periodic pruning of expired cache entries from cache is done on a dedicated thread which is turned on by enabling reaper in expiration configuration element/API.</p> </div> <div class="sect3"> <h4 id="eviction_strategies"><a class="anchor" href="#eviction_strategies"></a>4.1.1. Eviction strategies</h4> <div class="paragraph"> <div class="title"><code>NONE</code></div> <p>This eviction strategy effectively disables the eviction thread. This is the default configuration.</p> </div> <div class="paragraph"> <div class="title"><code>UNORDERED</code></div> <p>UNORDERED eviction strategy is a legacy eviction strategy that has been deprecated. If UNORDERED strategy is specified LRU eviction algorithm will be used.</p> </div> <div class="paragraph"> <div class="title"><code>LRU</code></div> <p>If LRU eviction is used cache entries are selected for eviction using a well known least-recently-used pattern.</p> </div> <div class="paragraph"> <div class="title"><code>LIRS</code></div> <p>LRU eviction algorithm, although simple and easy to understand, under performs in cases of weak access locality (one time access entries are not timely replaced, entries to be accessed soonest are unfortunately replaced, and so on). Recently, a new eviction algorithm - LIRS has gathered a lot of attention because it addresses weak access locality shortcomings of LRU yet it retains LRU&#8217;s simplicity. Eviction in LIRS algorithm relies on history information of cache entries accesses using so called Inter-Reference Recency (a.k.a IRR) and the Recency. The IRR of a cache entry A refers to number of other distinct entries accessed between the last two consecutive accesses to cache entry A, while recency refers to the number of other entries accessed from last reference to A up to current time point. If we relied only on cache recency we would essentially have LRU functionality. However, in addition to recency LIRS tracks elements that are in low IRR and high IRR, aptly named LIR and HIR cache entry blocks respectively. LIRS eviction algorithm essentially keeps entries with a low IRR in the cache as much as possible while evicting high IRR entries if eviction is required. If recency of a LIR cache entry increases to a certain point and entry in HIR gets accessed at a smaller recency than that of the LIR entry, the LIR/HIR statuses of the two blocks are switched. Entries in HIR may be evicted regardless of its recency, even if element was recently accessed.</p> </div> <div class="paragraph"> <div class="title"><code>MANUAL</code></div> <p>This eviction strategy is identical to NONE, in that it disables automatic eviction altogether, but signals the intention that the user wants to evict entries manually. The effect is to disable misleading warning validation messages.</p> </div> </div> <div class="sect3"> <h4 id="more_defaults"><a class="anchor" href="#more_defaults"></a>4.1.2. More defaults</h4> <div class="paragraph"> <p>By default when no <code>&lt;eviction /&gt;</code> element is specified, no eviction takes place.</p> </div> <div class="paragraph"> <p>In case there is an eviction element, this table describes behaviour of eviction based on information provided in the xml configuration ("-" in Supplied maxEntries or Supplied strategy column means that the attribute wasn&#8217;t supplied)</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Supplied maxEntries</th> <th class="tableblock halign-left valign-top">Supplied strategy</th> <th class="tableblock halign-left valign-top">Example</th> <th class="tableblock halign-left valign-top">Eviction behaviour</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;eviction /&gt;</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">no eviction</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&gt; 0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;eviction max-entries="100" /&gt;</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">the strategy defaults to LIRS and eviction takes place</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&gt; 0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">NONE</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;eviction max-entries="100" strategy="NONE" /&gt;</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">the strategy defaults to LIRS and eviction takes place</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&gt; 0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">!= NONE</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;eviction max-entries="100" strategy="LRU" /&gt;</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">eviction takes place with defined strategy</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;eviction max-entries="0" /&gt;</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">no eviction</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">NONE</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;eviction max-entries="0" strategy="NONE" /&gt;</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">no eviction</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">!= NONE</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;eviction max-entries="0" strategy="LRU" /&gt;</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ConfigurationException</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&lt; 0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;eviction max-entries="-1" /&gt;</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">no eviction</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&lt; 0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">NONE</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;eviction max-entries="-1" strategy="NONE" /&gt;</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">no eviction</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&lt; 0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">!= NONE</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;eviction max-entries="-1" strategy="LRU" /&gt;</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ConfigurationException</p></td> </tr> </tbody> </table> </div> </div> <div class="sect2"> <h3 id="expiration"><a class="anchor" href="#expiration"></a>4.2. Expiration</h3> <div class="paragraph"> <p>Similar to, but unlike eviction, is expiration. Expiration allows you to attach lifespan and/or maximum idle times to entries. Entries that exceed these times are treated as invalid and are removed. When removed expired entries are not passivated like evicted entries (if passivation is turned on).</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> Unlike eviction, expired entries are removed globally - from memory, cache stores, and cluster-wide. </td> </tr> </table> </div> <div class="paragraph"> <p>By default entries created are immortal and do not have a lifespan or maximum idle time. Using the cache API, mortal entries can be created with lifespans and/or maximum idle times. Further, default lifespans and/or maximum idle times can be configured by adding the <a href="http://docs.jboss.org/infinispan/8.2/configdocs/infinispan-config-8.2.html">&lt;expiration /&gt;</a> element to your <code>&lt;*-cache /&gt;</code> configuration sections.</p> </div> <div class="sect3"> <h4 id="difference_between_eviction_and_expiration"><a class="anchor" href="#difference_between_eviction_and_expiration"></a>4.2.1. Difference between Eviction and Expiration</h4> <div class="paragraph"> <p>Both Eviction and Expiration are means of cleaning the cache of unused entries and thus guarding the heap against OutOfMemory exceptions, so now a brief explanation of the difference.</p> </div> <div class="paragraph"> <p>With <em>eviction</em> you set <em>maximal number of entries</em> you want to keep in the cache and if this limit is exceeded, some candidates are found to be removed according to a choosen <em>eviction strategy</em> (LRU, LIRS, etc&#8230;&#8203;). Eviction can be setup to work with passivation (evicting to a cache store).</p> </div> <div class="paragraph"> <p>With <em>expiration</em> you set <em>time criteria</em> for entries, <em>how long you want to keep them</em> in cache. Either you set maximum <em>lifespan</em> of the entry - time it is allowed to stay in the cache or <em>maximum idle time</em> , time it&#8217;s allowed to be untouched (no operation performed with given key).</p> </div> </div> </div> <div class="sect2"> <h3 id="eviction_examples"><a class="anchor" href="#eviction_examples"></a>4.3. Eviction Examples</h3> <div class="olist arabic"> <ol class="arabic"> <li> <p><em>Expiration</em> is a top-level construct, represented in the configuration as well as in the cache API.</p> </li> <li> <p>While eviction is <em>local to each cache instance</em> , expiration is <em>cluster-wide</em> . Expiration lifespans and maxIdle values are replicated along with the cache entry.</p> </li> <li> <p>Expiration lifespan and maxIdle are also persisted in CacheStores, so this information survives eviction/passivation.</p> </li> <li> <p>Four eviction strategies are shipped, <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/eviction/EvictionStrategy.html#NONE">EvictionStrategy.NONE</a> , <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/eviction/EvictionStrategy.html#LRU">EvictionStrategy.LRU</a> , <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/eviction/EvictionStrategy.html#UNORDERED">EvictionStrategy.UNORDERED</a> , and <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/eviction/EvictionStrategy.html#LIRS">EvictionStrategy.LIRS</a> .</p> </li> </ol> </div> <div class="sect3"> <h4 id="configuration"><a class="anchor" href="#configuration"></a>4.3.1. Configuration</h4> <div class="paragraph"> <p>Eviction may be configured using the Configuration bean or the XML file. Eviction configuration is on a per-cache basis. Valid eviction-related configuration elements are:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;eviction</span> <span class="attribute-name">strategy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LRU</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-entries</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;expiration</span> <span class="attribute-name">lifespan</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-idle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">500</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Programmatically, the same would be defined using:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder().eviction().strategy(EvictionStrategy.LRU)
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .maxEntries(<span class="integer">2000</span>).expiration().wakeUpInterval(<span class="integer">5000l</span>).lifespan(<span class="integer">1000l</span>).maxIdle(<span class="integer">500l</span>)
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> .build();</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="default_values"><a class="anchor" href="#default_values"></a>4.3.2. Default values</h4> <div class="paragraph"> <p>Eviction is disabled by default. If enabled (using an empty <code>&lt;eviction /&gt;</code> element), certain default values are used:</p> </div> <div class="ulist"> <ul> <li> <p>strategy: EvictionStrategy.NONE is assumed, if a strategy is not specified..</p> </li> <li> <p>wakeupInterval: 5000 is used if not specified.</p> </li> <li> <p>If you wish to disable the eviction thread, set wakeupInterval to -1.</p> </li> <li> <p>maxEntries: -1 is used if not specified, which means unlimited entries.</p> </li> <li> <p>0 means no entries, and the eviction thread will strive to keep the cache empty.</p> </li> </ul> </div> <div class="paragraph"> <p>Expiration lifespan and maxIdle both default to -1.</p> </div> </div> <div class="sect3"> <h4 id="using_expiration"><a class="anchor" href="#using_expiration"></a>4.3.3. Using expiration</h4> <div class="paragraph"> <p>Expiration allows you to set either a lifespan or a maximum idle time on each key/value pair stored in the cache. This can either be set cache-wide using the configuration, as described above, or it can be defined per-key/value pair using the Cache interface. Any values defined per key/value pair overrides the cache-wide default for the specific entry in question.</p> </div> <div class="paragraph"> <p>For example, assume the following configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;expiration</span> <span class="attribute-name">lifespan</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// this entry will expire in 1000 millis</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">pinot noir</span><span class="delimiter">&quot;</span></span>, pinotNoirPrice);

<span class="comment">// this entry will expire in 2000 millis</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">chardonnay</span><span class="delimiter">&quot;</span></span>, chardonnayPrice, <span class="integer">2</span>, <span class="predefined-type">TimeUnit</span>.SECONDS);

<span class="comment">// this entry will expire 1000 millis after it is last accessed</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">pinot grigio</span><span class="delimiter">&quot;</span></span>, pinotGrigioPrice, -<span class="integer">1</span>,
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">TimeUnit</span>.SECONDS, <span class="integer">1</span>, <span class="predefined-type">TimeUnit</span>.SECONDS);

<span class="comment">// this entry will expire 1000 millis after it is last accessed, or</span>
<span class="comment">// in 5000 millis, which ever triggers first</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">riesling</span><span class="delimiter">&quot;</span></span>, rieslingPrice, <span class="integer">5</span>,
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">TimeUnit</span>.SECONDS, <span class="integer">1</span>, <span class="predefined-type">TimeUnit</span>.SECONDS);</code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="eviction_designs"><a class="anchor" href="#eviction_designs"></a>4.4. Eviction designs</h3> <div class="paragraph"> <p>Central to eviction is an EvictionManager - which is only available if eviction or expiration is configured.</p> </div> <div class="paragraph"> <p>The purpose of the EvictionManager is to drive the eviction/expiration thread which periodically purges items from the DataContainer. If the eviction thread is disabled (wakeupInterval set to -1) eviction can be kicked off manually using EvictionManager.processEviction(), for example from another maintenance thread that may run periodically in your application.</p> </div> <div class="paragraph"> <p>The eviction manager processes evictions in the following manner:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Causes the data container to purge expired entries</p> </li> <li> <p>Causes cache stores (if any) to purge expired entries</p> </li> <li> <p>Prunes the data container to a specific size, determined by maxElements</p> </li> </ol> </div> </div> </div> </div> <div class="sect1"> <h2 id="persistence"><a class="anchor" href="#persistence"></a>5. Persistence</h2> <div class="sectionbody"> <div class="paragraph"> <p>Persistence allows configuring external (persistent) storage engines complementary to the default in memory storage offered by Infinispan. An external persistent storage might be useful for several reasons:</p> </div> <div class="ulist"> <ul> <li> <p>Increased Durability. Memory is volatile, so a cache store could increase the life-span of the information store in the cache.</p> </li> <li> <p>Write-through. Interpose Infinispan as a caching layer between an application and a (custom) external storage engine.</p> </li> <li> <p>Overflow Data. By using eviction and passivation, one can store only the "hot" data in memory and overflow the data that is less frequently used to disk.</p> </li> </ul> </div> <div class="paragraph"> <p>The integration with the persistent store is done through the following SPI: CacheLoader, CacheWriter, AdvancedCacheLoader and AdvancedCacheWriter (discussed in the following sections).</p> </div> <div class="dlist"> <dl> <dt class="hdlist1">This SPI was refactored in Infinispan 6. It brings the following improvements over the previous (up to 5.x) persistence integration</dt> <dd> <div class="ulist"> <ul> <li> <p>Alignment with <a href="http://jcp.org/en/jsr/detail?id=107">JSR-107</a>. The <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/spi/CacheWriter.html">CacheWriter</a> and <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/spi/CacheLoader.html">CacheLoader</a> interface are similar to the the loader and writer in JSR 107. This should considerably help writing portable stores across JCache compliant vendors.</p> </li> <li> <p>Simplified Transaction Integration. All necessary locking is handled by Infinispan automatically and implementations donât have to be concerned with coordinating concurrent access to the store. Even though concurrent writes on the same key are not going to happen (depending locking mode in use), implementors should expect operations on the store to happen from multiple/different threads and code the implementation accordingly.</p> </li> <li> <p>Parallel Iteration. It is now possible to iterate over entries in the store with multiple threads in parallel.</p> </li> <li> <p>Reduced Serialization. This translates in less CPU usage. The new API exposes the stored entries in serialized format. If an entry is fetched from persistent storage for the sole purpose of being sent remotely, we no longer need to deserialize it (when reading from the store) and serialize it back (when writing to the wire). Now we can write to the wire the serialized format as read from the storage directly.</p> </li> </ul> </div> </dd> </dl> </div> <div class="sect2"> <h3 id="_Data_migration_section"><a class="anchor" href="#_Data_migration_section"></a>5.1. Data Migration</h3> <div class="paragraph"> <p>The format in which data is persisted has changed in Infinispan 6.0, so this means that if you stored data using Infinispan 4.x or Infinispan 5.x, Infinispan 6.0 won&#8217;t be able to read it. The best way to upgrade persisted data from Infinispan 4.x/5.x to Infinispan 6.0 is to use the mechanisms explained in the <a href="#_Rolling_chapter">Rolling Upgrades section</a>. In other words, by starting a rolling upgrade, data stored in Infinispan 4.x/5.x can be migrated to a Infinispan 6.0 installation where persitence is configured with a different location for the data. The location configuration varies according to the specific details of each cache store.</p> </div> <div class="paragraph"> <p>Following sections describe the SPI and also discuss the SPI implementations that Infinispan ships out of the box.</p> </div> </div> <div class="sect2"> <h3 id="api"><a class="anchor" href="#api"></a>5.2. API</h3> <div class="paragraph"> <p>The following class diagram presents the main SPI interfaces of the persistence API:</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/Figure2_1_persistence_API.png" alt="Figure2 1 persistence API"> </div> </div> <div class="paragraph"> <p>Some notes about the classes:</p> </div> <div class="ulist"> <ul> <li> <p><a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/commons/io/ByteBuffer.html">ByteBuffer</a> - abstracts the serialized form of an object</p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/spi/MarshalledEntry.html">MarshalledEntry</a> - abstracts the information held within a persistent store corresponding to a key-value added to the cache. Provides method for reading this information both in serialized (<a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/commons/io/ByteBuffer.html">ByteBuffer</a>) and deserialized (Object) format. Normally data read from the store is kept in serialized format and lazily deserialized on demand, within the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/spi/MarshalledEntry.html">MarshalledEntry</a> implementation</p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/spi/CacheWriter.html">CacheWriter</a> and <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/spi/CacheLoader.html">CacheLoader</a> provide basic methods for reading and writing to a store</p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/spi/AdvancedCacheLoader.html">AdvancedCacheLoader</a> and <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/spi/AdvancedCacheWriter.html">AdvancedCacheWriter</a> provide operations to manipulate the underlaying storage in bulk: parallel iteration and purging of expired entries, clear and size.</p> </li> </ul> </div> <div class="paragraph"> <p>A provider might choose to only implement a subset of these interfaces:</p> </div> <div class="ulist"> <ul> <li> <p>Not implementing the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/spi/AdvancedCacheWriter.html">AdvancedCacheWriter</a> makes the given writer not usable for purging expired entries or clear</p> </li> <li> <p>If a loader does not implement the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/spi/AdvancedCacheWriter.html">AdvancedCacheWriter</a> inteface, then it will not participate in preloading nor in cache iteration (required also for stream operations).</p> </li> </ul> </div> <div class="paragraph"> <p>If you&#8217;re looking at migrating your existing store to the new API or to write a new store implementation, the <a href="https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/persistence/file/SingleFileStore.java">SingleFileStore</a> might be a good starting point/example.</p> </div> </div> <div class="sect2"> <h3 id="configuration_2"><a class="anchor" href="#configuration_2"></a>5.3. Configuration</h3> <div class="paragraph"> <p>Stores (readers and/or writers) can be configured in a chain. Cache read operation looks at all of the specified <code>CacheLoader</code> s, in the order they are configured, until it finds a valid and non-null element of data. When performing writes all cache <code>CacheWriter</code> s are written to, except if the <code>ignoreModifications</code> element has been set to true for a specific cache writer.</p> </div> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="fa icon-important" title="Important"></i> </td> <td class="content"> <div class="title">Implementing both a CacheWriter and CacheLoader</div> it is possible and recommended for a store provider to implement both the <code>CacheWriter</code> and the <code>CacheLoader</code> interface. The stores that do this are considered both for reading and writing(assuming <code>read-only=false</code>) data. </td> </tr> </table> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml">This is the configuration of a custom(not shipped with infinispan) store:
   <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myCustomStore</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;store</span>
            <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.acme.CustomStore</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">preload</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">singleton</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

            <span class="tag">&lt;write-behind</span> <span class="attribute-name">flush-lock-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">12321</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">modification-queue-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">123</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">shutdown-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">321</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">thread-pool-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">23</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myProp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${system.property}<span class="tag">&lt;/property&gt;</span>
         <span class="tag">&lt;/store&gt;</span>
      <span class="tag">&lt;/persistence&gt;</span>
   <span class="tag">&lt;/local-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Explanation of the configuration options:</p> </div> <div class="ulist"> <ul> <li> <p><code>passivation</code> (false by default) has a significant impact on how Infinispan interacts with the loaders, and is discussed in the <a href="#cache-passivation">Cache Passivation</a> section.</p> </li> <li> <p><code>class</code> defines the class of the store and must implement CacheLoader, CacheWriter or both</p> </li> <li> <p><code>fetch-state</code> (false by default) determines whether or not to fetch the persistent state of a cache when joining a cluster. The aim here is to take the persistent state of a cache and apply it to the local cache store of the joining node. Fetch persistent state is ignored if a cache store is configured to be shared, since they access the same data. Only one configured cache loader may set this property to true; if more than one cache loader does so, a configuration exception will be thrown when starting your cache service.</p> </li> <li> <p><code>preload</code> (false by default) if true, when the cache starts, data stored in the cache loader will be pre-loaded into memory. This is particularly useful when data in the cache loader is needed immediately after startup and you want to avoid cache operations being delayed as a result of loading this data lazily. Can be used to provide a 'warm-cache' on startup, however there is a performance penalty as startup time is affected by this process. Note that preloading is done in a local fashion, so any data loaded is only stored locally in the node. No replication or distribution of the preloaded data happens. Also, Infinispan only preloads up to the maximum configured number of entries in <a href="#eviction_anchor">eviction</a>.</p> </li> <li> <p><code>shared</code> (false by default) indicates that the cache loader is shared among different cache instances, for example where all instances in a cluster use the same JDBC settings to talk to the same remote, shared database. Setting this to true prevents repeated and unnecessary writes of the same data to the cache loader by different cache instances.</p> </li> <li> <p><code>purge</code> (false by default) empties the specified cache loader (if <code>read-only</code> is false) when the cache loader starts up.</p> </li> <li> <p><code>read-only</code> (false by default) prevents new data to be persisted to the store.</p> </li> <li> <p><code>write-behind</code> (disabled by default) element has to do with a persisting data asynchronously to the actual store. It is discussed in detail <a href="#_write_behind_asynchronous">here</a>.</p> </li> <li> <p><code>singleton</code> (disabled by default) attribute enables modifications to be stored by only one node in the cluster, the coordinator. Essentially, whenever any data comes in to some node it is always replicated(or distributed) so as to keep the caches in-memory states in sync; the coordinator, though, has the sole responsibility of pushing that state to disk. This functionality must be configured by setting the enabled attribute to true in all nodes. Only the coordinator of the cluster will persist data, but all nodes must have this configured to prevent others from persisting as well. You cannot configure a store as shared and singleton.</p> </li> <li> <p>additional attributes can be configures within the <code>properties</code> section. These attributes configure aspects specific to each cache loader, e.g. the <code>myProp</code> attribute in the previous example. Other loaders, with more complex configuration, also introduce additional sub-elements to the basic configuration. See for example the JDBC cache store configuration examples below</p> </li> </ul> </div> <div class="paragraph"> <p>The configuration above is used for a generic store implementation. However the store implementation provided by default with Infinispan have a more rich configuration schema, in which the <code>properties</code> section is replaced with XML attributes:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="comment">&lt;!-- note that class is missing and is induced by the fileStore element name --&gt;</span>
Â Â Â <span class="tag">&lt;file-store</span>
           <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">preload</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${java.io.tmpdir}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;write-behind</span> <span class="attribute-name">flush-lock-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">15000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">thread-pool-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
Â Â  <span class="tag">&lt;/file-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The same configuration can be achieved programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">   ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
   builder.persistence()
         .passivation(<span class="predefined-constant">false</span>)
         .addSingleFileStore()
            .preload(<span class="predefined-constant">true</span>)
            .shared(<span class="predefined-constant">false</span>)
            .fetchPersistentState(<span class="predefined-constant">true</span>)
            .ignoreModifications(<span class="predefined-constant">false</span>)
            .purgeOnStartup(<span class="predefined-constant">false</span>)
            .location(<span class="predefined-type">System</span>.getProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">java.io.tmpdir</span><span class="delimiter">&quot;</span></span>))
            .async()
               .enabled(<span class="predefined-constant">true</span>)
               .threadPoolSize(<span class="integer">5</span>)
            .singleton()
               .enabled(<span class="predefined-constant">true</span>)
               .pushStateWhenCoordinator(<span class="predefined-constant">true</span>)
               .pushStateTimeout(<span class="integer">20000</span>);</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="cache-passivation"><a class="anchor" href="#cache-passivation"></a>5.4. Cache Passivation</h3> <div class="paragraph"> <p>A CacheWriter can be used to enforce entry passivation and activation on eviction in a cache. Cache passivation is the process of removing an object from in-memory cache and writing it to a secondary data store (e.g., file system, database) on eviction. Cache activation is the process of restoring an object from the data store into the in-memory cache when it&#8217;s needed to be used. In order to fully support passivation, a store needs to be both a CacheWriter and a CacheLoader. In both cases, the configured cache store is used to read from the loader and write to the data writer.</p> </div> <div class="paragraph"> <p>When an eviction policy in effect evicts an entry from the cache, if passivation is enabled, a notification that the entry is being passivated will be emitted to the cache listeners and the entry will be stored. When a user attempts to retrieve a entry that was evicted earlier, the entry is (lazily) loaded from the cache loader into memory. When the entry and its children have been loaded, they&#8217;re removed from the cache loader and a notification is emitted to the cache listeners that the entry has been activated. In order to enable passivation just set passivation to true (false by default). When passivation is used, only the first cache loader configured is used and all others are ignored.</p> </div> <div class="sect3"> <h4 id="cache_loader_behavior_with_passivation_disabled_vs_enabled"><a class="anchor" href="#cache_loader_behavior_with_passivation_disabled_vs_enabled"></a>5.4.1. Cache Loader Behavior with Passivation Disabled vs Enabled</h4> <div class="paragraph"> <p>When passivation is disabled, whenever an element is modified, added or removed, then that modification is persisted in the backend store via the cache loader. There is no direct relationship between eviction and cache loading. If you don&#8217;t use eviction, what&#8217;s in the persistent store is basically a copy of what&#8217;s in memory. If you do use eviction, what&#8217;s in the persistent store is basically a superset of what&#8217;s in memory (i.e. it includes entries that have been evicted from memory). When passivation is enabled, there is a direct relationship between eviction and the cache loader. Writes to the persistent store via the cache loader only occur as part of the eviction process. Data is deleted from the persistent store when the application reads it back into memory. In this case, what&#8217;s in memory and what&#8217;s in the persistent store are two subsets of the total information set, with no intersection between the subsets.</p> </div> <div class="paragraph"> <p>The following is a simple example, showing what state is in RAM and in the persistent store after each step of a 6 step process:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Insert keyOne</p> </li> <li> <p>Insert keyTwo</p> </li> <li> <p>Eviction thread runs, evicts keyOne</p> </li> <li> <p>Read keyOne</p> </li> <li> <p>Eviction thread runs, evicts keyTwo</p> </li> <li> <p>Remove keyTwo</p> </li> </ol> </div> <div class="olist arabic"> <div class="title">When passivation is <em>disabled</em></div> <ol class="arabic"> <li> <p><strong>Memory:</strong> keyOne <strong>Disk:</strong> keyOne</p> </li> <li> <p><strong>Memory:</strong> keyOne, keyTwo <strong>Disk:</strong> keyOne, keyTwo</p> </li> <li> <p><strong>Memory:</strong> keyTwo <strong>Disk:</strong> keyOne, keyTwo</p> </li> <li> <p><strong>Memory:</strong> keyOne, keyTwo <strong>Disk:</strong> keyOne, keyTwo</p> </li> <li> <p><strong>Memory:</strong> keyOne <strong>Disk:</strong> keyOne, keyTwo</p> </li> <li> <p><strong>Memory:</strong> keyOne <strong>Disk:</strong> keyOne</p> </li> </ol> </div> <div class="olist arabic"> <div class="title">When passivation is <em>enabled</em></div> <ol class="arabic"> <li> <p><strong>Memory:</strong> keyOne <strong>Disk:</strong> (none)</p> </li> <li> <p><strong>Memory:</strong> keyOne, keyTwo <strong>Disk:</strong> (none)</p> </li> <li> <p><strong>Memory:</strong> keyTwo <strong>Disk:</strong> keyOne</p> </li> <li> <p><strong>Memory:</strong> keyOne, keyTwo <strong>Disk:</strong> (none)</p> </li> <li> <p><strong>Memory:</strong> keyOne <strong>Disk:</strong> keyTwo</p> </li> <li> <p><strong>Memory:</strong> keyOne <strong>Disk:</strong> (none)</p> </li> </ol> </div> </div> </div> <div class="sect2"> <h3 id="cache_loaders_and_transactional_caches"><a class="anchor" href="#cache_loaders_and_transactional_caches"></a>5.5. Cache Loaders and transactional caches</h3> <div class="paragraph"> <p>When a cache is transactional and a cache loader is present, the cache loader won&#8217;t be enlisted in the transaction in which the cache is part. That means that it is possible to have inconsistencies at cache loader level: the transaction to succeed applying the in-memory state but (partially) fail applying the changes to the store. Manual recovery would not work with caches stores.</p> </div> </div> <div class="sect2"> <h3 id="write_through_and_write_behind_caching"><a class="anchor" href="#write_through_and_write_behind_caching"></a>5.6. Write-Through And Write-Behind Caching</h3> <div class="paragraph"> <p>Infinispan can optionally be configured with one or several cache stores allowing it to store data in a persistent location such as shared JDBC database, a local filesystem, etc. Infinispan can handle updates to the cache store in two different ways:</p> </div> <div class="ulist"> <ul> <li> <p>Write-Through (Synchronous)</p> </li> <li> <p>Write-Behind (Asynchronous)</p> </li> </ul> </div> <div class="sect3"> <h4 id="write_through_synchronous"><a class="anchor" href="#write_through_synchronous"></a>5.6.1. Write-Through (Synchronous)</h4> <div class="paragraph"> <p>In this mode, which is supported in version 4.0, when clients update a cache entry, i.e. via a Cache.put() invocation, the call will not return until Infinispan has gone to the underlying cache store and has updated it. Normally, this means that updates to the cache store are done within the boundaries of the client thread.</p> </div> <div class="paragraph"> <p>The main advantage of this mode is that the cache store is updated at the same time as the cache, hence the cache store is consistent with the cache contents. On the other hand, using this mode reduces performance because the latency of having to access and update the cache store directly impacts the duration of the cache operation.</p> </div> <div class="paragraph"> <p>Configuring a write-through or synchronous cache store does not require any particular configuration option. By default, unless marked explicitly as write-behind or asynchronous, all cache stores are write-through or synchronous. Please find below a sample configuration file of a write-through unshared local file cache store:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;file-store</span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${java.io.tmpdir}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> </div> <div class="sect3"> <h4 id="write_behind_asynchronous"><a class="anchor" href="#write_behind_asynchronous"></a>5.6.2. Write-Behind (Asynchronous)</h4> <div class="paragraph"> <p>In this mode, updates to the cache are asynchronously written to the cache store. Normally, this means that updates to the cache store are done by a separate thread to the client thread interacting with the cache.</p> </div> <div class="paragraph"> <p>One of the major advantages of this mode is that the performance of a cache operation does not get affected by the update of the underlying store. On the other hand, since the update happens asynchronously, there&#8217;s a time window during the which the cache store can contain stale data compared to the cache. Even within write-behind, there are different strategies that can be used to store data:</p> </div> <div class="sect4"> <h5 id="unscheduled_write_behind_strategy"><a class="anchor" href="#unscheduled_write_behind_strategy"></a>Unscheduled Write-Behind Strategy</h5> <div class="paragraph"> <p>In this mode, which is supported in version 4.0, Infinispan tries to store changes as quickly as possible by taking the pending changes and applying them in parallel. Normally, this means that there are several threads waiting for modifications to occur and once they&#8217;re available, they apply them to underlying cache store.</p> </div> <div class="paragraph"> <p>This strategy is suited for cache stores with low latency and cheap operation cost. One such example would a local unshared file based cache store, where the cache store is local to the cache itself. With this strategy, the window of inconsistency between the contents of the cache and the cache store are reduced to the lowest possible time. Please find below a sample configuration file of this strategy:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;file-store</span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${java.io.tmpdir}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="comment">&lt;!-- write behind configuration starts here --&gt;</span>
   <span class="tag">&lt;write-behind</span> <span class="tag">/&gt;</span>
   <span class="comment">&lt;!-- write behind configuration ends here --&gt;</span>
   <span class="tag">&lt;/file-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> </div> <div class="sect4"> <h5 id="scheduled_write_behind_strategy"><a class="anchor" href="#scheduled_write_behind_strategy"></a>Scheduled Write-Behind Strategy</h5> <div class="paragraph"> <p>First of all, please note that this strategy is not included in version 4.0 but it will be implemented at a later stage. <a href="https://jira.jboss.org/jira/browse/ISPN-328">ISPN-328</a> has been created to track this feature request. If you want it implemented, please vote for it on that page, and watch it to be notified of any changes. The following explanation refers to how we envision it to work.</p> </div> <div class="paragraph"> <p>In this mode, Infinispan would periodically store changes to the underlying cache store. The periodicity could be defined in seconds, minutes, days, etc.</p> </div> <div class="paragraph"> <p>Since this strategy is oriented at cache stores with high latency or expensive operation cost, it makes sense to coalesce changes, so that if there are multiple operations queued on the same key, only the latest value is applied to cache store. With this strategy, the window of inconsistency between the contents of the cache and the cache store depends on the delay or periodicity configured. The higher the periodicity, the higher the chance of inconsistency.</p> </div> </div> </div> </div> <div class="sect2"> <h3 id="filesystem_based_cache_stores"><a class="anchor" href="#filesystem_based_cache_stores"></a>5.7. Filesystem based cache stores</h3> <div class="paragraph"> <p>A filesystem-based cache store is typically used when you want to have a cache with a cache store available locally which stores data that has overflowed from memory, having exceeded size and/or time restrictions.</p> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> Usage of filesystem-based cache stores on shared filesystems like NFS, Windows shares, etc. should be avoided as these do not implement proper file locking and can cause data corruption. File systems are inherently not transactional, so when attempting to use your cache in a transactional context, failures when writing to the file (which happens during the commit phase) cannot be recovered. </td> </tr> </table> </div> <div class="sect3"> <h4 id="single_file_store"><a class="anchor" href="#single_file_store"></a>5.7.1. Single File Store</h4> <div class="paragraph"> <p>Starting with Infinispan 6.0, a new file cache store has been created called single file cache store. The old pre-6.0 file cache store has been completely removed, and it&#8217;s no longer configurable.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Check <a href="#_Data_migration_section">Data Migration section</a> for information on how to migrate old file based cache store data to the new single file cache store. </td> </tr> </table> </div> <div class="paragraph"> <p>The new single file cache store keeps all data in a single file. The way it looks up data is by keeping an in-memory index of keys and the positions of their values in this file. This results in greater performance compared to old file cache store. There is one caveat though. Since the single file based cache store keeps keys in memory, it can lead to increased memory consumption, and hence it&#8217;s not recommended for caches with big keys.</p> </div> <div class="paragraph"> <p>In certain use cases, this cache store suffers from fragmentation: if you store larger and larger values, the space is not reused and instead the entry is appended at the end of the file. The space (now empty) is reused only if you write another entry that can fit there. Also, when you remove all entries from the cache, the file won&#8217;t shrink, and neither will be de-fragmented.</p> </div> <div class="paragraph"> <p>These are the available configuration options for the single file cache store:</p> </div> <div class="ulist"> <ul> <li> <p><code>path</code> where data will be stored. (e.g., <code>path="/tmp/myDataStore"</code>). By default, the location is <code>Infinispan-SingleFileStore</code>.</p> </li> <li> <p><code>max-entries</code> specifies the maximum number of entries to keep in this file store. As mentioned before, in order to speed up lookups, the single file cache store keeps an index of keys and their corresponding position in the file. To avoid this index resulting in memory consumption problems, this cache store can bounded by a maximum number of entries that it stores. If this limit is exceeded, entries are removed permanently using the LRU algorithm both from the in-memory index and the underlying file based cache store. So, setting a maximum limit only makes sense when Infinispan is used as a cache, whose contents can be recomputed or they can be retrieved from the authoritative data store. If this maximum limit is set when the Infinispan is used as an authoritative data store, it could lead to data loss, and hence it&#8217;s not recommended for this use case. The default value is <code>-1</code> which means that the file store size is unlimited.</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
Â Â  <span class="tag">&lt;file-store</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/myDataStore</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-entries</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence()
    .addSingleFileStore()
    .location(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/myDataStore</span><span class="delimiter">&quot;</span></span>)
    .maxEntries(<span class="integer">5000</span>);</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="soft_index_file_store"><a class="anchor" href="#soft_index_file_store"></a>5.7.2. Soft-Index File Store</h4> <div class="paragraph"> <p>In Infinispan 7.0 we have added a new experimental local file-based cache store - Soft-Index File Store. It is a pure Java implementation that tries to get around Single File Store&#8217;s drawbacks by implementing a variant of B+ tree that is cached in-memory using Java&#8217;s soft references - here&#8217;s where the name Soft-Index File Store comes from. This B+ tree (called Index) is offloaded on filesystem to single file that does not need to be persisted - it is purged and rebuilt when the cache store restarts, its purpose is only offloading.</p> </div> <div class="paragraph"> <p>The data that should be persisted are stored in a set of files that are written in append-only way - that means that if you store this on conventional magnetic disk, it does not have to seek when writing a burst of entries. It is not stored in single file but set of files. When the usage of any of these files drops below 50% (the entries from the file are overwritten to another file), the file starts to be collected, moving the live entries into different file and in the end removing that file from disk.</p> </div> <div class="paragraph"> <p>Most of the structures in Soft Index File Store are bounded, therefore you don&#8217;t have to be afraid of OOMEs. For example, you can configure the limits for concurrently open files as well.</p> </div> <div class="sect4"> <h5 id="configuration_3"><a class="anchor" href="#configuration_3"></a>Configuration</h5> <div class="paragraph"> <p>Here is an example of Soft-Index File Store configuration via XML:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
    <span class="tag">&lt;soft-index-file-store</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:store:soft-index:8.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;index</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/sifs/testCache/index</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;data</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/sifs/testCache/data</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/soft-index-file-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Programmatic configuration would look as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence()
    .addStore(SoftIndexFileStoreConfigurationBuilder.class)
        .indexLocation(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/sifs/testCache/index</span><span class="delimiter">&quot;</span></span>);
        .dataLocation(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/sifs/testCache/data</span><span class="delimiter">&quot;</span></span>)</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="current_limitations"><a class="anchor" href="#current_limitations"></a>Current limitations</h5> <div class="paragraph"> <p>Size of a node in the Index is limited, by default it is 4096 bytes, though it can be configured. This size also limits the key length (or rather the length of the serialized form): you can&#8217;t use keys longer than size of the node - 15 bytes. Moreover, the key length is stored as 'short', limiting it to 32767 bytes. There&#8217;s no way how you can use longer keys - SIFS throws an exception when the key is longer after serialization.</p> </div> <div class="paragraph"> <p>When entries are stored with expiration, SIFS cannot detect that some of those entries are expired. Therefore, such old file will not be compacted (method AdvancedStore.purgeExpired() is not implemented). This can lead to excessive file-system space usage.</p> </div> <hr> <div class="paragraph"> <p>For detailed description of all the parameters supported by the stores, please consult the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/">javadoc</a>.</p> </div> </div> </div> </div> <div class="sect2"> <h3 id="jdbc_based_cache_loaders"><a class="anchor" href="#jdbc_based_cache_loaders"></a>5.8. JDBC based cache loaders</h3> <div class="paragraph"> <p>Based on the type of keys to be persisted, there are three JDBC cache loaders:</p> </div> <div class="ulist"> <ul> <li> <p><a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/jdbc/binary/JdbcBinaryStore.html">JdbcBinaryStore</a> - can store any type of keys. It stores all the keys that have the same hash value (hashCode method on key) in the same table row/blob, having as primary key the hash value. While this offers great flexibility (can store any key type), it impacts concurrency/throughput. E.g. If storing k1,k2 and k3 keys, and keys had same hash code, then they&#8217;d persisted in the same table row. Now, if 3 threads try to concurrently update k1, k2 and k3 respectively, they would need to do it sequentially since these threads would be updating the same row.</p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/jdbc/stringbased/JdbcStringBasedStore.html">JdbcStringBasedStore</a> - stores each key in its own row, increasing throughput under concurrent load. In order to store each key in its own column, it relies on a (pluggable) bijection that maps the each key to a String object. The bijection is defined by the Key2StringMapper interface. Infinispans ships a default implementation (smartly named <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/keymappers/DefaultTwoWayKey2StringMapper.html">DefaultTwoWayKey2StringMapper</a> ) that knows how to handle primitive types.</p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/jdbc/mixed/JdbcMixedStore.html">JdbcMixedStore</a> - it is a hybrid implementation that, based on the key type, delegates to either <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/jdbc/binary/JdbcBinaryStore.html">JdbcBinaryStore</a> or <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/jdbc/stringbased/JdbcStringBasedStore.html">JdbcStringBasedStore</a>.</p> </li> </ul> </div> <div class="sect3"> <h4 id="which_jdbc_cache_loader_should_i_use"><a class="anchor" href="#which_jdbc_cache_loader_should_i_use"></a>5.8.1. Which JDBC cache loader should I use?</h4> <div class="paragraph"> <p>It is generally preferable to use <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/jdbc/stringbased/JdbcStringBasedStore.html">JdbcStringBasedStore</a> when you are in control of the key types, as it offers better throughput under heavy load. One scenario in which it is not possible to use it though, is when you can&#8217;t write a <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/keymappers/Key2StringMapper.html">Key2StringMapper</a> to map the keys to to string objects (e.g. when you don&#8217;t have control over the types of the keys, for whatever reason). Then you should use either <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/jdbc/binary/JdbcBinaryStore.html">JdbcBinaryStore</a> or <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/jdbc/mixed/JdbcMixedStore.html">JdbcMixedStore</a> . The later is preferred to the former when the majority of the keys are handled by <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/jdbc/stringbased/JdbcStringBasedStore.html">JdbcStringBasedStore</a> , but you still have some keys you cannot convert through <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/keymappers/DefaultTwoWayKey2StringMapper.html">DefaultTwoWayKey2StringMapper</a>.</p> </div> </div> <div class="sect3"> <h4 id="connection_management_pooling"><a class="anchor" href="#connection_management_pooling"></a>5.8.2. Connection management (pooling)</h4> <div class="paragraph"> <p>In order to obtain a connection to the database all the JDBC cache loaders rely on a <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/jdbc/connectionfactory/ConnectionFactory.html">ConnectionFactory</a> implementation. The connection factory is specified programmatically using one of the connectionPool(), dataSource() or simpleConnection() methods on the JdbcBinaryCacheStoreConfigurationBuilder class or declaratively using one of the <code>&lt;connectionPool /&gt;</code>, <code>&lt;dataSource /&gt;</code> or <code>&lt;simpleConnection /&gt;</code> elements. Infinispan ships with three ConnectionFactory implementations:</p> </div> <div class="ulist"> <ul> <li> <p><a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/jdbc/connectionfactory/PooledConnectionFactory.html">PooledConnectionFactory</a> is a factory based on <a href="http://sourceforge.net/projects/c3p0/">C3P0</a> . Refer to <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/jdbc/connectionfactory/PooledConnectionFactory.html">javadoc</a> for details on configuring it.</p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/jdbc/connectionfactory/ManagedConnectionFactory.html">ManagedConnectionFactory</a> is a connection factory that can be used within managed environments, such as application servers. It knows how to look into the JNDI tree at a certain location (configurable) and delegate connection management to the DataSource. Refer to javadoc <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/jdbc/connectionfactory/ManagedConnectionFactory.html">javadoc</a> for details on how this can be configured.</p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/jdbc/connectionfactory/SimpleConnectionFactory.html">SimpleConnectionFactory</a> is a factory implementation that will create database connection on a per invocation basis. Not recommended in production.</p> </li> </ul> </div> <div class="paragraph"> <p>The <code>PooledConnectionFactory</code> is generally recommended for stand-alone deployments (i.e. not running within AS or servlet container). <code>ManagedConnectionFactory</code> can be used when running in a managed environment where a <code>DataSource</code> is present, so that connection pooling is performed within the <code>DataSource</code>.</p> </div> </div> <div class="sect3"> <h4 id="sample_configurations"><a class="anchor" href="#sample_configurations"></a>5.8.3. Sample configurations</h4> <div class="paragraph"> <p>Below is a sample configuration for the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/jdbc/binary/JdbcBinaryStore.html">JdbcBinaryStore</a> . For detailed description of all the parameters used refer to the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/jdbc/binary/JdbcBinaryStore.html">JdbcBinaryStore</a> . Please note the use of multiple XML schemas, since each store has its own schema.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;binary-keyed-jdbc-store</span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;simple-connection</span> <span class="attribute-name">connection-url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:h2:mem:infinispan_binary_based;DB_CLOSE_DELAY=-1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">driver</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.h2.Driver</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">username</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;binary-keyed-table</span> <span class="attribute-name">prefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_BUCKET_TABLE</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">drop-on-exit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">create-on-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;id-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;data-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;timestamp-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;/binary-keyed-table&gt;</span>
   <span class="tag">&lt;/binary-keyed-jdbc-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder.persistence()
      .addStore(JdbcBinaryStoreConfigurationBuilder.class)
         .fetchPersistentState(<span class="predefined-constant">false</span>)
         .ignoreModifications(<span class="predefined-constant">false</span>)
         .purgeOnStartup(<span class="predefined-constant">false</span>)
         .table()
         .dropOnExit(<span class="predefined-constant">true</span>)
         .createOnStart(<span class="predefined-constant">true</span>)
         .tableNamePrefix(<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_BUCKET_TABLE</span><span class="delimiter">&quot;</span></span>)
         .idColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span>).idColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span>)
         .dataColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span>).dataColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span>)
         .timestampColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span>).timestampColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span>)
         .connectionPool()
            .connectionUrl(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:h2:mem:infinispan_binary_based;DB_CLOSE_DELAY=-1</span><span class="delimiter">&quot;</span></span>)
            .username(<span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span>)
            .driverClass(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.h2.Driver</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>Below is a sample configuration for the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/jdbc/stringbased/JdbcStringBasedStore.html">JdbcStringBasedStore</a> . For detailed description of all the parameters used refer to the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/jdbc/stringbased/JdbcStringBasedStore.html">JdbcStringBasedStore</a> .</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;string-keyed-jdbc-store</span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;connection-pool</span> <span class="attribute-name">connection-url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:h2:mem:infinispan_string_based;DB_CLOSE_DELAY=-1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">username</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">driver</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.h2.Driver</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;string-keyed-table</span> <span class="attribute-name">drop-on-exit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">create-on-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">prefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_STRING_TABLE</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;id-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;data-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;timestamp-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;/string-keyed-table&gt;</span>
   <span class="tag">&lt;/string-keyed-jdbc-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder.persistence().addStore(JdbcStringBasedStoreConfigurationBuilder.class)
      .fetchPersistentState(<span class="predefined-constant">false</span>)
      .ignoreModifications(<span class="predefined-constant">false</span>)
      .purgeOnStartup(<span class="predefined-constant">false</span>)
      .table()
         .dropOnExit(<span class="predefined-constant">true</span>)
         .createOnStart(<span class="predefined-constant">true</span>)
         .tableNamePrefix(<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_STRING_TABLE</span><span class="delimiter">&quot;</span></span>)
         .idColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span>).idColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span>)
         .dataColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span>).dataColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span>)
         .timestampColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span>).timestampColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span>)
      .connectionPool()
         .connectionUrl(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:h2:mem:infinispan_binary_based;DB_CLOSE_DELAY=-1</span><span class="delimiter">&quot;</span></span>)
         .username(<span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span>)
         .driverClass(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.h2.Driver</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>Below is a sample configuration for the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/jdbc/mixed/JdbcMixedStore.html">JdbcMixedStore</a> . For detailed description of all the parameters used refer to the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/jdbc/mixed/JdbcMixedStore.html">JdbcMixedStore</a> .</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;mixed-keyed-jdbc-store</span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;simple-connection</span> <span class="attribute-name">connection-url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:h2:mem:infinispan_binary_based;DB_CLOSE_DELAY=-1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">driver</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.h2.Driver</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">username</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;string-keyed-table</span> <span class="attribute-name">prefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_MIXED_STR_TABLE</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">drop-on-exit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">create-on-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;id-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;data-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;timestamp-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;/string-keyed-table&gt;</span>
      <span class="tag">&lt;binary-keyed-table</span> <span class="attribute-name">prefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_MIXED_BINARY_TABLE</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">drop-on-exit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">create-on-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;id-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;data-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;timestamp-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;/binary-keyed-table&gt;</span>
   <span class="tag">&lt;/mixed-keyed-jdbc-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder.persistence().addStore(JdbcMixedStoreConfigurationBuilder.class)
      .fetchPersistentState(<span class="predefined-constant">false</span>).ignoreModifications(<span class="predefined-constant">false</span>).purgeOnStartup(<span class="predefined-constant">false</span>)
      .stringTable()
         .dropOnExit(<span class="predefined-constant">true</span>)
         .createOnStart(<span class="predefined-constant">true</span>)
         .tableNamePrefix(<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_MIXED_STR_TABLE</span><span class="delimiter">&quot;</span></span>)
         .idColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span>).idColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span>)
         .dataColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span>).dataColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span>)
         .timestampColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span>).timestampColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span>)
      .binaryTable()
         .dropOnExit(<span class="predefined-constant">true</span>)
         .createOnStart(<span class="predefined-constant">true</span>)
         .tableNamePrefix(<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_MIXED_BINARY_TABLE</span><span class="delimiter">&quot;</span></span>)
         .idColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span>).idColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span>)
         .dataColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span>).dataColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span>)
         .timestampColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span>).timestampColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span>)
      .connectionPool()
         .connectionUrl(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:h2:mem:infinispan_binary_based;DB_CLOSE_DELAY=-1</span><span class="delimiter">&quot;</span></span>)
         .username(<span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span>)
         .driverClass(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.h2.Driver</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>Finally, below is an example of a JDBC cache store with a managed connection factory, which is chosen implicitly by specifying a datasource JNDI location:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;string-keyed-jdbc-store</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:store:jdbc:7.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;data-source</span> <span class="attribute-name">jndi-url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java:/StringStoreWithManagedConnectionTest/DS</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;string-keyed-table</span> <span class="attribute-name">drop-on-exit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">create-on-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">prefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_STRING_TABLE</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;id-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;data-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;timestamp-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;/string-keyed-table&gt;</span>
<span class="tag">&lt;/string-keyed-jdbc-store&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder.persistence().addStore(JdbcStringBasedStoreConfigurationBuilder.class)
      .fetchPersistentState(<span class="predefined-constant">false</span>).ignoreModifications(<span class="predefined-constant">false</span>).purgeOnStartup(<span class="predefined-constant">false</span>)
      .table()
         .dropOnExit(<span class="predefined-constant">true</span>)
         .createOnStart(<span class="predefined-constant">true</span>)
         .tableNamePrefix(<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_STRING_TABLE</span><span class="delimiter">&quot;</span></span>)
         .idColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span>).idColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span>)
         .dataColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span>).dataColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span>)
         .timestampColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span>).timestampColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span>)
      .dataSource()
         .jndiUrl(<span class="string"><span class="delimiter">&quot;</span><span class="content">java:/StringStoreWithManagedConnectionTest/DS</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="title">Apache Derby users</div> If you&#8217;re connecting to an Apache Derby database, make sure you set dataColumnType to BLOB: <code>&lt;data-column name="DATA_COLUMN" type="BLOB"/&gt;</code> </td> </tr> </table> </div> </div> </div> <div class="sect2"> <h3 id="remote_store"><a class="anchor" href="#remote_store"></a>5.9. Remote store</h3> <div class="paragraph"> <p>The <code>RemoteStore</code> is a cache loader and writer implementation that stores data in a remote infinispan cluster. In order to communicate with the remote cluster, the <code>RemoteStore</code> uses the HotRod client/server architecture. HotRod bering the load balancing and fault tolerance of calls and the possibility to fine-tune the connection between the RemoteCacheStore and the actual cluster. Please refer to Hot Rod for more information on the protocol, client and server configuration. For a list of RemoteStore configuration refer to the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/remote/configuration/RemoteStoreConfigurationBuilder.html">javadoc</a> . Example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;remote-store</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:store:remote:8.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">raw-values</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;remote-server</span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">one</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">12111</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;remote-server</span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">two</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;connection-pool</span> <span class="attribute-name">max-active</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">exhausted-action</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">CREATE_NEW</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;write-behind</span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;/remote-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence().addStore(RemoteStoreConfigurationBuilder.class)
      .fetchPersistentState(<span class="predefined-constant">false</span>)
      .ignoreModifications(<span class="predefined-constant">false</span>)
      .purgeOnStartup(<span class="predefined-constant">false</span>)
      .remoteCacheName(<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span>)
      .rawValues(<span class="predefined-constant">true</span>)
.addServer()
      .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">one</span><span class="delimiter">&quot;</span></span>).port(<span class="integer">12111</span>)
      .addServer()
      .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">two</span><span class="delimiter">&quot;</span></span>)
      .connectionPool()
      .maxActive(<span class="integer">10</span>)
      .exhaustedAction(ExhaustedAction.CREATE_NEW)
      .async().enable();</code></pre> </div> </div> <div class="paragraph"> <p>In this sample configuration, the remote cache store is configured to use the remote cache named "mycache" on servers "one" and "two". It also configures connection pooling and provides a custom transport executor. Additionally the cache store is asynchronous.</p> </div> </div> <div class="sect2"> <h3 id="cluster_cache_loader"><a class="anchor" href="#cluster_cache_loader"></a>5.10. Cluster cache loader</h3> <div class="paragraph"> <p>The ClusterCacheLoader is a cache loader implementation that retrieves data from other cluster members.</p> </div> <div class="paragraph"> <p>It is a cache loader only as it doesn&#8217;t persist anything (it is not a Store), therefore features like <em>fetchPersistentState</em> (and like) are not applicable.</p> </div> <div class="paragraph"> <p>A cluster cache loader can be used as a non-blocking (partial) alternative to <em>stateTransfer</em> : keys not already available in the local node are fetched on-demand from other nodes in the cluster. This is a kind of lazy-loading of the cache content.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;cluster-loader</span> <span class="attribute-name">remote-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">500</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence()
    .addClusterLoader()
    .remoteCallTimeout(<span class="integer">500</span>);</code></pre> </div> </div> <div class="paragraph"> <p>For a list of ClusterCacheLoader configuration refer to the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/configuration/cache/ClusterLoaderConfiguration.html">javadoc</a> .</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> The ClusterCacheLoader does not support preloading(preload=true). It also won&#8217;t provide state if fetchPersistentSate=true. </td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="custom_cache_store_deployment"><a class="anchor" href="#custom_cache_store_deployment"></a>5.11. Custom Cache Store deployment</h3> <div class="paragraph"> <p>A Custom Cache Store might be packaged into a separate JAR file and deployed in a HotRod server using the following steps:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Create a JAR file (or use a <a href="https://github.com/infinispan/infinispan-cachestore-archetype">Custom Cache Store Archetype</a>) and implement one of the interfaces within it:</p> <div class="ulist"> <ul> <li> <p><code>org.infinispan.persistence.spi.AdvancedCacheWriter</code></p> </li> <li> <p><code>org.infinispan.persistence.spi.AdvancedCacheLoader</code></p> </li> <li> <p><code>org.infinispan.persistence.spi.CacheLoader</code></p> </li> <li> <p><code>org.infinispan.persistence.spi.CacheWriter</code></p> </li> <li> <p><code>org.infinispan.persistence.spi.ExternalStore</code></p> </li> <li> <p><code>org.infinispan.persistence.spi.AdvancedLoadWriteStore</code></p> </li> </ul> </div> </li> <li> <p>It is possible to create a Custom Cache Store configuration. This requires implementing <code>AbstractStoreConfiguration</code> and <code>AbstractStoreConfigurationBuilder</code>. Additionally, 2 annotations need to be added to the configuration - <code>@ConfigurationFor</code> and <code>@BuiltBy</code>. However this is an optional step.</p> </li> <li> <p>Create a proper file in <code>META-INF/services/</code>, which reflects the implementation:</p> <div class="ulist"> <ul> <li> <p><code>/META-INF/services/org.infinispan.persistence.spi.AdvancedCacheWriter</code></p> </li> <li> <p><code>/META-INF/services/org.infinispan.persistence.spi.AdvancedCacheLoader</code></p> </li> <li> <p><code>/META-INF/services/org.infinispan.persistence.spi.CacheLoader</code></p> </li> <li> <p><code>/META-INF/services/org.infinispan.persistence.spi.CacheWriter</code></p> </li> <li> <p><code>/META-INF/services/org.infinispan.persistence.spi.ExternalStore</code></p> </li> <li> <p><code>/META-INF/services/org.infinispan.persistence.spi.AdvancedLoadWriteStore</code> Write the fully qualified class name of the Custom Cache Store class implementation.</p> </li> </ul> </div> </li> <li> <p>Deploy the JAR file in the Infinispan Server.</p> </li> </ol> </div> </div> <div class="sect2"> <h3 id="command_line_interface_cache_loader"><a class="anchor" href="#command_line_interface_cache_loader"></a>5.12. Command-Line Interface cache loader</h3> <div class="paragraph"> <p>The Command-Line Interface (CLI) cache loader is a cache loader implementation that retrieves data from another Infinispan node using the CLI. The node to which the CLI connects to could be a standalone node, or could be a node that it&#8217;s part of a cluster. This cache loader is read-only, so it will only be used to retrieve data, and hence, won&#8217;t be used when persisting data.</p> </div> <div class="paragraph"> <p>The CLI cache loader is configured with a connection URL pointing to the Infinispan node to which connect to. Here is an example:</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Details on the format of the URL and how to make sure a node can receive invocations via the CLI can be found in the <a href="#_CLI_chapter">Command-Line Interface chapter</a>. </td> </tr> </table> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
Â Â  <span class="tag">&lt;cli-loader</span> <span class="attribute-name">connection</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jmx://1.2.3.4:4444/MyCacheManager/myCache</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence()
    .addStore(CLInterfaceLoaderConfigurationBuilder.class)
    .connectionString(<span class="string"><span class="delimiter">&quot;</span><span class="content">jmx://1.2.3.4:4444/MyCacheManager/myCache</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="more_implementations"><a class="anchor" href="#more_implementations"></a>5.13. More implementations</h3> <div class="paragraph"> <p>Many more cache loader and cache store implementations exist. Visit <a href="http://infinispan.org/cache-store-implementations">this website</a> for more details.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="leveldb_cache_store"><a class="anchor" href="#leveldb_cache_store"></a>6. LevelDB Cache Store</h2> <div class="sectionbody"> <div class="paragraph"> <p>The Infinispan Community</p> </div> <div class="sect2"> <h3 id="introduction"><a class="anchor" href="#introduction"></a>6.1. Introduction</h3> <div class="paragraph"> <p><a href="http://code.google.com/p/leveldb/">LevelDB</a> is a fast key-value filesystem-based storage from Google. LevelDB cache store currently uses a <a href="https://github.com/dain/leveldb">Java implementation</a>.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> It may be possible to use a <a href="https://github.com/fusesource/leveldbjni">JNI implementation</a> in the future. </td> </tr> </table> </div> <div class="sect3"> <h4 id="sample_usage"><a class="anchor" href="#sample_usage"></a>6.1.1. Sample Usage</h4> <div class="paragraph"> <p>LevelDB cache store requires 2 filesystem directories to be configured - each directory for a LevelDB database. One location is used to store non-expired data, while the second location is used to store expired keys pending purge.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> cacheConfig = <span class="keyword">new</span> ConfigurationBuilder().persistence()
                                .addStore(LevelDBStoreConfigurationBuilder.class)
                                .build();
EmbeddedCacheManager cacheManager = <span class="keyword">new</span> DefaultCacheManager(cacheConfig);

Cache&lt;<span class="predefined-type">String</span>, User&gt; usersCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">usersCache</span><span class="delimiter">&quot;</span></span>);
usersCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">raytsang</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> User(...));</code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="configuration_4"><a class="anchor" href="#configuration_4"></a>6.2. Configuration</h3> <div class="sect3"> <h4 id="sample_programatic_configuration"><a class="anchor" href="#sample_programatic_configuration"></a>6.2.1. Sample Programatic Configuration</h4> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> cacheConfig = <span class="keyword">new</span> ConfigurationBuilder().persistence()
                                .addStore(LevelDBStoreConfigurationBuilder.class)
                                .location(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/leveldb/data</span><span class="delimiter">&quot;</span></span>)
                                .expiredLocation(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/leveldb/expired</span><span class="delimiter">&quot;</span></span>)
                                .build();</code></pre> </div> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Parameter</th> <th class="tableblock halign-left valign-top">Description</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">location</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Directory to use for LevelDB to store primary cache store data. Directory will be auto-created if it does not exit.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">expiredLocation</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Directory to use for LevelDB to store expiring data pending to be purged permanently. Directory will be auto-created if it does not exit.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">expiryQueueSize</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Size of the in-memory queue to hold expiring entries before it gets flushed into expired LevelDB store</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">clearThreshold</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">There are two methods to clear all entries in LevelDB. One method is to iterate through all entries and remove each entry individually. The other method is to delete the database and re-init. For smaller databases, deleting individual entries is faster than the latter method. This configuration sets the max number of entries allowed before using the latter method</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">compressionType</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Configuration for LevelDB for data compression, see CompressionType enum for options</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">blockSize</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Configuration for LevelDB - see <a href="http://leveldb.googlecode.com/svn/trunk/doc/index.html">documentation</a> for performance tuning</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">cacheSize</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Configuration for LevelDB - see <a href="http://leveldb.googlecode.com/svn/trunk/doc/index.html">documentation</a> for performance tuning</p></td> </tr> </tbody> </table> </div> <div class="sect3"> <h4 id="sample_xml_configuration"><a class="anchor" href="#sample_xml_configuration"></a>6.2.2. Sample XML Configuration</h4> <div class="listingblock"> <div class="title">infinispan.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vehicleCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;persistence&gt;</span>
      <span class="tag">&lt;leveldb-store</span><span class="error">Â </span><span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/leveldb/data</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;expiration</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/leveldb/expired</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/leveldb-store&gt;</span>
   <span class="tag">&lt;/persistence&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="additional_references"><a class="anchor" href="#additional_references"></a>6.3. Additional References</h3> <div class="paragraph"> <p>Refer to the <a href="https://github.com/infinispan/infinispan/blob/master/persistence/leveldb/src/test/java/org/infinispan/persistence/leveldb/config/ConfigurationTest.java">test case</a> for code samples in action.</p> </div> <div class="paragraph"> <p>Refer to <a href="https://github.com/infinispan/infinispan/tree/master/persistence/leveldb/src/test/resources/config/">test configurations</a> for configuration samples.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="rest_cache_store"><a class="anchor" href="#rest_cache_store"></a>7. REST Cache Store</h2> <div class="sectionbody"> <div class="paragraph"> <p>The Infinispan Community</p> </div> <div class="sect2"> <h3 id="introduction_2"><a class="anchor" href="#introduction_2"></a>7.1. Introduction</h3> <div class="paragraph"> <p><strong>TODO</strong></p> </div> </div> <div class="sect2"> <h3 id="javadoc"><a class="anchor" href="#javadoc"></a>7.2. Javadoc</h3> <div class="paragraph"> <p><strong>TODO</strong></p> </div> </div> <div class="sect2"> <h3 id="configuration_5"><a class="anchor" href="#configuration_5"></a>7.3. Configuration</h3> <div class="paragraph"> <p><strong>TODO</strong></p> </div> </div> </div> </div> <div class="sect1"> <h2 id="jpa_cache_store"><a class="anchor" href="#jpa_cache_store"></a>8. JPA Cache Store</h2> <div class="sectionbody"> <div class="paragraph"> <p>The Infinispan Community</p> </div> <div class="sect2"> <h3 id="introduction_3"><a class="anchor" href="#introduction_3"></a>8.1. Introduction</h3> <div class="paragraph"> <p>The implementation depends on JPA 2.0 specification to access entity meta model.</p> </div> <div class="paragraph"> <p>In normal use cases, it&#8217;s recommended to leverage Infinispan for JPA second level cache and/or query cache. However, if you&#8217;d like to use only Infinispan API and you want Infinispan to persist into a cache store using a common format (e.g., a database with well defined schema), then JPA Cache Store could be right for you.</p> </div> <div class="ulist"> <div class="title">Things to note</div> <ul> <li> <p>When using JPA Cache Store, the key should be the ID of the entity, while the value should be the entity object.</p> </li> <li> <p>Only a single <code>@Id</code> or <code>@EmbeddedId</code> annotated property is allowed.</p> </li> <li> <p>Auto-generated ID is not supported.</p> </li> <li> <p>Lastly, all entries will be stored as immortal entries.</p> </li> </ul> </div> <div class="sect3"> <h4 id="sample_usage_2"><a class="anchor" href="#sample_usage_2"></a>8.1.1. Sample Usage</h4> <div class="paragraph"> <p>For example, given a persistence unit "myPersistenceUnit", and a JPA entity User:</p> </div> <div class="listingblock"> <div class="title">persistence.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence-unit</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myPersistenceUnit</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        ...
<span class="tag">&lt;/persistence-unit&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>User entity class</p> </div> <div class="listingblock"> <div class="title">User.java</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">User</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
        <span class="annotation">@Id</span>
        <span class="directive">private</span> <span class="predefined-type">String</span> username;
        <span class="directive">private</span> <span class="predefined-type">String</span> firstName;
        <span class="directive">private</span> <span class="predefined-type">String</span> lastName;

        ...
}</code></pre> </div> </div> <div class="paragraph"> <p>Then you can configure a cache "usersCache" to use JPA Cache Store, so that when you put data into the cache, the data would be persisted into the database based on JPA configuration.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager cacheManager = ...;


<span class="predefined-type">Configuration</span> cacheConfig = <span class="keyword">new</span> ConfigurationBuilder().persistence()
            .addStore(JpaStoreConfigurationBuilder.class)
            .persistenceUnitName(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.loaders.jpa.configurationTest</span><span class="delimiter">&quot;</span></span>)
            .entityClass(User.class)
            .build();
cacheManager.defineCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">usersCache</span><span class="delimiter">&quot;</span></span>, cacheConfig);

Cache&lt;<span class="predefined-type">String</span>, User&gt; usersCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">usersCache</span><span class="delimiter">&quot;</span></span>);
usersCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">raytsang</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> User(...));</code></pre> </div> </div> <div class="paragraph"> <p>Normally a single Infinispan cache can store multiple types of key/value pairs, for example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Cache&lt;<span class="predefined-type">String</span>, User&gt; usersCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">myCache</span><span class="delimiter">&quot;</span></span>);
usersCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">raytsang</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> User());
Cache&lt;<span class="predefined-type">Integer</span>, Teacher&gt; teachersCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">myCache</span><span class="delimiter">&quot;</span></span>);
teachersCache.put(<span class="integer">1</span>, <span class="keyword">new</span> Teacher());</code></pre> </div> </div> <div class="paragraph"> <p>It&#8217;s important to note that, when a cache is configured to use a JPA Cache Store, that cache would only be able to store ONE type of data.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Cache&lt;<span class="predefined-type">String</span>, User&gt; usersCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">myJPACache</span><span class="delimiter">&quot;</span></span>); <span class="comment">// configured for User entity class</span>
usersCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">raytsang</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> User());
Cache&lt;<span class="predefined-type">Integer</span>, Teacher&gt; teachersCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">myJPACache</span><span class="delimiter">&quot;</span></span>); <span class="comment">// cannot do this when this cache is configured to use a JPA cache store</span>
teachersCache.put(<span class="integer">1</span>, <span class="keyword">new</span> Teacher());</code></pre> </div> </div> <div class="paragraph"> <p>Use of <code>@EmbeddedId</code> is supported so that you can also use composite keys.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Vehicle</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
        <span class="annotation">@EmbeddedId</span>
        <span class="directive">private</span> VehicleId id;
        <span class="directive">private</span> <span class="predefined-type">String</span> color;        ...
}

<span class="annotation">@Embeddable</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">VehicleId</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span>
{
        <span class="directive">private</span> <span class="predefined-type">String</span> state;
        <span class="directive">private</span> <span class="predefined-type">String</span> licensePlate;
        ...
}</code></pre> </div> </div> <div class="paragraph"> <p>Lastly, auto-generated IDs ï»¿(e.g., <code>@GeneratedValue</code>) is not supported. When putting things into the cache with a JPA cache store, the key should be the ID value!</p> </div> </div> </div> <div class="sect2"> <h3 id="configuration_6"><a class="anchor" href="#configuration_6"></a>8.2. Configuration</h3> <div class="sect3"> <h4 id="sample_programatic_configuration_2"><a class="anchor" href="#sample_programatic_configuration_2"></a>8.2.1. Sample Programatic Configuration</h4> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> cacheConfig = <span class="keyword">new</span> ConfigurationBuilder().persistence()
             .addStore(JpaStoreConfigurationBuilder.class)
             .persistenceUnitName(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.loaders.jpa.configurationTest</span><span class="delimiter">&quot;</span></span>)
             .entityClass(User.class)
             .build();</code></pre> </div> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Parameter</th> <th class="tableblock halign-left valign-top">Description</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">persistenceUnitName</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">JPA persistence unit name in JPA configuration ï»¿(persistence.xml) that contains the JPA entity class</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">entityClass</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">JPA entity class that is expected to be stored in this cache. Only one class is allowed.</p></td> </tr> </tbody> </table> </div> <div class="sect3"> <h4 id="sample_xml_configuration_2"><a class="anchor" href="#sample_xml_configuration_2"></a>8.2.2. Sample XML Configuration</h4> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vehicleCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;jpa-store</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:store:jpa:7.0</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">persistence-unit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.persistence.jpa.configurationTest</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">entity-class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.persistence.jpa.entity.Vehicle</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                /<span class="error">&gt;</span>
   <span class="tag">&lt;/persistence&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre> </div> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Parameter</th> <th class="tableblock halign-left valign-top">Description</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">persistence-unit</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">JPA persistence unit name in JPA configuration ï»¿(persistence.xml) that contains the JPA entity class</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">entity-class</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Fully qualified JPA entity class name that is expected to be stored in this cache. Only one class is allowed.</p></td> </tr> </tbody> </table> </div> </div> <div class="sect2"> <h3 id="additional_references_2"><a class="anchor" href="#additional_references_2"></a>8.3. Additional References</h3> <div class="paragraph"> <p>Refer to the <a href="https://github.com/infinispan/infinispan/blob/master/persistence/jpa/src/test/java/org/infinispan/persistence/jpa/JpaConfigurationTest.java">test case</a> for code samples in action.</p> </div> <div class="paragraph"> <p>Refer to <a href="https://github.com/infinispan/infinispan/blob/master/persistence/jpa/src/test/resources/config/jpa-config.xml">test configurations</a> for configuration samples.</p> </div> </div> <div class="sect2"> <h3 id="javadoc_2"><a class="anchor" href="#javadoc_2"></a>8.4. Javadoc</h3> <div class="paragraph"> <p><strong>TODO</strong></p> </div> </div> </div> </div> <div class="sect1"> <h2 id="transactions"><a class="anchor" href="#transactions"></a>9. Transactions</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan can be configured to use and to participate in JTA compliant transactions. Alternatively, if transaction support is disabled, it is equivalent to using autocommit in JDBC calls, where modifications are potentially replicated after every change (if replication is enabled).</p> </div> <div class="paragraph"> <p>On every cache operation Infinispan does the following:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Retrieves the current <a href="http://docs.oracle.com/javaee/1.3/api/javax/transaction/Transaction.html">Transaction</a> associated with the thread</p> </li> <li> <p>If not already done, registers <a href="http://docs.oracle.com/javaee/1.3/api/javax/transaction/xa/XAResource.html">XAResource</a> with the transaction manager to be notified when a transaction commits or is rolled back.</p> </li> </ol> </div> <div class="paragraph"> <p>In order to do this, the cache has to be provided with a reference to the environment&#8217;s <a href="http://docs.oracle.com/javaee/1.3/api/javax/transaction/TransactionManager.html">TransactionManager</a> . This is usually done by configuring the cache with the class name of an implementation of the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/transaction/lookup/TransactionManagerLookup.html">TransactionManagerLookup</a> interface. When the cache starts, it will create an instance of this class and invoke its getTransactionManager() method, which returns a reference to the TransactionManager.</p> </div> <div class="paragraph"> <p>Infinispan ships with several transaction manager lookup classes:</p> </div> <div class="ulist"> <div class="title">Transaction manager lookup implementations</div> <ul> <li> <p><a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/transaction/lookup/DummyTransactionManagerLookup.html">DummyTransactionManagerLookup</a> : This provides with a dummy transaction manager which should only be used for testing. Being a dummy, this is not recommended for production use a it has some severe limitations to do with concurrent transactions and recovery.</p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/transaction/lookup/JBossStandaloneJTAManagerLookup.html">JBossStandaloneJTAManagerLookup</a> : If you&#8217;re running Infinispan in a standalone environment, this should be your default choice for transaction manager. It&#8217;s a fully fledged transaction manager based on <a href="http://www.jboss.org/jbosstm">JBoss Transactions</a> which overcomes all the deficiencies of the dummy transaction manager.</p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/transaction/lookup/GenericTransactionManagerLookup.html">GenericTransactionManagerLookup</a> : This is a lookup class that locate transaction managers in the most popular Java EE application servers. If no transaction manager can be found, it defaults on the dummy transaction manager.</p> </li> </ul> </div> <div class="paragraph"> <p>Once initialized, the TransactionManager can also be obtained from the Cache itself:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">//the cache must have a transactionManagerLookupClass defined</span>
Cache cache = cacheManager.getCache();

<span class="comment">//equivalent with calling TransactionManagerLookup.getTransactionManager();</span>
TransactionManager tm = cache.getAdvancedCache().getTransactionManager();</code></pre> </div> </div> <div class="sect2"> <h3 id="configuring_transactions"><a class="anchor" href="#configuring_transactions"></a>9.1. Configuring transactions</h3> <div class="paragraph"> <p>Transactions are being configured at cache level.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;transaction</span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">transaction-manager-lookup</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.transaction.lookup.GenericTransactionManagerLookup</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FULL_XA</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">locking</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">OPTIMISTIC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="ulist"> <ul> <li> <p>transactionManagerLookupClass fully qualified class name of a class that looks up a reference to a javax.transaction.TransactionManager</p> </li> <li> <p>mode - configures whether the cache is transaction mode, the available options are:</p> <div class="ulist"> <ul> <li> <p><code>NONE</code> - non transactional cache</p> </li> <li> <p><code>FULL_XA</code> - XA transactional cache with recovery enabled.</p> </li> <li> <p><code>NON_DURABLE_XA</code> - XA transactional cache with recovery disabled.</p> </li> <li> <p><code>NON_XA</code> - Transactional cache with intergration via Synchronization instead of XA.</p> </li> </ul> </div> </li> <li> <p>locking - configures whether the cache uses optimistic or pessimistic locking.</p> </li> </ul> </div> <div class="paragraph"> <p>For more details on how two phase commit (2PC) is implemented in Infinispan and how locks are being acquired see the section below. All possible transactional settings are available in <a href="http://docs.jboss.org/infinispan/8.2/configdocs/">Configuration reference</a></p> </div> </div> <div class="sect2"> <h3 id="transaction_modes"><a class="anchor" href="#transaction_modes"></a>9.2. Transaction modes</h3> <div class="paragraph"> <p>Starting with Infinispan 5.1 release a cache can accessed either transactionally or non-transactionally. The mixed access mode that existed in Infinispan 4 and 5.0 is no longer supported. There are several reasons for going this path, but one of them most important is a cleaner semantic on how concurrency is managed between multiple requestors for the same cache entry.</p> </div> <div class="paragraph"> <p>By default, all Infinispan caches are non-transactional. A cache can be made transactional by changing the <code>mode</code> attribute:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactional</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;transaction</span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NON_XA</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>One can configure a transactional cache programatically as well, the equivalent is:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder().transaction().transactionMode(TransactionMode.TRANSACTIONAL).build();
<span class="keyword">assert</span> c.transaction().transactionalCache();</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Do not forget to configure a TransactionManagerLookup for transactional caches. </td> </tr> </table> </div> <div class="paragraph"> <p>Supported transaction models are optimistic and pessimistic. Optimistic model is an improvement over the old transaction model as it completely defers lock acquisition to transaction prepare time. New approach reduces lock acquisition duration and increases throughput which in turn avoids deadlocks significantly. In pessimistic model, cluster wide-locks are acquired on each write operation only being released after the transaction completed.</p> </div> <div class="sect3"> <h4 id="optimistic_transactions"><a class="anchor" href="#optimistic_transactions"></a>9.2.1. Optimistic Transactions</h4> <div class="paragraph"> <p>With optimistic transactions locks are being acquired at transaction prepare time and are only being held up to the point the transaction commits (or rollbacks). This is different from the 5.0 default locking model where local locks are being acquire on writes and cluster locks are being acquired during prepare time.</p> </div> <div class="paragraph"> <p>Optimistic transactions can be enabled in the configuration file:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactional</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;transaction</span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NON_XA</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">locking</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">OPTIMISTIC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>or programatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder().transaction().lockingMode(LockingMode.OPTIMISTIC).build();
<span class="keyword">assert</span> c.transaction().lockingMode() == LockingMode.OPTIMISTIC;</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> By default, a transactional cache is optimistic. </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="pessimistic_transactions"><a class="anchor" href="#pessimistic_transactions"></a>9.2.2. Pessimistic Transactions</h4> <div class="paragraph"> <p>From a lock acquisition perspective, pessimistic transactions obtain locks on keys at the time the key is written. E.g.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">transactionManager.begin();
cache.put(k1,v1); <span class="comment">//k1 is locked</span>
cache.remove(k2); <span class="comment">//k2 is locked when this returns</span>
transactionManager.commit();</code></pre> </div> </div> <div class="paragraph"> <p>When <code>cache.put(k1,v1)</code> returns, k1 is locked and no other transaction running anywhere in the cluster can write to it. Reading k1 is still possible. The lock on k1 is released when the transaction completes (commits or rollbacks).</p> </div> <div class="paragraph"> <p>Pessimistic transactions can be enabled in the configuration file:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactional</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;transaction</span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NON_XA</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">locking</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PESSIMISTIC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>or programatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder().transaction().lockingMode(LockingMode.PESSIMISTIC).build();
<span class="keyword">assert</span> c.transaction().lockingMode() == LockingMode.PESSIMISTIC;</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="backward_compatibility"><a class="anchor" href="#backward_compatibility"></a>9.2.3. Backward compatibility</h4> <div class="paragraph"> <p>The <code>autoCommit</code> attribute was added in order to assure backward compatibility with Infinispan 4. If a cache is transactional and autoCommit is enabled (defaults to true) then any call that is performed outside of a transaction&#8217;s scope is transparently wrapped within a transaction. In other words Infinispan adds the logic for starting a transaction before the call and committing it after the call.</p> </div> <div class="paragraph"> <p>Therefore if your code accesses a cache both transactionally and non-transactionally all you have to do when migrating to Infinispan 5.1 is mark the cache as transactional and enable autoCommit (that&#8217;s actually enabled by default)</p> </div> <div class="paragraph"> <p>The autoCommit feature can be managed through configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactional</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;transaction</span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NON_XA</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">auto-commit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre> </div> </div> </div> <div class="sect3"> <h4 id="what_do_i_need_pessimistic_or_optimistic_transactions"><a class="anchor" href="#what_do_i_need_pessimistic_or_optimistic_transactions"></a>9.2.4. What do I need - pessimistic or optimistic transactions?</h4> <div class="paragraph"> <p>From a use case perspective, optimistic transactions should be used when there is <em>not</em> a lot of contention between multiple transactions running at the same time. That is because the optimistic transactions rollback if data has changed between the time it was read and the time it was committed (writeSkewCheck).</p> </div> <div class="paragraph"> <p>On the other hand, pessimistic transactions might be a better fit when there is high contention on the keys and transaction rollbacks are less desirable. Pessimistic transactions are more costly by their nature: each write operation potentially involves a RPC for lock acquisition.</p> </div> </div> </div> <div class="sect2"> <h3 id="deadlock_detection"><a class="anchor" href="#deadlock_detection"></a>9.3. Deadlock detection</h3> <div class="paragraph"> <p>Deadlocks can significantly (up to one order of magnitude, see benchmarks) reduce the throughput of a system, especially when multiple transactions are operating agains the same key set. Deadlock detection is disabled by default, but can be enabled/configured per cache (i.e. under *-cache config element) by adding the following:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">deadlock-detection-spin</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Some clues on when to enable deadlock detection. A high number of transaction rolling back due to <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/util/concurrent/TimeoutException.html">TimeoutException</a> is an indicator that this functionality might help. TimeoutException might be caused by other causes as well, but deadlocks will always result in this exception being thrown. Generally, when you have a high contention on a set of keys, deadlock detection may help. But the best way is not to guess the performance improvement but to benchmark and monitor it: you can have access to statistics (e.g. number of deadlocks detected) through JMX, as it is exposed via the DeadlockDetectingLockManager MBean. For more details on how deadlock detection works, benchmarks and design details refer to <a href="http://infinispan.blogspot.com/2009/07/increase-transactional-throughput-with.html">this</a> article.</p> </div> <div class="paragraph"> <p>Note: deadlock detection only runs on an a per cache basis: deadlocks that spread over two or more caches won&#8217;t be detected.</p> </div> </div> <div class="sect2"> <h3 id="dealing_with_exceptions"><a class="anchor" href="#dealing_with_exceptions"></a>9.4. Dealing with exceptions</h3> <div class="paragraph"> <p>If a <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/commons/tion.html">CacheException</a> (or a subclass of it) is thrown by a cache method within the scope of a JTA transaction, then the transaction is automatically marked for rollback.</p> </div> </div> <div class="sect2"> <h3 id="enlisting_synchronizations"><a class="anchor" href="#enlisting_synchronizations"></a>9.5. Enlisting Synchronizations</h3> <div class="paragraph"> <p>By default Infinispan registers itself as a first class participant in distributed transactions through <a href="http://docs.oracle.com/javaee/6/api/javax/transaction/xa/XAResource.html">XAResource</a> . There are situations where Infinispan is not required to be a participant in the transaction, but only to be notified by its lifecycle (prepare, complete): e.g. in the case Infinispan is used as a 2nd level cache in Hibernate.</p> </div> <div class="paragraph"> <p>Starting with 5.0 release, Infinispan allows transaction enlistment through <a href="http://docs.oracle.com/javaee/6/api/javax/transaction/Synchronization.html">Synchronisation</a> . To enable it just use <code>NON_XA</code> transaction mode:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;transaction</span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NON_XA</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p><a href="http://docs.oracle.com/javaee/6/api/javax/transaction/Synchronization.html">Synchronization</a>s have the advantage that they allow TransactionManager to optimize 2PC with a 1PC where only one other resource is enlisted with that transaction ( <a href="http://docs.redhat.com/docs/en-US/JBoss_Enterprise_Web_Platform/5/html/Administration_And_Configuration_Guide/ch09s04.html">last resource commit optimization</a> ). E.g. Hibernate second level cache: if Infinispan registers itself with the TransactionManager as an <a href="http://docs.oracle.com/javaee/6/api/javax/transaction/xa/XAResource.html">XAResource</a> than at commit time, the TransactionManager sees two <a href="http://docs.oracle.com/javaee/6/api/javax/transaction/xa/XAResource.html">XAResource</a> (cache and database) and does not make this optimization. Having to coordinate between two resources it needs to write the tx log to disk. On the other hand, registering Infinispan as a <a href="http://docs.oracle.com/javaee/6/api/javax/transaction/Synchronization.html">Synchronisation</a> makes the TransactionManager skip writing the log to the disk (performance improvement).</p> </div> </div> <div class="sect2"> <h3 id="batching"><a class="anchor" href="#batching"></a>9.6. Batching</h3> <div class="paragraph"> <p>Batching allows atomicity and some characteristics of a transaction, but not full-blown JTA or XA capabilities. Batching is often a lot lighter and cheaper than a full-blown transaction.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> Generally speaking, one should use batching API whenever the only participant in the transaction is an Infinispan cluster. On the other hand, JTA transactions (involving TransactionManager) should be used whenever the transactions involves multiple systems. E.g. considering the "Hello world!" of transactions: transferring money from one bank account to the other. If both accounts are stored within Infinispan, then batching can be used. If one account is in a database and the other is Infinispan, then distributed transactions are required. </td> </tr> </table> </div> <div class="sect3"> <h4 id="configuring_batching"><a class="anchor" href="#configuring_batching"></a>9.6.1. Configuring batching</h4> <div class="paragraph"> <p>To use batching, you need to enable invocation batching in your cache configuration, either on the Configuration object:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span>.setInvocationBatchingEnabled(<span class="predefined-constant">true</span>);</code></pre> </div> </div> <div class="paragraph"> <p>or in your XML file:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;local-cache&gt;</span>
   <span class="tag">&lt;transaction</span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BATCH</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>By default, invocation batching is disabled.</p> </div> <div class="paragraph"> <p>Note that you <em>do not</em> have to have a transaction manager defined to use batching.</p> </div> </div> <div class="sect3"> <h4 id="api_2"><a class="anchor" href="#api_2"></a>9.6.2. API</h4> <div class="paragraph"> <p>Once you have configured your cache to use batching, you use it by calling startBatch() and endBatch() on Cache. E.g.,</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Cache cache = cacheManager.getCache();
<span class="comment">// not using a batch</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>); <span class="comment">// will replicate immediately</span>

<span class="comment">// using a batch</span>
cache.startBatch();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.endBatch(<span class="predefined-constant">true</span>); <span class="comment">// This will now replicate the modifications since the batch was started.</span>

<span class="comment">// a new batch</span>
cache.startBatch();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k3</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.endBatch(<span class="predefined-constant">false</span>); <span class="comment">// This will &quot;discard&quot; changes made in the batch</span></code></pre> </div> </div> </div> <div class="sect3"> <h4 id="batching_and_jta"><a class="anchor" href="#batching_and_jta"></a>9.6.3. Batching and JTA</h4> <div class="paragraph"> <p>Behind the scenes, the batching functionality starts a JTA transaction, and all the invocations in that scope are associated with it. For this it uses a very simple (e.g. no recovery) internal TransactionManager implementation. With batching, you get:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Locks you acquire during an invocation are held until the batch completes</p> </li> <li> <p>Changes are all replicated around the cluster in a batch as part of the batch completion process. Reduces replication chatter for each update in the batch.</p> </li> <li> <p>If synchronous replication or invalidation are used, a failure in replication/invalidation will cause the batch to roll back.</p> </li> <li> <p>All the transaction related configurations apply for batching as well:</p> </li> </ol> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;transaction</span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NON_XA</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="transaction_recovery"><a class="anchor" href="#transaction_recovery"></a>9.7. Transaction recovery</h3> <div class="paragraph"> <p>Recovery is a feature of XA transactions, which deal with the eventuality of a resource or possibly even the transaction manager failing, and recovering accordingly from such a situation.</p> </div> <div class="sect3"> <h4 id="when_to_use_recovery"><a class="anchor" href="#when_to_use_recovery"></a>9.7.1. When to use recovery</h4> <div class="paragraph"> <p>Consider a distributed transaction in which money is transferred from an account stored in an external database to an account stored in Infinispan. When <code>TransactionManager.commit()</code> is invoked, both resources prepare successfully (1st phase). During the commit (2nd) phase, the database successfully applies the changes whilst Infinispan fails before receiving the commit request from the transaction manager. At this point the system is in an inconsistent state: money is taken from the account in the external database but not visible yet in Infinispan (since locks are only released during 2nd phase of a two-phase commit protocol). Recovery deals with this situation to make sure data in both the database and Infinispan ends up in a consistent state.</p> </div> </div> <div class="sect3"> <h4 id="how_does_it_work"><a class="anchor" href="#how_does_it_work"></a>9.7.2. How does it work</h4> <div class="paragraph"> <p>Recovery is coordinated by the transaction manager. The transaction manager works with Infinispan to determine the list of in-doubt transactions that require manual intervention and informs the system administrator (via email, log alerts, etc). This process is transaction manager specific, but generally requires some configuration on the transaction manager.Â Â </p> </div> <div class="paragraph"> <p>Knowing the in-doubt transaction ids, the system administrator can now connect to the Infinispan cluster and replay the commit of transactions or force the rollback. Infinispan provides JMX tooling for this - this is explained extensively in the <a href="http://community.jboss.org/docs/DOC-16646?uniqueTitle=false#Reconciliate_state">Reconciliate state</a> section.</p> </div> </div> <div class="sect3"> <h4 id="configuring_recovery"><a class="anchor" href="#configuring_recovery"></a>9.7.3. Configuring recoveryÂ Â Â </h4> <div class="paragraph"> <p>Recovery is <em>not</em> enabled by default in Infinispan. If disabled the TransactionManager won&#8217;t be able to work with Infinispan to determine the in-doubt transactions. In order to enable recovery through xml configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;transaction</span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FULL_XA</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">recovery-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">noRecovery</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> the <em>recovery-cache</em> attribute is not mandatory. </td> </tr> </table> </div> <div class="paragraph"> <p>Alternatively you can enable it through the fluent configuration API as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">//simply calling .recovery() enables it</span>
configuration.transaction().recovery();

<span class="comment">//then you can disable it</span>
configuration.transaction().recovery().disable();

<span class="comment">//or just check its status</span>
<span class="type">boolean</span> isRecoveryEnabled = configuration.isTransactionRecoveryEnabled();</code></pre> </div> </div> <div class="paragraph"> <p>Recovery can be enabled/disabled o a per cache level: e..g it is possible to have a transaction spanning a cache that is has it enabled and another one that doesn&#8217;t.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> For recovery to work, <code>mode</code> must be set to <code>FULL_XA</code>, since full-blown XA transactions are needed. </td> </tr> </table> </div> <div class="sect4"> <h5 id="enable_jmx_support"><a class="anchor" href="#enable_jmx_support"></a>Enable JMX support</h5> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="fa icon-important" title="Important"></i> </td> <td class="content"> In order to be able to use JMX for managing recovery JMX support must be explicitly enabled. More about enabling JMX <a href="http://community.jboss.org/docs/DOC-14865#Enabling_JMX_Statistics">here</a> . </td> </tr> </table> </div> </div> </div> <div class="sect3"> <h4 id="recovery_cache"><a class="anchor" href="#recovery_cache"></a>9.7.4. Recovery cache</h4> <div class="paragraph"> <p>In order to track in-doubt transactions and be able to reply them Infinispan caches all transaction state for future use. This state is held only for in-doubt transaction, being removed for successfully completed transactions after the commit/rollback phase completed.</p> </div> <div class="paragraph"> <p>This in-doubt transaction data is held within a local cache: this allows one to configure swapping this info to disk through cache loader in the case it gets too big. This cache can be specified through theÂ  "recoveryInfoCacheName" configuration attribute. If not specified infinispan will configure a local cache for you.</p> </div> <div class="paragraph"> <p>It is possible (though not mandated) to share same recovery cache between all the Infinispan caches that have recovery enabled.Â  If default recovery cache is overridden then the specified recovery cache must use a <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/transaction/lookup/class-use/TransactionManagerLookup.html">TransactionManagerLookup</a> that returns a different transaction manager than the one used by the cache itself.</p> </div> </div> <div class="sect3"> <h4 id="integration_with_the_transaction_manager"><a class="anchor" href="#integration_with_the_transaction_manager"></a>9.7.5. Integration with the transaction manager</h4> <div class="paragraph"> <p>Even though this is transaction manager specific, generally a transaction manager would need a reference to an XAResource implementation in order to invoke <code>XAResource.recover()</code> on it. In order to obtain a reference to an Infinispan XAResource following API can be used:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">XAResource</span> xar = cache.getAdvancedCache().getXAResource();<span class="error">Â </span></code></pre> </div> </div> <div class="paragraph"> <p>It is a common practice to run the recovery in a different process from the one running the transaction. At the moment it is not possible to do this with infinispan: the recovery must be run from the same process where the infinispan instance exists. This limitation will be dropped once <a href="https://issues.jboss.org/browse/ISPN-375">transactions over HotRod</a> are available.</p> </div> </div> <div class="sect3"> <h4 id="reconciliation"><a class="anchor" href="#reconciliation"></a>9.7.6. Reconciliation</h4> <div class="paragraph"> <p>The transaction manager informs the system administrator on in-doubt transaction in a proprietary way. At this stage it is assumed that the system administrator knows transaction&#8217;s XID (a byte array).</p> </div> <div class="paragraph"> <p>A normal recovery flow is:</p> </div> <div class="ulist"> <ul> <li> <p><strong>STEP 1</strong>: The system administrator connects to an Infinispan server through JMX, and lists the in doubt transactions. The image below demonstrates JConsole connecting to an Infinispan node that has an in doubt transaction.</p> </li> </ul> </div> <div class="imageblock"> <div class="content"> <img src="./images/showInDoubtTx.png" alt="showInDoubtTx"> </div> </div> <div class="paragraph"> <p>The status of each in-doubt transaction is displayed(in this example " <em>PREPARED</em> "). There might be multiple elements in the status field, e.g. "PREPARED" and "COMMITTED" in the case the transaction committed on certain nodes but not on all of them.Â Â </p> </div> <div class="ulist"> <ul> <li> <p><strong>STEP 2</strong>: The system administrator visually maps the XID received from the transaction manager to an Infinispna internal id, represented as a number. This step is needed because the XID, a byte array, cannot conveniently be passed to the JMX tool (e.g. JConsole) and then re-assembled on infinispan&#8217;s side.</p> </li> <li> <p><strong>STEP 3</strong>: The system administrator forces the transaction&#8217;s commit/rollback through the corresponding jmx operation, based on the internal id. The image below is obtained by forcing the commit of the transaction based on its internal id.</p> </li> </ul> </div> <div class="imageblock"> <div class="content"> <img src="./images/forceCommit.png" alt="forceCommit"> </div> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> All JMX operations described above can be executed on any node, regardless of where the transaction originated. </td> </tr> </table> </div> <div class="sect4"> <h5 id="force_commit_rollback_based_on_xid"><a class="anchor" href="#force_commit_rollback_based_on_xid"></a>Force commit/rollback based on XID</h5> <div class="paragraph"> <p>XID-based JMX operations for forcing in-doubt transactions' commit/rollback are available as well: these methods receive byte[] arrays describing the XID instead of the number associated with the transactions (as previously described at step 2). These can be useful e.g. if one wants to set up an automatic completion job for certain in-doubt transactions. This process is plugged into transaction manager&#8217;s recovery and has access to the transaction manager&#8217;s XID objects.</p> </div> </div> </div> <div class="sect3"> <h4 id="want_to_know_more"><a class="anchor" href="#want_to_know_more"></a>9.7.7. Want to know more?</h4> <div class="paragraph"> <p>The <a href="https://community.jboss.org/wiki/TransactionRecoveryDesign">recovery design document</a> describes in more detail the insides of transaction recovery implementation.</p> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="locking_and_concurrency"><a class="anchor" href="#locking_and_concurrency"></a>10. Locking and Concurrency</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan makes use of multi-versioned concurrency control (<a href="http://en.wikipedia.org/wiki/Multiversion_concurrency_control">MVCC</a>) - a concurrency scheme popular with relational databases and other data stores. MVCC offers many advantages over coarse-grained Java synchronization and even JDK Locks for access to shared data, including:</p> </div> <div class="ulist"> <ul> <li> <p>allowing concurrent readers and writers</p> </li> <li> <p>readers and writers do not block one another</p> </li> <li> <p>write skews can be detected and handled</p> </li> <li> <p>internal locks can be striped</p> </li> </ul> </div> <div class="sect2"> <h3 id="locking_implementation_details"><a class="anchor" href="#locking_implementation_details"></a>10.1. Locking implementation details</h3> <div class="paragraph"> <p>Infinispan&#8217;s MVCC implementation makes use of minimal locks and synchronizations, leaning heavily towards lock-free techniques such as <a href="http://en.wikipedia.org/wiki/Compare-and-swap">compare-and-swap</a> and lock-free data structures wherever possible, which helps optimize for multi-CPU and multi-core environments.</p> </div> <div class="paragraph"> <p>In particular, Infinispan&#8217;s MVCC implementation is heavily optimized for readers. Reader threads do not acquire explicit locks for entries, and instead directly read the entry in question.</p> </div> <div class="paragraph"> <p>Writers, on the other hand, need to acquire a write lock. This ensures only one concurrent writer per entry, causing concurrent writers to queue up to change an entry. To allow concurrent reads, writers make a copy of the entry they intend to modify, by wrapping the entry in an <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/container/entries/MVCCEntry.html">MVCCEntry</a> . This copy isolates concurrent readers from seeing partially modified state. Once a write has completed, MVCCEntry.commit() will flush changes to the data container and subsequent readers will see the changes written.</p> </div> <div class="sect3"> <h4 id="how_it_works_in_clustered_caches"><a class="anchor" href="#how_it_works_in_clustered_caches"></a>10.1.1. How it works in clustered caches?</h4> <div class="paragraph"> <p>In clustered caches, each key has a node responsible to lock the key. This node is called primary owner.</p> </div> <div class="sect4"> <h5 id="non_transactional_caches"><a class="anchor" href="#non_transactional_caches"></a>Non Transactional caches</h5> <div class="olist arabic"> <ol class="arabic"> <li> <p>The write operation is sent to the primary owner of the key.</p> </li> <li> <p>The primary owner tries to lock the key.</p> <div class="olist loweralpha"> <ol class="loweralpha" type="a"> <li> <p>If it succeeds, it forwards the operation to the other owners;</p> </li> <li> <p>Otherwise, an exception is thrown.</p> </li> </ol> </div> </li> </ol> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> If the operation is conditional and it fails on the primary owner, it is not forwarded to the other owners. </td> </tr> </table> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> If the operation is executed locally in the primary owner, the first step is skipped. </td> </tr> </table> </div> </div> <div class="sect4"> <h5 id="pessimistic_transactional_cache"><a class="anchor" href="#pessimistic_transactional_cache"></a>Pessimistic transactional cache</h5> <div class="paragraph"> <p>In pessimist transactional caches, the locks are acquired during write/lock operations.</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>A lock request is sent to the primary owner (can be an explicit lock request or an operation)</p> </li> <li> <p>The primary owner tries to acquire the lock:</p> <div class="olist loweralpha"> <ol class="loweralpha" type="a"> <li> <p>If it succeed, it sends back a positive reply;</p> </li> <li> <p>Otherwise, a negative reply is sent and the transaction is rollback.</p> </li> </ol> </div> </li> </ol> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> For conditional operations and write skew check (if enabled), the validation is performed in the originator. </td> </tr> </table> </div> </div> <div class="sect4"> <h5 id="optimistic_transactional_cache"><a class="anchor" href="#optimistic_transactional_cache"></a>Optimistic transactional cache</h5> <div class="paragraph"> <p>In optimistic transactional caches, the locks are acquired during transaction prepare time.</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>The prepare is sent to all the owners.</p> </li> <li> <p>The primary owners try to acquire the locks needed:</p> <div class="olist loweralpha"> <ol class="loweralpha" type="a"> <li> <p>If locking succeeds, it performs the write skew check.</p> </li> <li> <p>If the write skew check succeeds (or is disabled), send a positive reply.</p> </li> <li> <p>Otherwise, a negative reply is sent and the transaction is rolled back.</p> </li> </ol> </div> </li> </ol> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> For conditional commands, the validation still happens on the originator. In addition to that, the write skew check is done in the primary owner. </td> </tr> </table> </div> </div> </div> <div class="sect3"> <h4 id="isolation_levels"><a class="anchor" href="#isolation_levels"></a>10.1.2. Isolation levels</h4> <div class="paragraph"> <p>Infinispan offers two isolation levels - <a href="http://en.wikipedia.org/wiki/Isolation_level#READ_COMMITTED">READ_COMMITTED</a> (the default) and <a href="http://en.wikipedia.org/wiki/Isolation_level#REPEATABLE_READ">REPEATABLE_READ</a>, configurable via the <a href="http://docs.jboss.org/infinispan/5.1/configdocs/urn_infinispan_config_5.1/complexType/configuration.locking.html"><code>&lt;locking /&gt;</code></a> configuration element.</p> </div> <div class="paragraph"> <p>These isolation levels determine when readers see a concurrent write, and are internally implemented using different subclasses of <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/container/entries/MVCCEntry.html">MVCCEntry</a>, which have different behaviour in how state is committed back to the data container.</p> </div> <div class="paragraph"> <p>Here&#8217;s a more detailed example that should help understand the difference between READ_COMMITTED and REPEATABLE_READ in the context of Infinispan. With read committed, if between two consecutive read calls on the same key, the key has been updated by another transaction, the second read will return the new updated value:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Thread1: tx.begin()</p> </li> <li> <p>Thread1: cache.get(k) returns v</p> </li> <li> <p>Thread2: tx.begin()</p> </li> <li> <p>Thread2: cache.get(k) returns v</p> </li> <li> <p>Thread2: cache.put(k, v2)</p> </li> <li> <p>Thread2: tx.commit()</p> </li> <li> <p>Thread1: cache.get(k) returns v2!</p> </li> </ol> </div> <div class="paragraph"> <p>With REPEATABLE_READ, step 7 will still return v. So, if you&#8217;re going to retrieve the same key multiple times within a transaction, you should use REPEATABLE_READ.</p> </div> </div> <div class="sect3"> <h4 id="the_lockmanager"><a class="anchor" href="#the_lockmanager"></a>10.1.3. The LockManager</h4> <div class="paragraph"> <p>The LockManager is a component that is responsible for locking an entry for writing. The LockManager makes use of a LockContainer to locate/hold/create locks. LockContainers come in two broad flavours, with support for lock striping and with support for one lock per entry.</p> </div> </div> <div class="sect3"> <h4 id="lock_striping"><a class="anchor" href="#lock_striping"></a>10.1.4. Lock striping</h4> <div class="paragraph"> <p>Lock striping entails the use of a fixed-size, shared collection of locks for the entire cache, with locks being allocated to entries based on the entry&#8217;s key&#8217;s hash code. Similar to the way the JDK&#8217;s ConcurrentHashMap allocates locks, this allows for a highly scalable, fixed-overhead locking mechanism in exchange for potentially unrelated entries being blocked by the same lock.</p> </div> <div class="paragraph"> <p>The alternative is to disable lock striping - which would mean a <em>new</em> lock is created per entry. This approach <em>may</em> give you greater concurrent throughput, but it will be at the cost of additional memory usage, garbage collection churn, etc.</p> </div> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="fa icon-important" title="Important"></i> </td> <td class="content"> <div class="title">Default lock striping settings</div> From Infinispan 5.0, lock striping is disabled by default, due to potential deadlocks that can happen if locks for different keys end up in the same lock stripe. Previously, in Infinispan 4.x lock striping used to be enabled by default. </td> </tr> </table> </div> <div class="paragraph"> <p>The size of the shared lock collection used by lock striping can be tuned using the <code>concurrencyLevel</code> attribute of the <a href="http://docs.jboss.org/infinispan/5.1/configdocs/urn_infinispan_config_5.1/complexType/configuration.locking.html"><code>&lt;locking /&gt;</code></a> configuration element.</p> </div> </div> <div class="sect3"> <h4 id="concurrency_levels"><a class="anchor" href="#concurrency_levels"></a>10.1.5. Concurrency levels</h4> <div class="paragraph"> <p>In addition to determining the size of the striped lock container, this concurrency level is also used to tune any JDK ConcurrentHashMap based collections where related, such as internal to DataContainers. Please refer to the JDK ConcurrentHashMap Javadocs for a detailed discussion of concurrency levels, as this parameter is used in exactly the same way in Infinispan.</p> </div> </div> <div class="sect3"> <h4 id="consistency"><a class="anchor" href="#consistency"></a>10.1.6. Consistency</h4> <div class="paragraph"> <p>The fact that a single owner is locked (as opposed to all owners being locked) does not break the following consistency guarantee: if key K is hashed to nodes {A, B} and transaction TX1 acquires a lock for K, let&#8217;s say on A. If another transaction, TX2, is started on B (or any other node) and TX2 tries to lock K then it will fail with a timeout as the lock is already held by TX1. The reason for this is the that the lock for a key K is always, deterministically, acquired on the same node of the cluster, regardless of where the transaction originates.</p> </div> </div> </div> <div class="sect2"> <h3 id="data_versioning"><a class="anchor" href="#data_versioning"></a>10.2. Data Versioning</h3> <div class="paragraph"> <p>Infinispan will offer three forms of data versioning, including simple, partition aware and external. Each case is described in detail below.</p> </div> <div class="sect3"> <h4 id="simple_versioning"><a class="anchor" href="#simple_versioning"></a>10.2.1. Simple versioning</h4> <div class="paragraph"> <p>The purpose of simple versioning is to provide a reliable mechanism of write skew checks when using optimistic transactions, REPEATABLE_READ and a clustered cache. Write skew checks are performed at prepare-time to ensure a concurrent transaction hasn&#8217;t modified an entry while it was read and potentially updated based on the value read.</p> </div> <div class="paragraph"> <p>When operating in LOCAL mode, write skew checks rely on Java object references to compare differences and this is adequate to provide a reliable write-skew check, however this technique is useless in a cluster and a more reliable form of versioning is necessary to provide reliable write skew checks.</p> </div> <div class="paragraph"> <p>Simple versioning is an implementation of the proposed EntryVersion interface, backed by a long that is incremented each time the entry is updated.</p> </div> </div> <div class="sect3"> <h4 id="partition_aware_versioning"><a class="anchor" href="#partition_aware_versioning"></a>10.2.2. Partition-aware versioning</h4> <div class="paragraph"> <p>This versioning scheme makes use of <a href="http://en.wikipedia.org/wiki/Vector_clock">vector clocks</a> to provide a network partition resilient form of versioning.</p> </div> <div class="paragraph"> <p>Unlike simple versioning, which is maintained per entry, a vector clock&#8217;s node counter is maintained per-node.</p> </div> </div> <div class="sect3"> <h4 id="external_versioning"><a class="anchor" href="#external_versioning"></a>10.2.3. External versioning</h4> <div class="paragraph"> <p>This scheme is used to encapsulate an external source of data versioning within Infinispan, such as when using Infinispan with Hibernate which in turn gets its data version information directly from a database.</p> </div> <div class="paragraph"> <p>In this scheme, a mechanism to pass in the version becomes necessary, and overloaded versions of put() and putForExternalRead() will be provided in AdvancedCache to take in an external data version. This is then stored on the InvocationContext and applied to the entry at commit time.</p> </div> <div class="paragraph"> <p>Write skew checks cannot and will not be performed in the case of external data versioning.</p> </div> </div> <div class="sect3"> <h4 id="tombstones"><a class="anchor" href="#tombstones"></a>10.2.4. Tombstones</h4> <div class="paragraph"> <p>To deal with deletions of entries, tombstones will be maintained as null entries that have been deleted, so that version information of the deleted entry can be maintained and write skews can still be detected. However this is an expensive thing to do, and as such, is a configuration option, disabled by default. Further, tombstones will follow a strict lifespan and will be cleared from the system after a specific amount of time.</p> </div> </div> <div class="sect3"> <h4 id="configuration_7"><a class="anchor" href="#configuration_7"></a>10.2.5. Configuration</h4> <div class="paragraph"> <p>By default versioning will be <em>disabled</em>. This will mean write skew checks when using transactions and <em>REPEATABLE_READ</em> as an isolation level will be unreliable when used in a cluster. Note that this doesn&#8217;t affect single-node, LOCAL mode usage.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;versioning</span> <span class="attribute-name">scheme</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SIMPLE|NONE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Or</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">new</span> ConfigurationBuilder().versioning().scheme(SIMPLE);</code></pre> </div> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="clustering"><a class="anchor" href="#clustering"></a>11. Clustering</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan can be configured to be either local (standalone) or clustered. If in a cluster, the cache can be configured to replicate changes to all nodes, to invalidate changes across nodes and finally to be used in distributed mode - state changes are replicated to a small subset of nodes enough to be fault tolerant but not too many nodes to prevent scalability.</p> </div> <div class="sect2"> <h3 id="local_mode"><a class="anchor" href="#local_mode"></a>11.1. Local Mode</h3> <div class="paragraph"> <p>While Infinispan is particularly interesting in clustered mode, it also offers a very capable local mode. In this mode, it acts as a simple, in-memory data cache similar to JBoss Cache and EHCache.</p> </div> <div class="paragraph"> <p>But why would one use a local cache rather than a map? Caches offer a lot of features over and above a simple map, including write-through and write-behind caching to persist data, eviction of entries to prevent running out of memory, and support for expirable entries. Infinispan, specifically, is built around a high-performance, read-biased data container which uses modern techniques similar to <a href="http://en.wikipedia.org/wiki/Read-copy-update">read-copy-update</a>&#8201;&#8212;&#8201;which buys you non-blocking, thread-safe reads even when concurrent writes are taking place. Infinispan also makes heavy use of compare-and-swap and other lock-free algorithms, making it ideal for high-throughput, multi-CPU/multi-core environments. Further, Infinispan&#8217;s Cache API extends the JDK&#8217;s ConcurrentMap - making migration from a map to Infinispan trivial.</p> </div> </div> <div class="sect2"> <h3 id="replicated_mode"><a class="anchor" href="#replicated_mode"></a>11.2. Replicated Mode</h3> <div class="paragraph"> <p>Replication is a simple clustered mode where cache instances automatically discover neighboring instances on other JVMs on the same local network, and form a cluster. Entries added to any of these cache instances will be replicated to all other cache instances in the cluster, and can be retrieved locally from any instance. This clustered mode provides a quick and easy way to share state across a cluster, however replication practically only performs well in small clusters (under 10 nodes), due to the number of replication messages that need to happen - as the cluster size increases. Infinispan can be configured to use UDP multicast which mitigates this problem to some degree.</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/Figure1_6.png" alt="Figure1 6"> </div> <div class="title">Figure 1. Replication mode</div> </div> <div class="paragraph"> <p>Replication can be synchronous or asynchronous. Use of either one of the options is application dependent. Synchronous replication blocks the caller (e.g. on a put() ) until the modifications have been replicated successfully to all nodes in a cluster. Asynchronous replication performs replication in the background (the put() returns immediately). Infinispan offers a replication queue, where modifications are replicated periodically (i.e. interval-based), or when the queue size exceeds a number of elements, or a combination thereof. A replication queue can therefore offer much higher performance as the actual replication is performed by a background thread.</p> </div> <div class="paragraph"> <p>Asynchronous replication is faster (no caller blocking), because synchronous replication requires acknowledgments from all nodes in a cluster that they received and applied the modification successfully (round-trip time). However, when a synchronous replication returns successfully, the caller knows for sure that all modifications have been applied to all cache instances, whereas this is not be the case with asynchronous replication. With asynchronous replication, errors are simply written to a log. Even when using transactions, a transaction may succeed but replication may not succeed on all cache instances.</p> </div> </div> <div class="sect2"> <h3 id="invalidation_mode"><a class="anchor" href="#invalidation_mode"></a>11.3. Invalidation Mode</h3> <div class="paragraph"> <p>Invalidation is a clustered mode that does not actually share any data at all, but simply aims to remove data that may be stale from remote caches. This cache mode only makes sense if you have another, permanent store for your data such as a database and are only using Infinispan as an optimization in a read-heavy system, to prevent hitting the database every time you need some state. If a cache is configured for invalidation rather than replication, every time data is changed in a cache other caches in the cluster receive a message informing them that their data is now stale and should be evicted from memory.</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/Figure2_5.png" alt="Figure2 5"> </div> <div class="title">Figure 2. Invalidation mode</div> </div> <div class="paragraph"> <p>Invalidation, when used with a shared cache loader would cause remote caches to refer to the shared cache loader to retrieve modified data. The benefit of this is twofold: network traffic is minimized as invalidation messages are very small compared to replicating updated data, and also that other caches in the cluster look up modified data in a lazy manner, only when needed.</p> </div> <div class="paragraph"> <p>Invalidation messages are sent after each modification (no transactions or batches), or at the end of a transaction or batch, upon successful commit. This is usually more efficient as invalidation messages can be optimized for the transaction as a whole rather than on a per-modification basis.</p> </div> <div class="paragraph"> <p>Invalidation too can be synchronous or asynchronous, and just as in the case of replication, synchronous invalidation blocks until all caches in the cluster receive invalidation messages and have evicted stale data while asynchronous invalidation works in a 'fire-and-forget' mode, where invalidation messages are broadcast but doesn&#8217;t block and wait for responses.</p> </div> </div> <div class="sect2"> <h3 id="distribution_mode"><a class="anchor" href="#distribution_mode"></a>11.4. Distribution Mode</h3> <div class="paragraph"> <p>Distribution is a powerful clustering mode which allows Infinispan to scale linearly as more nodes are added to the cluster. Distribution makes use of a hash algorithm to determine on which node(s) entries should be stored. The number of copies that should be maintained in the cluster for each cache entry is configurable (<strong>numOwners</strong>). The number of copies represents the trade-off between performance and durability of data. The more copies you maintain, the lower performance will be, but also the lower the risk of losing data due to server outages. Regardless of how many copies are maintained, distribution still scales linearly and this is key to Infinispan&#8217;s scalability.</p> </div> <div class="paragraph"> <p>Another feature of the hash algorithm is that it is deterministic in locating entries without resorting to multicast requests or maintaining expensive metadata. Doing a GET anywhere will result in at most <em>numOwners</em> remote calls. The remote GET requests are staggered: we request the value from the primary owner, but if it doesn&#8217;t respond in a reasonable amount of time, we request the value from the backup owners as well. (The {{infinispan.stagger.delay}} system property, in milliseconds, controls the delay between requests.) A GET may also result in 0 remote calls if the key is present in the local cache. Doing a PUT can result in more remote calls, depending on the cache configuration (e.g. whether the cache is transactional).</p> </div> <div class="sect3"> <h4 id="read_consistency"><a class="anchor" href="#read_consistency"></a>11.4.1. Read consistency</h4> <div class="paragraph"> <p>Since GETs are sent to all data owners in parallel and the first returning result is used, this can lead to data inconsistency when using an <em>asynchronous</em> transport. If an updating thread modifies the primary data owner, but updates are only sent to backup nodes asynchronously, a concurrent read from the same thread may read a stale value for a short period of time until the asynchronous replication completes.</p> </div> <div class="paragraph"> <p>Note that this is <em>only</em> if the transport is <em>asynchronous</em>. If using a <em>synchronous</em> transport this behavior is not exhibited.</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/Figure3_3.png" alt="Figure3 3"> </div> <div class="title">Figure 3. Distribution mode</div> </div> </div> <div class="sect3"> <h4 id="hashing_algorithms"><a class="anchor" href="#hashing_algorithms"></a>11.4.2. Hashing Algorithms</h4> <div class="paragraph"> <p>The hashing algorithm in Infinispan is based on <a href="http://en.wikipedia.org/wiki/Consistent_hashing">consistent hashing</a>, and even though our implementation has diverged a bit, we still use the term <strong>consistent hash</strong>.</p> </div> <div class="paragraph"> <p>Unlike in consistent hashing, we split the key space into fixed <strong>segments</strong>. The number of segments is configurable (<strong>numSegments</strong>), and it cannot be changed without restarting the cluster. The mapping of keys to segments is also fixed&#8201;&#8212;&#8201;a key should map to the same segment, regardless of how the topology of the cluster changes.</p> </div> <div class="paragraph"> <p>Each hash segment is mapped to a list of nodes called <strong>owners</strong>. The order matters, because the first owner, also known as the <strong>primary owner</strong>, has a special role in many cache operations (e.g. locking). The other owners are called <strong>backup owners</strong>. There is no hard rule on how the segments are mapped to owners, although the hashing algorithms generally try to balance the number of segments allocated to each node and at the same time minimize the number of segments that have to move after a node joins or leaves the cluster.</p> </div> <div class="paragraph"> <p>The hashing algorithm in Infinispan is customizable, and in fact there are five implementations that ship with Infinispan by default:</p> </div> <div class="dlist"> <dl> <dt class="hdlist1">org.infinispan.distribution.ch.DefaultConsistentHashFactory</dt> <dd> <p>The default hashing algorithm. It achieves a pretty even distribution, but it has one disadvantage: the mapping of segments to nodes depends on the order in which caches joined the cluster, so a key&#8217;s owners are not guaranteed to be the same in all the caches running in a cluster.</p> </dd> <dt class="hdlist1">org.infinispan.distribution.ch.TopologyAwareConsistentHashFactory</dt> <dd> <p>Selected automatically when <a href="#ServerHinting">Server Hinting</a> is enabled. Similar to the default algorithm, but also tries to spread each segment&#8217;s copies across as many sites, racks, or machines as possible.</p> </dd> <dt class="hdlist1">org.infinispan.distribution.ch.SyncConsistentHashFactory</dt> <dd> <p>An alternative algorithm, closer to consistent hashing (but still not exactly the same). It addresses the weakness of the default algorithm, and always assigns a key to the same node in every cache as long as the cluster is symmetric. It does have some weaknesses of itself, though: the load distribution is less even, and it also moves more segments than necessary on a join or leave.</p> </dd> <dt class="hdlist1">org.infinispan.distribution.ch.TopologyAwareSyncConsistentHashFactory</dt> <dd> <p>Similar to <em>SyncConsistentHashFactory</em>, but adapted for <a href="#ServerHinting">Server Hinting</a>.</p> </dd> <dt class="hdlist1">org.infinispan.distribution.ch.ReplicatedConsistentHashFactory</dt> <dd> <p>This algorithm is used internally to implement replicated caches. Users should never select this explicitly in a distributed cache.</p> </dd> </dl> </div> <div class="sect4"> <h5 id="capacity_factors"><a class="anchor" href="#capacity_factors"></a>Capacity Factors</h5> <div class="paragraph"> <p>The nodes in a cluster are not always identical. It is possible to have "non-standard" nodes that take <em>2x</em> as much load as a regular node, or <em>0.5x</em> as much load as a regular node, using the <strong>capacityFactor</strong> setting. The capacity factor can be any non-negative number, and the hashing algorithm will try to assign to each node a load weighted by its capacity factor (both as a primary owner and as a backup owner).</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Capacity factors support is new in Infinispan 6.0. </td> </tr> </table> </div> <div class="paragraph"> <p>One interesting use case is nodes with a capacity factor of <em>0</em>. This could be useful when some nodes are too short-lived to be useful as data owners, but they can&#8217;t use HotRod (or other remote protocols) because they need transactions. With cross-site replication as well, the "site master" should only deal with forwarding commands between sites and shouldn&#8217;t handle user requests, so it makes sense to configure it with a capacity factor of 0.</p> </div> </div> <div class="sect4"> <h5 id="hashing_configuration"><a class="anchor" href="#hashing_configuration"></a>Hashing Configuration</h5> <div class="paragraph"> <p>This is how you configure hashing declaratively, via XML:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml">   <span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">distributedCache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">owners</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">segments</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">capacity-factor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>And this is how you can configure it programmatically, in Java:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder()
   .clustering()
      .cacheMode(CacheMode.DIST_SYNC)
      .hash()
         .numOwners(<span class="integer">2</span>)
         .numSegments(<span class="integer">100</span>)
         .capacityFactor(<span class="integer">2</span>)
   .build();</code></pre> </div> </div> </div> </div> <div class="sect3"> <h4 id="initial_cluster_size"><a class="anchor" href="#initial_cluster_size"></a>11.4.3. Initial cluster size</h4> <div class="paragraph"> <p>Infinispan&#8217;s very dynamic nature in handling toplogy changes (i.e. nodes being added / removed at runtime) means that, normally, a node doesn&#8217;t wait for the presence of other nodes before starting. While this is very flexible, it might not be suitable for applications which require a specific number of nodes to join the cluster before caches are started. For this reason, you can specify how many nodes should have joined the cluster before proceeding with cache initialization. To do this, use the <em>initialClusterSize</em> and <em>initialClusterTimeout</em> transport properties. The declarative XML configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml">   <span class="tag">&lt;transport</span> <span class="attribute-name">initial-cluster-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">initial-cluster-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">30000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The programmatic Java configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration global = <span class="keyword">new</span> GlobalConfigurationBuilder()
   .transport()
       .initialClusterSize(<span class="integer">4</span>)
       .initialClusterTimeout(<span class="integer">30000</span>)
   .build();</code></pre> </div> </div> <div class="paragraph"> <p>The above configuration will wait for <em>4</em> nodes to join the cluster before initialization. If the initial nodes do not appear within the specified timeout, the cache manager will fail to start.</p> </div> </div> <div class="sect3"> <h4 id="l1_caching"><a class="anchor" href="#l1_caching"></a>11.4.4. L1 Caching</h4> <div class="paragraph"> <p>To prevent repeated remote calls when doing multiple GETs, L1 caching can be enabled. L1 caching places remotely received values in a near cache for a short period of time (configurable) so repeated lookups would not result in remote calls. In the above diagram, if L1 was enabled, a subsequent GET for the same key on Server3 would not result in any remote calls.</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/Figure4_4.png" alt="Figure4 4"> </div> <div class="title">Figure 4. L1 caching</div> </div> <div class="paragraph"> <p>L1 caching is not free though. Enabling it comes at a cost, and this cost is that every time a key is updated, an invalidation message needs to be multicast to ensure nodes with the entry in L1 invalidates the entry. L1 caching causes the requesting node to cache the retrieved entry locally and listen for changes to the key on the wire. L1-cached entries are given an internal expiry to control memory usage. Enabling L1 will improve performance for repeated reads of non-local keys, but will increase memory consumption to some degree. It offers a nice tradeoff between the "read-mostly" performance of an invalidated data grid with the scalability of a distributed one. Is L1 caching right for you? The correct approach is to benchmark your application with and without L1 enabled and see what works best for your access pattern.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> Looking for Buddy Replication?Â  Buddy Replication - from JBoss Cache - does not exist in Infinispan.Â  See this blog article which discusses the reasons why Buddy Replication was not implemented in Infinispan, and how the same effects can be achieved using Infinispan: <a href="http://infinispan.blogspot.com/2009/08/distribution-instead-of-buddy.html" class="bare">http://infinispan.blogspot.com/2009/08/distribution-instead-of-buddy.html</a> </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="ServerHinting"><a class="anchor" href="#ServerHinting"></a>11.4.5. Server Hinting</h4> <div class="paragraph"> <p>The motivations behind this feature is to ensure when using distribution, backups are not picked to reside on the same physical server, rack or data centre. For obvious reasons it doesn&#8217;t work with total replication.</p> </div> <div class="sect4"> <h5 id="configuration_8"><a class="anchor" href="#configuration_8"></a>Configuration</h5> <div class="paragraph"> <p>The hints are configured at transport level:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;transport</span>
    <span class="attribute-name">cluster</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">MyCluster</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">machine</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">LinuxServer01</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">rack</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">Rack01</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">site</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">US-WestCoast</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The following topology hints can be specified:</p> </div> <div class="dlist"> <dl> <dt class="hdlist1">machine</dt> <dd> <p>This is probably the most useful, to disambiguate between multiple JVM instances on the same node, or even multiple virtual hosts on the same physical host.</p> </dd> <dt class="hdlist1">rack</dt> <dd> <p>In larger clusters with nodes occupying more than a single rack, this setting would help prevent backups being stored on the same rack.</p> </dd> <dt class="hdlist1">site</dt> <dd> <p>To differentiate between nodes in different data centres replicating to each other.Â Note that <a href="#CrossSiteReplication">Cross site replication</a> is another alternative for clusters that need to span two or more data centres.</p> </dd> </dl> </div> <div class="paragraph"> <p>All of the above are optional, and if not provided, the distribution algorithms provide no guarantees that backups will not be stored in instances on the same machine/rack/site.</p> </div> </div> </div> <div class="sect3"> <h4 id="KeyAffinityService"><a class="anchor" href="#KeyAffinityService"></a>11.4.6. Key affinity service</h4> <div class="paragraph"> <p>The key affinity service solves the following problem: for a distributed Infinispan cluster one wants to make sure that a value is placed in a certain node. Based on a supplied cluster <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/remoting/transport/Address.html">address</a> identifying the node, the service returns a key that will be hashed to that particular node.</p> </div> <div class="sect4"> <h5 id="api_3"><a class="anchor" href="#api_3"></a>API</h5> <div class="paragraph"> <p>Following code snippet depicts how a reference to this service can be obtained and used.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// 1. Obtain a reference to a cache manager</span>
EmbeddedCacheManager cacheManager = getCacheManager();<span class="comment">//obtain a reference to a cache manager</span>
Cache cache = cacheManager.getCache();
<span class="error">Â </span>
<span class="comment">// 2. Create the affinity service</span>
KeyAffinityService keyAffinityService = KeyAffinityServiceFactory.newLocalKeyAffinityService(
      cache,
      <span class="keyword">new</span> RndKeyGenerator(),
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="predefined-type">Executors</span>.newSingleThreadExecutor(),
      <span class="integer">100</span>);
<span class="error">Â </span>
<span class="comment">// 3. Obtain a key to be mapped to a certain address</span>
<span class="predefined-type">Object</span> localKey = keyAffinityService.getKeyForAddress(cacheManager.getAddress());
<span class="error">Â </span>
<span class="comment">// 4. This put makes sure that the key resigns on the local node (as obtained cacheManager.getAddress())</span>
cache.put(localKey, <span class="string"><span class="delimiter">&quot;</span><span class="content">yourValue</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>The service is started at step 2: after this point it uses the supplied <em>Executor</em> to generate and queue keys. At step 3, we obtain a key for this service, and use it at step 4, with that guarantee that it is distributed on the node identified by <code>cacheManager.getAddress()</code>.</p> </div> </div> <div class="sect4"> <h5 id="lifecycle"><a class="anchor" href="#lifecycle"></a>Lifecycle</h5> <div class="paragraph"> <p><em>KeyAffinityService</em> extends <em>Lifecycle</em>, which allows stopping and (re)starting it:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Lifecycle</span> {
<span class="error">Â </span><span class="error">Â </span> <span class="type">void</span> start();
<span class="error">Â </span><span class="error">Â </span> <span class="type">void</span> stop();
}</code></pre> </div> </div> <div class="paragraph"> <p>The service is instantiated through <em>KeyAffinityServiceFactory</em>. All the factory methods have an <em>Executor</em> parameter, that is used for asynchronous key generation (so that it won&#8217;t happen in the caller&#8217;s thread). It is the user&#8217;s responsibility to handle the shutdown of this <em>Executor</em>.</p> </div> <div class="paragraph"> <p>The <em>KeyAffinityService</em>, once started, needs to be explicitly stopped. This stops the background key generation and releases other held resources.</p> </div> <div class="paragraph"> <p>The only situation in which <em>KeyAffinityService</em> stops by itself is when the cache manager with which it was registered is shutdown.</p> </div> </div> <div class="sect4"> <h5 id="topology_changes"><a class="anchor" href="#topology_changes"></a>Topology changes</h5> <div class="paragraph"> <p>When a topology change takes place the key ownership from the <em>KeyAffinityService</em> might change. The key affinity service keep tracks of these topology changes and updates and doesn&#8217;t return stale keys, i.e. keys that would currently map to a different node than the one specified. However, this does not guarantee that at the time the key is used its node affinity hasn&#8217;t changed, e.g.:</p> </div> <div class="ulist"> <ul> <li> <p>Thread <code>T1</code> reads a key <code>k1</code> that maps to node <code>A</code>.</p> </li> <li> <p>A topology change happens which makes <code>k1</code> map to node <code>B</code>.</p> </li> <li> <p><code>T1</code> uses <code>k1</code> to add something to the cache. At this point <code>k1</code> maps to <code>B</code>, a different node than the one requested at the time of read.</p> </li> </ul> </div> <div class="paragraph"> <p>Whilst this is not ideal, it should be a supported behaviour for the application as all the already in-use keys might be moved over during cluster change. The <em>KeyAffinityService</em> provides an access proximity optimisation for stable clusters which doesn&#8217;t apply during the instability of topology changes.</p> </div> </div> </div> <div class="sect3"> <h4 id="the_grouping_api"><a class="anchor" href="#the_grouping_api"></a>11.4.7. The Grouping API</h4> <div class="paragraph"> <p>Complementary to <a href="#KeyAffinityService">Key affinity service</a> and similar to <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/atomic/AtomicMap.html">AtomicMap</a>, the grouping API allows you to co-locate a group of entries on the same nodes, but without being able to select the actual nodes.</p> </div> <div class="sect4"> <h5 id="how_does_it_work_2"><a class="anchor" href="#how_does_it_work_2"></a>How does it work?</h5> <div class="paragraph"> <p>Normally, when you store an entry, Infinispan will take a hash code of the key, map the hash to a hash segment, and store the entry on the nodes which own that segment. Infinispan always uses an algorithm to locate a key, never allowing the nodes on which the entry is stored to be specified manually. This scheme allows any node to know which nodes owns a key, without having to distribute such ownership information. This reduces the overhead of Infinispan, but more importantly improves redundancy as there is no need to replicate the ownership information in case of node failure.</p> </div> <div class="paragraph"> <p>If you use the grouping API, then Infinispan will ignore the hash of the key when deciding which <em>node</em> to store the entry on, and instead use a hash of the group. Infinispan still uses the hash of the key in its internal data structures, so using the grouping API will not slow things down. When the group API is in use, it is important that every node can still compute, using an algorithm, the owners of every key. For this reason, the group cannot be specified manually. The group can either be intrinsic to the entry (generated by the key class) or extrinsic (generated by an external function).</p> </div> </div> <div class="sect4"> <h5 id="how_do_i_use_the_grouping_api"><a class="anchor" href="#how_do_i_use_the_grouping_api"></a>How do I use the grouping API?</h5> <div class="paragraph"> <p>First, you must enable groups. If you are configuring Infinispan programmatically, then call:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder()
   .clustering().hash().groups().enabled()
   .build();</code></pre> </div> </div> <div class="paragraph"> <p>Or, if you are using XML:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache&gt;</span>
Â  Â <span class="tag">&lt;groups</span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>If you have control of the key class (you can alter the class definition, it&#8217;s not part of an unmodifiable library), and the determination of the group is not an orthogonal concern to the key class, then we recommend you use an intrinsic group. The intrinsic group can be specified using the <em>@Group</em> annotation placed on the method. Let&#8217;s take a look at an example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">User</span> {
<span class="error">Â </span><span class="error">Â </span> ...
<span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">String</span> office;
<span class="error">Â </span><span class="error">Â </span> ...

<span class="error">Â </span><span class="error">Â </span> <span class="directive">public</span> <span class="type">int</span> hashCode() {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// Defines the hash for the key, normally used to determine location</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> ...
<span class="error">Â </span><span class="error">Â </span> }

<span class="error">Â </span><span class="error">Â </span> <span class="comment">// Override the location by specifying a group, all keys in the same</span>
<span class="error">Â </span><span class="error">Â </span> <span class="comment">// group end up with the same owner</span>
<span class="error">Â </span><span class="error">Â </span> <span class="annotation">@Group</span>
<span class="error">Â </span><span class="error">Â </span> <span class="directive">public</span> <span class="predefined-type">String</span> getOffice() {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">return</span> office;
<span class="error">Â </span><span class="error">Â </span> }
<span class="error">Â </span><span class="error">Â </span> }
}</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> The group must be a <code>String</code> </td> </tr> </table> </div> <div class="paragraph"> <p>If you don&#8217;t have control over the key class, or the determination of the group is an orthogonal concern to the key class, we recommend you use an extrinsic group. An extrinsic group is specified by implementing the <em>Grouper</em> interface, which has a single method computeGroup, which should return the group. <em>Grouper</em> acts as an interceptor, passing the previously computed value in. The group passed to the first <em>Grouper</em> will be that determined by <em>@Group</em> (if <em>@Group</em> is defined). This allows you even greater control over the group when using an intrinsic group. For a grouper to be used when determining the group for a key, its <em>keyType</em> must be assignable from the key being grouped.</p> </div> <div class="paragraph"> <p>Let&#8217;s take a look at an example of a <em>Grouper</em>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">KXGrouper</span> <span class="directive">implements</span> Grouper&lt;<span class="predefined-type">String</span>&gt; {

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="comment">// A pattern that can extract from a &quot;kX&quot; (e.g. k1, k2) style key</span>
   <span class="comment">// The pattern requires a String key, of length 2, where the first character is</span>
   <span class="comment">// &quot;k&quot; and the second character is a digit. We take that digit, and perform</span>
   <span class="comment">// modular arithmetic on it to assign it to group &quot;1&quot; or group &quot;2&quot;.</span>
<span class="error">Â </span><span class="error">Â </span> <span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">Pattern</span> kPattern = <span class="predefined-type">Pattern</span>.compile(<span class="string"><span class="delimiter">&quot;</span><span class="content">(^k)(&lt;a&gt;</span><span class="char">\\</span><span class="content">d&lt;/a&gt;)$</span><span class="delimiter">&quot;</span></span>);

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">public</span> <span class="predefined-type">String</span> computeGroup(<span class="predefined-type">String</span> key, <span class="predefined-type">String</span> group) {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">Matcher</span> matcher = kPattern.matcher(key);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">if</span> (matcher.matches()) {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">String</span> g = <span class="predefined-type">Integer</span>.parseInt(matcher.group(<span class="integer">2</span>)) % <span class="integer">2</span> + <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">return</span> g;
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> } <span class="keyword">else</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">return</span> <span class="predefined-constant">null</span>;
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">public</span> <span class="predefined-type">Class</span>&lt;<span class="predefined-type">String</span>&gt; getKeyType() {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">return</span> <span class="predefined-type">String</span>.class;
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }
}</code></pre> </div> </div> <div class="paragraph"> <p>Here we determine a simple grouper that can take the key class and extract from the group from the key using a pattern. We ignore any group information specified on the key class.</p> </div> <div class="paragraph"> <p>You must register every grouper you wish to have used. If you are configuring Infinispan programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder()
   .clustering().hash().groups().enabled().addGrouper(<span class="keyword">new</span> KXGrouper())
   .build();</code></pre> </div> </div> <div class="paragraph"> <p>Or, if you are using XML:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache&gt;</span>
   <span class="tag">&lt;groups</span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;grouper</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.acme.KXGrouper</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;/groups&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre> </div> </div> </div> <div class="sect4"> <h5 id="advanced_interface"><a class="anchor" href="#advanced_interface"></a>Advanced Interface</h5> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> This interface is available since Infinispan 7.0.0. </td> </tr> </table> </div> <div class="paragraph"> <p>AdvancedCache allows to interact with the keys belonging to a group. It is possible to return the Set of keys belonging to a group and remove all the keys of the group. Below is the interface available:</p> </div> <div class="listingblock"> <div class="title">AdvancedCache.java</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * It fetches all the keys which belong to the group.
 * &lt;p/&gt;
 * Semantically, it iterates over all the keys in memory and persistence, and performs a read operation in the keys
 * found. Multiple invocations inside a transaction ensures that all the keys previous read are returned and it may
 * return newly added keys to the group from other committed transactions (also known as phantom reads).
 * &lt;p/&gt;
 * The {@code map} returned is immutable and represents the group at the time of the invocation. If you want to add
 * or remove keys from a group use {@link #put(Object, Object)} and {@link #remove(Object)}. To remove all the keys
 * in the group use {@link #removeGroup(String)}.
 * &lt;p/&gt;
 * To improve performance you may use the {@code flag} {@link org.infinispan.context.Flag#SKIP_CACHE_LOAD} to avoid
 * fetching the key/value from persistence. However, you will get an inconsistent snapshot of the group.
 *
 * @param groupName the group name.
 * @return an immutable {@link java.util.Map} with the key/value pairs.
 */</span>
<span class="predefined-type">Map</span>&lt;K, V&gt; getGroup(<span class="predefined-type">String</span> groupName);

<span class="comment">/**
 * It removes all the key which belongs to a group.
 * &lt;p/&gt;
 * Semantically, it fetches the most recent group keys/values and removes them.
 * &lt;p/&gt;
 * Note that, concurrent addition perform by other transactions/threads to the group may not be removed.
 *
 * @param groupName the group name.
 */</span>
<span class="type">void</span> removeGroup(<span class="predefined-type">String</span> groupName);</code></pre> </div> </div> </div> </div> </div> <div class="sect2"> <h3 id="asynchronous_options"><a class="anchor" href="#asynchronous_options"></a>11.5. Asynchronous Options</h3> <div class="paragraph"> <p>When Infinispan instances are clustered, regardless of the cluster mode, data can be propagated to other nodes in a synchronous or asynchronous way. When synchronous, the sender waits for replies from the receivers and when asynchronous, the sender sends the data and does not wait for replies from other nodes in the cluster.</p> </div> <div class="paragraph"> <p>With asynchronous modes, speed is more important than consistency and this is particularly advantageous in use cases such as HTTP session replication with sticky sessions enabled. In these scenarios, data, or in this case a particular session, is always accessed on the same cluster node and only in case of failure is data accessed in a different node. This type of architectures allow consistency to be relaxed in favour of increased performance.</p> </div> <div class="paragraph"> <p>In order to choose the asynchronous configuration that best suits your application, it&#8217;s important to understand the following configuration settings:</p> </div> <div class="sect3"> <h4 id="asynchronous_communications"><a class="anchor" href="#asynchronous_communications"></a>11.5.1. Asynchronous Communications</h4> <div class="paragraph"> <p>Whenever you add <a href="http://docs.jboss.org/infinispan/8.2/configdocs/infinispan-config-8.2.html"><code>&lt;replicated-cache mode="ASYNC"&gt; or &lt;distributed-cache mode="ASYNC"&gt; or &lt;invalidation-cache mode="ASYNC"&gt;</code></a> element, you&#8217;re telling the underlying JGroups layer in Infinispan to use asynchronous communication. What this means is that JGroups will send any replication/distribution/invalidation request to the wire but will not wait for a reply from the receiver.</p> </div> </div> <div class="sect3"> <h4 id="replication_queue"><a class="anchor" href="#replication_queue"></a>11.5.2. Replication Queue</h4> <div class="paragraph"> <p>The aim of the replication queue is to batch the individual cache operations and send them as one, as opposed to sending each cache operation individually. As a result, replication queue enabled configurations perform generally better compared to those that have it switched off because less RPC messages are sent, fewer envelopes are used&#8230;&#8203;etc. The only real trade off to the replication queue is that the queue is flushed periodically (based on time or queue size) and hence it might take longer for the replication/distribution/invalidation to be realised across the cluster. When replication queue is turned off, data is placed directly on the wire and hence it takes less for data to arrive to other nodes.</p> </div> </div> <div class="sect3"> <h4 id="asynchronous_api_2"><a class="anchor" href="#asynchronous_api_2"></a>11.5.3. Asynchronous API</h4> <div class="paragraph"> <p>Finally, the <a href="#_asynchronous_api">Asynchronous API</a> can be used to emulate non-blocking APIs, whereby calls are handed over to a different thread and asynchronous API calls return to the client immediately. Using this API can lead to reordering, so you should avoid calling modifying asynchronous methods on the same keys.</p> </div> </div> <div class="sect3"> <h4 id="return_values"><a class="anchor" href="#return_values"></a>11.5.4. Return Values</h4> <div class="paragraph"> <p>Regardless of the asynchronous option used, the return values of cache operations are reliable. If talking about return values of cache operations that return previous value, the correctness of these returns are guaranteed as well regardless of the clustering mode. With replication, the previous value is already available locally, and with distribution, regardless of whether it&#8217;s asynchronous or synchronous, Infinispan sends a synchronous request to get the previous value if not present locally. If on the other hand the asynchronous API is used, client code needs to get hold of the <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/commons/util/concurrent/NotifyingFuture.html">NotifiyngFuture</a> returned by the async operation in order to be able to query the previous value.</p> </div> </div> </div> <div class="sect2"> <h3 id="partition_handling"><a class="anchor" href="#partition_handling"></a>11.6. Partition handling</h3> <div class="paragraph"> <p>An Infinispan cluster is built out of a number of nodes where data is stored. In order not to lose data in the presence of node failures, Infinispan copies the same data - cache entry in Infinispan parlance - over multiple nodes. This level of data redundancy is configured through the <strong>numOwners</strong> configuration attribute and ensures that as long as fewer than <strong>numOwners</strong> nodes crash simultaneously, Infinispan has a copy of the data available.</p> </div> <div class="paragraph"> <p>However there might be catastrophic situations in which more than <strong>numOwners</strong> nodes disappear from the cluster:</p> </div> <div class="ulist"> <ul> <li> <p>split brain. Caused e.g. by a router crash, this splits the cluster in two or more partitions, or sub-clusters that operate independently. In these circumstances, multiple clients reading/writing from different partitions see different versions of the same cache entry, which for many application is problematic. Note there are ways to alleviate the possibility for the split brain to happen, such as redundant networks or <a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Deployment_Guide/s2-networkscripts-interfaces-chan.html">IP bonding</a>. These only reduce the window of time for the problem to occur, though.</p> </li> <li> <p><strong>numOwners</strong> nodes crash in sequence. When at least <strong>numOwners</strong> nodes crash in rapid sequence and Infinispan does not have the time to properly rebalance its state between crashes, the result is partial data lost.</p> </li> </ul> </div> <div class="paragraph"> <p>The partition handling functionality discussed in this section allows the user to be informed when data has been lost, temporarily or permanently, and wait for the cluster to heal. The goal is to avoid situations in which wrong data is returned to the user as a result of either split brain or multiple nodes crashing in rapid sequence. In terms of Brewer&#8217;s <a href="http://en.wikipedia.org/wiki/CAP_theorem">CAP theorem</a> , enabling partition handling in Infinispan preserves data consistency but sacrifices availability in the presence of partitions.</p> </div> <div class="paragraph"> <p>Enabling partition handling is critical for applications that have high consistency requirements: when the data read from the system must be accurate. On the other hand, if Infinispan is used as a best-effort cache, partitions are perfectly tolerable.</p> </div> <div class="paragraph"> <p>The following sections describe the way Infinispan handles <a href="#split-brain">split brain</a> and <a href="#successive-node-failures">successive failures</a> when partition handling is enabled, followed by a section on <a href="#partition-handling-configuration">configuring the partition handling functionality</a>.</p> </div> <div class="sect3"> <h4 id="split-brain"><a class="anchor" href="#split-brain"></a>11.6.1. Split brain</h4> <div class="paragraph"> <p>In a split brain situation, each network partition will install its own JGroups view, removing the nodes from the other partition(s). We don&#8217;t have a direct way of determining whether the has been split into two or more partitions, since the partitions are unaware of each other. Instead, we assume the cluster has split when one or more nodes disappear from the JGroups cluster without sending an explicit leave message.</p> </div> <div class="paragraph"> <p>With partition handling disabled, each such partition would continue to function as an independent cluster. Each partition may only see a part of the data, and each partition could write conflicting updates in the cache.</p> </div> <div class="paragraph"> <p>With partition handling enabled, if we detect a split, each partition does not start a rebalance immediately, but first it checks whether it should enter degraded mode instead:</p> </div> <div class="ulist"> <ul> <li> <p>If at least one segment has lost all its owners (meaning at least <em>numOwners</em> nodes left since the last rebalance ended), the partition enters degraded mode.</p> </li> <li> <p>If the partition does not contain a simple majority of the nodes (floor(numNodes/2) + 1) in the <em>latest stable topology</em>, the partition also enters degraded mode.</p> </li> <li> <p>Otherwise the partition keeps functioning normally, and it starts a rebalance.</p> </li> </ul> </div> <div class="paragraph"> <p>The <em>stable topology</em> is updated every time a rebalance operation ends and the coordinator determines that another rebalance is not necessary.</p> </div> <div class="paragraph"> <p>These rules ensures that at most one partition stays in available mode, and the other partitions enter degraded mode.</p> </div> <div class="paragraph"> <p>When a partition is in degraded mode, it only allows access to the keys that are wholly owned:</p> </div> <div class="ulist"> <ul> <li> <p>Requests (reads and writes) for entries that have all the copies on nodes within this partition are honoured.</p> </li> <li> <p>Requests for entries that are partially or totally owned by nodes that disappeared are rejected with an <code>AvailabilityException</code>.</p> </li> </ul> </div> <div class="paragraph"> <p>This guarantees that partitions cannot write different values for the same key (cache is consistent), and also that one partition can not read keys that have been updated in the other partitions (no stale data).</p> </div> <div class="paragraph"> <p>To exemplify, consider the initial cluster <code>M = {A, B, C, D}</code>, configured in distributed mode with <code>numOwners = 2</code>. Further on, consider three keys <code>k1</code>, <code>k2</code> and <code>k3</code> (that might exist in the cache or not) such that <code>owners(k1) = {A,B}</code>, <code>owners(k2) = {B,C}</code> and <code>owners(k3) = {C,D}</code>. Then the network splits in two partitions, <code>N1 = {A, B}</code> and <code>N2 = {C, D}</code>, they enter degraded mode and behave like this:</p> </div> <div class="ulist"> <ul> <li> <p>on <code>N1</code>, <code>k1</code> is available for read/write, <code>k2</code> (partially owned) and <code>k3</code> (not owned) are not available and accessing them results in an <code>AvailabilityException</code></p> </li> <li> <p>on <code>N2</code>, <code>k1</code> and <code>k2</code> are not available for read/write, <code>k3</code> is available</p> </li> </ul> </div> <div class="paragraph"> <p>A relevant aspect of the partition handling process is the fact that when a split brain happens, the resulting partitions rely on the original consistent hash function (the one that existed before the split brain) in order to calculate key ownership. So it doesn&#8217;t matter if <code>k1</code>, <code>k2</code>, or <code>k3</code> already existed cache or not, their availability is the same.</p> </div> <div class="paragraph"> <p>If at a further point in time the network heals and <code>N1</code> and <code>N2</code> partitions merge back together into the initial cluster <code>M</code>, then <code>M</code> exits the degraded mode and becomes fully available again.</p> </div> <div class="paragraph"> <p>As another example, the cluster could split in two partitions <code>O1 = {A, B, C}</code> and <code>O2 = {D}</code>, partition <code>O1</code> will stay fully available (rebalancing cache entries on the remaining members). Partition <code>O2</code>, however, will detect a split and enter the degraded mode. Since it doesn&#8217;t have any fully owned keys, it will reject any read or write operation with an <code>AvailabilityException</code>.</p> </div> <div class="paragraph"> <p>If afterwards partitions <code>O1</code> and <code>O2</code> merge back into <code>M</code>, then the cache entries on <code>D</code> will be wiped (since they could be stale). <code>D</code> will be fully available, but it will not hold any data until the cache is rebalanced.</p> </div> <div class="sect4"> <h5 id="current_limitations_2"><a class="anchor" href="#current_limitations_2"></a>Current limitations</h5> <div class="paragraph"> <p>Two partitions could start up isolated, and as long as they don&#8217;t merge they can read and write inconsistent data. In the future, we will allow custom availability strategies (e.g. check that a certain node is part of the cluster, or check that an external machine is accessible) that could handle that situation as well.</p> </div> </div> </div> <div class="sect3"> <h4 id="successive-node-failures"><a class="anchor" href="#successive-node-failures"></a>11.6.2. Successive nodes stopped</h4> <div class="paragraph"> <p>As mentioned in the previous section, Infinispan can&#8217;t detect whether a node left the JGroups view because of a process/machine crash, or because of a network failure: whenever a node leaves the JGroups cluster abruptly, it is assumed to be because of a network problem.</p> </div> <div class="paragraph"> <p>If the configured number of copies (<em>numOwners</em>) is greater than 1, the cluster can remain available and will try to make new replicas of the data on the crashed node. However, other nodes might crash during the rebalance process. If more than <em>numOwners</em> nodes crash in a short interval of time, there is a chance that some cache entries have disappeared from the cluster altogether. In this case, with partition handling functionality enabled, Infinispan assumes (incorrectly) that there is a split brain and enters degraded mode as described in the split-brain section.</p> </div> <div class="paragraph"> <p>The administrator can also shut down more than <strong>numOwners</strong> nodes in rapid succession, causing the loss of the data stored only on those nodes. When the administrator shuts down a node gracefully, Infinispan knows that the node can&#8217;t come back. However, the cluster doesn&#8217;t keep track of how each node left, and the cache still enters <em>degraded</em> mode as if those nodes had crashed.</p> </div> <div class="paragraph"> <p>At this stage there is no way for the cluster to recover its state, except stopping it and repopulating it on restart with the data from an external source. Clusters are expected to be configured with an appropriate <strong>numOwners</strong> in order to avoid <strong>numOwners</strong> successive node failures, so this situation should be pretty rare. If the application can handle losing some of the data in the cache, the administrator can force the availability mode back to AVAILABLE <a href="#partition-handling-monitoring">via JMX</a>.</p> </div> </div> <div class="sect3"> <h4 id="partition-handling-configuration"><a class="anchor" href="#partition-handling-configuration"></a>11.6.3. Configuration for partition handling functionality</h4> <div class="paragraph"> <p>At this stage the partition handling is disabled by default. We will revisit this decision in the future, based on user feedback. In order to enable partition handling within the XML configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">the-default-cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;partition-handling</span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Unless the cache is distributed or replicated, the configuration is ignored.</p> </div> <div class="paragraph"> <p>The same can be achieved programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder dcc = <span class="keyword">new</span> ConfigurationBuilder();
dcc.clustering().partitionHandling().enabled(<span class="predefined-constant">true</span>);</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="partition-handling-monitoring"><a class="anchor" href="#partition-handling-monitoring"></a>11.6.4. Monitoring and administration</h4> <div class="paragraph"> <p>The availability mode of a cache is exposed in JMX as an attribute in the <a href="http://docs.jboss.org/infinispan/7.0/apidocs/jmxComponents.html#Cache">Cache MBean</a>. The attribute is writable, allowing an administrator to forcefully migrate a cache from degraded state back to available (at the cost of consistency).</p> </div> <div class="paragraph"> <p>The availability mode is also accessible via the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/AdvancedCache.html">AdvancedCache</a> interface:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">AdvancedCache ac = cache.getAdvancedCache();

<span class="comment">// Read the availability</span>
<span class="type">boolean</span> available = ac.getAvailability() == AvailabilityMode.AVAILABLE;

<span class="comment">// Change the availability</span>
<span class="keyword">if</span> (!available) {
   ac.setAvailability(AvailabilityMode.AVAILABLE);
}</code></pre> </div> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="local_mode_cache"><a class="anchor" href="#local_mode_cache"></a>12. Local mode cache</h2> <div class="sectionbody"> <div class="paragraph"> <p>Even though Infinispan&#8217;s biggest potential is as distributed, in-memory data grid platform, one aspect of it often gets overlooked - it can be used as a standalone cache node. But why would anyone use Infinispan over, say, a <a href="http://docs.oracle.com/javase/6/docs/api/java/util/concurrent/ConcurrentHashMap.html">ConcurrentHashMap</a> ? Here are some reasons:</p> </div> <div class="ulist"> <div class="title">Why a Cache is better than a Map</div> <ul> <li> <p><em>Eviction.</em> Built-in eviction ensures you don&#8217;t run out of memory.</p> </li> <li> <p><em>Write-through and write-behind caching.</em> Going beyond memory and onto disk (or any other pluggable <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/persistence/spi/ExternalStore.html">ExternalStore</a> ) means that your state survives restarts, and preloaded hot caches can be configured.</p> </li> <li> <p><em>JTA support and XA compliance.</em> Participate in ongoing transactions with any <a href="http://java.sun.com/javaee/technologies/jta/index.jsp">JTA</a> -compliant transaction manager.</p> </li> <li> <p><em>MVCC-based concurrency.</em> Highly optimized for fast, non-blocking readers.</p> </li> <li> <p><em>Manageability.</em> <a href="http://docs.jboss.org/infinispan/8.2/apidocs/jmxComponents.html">Simple JMX</a> or rich GUI management console via <a href="http://community.jboss.org/docs/DOC-13721">JOPR</a> , you have a choice.</p> </li> <li> <p><em>Not just for the JVM.</em> <a href="#_server_modules">server modules</a> speaking REST, Memcached and Hot Rod protocols help non-JVM platforms use Infinispan.</p> </li> <li> <p><em>Cluster-ready.</em> Should the need arise.</p> </li> </ul> </div> <div class="paragraph"> <p>So how do you get started with Infinispan in local mode? The simplest configuration file containing just</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan</span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>is enough to get you started, or you can create DefaultCacheManager with <em>no-argument</em> constructor. Either approach creates local default cache.</p> </div> <div class="paragraph"> <p>All the features above are exposed via an easy-to-use <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/Cache.html">Cache</a> interface, which extends <a href="http://docs.oracle.com/javase/6/docs/api/java/util/concurrent/ConcurrentMap.html">ConcurrentMap</a> and is compatible with many other cache systems. Infinispan even ships with <a href="#_configuration_migration_tools">migration tools</a> to help you move off other cache solutions onto Infinispan, whether you need a cache to store data retrieved remotely or simply as a <a href="#_using_infinispan_as_jpa_hibernate_second_level_cache_provider">2nd level cache for Hibernate</a>.</p> </div> <div class="sect2"> <h3 id="performance"><a class="anchor" href="#performance"></a>12.1. Performance</h3> <div class="paragraph"> <p>In the process of testing and tuning Infinispan on very large clusters, we have started to put together a benchmarking framework called <a href="https://github.com/radargun/radargun">RadarGun</a>. Thanks to RadarGun, we have the ability to measure cache performance in standalone, local mode. We compared Infinispan 4.0 in local mode against the latest JBoss Cache release (3.2.2.GA) and EHCache (1.7.2). Some background on the tests:</p> </div> <div class="ulist"> <ul> <li> <p>Used a latest snapshot of RadarGun</p> </li> <li> <p>Run on an <a href="http://www.redhat.com/rhel/">RHEL</a> 5 server with 4 Intel Xeon cores, 4GB of RAM</p> </li> <li> <p>Sun JDK 1.6.0_18, with <code>-Xms1g -Xmx1g</code></p> </li> <li> <p>Test run on a single node, with 25 concurrent threads, using randomly generated Strings as keys and values and a 1kb payload for each entry, with a 80/20 read/write ratio.</p> </li> <li> <p>Performance measured in transactions per second (higher = better).</p> </li> </ul> </div> <div class="imageblock"> <div class="content"> <img src="./images/local_gets_all_included.png" alt="local gets all included"> </div> </div> <div class="imageblock"> <div class="content"> <img src="./images/local_puts_all_included.png" alt="local puts all included"> </div> </div> <div class="paragraph"> <p>In summary, what we have here is that when run in local mode, Infinispan is a high-performance standalone caching engine which offers a rich set of features while still being trivially simple to configure and use.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> These tests were run in 2010. An updated benchmark is expected soon. </td> </tr> </table> </div> </div> </div> </div> <div class="sect1"> <h2 id="marshalling"><a class="anchor" href="#marshalling"></a>13. Marshalling</h2> <div class="sectionbody"> <div class="paragraph"> <p>Marshalling is the process of converting Java POJOs into something that can be written in a format that can be transferred over the wire. Unmarshalling is the reverse process whereby data read from a wire format is transformed back into Java POJOs. Infinispan uses marshalling/unmarshalling in order to:</p> </div> <div class="ulist"> <ul> <li> <p>Transform data so that it can be send over to other Infinispan nodes in a cluster.</p> </li> <li> <p>Transform data so that it can be stored in underlying cache stores.</p> </li> <li> <p>Store data in Infinispan in a wire format to provide lazy deserialization capabilities.</p> </li> </ul> </div> <div class="sect2"> <h3 id="the_role_of_jboss_marshalling"><a class="anchor" href="#the_role_of_jboss_marshalling"></a>13.1. The Role Of JBoss Marshalling</h3> <div class="paragraph"> <p>Since performance is a very important factor in this process, Infinispan uses JBoss Marshalling framework instead of standard Java Serialization in order to marshall/unmarshall Java POJOs. Amongst other things, this framework enables Infinispan to provide highly efficient ways to marshall internal Infinispan Java POJOs that are constantly used. Apart from providing more efficient ways to marshall Java POJOs, including internal Java classes, JBoss Marshalling uses highly performant <code>java.io.ObjectOutput</code> and <code>java.io.ObjectInput</code> implementations compared to standard <code>java.io.ObjectOutputStream</code> and <code>java.io.ObjectInputStream</code>.</p> </div> </div> <div class="sect2"> <h3 id="support_for_non_serializable_objects"><a class="anchor" href="#support_for_non_serializable_objects"></a>13.2. Support For Non-Serializable Objects</h3> <div class="paragraph"> <p>From a users perspective, a very common concern is whether Infinispan supports storing non-Serializable objects. In 4.0, an Infinispan cache instance can only store non-Serializable key or value objects if, and only if:</p> </div> <div class="ulist"> <ul> <li> <p>cache is configured to be a local cache <em>and&#8230;&#8203;</em></p> </li> <li> <p>cache is not configured with lazy serialization <em>and&#8230;&#8203;</em></p> </li> <li> <p>cache is not configured with any write-behind cache store</p> </li> </ul> </div> <div class="paragraph"> <p>If either of these options is true, key/value pairs in the cache will need to be marshalled and currently they require to either to extend <code>java.io.Serializable</code> or <code>java.io.Externalizable</code>.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> Since Infinispan 5.0, marshalling non-Serializable key/value objects is supported as long as users can to provide meaningful Externalizer implementations for these non-Seralizable objects. <a href="#_plugging_infinispan_with_user_defined_externalizers">This section</a> has more details. </td> </tr> </table> </div> <div class="paragraph"> <p>If you&#8217;re unable to retrofit Serializable or Externalizable into the classes whose instances are stored in Infinispan, you could alternatively use something like <a href="http://x-stream.github.io/">XStream</a> to convert your Non-Serializable objects into a String that can be stored into Infinispan. You can find an example on how to use XStream <a href="http://anonsvn.jboss.org/repos/infinispan/trunk/core/src/test/java/org/infinispan/marshall/TestObjectStreamMarshaller.java">here</a> . The one caveat about using XStream is that it slows down the process of storing key/value objects due to the XML transformation that it needs to do.</p> </div> <div class="sect3"> <h4 id="store_as_binary"><a class="anchor" href="#store_as_binary"></a>13.2.1. Store As Binary</h4> <div class="paragraph"> <p>Store as binary enables data to be stored in its serialized form. This can be useful to achieve lazy deserialization, which is the mechanism by which Infinispan by which serialization and deserialization of objects is deferred till the point in time in which they are used and needed. This typically means that any deserialization happens using the thread context class loader of the invocation that requires deserialization, and is an effective mechanism to provide classloader isolation. By default lazy deserialization is disabled but if you want to enable it, you can do it like this:</p> </div> <div class="ulist"> <ul> <li> <p>Via XML at the Cache level, either under <code>&lt;*-cache /&gt;</code> element:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;store-as-binary</span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="ulist"> <ul> <li> <p>Programmatically:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = ...
builder.storeAsBinary().enable();</code></pre> </div> </div> <div class="sect4"> <h5 id="equality_considerations"><a class="anchor" href="#equality_considerations"></a>Equality Considerations</h5> <div class="paragraph"> <p>When using lazy deserialization/storing as binary, keys and values are wrapped as <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/marshall/core/MarshalledValue">MarshalledValue</a>s. It is this wrapper class that transparently takes care of serialization and deserialization on demand, and internally may have a reference to the object itself being wrapped, or the serialized, byte array representation of this object.</p> </div> <div class="paragraph"> <p>This has a particular effect on the behavior of equality. The equals() method of this class will either compare binary representations (byte arrays) or delegate to the wrapped object instance&#8217;s equals() method, depending on whether both instances being compared are in serialized or deserialized form at the time of comparison. If one of the instances being compared is in one form and the other in another form, then one instance is either serialized or deserialized. The preference will be to compare object representations, unless the cache is <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/Cache.html#compact()">compacted</a>, in which case byte array comparison is favored.</p> </div> <div class="paragraph"> <p>This will affect the way keys stored in the cache will work, when <code>storeAsBinary</code> is used, since comparisons happen on the key which will be wrapped by a MarshalledValue.Â Implementers of equals() methods on their keys need to be aware of the behavior of equality comparison, when a key is wrapped as a MarshalledValue, as detailed above.</p> </div> </div> <div class="sect4"> <h5 id="store_by_value_via_defensive_copying"><a class="anchor" href="#store_by_value_via_defensive_copying"></a>Store-by-value via defensive copying</h5> <div class="paragraph"> <p>The configuration <code>storeAsBinary</code> offers the possibility to enable defensive copying, which allows for store-by-value like behaviour.</p> </div> <div class="paragraph"> <p>Infinispan marshalls objects the moment they&#8217;re stored, hence changes made to object references are not stored in the cache, not even for local caches. This provides store-by-value like behaviour. Enabling <code>storeAsBinary</code> can be achieved:</p> </div> <div class="ulist"> <ul> <li> <p>Via XML at the Cache level, either under <code>&lt;*-cache /&gt;</code> or <code>&lt;default /&gt;</code> elements:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;store-as-binary</span> <span class="attribute-name">keys</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">values</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="ulist"> <ul> <li> <p>Programmatically:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = ...
builder.storeAsBinary().enable().storeKeysAsBinary(<span class="predefined-constant">true</span>).storeValuesAsBinary(<span class="predefined-constant">true</span>);</code></pre> </div> </div> </div> </div> </div> <div class="sect2"> <h3 id="advanced_configuration"><a class="anchor" href="#advanced_configuration"></a>13.3. Advanced Configuration</h3> <div class="paragraph"> <p>Internally, Infinispan uses an implementation of <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/marshall/Marshaller.html">this Marshaller interface</a> in order to marshall/unmarshall Java objects so that they&#8217;re sent other nodes in the grid, or so that they&#8217;re stored in a cache store, or even so to transform them into byte arrays for lazy deserialization.</p> </div> <div class="paragraph"> <p>By default, Infinispan uses the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/marshall/VersionAwareMarshaller.html">VersionAwareMarshaller</a> which, as the name suggests, adds a version short to the start of any stream when writing, enabling similar VersionAwareMarshaller instances to read the version short and know which specific marshaller implementation to delegate the call to. Using a VersionAwareMarshaller helps achieve wire protocol compatibility between minor releases but still affords us the flexibility to tweak and improve the wire protocol between minor or micro releases. Optionally, Infinispan users to optionally provide their own marshaller, for example:</p> </div> <div class="ulist"> <ul> <li> <p>Via XML at the CacheManager level, under <code>&lt;cache-manager /&gt;</code> element:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;serialization</span> <span class="attribute-name">marshaller</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.acme.MyMarshaller</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="ulist"> <ul> <li> <p>Programmatically:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder builder = ...
builder.serialization().marshaller(myMarshaller); <span class="comment">// needs an instance of the marshaller</span></code></pre> </div> </div> <div class="sect3"> <h4 id="troubleshooting"><a class="anchor" href="#troubleshooting"></a>13.3.1. Troubleshooting</h4> <div class="paragraph"> <p>Sometimes it might happen that the Infinispan marshalling layer, and in particular JBoss Marshalling, might have issues marshalling/unmarshalling some user object. In Infinispan 4.0, marshalling exceptions will contain further information on the objects that were being marshalled. Example:</p> </div> <div class="listingblock"> <div class="content"> <pre>java.io.NotSerializableException: java.lang.Object
at org.jboss.marshalling.river.RiverMarshaller.doWriteObject(RiverMarshaller.java:857)
at org.jboss.marshalling.AbstractMarshaller.writeObject(AbstractMarshaller.java:407)
at org.infinispan.marshall.exts.ReplicableCommandExternalizer.writeObject(ReplicableCommandExternalizer.java:54)
at org.infinispan.marshall.jboss.ConstantObjectTable$ExternalizerAdapter.writeObject(ConstantObjectTable.java:267)
at org.jboss.marshalling.river.RiverMarshaller.doWriteObject(RiverMarshaller.java:143)
at org.jboss.marshalling.AbstractMarshaller.writeObject(AbstractMarshaller.java:407)
at org.infinispan.marshall.jboss.JBossMarshaller.objectToObjectStream(JBossMarshaller.java:167)
at org.infinispan.marshall.VersionAwareMarshaller.objectToBuffer(VersionAwareMarshaller.java:92)
at org.infinispan.marshall.VersionAwareMarshaller.objectToByteBuffer(VersionAwareMarshaller.java:170)
at org.infinispan.marshall.VersionAwareMarshallerTest.testNestedNonSerializable(VersionAwareMarshallerTest.java:415)
Caused by: an exception which occurred:
in object java.lang.Object@b40ec4
in object org.infinispan.commands.write.PutKeyValueCommand@df661da7
... Removed 22 stack frames</pre> </div> </div> <div class="paragraph"> <p>The way the "in object" messages are read is the same in which stacktraces are read. The highest "in object" being the most inner one and the lowest "in object" message being the most outer one. So, the above example indicates that a java.lang.Object instance contained in an instance of org.infinispan.commands.write.PutKeyValueCommand could not be serialized because java.lang.Object@b40ec4 is not serializable.</p> </div> <div class="paragraph"> <p>This is not all though! If you enable DEBUG or TRACE logging levels, marshalling exceptions will contain show the toString() representations of objects in the stacktrace. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre>java.io.NotSerializableException: java.lang.Object
...
Caused by: an exception which occurred:
in object java.lang.Object@b40ec4
-&gt; toString = java.lang.Object@b40ec4
in object org.infinispan.commands.write.PutKeyValueCommand@df661da7
-&gt; toString = PutKeyValueCommand{key=k, value=java.lang.Object@b40ec4, putIfAbsent=false, lifespanMillis=0, maxIdleTimeMillis=0}</pre> </div> </div> <div class="paragraph"> <p>With regards to unmarshalling exceptions, showing such level of information it&#8217;s a lot more complicated but where possible. Infinispan will provide class type information. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre>java.io.IOException: Injected failure!
at org.infinispan.marshall.VersionAwareMarshallerTest$1.readExternal(VersionAwareMarshallerTest.java:426)
at org.jboss.marshalling.river.RiverUnmarshaller.doReadNewObject(RiverUnmarshaller.java:1172)
at org.jboss.marshalling.river.RiverUnmarshaller.doReadObject(RiverUnmarshaller.java:273)
at org.jboss.marshalling.river.RiverUnmarshaller.doReadObject(RiverUnmarshaller.java:210)
at org.jboss.marshalling.AbstractUnmarshaller.readObject(AbstractUnmarshaller.java:85)
at org.infinispan.marshall.jboss.JBossMarshaller.objectFromObjectStream(JBossMarshaller.java:210)
at org.infinispan.marshall.VersionAwareMarshaller.objectFromByteBuffer(VersionAwareMarshaller.java:104)
at org.infinispan.marshall.VersionAwareMarshaller.objectFromByteBuffer(VersionAwareMarshaller.java:177)
at org.infinispan.marshall.VersionAwareMarshallerTest.testErrorUnmarshalling(VersionAwareMarshallerTest.java:431)
Caused by: an exception which occurred:
in object of type org.infinispan.marshall.VersionAwareMarshallerTest$1</pre> </div> </div> <div class="paragraph"> <p>In this example, an IOException was thrown when trying to unmarshall a instance of the inner class org.infinispan.marshall.VersionAwareMarshallerTest$1. In similar fashion to marshalling exceptions, when DEBUG or TRACE logging levels are enabled, classloader information of the class type is provided. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre>java.io.IOException: Injected failure!
...
Caused by: an exception which occurred:
in object of type org.infinispan.marshall.VersionAwareMarshallerTest$1
-&gt; classloader hierarchy:
-&gt; type classloader = sun.misc.Launcher$AppClassLoader@198dfaf
-&gt;...file:/opt/eclipse/configuration/org.eclipse.osgi/bundles/285/1/.cp/eclipse-testng.jar
-&gt;...file:/opt/eclipse/configuration/org.eclipse.osgi/bundles/285/1/.cp/lib/testng-jdk15.jar
-&gt;...file:/home/galder/jboss/infinispan/code/trunk/core/target/test-classes/
-&gt;...file:/home/galder/jboss/infinispan/code/trunk/core/target/classes/
-&gt;...file:/home/galder/.m2/repository/org/testng/testng/5.9/testng-5.9-jdk15.jar
-&gt;...file:/home/galder/.m2/repository/net/jcip/jcip-annotations/1.0/jcip-annotations-1.0.jar
-&gt;...file:/home/galder/.m2/repository/org/easymock/easymockclassextension/2.4/easymockclassextension-2.4.jar
-&gt;...file:/home/galder/.m2/repository/org/easymock/easymock/2.4/easymock-2.4.jar
-&gt;...file:/home/galder/.m2/repository/cglib/cglib-nodep/2.1_3/cglib-nodep-2.1_3.jar
-&gt;...file:/home/galder/.m2/repository/javax/xml/bind/jaxb-api/2.1/jaxb-api-2.1.jar
-&gt;...file:/home/galder/.m2/repository/javax/xml/stream/stax-api/1.0-2/stax-api-1.0-2.jar
-&gt;...file:/home/galder/.m2/repository/javax/activation/activation/1.1/activation-1.1.jar
-&gt;...file:/home/galder/.m2/repository/jgroups/jgroups/2.8.0.CR1/jgroups-2.8.0.CR1.jar
-&gt;...file:/home/galder/.m2/repository/org/jboss/javaee/jboss-transaction-api/1.0.1.GA/jboss-transaction-api-1.0.1.GA.jar
-&gt;...file:/home/galder/.m2/repository/org/jboss/marshalling/river/1.2.0.CR4-SNAPSHOT/river-1.2.0.CR4-SNAPSHOT.jar
-&gt;...file:/home/galder/.m2/repository/org/jboss/marshalling/marshalling-api/1.2.0.CR4-SNAPSHOT/marshalling-api-1.2.0.CR4-SNAPSHOT.jar
-&gt;...file:/home/galder/.m2/repository/org/jboss/jboss-common-core/2.2.14.GA/jboss-common-core-2.2.14.GA.jar
-&gt;...file:/home/galder/.m2/repository/org/jboss/logging/jboss-logging-spi/2.0.5.GA/jboss-logging-spi-2.0.5.GA.jar
-&gt;...file:/home/galder/.m2/repository/log4j/log4j/1.2.14/log4j-1.2.14.jar
-&gt;...file:/home/galder/.m2/repository/com/thoughtworks/xstream/xstream/1.2/xstream-1.2.jar
-&gt;...file:/home/galder/.m2/repository/xpp3/xpp3_min/1.1.3.4.O/xpp3_min-1.1.3.4.O.jar
-&gt;...file:/home/galder/.m2/repository/com/sun/xml/bind/jaxb-impl/2.1.3/jaxb-impl-2.1.3.jar
-&gt; parent classloader = sun.misc.Launcher$ExtClassLoader@1858610
-&gt;...file:/usr/java/jdk1.5.0_19/jre/lib/ext/localedata.jar
-&gt;...file:/usr/java/jdk1.5.0_19/jre/lib/ext/sunpkcs11.jar
-&gt;...file:/usr/java/jdk1.5.0_19/jre/lib/ext/sunjce_provider.jar
-&gt;...file:/usr/java/jdk1.5.0_19/jre/lib/ext/dnsns.jar
... Removed 22 stack frames
&lt;/code&gt;</pre> </div> </div> <div class="paragraph"> <p>Finding the root cause of marshalling/unmarshalling exceptions can sometimes be really daunting but we hope that the above improvements would help get to the bottom of those in a more quicker and efficient manner.</p> </div> </div> </div> <div class="sect2"> <h3 id="plugging_infinispan_with_user_defined_externalizers"><a class="anchor" href="#plugging_infinispan_with_user_defined_externalizers"></a>13.4. Plugging Infinispan With User Defined Externalizers</h3> <div class="paragraph"> <p>One of the key aspects of Infinispan is that it often needs to marshall/unmarshall objects in order to provide some of its functionality. For example, if it needs to store objects in a write-through or write-behind cache store, the stored objects need marshalling. If a cluster of Infinispan nodes is formed, objects shipped around need marshalling. Even if you enable lazy deserialization, objects need to be marshalled so that they can be lazily unmarshalled with the correct classloader.</p> </div> <div class="paragraph"> <p>Using standard JDK serialization is slow and produces payloads that are too big and can affect bandwidth usage. On top of that, JDK serialization does not work well with objects that are supposed to be immutable. In order to avoid these issues, Infinispan uses <a href="http://jboss.org/jbossmarshalling">JBoss Marshalling</a> for marshalling/unmarshalling objects. JBoss Marshalling is fast, produces very space efficient payloads, and on top of thatÂ  during unmarshalling, it enables users to have full control over how to construct objects, hence allowing objects to carry on being immutable.</p> </div> <div class="paragraph"> <p>Starting with 5.0, users of Infinispan can now benefit from this marshalling framework as well, and they can provide their own externalizer implementations, but before finding out how to provide externalizers, let&#8217;s look at the benefits they bring.</p> </div> <div class="sect3"> <h4 id="benefits_of_externalizers"><a class="anchor" href="#benefits_of_externalizers"></a>13.4.1. Benefits of Externalizers</h4> <div class="paragraph"> <p>The JDK provides a simple way to serialize objects which, in its simplest form, is just a matter of extending <a href="http://docs.oracle.com/javase/6/docs/api/java/io/Serializable.html">java.io.Serializable</a> , but as it&#8217;s well known, this is known to be slow and it generates payloads that are far too big. An alternative way to do serialization, still relying on JDK serialization, is for your objects to extend <a href="http://docs.oracle.com/javase/6/docs/api/java/io/Externalizable.html">java.io.Externalizable</a> . This allows for users to provide their own ways to marshall/unmarshall classes, but has some serious issues because, on top of relying on slow JDK serialization, it forces the class that you want to serialize to extend this interface, which has two side effects: The first is that you&#8217;re forced to modify the source code of the class that you want to marshall/unmarshall which you might not be able to do because you either, don&#8217;t own the source, or you don&#8217;t even have it. Secondly, since Externalizable implementations do not control object creation, you&#8217;re forced to add set methods in order to restore the state, hence potentially forcing your immutable objects to become mutable.</p> </div> <div class="paragraph"> <p>Instead of relying on JDK serialization, Infinispan uses JBoss Marshalling to serialize objects and requires any classes to be serialized to be associated with an <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/commons/marshall/Externalizer.html">Externalizer</a> interface implementation that knows how to transform an object of a particular class into a serialized form and how to read an object of that class from a given input. Infinispan does not force the objects to be serialized to implement Externalizer. In fact, it is recommended that a separate class is used to implement the Externalizer interface because, contrary to JDK serialization, Externalizer implementations control how objects of a particular class are created when trying to read an object from a stream. This means that readObject() implementations are responsible of creating object instances of the target class, hence giving users a lot of flexibility on how to create these instances (whether direct instantiation, via factory or reflection), and more importantly, allows target classes to carry on being immutable. This type of externalizer architecture promotes good OOP designs principles, such as the principle of <a href="http://en.wikipedia.org/wiki/Single_responsibility_principle">single responsibility</a> .</p> </div> <div class="paragraph"> <p>It&#8217;s quite common, and in general recommended, that Externalizer implementations are stored as inner static public classes within classes that they externalize. The advantages of doing this is that related code stays together, making it easier to maintain. In Infinispan, there are two ways in which Infinispan can be plugged with user defined externalizers:</p> </div> </div> <div class="sect3"> <h4 id="user_friendly_externalizers"><a class="anchor" href="#user_friendly_externalizers"></a>13.4.2. User Friendly Externalizers</h4> <div class="paragraph"> <p>In the simplest possible form, users just need to provide an <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/commons/marshall/Externalizer.html">Externalizer</a> implementation for the type that they want to marshall/unmarshall, and then annotate the marshalled type class with {@link SerializeWith} annotation indicating the externalizer class to use. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.marshall.Externalizer</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.marshall.SerializeWith</span>;

<span class="annotation">@SerializeWith</span>(Person.PersonExternalizer.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Person</span> {

<span class="error">Â </span><span class="error">Â </span> <span class="directive">final</span> <span class="predefined-type">String</span> name;
<span class="error">Â </span><span class="error">Â </span> <span class="directive">final</span> <span class="type">int</span> age;

<span class="error">Â </span><span class="error">Â </span> <span class="directive">public</span> Person(<span class="predefined-type">String</span> name, <span class="type">int</span> age) {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="local-variable">this</span>.name = name;
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="local-variable">this</span>.age = age;
<span class="error">Â </span><span class="error">Â </span> }

<span class="error">Â </span><span class="error">Â </span> <span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">PersonExternalizer</span> <span class="directive">implements</span> Externalizer&lt;Person&gt; {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="annotation">@Override</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">public</span> <span class="type">void</span> writeObject(<span class="predefined-type">ObjectOutput</span> output, Person person)
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">throws</span> <span class="exception">IOException</span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> output.writeObject(person.name);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> output.writeInt(person.age);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="annotation">@Override</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">public</span> Person readObject(<span class="predefined-type">ObjectInput</span> input)
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">throws</span> <span class="exception">IOException</span>, <span class="exception">ClassNotFoundException</span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">return</span> <span class="keyword">new</span> Person((<span class="predefined-type">String</span>) input.readObject(), input.readInt());
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }
<span class="error">Â </span><span class="error">Â </span> }
}</code></pre> </div> </div> <div class="paragraph"> <p>At runtime JBoss Marshalling will inspect the object and discover that it&#8217;s marshallable (thanks to the annotation) and so marshall it using the externalizer class passed. To make externalizer implementations easier to code and more typesafe, make sure you define type <code>&lt;T&gt;</code> as the type of object that&#8217;s being marshalled/unmarshalled.</p> </div> <div class="paragraph"> <p>Even though this way of defining externalizers is very user friendly, it has some disadvantages:</p> </div> <div class="ulist"> <ul> <li> <p>Due to several constraints of the model, such as support for different versions of the same class or the need to marshall the Externalizer class, the payload sizes generated via this method are not the most efficient.</p> </li> <li> <p>This model requires that the marshalled class be annotated with {@link SerializeWith} but a user might need to provide an Externalizer for a class for which source code is not available, or for any other constraints, it cannot be modified.</p> </li> <li> <p>The use of annotations by this model might be limiting for framework developers or service providers that try to abstract lower level details, such as the marshalling layer, away from the user.</p> </li> </ul> </div> <div class="paragraph"> <p>If you&#8217;re affected by any of these disadvantages, an alternative method to provide externalizers is available via more advanced externalizers:</p> </div> </div> <div class="sect3"> <h4 id="advanced_externalizers"><a class="anchor" href="#advanced_externalizers"></a>13.4.3. Advanced Externalizers</h4> <div class="paragraph"> <p><a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/commons/marshall/AdvancedExternalizer.html">AdvancedExternalizer</a> provides an alternative way to provide externalizers for marshalling/unmarshalling user defined classes that overcome the deficiencies of the more user-friendly externalizer definition model explained in Externalizer. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.marshall.AdvancedExternalizer</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Person</span> {

<span class="error">Â </span><span class="error">Â </span> <span class="directive">final</span> <span class="predefined-type">String</span> name;
<span class="error">Â </span><span class="error">Â </span> <span class="directive">final</span> <span class="type">int</span> age;

<span class="error">Â </span><span class="error">Â </span> <span class="directive">public</span> Person(<span class="predefined-type">String</span> name, <span class="type">int</span> age) {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="local-variable">this</span>.name = name;
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="local-variable">this</span>.age = age;
<span class="error">Â </span><span class="error">Â </span> }

<span class="error">Â </span><span class="error">Â </span> <span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">PersonExternalizer</span> <span class="directive">implements</span> AdvancedExternalizer&lt;Person&gt; {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="annotation">@Override</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">public</span> <span class="type">void</span> writeObject(<span class="predefined-type">ObjectOutput</span> output, Person person)
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">throws</span> <span class="exception">IOException</span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> output.writeObject(person.name);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> output.writeInt(person.age);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="annotation">@Override</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">public</span> Person readObject(<span class="predefined-type">ObjectInput</span> input)
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">throws</span> <span class="exception">IOException</span>, <span class="exception">ClassNotFoundException</span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">return</span> <span class="keyword">new</span> Person((<span class="predefined-type">String</span>) input.readObject(), input.readInt());
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="annotation">@Override</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> Person&gt;&gt; getTypeClasses() {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">return</span> <span class="predefined-type">Util</span>.&lt;<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> Person&gt;&gt;asSet(Person.class);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="annotation">@Override</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">public</span> <span class="predefined-type">Integer</span> getId() {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">return</span> <span class="integer">2345</span>;
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }
<span class="error">Â </span><span class="error">Â </span> }
}</code></pre> </div> </div> <div class="paragraph"> <p>The first noticeable difference is that this method does not require user classes to be annotated in anyway, so it can be used with classes for which source code is not available or that cannot be modified. The bound between the externalizer and the classes that are marshalled/unmarshalled is set by providing an implementation for <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/commons/marshall/AdvancedExternalizer.html#getTypeClasses--">getTypeClasses()</a> which should return the list of classes that this externalizer can marshall:</p> </div> <div class="sect4"> <h5 id="linking_externalizers_with_marshaller_classes"><a class="anchor" href="#linking_externalizers_with_marshaller_classes"></a>Linking Externalizers with Marshaller Classes</h5> <div class="paragraph"> <p>Once the Externalizer&#8217;s readObject() and writeObject() methods have been implemented, it&#8217;s time to link them up together with the type classes that they externalize. To do so, the Externalizer implementation must provide a getTypeClasses() implementation. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.util.Util</span>;
...
<span class="annotation">@Override</span>
<span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> ReplicableCommand&gt;&gt; getTypeClasses() {
<span class="error">Â </span> <span class="keyword">return</span> <span class="predefined-type">Util</span>.asSet(LockControlCommand.class, RehashControlCommand.class,
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> StateTransferControlCommand.class, GetKeyValueCommand.class,
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> ClusteredGetCommand.class, MultipleRpcCommand.class,
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> SingleRpcCommand.class, CommitCommand.class,
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> PrepareCommand.class, RollbackCommand.class,
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> ClearCommand.class, EvictCommand.class,
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> InvalidateCommand.class, InvalidateL1Command.class,
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> PutKeyValueCommand.class, PutMapCommand.class,
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> RemoveCommand.class, ReplaceCommand.class);
}</code></pre> </div> </div> <div class="paragraph"> <p>In the code above, ReplicableCommandExternalizer indicates that it can externalize several type of commands. In fact, it marshalls all commands that extend ReplicableCommand interface, but currently the framework only supports class equality comparison and so, it&#8217;s not possible to indicate that the classes to marshalled are all children of a particular class/interface.</p> </div> <div class="paragraph"> <p>However there might sometimes when the classes to be externalized are private and hence it&#8217;s not possible to reference the actual class instance. In this situations, users can attempt to look up the class with the given fully qualified class name and pass that back. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> <span class="predefined-type">List</span>&gt;&gt; getTypeClasses() {
<span class="error">Â </span> <span class="keyword">return</span> <span class="predefined-type">Util</span>.&lt;<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> <span class="predefined-type">List</span>&gt;&gt;asSet(
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">Util</span>.loadClass(<span class="string"><span class="delimiter">&quot;</span><span class="content">java.util.Collections$SingletonList</span><span class="delimiter">&quot;</span></span>));
}</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="externalizer_identifier"><a class="anchor" href="#externalizer_identifier"></a>Externalizer Identifier</h5> <div class="paragraph"> <p>Secondly, in order to save the maximum amount of space possible in the payloads generated, advanced externalizers require externalizer implementations to provide a positive identified via <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/commons/marshall/AdvancedExternalizer.html#getId--">getId()</a> implementations or via XML/programmatic configuration that identifies the externalizer when unmarshalling a payload.Â  In order for this to work however, advanced externalizers require externalizers to be registered on cache manager creation time via XML or programmatic configuration which will be explained in next section. On the contrary, externalizers based on Externalizer and SerializeWith require no pre-registration whatsoever. Internally, Infinispan uses this advanced externalizer mechanism in order to marshall/unmarshall internal classes.</p> </div> <div class="paragraph"> <p>So, getId() should return a positive integer that allows the externalizer to be identified at read time to figure out which Externalizer should read the contents of the incoming buffer, or it can return null. If getId() returns null, it is indicating that the id of this advanced externalizer will be defined via XML/programmatic configuration, which will be explained in next section.</p> </div> <div class="paragraph"> <p>Regardless of the source of the the id, using a positive integer allows for very efficient variable length encoding of numbers, and it&#8217;s much more efficient than shipping externalizer implementation class information or class name around. Infinispan users can use any positive integer as long as it does not clash with any other identifier in the system. It&#8217;s important to understand that a user defined externalizer can even use the same numbers as the externalizers in the Infinispan Core project because the internal Infinispan Core externalizers are special and they use a different number space to the user defined externalizers. On the contrary, users should avoid using numbers that are within the pre-assigned identifier ranges which can be found at the end of this article. Infinispan checks for id duplicates on startup, and if any are found, startup is halted with an error.</p> </div> <div class="paragraph"> <p>When it comes to maintaining which ids are in use, it&#8217;s highly recommended that this is done in a centralized way. For example, getId() implementations could reference a set of statically defined identifiers in a separate class or interface. Such class/interface would give a global view of the identifiers in use and so can make it easier to assign new ids.</p> </div> </div> <div class="sect4"> <h5 id="registering_advanced_externalizers"><a class="anchor" href="#registering_advanced_externalizers"></a>Registering Advanced Externalizers</h5> <div class="paragraph"> <p>The following example shows the type of configuration required to register an advanced externalizer implementation for Person object shown earlier stored as a static inner class within it:</p> </div> <div class="listingblock"> <div class="title">infinispan.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
Â  <span class="tag">&lt;cache-container&gt;</span>
Â Â Â  <span class="tag">&lt;serialization&gt;</span>
Â Â Â Â   <span class="tag">&lt;advanced-externalizer</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Person$PersonExternalizer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
Â Â Â  <span class="tag">&lt;/serialization&gt;</span>
Â  <span class="tag">&lt;/cache-container&gt;</span>
Â  ...
<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder builder = ...
builder.serialization()
<span class="error">Â </span><span class="error">Â </span> .addAdvancedExternalizer(<span class="keyword">new</span> Person.PersonExternalizer());</code></pre> </div> </div> <div class="paragraph"> <p>As mentioned earlier, when listing these externalizer implementations, users can optionally provide the identifier of the externalizer via XML or programmatically instead of via getId() implementation. Again, this offers a centralized way to maintain the identifiers but it&#8217;s important that the rules are clear: An AdvancedExternalizer implementation, either via XML/programmatic configuration or via annotation, needs to be associated with an identifier. If it isn&#8217;t, Infinispan will throw an error and abort startup. If a particular AdvancedExternalizer implementation defines an id both via XML/programmatic configuration and annotation, the value defined via XML/programmatically is the one that will be used. Here&#8217;s an example of an externalizer whose id is defined at registration time:</p> </div> <div class="listingblock"> <div class="title">infinispan.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
Â  <span class="tag">&lt;cache-container&gt;</span>
Â Â Â  <span class="tag">&lt;serialization&gt;</span>
Â Â Â Â   <span class="tag">&lt;advanced-externalizer</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">123</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Person$PersonExternalizer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
Â Â Â  <span class="tag">&lt;/serialization&gt;</span>
Â  <span class="tag">&lt;/cache-container&gt;</span>
Â  ...
<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder builder = ...
builder.serialization()
<span class="error">Â </span><span class="error">Â </span> .addAdvancedExternalizer(<span class="integer">123</span>, <span class="keyword">new</span> Person.PersonExternalizer());</code></pre> </div> </div> <div class="paragraph"> <p>Finally, a couple of notes about the programmatic configuration. GlobalConfiguration.addExternalizer() takes varargs, so it means that it is possible to register multiple externalizers in just one go, assuming that their ids have already been defined via @Marshalls annotation. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">builder.serialization()
<span class="error">Â </span><span class="error">Â </span> .addAdvancedExternalizer(<span class="keyword">new</span> Person.PersonExternalizer(),
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">new</span> Address.AddressExternalizer());</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="preassigned_externalizer_id_ranges"><a class="anchor" href="#preassigned_externalizer_id_ranges"></a>Preassigned Externalizer Id Ranges</h5> <div class="paragraph"> <p>This is the list of Externalizer identifiers that are used by Infinispan based modules or frameworks. Infinispan users should avoid using ids within these ranges.</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Tree Module:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1000 - 1099</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Server Modules:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1100 - 1199</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Hibernate Infinispan Second Level Cache:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1200 - 1299</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Lucene Directory:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1300 - 1399</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Hibernate OGM:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1400 - 1499</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Hibernate Search:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1500 - 1599</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Query Module:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1600 - 1699</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Remote Query Module:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1700 - 1799</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Scripting Module:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1800 - 1849</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Server Event Logger Module:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1850 - 1899</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Remote Store:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1900 - 1999</p></td> </tr> </tbody> </table> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="server_modules"><a class="anchor" href="#server_modules"></a>14. Server Modules</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan offers two alternative access methods: embedded mode and client-server mode.</p> </div> <div class="ulist"> <ul> <li> <p>In Embedded mode the Infinispan libraries co-exist with the user application in the same JVM as shown in the following diagram</p> </li> </ul> </div> <div class="imageblock"> <div class="content"> <img src="./images/server_modules_1.png" alt="server modules 1"> </div> </div> <div class="ulist"> <ul> <li> <p>Client-server mode is when applications access the data stored in a remote Infinispan server using some kind of network protocol</p> </li> </ul> </div> <div class="sect2"> <h3 id="why_client_server"><a class="anchor" href="#why_client_server"></a>14.1. Why Client-Server?</h3> <div class="paragraph"> <p>There are situations when accessing Infinispan in a client-server mode might make more sense than embedding it within your application, for example, when trying to access Infinispan from a non-JVM environment. Since Infinispan is written in Java, if someone had a C++ application that wanted to access it, it couldn&#8217;t just do it in a p2p way. On the other hand, client-server would be perfectly suited here assuming that a language neutral protocol was used and the corresponding client and server implementations were available.</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/server_modules_2.png" alt="server modules 2"> </div> </div> <div class="paragraph"> <p>In other situations, Infinispan users want to have an elastic application tier where you start/stop business processing servers very regularly. Now, if users deployed Infinispan configured with distribution or state transfer, startup time could be greatly influenced by the shuffling around of data that happens in these situations. So in the following diagram, assuming Infinispan was deployed in p2p mode, the app in the second server could not access Infinispan until state transfer had completed.</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/server_modules_3.png" alt="server modules 3"> </div> </div> <div class="paragraph"> <p>This effectively means that bringing up new application-tier servers is impacted by things like state transfer because applications cannot access Infinispan until these processes have finished and if the state being shifted around is large, this could take some time. This is undesirable in an elastic environment where you want quick application-tier server turnaround and predictable startup times. Problems like this can be solved by accessing Infinispan in a client-server mode because starting a new application-tier server is just a matter of starting a lightweight client that can connect to the backing data grid server. No need for rehashing or state transfer to occur and as a result server startup times can be more predictable which is very important for modern cloud-based deployments where elasticity in your application tier is important.</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/AchievingElasticity.png" alt="AchievingElasticity"> </div> </div> <div class="paragraph"> <p>Other times, it&#8217;s common to find multiple applications needing access to data storage. In this cases, you could in theory deploy an Infinispan instance per each of those applications but this could be wasteful and difficult to maintain. Think about databases here, you don&#8217;t deploy a database alongside each of your applications, do you? So, alternatively you could deploy Infinispan in client-server mode keeping a pool of Infinispan data grid nodes acting as a shared storage tier for your applications.</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/server_modules_4.png" alt="server modules 4"> </div> </div> <div class="paragraph"> <p>Deploying Infinispan in this way also allows you to manage each tier independently, for example, you can upgrade you application or app server without bringing down your Infinispan data grid nodes.</p> </div> </div> <div class="sect2"> <h3 id="why_use_embedded_mode"><a class="anchor" href="#why_use_embedded_mode"></a>14.2. Why use embedded mode?</h3> <div class="paragraph"> <p>Before talking about individual Infinispan server modules, it&#8217;s worth mentioning that in spite of all the benefits, client-server Infinispan still has disadvantages over p2p. Firstly, p2p deployments are simpler than client-server ones because in p2p, all peers are equals to each other and hence this simplifies deployment. So, if this is the first time you&#8217;re using Infinispan, p2p is likely to be easier for you to get going compared to client-server.</p> </div> <div class="paragraph"> <p>Client-server Infinispan requests are likely to take longer compared to p2p requests, due to the serialization and network cost in remote calls. So, this is an important factor to take in account when designing your application. For example, with replicated Infinispan caches, it might be more performant to have lightweight HTTP clients connecting to a server side application that accesses Infinispan in p2p mode, rather than having more heavyweight client side apps talking to Infinispan in client-server mode, particularly if data size handled is rather large. With distributed caches, the difference might not be so big because even in p2p deployments, you&#8217;re not guaranteed to have all data available locally.</p> </div> <div class="paragraph"> <p>Environments where application tier elasticity is not so important, or where server side applications access state-transfer-disabled, replicated Infinispan cache instances are amongst scenarios where Infinispan p2p deployments can be more suited than client-server ones.</p> </div> </div> <div class="sect2"> <h3 id="server_modules_2"><a class="anchor" href="#server_modules_2"></a>14.3. Server Modules</h3> <div class="paragraph"> <p>So, now that it&#8217;s clear when it makes sense to deploy Infinispan in client-server mode, what are available solutions? All Infinispan server modules are based on the same pattern where the server backend creates an embedded Infinispan instance and if you start multiple backends, they can form a cluster and share/distribute state if configured to do so. The server types below primarily differ in the type of listener endpoint used to handle incoming connections.</p> </div> <div class="paragraph"> <p>Here&#8217;s a brief summary of the available server endpoints.</p> </div> <div class="ulist"> <ul> <li> <p><strong>Hot Rod Server Module</strong> - This module is an implementation of the <a href="#_hot_rod_protocol">Hot Rod binary protocol</a> backed by Infinispan which allows clients to do dynamic load balancing and failover and smart routing.</p> <div class="ulist"> <ul> <li> <p>A <a href="http://www.infinispan.org/hotrod-clients">variety of clients</a> exist for this protocol.</p> </li> <li> <p>If you&#8217;re clients are running Java, this should be your defacto server module choice because it allows for dynamic load balancing and failover. This means that Hot Rod clients can dynamically detect changes in the topology of Hot Rod servers as long as these are clustered, so when new nodes join or leave, clients update their Hot Rod server topology view. On top of that, when Hot Rod servers are configured with distribution, clients can detect where a particular key resides and so they can route requests smartly.</p> </li> <li> <p>Load balancing and failover is dynamically provided by Hot Rod client implementations using information provided by the server.</p> </li> </ul> </div> </li> <li> <p><strong>REST Server Module</strong> - The REST server, which is distributed as a WAR file, can be deployed in any servlet container to allow Infinispan to be accessed via a RESTful HTTP interface.</p> <div class="ulist"> <ul> <li> <p>To connect to it, you can use any HTTP client out there and there&#8217;re tons of different client implementations available out there for pretty much any language or system.</p> </li> <li> <p>This module is particularly recommended for those environments where HTTP port is the only access method allowed between clients and servers.</p> </li> <li> <p>Clients wanting to load balance or failover between different Infinispan REST servers can do so using any standard HTTP load balancer such as <a href="http://www.jboss.org/mod_cluster">mod_cluster</a> . It&#8217;s worth noting though these load balancers maintain a static view of the servers in the backend and if a new one was to be added, it would require manual update of the load balancer.</p> </li> </ul> </div> </li> <li> <p><strong>Memcached Server Module</strong> - This module is an implementation of the <a href="http://github.com/memcached/memcached/blob/master/doc/protocol.txt">Memcached text protocol</a> backed by Infinispan.</p> <div class="ulist"> <ul> <li> <p>To connect to it, you can use any of the <a href="http://code.google.com/p/memcached/wiki/Clients">existing Memcached clients</a> which are pretty diverse.</p> </li> <li> <p>As opposed to Memcached servers, Infinispan based Memcached servers can actually be clustered and hence they can replicate or distribute data using consistent hash algorithms around the cluster. So, this module is particularly of interest to those users that want to provide failover capabilities to the data stored in Memcached servers.</p> </li> <li> <p>In terms of load balancing and failover, there&#8217;re a few clients that can load balance or failover given a static list of server addresses (perl&#8217;s Cache::Memcached for example) but any server addition or removal would require manual intervention.</p> </li> </ul> </div> </li> <li> <p><strong>Websocket Server Module</strong> - This module enables Infinispan to be accessed over a <a href="http://en.wikipedia.org/wiki/WebSockets">Websocket</a> interface via a Javascript API.</p> <div class="ulist"> <ul> <li> <p>This module is very specifically designed for Javascript clients and so that is the only client implementation available.</p> </li> <li> <p>This module is particularly suited for developers wanting to enable access to Infinispan instances from their Javascript codebase.</p> </li> <li> <p>Since websockets work on the same HTTP port, any HTTP load balancer would do to load balance and failover.</p> </li> <li> <p>This module is <strong class="red">EXPERIMENTAL</strong>! Beware!</p> </li> </ul> </div> </li> </ul> </div> </div> <div class="sect2"> <h3 id="using_hot_rod_server"><a class="anchor" href="#using_hot_rod_server"></a>14.4. Using Hot Rod Server</h3> <div class="paragraph"> <p>The Infinispan Server distribution contains a server module that implements Infinispan&#8217;s custom binary protocol called Hot Rod. The protocol was designed to enable faster client/server interactions compared to other existing text based protocols and to allow clients to make more intelligent decisions with regards to load balancing, failover and even data location operations. Please refer to Infinispan Server&#8217;s <a href="../infinispan_server_guide/infinispan_server_guide.html">documentation</a> for instructions on how to configure and run a HotRod server.</p> </div> <div class="sect3"> <h4 id="hot_rod_protocol"><a class="anchor" href="#hot_rod_protocol"></a>14.4.1. Hot Rod Protocol</h4> <div class="paragraph"> <p>The following articles provides detailed information about each version of the custom TCP client/server Hot Rod protocol.</p> </div> <div class="ulist"> <ul> <li> <p><a href="#_hot_rod_protocol_1_0">Hot Rod Protocol 1.0</a></p> </li> <li> <p><a href="#_hot_rod_protocol_1_1">Hot Rod Protocol 1.1</a></p> </li> <li> <p><a href="#_hot_rod_protocol_1_2">Hot Rod Protocol 1.2</a></p> </li> <li> <p><a href="#_hot_rod_protocol_1_3">Hot Rod Protocol 1.3</a></p> </li> <li> <p><a href="#_hot_rod_protocol_2_0">Hot Rod Protocol 2.0</a></p> </li> <li> <p><a href="#_hot_rod_protocol_2_1">Hot Rod Protocol 2.1</a></p> </li> <li> <p><a href="#_hot_rod_protocol_2_2">Hot Rod Protocol 2.2</a></p> </li> <li> <p><a href="#_hot_rod_protocol_2_3">Hot Rod Protocol 2.3</a></p> </li> <li> <p><a href="#_hot_rod_protocol_2_4">Hot Rod Protocol 2.4</a></p> </li> <li> <p><a href="#_hot_rod_protocol_2_5">Hot Rod Protocol 2.5</a></p> </li> <li> <p><a href="#_hot_rod_protocol_2_6">Hot Rod Protocol 2.6</a></p> </li> </ul> </div> <div class="sect4"> <h5 id="hot_rod_protocol_1_0"><a class="anchor" href="#hot_rod_protocol_1_0"></a>Hot Rod Protocol 1.0</h5> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Infinispan versions</div> This version of the protocol is implemented since Infinispan 4.1.0.Final </td> </tr> </table> </div> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="fa icon-important" title="Important"></i> </td> <td class="content"> All key and values are sent and stored as byte arrays. Hot Rod makes no assumptions about their types. </td> </tr> </table> </div> <div class="paragraph"> <p>Some clarifications about the other types:</p> </div> <div class="ulist"> <ul> <li> <p>vInt : Variable-length integers are defined defined as compressed, positive integers where the high-order bit of each byte indicates whether more bytes need to be read. The low-order seven bits are appended as increasingly more significant bits in the resulting integer value making it efficient to decode. Hence, values from zero to 127 are stored in a single byte, values from 128 to 16,383 are stored in two bytes, and so on:</p> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><code>Value</code></th> <th class="tableblock halign-left valign-top"><code>First byte</code></th> <th class="tableblock halign-left valign-top"><code>Second byte</code></th> <th class="tableblock halign-left valign-top"><code>Third byte</code></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>0</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>00000000</code></p></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>1</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>00000001</code></p></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>2</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>00000010</code></p></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>&#8230;&#8203;</code></p></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>127</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>01111111</code></p></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>128</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>10000000</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>00000001</code></p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>129</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>10000001</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>00000001</code></p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>130</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>10000010</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>00000001</code></p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>&#8230;&#8203;</code></p></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>16,383</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>11111111</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>01111111</code></p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>16,384</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>10000000</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>10000000</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>00000001</code></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>16,385</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>10000001</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>10000000</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>00000001</code></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>&#8230;&#8203;</code></p></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> </tbody> </table> </li> <li> <p>signed vInt: The vInt above is also able to encode negative values, but will always use the maximum size (5 bytes) no matter how small the endoded value is. In order to have a small payload for negative values too, signed vInts uses ZigZag encoding on top of the vInt encoding. More details <a href="http://developers.google.com/protocol-buffers/docs/encoding#types">here</a></p> </li> <li> <p>vLong : Refers to unsigned variable length long values similar to vInt but applied to longer values. They&#8217;re between 1 and 9 bytes long.</p> </li> <li> <p>String : Strings are always represented using UTF-8 encoding.</p> </li> </ul> </div> <div class="sect5"> <h6 id="request_header"><a class="anchor" href="#request_header"></a>Request Header</h6> <div class="paragraph"> <p>The header for a request is composed of:</p> </div> <table class="tableblock frame-all grid-all spread"> <caption class="title">Table 4. Request header</caption> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Magic</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0xA0 = request</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Message ID</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vLong</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ID of the message that will be copied back in the response. This allows for hot rod clients to implement the protocol in an asynchronous way.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Version</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan hot rod server version. In this particular case, this is 10</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Opcode</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Request operation code:<br> 0x01 = put (since 1.0)<br> 0x03 = get (since 1.0)<br> 0x05 = putIfAbsent (since 1.0)<br> 0x07 = replace (since 1.0)<br> 0x09 = replaceIfUnmodified (since 1.0)<br> 0x0B = remove (since 1.0)<br> 0x0D = removeIfUnmodified (since 1.0)<br> 0x0F = containsKey (since 1.0)<br> 0x11 = getWithVersion (since 1.0)<br> 0x13 = clear (since 1.0)<br> 0x15 = stats (since 1.0)<br> 0x17 = ping (since 1.0)<br> 0x19 = bulkGet (since 1.2)<br> 0x1B = getWithMetadata (since 1.2)<br> 0x1D = bulkGetKeys (since 1.2)<br> 0x1F = query (since 1.3)<br> 0x21 = authMechList (since 2.0)<br> 0x23 = auth (since 2.0)<br> 0x25 = addClientListener (since 2.0)<br> 0x27 = removeClientListener (since 2.0)<br> 0x29 = size (since 2.0)<br> 0x2B = exec (since 2.1)<br> 0x2D = putAll (since 2.1)<br> 0x2F = getAll (since 2.1)<br> 0x31 = iterationStart (since 2.3)<br> 0x33 = iterationNext (since 2.3)<br> 0x35 = iterationEnd (since 2.3)<br></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Cache Name Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of cache name. If the passed length is 0 (followed by no cache name), the operation will interact with the default cache.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Cache Name</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Name of cache on which to operate. This name must match the name of predefined cache in the Infinispan configuration file.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Flags</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">A variable length number representing flags passed to the system. Each flags is represented by a bit. Note that since this field is sent as variable length, the most significant bit in a byte is used to determine whether more bytes need to be read, hence this bit does not represent any flag. Using this model allows for flags to be combined in a short space. Here are the current values for each flag:<br> 0x0001 = force return previous value</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Client Intelligence</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">This byte hints the server on the client capabilities:<br> 0x01 = basic client, interested in neither cluster nor hash information<br> 0x02 = topology-aware client, interested in cluster information<br> 0x03 = hash-distribution-aware client, that is interested in both cluster and hash information<br></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Topology Id</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">This field represents the last known view in the client. Basic clients will only send 0 in this field. When topology-aware or hash-distribution-aware clients will send 0 until they have received a reply from the server with the current view id. Afterwards, they should send that view id until they receive a new view id in a response.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Transaction Type</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">This is a 1 byte field, containing one of the following well-known supported transaction types (For this version of the protocol, the only supported transaction type is 0):<br> 0 = Non-transactional call, or client does not support transactions. The subsequent TX_ID field will be omitted.<br> 1 = X/Open XA transaction ID (XID). This is a well-known, fixed-size format.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Transaction Id</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The byte array uniquely identifying the transaction associated to this call. Its length is determined by the transaction type. If transaction type is 0, no transaction id will be present.</p></td> </tr> </tbody> </table> </div> <div class="sect5"> <h6 id="response_header"><a class="anchor" href="#response_header"></a>Response Header</h6> <div class="paragraph"> <p>The header for a response is composed of:</p> </div> <table class="tableblock frame-all grid-all spread"> <caption class="title">Table 5. Response header</caption> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Magic</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0xA1 = response</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Message ID</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vLong</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ID of the message, matching the request for which the response is sent.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Opcode</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response operation code:<br> 0x02 = put (since 1.0)<br> 0x04 = get (since 1.0)<br> 0x06 = putIfAbsent (since 1.0)<br> 0x08 = replace (since 1.0)<br> 0x0A = replaceIfUnmodified (since 1.0)<br> 0x0C = remove (since 1.0)<br> 0x0E = removeIfUnmodified (since 1.0)<br> 0x10 = containsKey (since 1.0)<br> 0x12 = getWithVersion (since 1.0)<br> 0x14 = clear (since 1.0)<br> 0x16 = stats (since 1.0)<br> 0x18 = ping (since 1.0)<br> 0x1A = bulkGet (since 1.0)<br> 0x1C = getWithMetadata (since 1.2)<br> 0x1E = bulkGetKeys (since 1.2)<br> 0x20 = query (since 1.3)<br> 0x22 = authMechList (since 2.0)<br> 0x24 = auth (since 2.0)<br> 0x26 = addClientListener (since 2.0)<br> 0x28 = removeClientListener (since 2.0)<br> 0x2A = size (since 2.0)<br> 0x2C = exec (since 2.1)<br> 0x2E = putAll (since 2.1)<br> 0x30 = getAll (since 2.1)<br> 0x32 = iterationStart (since 2.3)<br> 0x34 = iterationNext (since 2.3)<br> 0x36 = iterationEnd (since 2.3)<br> 0x50 = error (since 1.0)<br></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Status</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Status of the response, possible values:<br> 0x00 = No error<br> 0x01 = Not put/removed/replaced<br> 0x02 = Key does not exist<br> 0x81 = Invalid magic or message id<br> 0x82 = Unknown command<br> 0x83 = Unknown version<br> 0x84 = Request parsing error<br> 0x85 = Server Error<br> 0x86 = Command timed out<br></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Topology Change Marker</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">This is a marker byte that indicates whether the response is prepended with topology change information. When no topology change follows, the content of this byte is 0. If a topology change follows, its contents are 1.</p></td> </tr> </tbody> </table> <div class="admonitionblock caution"> <table> <tr> <td class="icon"> <i class="fa icon-caution" title="Caution"></i> </td> <td class="content"> Exceptional error status responses, those that start with 0x8 &#8230;&#8203;, are followed by the length of the error message (as a vInt ) and error message itself as String. </td> </tr> </table> </div> </div> <div class="sect5"> <h6 id="topology_change_headers"><a class="anchor" href="#topology_change_headers"></a>Topology Change Headers</h6> <div class="paragraph"> <p>The following section discusses how the response headers look for topology-aware or hash-distribution-aware clients when there&#8217;s been a cluster or view formation change. Note that it&#8217;s the server that makes the decision on whether it sends back the new topology based on the current topology id and the one the client sent. If they&#8217;re different, it will send back the new topology.</p> </div> </div> <div class="sect5"> <h6 id="topology_aware_client_topology_change_header"><a class="anchor" href="#topology_aware_client_topology_change_header"></a>Topology-Aware Client Topology Change Header</h6> <div class="paragraph"> <p>This is what topology-aware clients receive as response header when a topology change is sent back:</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header with topology change marker</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">See previous section.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Topology Id</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Topology ID</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Num servers in topology</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of Infinispan Hot Rod servers running within the cluster. This could be a subset of the entire cluster if only a fraction of those nodes are running Hot Rod servers.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m1: Host/IP length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of hostname or IP address of individual cluster member that Hot Rod client can use to access it. Using variable length here allows for covering for hostnames, IPv4 and IPv6 addresses.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m1: Host/IP address</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">String containing hostname or IP address of individual cluster member that Hot Rod client can use to access it.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m1: Port</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">2 bytes (Unsigned Short)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Port that Hot Rod clients can use to communicate with this cluster member.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m2: Host/IP length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m2: Host/IP address</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m2: Port</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">2 bytes (Unsigned Short)</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;etc</p></td> <td class="tableblock halign-center valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> </tbody> </table> </div> <div class="sect5"> <h6 id="distribution_aware_client_topology_change_header"><a class="anchor" href="#distribution_aware_client_topology_change_header"></a>Distribution-Aware Client Topology Change Header</h6> <div class="paragraph"> <p>This is what hash-distribution-aware clients receive as response header when a topology change is sent back:</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header with topology change marker</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">See previous section.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Topology Id</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Topology ID</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Num Key Owners</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">2 bytes (Unsigned Short)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Globally configured number of copies for each Infinispan distributed key</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Hash Function Version</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Hash function version, pointing to a specific hash function in use. See <a href="#_hot_rod_hash_functions">Hot Rod hash functions</a> for details.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Hash space size</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Modulus used by Infinispan for for all module arithmetic related to hash code generation. Clients will likely require this information in order to apply the correct hash calculation to the keys.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Num servers in topology</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of Infinispan Hot Rod servers running within the cluster. This could be a subset of the entire cluster if only a fraction of those nodes are running Hot Rod servers.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m1: Host/IP length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of hostname or IP address of individual cluster member that Hot Rod client can use to access it. Using variable length here allows for covering for hostnames, IPv4 and IPv6 addresses.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m1: Host/IP address</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">String containing hostname or IP address of individual cluster member that Hot Rod client can use to access it.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m1: Port</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">2 bytes (Unsigned Short)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Port that Hot Rod clients can use to communicat with this cluster member.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m1: Hashcode</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">4 bytes</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">32 bit integer representing the hashcode of a cluster member that a Hot Rod client can use indentify in which cluster member a key is located having applied the CSA to it.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m2: Host/IP length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m2: Host/IP address</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m2: Port</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">2 bytes (Unsigned Short)</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m2: Hashcode</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">4 bytes</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;etc</p></td> <td class="tableblock halign-center valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> </tbody> </table> <div class="paragraph"> <p>It&#8217;s important to note that since hash headers rely on the consistent hash algorithm used by the server and this is a factor of the cache interacted with, hash-distribution-aware headers can only be returned to operations that target a particular cache. Currently ping command does not target any cache (this is to change as per <a href="https://jira.jboss.org/jira/browse/ISPN-424">ISPN-424</a>) , hence calls to ping command with hash-topology-aware client settings will return a hash-distribution-aware header with "Num Key Owners", "Hash Function Version", "Hash space size" and each individual host&#8217;s hash code all set to 0. This type of header will also be returned as response to operations with hash-topology-aware client settings that are targeting caches that are not configured with distribution.</p> </div> </div> <div class="sect5"> <h6 id="operations"><a class="anchor" href="#operations"></a>Operations</h6> <div class="paragraph"> <div class="title">Get (0x03)/Remove (0x0B)/ContainsKey (0x0F)/GetWithVersion (0x11)</div> <p>Common request format:</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of key. Note that the size of a vint can be up to 5 bytes which in theory can produce bigger numbers than Integer.MAX_VALUE. However, Java cannot create a single array thatâs bigger than Integer.MAX_VALUE, hence the protocol is limiting vint array lengths to Integer.MAX_VALUE.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Byte array containing the key whose value is being requested.</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Get response (0x04):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if key retrieved<br> 0x02 = if key does not exist<br></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If success, length of value</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If success, the requested value</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Remove response (0x0C):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if key removed<br> 0x02 = if key does not exist<br></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Previous value Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was sent in the request and the key was removed, the length of the previous value will be returned. If the key does not exist, value length would be 0. If no flag was sent, no value length would be present.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Previous value</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was sent in the request and the key was removed, previous value.</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>ContainsKey response (0x10):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if key exists<br> 0x02 = if key does not exist<br></p></td> </tr> </tbody> </table> <div class="paragraph"> <p>GetWithVersion response (0x12):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if key retrieved<br> 0x02 = if key does not exist<br></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry Version</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">8 bytes</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Unique value of an existing entry&#8217;s modification. The protocol does not mandate that entry_version values are sequential. They just need to be unique per update at the key level.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If success, length of value</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If success, the requested value</p></td> </tr> </tbody> </table> <div class="paragraph"> <div class="title">BulkGet</div> <p>Request (0x19):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry count</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of Infinispan entries to be returned by the server (entry == key + associated value). Needed to support CacheLoader.load(int). If 0 then all entries are returned (needed for CacheLoader.loadAll()).</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Response (0x20):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, data follows<br></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">More</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">One byte representing whether more entries need to be read from the stream. So, when it&#8217;s set to 1, it means that an entry follows, whereas when it&#8217;s set to 0, it&#8217;s the end of stream and no more entries are left to read. For more information on BulkGet look <a href="http://community.jboss.org/docs/DOC-15592">here</a></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 1 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of key</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 1</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Retrieved key</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 1 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of value</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 1</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Retrieved value</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">More</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 2 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 2</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 2 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 2</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203; etc</p></td> <td class="tableblock halign-center valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> </tbody> </table> <div class="paragraph"> <div class="title">Put (0x01)/PutIfAbsent (0x05)/Replace (0x07)</div> <p>Common request format:</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of key. Note that the size of a vint can be up to 5 bytes which in theory can produce bigger numbers than Integer.MAX_VALUE. However, Java cannot create a single array thatâs bigger than Integer.MAX_VALUE, hence the protocol is limiting vint array lengths to Integer.MAX_VALUE.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Byte array containing the key whose value is being requested.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Lifespan</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of seconds that a entry during which the entry is allowed to life. If number of seconds is bigger than 30 days, this number of seconds is treated as UNIX time and so, represents the number of seconds since 1/1/1970. If set to 0, lifespan is unlimited.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Max Idle</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of seconds that a entry can be idle before it&#8217;s evicted from the cache. If 0, no max idle time.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of value</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte-array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Value to be stored</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Put response (0x02):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if stored<br></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Previous value Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was sent in the request and the key was put, the length of the previous value will be returned. If the key does not exist, value length would be 0. If no flag was sent, no value length would be present.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Previous value</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was sent in the request and the key was put, previous value.</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Replace response (0x08):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if stored<br> 0x01 = if store did not happen because key does not exist<br></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Previous value Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was sent in the request, the length of the previous value will be returned. If the key does not exist, value length would be 0. If no flag was sent, no value length would be present.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Previous value</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was sent in the request and the key was replaced, previous value.</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>PutIfAbsent response (0x06):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if stored<br> 0x01 = if store did not happen because key was present<br></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Previous value Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was sent in the request, the length of the previous value will be returned. If the key does not exist, value length would be 0. If no flag was sent, no value length would be present.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Previous value</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was sent in the request and the key was replaced, previous value.</p></td> </tr> </tbody> </table> <div class="paragraph"> <div class="title">ReplaceIfUnmodified</div> <p>Request (0x09):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of key. Note that the size of a vint can be up to 5 bytes which in theory can produce bigger numbers than Integer.MAX_VALUE. However, Java cannot create a single array thatâs bigger than Integer.MAX_VALUE, hence the protocol is limiting vint array lengths to Integer.MAX_VALUE.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Byte array containing the key whose value is being requested.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Lifespan</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of seconds that a entry during which the entry is allowed to life. If number of seconds is bigger than 30 days, this number of seconds is treated as UNIX time and so, represents the number of seconds since 1/1/1970. If set to 0, lifespan is unlimited.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Max Idle</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of seconds that a entry can be idle before it&#8217;s evicted from the cache. If 0, no max idle time.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry Version</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">8 bytes</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Use the value returned by GetWithVersion operation.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of value</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte-array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Value to be stored</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Response (0x0A):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if replaced<br> 0x01 = if replace did not happen because key had been modified<br> 0x02 = if not replaced because if key does not exist</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Previous value Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was sent in the request, the length of the previous value will be returned. If the key does not exist, value length would be 0. If no flag was sent, no value length would be present.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Previous value</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was sent in the request and the key was replaced, previous value.</p></td> </tr> </tbody> </table> <div class="paragraph"> <div class="title">RemoveIfUnmodified</div> <p>Request (0x0D):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of key. Note that the size of a vint can be up to 5 bytes which in theory can produce bigger numbers than Integer.MAX_VALUE. However, Java cannot create a single array thatâs bigger than Integer.MAX_VALUE, hence the protocol is limiting vint array lengths to Integer.MAX_VALUE.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Byte array containing the key whose value is being requested.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry Version</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">8 bytes</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Use the value returned by GetWithVersion operation.</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Response (0x0E):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if removed<br> 0x01 = if remove did not happen because key had been modified<br> 0x02 = if not removed because key does not exist<br></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Previous value Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was sent in the request, the length of the previous value will be returned. If the key does not exist, value length would be 0. If no flag was sent, no value length would be present.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Previous value</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was sent in the request and the key was removed, previous value.</p></td> </tr> </tbody> </table> <div class="paragraph"> <div class="title">Clear</div> <p>Request (0x13):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Response (0x14):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if cleared<br></p></td> </tr> </tbody> </table> <div class="paragraph"> <div class="title">PutAll</div> <p>Bulk operation to put all key value entries into the cache at the same time.</p> </div> <div class="paragraph"> <p>Request (0x2D):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Lifespan</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of seconds that provided entries are allowed to live. If number of seconds is bigger than 30 days, this number of seconds is treated as UNIX time and so, represents the number of seconds since 1/1/1970. If set to 0, lifespan is unlimited.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Max Idle</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of seconds that each entry can be idle before it&#8217;s evicted from the cache. If 0, no max idle time.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry count</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">How many entries are being inserted</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 1 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of key</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 1</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Retrieved key</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 1 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of value</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 1</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Retrieved value</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 2 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 2</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 2 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 2</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203; continues until entry count is reached</p></td> <td class="tableblock halign-center valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> </tbody> </table> <div class="paragraph"> <p>Response (0x2E):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if all put<br></p></td> </tr> </tbody> </table> <div class="paragraph"> <div class="title">GetAll</div> <p>Bulk operation to get all entries that map to a given set of keys.</p> </div> <div class="paragraph"> <p>Request (0x2F):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key count</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">How many keys to find entries for</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 1 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of key</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 1</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Retrieved key</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 2 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 2</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203; continues until key count is reached</p></td> <td class="tableblock halign-center valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> </tbody> </table> <div class="paragraph"> <p>Response (0x30):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry count</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">How many entries are being returned</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 1 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of key</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 1</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Retrieved key</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 1 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of value</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 1</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Retrieved value</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 2 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 2</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 2 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 2</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203; continues until entry count is reached</p></td> <td class="tableblock halign-center valign-top"></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if the get returned sucessfully<br></p></td> </tr> </tbody> </table> <div class="paragraph"> <div class="title">Stats</div> <p>Returns a summary of all available statistics. For each statistic returned, a name and a value is returned both in String UTF-8 format. The supported stats are the following:</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Name</th> <th class="tableblock halign-left valign-top">Explanation</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">timeSinceStart</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of seconds since Hot Rod started.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">currentNumberOfEntries</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of entries currently in the Hot Rod server.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">totalNumberOfEntries</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of entries stored in Hot Rod server.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">stores</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of put operations.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">retrievals</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of get operations.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">hits</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of get hits.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">misses</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of get misses.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">removeHits</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of removal hits.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">removeMisses</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of removal misses.</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Request (0x15):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Response (0x16):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if stats retrieved<br></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of stats</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of individual stats returned.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Name 1 length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of named statistic.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Name 1</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">String containing statistic name.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 1 length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of value field.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 1</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">String containing statistic value.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Name 2 length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Name 2</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 2 length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 2</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">String</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;etc</p></td> <td class="tableblock halign-center valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> </tbody> </table> <div class="paragraph"> <div class="title">Ping</div> <p>Application level request to see if the server is available.</p> </div> <div class="paragraph"> <p>Request (0x17):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Response (0x18):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if no errors<br></p></td> </tr> </tbody> </table> <div class="paragraph"> <div class="title">Error Handling</div> <p>Error response (0x50)</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x8x = error response code<br></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Error Message Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of error message</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Error Message</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Error message. In the case of 0x84 , this error field contains the latest version supported by the hot rod server. Length is defined by total body length.</p></td> </tr> </tbody> </table> <div class="paragraph"> <div class="title">Multi-Get Operations</div> <p>A multi-get operation is a form of get operation that instead of requesting a single key, requests a set of keys. The Hot Rod protocol does not include such operation but remote Hot Rod clients could easily implement this type of operations by either parallelizing/pipelining individual get requests. Another possibility would be for remote clients to use async or non-blocking get requests. For example, if a client wants N keys, it could send send N async get requests and then wait for all the replies. Finally, multi-get is not to be confused with bulk-get operations. In bulk-gets, either all or a number of keys are retrieved, but the client does not know which keys to retrieve, whereas in multi-get, the client defines which keys to retrieve.</p> </div> </div> <div class="sect5"> <h6 id="example_put_request"><a class="anchor" href="#example_put_request"></a>Example - Put request</h6> <div class="ulist"> <ul> <li> <p>Coded request</p> </li> </ul> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 11%;"> <col style="width: 11%;"> <col style="width: 11%;"> <col style="width: 11%;"> <col style="width: 11%;"> <col style="width: 11%;"> <col style="width: 11%;"> <col style="width: 11%;"> <col style="width: 11%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Byte</th> <th class="tableblock halign-left valign-top">0</th> <th class="tableblock halign-left valign-top">1</th> <th class="tableblock halign-left valign-top">2</th> <th class="tableblock halign-left valign-top">3</th> <th class="tableblock halign-left valign-top">4</th> <th class="tableblock halign-left valign-top">5</th> <th class="tableblock halign-left valign-top">6</th> <th class="tableblock halign-left valign-top">7</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0xA0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x09</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x41</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x01</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x07</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x4D ('M')</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x79 ('y')</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x43 ('C')</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x61 ('a')</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x63 ('c')</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x68 ('h')</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x65 ('e')</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x03</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">24</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x05</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x48 ('H')</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x65 ('e')</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x6C ('l')</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x6C ('l')</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x6F ('o')</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">32</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x05</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x57 ('W')</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x6F ('o')</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x72 ('r')</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x6C ('l')</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x64 ('d')</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Â </p></td> </tr> </tbody> </table> <div class="ulist"> <ul> <li> <p>Field explanation</p> </li> </ul> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-left valign-top">Value</th> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Magic (0)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0xA0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Message Id (1)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x09</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Version (2)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x41</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Opcode (3)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x01</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Cache name length (4)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x07</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Cache name(5-11)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">'MyCache'</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Flag (12)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Client Intelligence (13)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x03</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Topology Id (14)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Transaction Type (15)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Transaction Id (16)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Key field length (17)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x05</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key (18 - 22)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">'Hello'</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Lifespan (23)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Max idle (24)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Value field length (25)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x05</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value (26-30)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">'World'</p></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> </tbody> </table> <div class="ulist"> <ul> <li> <p>Coded response</p> </li> </ul> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 11%;"> <col style="width: 11%;"> <col style="width: 11%;"> <col style="width: 11%;"> <col style="width: 11%;"> <col style="width: 11%;"> <col style="width: 11%;"> <col style="width: 11%;"> <col style="width: 11%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Byte</th> <th class="tableblock halign-left valign-top">0</th> <th class="tableblock halign-left valign-top">1</th> <th class="tableblock halign-left valign-top">2</th> <th class="tableblock halign-left valign-top">3</th> <th class="tableblock halign-left valign-top">4</th> <th class="tableblock halign-left valign-top">5</th> <th class="tableblock halign-left valign-top">6</th> <th class="tableblock halign-left valign-top">7</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0xA1</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x09</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x01</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Â </p></td> </tr> </tbody> </table> <div class="ulist"> <ul> <li> <p>Field Explanation</p> </li> </ul> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-left valign-top">Value</th> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Magic (0)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0xA1</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Message Id (1)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x09</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Opcode (2)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x01</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Status (3)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Topology change marker (4)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> </tbody> </table> </div> </div> <div class="sect4"> <h5 id="hot_rod_protocol_1_1"><a class="anchor" href="#hot_rod_protocol_1_1"></a>Hot Rod Protocol 1.1</h5> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Infinispan versions</div> This version of the protocol is implemented since Infinispan 5.1.0.FINAL </td> </tr> </table> </div> <div class="sect5"> <h6 id="request_header_2"><a class="anchor" href="#request_header_2"></a>Request Header</h6> <div class="paragraph"> <p>The <code>version</code> field in the header is updated to <code>11</code>.</p> </div> </div> </div> <div class="sect4"> <h5 id="distribution_aware_client_topology_change_header_2"><a class="anchor" href="#distribution_aware_client_topology_change_header_2"></a>Distribution-Aware Client Topology Change Header</h5> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="fa icon-important" title="Important"></i> </td> <td class="content"> <div class="title">Updated for 1.1</div> This section has been modified to be more efficient when talking to distributed caches with virtual nodes enabled. </td> </tr> </table> </div> <div class="paragraph"> <p>This is what hash-distribution-aware clients receive as response header when a topology change is sent back:</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header with topology change marker</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">See previous section.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Topology Id</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Topology ID</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Num Key Owners</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">2 bytes (Unsigned Short)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Globally configured number of copies for each Infinispan distributed key</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Hash Function Version</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Hash function version, pointing to a specific hash function in use. See <a href="#_hot_rod_hash_functions">Hot Rod hash functions</a> for details.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Hash space size</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Modulus used by Infinispan for for all module arithmetic related to hash code generation. Clients will likely require this information in order to apply the correct hash calculation to the keys.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Num servers in topology</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of Infinispan Hot Rod servers running within the cluster. This could be a subset of the entire cluster if only a fraction of those nodes are running Hot Rod servers.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Num Virtual Nodes Owners</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Field added in version 1.1 of the protocol that represents the number of configured virtual nodes. If no virtual nodes are configured or the cache is not configured with distribution, this field will contain 0.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m1: Host/IP length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of hostname or IP address of individual cluster member that Hot Rod client can use to access it. Using variable length here allows for covering for hostnames, IPv4 and IPv6 addresses.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m1: Host/IP address</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">String containing hostname or IP address of individual cluster member that Hot Rod client can use to access it.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m1: Port</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">2 bytes (Unsigned Short)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Port that Hot Rod clients can use to communicat with this cluster member.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m1: Hashcode</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">4 bytes</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">32 bit integer representing the hashcode of a cluster member that a Hot Rod client can use indentify in which cluster member a key is located having applied the CSA to it.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m2: Host/IP length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m2: Host/IP address</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m2: Port</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">2 bytes (Unsigned Short)</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m2: Hashcode</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">4 bytes</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;etc</p></td> <td class="tableblock halign-center valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> </tbody> </table> </div> <div class="sect4"> <h5 id="server_node_hash_code_calculation"><a class="anchor" href="#server_node_hash_code_calculation"></a>Server node hash code calculation</h5> <div class="paragraph"> <p>Adding support for virtual nodes has made version 1.0 of the Hot Rod protocol impractical due to bandwidth it would have taken to return hash codes for all virtual nodes in the clusters (this number could easily be in the millions). So, as of version 1.1 of the Hot Rod protocol, clients are given the base hash id or hash code of each server, and then they have to calculate the real hash position of each server both with and without virtual nodes configured. Here are the rules clients should follow when trying to calculate a node&#8217;s hash code:</p> </div> <div class="paragraph"> <p>1. With <em>virtual nodes disabled</em> : Once clients have received the base hash code of the server, they need to normalize it in order to find the exact position of the hash wheel. The process of normalization involves passing the base hash code to the hash function, and then do a small calculation to avoid negative values. The resulting number is the node&#8217;s position in the hash wheel:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">int</span> getNormalizedHash(<span class="type">int</span> nodeBaseHashCode, Hash hashFct) {
   <span class="keyword">return</span> hashFct.hash(nodeBaseHashCode) &amp; <span class="predefined-type">Integer</span>.MAX_VALUE; <span class="comment">// make sure no negative numbers are involved.</span>
}</code></pre> </div> </div> <div class="paragraph"> <p>2. With <em>virtual nodes enabled</em> : In this case, each node represents N different virtual nodes, and to calculate each virtual node&#8217;s hash code, we need to take the the range of numbers between 0 and N-1 and apply the following logic:</p> </div> <div class="ulist"> <ul> <li> <p>For virtual node with 0 as id, use the technique used to retrieve a node&#8217;s hash code, as shown in the previous section.</p> </li> <li> <p>For virtual nodes from 1 to N-1 ids, execute the following logic:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">int</span> virtualNodeHashCode(<span class="type">int</span> nodeBaseHashCode, <span class="type">int</span> id, Hash hashFct) {
   <span class="type">int</span> virtualNodeBaseHashCode = id;
   virtualNodeBaseHashCode = <span class="integer">31</span> * virtualNodeBaseHashCode + nodeBaseHashCode;
   <span class="keyword">return</span> getNormalizedHash(virtualNodeBaseHashCode, hashFct);
}</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="hot_rod_protocol_1_2"><a class="anchor" href="#hot_rod_protocol_1_2"></a>Hot Rod Protocol 1.2</h5> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Infinispan versions</div> This version of the protocol is implemented since Infinispan 5.2.0.Final. Since Infinispan 5.3.0, HotRod supports encryption via SSL. However, since this only affects the transport, the version number of the protocol has not been incremented. </td> </tr> </table> </div> <div class="sect5"> <h6 id="request_header_3"><a class="anchor" href="#request_header_3"></a>Request Header</h6> <div class="paragraph"> <p>The <code>version</code> field in the header is updated to <code>12</code>.</p> </div> <div class="paragraph"> <p>Two new request operation codes have been added:</p> </div> <div class="ulist"> <ul> <li> <p>0x1B = getWithMetadata request</p> </li> <li> <p>0x1D = bulkKeysGet request</p> </li> </ul> </div> <div class="paragraph"> <p>Two new flags have been added too:</p> </div> <div class="ulist"> <ul> <li> <p>0x0002 = use cache-level configured default lifespan</p> </li> <li> <p>0x0004 = use cache-level configured default max idle</p> </li> </ul> </div> </div> <div class="sect5"> <h6 id="response_header_2"><a class="anchor" href="#response_header_2"></a>Response Header</h6> <div class="paragraph"> <p>Two new response operation codes have been added:</p> </div> <div class="ulist"> <ul> <li> <p>0x1C = getWithMetadata response</p> </li> <li> <p>0x1E = bulkKeysGet response</p> </li> </ul> </div> </div> <div class="sect5"> <h6 id="operations_2"><a class="anchor" href="#operations_2"></a>Operations</h6> <div class="paragraph"> <div class="title">GetWithMetadata</div> <p>Request (0x1B):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of key. Note that the size of a vint can be up to 5 bytes which in theory can produce bigger numbers than Integer.MAX_VALUE. However, Java cannot create a single array thatâs bigger than Integer.MAX_VALUE, hence the protocol is limiting vint array lengths to Integer.MAX_VALUE.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Byte array containing the key whose value is being requested.</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Response (0x1C):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if key retrieved<br> 0x02 = if key does not exist<br></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Flag</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">A flag indicating whether the response contains expiration information. The value of the flag is obtained as a bitwise OR operation between INFINITE_LIFESPAN (0x01) and <code>INFINITE_MAXIDLE (0x02)</code>.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Created</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">Long</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">(optional) a Long representing the timestamp when the entry was created on the server. This value is returned only if the flag&#8217;s INFINITE_LIFESPAN bit is not set.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Lifespan</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">(optional) a vInt representing the lifespan of the entry in seconds. This value is returned only if the flag&#8217;s INFINITE_LIFESPAN bit is not set.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">LastUsed</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">Long</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">(optional) a Long representing the timestamp when the entry was last accessed on the server. This value is returned only if the flag&#8217;s <code>INFINITE_MAXIDLE</code> bit is not set.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">MaxIdle</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">(optional) a vInt representing the maxIdle of the entry in seconds. This value is returned only if the flag&#8217;s <code>INFINITE_MAXIDLE</code> bit is not set.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry Version</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">8 bytes</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Unique value of an existing entry&#8217;s modification. The protocol does not mandate that entry_version values are sequential. They just need to be unique per update at the key level.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If success, length of value</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If success, the requested value</p></td> </tr> </tbody> </table> <div class="paragraph"> <div class="title">BulkKeysGet</div> <p>Request (0x1D):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Scope</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0 = Default Scope - This scope is used by RemoteCache.keySet() method. If the remote cache is a distributed cache, the server launch a stream operation to retrieve all keys from all of the nodes. (Remember, a topology-aware Hot Rod Client could be load balancing the request to any one node in the cluster). Otherwise, it&#8217;ll get keys from the cache instance local to the server receiving the request (that is because the keys should be the same across all nodes in a replicated cache).<br> 1 = Global Scope - This scope behaves the same to Default Scope.<br> 2 = Local Scope - In case when remote cache is a distributed cache, the server will not launch a stream operation to retrieve keys from all nodes. Instead, it&#8217;ll only get keys local from the cache instance local to the server receiving the request.<br></p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Response (0x1E):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, data follows<br></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">More</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">One byte representing whether more keys need to be read from the stream. So, when it&#8217;s set to 1, it means that an entry follows, whereas when it&#8217;s set to 0, it&#8217;s the end of stream and no more entries are left to read. For more information on BulkGet look <a href="http://community.jboss.org/docs/DOC-15592">here</a></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 1 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of key</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 1</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Retrieved key</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">More</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 2 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 2</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203; etc</p></td> <td class="tableblock halign-center valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> </tbody> </table> </div> </div> <div class="sect4"> <h5 id="hot_rod_protocol_1_3"><a class="anchor" href="#hot_rod_protocol_1_3"></a>Hot Rod Protocol 1.3</h5> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Infinispan versions</div> This version of the protocol is implemented since Infinispan 6.0.0.Final. </td> </tr> </table> </div> <div class="sect5"> <h6 id="request_header_4"><a class="anchor" href="#request_header_4"></a>Request Header</h6> <div class="paragraph"> <p>The <code>version</code> field in the header is updated to <code>13</code>.</p> </div> <div class="paragraph"> <p>A new request operation code has been added:</p> </div> <div class="ulist"> <ul> <li> <p>0x1F = query request</p> </li> </ul> </div> </div> <div class="sect5"> <h6 id="response_header_3"><a class="anchor" href="#response_header_3"></a>Response Header</h6> <div class="paragraph"> <p>A new response operation code has been added:</p> </div> <div class="ulist"> <ul> <li> <p>0x20 = query response</p> </li> </ul> </div> </div> <div class="sect5"> <h6 id="operations_3"><a class="anchor" href="#operations_3"></a>Operations</h6> <div class="paragraph"> <div class="title">Query</div> <p>Request (0x1F):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Query Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The length of the protobuf encoded query object</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Query</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Byte array containing the protobuf encoded query object, having a length specified by previous field.</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Response (0x20):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response payload Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The length of the protobuf encoded response object</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response payload</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Byte array containing the protobuf encoded response object, having a length specified by previous field.</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>As of Infinispan 6.0, the query and response objects are specified by the protobuf message types 'org.infinispan.client.hotrod.impl.query.QueryRequest' and 'org.infinispan.client.hotrod.impl.query.QueryResponse' defined in <a href="https://github.com/infinispan/infinispan/blob/master/remote-query/remote-query-client/src/main/resources/org/infinispan/query/remote/client/query.proto">remote-query/remote-query-client/src/main/resources/org/infinispan/query/remote/client/query.proto</a>. These definitions could change in future Infinispan versions, but as long as these evolutions will be kept backward compatible (according to the rules defined <a href="https://developers.google.com/protocol-buffers/docs/proto#updating">here</a>) no new Hot Rod protocol version will be introduced to accommodate this.</p> </div> </div> </div> <div class="sect4"> <h5 id="hot_rod_protocol_2_0"><a class="anchor" href="#hot_rod_protocol_2_0"></a>Hot Rod Protocol 2.0</h5> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Infinispan versions</div> This version of the protocol is implemented since Infinispan 7.0.0.Final. </td> </tr> </table> </div> <div class="sect5"> <h6 id="request_header_5"><a class="anchor" href="#request_header_5"></a>Request Header</h6> <div class="paragraph"> <p>The request header no longer contains <code>Transaction Type</code> and <code>Transaction ID</code> elements since they&#8217;re not in use, and even if they were in use, there are several operations for which they would not make sense, such as <code>ping</code> or <code>stats</code> commands. Once transactions are implemented, the protocol version will be upped, with the necessary changes in the request header.</p> </div> <div class="paragraph"> <p>The <code>version</code> field in the header is updated to <code>20</code>.</p> </div> <div class="paragraph"> <p>Two new flags have been added:</p> </div> <div class="ulist"> <ul> <li> <p>0x0008 = operation skips loading from configured cache loader.</p> </li> <li> <p>0x0010 = operation skips indexing. Only relevant when the query module is enabled for the cache</p> </li> </ul> </div> <div class="paragraph"> <p>The following new request operation codes have been added:</p> </div> <div class="ulist"> <ul> <li> <p>0x21 = auth mech list request</p> </li> <li> <p>0x23 = auth request</p> </li> <li> <p>0x25 = add client remote event listener request</p> </li> <li> <p>0x27 = remove client remote event listener request</p> </li> <li> <p>0x29 = size request</p> </li> </ul> </div> </div> <div class="sect5"> <h6 id="response_header_4"><a class="anchor" href="#response_header_4"></a>Response Header</h6> <div class="paragraph"> <p>The following new response operation codes have been added:</p> </div> <div class="ulist"> <ul> <li> <p>0x22 = auth mech list response</p> </li> <li> <p>0x24 = auth mech response</p> </li> <li> <p>0x26 = add client remote event listener response</p> </li> <li> <p>0x28 = remove client remote event listener response</p> </li> <li> <p>0x2A = size response</p> </li> </ul> </div> <div class="paragraph"> <p>Two new error codes have also been added to enable clients more intelligent decisions, particularly when it comes to fail-over logic:</p> </div> <div class="ulist"> <ul> <li> <p>0x87 = Node suspected. When a client receives this error as response, it means that the node that responded had an issue sending an operation to a third node, which was suspected. Generally, requests that return this error should be failed-over to other nodes.</p> </li> <li> <p>0x88 = Illegal lifecycle state. When a client receives this error as response, it means that the server-side cache or cache manager are not available for requests because either stopped, they&#8217;re stopping or similar situation. Generally, requests that return this error should be failed-over to other nodes.</p> </li> </ul> </div> <div class="paragraph"> <p>Some adjustments have been made to the responses for the following commands in order to better handle response decoding without the need to keep track of the information sent. More precisely, the way previous values are parsed has changed so that the status of the command response provides clues on whether the previous value follows or not. More precisely:</p> </div> <div class="ulist"> <ul> <li> <p>Put response returns <code>0x03</code> status code when put was successful and previous value follows.</p> </li> <li> <p>PutIfAbsent response returns <code>0x04</code> status code only when the putIfAbsent operation failed because the key was present and its value follows in the response. If the putIfAbsent worked, there would have not been a previous value, and hence it does not make sense returning anything extra.</p> </li> <li> <p>Replace response returns <code>0x03</code> status code only when replace happened and the previous or replaced value follows in the response. If the replace did not happen, it means that the cache entry was not present, and hence there&#8217;s no previous value that can be returned.</p> </li> <li> <p>ReplaceIfUnmodified returns <code>0x03</code> status code only when replace happened and the previous or replaced value follows in the response.</p> </li> <li> <p>ReplaceIfUnmodified returns <code>0x04</code> status code only when replace did not happen as a result of the key being modified, and the modified value follows in the response.</p> </li> <li> <p>Remove returns <code>0x03</code> status code when the remove happened and the previous or removed value follows in the response. If the remove did not occur as a result of the key not being present, it does not make sense sending any previous value information.</p> </li> <li> <p>RemoveIfUnmodified returns <code>0x03</code> status code only when remove happened and the previous or replaced value follows in the response.</p> </li> <li> <p>RemoveIfUnmodified returns <code>0x04</code> status code only when remove did not happen as a result of the key being modified, and the modified value follows in the response.</p> </li> </ul> </div> </div> </div> <div class="sect4"> <h5 id="distribution_aware_client_topology_change_header_3"><a class="anchor" href="#distribution_aware_client_topology_change_header_3"></a>Distribution-Aware Client Topology Change Header</h5> <div class="paragraph"> <p>In Infinispan 5.2, virtual nodes based consistent hashing was abandoned and instead segment based consistent hash was implemented. In order to satisfy the ability for Hot Rod clients to find data as reliably as possible, Infinispan has been transforming the segment based consistent hash to fit Hot Rod 1.x protocol. Starting with version 2.0, a brand new distribution-aware topology change header has been implemented which suppors segment based consistent hashing suitably and provides 100% data location guarantees.</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header with topology change marker</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Topology Id</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Topology ID</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Num servers in topology</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of Infinispan Hot Rod servers running within the cluster. This could be a subset of the entire cluster if only a fraction of those nodes are running Hot Rod servers.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m1: Host/IP length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of hostname or IP address of individual cluster member that Hot Rod client can use to access it. Using variable length here allows for covering for hostnames, IPv4 and IPv6 addresses.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m1: Host/IP address</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">String containing hostname or IP address of individual cluster member that Hot Rod client can use to access it.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m1: Port</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">2 bytes (Unsigned Short)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Port that Hot Rod clients can use to communicat with this cluster member.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m2: Host/IP length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m2: Host/IP address</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">m2: Port</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">2 bytes (Unsigned Short)</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">&#8230;&#8203;</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Hash Function Version</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Hash function version, pointing to a specific hash function in use. See <a href="#_hot_rod_hash_functions">Hot Rod hash functions</a> for details.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Num segments in topology</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Total number of segments in the topology</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of owners in segment</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">This can be either 0, 1 or 2 owners.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">First owner&#8217;s index</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Given the list of all nodes, the position of this owner in this list. This is only present if number of owners for this segment is 1 or 2.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Second owner&#8217;s index</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Given the list of all nodes, the position of this owner in this list. This is only present if number of owners for this segment is 2.</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Given this information, Hot Rod clients should be able to recalculate all the hash segments and be able to find out which nodes are owners for each segment. Even though there could be more than 2 owners per segment, Hot Rod protocol limits the number of owners to send for efficiency reasons.</p> </div> <div class="sect5"> <h6 id="operations_4"><a class="anchor" href="#operations_4"></a>Operations</h6> <div class="paragraph"> <div class="title">Auth Mech List</div> <p>Request (0x21):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Response (0x22):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Mech count</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The number of mechs</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Mech 1</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">String containing the name of the SASL mech in its IANA-registered form (e.g. GSSAPI, CRAM-MD5, etc)</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Mech 2</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;etc</p></td> <td class="tableblock halign-center valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> </tbody> </table> <div class="paragraph"> <p>The purpose of this operation is to obtain the list of valid SASL authentication mechs supported by the server. The client will then need to issue an Authenticate request with the preferred mech.</p> </div> <div class="paragraph"> <div class="title">Authenticate</div> <p>Request (0x23):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Mech</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">String containing the name of the mech chosen by the client for authentication. Empty on the successive invocations</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of the SASL client response</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response data</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The SASL client response</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Response (0x24):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Completed</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0 if further processing is needed, 1 if authentication is complete</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Challenge length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of the SASL server challenge</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Challenge data</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The SASL server challenge</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>The purpose of this operation is to authenticate a client against a server using SASL. The authentication process, depending on the chosen mech, might be a multi-step operation. Once complete the connection becomes authenticated</p> </div> <div class="paragraph"> <div class="title">Add client listener for remote events</div> <p>Request (0x25):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Listener ID</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Listener identifier</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Include state</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">When this byte is set to <code>1</code>, cached state is sent back to remote clients when either adding a cache listener for the first time, or when the node where a remote listener is registered changes in a clustered environment. When enabled, state is sent back as cache entry created events to the clients. If set to <code>0</code>, no state is sent back to the client when adding a listener, nor it gets state when the node where the listener is registered changes.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key/value filter factory name</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Optional name of the key/value filter factory to be used with this listener. The factory is used to create key/value filter instances which allow events to be filtered directly in the Hot Rod server, avoiding sending events that the client is not interested in. If no factory is to be used, the length of the string is <code>0</code>.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key/value filter factory parameter count</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The key/value filter factory, when creating a filter instance, can take an arbitrary number of parameters, enabling the factory to be used to create different filter instances dynamically. This count field indicates how many parameters will be passed to the factory. If no factory name was provided, this field is not present in the request.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key/value filter factory parameter 1</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">First key/value filter factory parameter</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key/value filter factory parameter 2</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Second key/value filter factory parameter</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td> <td class="tableblock halign-center valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Converter factory name</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Optional name of the converter factory to be used with this listener. The factory is used to transform the contents of the events sent to clients. By default, when no converter is in use, events are well defined, according to the type of event generated. However, there might be situations where users want to add extra information to the event, or they want to reduce the size of the events. In these cases, a converter can be used to transform the event contents. The given converter factory name produces converter instances to do this job. If no factory is to be used, the length of the string is <code>0</code>.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Converter factory parameter count</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The converter factory, when creating a converter instance, can take an arbitrary number of parameters, enabling the factory to be used to create different converter instances dynamically. This count field indicates how many parameters will be passed to the factory. If no factory name was provided, this field is not present in the request.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Converter factory parameter 1</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">First converter factory parameter</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Converter factory parameter 2</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Second converter factory parameter</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td> <td class="tableblock halign-center valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> </tbody> </table> <div class="paragraph"> <p>Response (0x26):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> </tbody> </table> <div class="paragraph"> <div class="title">Remove client listener for remote events</div> <p>Request (0x27):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Listener ID</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Listener identifier</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Response (0x28):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> </tbody> </table> <div class="paragraph"> <div class="title">Size</div> <p>Request (0x29):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Response (0x2A):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Size</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Size of the remote cache, which is calculated globally in the clustered set ups, and if present, takes cache store contents into account as well.</p></td> </tr> </tbody> </table> <div class="paragraph"> <div class="title">Exec</div> <p>Request (0x2B):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Script</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Name of the script to execute</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Parameter Count</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The number of parameters</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Parameter 1 Name</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The name of the first parameter</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Parameter 1 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The length of the first parameter</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Parameter 1 Value</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The value of the first parameter</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Response (0x2C):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if execution completed successfully<br> 0x85 = server error<br></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If success, length of return value</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If success, the result of the execution</p></td> </tr> </tbody> </table> </div> <div class="sect5"> <h6 id="remote_events"><a class="anchor" href="#remote_events"></a>Remote Events</h6> <div class="paragraph"> <p>Starting with Hot Rod 2.0, clients can register listeners for remote events happening in the server. Sending these events commences the moment a client adds a client listener for remote events.</p> </div> <div class="paragraph"> <p>Event Header:</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Magic</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0xA1 = response</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Message ID</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vLong</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ID of event</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Opcode</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Event type:<br> 0x60 = cache entry created event<br> 0x61 = cache entry modified event<br> 0x62 = cache entry removed event<br> 0x50 = error<br></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Status</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Status of the response, possible values:<br> 0x00 = No error<br></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Topology Change Marker</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Since events are not associated with a particular incoming topology ID to be able to decide whether a new topology is required to be sent or not, new topologies will never be sent with events. Hence, this marker will always have <code>0</code> value for events.</p></td> </tr> </tbody> </table> <table class="tableblock frame-all grid-all spread"> <caption class="title">Table 6. Cache entry created event</caption> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Event header with <code>0x60</code> operation code</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Listener ID</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Listener for which this event is directed</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Custom marker</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Custom event marker. For created events, this is <code>0</code>.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Command retried</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Marker for events that are result of retried commands. If command is retried, it returns <code>1</code>, otherwise <code>0</code>.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Created key</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Version</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">long</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Version of the created entry. This version information can be used to make conditional operations on this cache entry.</p></td> </tr> </tbody> </table> <table class="tableblock frame-all grid-all spread"> <caption class="title">Table 7. Cache entry modified event</caption> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Event header with <code>0x61</code> operation code</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Listener ID</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Listener for which this event is directed</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Custom marker</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Custom event marker. For created events, this is <code>0</code>.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Command retried</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Marker for events that are result of retried commands. If command is retried, it returns <code>1</code>, otherwise <code>0</code>.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Modified key</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Version</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">long</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Version of the modified entry. This version information can be used to make conditional operations on this cache entry.</p></td> </tr> </tbody> </table> <table class="tableblock frame-all grid-all spread"> <caption class="title">Table 8. Cache entry removed event</caption> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Event header with <code>0x62</code> operation code</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Listener ID</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Listener for which this event is directed</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Custom marker</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Custom event marker. For created events, this is <code>0</code>.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Command retried</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Marker for events that are result of retried commands. If command is retried, it returns <code>1</code>, otherwise <code>0</code>.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Removed key</p></td> </tr> </tbody> </table> <table class="tableblock frame-all grid-all spread"> <caption class="title">Table 9. Custom event</caption> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Event header with event specific operation code</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Listener ID</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Listener for which this event is directed</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Custom marker</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Custom event marker. For custom events, this is <code>1</code>.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Event data</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Custom event data, formatted according to the converter implementation logic.</p></td> </tr> </tbody> </table> </div> </div> <div class="sect4"> <h5 id="hot_rod_protocol_2_1"><a class="anchor" href="#hot_rod_protocol_2_1"></a>Hot Rod Protocol 2.1</h5> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Infinispan versions</div> This version of the protocol is implemented since Infinispan 7.1.0.Final. </td> </tr> </table> </div> <div class="sect5"> <h6 id="request_header_6"><a class="anchor" href="#request_header_6"></a>Request Header</h6> <div class="paragraph"> <p>The <code>version</code> field in the header is updated to <code>21</code>.</p> </div> </div> <div class="sect5"> <h6 id="operations_5"><a class="anchor" href="#operations_5"></a>Operations</h6> <div class="paragraph"> <div class="title">Add client listener for remote events</div> <p>An extra byte parameter is added at the end which indicates whether the client prefers client listener to work with raw binary data for filter/converter callbacks. If using raw data, its value is <code>1</code> otherwise <code>0</code>.</p> </div> <div class="paragraph"> <p>Request format:</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Listener ID</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Include state</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key/value filter factory parameter count</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td> <td class="tableblock halign-center valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Converter factory name</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Converter factory parameter count</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td> <td class="tableblock halign-center valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Use raw data</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If filter/converter parameters should be raw binary, then <code>1</code>, otherwise <code>0</code>.</p></td> </tr> </tbody> </table> <div class="paragraph"> <div class="title">Custom event</div> <p>Starting with Hot Rod 2.1, custom events can return raw data that the Hot Rod client should not try to unmarshall before passing it on to the user. The way this is transmitted to the Hot Rod client is by sending <code>2</code> as the custom event marker. So, the format of the custom event remains like this:</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Event header with event specific operation code</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Listener ID</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Listener for which this event is directed</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Custom marker</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Custom event marker. For custom events whose event data needs to be unmarshalled before returning to user the value is <code>1</code>. For custom events that need to return the event data as-is to the user, the value is <code>2</code>.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Event data</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Custom event data. If the custom marker is <code>1</code>, the bytes represent the marshalled version of the instance returned by the converter. If custom marker is <code>2</code>, it represents the byte array, as returned by the converter.</p></td> </tr> </tbody> </table> </div> </div> <div class="sect4"> <h5 id="hot_rod_protocol_2_2"><a class="anchor" href="#hot_rod_protocol_2_2"></a>Hot Rod Protocol 2.2</h5> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Infinispan versions</div> This version of the protocol is implemented since Infinispan 8.0 </td> </tr> </table> </div> <div class="paragraph"> <p>Added support for different time units.</p> </div> <div class="sect5"> <h6 id="operations_6"><a class="anchor" href="#operations_6"></a>Operations</h6> <div class="paragraph"> <div class="title">Put/PutAll/PutIfAbsent/Replace/ReplaceIfUnmodified</div> <p>Common request format:</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">TimeUnits</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">Byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Time units of lifespan (first 4 bits) and maxIdle (last 4 bits). Special units DEFAULT and INFINITE can be used for default server expiration and no expiration respectively. Possible values:<br> 0x00 = SECONDS<br> 0x01 = MILLISECONDS<br> 0x02 = NANOSECONDS<br> 0x03 = MICROSECONDS<br> 0x04 = MINUTES<br> 0x05 = HOURS<br> 0x06 = DAYS<br> 0x07 = DEFAULT<br> 0x08 = INFINITE<br></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Lifespan</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vLong</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Duration which the entry is allowed to life. Only sent when time unit is not DEFAULT or INFINITE</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Max Idle</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vLong</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Duration that each entry can be idle before it&#8217;s evicted from the cache. Only sent when time unit is not DEFAULT or INFINITE</p></td> </tr> </tbody> </table> </div> </div> <div class="sect4"> <h5 id="hot_rod_protocol_2_3"><a class="anchor" href="#hot_rod_protocol_2_3"></a>Hot Rod Protocol 2.3</h5> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Infinispan versions</div> This version of the protocol is implemented since Infinispan 8.0 </td> </tr> </table> </div> <div class="sect5"> <h6 id="operations_7"><a class="anchor" href="#operations_7"></a>Operations</h6> <div class="paragraph"> <div class="title">Iteration Start</div> <p>Request (0x31):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Segments size</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">signed vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Size of the bitset encoding of the segments ids to iterate on. The size is the maximum segment id rounded to nearest multiple of 8.<br> A value -1 indicates no segment filtering is to be done</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Segments</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">(Optional) Contains the segments ids bitset encoded, where each bit with value 1 represents a segment in the set. Byte order is little-endian.<br> Example: segments [1,3,12,13] would result in the following encoding:<br> 00001010 00110000<br> size: 16 bits<br> first byte: represents segments from 0 to 7, from which 1 and 3 are set<br> second byte: represents segments from 8 to 15, from which 12 and 13 are set<br> More details in the java.util.BitSet implementation. Segments will be sent if the previous field is not negative</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">FilterConverter size</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">signed vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The size of the String representing a KeyValueFilterConverter factory name deployed on the server, or -1 if no filter will be used</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">FilterConverter</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">UTF-8 byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">(Optional) KeyValueFilterConverter factory name deployed on the server. Present if previous field is not negative</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">BatchSize</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">number of entries to transfers from the server at one go</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Response (0x32):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">IterationId</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">String</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The unique id of the iteration</p></td> </tr> </tbody> </table> <div class="paragraph"> <div class="title">Iteration Next</div> <p>Request (0x33):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">IterationId</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">String</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The unique id of the iteration</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Response (0x34):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Finished segments size</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">size of the bitset representing segments that were finished iterating</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Finished segments</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">bitset encoding of the segments that were finished iterating</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry count</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">How many entries are being returned</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 1 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of key</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 1</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Retrieved key</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 1 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Length of value</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 1</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Retrieved value</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 2 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 2</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 2 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 2</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203; continues until entry count is reached</p></td> <td class="tableblock halign-center valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> </tbody> </table> <div class="paragraph"> <div class="title">Iteration End</div> <p>Request (0x35):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">IterationId</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">String</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The unique id of the iteration</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Response (0x36):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Header</th> <th class="tableblock halign-center valign-top">variable</th> <th class="tableblock halign-left valign-top">Response header</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if execution completed successfully<br> 0x05 = for non existent IterationId <br></p></td> </tr> </tbody> </table> </div> </div> <div class="sect4"> <h5 id="hot_rod_protocol_2_4"><a class="anchor" href="#hot_rod_protocol_2_4"></a>Hot Rod Protocol 2.4</h5> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Infinispan versions</div> This version of the protocol is implemented since Infinispan 8.1 </td> </tr> </table> </div> <div class="paragraph"> <p>This Hot Rod protocol version adds three new status code that gives the client hints on whether the server has compatibility mode enabled or not:</p> </div> <div class="ulist"> <ul> <li> <p><code>0x06</code>: Success status and compatibility mode is enabled.</p> </li> <li> <p><code>0x07</code>: Success status and return previous value, with compatibility mode is enabled.</p> </li> <li> <p><code>0x08</code>: Not executed and return previous value, with compatibility mode is enabled.</p> </li> </ul> </div> <div class="paragraph"> <p>The Iteration Start operation can optionally send parameters if a custom filter is provided and it&#8217;s parametrised:</p> </div> <div class="sect5"> <h6 id="operations_8"><a class="anchor" href="#operations_8"></a>Operations</h6> <div class="paragraph"> <div class="title">Iteration Start</div> <p>Request (0x31):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Segments size</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">signed vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Segments</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">FilterConverter size</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">signed vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">FilterConverter</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">UTF-8 byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Parameters size</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">the number of params of the filter. Only present when FilterConverter is provided.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Parameters</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte[][]</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">an array of parameters, each parameter is a byte array. Only present if Parameters size is greater than 0.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">BatchSize</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>The Iteration Next operation can optionally return projections in the value, meaning more than one value is contained in the same entry.</p> </div> <div class="paragraph"> <div class="title">Iteration Next</div> <p>Response (0x34):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Finished segments size</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Finished segments</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry count</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of value projections</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of projections for the values. If 1, behaves like version protocol version 2.3.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key1 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key1</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value1 projection1 length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">length of value1 first projection</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value1 projection1</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">retrieved value1 first projection</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value1 projection2 length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">length of value2 second projection</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value1 projection2</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">retrieved value2 second projection</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203; continues until all projections for the value retrieved</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">Key2 Length</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">vInt</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">Key2</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">byte array</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">Value2 projection1 length</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">vInt</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">length of value 2 first projection</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">Value2 projection1</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">byte array</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">retrieved value 2 first projection</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">Value2 projection2 length</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">vInt</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">length of value 2 second projection</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">Value2 projection2</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">byte array</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">retrieved value 2 second projection</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">&#8230;&#8203; continues until entry count is reached</p></td> <td class="tableblock halign-left valign-top"></td> </tr> </tbody> </table> <div class="olist arabic"> <ol class="arabic"> <li> <p>Stats:</p> </li> </ol> </div> <div class="paragraph"> <p>Statistics returned by previous Hot Rod protocol versions were local to the node where the Hot Rod operation had been called. Starting with 2.4, new statistics have been added which provide global counts for the statistics returned previously. If the Hot Rod is running in local mode, these statistics are not returned:</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Name</th> <th class="tableblock halign-left valign-top">Explanation</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">globalCurrentNumberOfEntries</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of entries currently across the Hot Rod cluster.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">globalStores</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Total number of put operations across the Hot Rod cluster.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">globalRetrievals</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Total number of get operations across the Hot Rod cluster.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">globalHits</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Total number of get hits across the Hot Rod cluster.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">globalMisses</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Total number of get misses across the Hot Rod cluster.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">globalRemoveHits</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Total number of removal hits across the Hot Rod cluster.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">globalRemoveMisses</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Total number of removal misses across the Hot Rod cluster.</p></td> </tr> </tbody> </table> </div> </div> <div class="sect4"> <h5 id="hot_rod_protocol_2_5"><a class="anchor" href="#hot_rod_protocol_2_5"></a>Hot Rod Protocol 2.5</h5> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Infinispan versions</div> This version of the protocol is implemented since Infinispan 8.2.0 </td> </tr> </table> </div> <div class="paragraph"> <p>This Hot Rod protocol version adds support for metadata retrieval along with entries in the iterator. It includes two changes:</p> </div> <div class="ulist"> <ul> <li> <p>Iteration Start request includes an optional flag</p> </li> <li> <p>IterationNext operation may include metadata info for each entry if the flag above is set</p> </li> </ul> </div> <div class="paragraph"> <div class="title">Iteration Start</div> <p>Request (0x31):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Segments size</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">signed vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Segments</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">FilterConverter size</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">signed vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">FilterConverter</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">UTF-8 byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Parameters size</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Parameters</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte[][]</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">BatchSize</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Metadata</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1 if metadata is to be returned for each entry, 0 otherwise</p></td> </tr> </tbody> </table> <div class="paragraph"> <div class="title">Iteration Next</div> <p>Response (0x34):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Finished segments size</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Finished segments</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry count</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Number of value projections</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Metadata (entry 1)</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If set, entry has metadata associated</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Expiration (entry 1)</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">A flag indicating whether the response contains expiration information. The value of the flag is obtained as a bitwise OR operation between INFINITE_LIFESPAN (0x01) and <code>INFINITE_MAXIDLE (0x02)</code>. Only present if the metadata flag above is set</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Created (entry 1)</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">Long</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">(optional) a Long representing the timestamp when the entry was created on the server. This value is returned only if the flag&#8217;s INFINITE_LIFESPAN bit is not set.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Lifespan (entry 1)</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">(optional) a vInt representing the lifespan of the entry in seconds. This value is returned only if the flag&#8217;s INFINITE_LIFESPAN bit is not set.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">LastUsed (entry 1)</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">Long</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">(optional) a Long representing the timestamp when the entry was last accessed on the server. This value is returned only if the flag&#8217;s <code>INFINITE_MAXIDLE</code> bit is not set.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">MaxIdle (entry 1)</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">(optional) a vInt representing the maxIdle of the entry in seconds. This value is returned only if the flag&#8217;s <code>INFINITE_MAXIDLE</code> bit is not set.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry Version (entry 1)</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">8 bytes</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Unique value of an existing entry&#8217;s modification. Only present if Metadata flag is set</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 1 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 1</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 1 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 1</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Metadata (entry 2)</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Same as for entry 1</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Expiration (entry 2)</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Same as for entry 1</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Created (entry 2)</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">Long</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Same as for entry 1</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Lifespan (entry 2)</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Same as for entry 1</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">LastUsed (entry 2)</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">Long</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Same as for entry 1</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">MaxIdle (entry 2)</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Same as for entry 1</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry Version (entry 2)</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">8 bytes</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Same as for entry 1</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 2 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key 2</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 2 Length</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Value 2</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203; continues until entry count is reached</p></td> <td class="tableblock halign-center valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> </tbody> </table> </div> <div class="sect4"> <h5 id="hot_rod_protocol_2_6"><a class="anchor" href="#hot_rod_protocol_2_6"></a>Hot Rod Protocol 2.6</h5> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Infinispan versions</div> This version of the protocol is implemented since Infinispan 8.2.6 </td> </tr> </table> </div> <div class="paragraph"> <p>This Hot Rod protocol version improves remote listener registration by adding a byte that indicates at a global level, which type of events the client is interested in. For example, a client can indicate that only created events, or only expiration and removal events&#8230;&#8203;etc. More fine grained event interests, e.g. per key, can be defined using the key/value filter parameter.</p> </div> <div class="paragraph"> <p>So, the new add listener request looks like this:</p> </div> <div class="paragraph"> <div class="title">Add client listener for remote events</div> <p>Request (0x25):</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 20%;"> <col style="width: 13%;"> <col style="width: 66%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Name</th> <th class="tableblock halign-center valign-top">Size</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Listener ID</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Listener identifier</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Include state</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">When this byte is set to <code>1</code>, cached state is sent back to remote clients when either adding a cache listener for the first time, or when the node where a remote listener is registered changes in a clustered environment. When enabled, state is sent back as cache entry created events to the clients. If set to <code>0</code>, no state is sent back to the client when adding a listener, nor it gets state when the node where the listener is registered changes.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key/value filter factory name</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Optional name of the key/value filter factory to be used with this listener. The factory is used to create key/value filter instances which allow events to be filtered directly in the Hot Rod server, avoiding sending events that the client is not interested in. If no factory is to be used, the length of the string is <code>0</code>.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key/value filter factory parameter count</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The key/value filter factory, when creating a filter instance, can take an arbitrary number of parameters, enabling the factory to be used to create different filter instances dynamically. This count field indicates how many parameters will be passed to the factory. If no factory name was provided, this field is not present in the request.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key/value filter factory parameter 1</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">First key/value filter factory parameter</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Key/value filter factory parameter 2</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Second key/value filter factory parameter</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td> <td class="tableblock halign-center valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Converter factory name</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Optional name of the converter factory to be used with this listener. The factory is used to transform the contents of the events sent to clients. By default, when no converter is in use, events are well defined, according to the type of event generated. However, there might be situations where users want to add extra information to the event, or they want to reduce the size of the events. In these cases, a converter can be used to transform the event contents. The given converter factory name produces converter instances to do this job. If no factory is to be used, the length of the string is <code>0</code>.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Converter factory parameter count</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The converter factory, when creating a converter instance, can take an arbitrary number of parameters, enabling the factory to be used to create different converter instances dynamically. This count field indicates how many parameters will be passed to the factory. If no factory name was provided, this field is not present in the request.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Converter factory parameter 1</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">First converter factory parameter</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Converter factory parameter 2</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Second converter factory parameter</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td> <td class="tableblock halign-center valign-top"></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Listener even type interests</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">A variable length number representing listener event type interests. Each event type is represented by a bit. Each flags is represented by a bit. Note that since this field is sent as variable length, the most significant bit in a byte is used to determine whether more bytes need to be read, hence this bit does not represent any flag. Using this model allows for flags to be combined in a short space. Here are the current values for each flag:<br> 0x01 = cache entry created events 0x02 = cache entry modified events 0x04 = cache entry removed events 0x08 = cache entry expired events</p></td> </tr> </tbody> </table> </div> </div> <div class="sect3"> <h4 id="hot_rod_hash_functions"><a class="anchor" href="#hot_rod_hash_functions"></a>14.4.2. Hot Rod Hash Functions</h4> <div class="paragraph"> <p>Infinispan makes use of a consistent hash function to place nodes on a hash wheel, and to place keys of entries on the same wheel to determine where entries live.</p> </div> <div class="paragraph"> <p>In Infinispan 4.2 and earlier, the hash space was hardcoded to 10240, but since 5.0, the hash space is <a href="http://docs.oracle.com/javase/6/docs/api/java/lang/Integer.html#MAX_VALUE">Integer.MAX_INT</a> . Please note that since Hot Rod clients should not assume a particular hash space by default, every time a hash-topology change is detected, this value is sent back to the client via the Hot Rod protocol.</p> </div> <div class="paragraph"> <p>When interacting with Infinispan via the Hot Rod protocol, it is mandated that keys (and values) are byte arrays, to ensure platform neutral behavior. As such, smart-clients which are aware of hash distribution on the backend would need to be able to calculate the hash codes of such byte array keys, again in a platform-neutral manner. To this end, the hash functions used by Infinispan are versioned and documented, so that it can be re-implemented by non-Java clients if needed.</p> </div> <div class="paragraph"> <p>The version of the hash function in use is provided in the Hot Rod protocol, as the hash function version parameter.</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Version 1 (single byte, 0x01) The initial version of the hash function in use is <a href="https://github.com/infinispan/infinispan/blob/master/commons/src/main/java/org/infinispan/commons/hash/MurmurHash2.java">Austin Appleby&#8217;s MurmurHash 2.0 algorithm</a> , a fast, non-cryptographic hash that exhibits excellent distribution, collision resistance and avalanche behavior. The specific version of the algorithm used is the slightly slower, endian-neutral version that allows consistent behavior across both big- and little-endian CPU architectures. Infinispan&#8217;s version also hard-codes the hash seed as -1. For details of the algorithm, please visit <a href="http://sites.google.com/site/murmurhash/">Austin Appleby&#8217;s MurmurHash 2.0 page</a> . Other implementations are detailed on <a href="http://en.wikipedia.org/wiki/MurmurHash">Wikipedia</a> . This hash function was the default one used by the Hot Rod server until Infinispan 4.2.1.</p> </li> <li> <p>Version 2 (single byte, 0x02) Since Infinispan 5.0, a new hash function is used by default which is <a href="https://github.com/infinispan/infinispan/blob/master/commons/src/main/java/org/infinispan/commons/hash/MurmurHash3.java">Austin Appleby&#8217;s MurmurHash 3.0 algorithm</a> . Detailed information about the hash function can be found in this <a href="http://code.google.com/p/smhasher/wiki/MurmurHash3">wiki</a> . Compared to 2.0, it provides better performance and spread.</p> </li> </ol> </div> </div> <div class="sect3"> <h4 id="java_hot_rod_client"><a class="anchor" href="#java_hot_rod_client"></a>14.4.3. Java Hot Rod client</h4> <div class="paragraph"> <p>Hot Rod is a binary, language neutral protocol. This article explains how a Java client can interact with a server via the Hot Rod protocol. A reference implementation of the protocol written in Java can be found in all Infinispan distributions, and this article focuses on the capabilities of this java client.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> Looking for more clients? Visit <a href="http://infinispan.org/hotrod-clients">this website</a> for clients written in a variety of different languages. </td> </tr> </table> </div> <div class="sect4"> <h5 id="configuration_9"><a class="anchor" href="#configuration_9"></a>Configuration</h5> <div class="paragraph"> <p>The Java Hot Rod client can be configured both programmatically and externally, through a configuration file.</p> </div> <div class="paragraph"> <p>The code snippet below illustrates the creation of a client instance using the available Java fluent API:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">org.infinispan.client.hotrod.configuration.ConfigurationBuilder cb
      = <span class="keyword">new</span> org.infinispan.client.hotrod.configuration.ConfigurationBuilder();
cb.tcpNoDelay(<span class="predefined-constant">true</span>)
  .connectionPool()
      .numTestsPerEvictionRun(<span class="integer">3</span>)
      .testOnBorrow(<span class="predefined-constant">false</span>)
      .testOnReturn(<span class="predefined-constant">false</span>)
      .testWhileIdle(<span class="predefined-constant">true</span>)
  .addServer()
      .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span>)
      .port(<span class="integer">11222</span>);
RemoteCacheManager rmc = <span class="keyword">new</span> RemoteCacheManager(cb.build());</code></pre> </div> </div> <div class="paragraph"> <p>For a complete reference to the available configuration option please refer to the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/client/hotrod/configuration/ConfigurationBuilder.html">ConfigurationBuilder</a>'s javadoc.</p> </div> <div class="paragraph"> <p>It is also possible to configure the Java Hot Rod client using an properties file, e.g.:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code>infinispan.client.hotrod.transport_factory = org.infinispan.client.hotrod.impl.transport.tcp.TcpTransportFactory
infinispan.client.hotrod.server_list = 12{infinispanversion}.0.1:11222
infinispan.client.hotrod.marshaller = org.infinispan.commons.marshall.jboss.GenericJBossMarshaller
infinispan.client.hotrod.async_executor_factory = org.infinispan.client.hotrod.impl.async.DefaultAsyncExecutorFactory
infinispan.client.hotrod.default_executor_factory.pool_size = 1
infinispan.client.hotrod.default_executor_factory.queue_size = 10000
infinispan.client.hotrod.hash_function_impl.1 = org.infinispan.client.hotrod.impl.consistenthash.ConsistentHashV1
infinispan.client.hotrod.tcp_no_delay = true
infinispan.client.hotrod.request_balancing_strategy = org.infinispan.client.hotrod.impl.transport.tcp.RoundRobinBalancingStrategy
infinispan.client.hotrod.key_size_estimate = 64
infinispan.client.hotrod.value_size_estimate = 512
infinispan.client.hotrod.force_return_values = false

## below is connection pooling config
maxActive=-1
maxTotal = -1
maxIdle = -1
whenExhaustedAction = 1
timeBetweenEvictionRunsMillis=120000
minEvictableIdleTimeMillis=300000
testWhileIdle = true
minIdle = 1</code></pre> </div> </div> <div class="paragraph"> <p>The properties file is then passed to one of constructors of <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html#RemoteCacheManager(java.net.URL)">RemoteCacheManager</a>. For a complete reference of the available configuration options for the properties file please refer to <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a>'s javadoc.</p> </div> </div> <div class="sect4"> <h5 id="basic_api"><a class="anchor" href="#basic_api"></a>Basic API</h5> <div class="paragraph"> <p>Below is a sample code snippet on how the client API can be used to store or retrieve information from a Hot Rod server using the Java Hot Rod client. It assumes that a Hot Rod server has been started bound to the default location (localhost:11222)</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">//API entry point, by default it connects to localhost:11222</span>
CacheContainer cacheContainer = <span class="keyword">new</span> RemoteCacheManager();

<span class="comment">//obtain a handle to the remote default cache</span>
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheContainer.getCache();

<span class="comment">//now add something to the cache and make sure it is there</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ferrari</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">assert</span> cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>).equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">ferrari</span><span class="delimiter">&quot;</span></span>);

<span class="comment">//remove the data</span>
cache.remove(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">assert</span> !cache.containsKey(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>) : <span class="string"><span class="delimiter">&quot;</span><span class="content">Value must have been removed!</span><span class="delimiter">&quot;</span></span>;</code></pre> </div> </div> <div class="paragraph"> <p>The client API maps the local API: <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a> corresponds to <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/manager/DefaultCacheManager.html">DefaultCacheManager</a> (both implement <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/manager/CacheContainer.html">CacheContainer</a> ). This common API facilitates an easy migration from local calls to remote calls through Hot Rod: all one needs to do is switch between <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/manager/DefaultCacheManager.html">DefaultCacheManager</a> and <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a> - which is further simplified by the common <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/manager/CacheContainer.html">CacheContainer</a> interface that both inherit.</p> </div> <div class="paragraph"> <p>All keys can be retrieved from the remote cache (whether it&#8217;s local, replicated, or distributed) by using keySet() method. If the remote cache is a distributed cache, the server will perform a distributed stream operation to retrieve all keys from clustered nodes, and return all keys to the client. Please use this method with care if there are large number of keys.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Set</span> keys = remoteCache.keySet();</code></pre> </div> </div> <div class="paragraph"> <p>Alternatively, if memory is a concern, use the remote iterator api to retrieve entries from the server:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Retrieve all entries in batches of 1000</span>
<span class="type">int</span> batchSize = <span class="integer">1000</span>;
<span class="keyword">try</span> (CloseableIterator&lt;Entry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt;&gt; iterator = remoteCache.retrieveEntries(<span class="predefined-constant">null</span>, batchSize)) {
     <span class="keyword">while</span>(iterator.hasNext()) {
        <span class="comment">// Do something</span>
     }
}

<span class="comment">// Filter by segment</span>
<span class="predefined-type">Set</span>&lt;<span class="predefined-type">Integer</span>&gt; segments = ...
try (CloseableIterator&lt;Entry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt;&gt; iterator = remoteCache.retrieveEntries(<span class="predefined-constant">null</span>, segments, batchSize)) {
     <span class="keyword">while</span>(iterator.hasNext()) {
        <span class="comment">// Do something</span>
     }
}

<span class="comment">// Filter by custom filter</span>
<span class="keyword">try</span> (CloseableIterator&lt;Entry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt;&gt; iterator = remoteCache.retrieveEntries(<span class="string"><span class="delimiter">&quot;</span><span class="content">myFilterConverterFactory</span><span class="delimiter">&quot;</span></span>, segments, batchSize)) {
     <span class="keyword">while</span>(iterator.hasNext()) {
        <span class="comment">// Do something</span>
     }
}</code></pre> </div> </div> <div class="paragraph"> <p>In order to use custom filters, it&#8217;s necessary to deploy them first in the server. Follow the steps:</p> </div> <div class="ulist"> <ul> <li> <p>Create a factory for the filter extending <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/filter/KeyValueFilterConverterFactory.html">KeyValueFilterConverterFactory</a>, annotated with @NamedFactory containing the name of the factory, example:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.io.Serializable</span>;

<span class="keyword">import</span> <span class="include">org.infinispan.filter.AbstractKeyValueFilterConverter</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.filter.KeyValueFilterConverter</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.filter.KeyValueFilterConverterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.filter.NamedFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.metadata.Metadata</span>;

<span class="annotation">@NamedFactory</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">myFilterConverterFactory</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyKeyValueFilterConverterFactory</span> <span class="directive">implements</span> KeyValueFilterConverterFactory {

   <span class="annotation">@Override</span>
   <span class="directive">public</span> KeyValueFilterConverter&lt;<span class="predefined-type">String</span>, SampleEntity1, SampleEntity2&gt; getFilterConverter() {
      <span class="keyword">return</span> <span class="keyword">new</span> MyKeyValueFilterConverter();
   }
   <span class="comment">// Filter implementation. Should be serializable or externalizable for DIST caches</span>
   <span class="directive">static</span> <span class="type">class</span> <span class="class">MyKeyValueFilterConverter</span> <span class="directive">extends</span> AbstractKeyValueFilterConverter&lt;<span class="predefined-type">String</span>, SampleEntity1, SampleEntity2&gt; <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
      <span class="annotation">@Override</span>
      <span class="directive">public</span> SampleEntity2 filterAndConvert(<span class="predefined-type">String</span> key, SampleEntity1 entity, Metadata metadata) {
         <span class="comment">// returning null will case the entry to be filtered out</span>
         <span class="comment">// return SampleEntity2 will convert from the cache type SampleEntity1</span>
      }
   }
}</code></pre> </div> </div> <div class="ulist"> <ul> <li> <p>Create a jar with a <code>META-INF/services/org.infinispan.filter.KeyValueFilterConverterFactory</code> file and within it, write the fully qualified class name of the filter factory class implementation.</p> </li> <li> <p>Optional: If the filter uses custom key/value classes, these must be included in the JAR so that the filter can correctly unmarshall key and/or value instances.</p> </li> <li> <p>Deploy the JAR file in the Infinispan Server.</p> </li> </ul> </div> </div> <div class="sect4"> <h5 id="versioned_api"><a class="anchor" href="#versioned_api"></a>Versioned API</h5> <div class="paragraph"> <p>A RemoteCacheManager provides instances of <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> interface that represents a handle to the named or default cache on the remote cluster. API wise, it extends the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/Cache.html">Cache</a> interface to which it also adds some new methods, including the so called versioned API. Please find below some examples of this API <a href="#sid-68355052">but to understand the motivation behind it, make sure you read this section</a>.</p> </div> <div class="paragraph"> <p>The code snippet bellow depicts the usage of these versioned methods:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// To use the versioned API, remote classes are specifically needed</span>
RemoteCacheManager remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager();
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache();

remoteCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ferrari</span><span class="delimiter">&quot;</span></span>);
RemoteCache.VersionedValue valueBinary = remoteCache.getVersioned(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// removal only takes place only if the version has not been changed</span>
<span class="comment">// in between. (a new version is associated with 'car' key on each change)</span>
<span class="keyword">assert</span> remoteCache.remove(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>, valueBinary.getVersion());
<span class="keyword">assert</span> !cache.containsKey(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>In a similar way, for replace:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">remoteCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ferrari</span><span class="delimiter">&quot;</span></span>);
RemoteCache.VersionedValue valueBinary = remoteCache.getVersioned(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">assert</span> remoteCache.replace(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">lamborghini</span><span class="delimiter">&quot;</span></span>, valueBinary.getVersion());</code></pre> </div> </div> <div class="paragraph"> <p>For more details on versioned operations refer to <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> 's javadoc.</p> </div> </div> <div class="sect4"> <h5 id="async_api"><a class="anchor" href="#async_api"></a>Async API</h5> <div class="paragraph"> <p>This cool feature is "borrowed" from the Infinispan core and it is largely discussed <a href="#_asynchronous_api">here</a></p> </div> </div> <div class="sect4"> <h5 id="client_event_listener_api"><a class="anchor" href="#client_event_listener_api"></a>Client Event Listener API</h5> <div class="paragraph"> <p>Starting with Infinispan 7.0, Java Hot Rod clients can register listeners to receive cache-entry level events. In 7.0, cache entry created, modified and removed events are supported.</p> </div> <div class="sect5"> <h6 id="creating_a_client_event_listener"><a class="anchor" href="#creating_a_client_event_listener"></a>Creating a Client Event Listener</h6> <div class="paragraph"> <p>Creating a client listener is very similar to embedded listeners, except that different annotations and event classes are used. Here&#8217;s an example of a client listener that prints out each event received:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.annotation</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.event</span>.*;

<span class="annotation">@ClientListener</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">EventPrintListener</span> {

   <span class="annotation">@ClientCacheEntryCreated</span>
   <span class="directive">public</span> <span class="type">void</span> handleCreatedEvent(ClientCacheEntryCreatedEvent e) {
      <span class="predefined-type">System</span>.out.println(e);
   }

   <span class="annotation">@ClientCacheEntryModified</span>
   <span class="directive">public</span> <span class="type">void</span> handleModifiedEvent(ClientCacheEntryModifiedEvent e) {
      <span class="predefined-type">System</span>.out.println(e);
   }

   <span class="annotation">@ClientCacheEntryRemoved</span>
   <span class="directive">public</span> <span class="type">void</span> handleRemovedEvent(ClientCacheEntryRemovedEvent e) {
      <span class="predefined-type">System</span>.out.println(e);
   }

}</code></pre> </div> </div> <div class="paragraph"> <p><code>ClientCacheEntryCreatedEvent</code> and <code>ClientCacheEntryModifiedEvent</code> instances provide information on the affected key, and the version of the entry. This version can be used to invoke conditional operations on the server, such as <code>replaceWithVersion</code> or <code>removeWithVersion</code>.</p> </div> <div class="paragraph"> <p><code>ClientCacheEntryRemovedEvent</code> events are only sent when the remove operation succeeds. In other words, if a remove operation is invoked but no entry is found or no entry should be removed, no event is generated. Users interested in removed events, even when no entry was removed, can develop event customization logic to generate such events. More information can be found in the <a href="#_customizing_client_events_contents">customizing client events section</a>.</p> </div> <div class="paragraph"> <p>All <code>ClientCacheEntryCreatedEvent</code>, <code>ClientCacheEntryModifiedEvent</code> and <code>ClientCacheEntryRemovedEvent</code> event instances also provide a <code>boolean isCommandRetried()</code> method that will return true if the write command that caused this had to be retried again due to a topology change. This could be a sign that this event has been duplicated or another event was dropped and replaced (eg: ClientCacheEntryModifiedEvent replaced ClientCacheEntryCreatedEvent).</p> </div> <div class="paragraph"> <p>Once the client listener implementation has been created, it needs to be registered with the server. To do so, execute:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> EventPrintListener());</code></pre> </div> </div> </div> <div class="sect5"> <h6 id="remove_a_client_event_listener"><a class="anchor" href="#remove_a_client_event_listener"></a>Remove a Client Event Listener</h6> <div class="paragraph"> <p>When an client event listener is not needed any more, it can be removed:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">EventPrintListener listener = ...
cache.removeClientListener(listener);</code></pre> </div> </div> </div> <div class="sect5"> <h6 id="filtering_client_events"><a class="anchor" href="#filtering_client_events"></a>Filtering Client Events</h6> <div class="paragraph"> <p>In order to avoid inundating clients with events, users can provide filtering functionality to limit the number of events fired by the server for a particular client listener. To enable filtering, a cache event filter factory needs to be created that produces filter instances:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventFilterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.filter.NamedFactory</span>;

<span class="annotation">@NamedFactory</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">static-filter</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">StaticCacheEventFilterFactory</span> <span class="directive">implements</span> CacheEventFilterFactory {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> CacheEventFilterFactory&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt; getFilter(<span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="keyword">return</span> <span class="keyword">new</span> StaticCacheEventFilter();
   }
}

<span class="comment">// Serializable, Externalizable or marshallable with Infinispan Externalizers</span>
<span class="comment">// needed when running in a cluster</span>
<span class="type">class</span> <span class="class">StaticCacheEventFilter</span> <span class="directive">implements</span> CacheEventFilter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt;, <span class="predefined-type">Serializable</span> {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">boolean</span> accept(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> oldValue, Metadata oldMetadata,
         <span class="predefined-type">String</span> newValue, Metadata newMetadata, EventType eventType) {
      <span class="keyword">if</span> (key.equals(<span class="integer">1</span>)) <span class="comment">// static key</span>
         <span class="keyword">return</span> <span class="predefined-constant">true</span>;

      <span class="keyword">return</span> <span class="predefined-constant">false</span>;
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>The cache event filter factory instance defined above creates filter instances which statically filter out all entries except the one whose key is <code>1</code>.</p> </div> <div class="paragraph"> <p>To be able to register a listener with this cache event filter factory, the factory has to be given a unique name, and the Hot Rod server needs to be plugged with the name and the cache event filter factory instance. Plugging the Infinispan Server with a custom filter involves the following steps:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Create a JAR file with the filter implementation within it.</p> </li> <li> <p>Optional: If the cache uses custom key/value classes, these must be included in the JAR so that the callbacks can be executed with the correctly unmarshalled key and/or value instances. If the client listener has <code>useRawData</code> enabled, this is not necessary since the callback key/value instances will be provided in binary format.</p> </li> <li> <p>Create a <code>META-INF/services/org.infinispan.notifications.cachelistener.filter.CacheEventFilterFactory</code> file within the JAR file and within it, write the fully qualified class name of the filter class implementation.</p> </li> <li> <p>Deploy the JAR file in the Infinispan Server.</p> </li> </ol> </div> <div class="paragraph"> <p>On top of that, the client listener needs to be linked with this cache event filter factory by adding the factory&#8217;s name to the @ClientListener annotation:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ClientListener</span>(filterFactoryName = <span class="string"><span class="delimiter">&quot;</span><span class="content">static-filter</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">EventPrintListener</span> { ... }</code></pre> </div> </div> <div class="paragraph"> <p>And, register the listener with the server:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> EventPrintListener());</code></pre> </div> </div> <div class="paragraph"> <p>Dynamic filter instances that filter based on parameters provided when the listener is registered are also possible. Filters use the parameters received by the filter factories to enable this option. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventFilterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventFilter</span>;

<span class="type">class</span> <span class="class">DynamicCacheEventFilterFactory</span> <span class="directive">implements</span> CacheEventFilterFactory {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> CacheEventFilter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt; getFilter(<span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="keyword">return</span> <span class="keyword">new</span> DynamicCacheEventFilter(params);
   }
}

<span class="comment">// Serializable, Externalizable or marshallable with Infinispan Externalizers</span>
<span class="comment">// needed when running in a cluster</span>
<span class="type">class</span> <span class="class">DynamicCacheEventFilter</span> <span class="directive">implements</span> CacheEventFilter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt;, <span class="predefined-type">Serializable</span> {
   <span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params;

   DynamicCacheEventFilter(<span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="local-variable">this</span>.params = params;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">boolean</span> accept(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> oldValue, Metadata oldMetadata,
         <span class="predefined-type">String</span> newValue, Metadata newMetadata, EventType eventType) {
      <span class="keyword">if</span> (key.equals(params[<span class="integer">0</span>])) <span class="comment">// dynamic key</span>
         <span class="keyword">return</span> <span class="predefined-constant">true</span>;

      <span class="keyword">return</span> <span class="predefined-constant">false</span>;
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>The dynamic parameters required to do the filtering are provided when the listener is registered:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> EventPrintListener(), <span class="keyword">new</span> <span class="predefined-type">Object</span><span class="type">[]</span>{<span class="integer">1</span>}, <span class="predefined-constant">null</span>);</code></pre> </div> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> Filter instances have to marshallable when they are deployed in a cluster so that the filtering can happen right where the event is generated, even if the even is generated in a different node to where the listener is registered. To make them marshallable, either make them extend <code>Serializable</code>, <code>Externalizable</code>, or provide a custom <code>Externalizer</code> for them. </td> </tr> </table> </div> </div> <div class="sect5"> <h6 id="customizing_client_events_contents"><a class="anchor" href="#customizing_client_events_contents"></a>Customizing Client Events contents</h6> <div class="paragraph"> <p>The events generated by default contain just enough information to make the event relevant but they avoid cramming too much information in order to reduce the cost of sending them. Optionally, the information shipped in the events can be customised in order to contain more information, such as values, or to contain even less information. This customization is done with <code>CacheEventConverter</code> instances generated by a <code>CacheEventConverterFactory</code>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverter</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.filter.NamedFactory</span>;

<span class="annotation">@NamedFactory</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">static-converter</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">StaticConverterFactory</span> <span class="directive">implements</span> CacheEventConverterFactory {
   <span class="directive">final</span> CacheEventConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt; staticConverter = <span class="keyword">new</span> StaticCacheEventConverter();
   <span class="directive">public</span> CacheEventConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt; getConverter(<span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="keyword">return</span> staticConverter;
   }
}

<span class="comment">// Serializable, Externalizable or marshallable with Infinispan Externalizers</span>
<span class="comment">// needed when running in a cluster</span>
<span class="type">class</span> <span class="class">StaticCacheEventConverter</span> <span class="directive">implements</span> CacheEventConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt;, <span class="predefined-type">Serializable</span> {
   <span class="directive">public</span> CustomEvent convert(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> oldValue, Metadata oldMetadata, <span class="predefined-type">String</span> newValue, Metadata newMetadata, EventType eventType) {
      <span class="keyword">return</span> <span class="keyword">new</span> CustomEvent(key, newValue);
   }
}

<span class="comment">// Needs to be Serializable, Externalizable or marshallable with Infinispan Externalizers</span>
<span class="comment">// regardless of cluster or local caches</span>
<span class="directive">static</span> <span class="type">class</span> <span class="class">CustomEvent</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
   <span class="directive">final</span> <span class="predefined-type">Integer</span> key;
   <span class="directive">final</span> <span class="predefined-type">String</span> value;
   CustomEvent(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> value) {
      <span class="local-variable">this</span>.key = key;
      <span class="local-variable">this</span>.value = value;
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>In the example above, the converter generates a new custom event which includes the value as well as the key in the event. This will result in bigger event payloads compared with default events, but if combined with filtering, it can reduce its network bandwidth cost.</p> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> The target type of the converter must be either <code>Serializable</code> or <code>Externalizable</code>. In this particular case of converters, providing an Externalizer will not work by default since the default Hot Rod client marshaller does not support them. </td> </tr> </table> </div> <div class="paragraph"> <p>Handling custom events requires a slightly different client listener implementation to the one demonstrated previously. To be more precise, it needs to handle <code>ClientCacheEntryCustomEvent</code> instances:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.annotation</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.event</span>.*;

<span class="annotation">@ClientListener</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomEventPrintListener</span> {

   <span class="annotation">@ClientCacheEntryCreated</span>
   <span class="annotation">@ClientCacheEntryModified</span>
   <span class="annotation">@ClientCacheEntryRemoved</span>
   <span class="directive">public</span> <span class="type">void</span> handleCustomEvent(ClientCacheEntryCustomEvent&lt;CustomEvent&gt; e) {
      <span class="predefined-type">System</span>.out.println(e);
   }

}</code></pre> </div> </div> <div class="paragraph"> <p>The <code>ClientCacheEntryCustomEvent</code> received in the callback exposes the custom event via <code>getEventData</code> method, and the <code>getType</code> method provides information on whether the event generated was as a result of cache entry creation, modification or removal.</p> </div> <div class="paragraph"> <p>Similar to filtering, to be able to register a listener with this converter factory, the factory has to be given a unique name, and the Hot Rod server needs to be plugged with the name and the cache event converter factory instance. Plugging the Infinispan Server with an event converter involves the following steps:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Create a JAR file with the converter implementation within it.</p> </li> <li> <p>Optional: If the cache uses custom key/value classes, these must be included in the JAR so that the callbacks can be executed with the correctly unmarshalled key and/or value instances. If the client listener has <code>useRawData</code> enabled, this is not necessary since the callback key/value instances will be provided in binary format.</p> </li> <li> <p>Create a <code>META-INF/services/org.infinispan.notifications.cachelistener.filter.CacheEventConverterFactory</code> file within the JAR file and within it, write the fully qualified class name of the converter class implementation.</p> </li> <li> <p>Deploy the JAR file in the Infinispan Server.</p> </li> </ol> </div> <div class="paragraph"> <p>On top of that, the client listener needs to be linked with this converter factory by adding the factory&#8217;s name to the @ClientListener annotation:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ClientListener</span>(converterFactoryName = <span class="string"><span class="delimiter">&quot;</span><span class="content">static-converter</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomEventPrintListener</span> { ... }</code></pre> </div> </div> <div class="paragraph"> <p>And, register the listener with the server:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> CustomEventPrintListener());</code></pre> </div> </div> <div class="paragraph"> <p>Dynamic converter instances that convert based on parameters provided when the listener is registered are also possible. Converters use the parameters received by the converter factories to enable this option. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverter</span>;

<span class="annotation">@NamedFactory</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">dynamic-converter</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">DynamicCacheEventConverterFactory</span> <span class="directive">implements</span> CacheEventConverterFactory {
   <span class="directive">public</span> CacheEventConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt; getConverter(<span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="keyword">return</span> <span class="keyword">new</span> DynamicCacheEventConverter(params);
   }
}

<span class="comment">// Serializable, Externalizable or marshallable with Infinispan Externalizers needed when running in a cluster</span>
<span class="type">class</span> <span class="class">DynamicCacheEventConverter</span> <span class="directive">implements</span> CacheEventConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt;, <span class="predefined-type">Serializable</span> {
   <span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params;

   DynamicCacheEventConverter(<span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="local-variable">this</span>.params = params;
   }

   <span class="directive">public</span> CustomEvent convert(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> oldValue, Metadata oldMetadata,
         <span class="predefined-type">String</span> newValue, Metadata newMetadata, EventType eventType) {
      <span class="comment">// If the key matches a key given via parameter, only send the key information</span>
      <span class="keyword">if</span> (params[<span class="integer">0</span>].equals(key))
         <span class="keyword">return</span> <span class="keyword">new</span> CustomEvent(key, <span class="predefined-constant">null</span>);

      <span class="keyword">return</span> <span class="keyword">new</span> CustomEvent(key, newValue);
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>The dynamic parameters required to do the conversion are provided when the listener is registered:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> EventPrintListener(), <span class="predefined-constant">null</span>, <span class="keyword">new</span> <span class="predefined-type">Object</span><span class="type">[]</span>{<span class="integer">1</span>});</code></pre> </div> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> Converter instances have to marshallable when they are deployed in a cluster, so that the conversion can happen right where the event is generated, even if the even is generated in a different node to where the listener is registered. To make them marshallable, either make them extend <code>Serializable</code>, <code>Externalizable</code>, or provide a custom <code>Externalizer</code> for them. </td> </tr> </table> </div> </div> <div class="sect5"> <h6 id="filtering_and_customizing_client_events"><a class="anchor" href="#filtering_and_customizing_client_events"></a>Filtering and Customizing Client Events</h6> <div class="paragraph"> <p>If you want to do both event filtering and customization, it&#8217;s easier to implement <code>org.infinispan.notifications.cachelistener.filter.CacheEventFilterConverter</code> which allows both filter and customization to happen in a single step. For convenience, it&#8217;s recommended to extend <code>org.infinispan.notifications.cachelistener.filter.AbstractCacheEventFilterConverter</code> instead of implementing <code>org.infinispan.notifications.cachelistener.filter.CacheEventFilterConverter</code> directly. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverter</span>;

<span class="annotation">@NamedFactory</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">dynamic-filter-converter</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">DynamicCacheEventFilterConverterFactory</span> <span class="directive">implements</span> CacheEventFilterConverterFactory {
   <span class="directive">public</span> CacheEventFilterConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt; getFilterConverter(<span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="keyword">return</span> <span class="keyword">new</span> DynamicCacheEventFilterConverter(params);
   }
}

<span class="comment">// Serializable, Externalizable or marshallable with Infinispan Externalizers needed when running in a cluster</span>
<span class="comment">//</span>
<span class="type">class</span> <span class="class">DynamicCacheEventFilterConverter</span> <span class="directive">extends</span> AbstractCacheEventFilterConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt;, <span class="predefined-type">Serializable</span> {
   <span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params;

   DynamicCacheEventFilterConverter(<span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="local-variable">this</span>.params = params;
   }

   <span class="directive">public</span> CustomEvent filterAndConvert(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> oldValue, Metadata oldMetadata,
         <span class="predefined-type">String</span> newValue, Metadata newMetadata, EventType eventType) {
      <span class="comment">// If the key matches a key given via parameter, only send the key information</span>
      <span class="keyword">if</span> (params[<span class="integer">0</span>].equals(key))
         <span class="keyword">return</span> <span class="keyword">new</span> CustomEvent(key, <span class="predefined-constant">null</span>);

      <span class="keyword">return</span> <span class="keyword">new</span> CustomEvent(key, newValue);
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>Similar to filters and converters, to be able to register a listener with this combined filter/converter factory, the factory has to be given a unique name via the <code>@NamedFactory</code> annotation, and the Hot Rod server needs to be plugged with the name and the cache event converter factory instance. Plugging the Infinispan Server with an event converter involves the following steps:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Create a JAR file with the converter implementation within it.</p> </li> <li> <p>Optional: If the cache uses custom key/value classes, these must be included in the JAR so that the callbacks can be executed with the correctly unmarshalled key and/or value instances. If the client listener has <code>useRawData</code> enabled, this is not necessary since the callback key/value instances will be provided in binary format.</p> </li> <li> <p>Create a <code>META-INF/services/org.infinispan.notifications.cachelistener.filter.CacheEventFilterConverterFactory</code> file within the JAR file and within it, write the fully qualified class name of the converter class implementation.</p> </li> <li> <p>Deploy the JAR file in the Infinispan Server.</p> </li> </ol> </div> <div class="paragraph"> <p>From a client perspective, to be able to use the combined filter and converter class, the client listener must define the same filter factory and converter factory names, e.g.:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ClientListener</span>(filterFactoryName = <span class="string"><span class="delimiter">&quot;</span><span class="content">dynamic-filter-converter</span><span class="delimiter">&quot;</span></span>, converterFactoryName = <span class="string"><span class="delimiter">&quot;</span><span class="content">dynamic-filter-converter</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomEventPrintListener</span> { ... }</code></pre> </div> </div> <div class="paragraph"> <p>The dynamic parameters required in the example above are provided when the listener is registered via either filter or converter parameters. If filter parameters are non-empty, those are used, otherwise, the converter parameters:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> CustomEventPrintListener(), <span class="keyword">new</span> <span class="predefined-type">Object</span><span class="type">[]</span>{<span class="integer">1</span>}, <span class="predefined-constant">null</span>);</code></pre> </div> </div> </div> <div class="sect5"> <h6 id="event_marshalling"><a class="anchor" href="#event_marshalling"></a>Event Marshalling</h6> <div class="paragraph"> <p>Hot Rod servers store data as byte arrays, but in spite of that, Java Hot Rod client users can still develop <code>CacheEventConverter</code> or <code>CacheEventFilter</code> instances that worked on typed objects. The way this is done is by making the Hot Rod server use the same marshaller as the one used by the Java Hot Rod client. This is enabled by default.</p> </div> <div class="paragraph"> <p>However, users are free to plug a custom <code>org.infinispan.commons.marshall.Marshaller</code> implementation in order to marshall objects using alternative techniques to the one used by default by the Hot Rod Java client. For example, a user might want to marshall objects using Google Protocol Buffers.</p> </div> <div class="paragraph"> <p>As indicated in the <a href="#_marshalling_data">Marshalling data</a> section, Hot Rod Java clients can be configured to use a different <code>org.infinispan.commons.marshall.Marshaller</code> instance. If doing this and deploying <code>CacheEventConverter</code> or <code>CacheEventFilter</code> instances, the same marshaller instance needs to be deployed in the server so that callback parameters of <code>CacheEventConverter</code> or <code>CacheEventFilter</code> instances can be correctly unmarshalled.</p> </div> <div class="paragraph"> <p>To deploy a Marshaller instance server-side, follow a similar method to the one used to deploy <code>CacheEventConverter</code> or <code>CacheEventFilter</code> instances:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Create a JAR file with the converter implementation within it.</p> </li> <li> <p>Create a <code>META-INF/services/org.infinispan.commons.marshall.Marshaller</code> file within the JAR file and within it, write the fully qualified class name of the marshaller class implementation.</p> </li> <li> <p>Deploy the JAR file in the Infinispan Server.</p> </li> </ol> </div> <div class="paragraph"> <p>Note that the Marshaller could be deployed in either a separate jar, or in the same jar as the <code>CacheEventConverter</code> and/or <code>CacheEventFilter</code> instances. Also, currently deployment of a single <code>org.infinispan.commons.marshall.Marshaller</code> instance is supported. If multiple marshaller instances are deployed, warning messages will be displayed as reminder indicating which marshaller instance will be used.</p> </div> </div> <div class="sect5"> <h6 id="client_event_listener_state_consumption"><a class="anchor" href="#client_event_listener_state_consumption"></a>Client Event Listener State Consumption</h6> <div class="paragraph"> <p>Client listener annotation has an optional <code>includeCurrentState</code> attribute that specifies whether state will be sent to the client when the listener is added or when there&#8217;s a failover of the listener.</p> </div> <div class="paragraph"> <p>By default, <code>includeCurrentState</code> is false, but if set to true and a client listener is added in a cache already containing data, the server iterates over the cache contents and sends an event for each entry to the client as a <code>ClientCacheEntryCreated</code> (or custom event if configured). This allows clients to build some local data structures based on the existing content. Once the content has been iterated over, events are received as normal, as cache updates are received. If the cache is clustered, the entire cluster wide contents are iterated over.</p> </div> <div class="paragraph"> <p><code>includeCurrentState</code> also controls whether state is received when the node where the client event listener is registered fails and it&#8217;s moved to a different node. The next section discusses this topic in depth.</p> </div> </div> <div class="sect5"> <h6 id="client_event_listener_failure_handling"><a class="anchor" href="#client_event_listener_failure_handling"></a>Client Event Listener Failure Handling</h6> <div class="paragraph"> <p>When a Hot Rod client registers a client listener, it does so in a single node in a cluster. If that node fails, the Java Hot Rod client detects that transparently and fails over all listeners registered in the node that failed to another node.</p> </div> <div class="paragraph"> <p>During this fail over the client might miss some events. To avoid missing these events, the client listener annotation contains an optional parameter called <code>includeCurrentState</code> which if set to true, when the failover happens, the cache contents can iterated over and <code>ClientCacheEntryCreated</code> events (or custom events if configured) are generated. By default, <code>includeCurrentState</code> is set to false.</p> </div> <div class="paragraph"> <p>Java Hot Rod clients can be made aware of such fail over event by adding a callback to handle it:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ClientCacheFailover</span>
<span class="directive">public</span> <span class="type">void</span> handleFailover(ClientCacheFailoverEvent e) {
  ...
}</code></pre> </div> </div> <div class="paragraph"> <p>This is very useful in use cases where the client has cached some data, and as a result of the fail over, taking in account that some events could be missed, it could decide to clear any locally cached data when the fail over event is received, with the knowledge that after the fail over event, it will receive events for the contents of the entire cache.</p> </div> </div> </div> <div class="sect4"> <h5 id="near_caching"><a class="anchor" href="#near_caching"></a>Near Caching</h5> <div class="paragraph"> <p>The Java Hot Rod client can be optionally configured with a near cache, which means that the Hot Rod client can keep a local cache that stores recently used data. Enabling near caching can significantly improve the performance of read operations <code>get</code> and <code>getVersioned</code> since data can potentially be located locally within the Hot Rod client instead of having to go remote.</p> </div> <div class="paragraph"> <p>To enable near caching, the user must set the near cache mode to <code>INVALIDATED</code>. By doing that near cache is populated upon retrievals from the server via calls to <code>get</code> or <code>getVersioned</code> operations. When near cached entries are updated or removed server-side, the cached near cache entries are invalidated. If a key is requested after it&#8217;s been invalidated, it&#8217;ll have to be re-fetched from the server.</p> </div> <div class="paragraph"> <p>When near cache is enabled, its size must be configured by defining the maximum number of entries to keep in the near cache. When the maximum is reached, near cached entries are evicted using a least-recently-used (LRU) algorithm. If providing 0 or a negative value, it is assumed that the near cache is unbounded.</p> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> Users should be careful when configuring near cache to be unbounded since it shifts the responsibility to keep the near cache&#8217;s size within the boundaries of the client JVM to the user. </td> </tr> </table> </div> <div class="paragraph"> <p>The Hot Rod client&#8217;s near cache mode is configured using the <code>NearCacheMode</code> enumeration and calling:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.configuration.ConfigurationBuilder</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.configuration.NearCacheMode</span>;
...

<span class="comment">// Unbounded invalidated near cache</span>
ConfigurationBuilder unbounded = <span class="keyword">new</span> ConfigurationBuilder();
unbounded.nearCache().mode(NearCacheMode.INVALIDATED).maxEntries(-<span class="integer">1</span>);

<span class="comment">// Bounded invalidated near cache</span>
ConfigurationBuilder bounded = <span class="keyword">new</span> ConfigurationBuilder();
bounded.nearCache().mode(NearCacheMode.INVALIDATED).maxEntries(<span class="integer">100</span>);</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Near caches work the same way for local caches as they do for clustered caches, but in a clustered cache scenario, if the server node sending the near cache notifications to the Hot Rod client goes down, the Hot Rod client transparently fails over to another node in the cluster, clearing the near cache along the way. </td> </tr> </table> </div> </div> <div class="sect4"> <h5 id="unsupported_methods"><a class="anchor" href="#unsupported_methods"></a>Unsupported methods</h5> <div class="paragraph"> <p>Some of the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/Cache.html">Cache</a> methods are not being supported by the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> . Calling one of these methods results in an <a href="http://docs.oracle.com/javase/6/docs/api/java/lang/UnsupportedOperationException.html">UnsupportedOperationException</a> being thrown. Most of these methods do not make sense on the remote cache (e.g. listener management operations), or correspond to methods that are not supported by local cache as well (e.g. containsValue). Another set of unsupported operations are some of the atomic operations inherited from <a href="http://docs.oracle.com/javase/6/docs/api/java/util/concurrent/ConcurrentMap.html">ConcurrentMap</a> :</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="type">boolean</span> remove(<span class="predefined-type">Object</span> key, <span class="predefined-type">Object</span> value);
<span class="type">boolean</span> replace(<span class="predefined-type">Object</span> key, <span class="predefined-type">Object</span> value);
<span class="type">boolean</span> replace(<span class="predefined-type">Object</span> key, <span class="predefined-type">Object</span> oldValue, <span class="predefined-type">Object</span> value);</code></pre> </div> </div> <div class="paragraph"> <p><a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> offers alternative versioned methods for these atomic operations, that are also network friendly, by not sending the whole value object over the network, but a version identifier. See the section on versioned API.</p> </div> <div class="paragraph"> <p>Each one of these unsupported operation is documented in the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> javadoc.</p> </div> </div> </div> <div class="sect3"> <h4 id="return_values_2"><a class="anchor" href="#return_values_2"></a>14.4.4. Return values</h4> <div class="paragraph"> <p>There is a set of methods that alter a cached entry and return the previous existing value, e.g.:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">V remove(<span class="predefined-type">Object</span> key);
V put(K key, V value);</code></pre> </div> </div> <div class="paragraph"> <p>By default on RemoteCache, these operations return null even if such a previous value exists. This approach reduces the amount of data sent over the network. However, if these return values are needed they can be enforced on a per invocation basis using flags:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">aKey</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">initialValue</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">assert</span> <span class="predefined-constant">null</span> == cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">aKey</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">aValue</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">assert</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">aValue</span><span class="delimiter">&quot;</span></span>.equals(cache.withFlags(Flag.FORCE_RETURN_VALUE).put(<span class="string"><span class="delimiter">&quot;</span><span class="content">aKey</span><span class="delimiter">&quot;</span></span>,
<span class="error">Â </span><span class="error">Â </span> <span class="string"><span class="delimiter">&quot;</span><span class="content">newValue</span><span class="delimiter">&quot;</span></span>));</code></pre> </div> </div> <div class="paragraph"> <p>This default behavior can can be changed through force-return-value=true configuration parameter (see configuration section bellow).</p> </div> </div> <div class="sect3"> <h4 id="intelligence"><a class="anchor" href="#intelligence"></a>14.4.5. Intelligence</h4> <div class="paragraph"> <p>HotRod defines three level of intelligence for the clients:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>basic client, interested in neither cluster nor hash information</p> </li> <li> <p>topology-aware client, interested in cluster information</p> </li> <li> <p>hash-distribution-aware client, that is interested in both cluster and hash information</p> </li> </ol> </div> <div class="paragraph"> <p>The java client supports all 3 levels of intelligence. It is transparently notified whenever a new server is added/removed from the HotRod cluster. At startup it only needs to know the address of one HotRod server (ip:host). On connection to the server the cluster topology is piggybacked to the client, and all further requests are being dispatched to all available servers. Any further topology change is also piggybacked.</p> </div> <div class="sect4"> <h5 id="distribution_aware_client"><a class="anchor" href="#distribution_aware_client"></a>Distribution-aware client</h5> <div class="paragraph"> <p>Another aspect of the 3rd level of intelligence is the fact that it is hash-distribution-aware. This means that, for each operation, the client chooses the most appropriate remote server to go to: the data owner. As an example, for a put(k,v) operation, the client calculates k&#8217;s hash value and knows exactly on which server the data resides on. Then it picks up a tcp connection to that particular server and dispatches the operation to it. This means less burden on the server side which would otherwise need to lookup the value based on the key&#8217;s hash. It also results in a quicker response from the server, as an additional network roundtrip is skipped. This hash-distribution-aware aspect is only relevant to the distributed HotRod clusters and makes no difference for replicated server deployments.</p> </div> </div> </div> <div class="sect3"> <h4 id="request_balancing"><a class="anchor" href="#request_balancing"></a>14.4.6. Request Balancing</h4> <div class="paragraph"> <p>Request balancing is only relevant when the server side is configured with replicated infinispan cluster (on distributed clusters the hash-distribution-aware client logic is used, as discussed in the previos paragraph). Because the client is topology-aware, it knows the list of available servers at all the time. Request balancing has to do with how the client dispatches requests to the available servers.</p> </div> <div class="paragraph"> <p>The default strategy is round-robin: requests are being dispatched to all existing servers in a circular manner. E.g. given a cluster of servers {s1, s2, s3} here is how request will be dispatched:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">CacheContainer cacheContainer = <span class="keyword">new</span> RemoteCacheManager();
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheContainer.getCache();

cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">aValue</span><span class="delimiter">&quot;</span></span>); <span class="comment">//this goes to s1</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">aValue</span><span class="delimiter">&quot;</span></span>); <span class="comment">//this goes to s2</span>
<span class="predefined-type">String</span> value = cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>); <span class="comment">//this goes to s3</span>

cache.remove(<span class="string"><span class="delimiter">&quot;</span><span class="content">key2</span><span class="delimiter">&quot;</span></span>); <span class="comment">//this is dispatched to s1 again, and so on...</span></code></pre> </div> </div> <div class="paragraph"> <p>Custom types of balancing policies can defined by implementing the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/client/hotrod/impl/transport/tcp/FailoverRequestBalancingStrategy.html">FailoverRequestBalancingStrategy</a> and by specifying it through the infinispan.client.hotrod.request-balancing-strategy configuration property. Please refer to configuration section for more details on this.</p> </div> <div class="paragraph"> <div class="title">WARNING: <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/client/hotrod/impl/transport/tcp/FailoverRequestBalancingStrategy.html">FailoverRequestBalancingStrategy</a></div> <p>is a newly added interface in Infinispan 7.0. Previously, users had to provide implementations of <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/client/hotrod/impl/transport/tcp/FailoverRequestBalancingStrategy.html">FailoverRequestBalancingStrategy</a> , which it has been deprecated starting with Infinispan 7.0.</p> </div> <div class="sect4"> <h5 id="persistent_connections"><a class="anchor" href="#persistent_connections"></a>Persistent connections</h5> <div class="paragraph"> <p>In order to avoid creating a TCP connection on each request (which is a costly operation), the client keeps a pool of persistent connections to all the available servers and it reuses these connections whenever it is possible. The validity of the connections is checked using an async thread that iterates over the connections in the pool and sends a HotRod ping command to the server. By using this connection validation process the client is being proactive: there&#8217;s a hight chance for broken connections to be found while being idle in the pool and no on actual request from the application.</p> </div> <div class="paragraph"> <p>The number of connections per server, total number of connections, how long should a connection be kept idle in the pool before being closed - all these (and more) can be configured. Please refer to the javadoc of <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a> for a list of all possible configuration elements.</p> </div> </div> <div class="sect4"> <h5 id="marshalling_data"><a class="anchor" href="#marshalling_data"></a>Marshalling data</h5> <div class="paragraph"> <p>The Hot Rod client allows one to plug in a custom marshaller for transforming user objects into byte arrays and the other way around. This transformation is needed because of Hot Rod&#8217;s binary nature - it doesn&#8217;t know about objects.</p> </div> <div class="paragraph"> <p>The marshaller can be plugged through the "marshaller" configuration element (see Configuration section): the value should be the fully qualified name of a class implementing the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/marshall/Marshaller.html">Marshaller</a> interface. This is a optional parameter, if not specified it defaults to the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/marshall/jboss/GenericJBossMarshaller.html">GenericJBossMarshaller</a> - a highly optimized implementation based on the <a href="http://www.jboss.org/jbossmarshalling">JBoss Marshalling</a> library.</p> </div> <div class="paragraph"> <p>Since version 6.0, there&#8217;s a new marshaller available to Java Hot Rod clients based on Protostream which generates portable payloads. You can find more information about it <a href="#_querying_via_the_java_hot_rod_client">here</a></p> </div> </div> <div class="sect4"> <h5 id="statistics"><a class="anchor" href="#statistics"></a>Statistics</h5> <div class="paragraph"> <p>Various server usage statistics can be obtained through the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> .stats() method. This returns a <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/client/hotrod/ServerStatistics.html">ServerStatistics</a> object - please refer to javadoc for details on the available statistics.</p> </div> </div> <div class="sect4"> <h5 id="configuration_10"><a class="anchor" href="#configuration_10"></a>Configuration</h5> <div class="paragraph"> <p>All the configurations are passed to the RemoteCacheManager&#8217;s constructor as key-value pairs, through an instance of <a href="http://docs.oracle.com/javase/6/docs/api/java/util/Properties.html">java.util.Properties</a> or reference to a .properties file. Please refer to the javadoc of RemoteCacheManager for a exhaustive list of the possible configuration elements.</p> </div> </div> <div class="sect4"> <h5 id="multi_get_operations"><a class="anchor" href="#multi_get_operations"></a>Multi-Get Operations</h5> <div class="paragraph"> <p>The Java Hot Rod client does not provide multi-get functionality out of the box but clients can build it themselves with the given APIs.</p> </div> </div> <div class="sect4"> <h5 id="more_info"><a class="anchor" href="#more_info"></a>More info</h5> <div class="paragraph"> <p>It is highly recommended to read the following Javadocs (this is pretty much all the public API of the client):</p> </div> <div class="ulist"> <ul> <li> <p><a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a></p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a></p> </li> </ul> </div> </div> </div> <div class="sect3"> <h4 id="sid-68355052"><a class="anchor" href="#sid-68355052"></a>14.4.7. Failover capabilities</h4> <div class="paragraph"> <p>Hot Rod clients' capabilities to keep up with topology changes helps with request balancing and more importantly, with the ability to failover operations if one or several of the servers fail.</p> </div> <div class="paragraph"> <p>Some of the conditional operations mentioned above, including <code>putIfAbsent</code>, <code>replace</code> with and without version, and conditional <code>remove</code> have strict method return guarantees, as well as those operations where returning the previous value is forced.</p> </div> <div class="paragraph"> <p>In spite of failures, these methods return values need to be guaranteed, and in order to do so, it&#8217;s necessary that these methods are not applied partially in the cluster in the event of failure. For example, imagine a <code>replace()</code> operation called in a server for key=k1 with <code>Flag.FORCE_RETURN_VALUE</code>, whose current value is <code>A</code> and the replace wants to set it to <code>B</code>. If the replace fails, it could happen that some servers contain <code>B</code> and others contain <code>A</code>, and during the failover, the original <code>replace()</code> could end up returning <code>B</code>, if the replace failovers to a node where <code>B</code> is set, or could end up returning <code>A</code>.</p> </div> <div class="paragraph"> <p>To avoid this kind of situations, whenever Java Hot Rod client users want to use conditional operations, or operations whose previous value is required, it&#8217;s important that the cache is configured to be transactional in order to avoid incorrect conditional operations or return values.</p> </div> <div class="sect4"> <h5 id="site_cluster_failover"><a class="anchor" href="#site_cluster_failover"></a>Site Cluster Failover</h5> <div class="paragraph"> <p>On top of the in-cluster failover, Hot Rod clients are also able to failover to different clusters, which could be represented as an independent site.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> This feature was introduced in Infinispan 8.1. </td> </tr> </table> </div> <div class="paragraph"> <p>The way site cluster failover works is that if all the main cluster nodes are not available, the client checks to see if any other clusters have been defined in which cases it tries to failover to the alternative cluster. If the failover succeeds, the client will remain connected to the alternative cluster until this becomes unavailable, in which case it&#8217;ll try any other clusters defined, and ultimately, it&#8217;ll try the original server settings.</p> </div> <div class="paragraph"> <p>To configure a cluster in the Hot Rod client, one host/port pair details must be provided for each of the clusters configured. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">org.infinispan.client.hotrod.configuration.ConfigurationBuilder cb
      = <span class="keyword">new</span> org.infinispan.client.hotrod.configuration.ConfigurationBuilder();
cb.addCluster().addClusterNode(<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-cluster-host</span><span class="delimiter">&quot;</span></span>, <span class="integer">11222</span>);
RemoteCacheManager rmc = <span class="keyword">new</span> RemoteCacheManager(cb.build());</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Remember that regardless of the cluster definitions, the initial server(s) configuration must be provided unless the initial servers can be resolved using the default server host and port details. </td> </tr> </table> </div> <div class="sect5"> <h6 id="manual_site_cluster_switch"><a class="anchor" href="#manual_site_cluster_switch"></a>Manual Site Cluster Switch</h6> <div class="paragraph"> <p>As well as supporting automatic site cluster failover, Java Hot Rod clients can also switch between site clusters manually by calling RemoteCacheManager&#8217;s <code>switchToCluster(clusterName)</code> and <code>switchToDefaultCluster()</code>.</p> </div> <div class="paragraph"> <p>Using <code>switchToCluster(clusterName)</code>, users can force a client to switch to one of the clusters pre-defined in the Hot Rod client configuration. To switch to the initial servers defined in the client configuration, call <code>switchToDefaultCluster()</code>.</p> </div> </div> </div> </div> <div class="sect3"> <h4 id="consistent_concurrent_updates_with_hot_rod_versioned_operations"><a class="anchor" href="#consistent_concurrent_updates_with_hot_rod_versioned_operations"></a>14.4.8. Consistent Concurrent Updates With Hot Rod Versioned Operations</h4> <div class="paragraph"> <p>Data structures, such as Infinispan <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/Cache.html">Cache</a> , that are accessed and modified concurrently can suffer from data consistency issues unless there&#8217;re mechanisms to guarantee data correctness. Infinispan Cache, since it implements <a href="http://docs.oracle.com/javase/6/docs/api/java/util/concurrent/ConcurrentMap.html">ConcurrentMap</a> , provides operations such as link:http://docs.oracle.com/javase/6/docs/api/java/util/concurrent/ConcurrentMap.html#replace(K, V, V)[conditional replace] , link:http://docs.oracle.com/javase/6/docs/api/java/util/concurrent/ConcurrentMap.html#putIfAbsent(K, V)[putIfAbsent] , and link:http://docs.oracle.com/javase/6/docs/api/java/util/concurrent/ConcurrentMap.html#remove(java.lang.Object, java.lang.Object)[conditional remove] to its clients in order to guarantee data correctness. It even allows clients to operate against cache instances within JTA transactions, hence providing the necessary data consistency guarantees.</p> </div> <div class="paragraph"> <p>However, when it comes to <a href="http://community.jboss.org/wiki/HotRodProtocol">Hot Rod protocol</a> backed servers, clients do not yet have the ability to start remote transactions but they can call instead versioned operations to mimic the conditional methods provided by the embedded Infinispan cache instanceÂ API. Let&#8217;s look at a real example to understand how it works.</p> </div> <div class="sect4"> <h5 id="data_consistency_problem"><a class="anchor" href="#data_consistency_problem"></a>Data Consistency Problem</h5> <div class="paragraph"> <p>Imagine you have two ATMs that connect using Hot Rod to a bank where an account&#8217;s balance is stored. Two closely followed operations to retrieve the latest balance could return 500 CHF (swiss francs) as shown below:</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/server_modules_6.png" alt="server modules 6"> </div> </div> <div class="paragraph"> <p>Next a customer connects to the first ATM and requests 400 CHF to be retrieved. Based on the last value read, the ATM could calculate what the new balance is, which is 100 CHF, and request a put with this new value. Let&#8217;s imagine now that around the same time another customer connects to the ATM and requests 200 CHF to be retrieved. Let&#8217;s assume that the ATM thinks it has the latest balance and based on its calculations it sets the new balance to 300 CHF:</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/server_modules_7.png" alt="server modules 7"> </div> </div> <div class="paragraph"> <p>Obviously, this would be wrong. Two concurrent updates have resulted in an incorrect account balance. The second update should not have been allowed since the balance the second ATM had was incorrect. Even if the ATM would have retrieved the balance before calculating the new balance, someone could have updated between the new balance being retrieved and the update. Before finding out how to solve this issue in a client-server scenario with Hot Rod, let&#8217;s look at how this is solved when Infinispan clients run in peer-to-peer mode where clients and Infinispan live within the same JVM.</p> </div> <div class="sect5"> <h6 id="embedded_mode_solution"><a class="anchor" href="#embedded_mode_solution"></a>Embedded-mode Solution</h6> <div class="paragraph"> <p>If the ATM and the Infinispan instance storing the bank account lived in the same JVM, the ATM could use the link:http://docs.oracle.com/javase/6/docs/api/java/util/concurrent/ConcurrentMap.html#replace(K, V, V)[conditional replace API] referred at the beginning of this article. So, it could send the previous known value to verify whether it has changed since it was last read. By doing so, the first operation could double check that the balance is still 500 CHF when it was to update to 100 CHF. Now, when the second operation comes, the current balance would not be 500 CHF any more and hence the conditional replace call would fail, hence avoiding data consistency issues:</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/server_modules_8.png" alt="server modules 8"> </div> </div> </div> <div class="sect5"> <h6 id="client_server_solution"><a class="anchor" href="#client_server_solution"></a>Client-Server Solution</h6> <div class="paragraph"> <p>In theory, Hot Rod could use the same p2p solution but sending the previous value would be not practical. In this example, the previous value is just an integer but the value could be a lot bigger and hence forcing clients to send it to the server would be rather wasteful. Instead, Hot Rod offers versioned operations to deal with this situation.</p> </div> <div class="paragraph"> <p>Basically, together with each key/value pair, Hot Rod stores a version number which uniquely identifies each modification. So, using an operation called <a href="http://community.jboss.org/wiki/HotRodProtocol#getWithVersion_response">getVersioned or getWithVersion</a> , clients can retrieve not only the value associated with a key, but also the current version. So, if we look at the previous example once again, the ATMs could call getVersioned and get the balance&#8217;s version:</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/server_modules_9.png" alt="server modules 9"> </div> </div> <div class="paragraph"> <p>When the ATMs wanted to modify the balance, instead of just calling put, they could call <a href="http://community.jboss.org/wiki/HotRodProtocol#removeIfUnmodified_request">replaceIfUnmodified</a> operation passing the latest version number of which the clients are aware of. The operation will only succeed if the version passed matches the version in the server. So, the first modification by the ATM would be allowed since the client passes 1 as version and the server side version for the balance is also 1. On the other hand, the second ATM would not be able to make the modification because after the first ATMs modification the version would have been incremented to 2, and now the passed version (1) and the server side version (2) would not match:</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/server_modules_10.png" alt="server modules 10"> </div> </div> </div> </div> </div> <div class="sect3"> <h4 id="sid-68355104"><a class="anchor" href="#sid-68355104"></a>14.4.9. Interacting With Hot Rod Server From Within Same JVM</h4> <div class="paragraph"> <p>Normally, a Hot Rod server is accessed via a Hot Rod protocol client such as the Java Hot Rod client. However, there might be situations where not only do you want to access the Hot Rod server remotely, you might also want to access it locally from within the same JVM that the Hot Rod server is running. For example, you might have an Infinispan cache pushing changes <a href="#_remote_cache_loader">via the RemoteCacheStore to a Hot Rod server</a>, and if the cache goes down, you might want to access the data directly from the Hot Rod server itself.</p> </div> <div class="paragraph"> <p>In this situations, we have to remember that the Hot Rod protocol specifies that keys and values are stored as byte arrays. This means that if the client code, using an existing Hot Rod client, stored Strings or Integers, or any other complex serializable or externalizable object, you won&#8217;t be able to retrieve these objects straight from the cache that the Hot Rod server uses.</p> </div> <div class="paragraph"> <p>To actually get the fully constructed objects that you&#8217;re after, you&#8217;re gonna need to take the byte arrays stored within the Hot Rod server and unmarshall them into something that you can use. In the future, this is something that might be done for you, as suggested in <a href="https://jira.jboss.org/browse/ISPN-706">ISPN-706</a> (superseded by <a href="https://issues.jboss.org/browse/ISPN-2281">ISPN-2281</a> ), but for the time being, clients wanting to access Hot Rod server data will have to do it themselves.</p> </div> <div class="paragraph"> <p>Two different use cases need to be differentiated at this stage and to explain how to transform the Hot Rod server data into something usable, we&#8217;ll assume that the clients are java clients:</p> </div> <div class="sect4"> <h5 id="data_stored_directly_via_a_hot_rod_client"><a class="anchor" href="#data_stored_directly_via_a_hot_rod_client"></a>Data Stored Directly Via A Hot Rod Client</h5> <div class="paragraph"> <p>The most common case is for a client to use a Hot Rod client library directly to store data in the Hot Rod server. In this case, assuming that the client used the existing Java Hot Rod client, the default marshaller used to marshall objects into byte arrays is the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/marshall/jboss/GenericJBossMarshaller.html">GenericJBossMarshaller</a> . So, if a user wants to read data from the Hot Rod server directly, it would need to execute something along the lines of:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.marshall.jboss.GenericJBossMarshaller</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.util.ByteArrayKey</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.server.core.CacheValue</span>;
...

<span class="comment">// Create a new instance of the marshaller:</span>
GenericJBossMarshaller marshaller = <span class="keyword">new</span> GenericJBossMarshaller();
<span class="predefined-type">Object</span> key = ...

<span class="comment">// Take the cache key and convert into a byte array,</span>
<span class="comment">// and wrap it with an instance of ByteArrayKey</span>
ByteArrayKey bytesKey = <span class="keyword">new</span> ByteArrayKey(marshaller.objectToByteBuffer(key));

<span class="comment">// Internally, Hot Rod stores values wrapped in a CacheValue, so retrieve it</span>
CacheValue cacheValue = (CacheValue) cache.get(bytesKey);

<span class="comment">// Take the data part which is byte array and unmarshall it to retrieve the value</span>
<span class="predefined-type">Object</span> value = marshaller.objectFromByteBuffer(cacheValue.data());</code></pre> </div> </div> <div class="paragraph"> <p>If you want to store data directly in the HotRod server, you&#8217;d have to execute something like this:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.marshall.jboss.GenericJBossMarshaller</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.util.ByteArrayKey</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.server.core.CacheValue</span>;
...

<span class="comment">// Create a new instance of the marshaller:</span>
GenericJBossMarshaller marshaller = <span class="keyword">new</span> GenericJBossMarshaller();
<span class="predefined-type">Object</span> key = ...
Object value = ...

<span class="comment">// Take the cache key and convert into a byte array,</span>
<span class="comment">// and wrap it with an instance of ByteArrayKey</span>
ByteArrayKey bytesKey = <span class="keyword">new</span> ByteArrayKey(marshaller.objectToByteBuffer(key));

<span class="comment">// Internally, Hot Rod stores values wrapped in a CacheValue, so create instance</span>
<span class="comment">// Remember that you need to give it a version number, so either:</span>
<span class="comment">// 1. Increment previous value's version</span>
<span class="comment">// 2. Or generate a new version number that minimises potential clash</span>
<span class="comment">//Â Â Â  with a concurrent update to the same key in the cluster</span>
CacheValue cacheValue = <span class="keyword">new</span> CacheValue(marshaller.objectToByteBuffer(value), <span class="integer">1</span>)

<span class="comment">// Finally, store it in the cache</span>
cache.put(bytesKey, cacheValue);</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="data_stored_via_remote_cache_store"><a class="anchor" href="#data_stored_via_remote_cache_store"></a>Data Stored Via Remote Cache Store</h5> <div class="paragraph"> <p>Other times, Hot Rod server might be storing data coming from a <a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737163">RemoteCacheStore</a> , rather than user code. In this case, there&#8217;re a couple of differences to the code above. First of all, the marshaller is slightly different. Instead, the RemoteCacheStore uses the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/marshall/VersionAwareMarshaller.html">VersionAwareMarshaller</a> which all it does is add Infinispan version information to the byte array generated. The second difference is that RemoteCacheStore stores internal cache entry classes, which apart from the value part, they contain other extra information. So, any code trying to read these directly from the Hot Rod server would need to take in account. For example, to read data from such Hot Rod server:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.marshall.VersionAwareMarshaller</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.util.ByteArrayKey</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.server.core.CacheValue</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.container.entries.CacheEntry</span>;
...

<span class="comment">// Create a new instance of the marshaller</span>
VersionAwareMarshaller marshaller = <span class="keyword">new</span> VersionAwareMarshaller();
<span class="predefined-type">Object</span> key = ...

<span class="comment">// Take the cache key and convert into a byte array,</span>
<span class="comment">// and wrap it with an instance of ByteArrayKey</span>
ByteArrayKey bytesKey = <span class="keyword">new</span> ByteArrayKey(marshaller.objectToByteBuffer(key));

<span class="comment">// Internally, Hot Rod stores values wrapped in a CacheValue, so retrieve it</span>
CacheValue cacheValue = (CacheValue) cache.get(bytesKey);

<span class="comment">// However, in this case the data part of CacheValue does not contain directly</span>
<span class="comment">// the value Instead, it contains an instance of CacheEntry, so we need to</span>
<span class="comment">// unmarshall that and then get the actual value</span>
CacheEntry cacheEntry = (CacheEntry)
<span class="error">Â </span><span class="error">Â </span> marshaller.objectFromByteBuffer(cacheValue.data());
<span class="predefined-type">Object</span> value = cacheEntry.getValue();</code></pre> </div> </div> <div class="paragraph"> <p>And to actually write data back into the Hot Rod server directly:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.marshall.VersionAwareMarshaller</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.util.ByteArrayKey</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.server.core.CacheValue</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.container.entries.CacheEntry</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.container.entries.InternalEntryFactory</span>;
...

<span class="comment">// Create a new instance of the marshaller:</span>
VersionAwareMarshaller marshaller = <span class="keyword">new</span> VersionAwareMarshaller();
<span class="predefined-type">Object</span> key = ...
Object value = ...

<span class="comment">// Take the cache key and convert into a byte array</span>
ByteArrayKey bytesKey = <span class="keyword">new</span> ByteArrayKey(marshaller.objectToByteBuffer(key));

<span class="comment">// With the value to store, a new CacheEntry instance needs to be created:</span>
CacheEntry cacheEntry = InternalEntryFactory.create(bytesKey, value, ...)

<span class="comment">// Internally, Hot Rod stores values wrapped in a CacheValue, so create instance</span>
<span class="comment">// Remember that you need to give it a version number, so either:</span>
<span class="comment">// 1. Increment previous value's version</span>
<span class="comment">// 2. Or generate a new version number that minimises potential clash</span>
<span class="comment">//Â Â Â  with a concurrent update to the same key in the cluster</span>
CacheValue cacheValue = <span class="keyword">new</span> CacheValue(
<span class="error">Â </span><span class="error">Â </span> marshaller.objectToByteBuffer(cacheEntry), <span class="integer">1</span>)

<span class="comment">// Finally, store it in the cache</span>
cache.put(bytesKey, cacheValue);</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="multiple_tiers_of_caches"><a class="anchor" href="#multiple_tiers_of_caches"></a>Multiple Tiers of Caches</h5> <div class="paragraph"> <p>A combination of the Hot Rod protocol and <a href="http://community.jboss.org/docs/DOC-14893?uniqueTitle=false#Remote_cache_loader">RemoteCacheLoader</a> opened the way for a set of new architectures in Infinispan, where layers of caches can exists and interact. This article takes a look at such a layered architecture.</p> </div> <div class="sect5"> <h6 id="sample_architecture_near_caching"><a class="anchor" href="#sample_architecture_near_caching"></a>Sample architecture/near caching</h6> <div class="imageblock"> <div class="content"> <img src="./images/client_server.png" alt="client server"> </div> </div> <div class="paragraph"> <p>The diagram above shows an Infinispan server cluster running 3 hotrod servers. This cluster is accessed remotely, through HotRod, by another infinispan cluster:Â  client cluster (upper part of the image). All the nodes in the server cluster are configured to run HotRod servers, so requests from remote loader are being balanced between them. The client cluster is configured with invalidation as cluster mode and a RemoteCacheLoader to access data stored in the server cluster. Application data is held on the server cluster which runs in DIST mode for scalability.</p> </div> <div class="paragraph"> <p>In this deployment the client code, running in same address space with the client cluster,Â  holds all its data in the server cluster. Client cluster acts as an <em>near-cache</em> for frequently accessed entries.</p> </div> </div> </div> </div> <div class="sect3"> <h4 id="querying_via_the_java_hot_rod_client"><a class="anchor" href="#querying_via_the_java_hot_rod_client"></a>14.4.10. Querying via the Java Hot Rod client</h4> <div class="paragraph"> <p>While previous Infinispan versions were already providing <a href="#_querying_infinispan">indexing and searching</a> of Java entities to embedded clients, starting with Infinispan 6.0 and the introduction of the new <a href="#_hot_rod_protocol_1_3">Hot Rod protocol version 1.3</a> we add support for remote, language neutral, querying.</p> </div> <div class="paragraph"> <p>This leap required two major changes:</p> </div> <div class="ulist"> <ul> <li> <p>Since non-JVM clients cannot benefit from directly using <a href="http://lucene.apache.org/">Apache Lucene</a>'s Java API, Infinispan defines its own new <a href="#_infinispan_s_query_dsl">query language</a>, based on an internal DSL that is easily implementable in all languages for which we currently have an implementation of the Hot Rod client.</p> </li> <li> <p>In order to enable indexing, the entities put in the cache by clients can no longer be opaque binary blobs understood solely by the client. Their structure has to be known to both server and client, so a common way of encoding structured data had to be adopted. Furthermore, allowing multi-language clients to access the data requires a language and platform-neutral encoding. Google&#8217;s <a href="http://code.google.com/p/protobuf/">Protocol Buffers</a> was elected as an encoding format for both over-the-wire and storage due to its efficiency, robustness, good multi-language support and support for schema evolution.</p> </li> </ul> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> As of 6.0, only the Java implementation of the Hot Rod client was upgraded to support querying. Clients for other languages will follow soon. </td> </tr> </table> </div> <div class="sect4"> <h5 id="storing_protobuf_encoded_entities"><a class="anchor" href="#storing_protobuf_encoded_entities"></a>Storing Protobuf encoded entities</h5> <div class="paragraph"> <p>Remote clients that want to be able to index and query their stored entities must do so using the Protobuf encoding format. This is <em>key</em> for the search capability to work. But it&#8217;s also possible to store Protobuf entities just for gaining the benefit of platform independence and not enable indexing if you do not need it.</p> </div> <div class="paragraph"> <p>Protobuf is all about structured data, so first thing you do to use it is define the structure of your data. This is accomplished by declaring protocol buffer message types in .proto files, like in the following example. Protobuf is a broad subject, we will not detail it here, so please consult the Protobuf <a href="https://developers.google.com/protocol-buffers/docs/overview">Developer Guide</a> for an in-depth explanation. It suffices to say for now that our example defines an entity (message type in protobuf speak) named <em>Book</em>, placed in a package named <em>book_sample</em>. Our entity declares several fields of primitive types and a repeatable field (an array basically) named <em>authors</em>. The <em>Author</em> message instances are embedded in the <em>Book</em> message instance.</p> </div> <div class="listingblock"> <div class="title">library.proto</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="proto">package book_sample;

message Book {
  required string title = 1;
  required string description = 2;
  required int32 publicationYear = 3; // no native Date type available in Protobuf

  repeated Author authors = 4;
}

message Author {
  required string name = 1;
  required string surname = 2;
}</code></pre> </div> </div> <div class="paragraph"> <p>There are a few important notes we need to make about Protobuf messages:</p> </div> <div class="ulist"> <ul> <li> <p>nesting of messages is possible, but the resulting structure is strictly a tree, never a graph</p> </li> <li> <p>there is no concept of type inheritance</p> </li> <li> <p>collections are not supported but arrays can be easily emulated using repeated fields</p> </li> </ul> </div> <div class="paragraph"> <p>Using Protobuf with the Java Hot Rod client is a two step process. First, the client must be configured to use a dedicated marshaller, <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/client/hotrod/marshall/ProtoStreamMarshaller.html"><em>ProtoStreamMarshaller</em></a>. This marshaller uses the <a href="https://github.com/infinispan/protostream"><em>ProtoStream</em></a> library to assist you in encoding your objects. The second step is instructing <em>ProtoStream</em> library on how to marshall your message types. The following example highlights this process.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td> <td class="code"><pre><span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.configuration.ConfigurationBuilder</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.marshall.ProtoStreamMarshaller</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.protostream.SerializationContext</span>;
...

ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder.addServer()
    .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>).port(<span class="integer">11234</span>)
    .marshaller(<span class="keyword">new</span> ProtoStreamMarshaller());

RemoteCacheManager remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager(clientBuilder.build());

SerializationContext srcCtx = ProtoStreamMarshaller.getSerializationContext(remoteCacheManager);

serCtx.registerProtofiles(<span class="string"><span class="delimiter">&quot;</span><span class="content">/library.proto</span><span class="delimiter">&quot;</span></span>);
serCtx.registerMarshaller(<span class="predefined-type">Book</span>.class, <span class="keyword">new</span> BookMarshaller());
serCtx.registerMarshaller(Author.class, <span class="keyword">new</span> AuthorMarshaller());

<span class="comment">// Book and Author classes omitted for brevity</span></pre></td> </tr></table></code></pre> </div> </div> <div class="paragraph"> <p>The interesting part in this sample is obtaining the <em>SerializationContext</em> associated to the <em>RemoteCacheManager</em> and then instructing ProtoStream about the protobuf types we want to marshall. The <em>SerializationContext</em> is provided by the library for this purpose. The <code>SerializationContext.registerProtoFiles</code> method receives the name of one or more classpath resources that is expected to be a protobuf definition containing our type declarations.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> A <em>RemoteCacheManager</em> has no <em>SerializationContext</em> associated with it unless it was configured to use a <em>ProtoStreamMarshaller</em>. </td> </tr> </table> </div> <div class="paragraph"> <p>The next relevant part is the registration of per entity marshallers for our domain model types. They must be provided by the user for each type or marshalling will fail. Writing marshallers is a simple process. The <em>BookMarshaller</em> example should get you started. The most important thing you need to consider is they need to be stateless and threadsafe as a single instance of them is being used.</p> </div> <div class="listingblock"> <div class="title">BookMarshaller.java</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.protostream.MessageMarshaller</span>;
...

public <span class="type">class</span> <span class="class">BookMarshaller</span> <span class="directive">implements</span> MessageMarshaller&lt;<span class="predefined-type">Book</span>&gt; {

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">String</span> getTypeName() {
      <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">book_sample.Book</span><span class="delimiter">&quot;</span></span>;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> <span class="predefined-type">Book</span>&gt; getJavaClass() {
      <span class="keyword">return</span> <span class="predefined-type">Book</span>.class;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> writeTo(ProtoStreamWriter writer, <span class="predefined-type">Book</span> book) <span class="directive">throws</span> <span class="exception">IOException</span> {
      writer.writeString(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, book.getTitle());
      writer.writeString(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>, book.getDescription());
      writer.writeCollection(<span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span>, book.getAuthors(), Author.class);
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">Book</span> readFrom(ProtoStreamReader reader) <span class="directive">throws</span> <span class="exception">IOException</span> {
      <span class="predefined-type">String</span> title = reader.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>);
      <span class="predefined-type">String</span> description = reader.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>);
      <span class="type">int</span> publicationYear = reader.readInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>);
      <span class="predefined-type">Set</span>&lt;Author&gt; authors = reader.readCollection(<span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;Author&gt;(), Author.class);
      <span class="keyword">return</span> <span class="keyword">new</span> <span class="predefined-type">Book</span>(title, description, publicationYear, authors);
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>Once you&#8217;ve followed these steps to setup your client you can start reading and writing Java objects to the remote cache and the actual data stored in the cache will be protobuf encoded provided that marshallers were registered with the remote client for all involved types (<em>Book</em> and <em>Author</em> in our example). Keeping your objects stored in protobuf format has the benefit of being able to consume them with compatible clients written in different languages.</p> </div> <div class="paragraph"> <p>TODO Add reference to sample in C++ client user guide</p> </div> </div> <div class="sect4"> <h5 id="indexing_of_protobuf_encoded_entries"><a class="anchor" href="#indexing_of_protobuf_encoded_entries"></a>Indexing of Protobuf encoded entries</h5> <div class="paragraph"> <p>After configuring the client as described in the previous section you can start configuring indexing for your caches on the server side. Activating indexing and the various indexing specific configurations is identical to embedded mode and is detailed in the <a href="#_configuration_7">Querying Infinispan</a> chapter.</p> </div> <div class="paragraph"> <p>There is however an extra configuration step involved. While in embedded mode the indexing metadata is obtained via Java reflection by analyzing the presence of various Hibernate Search annotations on the entry&#8217;s class, this is obviously not possible if the entry is protobuf encoded. The server needs to extract the relevant metadata from the same descriptor (.proto file) as the client. The descriptor is currently supplied to the server by remotely invoking the <em>ProtobufMetadataManager</em> MBean via JMX. The <em>ProtobufMetadataManager</em> is a cluster-wide replicated repository of protobuf descriptors. For each running cache manager a separate <em>ProtobufMetadataManager</em> MBean instance exists. Its ObjectName follows this pattern:</p> </div> <div class="literalblock"> <div class="content"> <pre>&lt;jmx domain&gt;:type=RemoteQuery,name=&lt;cache manager name&gt;,component=ProtobufMetadataManager</pre> </div> </div> <div class="paragraph"> <p>The method relevant for registering the protobuf descriptor file has the signature:</p> </div> <div class="literalblock"> <div class="content"> <pre>void registerProtofile(String names[]. String contents[])</pre> </div> </div> <div class="paragraph"> <p>A detailed example for all the described steps can be seen in the Java Hot Rod client test suite, particularly in <a href="https://github.com/infinispan/infinispan/blob/master/client/hotrod-client/src/test/java/org/infinispan/client/hotrod/query/HotRodQueryTest.java">HotRodQueryTest</a></p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Once indexing is enabled for a cache all fields of Protobuf encoded entries are going to be indexed. Future versions will allow you to select which fields to index (see <a href="https://issues.jboss.org/browse/ISPN-3718">ISPN-3718</a>). </td> </tr> </table> </div> </div> <div class="sect4"> <h5 id="a_remote_query_example"><a class="anchor" href="#a_remote_query_example"></a>A remote query example</h5> <div class="paragraph"> <p>You&#8217;ve managed to configure both client and server to talk protobuf and you&#8217;ve enabled indexing. Let&#8217;s put some data in the cache and try to search for it then!</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.query.dsl</span>.*;
...

RemoteCacheManager remoteCacheManager = ...;
RemoteCache&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">Book</span>&gt; remoteCache = remoteCacheManager.getCache();

<span class="predefined-type">Book</span> book1 = <span class="keyword">new</span> <span class="predefined-type">Book</span>();
book1.setTitle(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hibernate in Action</span><span class="delimiter">&quot;</span></span>);
remoteCache.put(<span class="integer">1</span>, book1);

<span class="predefined-type">Book</span> book2 = <span class="keyword">new</span> <span class="predefined-type">Book</span>();
book2.setTile(<span class="string"><span class="delimiter">&quot;</span><span class="content">Infinispan Data Grid Platform</span><span class="delimiter">&quot;</span></span>);
remoteCache.put(<span class="integer">2</span>, book2);

QueryFactory qf = Search.getQueryFactory(remoteCache);
<span class="predefined-type">Query</span> query = qf.from(<span class="predefined-type">Book</span>.class)
            .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Infinispan%</span><span class="delimiter">&quot;</span></span>).toBuilder()
            .build();

<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; list = query.list(); <span class="comment">// Voila! We have our book back from the cache!</span></code></pre> </div> </div> <div class="paragraph"> <p>The key part of creating a query is obtaining the <em>QueryFactory</em> for the remote cache using the <em>org.infinispan.client.hotrod.Search.getQueryFactory()</em> method. Once you have this creating the query is similar to embedded mode which is covered in <a href="#_infinispan_s_query_dsl">this</a> section.</p> </div> </div> <div class="sect4"> <h5 id="running_in_compatibility_mode"><a class="anchor" href="#running_in_compatibility_mode"></a>Running in Compatibility Mode</h5> <div class="paragraph"> <p>TODO</p> </div> </div> </div> </div> <div class="sect2"> <h3 id="scripting"><a class="anchor" href="#scripting"></a>14.5. Scripting</h3> <div class="paragraph"> <p>Scripting is a feature of Infinispan Server which allows invoking server-side scripts from remote clients. Scripting leverages the JDK&#8217;s javax.script ScriptEngines, therefore allowing the use of any JVM languages which offer one. By default, the JDK comes with Nashorn, a ScriptEngine capable of running JavaScript.</p> </div> <div class="sect3"> <h4 id="installing_scripts"><a class="anchor" href="#installing_scripts"></a>14.5.1. Installing scripts</h4> <div class="paragraph"> <p>Scripts are stored in a special script cache, named '___script_cache'. Adding a script is therefore as simple as put+ting it into the cache itself. If the name of the script contains a filename extension, e.g. +myscript.js, then that extension determines the engine that will be used to execute it. Alternatively the script engine can be selected using script metadata (see below).</p> </div> </div> <div class="sect3"> <h4 id="script_metadata"><a class="anchor" href="#script_metadata"></a>14.5.2. Script metadata</h4> <div class="paragraph"> <p>Script metadata is additional information about the script that the user can provide to the server to affect how a script is executed. It is contained in a specially-formatted comment on the first lines of the script.</p> </div> <div class="paragraph"> <p>Properties are specified as key=value pairs, separated by commas. You can use several different comment styles: The <code>//</code>, <code>;;</code>, <code>#</code> depending on the scripting language you use. You can split metadata over multiple lines if necessary, and you can use single (') or double (") quotes to delimit your values.</p> </div> <div class="paragraph"> <p>The following are examples of valid metadata comments:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// name=test, language=javascript</span>
<span class="comment">// mode=local, parameters=[a,b,c]</span></code></pre> </div> </div> <div class="sect4"> <h5 id="metadata_properties"><a class="anchor" href="#metadata_properties"></a>Metadata properties</h5> <div class="paragraph"> <p>The following metadata property keys are available</p> </div> <div class="ulist"> <ul> <li> <p>mode: defines the mode of execution of a script. Can be one of the following values:</p> <div class="ulist"> <ul> <li> <p>local: the script will be executed only by the node handling the request. The script itself however can invoke clustered operations</p> </li> <li> <p>distributed: runs the script using the Distributed Executor Service</p> </li> <li> <p>mapper: runs the script as the mapper of map/reduce job. This property also requires that the user specify a reducer property and optional collator and combiner properties. This mode is deprecated and will be removed in Infinispan 9. Use local mode and the distributed streams API instead.</p> </li> <li> <p>reducer: this type of script can&#8217;t be executed directly, but must be specified as a reducer property on a script of type mapper. This mode is deprecated and will be removed in Infinispan 9. Use local mode and the distributed streams API instead.</p> </li> <li> <p>collator: this type of script can&#8217;t be executed directly, but must be specified as a collator property on a script of type mapper. This mode is deprecated and will be removed in Infinispan 9. Use local mode and the distributed streams API instead.</p> </li> <li> <p>combiner: this type of script can&#8217;t be executed directly, but must be specified as a combiner property on a script of type mapper. This mode is deprecated and will be removed in Infinispan 9. Use local mode and the distributed streams API instead.</p> </li> </ul> </div> </li> <li> <p>language: defines the script engine that will be used to execute the script, e.g. Javascript</p> </li> <li> <p>extension: an alternative method of specifying the script engine that will be used to execute the script, e.g. js</p> </li> <li> <p>role: a specific role which is required to execute the script</p> </li> <li> <p>reducer: this property is only valid for mapper scripts, and specifies the name of another script that will be used for the reduce phase of a map/reduce job. This property will be removed in Infinispan 9.</p> </li> <li> <p>collator: this property is only valid for mapper scripts, and specifies the name of another script that will be used for the collation phase of a map/reduce job. This property will be removed in Infinispan 9.</p> </li> <li> <p>combiner: this property is only valid for mapper scripts, and specifies the name of another script that will be used for the combine phase of a map/reduce job. This property will be removed in Infinispan 9.</p> </li> <li> <p>parameters: an array of valid parameter names for this script. Invocations which specify parameter names not included in this list will cause an exception.</p> </li> <li> <p>datatype: optional property providing information, in the form of Media Types (also known as MIME) about the type of the data stored in the caches, as well as parameter and return values. Currently it only accepts a single value which is <code>text/plain; charset=utf-8</code>, indicating that data is String UTF-8 format. This metadata parameter is designed for remote clients that only support a particular type of data, making it easy for them to retrieve, store and work with parameters.</p> </li> </ul> </div> <div class="paragraph"> <p>Since the execution mode is a characteristic of the script, nothing special needs to be done on the client to invoke scripts in different modes.</p> </div> </div> </div> <div class="sect3"> <h4 id="script_bindings"><a class="anchor" href="#script_bindings"></a>14.5.3. Script bindings</h4> <div class="paragraph"> <p>The script engine within Infinispan exposes several internal objects as bindings in the scope of the script execution. These are:</p> </div> <div class="ulist"> <ul> <li> <p>cache: the cache against which the script is being executed</p> </li> <li> <p>marshaller: the marshaller to use for marshalling/unmarshalling data to the cache</p> </li> <li> <p>cacheManager: the cacheManager for the cache</p> </li> <li> <p>scriptingManager: the instance of the script manager which is being used to run the script. This can be used to run other scripts from a script.</p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="script_parameters"><a class="anchor" href="#script_parameters"></a>14.5.4. Script parameters</h4> <div class="paragraph"> <p>Aside from the standard bindings described above, when a script is executed it can be passed a set of named parameters which also appear as bindings. Parameters are passed as name,value pairs where name is a string and value can be any value that is understood by the marshaller in use.</p> </div> <div class="paragraph"> <p>The following is an example of a JavaScript script which takes two parameters, multiplicand and multiplier and multiplies them. Because the last operation is an expression evaluation, its result is returned to the invoker.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// mode=local,language=javascript</span>
multiplicand * multiplier</code></pre> </div> </div> <div class="paragraph"> <p>To store the script in the script cache, use the following Hot Rod code:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; scriptCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">___script_cache</span><span class="delimiter">&quot;</span></span>);
scriptCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">multiplication.js</span><span class="delimiter">&quot;</span></span>,
  <span class="string"><span class="delimiter">&quot;</span><span class="content">// mode=local,language=javascript</span><span class="char">\n</span><span class="delimiter">&quot;</span></span> +
  <span class="string"><span class="delimiter">&quot;</span><span class="content">multiplicand * multiplier</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="running_scripts_using_the_hot_rod_java_client"><a class="anchor" href="#running_scripts_using_the_hot_rod_java_client"></a>14.5.5. Running Scripts using the Hot Rod Java client</h4> <div class="paragraph"> <p>The following example shows how to invoke the above script by passing two named parameters.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Integer</span>&gt; cache = cacheManager.getCache();
<span class="comment">// Create the parameters for script execution</span>
<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; params = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
params.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">multiplicand</span><span class="delimiter">&quot;</span></span>, <span class="integer">10</span>);
params.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">multiplier</span><span class="delimiter">&quot;</span></span>, <span class="integer">20</span>);
<span class="comment">// Run the script on the server, passing in the parameters</span>
<span class="predefined-type">Object</span> result = cache.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">multiplication.js</span><span class="delimiter">&quot;</span></span>, params);</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="distributed_execution"><a class="anchor" href="#distributed_execution"></a>14.5.6. Distributed execution</h4> <div class="paragraph"> <p>The following is a script which runs within a Distributed Executor. Each node will return its address, and the results from all nodes will be collected in a List and returned to the client.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// mode:distributed,language=javascript</span>
cacheManager.getAddress().toString();</code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="infinispan_rest_server"><a class="anchor" href="#infinispan_rest_server"></a>14.6. Infinispan REST Server</h3> <div class="paragraph"> <p>The Infinispan Server distribution contains a server module that implements <a href="http://en.wikipedia.org/wiki/Representational_State_Transfer">RESTful</a> HTTP access to the Infinispan data grid, built on JAX_RS. Please refer to Infinispan Server&#8217;s <a href="../infinispan_server_guide/infinispan_server_guide.html">documentation</a> for instructions on how to configure and run a REST server.</p> </div> <div class="sect3"> <h4 id="rest_api"><a class="anchor" href="#rest_api"></a>14.6.1. REST API</h4> <div class="paragraph"> <p>HTTP PUT and POST methods are used to place data in the cache, with URLs to address the cache name and key(s) - the data being the body of the request (the data can be anything you like). It is important that a Content-Type header is set. Other headers are used to control the cache settings and behaviour (detailed in that link).</p> </div> <div class="sect4"> <h5 id="putting_data_in"><a class="anchor" href="#putting_data_in"></a>Putting data in</h5> <div class="sect5"> <h6 id="code_put_cachename_cachekey_code"><a class="anchor" href="#code_put_cachename_cachekey_code"></a><code>PUT /{cacheName}/{cacheKey}</code></h6> <div class="paragraph"> <p>A PUT request of the above URL form will place the payload (body) in the given cache, with the given key (the named cache must exist on the server). For example <code><a href="http://someserver/hr/payRoll/3" class="bare">http://someserver/hr/payRoll/3</a></code> (in which case <code>hr</code> is the cache name, and <code>payRoll/3</code> is the key). Any existing data will be replaced, and Time-To-Live and Last-Modified values etc will updated (if applicable).</p> </div> </div> <div class="sect5"> <h6 id="code_post_cachename_cachekey_code"><a class="anchor" href="#code_post_cachename_cachekey_code"></a><code>POST /{cacheName}/{cacheKey}</code></h6> <div class="paragraph"> <p>Exactly the same as PUT, only if a value in a cache/key already exists, it will return a Http CONFLICT status (and the content will not be updated).</p> </div> </div> <div class="sect5"> <h6 id="headers"><a class="anchor" href="#headers"></a>Headers</h6> <div class="ulist"> <ul> <li> <p>Content-Type : MANDATORY (use <a href="http://www.iana.org/assignments/media-types/">media/mime-types</a> for example: "application/json"). If you set the Content-Type to <code>application/x-java-serialized-object</code>, then it will be stored as a Java object</p> </li> <li> <p>performAsync : OPTIONAL true/false (if true, this will return immediately, and then replicate data to the cluster on its own. Can help with bulk data inserts/large clusters.)</p> </li> <li> <p>timeToLiveSeconds : OPTIONAL number (the number of seconds before this entry will automatically be deleted). If no parameter is sent, Infinispan assumes -1 as default value, which means that the entry will not expire. Passing any negative value will have the same effect.</p> </li> <li> <p>maxIdleTimeSeconds : OPTIONAL number (the number of seconds after last usage of this entry when it will automatically be deleted). If no parameter is sent, Infinispan assumes -1 as default value, which means that the entry will not expire as a result of idle time. Passing any negative value will have the same effect.</p> </li> </ul> </div> <div class="ulist"> <div class="title">Passing 0 as parameter for timeToLiveSeconds and/or maxIdleTimeSeconds</div> <ul> <li> <p>If both <code>timeToLiveSeconds</code> and <code>maxIdleTimeSeconds</code> are 0, the cache will use the default <code>lifespan</code> and <code>maxIdle</code> values configured in XML/programmatically</p> </li> <li> <p>If <em>only</em> <code>maxIdleTimeSeconds</code> is 0, it uses the <code>timeToLiveSeconds</code> value passed as parameter (or -1 if not present), and default <code>maxIdle</code> configured in XML/programmatically</p> </li> <li> <p>If <em>only</em> <code>timeToLiveSeconds</code> is 0, it uses default <code>lifespan</code> configured in XML/programmatically, and <code>maxIdle</code> is set to whatever came as parameter (or -1 if not present)</p> </li> </ul> </div> </div> </div> <div class="sect4"> <h5 id="getting_data_back_out"><a class="anchor" href="#getting_data_back_out"></a>Getting data back out</h5> <div class="paragraph"> <p>HTTP GET and HEAD are used to retrieve data from entries.</p> </div> <div class="sect5"> <h6 id="code_get_cachename_cachekey_code"><a class="anchor" href="#code_get_cachename_cachekey_code"></a><code>GET /{cacheName}/{cacheKey}</code></h6> <div class="paragraph"> <p>This will return the data found in the given cacheName, under the given key - as the body of the response. A Content-Type header will be supplied which matches what the data was inserted as (other then if it is a Java object, see below). Browsers can use the cache directly of course (eg as a CDN). An <a href="http://en.wikipedia.org/wiki/HTTP_ETag">ETag</a> will be returned unique for each entry, as will the Last-Modified and Expires headers field indicating the state of the data at the given URL. ETags allow browsers (and other clients) to ask for data only in the case where it has changed (to save on bandwidth) - this is standard HTTP and is honoured by Infinispan.</p> </div> <div class="paragraph"> <p>Since Infinispan 5.3 it is possible to obtain additional information by appending the "extended" parameter on the query string, as follows:</p> </div> <div class="literalblock"> <div class="content"> <pre>GET /cacheName/cacheKey?extended</pre> </div> </div> <div class="paragraph"> <p>This will return the following custom headers:</p> </div> <div class="ulist"> <ul> <li> <p>Cluster-Primary-Owner: the node name of the primary owner for this key</p> </li> <li> <p>Cluster-Node-Name: the JGroups node name of the server that has handled the request</p> </li> <li> <p>Cluster-Physical-Address: the physical JGroups address of the server that has handled the request.</p> </li> </ul> </div> </div> <div class="sect5"> <h6 id="code_head_cachename_cachekey_code"><a class="anchor" href="#code_head_cachename_cachekey_code"></a><code>HEAD /{cacheName}/{cacheKey}</code></h6> <div class="paragraph"> <p>The same as GET, only no content is returned (only the header fields). You will receive the same content that you stored. E.g., if you stored a String, this is what you get back. If you stored some XML or JSON, this is what you will receive. If you stored a binary (base 64 encoded) blob, perhaps a serialized; Java; object - you will need to; deserialize this yourself.</p> </div> <div class="paragraph"> <p>Similarly to the GET method, the HEAD method also supports returning extended information via headers. See above.</p> </div> </div> </div> <div class="sect4"> <h5 id="listing_keys"><a class="anchor" href="#listing_keys"></a>Listing keys</h5> <div class="sect5"> <h6 id="code_get_cachename_code"><a class="anchor" href="#code_get_cachename_code"></a><code>GET /{cacheName}</code></h6> <div class="paragraph"> <p>This will return a list of keys present in the given cacheName as the body of the response. The format of the response can be controlled via the Accept header as follows:</p> </div> <div class="ulist"> <ul> <li> <p>application/xml - the list of keys will be returned in XML format.</p> </li> <li> <p>application/json - the list of keys will be return in JSON format.</p> </li> <li> <p>text/html - the list of keys will be returned in HTML format.</p> </li> <li> <p>text/plain - the list of keys will be returned in plain text format, one key per line</p> </li> </ul> </div> <div class="paragraph"> <p>If the cache identified by cacheName is distributed, only the keys owned by the node handling the request will be returned. To return all keys, append the "global" parameter to the query, as follows:</p> </div> <div class="literalblock"> <div class="content"> <pre>GET /cacheName?global</pre> </div> </div> </div> </div> <div class="sect4"> <h5 id="removing_data"><a class="anchor" href="#removing_data"></a>Removing data</h5> <div class="paragraph"> <p>Data can be removed at the cache key/element level, or via a whole cache name using the HTTP delete method.</p> </div> <div class="sect5"> <h6 id="code_delete_cachename_cachekey_code"><a class="anchor" href="#code_delete_cachename_cachekey_code"></a><code>DELETE /{cacheName}/{cacheKey}</code></h6> <div class="paragraph"> <p>Removes the given key name from the cache.</p> </div> </div> <div class="sect5"> <h6 id="code_delete_cachename_code"><a class="anchor" href="#code_delete_cachename_code"></a><code>DELETE /{cacheName}</code></h6> <div class="paragraph"> <p>Removes ALL the entries in the given cache name (i.e., everything from that path down). If the operation is successful, it returns 200 code.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Make it quicker!</div> Set the header performAsync to true to return immediately and let the removal happen in the background. </td> </tr> </table> </div> </div> </div> </div> <div class="sect3"> <h4 id="client_side_code"><a class="anchor" href="#client_side_code"></a>14.6.2. Client side code</h4> <div class="paragraph"> <p>Part of the point of a RESTful service is that you don&#8217;t need to have tightly coupled client libraries/bindings. All you need is a HTTP client library. For Java, Apache HTTP Commons Client works just fine (and is used in the integration tests), or you can use java.net API.</p> </div> <div class="sect4"> <h5 id="ruby_example"><a class="anchor" href="#ruby_example"></a>Ruby example</h5> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="ruby"><span class="comment"># Shows how to interact with Infinispan REST api from ruby.</span>
<span class="comment"># No special libraries, just standard net/http</span>
<span class="comment">#</span>
<span class="comment"># Author: Michael Neale</span>
<span class="comment">#</span>
require <span class="string"><span class="delimiter">'</span><span class="content">net/http</span><span class="delimiter">'</span></span>

http = <span class="constant">Net</span>::<span class="constant">HTTP</span>.new(<span class="string"><span class="delimiter">'</span><span class="content">localhost</span><span class="delimiter">'</span></span>, <span class="integer">8080</span>)

<span class="comment">#Create new entry</span>
http.post(<span class="string"><span class="delimiter">'</span><span class="content">/infinispan/rest/MyData/MyKey</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">DATA HERE</span><span class="delimiter">'</span></span>, {<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>})

<span class="comment">#get it back</span>
puts http.get(<span class="string"><span class="delimiter">'</span><span class="content">/infinispan/rest/MyData/MyKey</span><span class="delimiter">'</span></span>).body

<span class="comment">#use PUT to overwrite</span>
http.put(<span class="string"><span class="delimiter">'</span><span class="content">/infinispan/rest/MyData/MyKey</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">MORE DATA</span><span class="delimiter">'</span></span>, {<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>})

<span class="comment">#and remove...</span>
http.delete(<span class="string"><span class="delimiter">'</span><span class="content">/infinispan/rest/MyData/MyKey</span><span class="delimiter">'</span></span>)

<span class="comment">#Create binary data like this... just the same...</span>
http.put(<span class="string"><span class="delimiter">'</span><span class="content">/infinispan/rest/MyImages/Image.png</span><span class="delimiter">'</span></span>, <span class="constant">File</span>.read(<span class="string"><span class="delimiter">'</span><span class="content">/Users/michaelneale/logo.png</span><span class="delimiter">'</span></span>), {<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">image/png</span><span class="delimiter">&quot;</span></span>})


<span class="comment">#and if you want to do json...</span>
require <span class="string"><span class="delimiter">'</span><span class="content">rubygems</span><span class="delimiter">'</span></span>
require <span class="string"><span class="delimiter">'</span><span class="content">json</span><span class="delimiter">'</span></span>

<span class="comment">#now for fun, lets do some JSON !</span>
data = {<span class="symbol">:name</span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">michael</span><span class="delimiter">&quot;</span></span>, <span class="symbol">:age</span> =&gt; <span class="integer">42</span> }
http.put(<span class="string"><span class="delimiter">'</span><span class="content">/infinispan/rest/Users/data/0</span><span class="delimiter">'</span></span>, data.to_json, {<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>})</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="python_example"><a class="anchor" href="#python_example"></a>Python example</h5> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># Sample python code using the standard http lib only</span>
<span class="comment">#</span>

<span class="keyword">import</span> <span class="include">httplib</span>


<span class="comment">#putting data in</span>
conn = httplib.HTTPConnection(<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost:8080</span><span class="delimiter">&quot;</span></span>)
data = <span class="string"><span class="delimiter">&quot;</span><span class="content">SOME DATA HERE </span><span class="content">\!</span><span class="delimiter">&quot;</span></span> <span class="comment">#could be string, or a file...</span>
conn.request(<span class="string"><span class="delimiter">&quot;</span><span class="content">POST</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">/infinispan/rest/Bucket/0</span><span class="delimiter">&quot;</span></span>, data, {<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>})
response = conn.getresponse()
<span class="keyword">print</span> response.status

<span class="comment">#getting data out</span>
<span class="keyword">import</span> <span class="include">httplib</span>
conn = httplib.HTTPConnection(<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost:8080</span><span class="delimiter">&quot;</span></span>)
conn.request(<span class="string"><span class="delimiter">&quot;</span><span class="content">GET</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">/infinispan/rest/Bucket/0</span><span class="delimiter">&quot;</span></span>)
response = conn.getresponse()
<span class="keyword">print</span> response.status
<span class="keyword">print</span> response.read()</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="java_example"><a class="anchor" href="#java_example"></a>Java example</h5> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.io.BufferedReader</span>;
<span class="keyword">import</span> <span class="include">java.io.IOException</span>;
<span class="keyword">import</span> <span class="include">java.io.InputStreamReader</span>;
<span class="keyword">import</span> <span class="include">java.io.OutputStreamWriter</span>;
<span class="keyword">import</span> <span class="include">java.net.HttpURLConnection</span>;
<span class="keyword">import</span> <span class="include">java.net.URL</span>;

<span class="comment">/**
 * Rest example accessing Infinispan Cache.
 * @author Samuel Tauil (samuel@redhat.com)
 *
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">RestExample</span> {

   <span class="comment">/**
    * Method that puts a String value in cache.
    * @param urlServerAddress
    * @param value
    * @throws IOException
    */</span>
   <span class="directive">public</span> <span class="type">void</span> putMethod(<span class="predefined-type">String</span> urlServerAddress, <span class="predefined-type">String</span> value) <span class="directive">throws</span> <span class="exception">IOException</span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>   <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Executing PUT</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="predefined-type">URL</span> address = <span class="keyword">new</span> <span class="predefined-type">URL</span>(urlServerAddress);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">executing request </span><span class="delimiter">&quot;</span></span> + urlServerAddress);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="predefined-type">HttpURLConnection</span> connection = (<span class="predefined-type">HttpURLConnection</span>) address.openConnection();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Executing put method of value: </span><span class="delimiter">&quot;</span></span> + value);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>connection.setRequestMethod(<span class="string"><span class="delimiter">&quot;</span><span class="content">PUT</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>connection.setRequestProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>connection.setDoOutput(<span class="predefined-constant">true</span>);

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="predefined-type">OutputStreamWriter</span> outputStreamWriter = <span class="keyword">new</span> <span class="predefined-type">OutputStreamWriter</span>(connection.getOutputStream());
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>outputStreamWriter.write(value);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>connection.connect();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>outputStreamWriter.flush();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="predefined-type">System</span>.out.println(connection.getResponseCode() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span> + connection.getResponseMessage());
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>connection.disconnect();
   }

   <span class="comment">/**
    * Method that gets a value by a key in url as param value.
    * @param urlServerAddress
    * @return String value
    * @throws IOException
    */</span>
   <span class="directive">public</span> <span class="predefined-type">String</span> getMethod(<span class="predefined-type">String</span> urlServerAddress) <span class="directive">throws</span> <span class="exception">IOException</span> {
      <span class="predefined-type">String</span> line = <span class="keyword">new</span> <span class="predefined-type">String</span>();
      <span class="predefined-type">StringBuilder</span> stringBuilder = <span class="keyword">new</span> <span class="predefined-type">StringBuilder</span>();

      <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);
      <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Executing GET</span><span class="delimiter">&quot;</span></span>);
      <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);

      <span class="predefined-type">URL</span> address = <span class="keyword">new</span> <span class="predefined-type">URL</span>(urlServerAddress);
      <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">executing request </span><span class="delimiter">&quot;</span></span> + urlServerAddress);

      <span class="predefined-type">HttpURLConnection</span> connection = (<span class="predefined-type">HttpURLConnection</span>) address.openConnection();
      connection.setRequestMethod(<span class="string"><span class="delimiter">&quot;</span><span class="content">GET</span><span class="delimiter">&quot;</span></span>);
      connection.setRequestProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>);
      connection.setDoOutput(<span class="predefined-constant">true</span>);

      <span class="predefined-type">BufferedReader</span>&amp;nbsp; bufferedReader = <span class="keyword">new</span> <span class="predefined-type">BufferedReader</span>(<span class="keyword">new</span> <span class="predefined-type">InputStreamReader</span>(connection.getInputStream()));

      connection.connect();

      <span class="keyword">while</span> ((line = bufferedReader.readLine()) <span class="error">\</span>!= <span class="predefined-constant">null</span>) {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>   stringBuilder.append(line + <span class="string"><span class="delimiter">'</span><span class="content">\n</span><span class="delimiter">'</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>}

      <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Executing get method of value: </span><span class="delimiter">&quot;</span></span> + stringBuilder.toString());

      <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);
      <span class="predefined-type">System</span>.out.println(connection.getResponseCode() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span> + connection.getResponseMessage());
      <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);

      connection.disconnect();

      <span class="keyword">return</span> stringBuilder.toString();
   }

   <span class="comment">/**
    * Main method example.
    * @param args
    * @throws IOException
    */</span>
   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="error">\</span>[<span class="error">\</span>] args) <span class="directive">throws</span> <span class="exception">IOException</span> {
      <span class="comment">//Attention to the cache name &quot;cacheX&quot; it was configured in xml file with tag &lt;*-cache name=&quot;cacheX&quot;&gt;</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>RestExample restExample = <span class="keyword">new</span> RestExample();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>restExample.putMethod(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/infinispan/rest/cacheX/1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Infinispan REST Test</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>restExample.getMethod(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/infinispan/rest/cacheX/1</span><span class="delimiter">&quot;</span></span>);<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>}
}</code></pre> </div> </div> </div> </div> </div> <div class="sect2"> <h3 id="using_infinispan_memcached_server"><a class="anchor" href="#using_infinispan_memcached_server"></a>14.7. Using Infinispan Memcached Server</h3> <div class="paragraph"> <p>The Infinispan Server distribution contains a server module that implements the <a href="http://github.com/memcached/memcached/blob/master/doc/protocol.txt">Memcached text protocol</a>. This allows Memcached clients to talk to one or several Infinispan backed Memcached servers. These servers could either be working standalone just like Memcached does where each server acts independently and does not communicate with the rest, or they could be clustered where servers replicate or distribute their contents to other Infinispan backed Memcached servers, thus providing clients with failover capabilities. Please refer to Infinispan Server&#8217;s <a href="../infinispan_server_guide/infinispan_server_guide.html">documentation</a> for instructions on how to configure and run a Memcached server.</p> </div> <div class="sect3"> <h4 id="command_clarifications"><a class="anchor" href="#command_clarifications"></a>14.7.1. Command Clarifications</h4> <div class="sect4"> <h5 id="flush_all"><a class="anchor" href="#flush_all"></a>Flush All</h5> <div class="paragraph"> <p>Even in a clustered environment, flush_all command leads to the clearing of the Infinispan Memcached server where the call lands. There&#8217;s no attempt to propagate this flush to other nodes in the cluster. This is done so that flush_all with delay use case can be reproduced with the Infinispan Memcached server. The aim of passing a delay to flush_all is so that different Memcached servers in a full can be flushed at different times, and hence avoid overloading the database with requests as a result of all Memcached servers being empty. For more info, check the <a href="http://github.com/memcached/memcached/blob/master/doc/protocol.txt">Memcached text protocol section on flush_all</a> .</p> </div> </div> </div> <div class="sect3"> <h4 id="unsupported_features"><a class="anchor" href="#unsupported_features"></a>14.7.2. Unsupported Features</h4> <div class="paragraph"> <p>This section explains those parts of the memcached text protocol that for one reason or the other, are not currently supported by the Infinispan based memcached implementation.</p> </div> <div class="sect4"> <h5 id="individual_stats"><a class="anchor" href="#individual_stats"></a>Individual Stats</h5> <div class="paragraph"> <p>Due to difference in nature between the original memcached implementation which is C/C++ based and the Infinispan implementation which is Java based, there&#8217;re some general purpose stats that are not supported. For these unsupported stats, Infinispan memcached server always returns 0.</p> </div> <div class="ulist"> <div class="title">Unsupported statistics</div> <ul> <li> <p>pid</p> </li> <li> <p>pointer_size</p> </li> <li> <p>rusage_user</p> </li> <li> <p>rusage_system</p> </li> <li> <p>bytes</p> </li> <li> <p>curr_connections</p> </li> <li> <p>total_connections</p> </li> <li> <p>connection_structures</p> </li> <li> <p>auth_cmds</p> </li> <li> <p>auth_errors</p> </li> <li> <p>limit_maxbytes</p> </li> <li> <p>threads</p> </li> <li> <p>conn_yields</p> </li> <li> <p>reclaimed</p> </li> </ul> </div> </div> <div class="sect4"> <h5 id="statistic_settings"><a class="anchor" href="#statistic_settings"></a>Statistic Settings</h5> <div class="paragraph"> <p>The settings statistics section of the text protocol has not been implemented due to its volatility.</p> </div> </div> <div class="sect4"> <h5 id="settings_with_arguments_parameter"><a class="anchor" href="#settings_with_arguments_parameter"></a>Settings with Arguments Parameter</h5> <div class="paragraph"> <p>Since the arguments that can be send to the Memcached server are not documented, Infinispan Memcached server does not support passing any arguments to stats command. If any parameters are passed, the Infinispan Memcached server will respond with a CLIENT_ERROR .</p> </div> </div> <div class="sect4"> <h5 id="delete_hold_time_parameter"><a class="anchor" href="#delete_hold_time_parameter"></a>Delete Hold Time Parameter</h5> <div class="paragraph"> <p>Memcached does no longer honor the optional hold time parameter to delete command and so the Infinispan based memcached server does not implement such feature either.</p> </div> </div> <div class="sect4"> <h5 id="verbosity_command"><a class="anchor" href="#verbosity_command"></a>Verbosity Command</h5> <div class="paragraph"> <p>Verbosity command is not supported since Infinispan logging cannot be simplified to defining the logging level alone.</p> </div> </div> </div> <div class="sect3"> <h4 id="talking_to_infinispan_memcached_servers_from_non_java_clients"><a class="anchor" href="#talking_to_infinispan_memcached_servers_from_non_java_clients"></a>14.7.3. Talking To Infinispan Memcached Servers From Non-Java Clients</h4> <div class="paragraph"> <p>This section shows how to talk to Infinispan memcached server via non-java client, such as a python script.</p> </div> <div class="sect4"> <h5 id="multi_clustered_server_tutorial"><a class="anchor" href="#multi_clustered_server_tutorial"></a>Multi Clustered Server Tutorial</h5> <div class="paragraph"> <p>The example showcases the distribution capabilities of Infinispan memcached severs that are not available in the original memcached implementation.</p> </div> <div class="ulist"> <ul> <li> <p>Start two clustered nodes: This configuration is the same one used for the GUI demo:</p> <div class="literalblock"> <div class="content"> <pre>$ ./bin/standalone.sh -c clustered.xml -Djboss.node.name=nodeA
$ ./bin/standalone.sh -c clustered.xml -Djboss.node.name=nodeB -Djboss.socket.binding.port-offset=100</pre> </div> </div> </li> </ul> </div> <div class="paragraph"> <p>Alternatively use</p> </div> <div class="literalblock"> <div class="content"> <pre>$ ./bin/domain.sh</pre> </div> </div> <div class="paragraph"> <p>Which automatically starts two nodes.</p> </div> <div class="ulist"> <ul> <li> <p>Execute <a href="https://github.com/infinispan/infinispan/tree/master/server/memcached/src/test/resources/test_memcached_write.py">test_memcached_write.py</a> script which basically executes several write operations against the Infinispan memcached server bound to port 11211. If the script is executed successfully, you should see an output similar to this:</p> <div class="literalblock"> <div class="content"> <pre>Connecting to 127.0.0.1:11211
Testing set ['Simple_Key': Simple value] ... OK
Testing set ['Expiring_Key' : 999 : 3] ... OK
Testing increment 3 times ['Incr_Key' : starting at 1 ]
Initialise at 1 ... OK
Increment by one ... OK
Increment again ... OK
Increment yet again ... OK
Testing decrement 1 time ['Decr_Key' : starting at 4 ]
Initialise at 4 ... OK
Decrement by one ... OK
Testing decrement 2 times in one call ['Multi_Decr_Key' : 3 ]
Initialise at 3 ... OK
Decrement by 2 ... OK</pre> </div> </div> </li> <li> <p>Execute <a href="https://github.com/infinispan/infinispan/tree/master/server/memcached/src/test/resources/test_memcached_read.py">test_memcached_read.py</a> script which connects to server bound to 127.0.0.1:11311 and verifies that it can read the data that was written by the writer script to the first server. If the script is executed successfully, you should see an output similar to this:</p> <div class="literalblock"> <div class="content"> <pre>Connecting to 127.0.0.1:11311
Testing get ['Simple_Key'] should return Simple value ... OK
Testing get ['Expiring_Key'] should return nothing... OK
Testing get ['Incr_Key'] should return 4 ... OK
Testing get ['Decr_Key'] should return 3 ... OK
Testing get ['Multi_Decr_Key'] should return 1 ... OK</pre> </div> </div> </li> </ul> </div> </div> </div> </div> <div class="sect2"> <h3 id="infinispan_websocket_server"><a class="anchor" href="#infinispan_websocket_server"></a>14.8. Infinispan WebSocket Server</h3> <div class="paragraph"> <p>The Infinispan Server distribution contains a server module that implements the <a href="http://dev.w3.org/html5/websockets/">WebSocket Interface</a> via a very simple Javascript "Cache" API. The WebSocket Interface was introduced as part of the HTML 5 specification.Â  It defines a full-duplex communication channel to the browser, operating over a single socket (unlike Comet or Ajax) and is exposed to the browser via a Javascript interface. Please refer to Infinispan Server&#8217;s <a href="../infinispan_server_guide/infinispan_server_guide.html">documentation</a> for instructions on how to configure and run a WebSocket server.</p> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> This is a highly experimental module. </td> </tr> </table> </div> <div class="sect3"> <h4 id="javascript_api"><a class="anchor" href="#javascript_api"></a>14.8.1. Javascript API</h4> <div class="paragraph"> <p>Writing a web page that uses the Infinispan Cache API is trivial.Â  The page simply needs to include a <code>&lt;script /&gt;</code> declaration for the infinispan-ws.js Javascript source file.Â  This script is served up by WebSocket Server.</p> </div> <div class="paragraph"> <p>So, for loading infinispan-ws.js from a WebSocket Server instance running on <em>www.acme.com:8181</em> (default port):</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;script</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text/javascript</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;a href=</span><span class="delimiter">&quot;</span></span><span class="attribute-name">http:</span><span class="error">/</span><span class="error">/</span><span class="attribute-name">www.acme.com:61999</span><span class="error">/</span><span class="attribute-name">infinispan-ws.js</span><span class="error">&quot;</span> <span class="attribute-name">target</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">_blank</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>http://www.acme.com:8181/infinispan-ws.js<span class="tag">&lt;/a&gt;</span>&quot; /<span class="error">&gt;</span></code></pre> </div> </div> <div class="sect4"> <h5 id="creating_a_client_side_cache_object_instance"><a class="anchor" href="#creating_a_client_side_cache_object_instance"></a>Creating a Client-Side Cache Object Instance</h5> <div class="paragraph"> <p>The client-side interface to a server-side Infinispan cache is the Cache Javascript object.Â  It can be constructed as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="javascript"><span class="tag">&lt;script</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text/javascript</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="inline"><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">var</span> cache = <span class="keyword">new</span> Cache();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// etc...</span></span>
<span class="tag">&lt;/script&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>By default, the Cache instance will interface to the default Infinispan Cache associated with the WebSocket Server from which the infinispan-ws.js Javascript source file was loaded.Â  So, in the above case, the Cache object instance will connect to the WebSocket Server running on <em>www.acme.com:8181</em> (i.e. <em>ws://www.acme.com:8181</em> ).</p> </div> <div class="paragraph"> <p>The Infinispan Cache name and WebSocket Server address can be specified in the <em>Cache</em> object constructor as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="javascript"><span class="keyword">var</span> cache = <span class="keyword">new</span> Cache(<span class="string"><span class="delimiter">&quot;</span><span class="content">omCache</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ws://ws.acmews.com:8181</span><span class="delimiter">&quot;</span></span>);
<span class="comment">// etc...</span></code></pre> </div> </div> </div> <div class="sect4"> <h5 id="cache_operations"><a class="anchor" href="#cache_operations"></a>Cache Operations</h5> <div class="paragraph"> <p>A number of cache operations can be performed via the Cache object instance such as <em>get</em> , <em>put</em> , <em>remove</em> , <em>notify</em> and <em>unnotify</em> .</p> </div> <div class="paragraph"> <p>The get and notify operations require a callback function to be registered with the Cache object instance.Â  This callback function receives all add/update/remove notifications on any cache entries for which the notify function was invoked.Â  It also asynchronously receives the result of a single invocation of the get function i.e. get can be thought of as "notify once, immediately".</p> </div> <div class="paragraph"> <p>The callback function is registered with the Cache object instance via the registerCallback function.Â  The function should have 2 parameters - key and value , relating to the cache key and value.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="javascript"><span class="keyword">var</span> cache = <span class="keyword">new</span> Cache();

<span class="comment">// Ask to be notified about some cache entries...</span>
cache.notify(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderStatus</span><span class="delimiter">&quot;</span></span>);
cache.notify(<span class="string"><span class="delimiter">&quot;</span><span class="content">expectedDeliveryTime</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// Register the callback function for receiving notifcations...</span>
cache.registerCallback(cacheCallback);

<span class="comment">// Cache callback function...</span>
<span class="keyword">function</span> <span class="function">cacheCallback</span>(key, value) {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// Handle notification...</span>
}</code></pre> </div> </div> <div class="paragraph"> <p>Getting and updating data in the cache is done by simply calling the get , put and remove functions on the Cache object instance.Â  These operations could be triggered by user interaction with a web form e.g.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;form</span> <span class="attribute-name">onsubmit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="keyword">return</span> <span class="predefined-constant">false</span>;<span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

Â Â Â  <span class="comment">&lt;!-- Other form components... --&gt;</span>

Â Â Â  <span class="comment">&lt;!-- Buttons for making cache updates... --&gt;</span>
Â Â Â  <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">button</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Put</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">onclick</span>=<span class="string"><span class="delimiter">&quot;</span>cache.put(<span class="local-variable">this</span>.form.key.value, <span class="local-variable">this</span>.form.val.value)<span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
Â Â Â  <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">button</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Get</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">onclick</span>=<span class="string"><span class="delimiter">&quot;</span>cache.get(<span class="local-variable">this</span>.form.key.value)<span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
Â Â Â  <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">button</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Remove</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">onclick</span>=<span class="string"><span class="delimiter">&quot;</span>cache.remove(<span class="local-variable">this</span>.form.key.value)<span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/form&gt;</span></code></pre> </div> </div> </div> </div> <div class="sect3"> <h4 id="sample_code"><a class="anchor" href="#sample_code"></a>14.8.2. Sample code</h4> <div class="paragraph"> <p>Infinispan&#8217;s source tree contains a sample HTML document that makes use of the WebSocket server.Â  Browse through the source of this HTML document <a href="https://github.com/infinispan/infinispan/blob/master/server/websocket/src/main/release/etc/sample-websocket-client.html">here</a> .</p> </div> </div> <div class="sect3"> <h4 id="screencast"><a class="anchor" href="#screencast"></a>14.8.3. Screencast</h4> <div class="paragraph"> <p>See the following <a href="http://www.screencast.com/t/ZGEzNDJlY">demo of the Infinispan WebSocket Server</a> in action.</p> </div> </div> <div class="sect3"> <h4 id="status"><a class="anchor" href="#status"></a>14.8.4. Status</h4> <div class="paragraph"> <p>Prototype/Alpha.</p> </div> </div> <div class="sect3"> <h4 id="source"><a class="anchor" href="#source"></a>14.8.5. Source</h4> <div class="paragraph"> <p><a href="https://github.com/infinispan/infinispan/tree/master/server/websocket">Browse Infinispan&#8217;s Git repository</a> .</p> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-68355061"><a class="anchor" href="#sid-68355061"></a>15. Querying Infinispan</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan supports indexing and searching of Java objects stored in the grid using powerful search APIs which complement its main Map-like API. Historically, searching was first available in Infinispan via <a href="http://lucene.apache.org/">Apache Lucene</a>'s API but since version 6.0 Infinispan provides its own <a href="#_infinispan_s_query_dsl">query API</a> based on a simple and expressive internal DSL. Searching with the new API is available for both embedded and remote clients while the Lucene based API is only available to embedded clients. The remote querying capability is further described in the <a href="#_querying_via_the_java_hot_rod_client">Hot Rod client chapter</a>.</p> </div> <div class="sect2"> <h3 id="the_infinispan_query_module"><a class="anchor" href="#the_infinispan_query_module"></a>15.1. The infinispan-query module</h3> <div class="paragraph"> <p>This module adds indexing and querying capabilities to Infinispan. It uses <a href="http://hibernate.org/subprojects/search">Hibernate Search</a> and <a href="http://lucene.apache.org/">Apache Lucene</a> to index and search objects in the cache. It allows users to obtain objects within the cache without needing to know the keys to each object that they want to obtain. You can search your objects based on some of its properties. For example to retrieve all red cars (exact metadata match), or all books about a specific topic (full text search and relevance scoring).</p> </div> <div class="paragraph"> <p>The queries can be expressed as Lucene queries, built directly using the Lucene Query API or built with the help of Hibernate Search Query DSL. Alternatively, you can also use Infinispan&#8217;s own query DSL which most users might find easier to use than the one based on Lucene at the cost of not being able to access some of the powerful capabilities which are specific to the underlying Lucene implementation.</p> </div> <div class="sect3"> <h4 id="configuration_11"><a class="anchor" href="#configuration_11"></a>15.1.1. Configuration</h4> <div class="paragraph"> <p>Indexing must be enabled in the configuration (as explained in <a href="#sid-68355029">XML Configuration</a> or <a href="#sid-68355029">Programmatic configuration</a> ). This will trigger automatic indexing of objects stored in the cache; there are several different ways to specify how these objects need to be indexed explained in the following paragraphs. To run queries you use the <em>SearchManager</em> which exposes all necessary methods to get started.</p> </div> </div> </div> <div class="sect2"> <h3 id="simple_example"><a class="anchor" href="#simple_example"></a>15.2. Simple example</h3> <div class="paragraph"> <p>We&#8217;re going to store <em>Book</em> instances in Infinispan; each <em>Book</em> will be defined as in the following example; we have to choose which properties are indexed, and for each property we can optionally choose advanced indexing options using the annotations defined in the Hibernate Search project.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// example values stored in the cache and indexed:</span>
<span class="keyword">import</span> <span class="include">org.hibernate.search.annotations</span>.*;

<span class="comment">//Values you want to index need to be annotated with @Indexed, then you pick which fields and how they are to be indexed:</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {
   <span class="annotation">@Field</span> <span class="predefined-type">String</span> title;
   <span class="annotation">@Field</span> <span class="predefined-type">String</span> description;
   <span class="annotation">@Field</span> <span class="annotation">@DateBridge</span>(resolution=Resolution.YEAR) <span class="predefined-type">Date</span> publicationYear;
   <span class="annotation">@IndexedEmbedded</span> <span class="predefined-type">Set</span>&lt;Author&gt; authors = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;Author&gt;();
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">Author</span> {
   <span class="annotation">@Field</span> <span class="predefined-type">String</span> name;
   <span class="annotation">@Field</span> <span class="predefined-type">String</span> surname;
   <span class="comment">// hashCode() and equals() omitted</span>
}</code></pre> </div> </div> <div class="paragraph"> <p>Now assuming we stored several <em>Book</em> instances in our Infinispan <em>Cache</em> , we can search them for any matching field as in the following example.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// get the search manager from the cache:</span>
SearchManager searchManager = org.infinispan.query.Search.getSearchManager(cache);

<span class="comment">// create any standard Lucene query, via Lucene's QueryParser or any other means:</span>
org.apache.lucene.search.Query fullTextQuery = <span class="comment">//any Apache Lucene Query</span>

<span class="comment">// convert the Lucene query to a CacheQuery:</span>
CacheQuery cacheQuery = searchManager.getQuery( fullTextQuery );

<span class="comment">// get the results:</span>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Object</span>&gt; found = cacheQuery.list();</code></pre> </div> </div> <div class="paragraph"> <p>A Lucene Query is often created by parsing a query in text format such as "title:infinispan AND authors.name:sanne", or by using the query builder provided by Hibernate Search.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// get the search manager from the cache:</span>
SearchManager searchManager = org.infinispan.query.Search.getSearchManager( cache );

<span class="comment">// you could make the queries via Lucene APIs, or use some helpers:</span>
QueryBuilder queryBuilder = searchManager.buildQueryBuilderForClass(<span class="predefined-type">Book</span>.class).get();

<span class="comment">// the queryBuilder has a nice fluent API which guides you through all options.</span>
<span class="comment">// this has some knowledge about your object, for example which Analyzers</span>
<span class="comment">// need to be applied, but the output is a fairly standard Lucene Query.</span>
org.apache.lucene.search.Query luceneQuery = queryBuilder.phrase()
                  .onField(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>)
                  .andField(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>)
                  .sentence(<span class="string"><span class="delimiter">&quot;</span><span class="content">a book on highly scalable query engines</span><span class="delimiter">&quot;</span></span>)
                  .createQuery();

<span class="comment">// the query API itself accepts any Lucene Query, and on top of that</span>
<span class="comment">// you can restrict the result to selected class types:</span>
CacheQuery query = searchManager.getQuery(luceneQuery, <span class="predefined-type">Book</span>.class);

<span class="comment">// and there are your results!</span>
<span class="predefined-type">List</span> objectList = query.list();

<span class="keyword">for</span> (<span class="predefined-type">Object</span> book : objectList) {
      <span class="predefined-type">System</span>.out.println(book);
}</code></pre> </div> </div> <div class="paragraph"> <p>A part from <em>list()</em> you have the option for streaming results, or use pagination.</p> </div> <div class="paragraph"> <p>This barely scratches the surface of all what is possible to do: see the <a href="http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single">Hibernate Search reference documentation</a> to learn about sorting, numeric fields, declarative filters, caching filters, complex object graph indexing, custom types and the powerful faceting search API.</p> </div> <div class="sect3"> <h4 id="notable_differences_with_hibernate_search"><a class="anchor" href="#notable_differences_with_hibernate_search"></a>15.2.1. Notable differences with Hibernate Search</h4> <div class="paragraph"> <p>Using <em>@DocumentId</em> to mark a field as identifier does not apply to Infinispan values; in Infinispan Query the identifier for all <em>@Indexed</em> objects is the key used to store the value. You can still customize how the key is indexed using a combination of <em>@Transformable</em> , <em>@ProvidedId</em> , custom types and custom <em>FieldBridge</em> implementations.</p> </div> </div> <div class="sect3"> <h4 id="requirements_for_the_key_transformable_and_providedid"><a class="anchor" href="#requirements_for_the_key_transformable_and_providedid"></a>15.2.2. Requirements for the Key: @Transformable and @ProvidedId</h4> <div class="paragraph"> <p>The key for each value needs to be indexed as well, and the key instance must be transformed in a <em>String</em>. Infinispan includes some default transformation routines to encode common primitives, but to use a custom key you must provide an implementation of <em>org.infinispan.query.Transformer</em> .</p> </div> <div class="sect4"> <h5 id="registering_a_transformer_via_annotations"><a class="anchor" href="#registering_a_transformer_via_annotations"></a>Registering a Transformer via annotations</h5> <div class="paragraph"> <p>You can annotate your key type with <em>org.infinispan.query.Transformable</em> :</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Transformable</span>(transformer = CustomTransformer.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomKey</span> {
   ...
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomTransformer</span> <span class="directive">implements</span> <span class="predefined-type">Transformer</span> {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">Object</span> fromString(<span class="predefined-type">String</span> s) {
      ...
      return <span class="keyword">new</span> CustomKey(...);
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">String</span> toString(<span class="predefined-type">Object</span> customType) {
      CustomKey ck = (CustomKey) customType;
      <span class="keyword">return</span> ...
   }
}</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="registering_a_transformer_programmatically"><a class="anchor" href="#registering_a_transformer_programmatically"></a>Registering a Transformer programmatically</h5> <div class="paragraph"> <p>Using this technique, you don&#8217;t have to annotated your custom key type:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">org.infinispan.query.SearchManager.registerKeyTransformer(<span class="predefined-type">Class</span>&lt;?&gt;, <span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> <span class="predefined-type">Transformer</span>&gt;)</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="providedid"><a class="anchor" href="#providedid"></a>@ProvidedId</h5> <div class="paragraph"> <p>The <em>org.hibernate.search.annotations.ProvidedId</em> annotation lets you apply advanced indexing options to the key field: the field name to be used, and/or specify a custom <em>FieldBridge</em> .</p> </div> </div> </div> </div> <div class="sect2"> <h3 id="configuration_12"><a class="anchor" href="#configuration_12"></a>15.3. Configuration</h3> <div class="sect3"> <h4 id="configuration_via_xml"><a class="anchor" href="#configuration_via_xml"></a>15.3.1. Configuration via XML</h4> <div class="paragraph"> <p>To enable indexing via XML, you need to add the <code>&lt;indexing /&gt;</code> element to your cache configuration, and optionally pass additional properties to the embedded Hibernate Search engine:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
   <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LOCAL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.directory_provider</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>ram<span class="tag">&lt;/property&gt;</span>
         <span class="tag">&lt;/indexing&gt;</span>
      <span class="tag">&lt;/local-cache&gt;</span>
   <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>In this example the index is stored in memory, so when this nodes is shutdown the index is lost: good for a quick demo, but in real world cases you&#8217;ll want to use the default (store on filesystem) or store the index in Infinispan as well. For the complete reference of properties to define, refer to the <a href="http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#search-configuration">Hibernate Search documentation</a> .</p> </div> </div> <div class="sect3"> <h4 id="automatic_configuration"><a class="anchor" href="#automatic_configuration"></a>15.3.2. Automatic configuration</h4> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml">      <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LOCAL</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">auto-config</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;/indexing&gt;</span>
      <span class="tag">&lt;/local-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Tha attribute auto-config provides a simple way of configuring indexing based on the cache type. For replicated and local caches, the indexing is configured to be persisted on disk and not shared with any other processes. Also, it is configured so that minimum delay exists between the moment an object is indexed and the moment it is available for searches (near real time).</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> it is possible to redefine any property added via auto-config, and also add new properties, allowing for advanced tuning. </td> </tr> </table> </div> <div class="paragraph"> <p>The auto config adds the following properties for replicated and local caches:</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 7%;"> <col style="width: 21%;"> <col style="width: 71%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Property name</th> <th class="tableblock halign-left valign-top">value</th> <th class="tableblock halign-left valign-top">description</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.search.default.directory_provider</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">filesystem</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Filesystem based index. More details at <a href="http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#search-configuration-directory">Hibernate Search documentation</a></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.search.default.exclusive_index_use</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">indexing operation in exclusive mode, allowing Hibernate Search to optimize writes</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.search.default.indexmanager</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">near-real-time</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">make use of Lucene near real time feature, meaning indexed objects are promptly available to searches</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.search.default.reader.strategy</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">shared</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Reuse index reader across several queries, thus avoiding reopening it</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>For distributed caches, the auto-config configure indexes in infinispan itself, internally handled as a master-slave mechanism where indexing operations are sent to a single node which is responsible to write to the index.</p> </div> <div class="paragraph"> <p>The auto config properties for distributed caches are:</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 7%;"> <col style="width: 21%;"> <col style="width: 71%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Property name</th> <th class="tableblock halign-left valign-top">value</th> <th class="tableblock halign-left valign-top">description</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.search.default.directory_provider</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">infinispan</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Indexes stored in Infinispan. More details at <a href="http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#infinispan-directories">Hibernate Search documentation</a></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.search.default.exclusive_index_use</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">indexing operation in exclusive mode, allowing Hibernate Search to optimize writes</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.search.default.indexmanager</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">org.infinispan.query.indexmanager.InfinispanIndexManager</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Delegates index writing to a single node in the Infinispan cluster</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.search.default.reader.strategy</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">shared</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Reuse index reader across several queries, avoiding reopening it</p></td> </tr> </tbody> </table> </div> <div class="sect3"> <h4 id="lucene_directory"><a class="anchor" href="#lucene_directory"></a>15.3.3. Lucene Directory</h4> <div class="paragraph"> <p>Infinispan Query isn&#8217;t aware of where you store the indexes, it just passes the configuration of which <em>Lucene Directory</em> implementation you want to use to the Hibernate Search engine. There are several <em>Lucene Directory</em> implementations bundled, and you can plug your own or add third party implementations: the Directory is the IO API for Lucene to store the indexes.</p> </div> <div class="paragraph"> <p>The most common <em>Lucene Directory</em> implementations used with <em>Infinispan Query</em> are:</p> </div> <div class="ulist"> <ul> <li> <p>Ram - stores the index in a local map to the node. This index can&#8217;t be shared.</p> </li> <li> <p>Filesystem - stores the index in a locally mounted filesystem. This could be a network shared FS, but sharing this way is generally not recommended.</p> </li> <li> <p>Infinispan - stores the index in a different dedicated Infinispan cache. This cache can be configured as replicated or distributed, to share the index among nodes. See also the dedicated chapter on the Lucene Directory in this guide.</p> </li> </ul> </div> <div class="paragraph"> <p>Of course having a shared index vs. an independent index on each node directly affects behaviour of the Query module; some combinations might not make much sense.</p> </div> </div> <div class="sect3"> <h4 id="using_programmatic_configuration_and_index_mapping"><a class="anchor" href="#using_programmatic_configuration_and_index_mapping"></a>15.3.4. Using programmatic configuration and index mapping</h4> <div class="paragraph"> <p>In the following example we start Infinispan programmatically, avoiding XML configuration files, and also map an object <em>Author</em> which is to be stored in the grid and made searchable on two properties but without annotating the class.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">SearchMapping mapping = <span class="keyword">new</span> SearchMapping();
mapping.entity(Author.class).indexed().providedId()
      .property(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">ElementType</span>.METHOD).field()
      .property(<span class="string"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">ElementType</span>.METHOD).field();

<span class="predefined-type">Properties</span> properties = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
properties.put(org.hibernate.search.Environment.MODEL_MAPPING, mapping);
properties.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.search.[other options]</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">[...]</span><span class="delimiter">&quot;</span></span>);

<span class="predefined-type">Configuration</span> infinispanConfiguration = <span class="keyword">new</span> ConfigurationBuilder()
      .indexing()
         .enable()
         .indexLocalOnly(<span class="predefined-constant">true</span>)
         .withProperties(properties)
      .build();

DefaultCacheManager cacheManager = <span class="keyword">new</span> DefaultCacheManager(infinispanConfiguration);

Cache&lt;<span class="predefined-type">Long</span>, Author&gt; cache = cacheManager.getCache();
SearchManager sm = Search.getSearchManager(cache);

Author author = <span class="keyword">new</span> Author(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Manik</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Surtani</span><span class="delimiter">&quot;</span></span>);
cache.put(author.getId(), author);

QueryBuilder qb = sm.buildQueryBuilderForClass(Author.class).get();
<span class="predefined-type">Query</span> q = qb.keyword().onField(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>).matching(<span class="string"><span class="delimiter">&quot;</span><span class="content">Manik</span><span class="delimiter">&quot;</span></span>).createQuery();
CacheQuery cq = sm.getQuery(q, Author.class);
Assert.assertEquals(cq.getResultSize(), <span class="integer">1</span>);</code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="cache_modes_and_managing_indexes"><a class="anchor" href="#cache_modes_and_managing_indexes"></a>15.4. Cache modes and managing indexes</h3> <div class="paragraph"> <p>Index management is currently controlled by the <em>Configuration.setIndexLocalOnly()</em> setter, or the <code>&lt;indexing index="LOCAL" /&gt;</code> XML element. If you set this to true, only modifications made locally on each node are considered in indexing. Otherwise, remote changes are considered too.</p> </div> <div class="paragraph"> <p>Regarding actually configuring a Lucene directory, refer to the <a href="http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#search-configuration">Hibernate Search documentation</a> on how to pass in the appropriate Lucene configuration via the Properties object passed to QueryHelper.</p> </div> <div class="sect3"> <h4 id="local"><a class="anchor" href="#local"></a>15.4.1. LOCAL</h4> <div class="paragraph"> <p>In local mode, you may use any Lucene Directory implementation. Also the option <em>indexLocalOnly</em> isn&#8217;t meaningful.</p> </div> </div> <div class="sect3"> <h4 id="replication"><a class="anchor" href="#replication"></a>15.4.2. REPLICATION</h4> <div class="paragraph"> <p>In replication mode, each node can have its own local copy of the index. So indexes can either be stored locally on each node (RAMDirectory, FSDirectory, etc) but you need to set <em>indexLocalOnly</em> to <em>false</em> , so that each node will apply needed updates it receives from other nodes in addition to the updates started locally. Any Directory implementation can be used, but you have to make sure that when a new node is started it receives an up to date copy of the index; typically rsync is well suited for this task, but being an external operation you might end up with a slightly out-of-sync index, especially if updates are very frequent.</p> </div> <div class="paragraph"> <p>Alternately, if you use some form of shared storage for indexes (see <em>Sharing the Index</em> ), you then have to set <em>indexLocalOnly</em> to <em>true</em> so that each node will apply only the changes originated locally; in this case there&#8217;s no risk in having an out-of-sync index, but to avoid write contention on the index you should make sure that a single node is "in charge" of updating the index. Again, the Hibernate Search reference documentation describes means to use <a href="http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#jms-backend">a JMS queue</a> or <a href="http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#jgroups-backend">JGroups</a> to send indexing tasks to a master node.</p> </div> <div class="paragraph"> <p>The diagram below shows a replicated deployment, in which each node has a local index.</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/QueryingInfinispan-REPLonly.png" alt="QueryingInfinispan REPLonly"> </div> </div> </div> <div class="sect3"> <h4 id="distribution"><a class="anchor" href="#distribution"></a>15.4.3. DISTRIBUTION</h4> <div class="paragraph"> <p>For these 2 cache modes, you <em>need</em> to use a shared index and set <em>indexLocalOnly</em> to true.</p> </div> <div class="paragraph"> <p>The diagram below shows a deployment with a shared index. Note that while not mandatory, a shared index can be used for replicated (vs. distributed) caches as well.</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/QueryingInfinispan-DISTINVALandREPL.png" alt="QueryingInfinispan DISTINVALandREPL"> </div> </div> </div> <div class="sect3"> <h4 id="invalidation"><a class="anchor" href="#invalidation"></a>15.4.4. INVALIDATION</h4> <div class="paragraph"> <p>Indexing or searching of elements under INVALIDATION mode is not supported.</p> </div> </div> </div> <div class="sect2"> <h3 id="sharing_the_index"><a class="anchor" href="#sharing_the_index"></a>15.5. Sharing the Index</h3> <div class="paragraph"> <p>The most simple way to share an index is to use some form of shared storage for the indexes, like an <em>FSDirectory</em> on a shared disk; however this form is problematic as the <em>FSDirectory</em> relies on specific locking semantics which are often incompletely implemented on network filesystems, or not reliable enough; if you go for this approach make sure to search for potential problems on the Lucene mailing lists for other experiences and workarounds. Good luck, test well.</p> </div> <div class="paragraph"> <p>There are many alternative Directory implementations you can find, one of the most suited approaches when working with Infinispan is of course to store the index in an Infinispan cache: have a look at the <a href="#sid-68355039">InfinispanDirectoryProvider</a> , as all Infinispan based layers it can be combined with persistent CacheLoaders to keep the index on a shared filesystem without the locking issues, or alternatively in a database, cloud storage, or any other CacheLoader implementation; you could backup the index in the same store used to backup your values.</p> </div> <div class="paragraph"> <p>For full documentation on clustering the Lucene engine, refer to the <a href="http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#search-configuration">Hibernate Search documentation</a> to properly configure it clustered.</p> </div> </div> <div class="sect2"> <h3 id="clustering_the_index_in_infinispan"><a class="anchor" href="#clustering_the_index_in_infinispan"></a>15.6. Clustering the Index in Infinispan</h3> <div class="paragraph"> <p>Again the configuration details are in the Hibernate Search reference, in particular in the <a href="http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#infinispan-directories">infinispan-directories</a> section. This backend will by default start a secondary Infinispan CacheManager, and optionally take another Infinispan configuration file: don&#8217;t reuse the same configuration or you will start grids recursively! It is currently not possible to share the same CacheManager.</p> </div> </div> <div class="sect2"> <h3 id="rebuilding_the_index"><a class="anchor" href="#rebuilding_the_index"></a>15.7. Rebuilding the Index</h3> <div class="paragraph"> <p>Occasionally you might need to rebuild the Lucene index by reconstructing it from the data stored in the Cache. You need to rebuild the index if you change the definition of what is indexed on your types, or if you change for example some <em>Analyzer</em> parameter, as Analyzers affect how the index is defined. Also, you might need to rebuild the index if you had it destroyed by some system administration mistake. To rebuild the index just get a reference to the MassIndexer and start it; beware if might take some time as it needs to reprocess all data in the grid!</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">SearchManager searchManager = Search.getSearchManager(cache);
searchManager.getMassIndexer().start();</code></pre> </div> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> This is also available as a <code>start</code> JMX operation on the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/jmxComponents.html#MassIndexer">MassIndexer MBean</a> registered under the name <code>org.infinispan:type=Query,manager="{name-of-cache-manager}",cache="{name-of-cache}",component=MassIndexer</code>. </td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="obtaining_query_statistics"><a class="anchor" href="#obtaining_query_statistics"></a>15.8. Obtaining query statistics</h3> <div class="paragraph"> <p>Query <a href="http://docs.jboss.org/hibernate/search/4.4/api/org/hibernate/search/stat/Statistics.html"><em>Statistics</em></a> can be obtained from the <em>SearchManager</em>, as demonstrated in the following code snippet.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">SearchManager searchManager = Search.getSearchManager(cache);
org.hibernate.search.stat.Statistics statistics = searchManager.getStatistics();</code></pre> </div> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> This data is also available via JMX through the <a href="http://docs.jboss.org/hibernate/search/4.4/reference/en-US/html/search-monitoring.html#d0e7624">Hibernate Search StatisticsInfoMBean</a> registered under the name <code>org.infinispan:type=Query,manager="{name-of-cache-manager}",cache="{name-of-cache}",component=Statistics</code>. Please note this MBean is always registered by Infinispan but the statistics are collected only if <a href="#_enabling_jmx_statistics">statistics collection is enabled</a> at cache level. </td> </tr> </table> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> Hibernate Search has its own configuration properties <code>hibernate.search.jmx_enabled</code> and <code>hibernate.search.generate_statistics</code> for JMX statistics as explained <a href="http://docs.jboss.org/hibernate/search/4.4/reference/en-US/html/search-monitoring.html#d0e7595">here</a>. Using them with Infinispan Query is forbidden as it will only lead to duplicated MBeans and unpredictable results. </td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="infinispan_s_query_dsl"><a class="anchor" href="#infinispan_s_query_dsl"></a>15.9. Infinispan&#8217;s Query DSL</h3> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> This is a new API undergoing refinements and changes that might break compatibility in future releases. </td> </tr> </table> </div> <div class="paragraph"> <p>Starting with 6.0 Infinispan provides its own query DSL, independent of Lucene and Hibernate Search. Decoupling the query API from the underlying query and indexing mechanism makes it possible to introduce new alternative engines in the future, besides Lucene, and still being able to use the same uniform query API. This opens up the possibility of introducing a future index-less searching engine based on Map/Reduce that will be accessible exclusively via the new query API. The current implementation of indexing and searching is still based on Hibernate Search and Lucene so all indexing related aspects presented in this chapter still apply.</p> </div> <div class="paragraph"> <p>The new API simplifies the writing of queries by not exposing the user to the low level details of constructing Lucene query objects and also has the advantage of being available to <a href="#_querying_via_the_java_hot_rod_client">remote Hot Rod clients</a>. But before delving into further details, let&#8217;s examine first a simple example of writing a query for the <em>Book</em> entity from <a href="#_simple_example">previous example</a>.</p> </div> <div class="listingblock"> <div class="title">Query example using Infinispan&#8217;s query DSL</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.query.dsl</span>.*;

<span class="comment">// get the DSL query factory from the cache, to be used for constructing the Query object:</span>
QueryFactory qf = org.infinispan.query.Search.getQueryFactory(cache);

<span class="comment">// create a query for all the books that have a title which contains the word &quot;engine&quot;:</span>
org.infinispan.query.dsl.Query query = qf.from(<span class="predefined-type">Book</span>.class)
      .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%engine%</span><span class="delimiter">&quot;</span></span>)
      .toBuilder().build();

<span class="comment">// get the results:</span>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; list = query.list();</code></pre> </div> </div> <div class="paragraph"> <p>The API is located in the <em>org.infinispan.query.dsl</em> package. A query is created with the help of the <em>QueryFactory</em> instance which is obtained from the per-cache <em>SearchManager</em>. Each <em>QueryFactory</em> instance is bound to the same <em>Cache</em> instance as the <em>SearchManager</em>, but it is otherwise a stateless and thread-safe object that can be used for creating multiple queries in parallel.</p> </div> <div class="paragraph"> <p>Query creation starts with the invocation of the <code>from(Class entityType)</code> method which returns a <em>QueryBuilder</em> object that is further responsible for creating queries targeted to the specified entity class from the given cache.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> A query will always target a single entity type and is evaluated over the contents of a single cache. Running a query over multiple caches or creating queries that target several entity types (joins) is not supported. </td> </tr> </table> </div> <div class="paragraph"> <p>The <em>QueryBuilder</em> accumulates search criteria and configuration specified through the invocation of its DSL methods and is ultimately used to build a <em>Query</em> object by the invocation of the <code>QueryBuilder.build()</code> method that completes the construction. Being a stateful object, it cannot be used for constructing multiple queries at the same time (except for <a href="#_nested_conditions">nested queries</a>) but can be reused afterwards.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> This <em>QueryBuilder</em> is different from the one from Hibernate Search but has a somewhat similar purpose, hence the same name. We are considering renaming it in near future to prevent ambiguity. </td> </tr> </table> </div> <div class="paragraph"> <p>Executing the query and fetching the results is as simple as invoking the <code>list()</code> method of the <em>Query</em> object. Once executed the <em>Query</em> object is not reusable. If you need to re-execute it in order to obtain fresh results then a new instance must be obtained by calling <code>QueryBuilder.build()</code>.</p> </div> </div> <div class="sect2"> <h3 id="filtering_operators"><a class="anchor" href="#filtering_operators"></a>15.10. Filtering operators</h3> <div class="paragraph"> <p>Constructing a query is a hierarchical process of composing multiple criteria and is best explained following this hierarchy.</p> </div> <div class="paragraph"> <p>The simplest possible form of a query criteria is a restriction on the values of an entity attribute according to a filtering operator that accepts zero or more arguments. The entity attribute is specified by invoking the <code>having(String attributePath)</code> method of the query builder which returns an intermediate context object (<a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/query/dsl/FilterConditionEndContext.html"><em>FilterConditionEndContext</em></a>) that exposes all the available operators. Each of the methods defined by <em>FilterConditionEndContext</em> is an operator that accepts an argument, except for <code>between</code> which has two arguments and <code>isNull</code> which has no arguments. The arguments are statically evaluated at the time the query is constructed, so if you&#8217;re looking for a feature similar to SQL&#8217;s correlated sub-queries, that is not currently available.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// a single query criterion</span>
QueryBuilder qb = ...
qb.having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">Infinispan Data Grid Platform</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <table class="tableblock frame-all grid-all spread"> <caption class="title">Table 10. <em>FilterConditionEndContext</em> exposes the following filtering operators:</caption> <colgroup> <col style="width: 7%;"> <col style="width: 21%;"> <col style="width: 71%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Filter</th> <th class="tableblock halign-left valign-top">Arguments</th> <th class="tableblock halign-left valign-top">Description</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">in</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">CollectionÂ values</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left operand is equal to one of the elements from the Collection of values given as argument.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">in</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Object&#8230;&#8203;Â values</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left operand is equal to one of the (fixed) list of values given as argument.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">contains</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ObjectÂ value</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument (which is expected to be an array or a Collection) contains the given element.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">containsAll</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">CollectionÂ values</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument (which is expected to be an array or a Collection) contains all the elements of the given collection, in any order.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">containsAll</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Object&#8230;&#8203;Â values</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument (which is expected to be an array or a Collection) contains all of the the given elements, in any order.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">containsAny</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">CollectionÂ values</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument (which is expected to be an array or a Collection) contains any of the elements of the given collection.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">containsAny</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Object&#8230;&#8203;Â values</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument (which is expected to be an array or a Collection) contains any of the the given elements.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">isNull</p></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is null.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">like</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">StringÂ pattern</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument (which is expected to be a String) matches a wildcard pattern that follows the JPA rules.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">eq</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ObjectÂ value</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is equal to the given value.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">equal</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ObjectÂ value</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Alias for eq.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">gt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ObjectÂ value</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is greater than the given value.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">gte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ObjectÂ value</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is greater than or equal to the given value.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">lt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ObjectÂ value</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is less than the given value.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">lte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ObjectÂ value</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is less than or equal to the given value.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">between</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ObjectÂ from, ObjectÂ to</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is between the given range limits.</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>It&#8217;s important to note that query construction requires a multi-step chaining of method invocation that must be done in the proper sequence, must be properly completed exactly <em>once</em> and must not be done twice, or it will result in an error. The following examples are invalid, and depending on each case they lead to criteria being ignored (in benign cases) or an exception being thrown (in more serious ones).</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Incomplete construction. This query does not have any filter on &quot;title&quot; attribute yet,</span>
<span class="comment">// although the author may have intended to add one.</span>
QueryBuilder qb1 = ...
qb1.having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">Query</span> q1 = qb1.build(); <span class="comment">// consequently, this query matches all Book instances regardless of title!</span>

<span class="comment">// Duplicated completion. This results in an exception at run-time.</span>
<span class="comment">// Maybe the author intended to connect two conditions with a boolean operator,</span>
<span class="comment">// but this does NOT actually happen here.</span>
QueryBuilder qb2 = ...
qb2.having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Infinispan%</span><span class="delimiter">&quot;</span></span>);
qb2.having(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%clustering%</span><span class="delimiter">&quot;</span></span>);   <span class="comment">// will throw java.lang.IllegalStateException: Sentence already started. Cannot use 'having(..)' again.</span>
<span class="predefined-type">Query</span> q2 = qb2.build();</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> All fields participating in the query need to be indexed by Hibernate Search for querying to work in embedded mode. We plan to add index-less searching with Map/Reduce in future versions (see <a href="https://issues.jboss.org/browse/ISPN-3717">ISPN-3717</a>). </td> </tr> </table> </div> <div class="sect3"> <h4 id="filtering_based_on_attributes_of_embedded_entities"><a class="anchor" href="#filtering_based_on_attributes_of_embedded_entities"></a>15.10.1. Filtering based on attributes of embedded entities</h4> <div class="paragraph"> <p>The <code>having</code> method also accepts dot separated attribute paths for referring to <em>embedded entity</em> attributes, so the following is a valid query:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// match all books that have an author named &quot;Manik&quot;</span>
<span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
      .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">author.name</span><span class="delimiter">&quot;</span></span>).eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">Manik</span><span class="delimiter">&quot;</span></span>)
      .toBuilder().build();</code></pre> </div> </div> <div class="paragraph"> <p>Each part of the attribute path must refer to an existing indexed attribute in the corresponding entity or embedded entity class respectively. It&#8217;s possible to have multiple levels of embedding.</p> </div> </div> </div> <div class="sect2"> <h3 id="boolean_conditions"><a class="anchor" href="#boolean_conditions"></a>15.11. Boolean conditions</h3> <div class="paragraph"> <p>Combining multiple attribute conditions with logical conjunction (<code>and</code>) and disjunction (<code>or</code>) operators in order to create more complex conditions is demonstrated in the following example. The well known operator precedence rule for boolean operators applies here, so the order of DSL method invocations during construction is irrelevant. Here <code>and</code> operator still has higher priority than <code>or</code> even though <code>or</code> was invoked first.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// match all books that have the word &quot;Infinispan&quot; in their title</span>
<span class="comment">// or have an author named &quot;Manik&quot; and their description contains the word &quot;clustering&quot;</span>
<span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
  .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Infinispan%</span><span class="delimiter">&quot;</span></span>)
  .or().having(<span class="string"><span class="delimiter">&quot;</span><span class="content">author.name</span><span class="delimiter">&quot;</span></span>).eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">Manik</span><span class="delimiter">&quot;</span></span>)
  .and().having(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%clustering%</span><span class="delimiter">&quot;</span></span>)
  .toBuilder().build();</code></pre> </div> </div> <div class="paragraph"> <p>Boolean negation is achieved with the <code>not</code> operator, which has highest precedence among logical operators and applies only to the next simple attribute condition.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// match all books that do not have the word &quot;Infinispan&quot; in their title and are authored by &quot;Manik&quot;</span>
<span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
  .not().having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Infinispan%</span><span class="delimiter">&quot;</span></span>)
  .and().having(<span class="string"><span class="delimiter">&quot;</span><span class="content">author.name</span><span class="delimiter">&quot;</span></span>).eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">Manik</span><span class="delimiter">&quot;</span></span>)
  .toBuilder().build();</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="nested_conditions"><a class="anchor" href="#nested_conditions"></a>15.12. Nested conditions</h3> <div class="paragraph"> <p>Changing the precendece of logical operators is achieved with nested filter conditions. Logical operators can be used to connect two simple attribute conditions as presented before, but can also connect a simple attribute condition with the subsequent complex condition created with the same query factory.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// match all books that have an author named &quot;Manik&quot; and their title contains</span>
<span class="comment">// the word &quot;Infinispan&quot; or their description contains the word &quot;clustering&quot;</span>
<span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
  .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">author.name</span><span class="delimiter">&quot;</span></span>).eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">Manik</span><span class="delimiter">&quot;</span></span>);
  .and(queryFactory.having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Infinispan%</span><span class="delimiter">&quot;</span></span>)
          .or().having(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%clustering%</span><span class="delimiter">&quot;</span></span>))
  .toBuilder().build();</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="projections"><a class="anchor" href="#projections"></a>15.13. Projections</h3> <div class="paragraph"> <p>In some use cases returning the whole domain object is overkill if only a small subset of the attributes are actually used by the application, especially if the domain entity has embedded entities. The query language allows you to specify a subset of attributes (or attribute paths) to return - the projection. If projections are used then the <code>Query.list()</code> will not return the whole domain entity but will return a <em>List</em> of <em>Object[]</em>, each slot in the array corresponding to a projected attribute.</p> </div> <div class="paragraph"> <p>TODO document what needs to be configured for an attribute to be available for projection.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// match all books that have the word &quot;Infinispan&quot; in their title or description</span>
<span class="comment">// and return only their title and publication year</span>
<span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
  .select(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>)
  .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Infinispan%</span><span class="delimiter">&quot;</span></span>)
  .or().having(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Infinispan%</span><span class="delimiter">&quot;</span></span>))
  .toBuilder().build();</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="sorting"><a class="anchor" href="#sorting"></a>15.14. Sorting</h3> <div class="paragraph"> <p>Ordering the results based on one or more attributes or attribute paths is done with the <code>QueryBuilder.orderBy( )</code> method which accepts an attribute path and a sorting direction. If multiple sorting criteria are specified, then the order of invocation of <code>orderBy</code> method will dictate their precedence. But you have to think of the multiple sorting criteria as acting together on the tuple of specified attributes rather than in a sequence of individual sorting operations on each attribute.</p> </div> <div class="paragraph"> <p>TODO document what needs to be configured for an attribute to be available for sorting.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// match all books that have the word &quot;Infinispan&quot; in their title or description</span>
<span class="comment">// and return them sorted by the publication year and title</span>
<span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
  .orderBy(<span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>, SortOrder.DESC)
  .orderBy(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, SortOrder.ASC)
  .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Infinispan%</span><span class="delimiter">&quot;</span></span>)
  .or().having(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Infinispan%</span><span class="delimiter">&quot;</span></span>))
  .toBuilder().build();</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="pagination"><a class="anchor" href="#pagination"></a>15.15. Pagination</h3> <div class="paragraph"> <p>You can limit the number of returned results by setting the <em>maxResults</em> property of <em>QueryBuilder</em>. This can be used in conjunction with setting the <em>startOffset</em> in order to achieve pagination of the result set.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// match all books that have the word &quot;clustering&quot; in their title</span>
<span class="comment">// sorted by publication year and title</span>
<span class="comment">// and return 3'rd page of 10 results</span>
<span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
  .orderBy(<span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>, SortOrder.DESC)
  .orderBy(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, SortOrder.ASC)
  .setStartOffset(<span class="integer">20</span>)
  .maxResults(<span class="integer">10</span>)
  .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%clustering%</span><span class="delimiter">&quot;</span></span>)
  .toBuilder().build();</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Even if the results being fetched are limited to <em>maxResults</em> you can still find the total number of matching results by calling <code>Query.getResultSize()</code>. </td> </tr> </table> </div> <div class="paragraph"> <p>TODO Does pagination make sense if no stable sort criteria is defined? Luckily when running on Lucene and no sort criteria is specified we still have the order of relevance, but this has to be defined for other search engines.</p> </div> </div> <div class="sect2"> <h3 id="grouping_and_aggregation"><a class="anchor" href="#grouping_and_aggregation"></a>15.16. Grouping and Aggregation</h3> <div class="paragraph"> <p>Infinispan has the ability to group query results according to a set of grouping fields and construct aggregations of the results from each group by applying an aggregation function to the set of values that fall into each group. Grouping and aggregation can only be applied to projection queries. The supported aggregations are: avg, sum, count, max, min. The set of grouping fields is specified with the <em>groupBy(field)</em> method, which can be invoked multiple times. The order used for defining grouping fields is not relevant. All fields selected in the projection must either be grouping fields or else they must be aggregated using one of the grouping functions described below. A projection field can be aggregated and used for grouping at the same time. A query that selects only grouping fields but no aggregation fields is legal. â </p> </div> <div class="paragraph"> <p>Example: Grouping Books by author and counting them.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
    .select(<span class="predefined-type">Expression</span>.property(<span class="string"><span class="delimiter">&quot;</span><span class="content">author</span><span class="delimiter">&quot;</span></span>), <span class="predefined-type">Expression</span>.count(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>))
    .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%engine%</span><span class="delimiter">&quot;</span></span>)
    .toBuilder()
    .groupBy(<span class="string"><span class="delimiter">&quot;</span><span class="content">author</span><span class="delimiter">&quot;</span></span>)
    .build();</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> A projection query in which all selected fields have an aggregation function applied and no fields are used for grouping is allowed. In this case the aggregations will be computed globally as if there was a single global group. </td> </tr> </table> </div> <div class="sect4"> <h5 id="aggregations"><a class="anchor" href="#aggregations"></a>Aggregations</h5> <div class="paragraph"> <p>The following aggregation functions may be applied to a field: avg, sum, count, max, min</p> </div> <div class="ulist"> <ul> <li> <p>avg() - Computes the average of a set of numbers. Accepted values are primitive numbers and instances of <em>java.lang.Number</em>. The result is represented as <em>java.lang.Double</em>. If there are no non-null values the result is <em>null</em> instead.</p> </li> <li> <p>count() - Counts the number of non-null rows and returns a <em>java.lang.Long</em>. If there are no non-null values the result is <em>0</em> instead.</p> </li> <li> <p>max() - Returns the greatest value found. Accepted values must be instances of <em>java.lang.Comparable</em>. If there are no non-null values the result is <em>null</em> instead.</p> </li> <li> <p>min() - Returns the smallest value found. Accepted values must be instances of <em>java.lang.Comparable</em>. If there are no non-null values the result is <em>null</em> instead.</p> </li> <li> <p>sum() - Computes the sum of a set of Numbers. If there are no non-null values the result is <em>null</em> instead. The following table indicates the return type based on the specified field.</p> </li> </ul> </div> <table class="tableblock frame-all grid-all spread"> <caption class="title">Table 11. Table sum return type</caption> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Type</th> <th class="tableblock halign-left valign-top">Return Type</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Integral (other than BigInteger)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Long</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Float or Double</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Double</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">BigInteger</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">BigInteger</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">BigDecimal</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">BigDecimal</p></td> </tr> </tbody> </table> </div> <div class="sect3"> <h4 id="evaluation_of_queries_with_grouping_and_aggregation"><a class="anchor" href="#evaluation_of_queries_with_grouping_and_aggregation"></a>15.16.2. Evaluation of queries with grouping and aggregation</h4> <div class="paragraph"> <p>Aggregation queries can include filtering conditions, like usual queries. Filtering can be performed in two stages: before and after the grouping operation. All filter conditions defined before invoking the <em>groupBy</em> method will be applied before the grouping operation is performed, directly to the cache entries (not to the final projection). These filter conditions may reference any fields of the queried entity type, and are meant to restrict the data set that is going to be the input for the grouping stage. All filter conditions defined after invoking the <em>groupBy</em> method will be applied to the projection that results from the projection and grouping operation. These filter conditions can either reference any of the <em>groupBy</em> fields or aggregated fields. Referencing aggregated fields that are not specified in the select clause is allowed; however, referencing non-aggregated and non-grouping fields is forbidden. Filtering in this phase will reduce the amount of groups based on their properties. Sorting may also be specified similar to usual queries. The ordering operation is performed after the grouping operation and can reference any of the <em>groupBy</em> fields or aggregated fields.</p> </div> </div> </div> <div class="sect2"> <h3 id="usage_samples"><a class="anchor" href="#usage_samples"></a>15.17. Usage samples</h3> <div class="paragraph"> <p>Probably the best way to explore using the Query DSL API is to have a look at our tests suite. <a href="https://github.com/infinispan/infinispan/blob/master/query/src/test/java/org/infinispan/query/dsl/embedded/QueryDslConditionsTest.java">QueryDslConditionsTest</a> is a fine example. == Infinispan as a storage for Lucene indexes Infinispan includes a highly scalable distributed <a href="http://lucene.apache.org">Apache Lucene Directory</a> implementation.</p> </div> <div class="paragraph"> <p>This directory closely mimics the same semantics of the traditional filesystem and RAM-based directories, being able to work as a drop-in replacement for existing applications using Lucene and providing reliable index sharing and other features of Infinispan like node auto-discovery, automatic failover and rebalancing, optionally transactions, and can be backed by traditional storage solutions as filesystem, databases or cloud store engines.</p> </div> <div class="paragraph"> <p>The implementation extends Lucene&#8217;s <em>org.apache.lucene.store.Directory</em> so it can be used to <em>store</em> the index in a cluster-wide shared memory, making it easy to distribute the index. Compared to rsync-based replication this solution is suited for use cases in which your application makes frequent changes to the index and you need them to be quickly distributed to all nodes. Consistency levels, synchronicity and guarantees, total elasticity and auto-discovery are all configurable; also changes applied to the index can optionally participate in a JTA transaction, optionally supporting XA transactions with recovery.</p> </div> <div class="paragraph"> <p>Two different <em>LockFactory</em> implementations are provided to guarantee only one <em>IndexWriter</em> at a time will make changes to the index, again implementing the same semantics as when opening an index on a local filesystem. As with other Lucene Directories, you can override the <em>LockFactory</em> if you prefer to use an alternative implementation.</p> </div> </div> <div class="sect2"> <h3 id="additional_links"><a class="anchor" href="#additional_links"></a>15.18. Additional Links</h3> <div class="paragraph"> <p>Javadoc: <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/lucene/impl/DirectoryLuceneV4.html" class="bare">http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/lucene/impl/DirectoryLuceneV4.html</a> Issue tracker: <a href="https://jira.jboss.org/browse/ISPN/component/12312732" class="bare">https://jira.jboss.org/browse/ISPN/component/12312732</a> Source code: <a href="https://github.com/infinispan/infinispan" class="bare">https://github.com/infinispan/infinispan</a></p> </div> </div> <div class="sect2"> <h3 id="lucene_compatibility"><a class="anchor" href="#lucene_compatibility"></a>15.19. Lucene compatibility</h3> <div class="paragraph"> <p>Since Infinispan version 7 this Directory implementation is compatible exclusively with Apache Lucene versions 4.8.1, 4.9.0, 4.10.0, 4.10.1, 4.10.2: previous versions are compatible with a range of older Lucene versions, but backwards compatibility could no longer be maintained. If you need compatibility for an older version, either use an older version of Infinispan or you can get in touch with the developers if you are willing to help to create the backwards compatible versions.</p> </div> </div> <div class="sect2"> <h3 id="how_to_use_it"><a class="anchor" href="#how_to_use_it"></a>15.20. How to use it</h3> <div class="paragraph"> <p>To create a Directory instance:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.apache.lucene.store.Directory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.lucene.directory.DirectoryBuilder</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.Cache</span>;

Cache cache = <span class="comment">// create an Infinispan cache, configured as you like</span>
Directory indexDir = DirectoryBuilder.newDirectoryInstance(cache, cache, cache, indexName)
                                     .create();</code></pre> </div> </div> <div class="paragraph"> <p>The <em>indexName</em> is a unique key to identify your index. It takes the same role as the path did on filesystem based indexes: you can create several different indexes giving them different names. When you use the same <em>indexName</em> in another instance connected to the same network (or instantiated on the same machine, useful for testing) they will join, form a cluster and share all content. Using a different <em>indexName</em> allows you to store different indexes in the same set of Caches.</p> </div> <div class="paragraph"> <p>The <em>cache</em> is passed three times in this example, as that is ok for a quick demo, but as the API suggests it&#8217;s a good idea to tune each cache separately as they will be used in different ways. More details provided below.</p> </div> <div class="paragraph"> <p>New nodes can be added or removed dynamically, making the service administration very easy and also suited for cloud environments: it&#8217;s simple to react to load spikes, as adding more memory and CPU power to the search system is done by just starting more nodes.</p> </div> </div> <div class="sect2"> <h3 id="limitations"><a class="anchor" href="#limitations"></a>15.21. Limitations</h3> <div class="paragraph"> <p>As when using an <em>IndexWriter</em> on a filesystem based <em>Directory</em> , even on the clustered edition only one <em>IndexWriter</em> can be opened across the whole cluster.</p> </div> <div class="paragraph"> <p>As an example, <a href="http://search.hibernate.org">Hibernate Search</a> , which includes integration with this Lucene Directory since version 3.3, sends index change requests across a JMS queue, or a <em>JGroups</em> channel. Other valid approaches are to proxy the remote <em>IndexWriter</em> or just design your application in such a way that only one node attempts to write it.</p> </div> <div class="paragraph"> <p>Reading (searching) is of course possible in parallel, from any number of threads on each node; changes applied to the single IndexWriter are affecting results of all threads on all nodes in a very short time, or guaranteed to be visible after a commit when using transactions.</p> </div> </div> <div class="sect2"> <h3 id="configuration_13"><a class="anchor" href="#configuration_13"></a>15.22. Configuration</h3> <div class="paragraph"> <p>Infinispan can be configured as LOCAL clustering mode, in which case it will disable clustering features and serve as a cache for the index, or any clustering mode. A transaction manager is not mandatory, but when enabled the changes to the index can participate in transactions.</p> </div> <div class="paragraph"> <p>Batching was required in previous versions, it&#8217;s not strictly needed anymore.</p> </div> <div class="paragraph"> <p>As better explained in the javadocs of <em>org.infinispan.lucene.InfinispanDirectory</em> , it&#8217;s possible for it to use more than a single cache, using specific configurations for different purposes. When using readlocks, make sure to not enable transactions on this cache.</p> </div> <div class="paragraph"> <p>Any Infinispan configuration should work fine as long as caches are not configured to remove entries after thresholds.</p> </div> </div> <div class="sect2"> <h3 id="demo"><a class="anchor" href="#demo"></a>15.23. Demo</h3> <div class="paragraph"> <p>There is a simple command-line demo of its capabilities distributed with Infinispan under demos/lucene-directory; make sure you grab the <em>"Binaries, server and demos"</em> package from <a href="http://www.jboss.org/infinispan/downloads">download page</a> , which contains all demos.</p> </div> <div class="paragraph"> <p>Start several instances, then try adding text in one instance and searching for it on the other. The configuration is not tuned at all, but should work out-of-the box without any changes. If your network interface has multicast enabled, it will cluster across the local network with other instances of the demo.</p> </div> </div> <div class="sect2"> <h3 id="maven_dependencies"><a class="anchor" href="#maven_dependencies"></a>15.24. Maven dependencies</h3> <div class="paragraph"> <p>All you need is <em>org.infinispan:infinispan-lucene-directory</em> :</p> </div> <div class="listingblock"> <div class="title">pom.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
Â Â  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
Â Â  <span class="tag">&lt;artifactId&gt;</span>infinispan-lucene-directory<span class="tag">&lt;/artifactId&gt;</span>
Â Â  <span class="tag">&lt;version&gt;</span>${infinispan.version}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre> </div> </div> </div> <div class="sect2"> <h3 id="using_a_cacheloader"><a class="anchor" href="#using_a_cacheloader"></a>15.25. Using a CacheLoader</h3> <div class="paragraph"> <p>Using a CacheLoader you can have the index content backed up to a permanent storage; you can use a shared store for all nodes or one per node, see <a href="#cache-passivation">cache passivation</a> for more details.</p> </div> <div class="paragraph"> <p>When using a CacheLoader to store a Lucene index, to get best write performance you would need to configure the CacheLoader with <em>async=true</em> .</p> </div> <div class="sect3"> <h4 id="storing_the_index_in_a_database"><a class="anchor" href="#storing_the_index_in_a_database"></a>15.25.1. Storing the index in a database</h4> <div class="paragraph"> <p>It might be useful to store the Lucene index in a relational database; this would be very slow but Infinispan can act as a cache between the application and the JDBC interface, making this configuration useful in both clustered and non-clustered configurations. When storing indexes in a JDBC database, it&#8217;s suggested to use the <em>JdbcStringBasedCacheStore</em> , which will need this attribute:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">key2StringMapperClass</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.lucene.LuceneKey2StringMapper</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> </div> <div class="sect3"> <h4 id="loading_an_existing_lucene_index"><a class="anchor" href="#loading_an_existing_lucene_index"></a>15.25.2. Loading an existing Lucene Index</h4> <div class="paragraph"> <p>The <em>org.infinispan.lucene.cachestore.LuceneCacheLoader</em> is an Infinispan CacheLoader able to have Infinispan directly load data from an existing Lucene index into the grid. Currently this supports reading only.</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 33%;"> <col style="width: 33%;"> <col style="width: 33%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Property</th> <th class="tableblock halign-left valign-top">Description</th> <th class="tableblock halign-left valign-top">Default</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><em>location</em></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The path where the indexes are stored. Subdirectories (of first level only) should contain the indexes to be loaded, each directory matching the index name attribute of the InfinispanDirectory constructor.</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">none (mandatory)</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><em>autoChunkSize</em></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">A threshold in bytes: if any segment is larger than this, it will be transparently chunked in smaller cache entries up to this size.</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">32MB</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>It&#8217;s worth noting that the IO operations are delegated to Lucene&#8217;s standard <em>org.apache.lucene.store.FSDirectory</em> , which will select an optimal approach for the running platform.</p> </div> <div class="paragraph"> <p>Implementing write-through should not be hard: you&#8217;re welcome to try implementing it.</p> </div> </div> </div> <div class="sect2"> <h3 id="architectural_limitations"><a class="anchor" href="#architectural_limitations"></a>15.26. Architectural limitations</h3> <div class="paragraph"> <p>This Directory implementation makes it possible to have almost real-time reads across multiple nodes. A fundamental limitation of the Lucene design is that only a single IndexWriter is allowed to make changes on the index: a pessimistic lock is acquired by the writer; this is generally ok as a single IndexWriter <em>instance</em> is very fast and accepts update requests from multiple threads. When sharing the Directory across Infinispan nodes the IndexWriter limitation is not lifted: since you can have only one instance, that reflects in your application as having to apply all changes on the same node. There are several strategies to write from multiple nodes on the same index:</p> </div> <div class="ulist"> <div class="title">Index write strategies</div> <ul> <li> <p>One node writes, the other delegate to it sending messages</p> </li> <li> <p>Each node writes on turns</p> </li> <li> <p>You application makes sure it will only ever apply index writes on one node</p> </li> </ul> </div> <div class="paragraph"> <p>The <em>Infinispan Lucene Directory</em> protects its content by implementing a distributed locking strategy, though this is designed as a last line of defense and is not to be considered an efficient mechanism to coordinate multiple writes: if you don&#8217;t apply one of the above suggestions and get high write contention from multiple nodes you will likely get timeout exception.</p> </div> </div> <div class="sect2"> <h3 id="suggestions_for_optimal_performance"><a class="anchor" href="#suggestions_for_optimal_performance"></a>15.27. Suggestions for optimal performance</h3> <div class="sect3"> <h4 id="jgroups_and_networking_stack"><a class="anchor" href="#jgroups_and_networking_stack"></a>15.27.1. JGroups and networking stack</h4> <div class="paragraph"> <p>JGroups manages all network IO and as such it is a critical component to tune for your specific environment. Make sure to read the <a href="http://jgroups.org/manual-3.x/html/index.html">JGroups reference documentation</a> , and play with the performance tests included in JGroups to make sure your network stack is setup appropriately. Don&#8217;t forget to check also operating system level parameters, for example buffer sizes dedicated for networking. JGroups will log warning when it detects something wrong, but there is much more you can look into.</p> </div> </div> <div class="sect3"> <h4 id="using_a_cachestore"><a class="anchor" href="#using_a_cachestore"></a>15.27.2. Using a CacheStore</h4> <div class="paragraph"> <p>Currently all CacheStore implementations provided by Infinispan have a significant slowdown; we hope to resolve that soon but for the time being if you need high performance on writes with the Lucene Directory the best option is to disable any CacheStore; the second best option is to configure the CacheStore as <em>async</em> . If you only need to load a Lucene index from read-only storage, see the above description for <em>org.infinispan.lucene.cachestore.LuceneCacheLoader</em> .</p> </div> </div> <div class="sect3"> <h4 id="apply_standard_lucene_tuning"><a class="anchor" href="#apply_standard_lucene_tuning"></a>15.27.3. Apply standard Lucene tuning</h4> <div class="paragraph"> <p>All known options of Lucene apply to the Infinispan Lucene Directory as well; of course the effect might be less significant in some cases, but you should definitely read the <a href="http://lucene.apache.org/core/index.html">Apache Lucene documentation</a> .</p> </div> </div> <div class="sect3"> <h4 id="disable_batching_and_transactions"><a class="anchor" href="#disable_batching_and_transactions"></a>15.27.4. Disable batching and transactions</h4> <div class="paragraph"> <p>Early versions required Infinispan to have batching or transactions enabled. This is no longer a requirement, and in fact disabling them should provide little improvement in performance.</p> </div> </div> <div class="sect3"> <h4 id="set_the_right_chunk_size"><a class="anchor" href="#set_the_right_chunk_size"></a>15.27.5. Set the right chunk size</h4> <div class="paragraph"> <p>The chunk size is an optional parameter to be passed to the Directory builder. While it&#8217;s optional, its default is suited only for testing and small demos, while setting a larger size can have a dramatic effect on performance especially when running on multiple nodes. To correctly set this variable you need to estimate what the expected size of your segments is; generally this is trivial by looking at the file size of the index segments generated by your application when it&#8217;s using the standard FSDirectory. You then have to consider:</p> </div> <div class="ulist"> <ul> <li> <p>The chunk size affects the size of internally created buffers, so you don&#8217;t want an outrageously large array as you&#8217;re going to waste precious JVM memory. Also consider that during index writing such arrays are frequently allocated.</p> </li> <li> <p>If a segment doesn&#8217;t fit in the chunk size, it&#8217;s going to be fragmented. When searching on a fragmented segment performance can&#8217;t peak.</p> </li> </ul> </div> <div class="paragraph"> <p>Using the <em>org.apache.lucene.index.IndexWriterConfig</em> you can tune your index writing to <em>approximately</em> keep your segment size to a reasonable level, from there then tune the chunksize, after having defined the chunksize you might want to revisit your network configuration settings.</p> </div> </div> <div class="sect3"> <h4 id="use_dedicated_cache_instances"><a class="anchor" href="#use_dedicated_cache_instances"></a>15.27.6. Use dedicated Cache instances</h4> <div class="paragraph"> <p>When constructing the Directory instance you have the option to specify different caches. The <em>metadataCache</em> is going to be accessed frequently by all nodes and its content is very small, so it&#8217;s best to use <em>REPL_SYNC</em> . The <em>chunksCache</em> contains the raw byte arrays of your index segments otherwise stored on filesystem, so - assuming your system is read-mostly - you might also want to use replication on this cache, but you have to consider if you have enough memory to store all the data replicated on all nodes; if not, you might be better off using <em>DIST_SYNC</em> , optionally enabling L1. The <em>distLocksCache</em> cache is similar to the <em>chunksCache</em> , just that it doesn&#8217;t need a CacheStore even if you want to persist the index.</p> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="map_reduce"><a class="anchor" href="#map_reduce"></a>16. Map/Reduce</h2> <div class="sectionbody"> <div class="paragraph"> <p>MapReduce is a programming model allowing transparent distributed processing of very large data sets over data grids. The name MapReduce comes from an idea of using two distinct computational phases of map and reduce. In the map phase, master node that initiates a task takes the task input, divides it and sends tasks for map phase execution on the grid. Each node in turns executes a map function on its input returning intermediate results back to master node. Master node task collects all intermediate results from map phase combines them by intermediate result keys and sends intermediate keys/values for reduction on the grid. Finally master tasks node receives all results from reduction phases and returns the final result to invoker of the MapReduce task.</p> </div> <div class="admonitionblock caution"> <table> <tr> <td class="icon"> <i class="fa icon-caution" title="Caution"></i> </td> <td class="content"> The Map/Reduce framework has been deprecated and will be removed with Infinispan 9. Please check out the <a href="user_guide.html#_streams">Streams</a> section for its replacement. </td> </tr> </table> </div> <div class="sect2"> <h3 id="api_4"><a class="anchor" href="#api_4"></a>16.1. API</h3> <div class="paragraph"> <p>Infinispan&#8217;s own MapReduce model is an adaptation of Google&#8217;s original <a href="http://research.google.com/archive/mapreduce.html">MapReduce</a> . There are four main components in each map reduce task: Mapper, Reducer, Collator and MapReduceTask.</p> </div> <div class="paragraph"> <p>Implementation of a Mapper class is a component of MapReduceTask invoked once for each input entry K,V. Every Mapper instance is migrated to an Infinispan node, given a cache entry K,V input pair which it transforms into an intermediate key/value pair emitted into Infinispan provided Collector instance. Intermediate results are further reduced using a Reducer.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Mapper</span>&lt;KIn, VIn, KOut, VOut&gt; <span class="directive">extends</span> <span class="predefined-type">Serializable</span> {

   <span class="comment">/**
    * Invoked once for each input cache entry KIn,VOut pair.
    */</span>
   <span class="type">void</span> map(KIn key, VIn value, Collector&lt;KOut, VOut&gt; collector);
}</code></pre> </div> </div> <div class="paragraph"> <p>The Reducer, as its name implies, reduces a list of intermediate results from map phase of MapReduceTask. Infinispan distributed execution environment creates one instance of Reducer per execution node.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Reducer</span>&lt;KOut, VOut&gt; <span class="directive">extends</span> <span class="predefined-type">Serializable</span> {

   <span class="comment">/**
    * Combines/reduces all intermediate values for a particular intermediate key to a single value.
    * &lt;p&gt;
    *
    */</span>
   VOut reduce(KOut reducedKey, <span class="predefined-type">Iterator</span>&lt;VOut&gt; iter);

}</code></pre> </div> </div> <div class="paragraph"> <p>Collator coordinates results from Reducers executed on Infinispan cluster and assembles a final result returned to an invoker of MapReduceTask. Collator is applied to final <code>Map&lt;KOut, VOut&gt;</code> result of MapReduceTask.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Reducer</span>&lt;KOut, VOut&gt; <span class="directive">extends</span> <span class="predefined-type">Serializable</span> {

   <span class="comment">/**
    * Combines/reduces all intermediate values for a particular intermediate key to a single value.
    * &lt;p&gt;
    *
    */</span>
   VOut reduce(KOut reducedKey, <span class="predefined-type">Iterator</span>&lt;VOut&gt; iter);

}</code></pre> </div> </div> <div class="paragraph"> <p>Finally, <a href="https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/distexec/mapreduce/MapReduceTask.java">MapReduceTask</a> is a distributed task unifying Mapper, Reducer and Collator into a cohesive large scale computation to be transparently parallelized across Infinispan cluster nodes. Users of MapReduceTask need to provide a cache whose data is used as input for this task. Infinispan execution environment will instantiate and migrate instances of provided mappers and reducers seamlessly across Infinispan nodes. Unless otherwise specified using onKeys method input keys filter all available key value pairs of a specified cache will be used as input data for this task.</p> </div> <div class="sect3"> <h4 id="task_timeout"><a class="anchor" href="#task_timeout"></a>16.1.1. Task timeout</h4> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> The timeout per Map/Reduce task is only available for Infinispan 5.3 and higher. </td> </tr> </table> </div> <div class="paragraph"> <p>It is possible to set a timeout value for each Map/Reduce tasks. However, if no timeout is specified, it uses the replication timeout as a default timeout (the same behavior as the previous Infinispan versions). You can set the timeout in your task by doing the following:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">MapReduceTask task = <span class="keyword">new</span> MapReduceTask(cache);
task.timeout(<span class="integer">1</span>, <span class="predefined-type">TimeUnit</span>.MINUTES);</code></pre> </div> </div> <div class="paragraph"> <p>Also, it is possible to know which is the current timeout value for the task:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Map/Reduce task timeout is </span><span class="delimiter">&quot;</span></span> + task.timeout(<span class="predefined-type">TimeUnit</span>.MILLISECONDS) + <span class="string"><span class="delimiter">&quot;</span><span class="content"> millseconds</span><span class="delimiter">&quot;</span></span>);<span class="error">Â </span></code></pre> </div> </div> <div class="paragraph"> <p>For more information about this, please check the java doc in <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/distexec/mapreduce/MapReduceTask.html">Map Reduce Task API Documentation</a></p> </div> </div> </div> <div class="sect2"> <h3 id="mapper_and_cdi"><a class="anchor" href="#mapper_and_cdi"></a>16.2. Mapper and CDI</h3> <div class="paragraph"> <p>Although Mapper gets invoked with an appropriate input key/value pairs on an executing node, Infinispan also provides CDI injection of an input Cache in case users might need some additional data from input cache in order to complete map transformation. Upon arrival of user&#8217;s Mapper to an Infinispan executing node, Infinispan CDI mechanism will provide appropriate cache reference and inject it to executing Mapper. All one has to do is to declare a Cache field in Mapper and annotate it with @org.infinispan.cdi.Input annotation along with the mandatory @Inject annotation.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">WordCountCacheInjectedMapper</span> <span class="directive">implements</span> Mapper&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>, <span class="predefined-type">String</span>, <span class="predefined-type">Integer</span>&gt; {

      <span class="annotation">@Inject</span>
      <span class="annotation">@Input</span>
      <span class="directive">private</span> Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache;

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="type">void</span> map(<span class="predefined-type">String</span> key, <span class="predefined-type">String</span> value, Collector&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Integer</span>&gt; collector) {

         <span class="comment">//use injected cache if needed</span>
         <span class="predefined-type">StringTokenizer</span> tokens = <span class="keyword">new</span> <span class="predefined-type">StringTokenizer</span>(value);
         <span class="keyword">while</span> (tokens.hasMoreElements()) {
            <span class="predefined-type">String</span> s = (<span class="predefined-type">String</span>) tokens.nextElement();
            collector.emit(s, <span class="integer">1</span>);
         }
      }
}</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="mapreducetask_distributed_execution"><a class="anchor" href="#mapreducetask_distributed_execution"></a>16.3. MapReduceTask distributed execution</h3> <div class="paragraph"> <p>As our MapReduce implementation grew out of the proof of concept phase (and especially after our users had already production tested it), we needed to remove the most prominent impediment to an industrial grade MapReduce solution that we strive for: distributing reduce phase execution.</p> </div> <div class="ulist"> <ul> <li> <p>Reduce phase: prior to the Infinispan 5.2 release was done on a single Infinispan master task node. Therefore, the size of map reduce problems we could support (data size wise) was effectively shrunk to a working memory of a single Infinispan node. Starting with the Infinispan 5.2 release, we have removed this limitation, and reduce phase execution is distributed across the cluster as well. Of course, users still have an option to use MapReduceTask the old way, and we even recommend that particular approach for smaller sized input tasks. We have achieved distribution of reduce phase by relying on Infinispan&#8217;s consistent hashing and DeltaAware cache insertion. Here is how we distributed reduce phase execution:</p> </li> <li> <p>Map phase: MapReduceTask, as it currently does, will hash task input keys and group them by execution node N they are hashed to. After key node mapping, MapReduceTask sends map function and input keys to each node N. Map function is invoked using given keys and locally loaded corresponding values.</p> </li> </ul> </div> <div class="imageblock"> <div class="content"> <img src="./images/intermediatephase.png" alt="intermediatephase"> </div> </div> <div class="ulist"> <ul> <li> <p>Results are collected with an Infinispan supplied Collector, and combine phase is initiated. A Combiner, if specified, takes KOut keys and immediately invokes reduce phase on keys. The result of mapping phase executed on each node is KOut/VOut map. There will be one resulting map per execution node N per launched MapReduceTask.</p> </li> <li> <p>Intermediate KOut/VOut migration phase</p> <div class="ulist"> <ul> <li> <p>In order to proceed with reduce phase, all intermediate keys and values need to be grouped by intermediate KOut keys. More specifically, as map phases around the cluster can produce identical intermediate keys, all those identical intermediate keys and their values need to be grouped before reduce is executed on any particular intermediate key.</p> </li> <li> <p>Therefore at the end of combine phase, instead of returning map with intermediate keys and values to the master task node, we instead hash each intermediate key KOut and migrate it with its VOut values to Infinispan node where keys KOut are hashed to. We achieve this using a temporary DIST cache and underlying consistent hashing mechanism. Using DeltaAware cache insertion we effectively collect all VOut values under each KOut for all executed map functions across the cluster</p> </li> </ul> </div> </li> </ul> </div> <div class="imageblock"> <div class="content"> <img src="./images/mapphase.png" alt="mapphase"> </div> </div> <div class="ulist"> <ul> <li> <p>At this point, map and combine phase have finished its execution; list of KOut keys is returned to a master node and its initiating MapReduceTask. We do not return VOut values as we do not need them at master task node. MapReduceTask is ready to start with reduce phase.</p> </li> </ul> </div> <div class="paragraph"> <p>Reduce phase * Reduce phase is easy to accomplish now as Infinispan&#8217;s consistent hashing already finished all the hard lifting for us. To complete reduce phase, MapReduceTask groups KOut keys by execution node N they are hashed to. For each node N and its grouped input KOut keys, MapReduceTask sends a reduce command to a node N where KOut keys are hashed. Once reduce command arrives on target execution node, it looks up temporary cache belonging to MapReduce task - and for each KOut key, grabs a list of VOut values, wraps it with an Iterator and invokes reduce on it._</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/reducephase.png" alt="reducephase"> </div> </div> <div class="paragraph"> <p>A result of each reduce is a map where each key is KOut and value is VOut. Each Infinispan execution node N returns one map with KOut/VOut result values. As all initiated reduce commands return to a calling node, MapReduceTask simply combines all resulting maps into map M and returns M as a result of MapReduceTask.</p> </div> <div class="paragraph"> <p>Distributed reduce phase is turned on by using a MapReduceTask link:http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/distexec/mapreduce/MapReduceTask.html#MapReduceTask(org.infinispan.Cache, boolean)[constructor] specifying cache to use as input data for the task and boolean parameter distributeReducePhase set to true. Map/Reduce API <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/distexec/mapreduce/package-summary.html">javadoc</a> and demos are included in distribution.</p> </div> </div> <div class="sect2"> <h3 id="examples_2"><a class="anchor" href="#examples_2"></a>16.4. Examples</h3> <div class="paragraph"> <p>Word count is a classic, if not overused, example of map/reduce paradigm. Assume we have a mapping of key -&#8594; sentence stored on Infinispan nodes. Key is a String, each sentence is also a String, and we have to count occurrence of all words in all sentences available. The implementation of such a distributed task could be defined as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">WordCountExample</span> {

   <span class="comment">/**
    * In this example replace c1 and c2 with
    * real Cache references
    *
    * @param args
    */</span>
   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
      Cache c1 = <span class="predefined-constant">null</span>;
      Cache c2 = <span class="predefined-constant">null</span>;

      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello world here I am</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Infinispan rules the world</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JUDCon is in Boston</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">4</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss World is in Boston as well</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">12</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss Application Server</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">15</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello world</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">14</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Infinispan community</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">15</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello world</span><span class="delimiter">&quot;</span></span>);

      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">111</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Infinispan open source</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">112</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Boston is close to Toronto</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">113</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Toronto is a capital of Ontario</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">114</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JUDCon is cool</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">211</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss World is awesome</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">212</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss rules</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">213</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss division of RedHat </span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">214</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">RedHat community</span><span class="delimiter">&quot;</span></span>);

      MapReduceTask&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>, <span class="predefined-type">String</span>, <span class="predefined-type">Integer</span>&gt; t =
         <span class="keyword">new</span> MapReduceTask&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>, <span class="predefined-type">String</span>, <span class="predefined-type">Integer</span>&gt;(c1);
      t.mappedWith(<span class="keyword">new</span> WordCountMapper())
         .reducedWith(<span class="keyword">new</span> WordCountReducer());
      <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Integer</span>&gt; wordCountMap = t.execute();
   }

   <span class="directive">static</span> <span class="type">class</span> <span class="class">WordCountMapper</span> <span class="directive">implements</span> Mapper&lt;<span class="predefined-type">String</span>,<span class="predefined-type">String</span>,<span class="predefined-type">String</span>,<span class="predefined-type">Integer</span>&gt; {
      <span class="comment">/** The serialVersionUID */</span>
      <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">long</span> serialVersionUID = -<span class="integer">5943370243108735560L</span>;

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="type">void</span> map(<span class="predefined-type">String</span> key, <span class="predefined-type">String</span> value, Collector&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Integer</span>&gt; c) {
         <span class="predefined-type">StringTokenizer</span> tokens = <span class="keyword">new</span> <span class="predefined-type">StringTokenizer</span>(value);
         <span class="keyword">while</span> (tokens.hasMoreElements()) {
            <span class="predefined-type">String</span> s = (<span class="predefined-type">String</span>) tokens.nextElement();
            c.emit(s, <span class="integer">1</span>);
         }
      }
   }

   <span class="directive">static</span> <span class="type">class</span> <span class="class">WordCountReducer</span> <span class="directive">implements</span> Reducer&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Integer</span>&gt; {
      <span class="comment">/** The serialVersionUID */</span>
      <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">long</span> serialVersionUID = <span class="integer">1901016598354633256L</span>;

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="predefined-type">Integer</span> reduce(<span class="predefined-type">String</span> key, <span class="predefined-type">Iterator</span>&lt;<span class="predefined-type">Integer</span>&gt; iter) {
         <span class="type">int</span> sum = <span class="integer">0</span>;
         <span class="keyword">while</span> (iter.hasNext()) {
            <span class="predefined-type">Integer</span> i = (<span class="predefined-type">Integer</span>) iter.next();
            sum += i;
         }
         <span class="keyword">return</span> sum;
      }
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>As we have seen it is relatively easy to specify map reduce task counting number of occurrences for each word in all sentences. Best of all result is returned to task invoker in the form of <code>Map&lt;KOut, VOut&gt;</code> rather than being written to a stream.</p> </div> <div class="paragraph"> <p>What if we need to find the most frequent word in our word count example? All we have to do is to define a Collator that will transform the result of MapReduceTask <code>Map&lt;KOut, VOut&gt;</code> into a String which in turn is returned to a task invoker. We can think of Collator as transformation function applied to a final result of MapReduceTask.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">MapReduceTask&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>, <span class="predefined-type">String</span>, <span class="predefined-type">Integer</span>&gt; t = <span class="keyword">new</span> MapReduceTask&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>, <span class="predefined-type">String</span>, <span class="predefined-type">Integer</span>&gt;(cache);
t.mappedWith(<span class="keyword">new</span> WordCountMapper()).reducedWith(<span class="keyword">new</span> WordCountReducer());
<span class="predefined-type">String</span> mostFrequentWord = t.execute(
      <span class="keyword">new</span> <span class="predefined-type">Collator</span>&lt;<span class="predefined-type">String</span>,<span class="predefined-type">Integer</span>,<span class="predefined-type">String</span>&gt;() {

         <span class="annotation">@Override</span>
         <span class="directive">public</span> <span class="predefined-type">String</span> collate(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Integer</span>&gt; reducedResults) {
            <span class="predefined-type">String</span> mostFrequent = <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;
            <span class="type">int</span> maxCount = <span class="integer">0</span>;
            <span class="keyword">for</span> (Entry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Integer</span>&gt; e : reducedResults.entrySet()) {
               <span class="predefined-type">Integer</span> count = e.getValue();
               <span class="keyword">if</span>(count &gt; maxCount) {
                  maxCount = count;
                  mostFrequent = e.getKey();
               }
            }
         <span class="keyword">return</span> mostFrequent;
         }

      });
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">The most frequent word is </span><span class="delimiter">&quot;</span></span> + mostFrequentWord);</code></pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="streams"><a class="anchor" href="#streams"></a>17. Streams</h2> <div class="sectionbody"> <div class="paragraph"> <p>Java 8 introduced the concept of a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html">Stream</a> which allows functional-style operations on collections rather than having to procedurally iterate over the data yourself. Stream operations can be implemented in a fashion very similar to MapReduce. Streams, just like MapReduce allow you to perform processing upon the entirety of your cache, possibly a very large data set, but in an efficient way.</p> </div> <div class="paragraph"> <p>Also since we can control how the entries are iterated upon we can more efficiently perform the operations in a cache that is distributed if you want it to perform all of the operations across the cluster concurrently.</p> </div> <div class="paragraph"> <p>A stream is retrieved from the <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/Cache.html#entrySet--">entrySet</a>, <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/Cache.html#keySet--">keySet</a> or <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/Cache.html#values--">values</a> collections returned from the Cache by invoking the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Collection.html#stream--">stream</a> or <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Collection.html#parallelStream--">parallelStream</a> methods.</p> </div> <div class="sect2"> <h3 id="common_stream_operations"><a class="anchor" href="#common_stream_operations"></a>17.1. Common stream operations</h3> <div class="paragraph"> <p>This section highlights various options that are present irrespective of what type of underlying cache you are using.</p> </div> <div class="sect3"> <h4 id="key_filtering"><a class="anchor" href="#key_filtering"></a>17.1.1. Key filtering</h4> <div class="paragraph"> <p>It is possible to filter the stream so that it only operates upon a given subset of keys. This can be done by invoking the <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/CacheStream.html#filterKeys-java.util.Set-">filterKeys</a> method on the <code>CacheStream</code>. This should always be used over a Predicate <a href="http://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html?is-external=true#filter-java.util.function.Predicate-">filter</a> and will be faster if the predicate was holding all keys.</p> </div> <div class="paragraph"> <p>If you are familiar with the <code>AdvancedCache</code> interface you may be wondering why you even use <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/AdvancedCache.html#getAll-java.util.Set-">getAll</a> over this keyFilter. There are some small benefits (mostly smaller payloads) to using getAll if you need the entries as is and need them all in memory in the local node. However if you need to do processing on these elements a stream is recommended since you will get both distributed and threaded parallelism for free.</p> </div> </div> <div class="sect3"> <h4 id="segment_based_filtering"><a class="anchor" href="#segment_based_filtering"></a>17.1.2. Segment based filtering</h4> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> This is an advanced feature and should only be used with deep knowledge of Infinispan segment and hashing techniques. These segments based filtering can be useful if you need to segment data into separate invocations. This can be useful when integrating with other tools such as <a href="http://spark.apache.org/">Apache Spark</a>. </td> </tr> </table> </div> <div class="paragraph"> <p>This option is only supported for replicated and distributed caches. This allows the user to operate upon a subset of data at a time as determined by the <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/distribution/ch/KeyPartitioner.html">KeyPartitioner</a>. The segments can be filtered by invoking <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/CacheStream.html#filterKeySegments-java.util.Set-">filterKeySegments</a> method on the <code>CacheStream</code>. This is applied after the key filter but before any intermediate operations are performed.</p> </div> </div> </div> <div class="sect2"> <h3 id="local_invalidation"><a class="anchor" href="#local_invalidation"></a>17.2. Local/Invalidation</h3> <div class="paragraph"> <p>A stream used with a local or invalidation cache can be used just the same way you would use a stream on a regular collection. Infinispan handles all of the translations if necessary behind the scenes and works with all of the more interesting options (ie. storeAsBinary, compatibility mode, and a cache loader).</p> </div> <div class="sect3"> <h4 id="example"><a class="anchor" href="#example"></a>17.2.1. Example</h4> <div class="paragraph"> <p>The code below takes a cache and returns a map with all the cache entries whose values contain the string "JBoss"</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; jbossValues = cache.entrySet().stream()
              .filter(e -&gt; e.getValue().contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss</span><span class="delimiter">&quot;</span></span>))
              .collect(Collectors.toMap(<span class="predefined-type">Map</span>.Entry::getKey, <span class="predefined-type">Map</span>.Entry::getValue));</code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="distribution_replication"><a class="anchor" href="#distribution_replication"></a>17.3. Distribution/Replication</h3> <div class="paragraph"> <p>This is where streams come into their stride. When a stream operation is performed it will send the various intermediate and terminal operations to each node that has pertinent data. This allows processing the intermediate values on the nodes owning the data, and only sending the final results back to the originating nodes, improving performance.</p> </div> <div class="sect3"> <h4 id="rehash_aware"><a class="anchor" href="#rehash_aware"></a>17.3.1. Rehash Aware</h4> <div class="paragraph"> <p>Internally the data is segmented and each node only performs the operations upon the data it owns as a primary owner. This allows for data to be processed evenly, assuming segments are granular enough to provide for equal amounts of data on each node.</p> </div> <div class="paragraph"> <p>When you are utilizing a distributed cache, the data can be reshuffled between nodes when a new node joins or leaves. Distributed Streams handle this reshuffling of data automatically so you don&#8217;t have to worry about monitoring when nodes leave or join the cluster. Reshuffled entries may be processed a second time, and we keep track of the processed entries at the key level or at the segment level (depending on the terminal operation) to limit the amount of duplicate processing.</p> </div> <div class="paragraph"> <p>It is possible but highly discouraged to disable rehash awareness on the stream. This should only be considered if your request can handle only seeing a subset of data if a rehash occurs. This can be done by invoking <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/CacheStream.html#disableRehashAware--">CacheStream.disableRehashAware()</a> The performance gain for most operations when a rehash doesn&#8217;t occur is completely negligible. The only exceptions are for iterator and forEach, which will use less memory, since they do not have to keep track of processed keys.</p> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> Please rethink disabling rehash awareness unless you really know what you are doing. </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="serialization"><a class="anchor" href="#serialization"></a>17.3.2. Serialization</h4> <div class="paragraph"> <p>Since the operations are sent across to other nodes they must be serializable by Infinispan marshalling. This allows the operations to be sent to the other nodes.</p> </div> <div class="paragraph"> <p>The simplest way is to cast your lambdas as Serializable as below.</p> </div> <div class="paragraph"> <p>In our previous example we used a <code>Collector</code> to collect all the results into a <code>Map</code>. Unfortunately the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collectors.html">Collectors</a> class doesn&#8217;t produce Serializable instances. Thus if you need to use these, you can use the newly provided <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/stream/CacheCollectors.html">CacheCollectors</a> class which allows for a <code>Supplier&lt;Collector&gt;</code> to be provided. This instance could then use the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collectors.html">Collectors</a> to supply a <code>Collector</code> which is not serialized. You can read more details about how the collector peforms in a distributed fashion at <a href="user_guide.html#_distributed_stream_execution">distributed execution</a>.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; jbossValues = cache.entrySet().stream()
              .filter((<span class="predefined-type">Serializable</span> &amp; <span class="predefined-type">Predicate</span>&lt;<span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt;&gt;) e -&gt; e.getValue().contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">Jboss</span><span class="delimiter">&quot;</span></span>))
              .collect(CacheCollectors.serializableCollector(() -&gt; Collectors.toMap(<span class="predefined-type">Map</span>.Entry::getKey, <span class="predefined-type">Map</span>.Entry::getValue)));</code></pre> </div> </div> <div class="paragraph"> <p>The recommended way is to use an <a href="user_guide.html#_advanced_externalizers">AdvancedExternalizer</a> as this provides the smallest payload.</p> </div> </div> <div class="sect3"> <h4 id="parallel_computation"><a class="anchor" href="#parallel_computation"></a>17.3.3. Parallel Computation</h4> <div class="paragraph"> <p>Distributed streams by default try to parallelize as much as possible. It is possible for the end user to control this and actually they always have to control one of the options. There are 2 ways these streams are parallelized.</p> </div> <div class="sect4"> <h5 id="local_to_each_node"><a class="anchor" href="#local_to_each_node"></a>Local to each node</h5> <div class="paragraph"> <p>When a stream is created from the cache collection the end user can choose between invoking <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Collection.html#stream--">stream</a> or <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Collection.html#parallelStream--">parallelStream</a> method. Depending on if the parallel stream was picked will enable multiple threading for each node locally. Note that some operations like a rehash aware iterator and forEach operations will always use a sequential stream locally. This could be enhanced at some point to allow for parallel streams locally.</p> </div> </div> <div class="sect4"> <h5 id="remote_requests"><a class="anchor" href="#remote_requests"></a>Remote requests</h5> <div class="paragraph"> <p>When there are multiple nodes it may be desirable to control whether the remote requests are all processed at the same time concurrently or one at a time. By default all terminal operations except the iterator perform concurrent requests. The iterator, method to reduce overall memory pressure on the local node, only performs sequential requests which actually performs slightly better.</p> </div> <div class="paragraph"> <p>If a user wishes to change this default however they can do so by invoking the <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/CacheStream.html#sequentialDistribution--">sequentialDistribution</a> or <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/CacheStream.html#parallelDistribution--">parallelDistribution</a> methods on the <code>CacheStream</code>. Note that currently intermediate operations return a <code>Stream</code> instance so you must make sure to invoke these methods before calling another intermediate operation.</p> </div> </div> </div> <div class="sect3"> <h4 id="task_timeout_2"><a class="anchor" href="#task_timeout_2"></a>17.3.4. Task timeout</h4> <div class="paragraph"> <p>It is possible to set a timeout value for the operation requests. This timeout is used only for remote requests timing out and it is on a per request basis. The former means the local execution will not timeout and the latter means if you have a failover scenario as described above the subsequent requests each have a new timeout. If no timeout is specified it uses the replication timeout as a default timeout. You can set the timeout in your task by doing the following:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">CacheStream&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; stream = cache.entrySet().stream();
stream.timeout(<span class="integer">1</span>, <span class="predefined-type">TimeUnit</span>.MINUTES);</code></pre> </div> </div> <div class="paragraph"> <p>For more information about this, please check the java doc in <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/CacheStream.html#timeout-long-java.util.concurrent.TimeUnit-">timeout</a> javadoc.</p> </div> </div> <div class="sect3"> <h4 id="injection"><a class="anchor" href="#injection"></a>17.3.5. Injection</h4> <div class="paragraph"> <p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html">Stream</a> has a terminal operation called <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#forEach-java.util.function.Consumer-">forEach</a> which allows for running some sort of side effect operation on the data. In this case it may be desirable to get a reference to the <code>Cache</code> that is backing this Stream. If your <code>Consumer</code> implements the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/stream/CacheAware.html">CacheAware</a> interface the <code>injectCache</code> method be invoked before the accept method from the <code>Consumer</code> interface.</p> </div> </div> <div class="sect3"> <h4 id="distributed_stream_execution"><a class="anchor" href="#distributed_stream_execution"></a>17.3.6. Distributed Stream execution</h4> <div class="paragraph"> <p>Distributed streams execution works in a fashion very similiar to map reduce. Except in this case we are sending zero to many intermediate operations (map, filter etc.) and a single terminal operation to the various nodes. The operation basically comes down to the following:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>The desired segments are grouped by which node is the primary owner of the given segment</p> </li> <li> <p>A request is generated to send to each remote node that contains the intermediate and terminal operations including which segments it should process</p> <div class="olist loweralpha"> <ol class="loweralpha" type="a"> <li> <p>The terminal operation will be performed locally if necessary</p> </li> <li> <p>Each remote node will receive this request and run the operations and subsequently send the response back</p> </li> </ol> </div> </li> <li> <p>The local node will then gather the local response and remote responses together performing any kind of reduction required by the operations themselves.</p> </li> <li> <p>Final reduced response is then returned to the user</p> </li> </ol> </div> <div class="paragraph"> <p>In most cases all operations are fully distributed, as in the operations are all fully applied on each remote node and usually only the last operation or something related may be reapplied to reduce the results from multiple nodes. One important note is that intermediate values do not actually have to be serializable, it is the last value sent back that is the part desired (exceptions for various operations will be highlighted below).</p> </div> <div class="sect4"> <h5 id="terminal_operator_distributed_result_reductions"><a class="anchor" href="#terminal_operator_distributed_result_reductions"></a>Terminal operator distributed result reductions</h5> <div class="paragraph"> <p>The following paragraphs describe how the distributed reductions work for the various terminal operators. Some of these are special in that an intermediate value may be required to be serializable instead of the final result.</p> </div> <div class="dlist"> <dl> <dt class="hdlist1">allMatch noneMatch anyMatch</dt> <dd> <p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#allMatch-java.util.function.Predicate-">allMatch</a> operation is ran on each node and then all the results are logically anded together locally to get the appropriate value. The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#noneMatch-java.util.function.Predicate-">noneMatch</a> and <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#anyMatch-java.util.function.Predicate-">anyMatch</a> operations use a logical or instead. These methods also have early termination support, stopping remote and local operations once the final result is known.</p> </dd> <dt class="hdlist1">collect</dt> <dd> <p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#collect-java.util.stream.Collector-">collect</a> method is interesting in that it can do a few extra steps. The remote node performs everything as normal except it doesn&#8217;t perform the final <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collector.html#finisher--">finisher</a> upon the result and instead sends back the fully combined results. The local thread then <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collector.html#combiner--">combines</a> the remote and local result into a value which is then finally finished. The key here to remember is that the final value doesn&#8217;t have to be serializable but rather the values produced from the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collector.html#supplier--">supplier</a> and <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collector.html#combiner--">combiner</a> methods.</p> </dd> <dt class="hdlist1">count</dt> <dd> <p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#count--">count</a> method just adds the numbers together from each node.</p> </dd> <dt class="hdlist1">findAny findFirst</dt> <dd> <p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#findAny--">findAny</a> operation returns just the first value they find, whether it was from a remote node or locally. Note this supports early termination in that once a value is found it will not process others. Note the findFirst method is special since it requires a sorted intermediate operation, which is detailed in the <a href="user_guide.html#_intermediate_operation_exceptions">exceptions</a> section.</p> </dd> <dt class="hdlist1">max min</dt> <dd> <p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#max-java.util.Comparator-">max</a> and <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#min-java.util.Comparator-">min</a> methods find the respective min or max value on each node then a final reduction is performed locally to ensure only the min or max across all nodes is returned.</p> </dd> <dt class="hdlist1">reduce</dt> <dd> <p>The various reduce methods <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#reduce-java.util.function.BinaryOperator-">1</a> , <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#reduce-T-java.util.function.BinaryOperator-">2</a> , <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#reduce-U-java.util.function.BiFunction-java.util.function.BinaryOperator-">3</a> will end up serializing the result as much as the accumulator can do. Then it will accumulate the local and remote results together locally, before combining if you have provided that. Note this means a value coming from the combiner doesn&#8217;t have to be Serializable.</p> </dd> </dl> </div> </div> </div> <div class="sect3"> <h4 id="key_based_rehash_aware_operators"><a class="anchor" href="#key_based_rehash_aware_operators"></a>17.3.7. Key based rehash aware operators</h4> <div class="paragraph"> <p>The <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/CacheStream.html#iterator--">iterator</a>, <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/CacheStream.html#spliterator--">spliterator</a> and <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/CacheStream.html#forEach-java.util.function.Consumer-">forEach</a> are unlike the other terminal operators in that the rehash awareness has to keep track of what keys per segment have been processed instead of just segments. This is to guarantee an exactly once (iterator &amp; spliterator) or at least once behavior (forEach) even under cluster membership changes.</p> </div> <div class="paragraph"> <p>The <code>iterator</code> and <code>spliterator</code> operators when invoked on a remote node will return back batches of entries, where the next batch is only sent back after the last has been fully consumed. This batching is done to limit how many entries are in memory at a given time. The user node will hold onto which keys it has processed and when a given segment is completed it will release those keys from memory. This is why sequential processing is preferred for the iterator method, so only a subset of segment keys are held in memory at once, instead of from all nodes.</p> </div> <div class="paragraph"> <p>The forEach method also returns batches, but it returns a batch of keys after it has finished processing at least a batch worth of keys. This way the originating node can know what keys have been processed already to reduce chances of processing the same entry again. Unfortunately this means it is possible to have an at least once behavior when a node goes down unexpectedly. In this case that node could have been processing a batch and not yet completed one and those entries that were processed but not in a completed batch will be ran again when the rehash failure operation occurs. Note that adding a node will not cause this issue as the rehash failover doesn&#8217;t occur until all responses are received.</p> </div> <div class="paragraph"> <p>These operations batch sizes are both controlled by the same value which can be configured by invoking <a href="https://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/CacheStream.html#distributedBatchSize-int-">distributedBatchSize</a> method on the <code>CacheStream</code>. This value will default to the <code>chunkSize</code> configured in state transfer. Unfortunately this value is a tradeoff with memory usage vs performance vs at least once and your mileage may vary.</p> </div> <div class="sect4"> <h5 id="using_code_iterator_code_with_a_replication_cache"><a class="anchor" href="#using_code_iterator_code_with_a_replication_cache"></a>Using <code>iterator</code> with a replication cache</h5> <div class="paragraph"> <p>Currently if you are using a replicated cache the <code>iterator</code> or <code>spliterator</code> terminal operations will not perform any of the operations remotely and will instead perform everythign on the local node. This is for performance as doing a remote iteration process is very costly.</p> </div> </div> </div> <div class="sect3"> <h4 id="intermediate_operation_exceptions"><a class="anchor" href="#intermediate_operation_exceptions"></a>17.3.8. Intermediate operation exceptions</h4> <div class="paragraph"> <p>There are some intermediate operations that have special exceptions, these are <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#skip-long-">skip</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#peek-java.util.function.Consumer-">peek</a>, sorted <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#sorted-java.util.Comparator-">1</a> <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#sorted--">2</a>. &amp; <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#distinct--">distinct</a>. All of these methods have some sort of artificial iterator implanted in the stream processing to guarantee correctness, they are documented as below. Note this means these operations may cause possibly severe performance degradation.</p> </div> <div class="dlist"> <dl> <dt class="hdlist1">Skip</dt> <dd> <p>An artificial iterator is implanted up to the intermediate skip operation. Then results are brought locally so it can skip the appropriate amount of elements.</p> </dd> <dt class="hdlist1">Peek</dt> <dd> <p>An artificial iterator is implanted up to the intermediate peek operation. Only up to the number of peeked elements is returned a remote node. Then results are brought locally so it can peek at only the amount desired.</p> </dd> <dt class="hdlist1">Sorted</dt> <dd> <p>WARNING: This operation requires having all entries in memory on the local node. An artificial iterator is implanted up to the intermediate sorted operation. All results are sorted locally. There are possible plans to have a distributed sort which returns batches of elements, but this is not yet implemented.</p> </dd> <dt class="hdlist1">Distinct</dt> <dd> <p>WARNING: This operation requires having all or nearly all entries in memory on the local node. Distinct is performed on each remote node and then an artificial iterator returns those distinct values. Then finally all of those results have a distinct operation performed upon them.</p> </dd> </dl> </div> <div class="paragraph"> <p>The rest of the intermediate operations are fully distributed as one would expect.</p> </div> </div> </div> <div class="sect2"> <h3 id="examples_3"><a class="anchor" href="#examples_3"></a>17.4. Examples</h3> <div class="paragraph"> <p>Using the existing Map/Reduce example <a href="user_guide.html#examples_2">example</a>, it has been adapted for Streams. Word count is a classic, if overused, example of map/reduce paradigm. Assume we have a mapping of key &#8594; sentence stored on Infinispan nodes. Key is a String, each sentence is also a String, and we have to count occurrence of all words in all sentences available. The implementation of such a distributed task could be defined as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">WordCountExample</span> {

   <span class="comment">/**
    * In this example replace c1 and c2 with
    * real Cache references
    *
    * @param args
    */</span>
   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
      Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; c1 = ...;
      Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; c2 = ...;

      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello world here I am</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Infinispan rules the world</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JUDCon is in Boston</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">4</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss World is in Boston as well</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">12</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss Application Server</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">15</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello world</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">14</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Infinispan community</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">15</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello world</span><span class="delimiter">&quot;</span></span>);

      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">111</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Infinispan open source</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">112</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Boston is close to Toronto</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">113</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Toronto is a capital of Ontario</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">114</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JUDCon is cool</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">211</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss World is awesome</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">212</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss rules</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">213</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss division of RedHat </span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">214</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">RedHat community</span><span class="delimiter">&quot;</span></span>);

      <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Integer</span>&gt; wordCountMap = c1.entrySet().parallelStream()
         .map((<span class="predefined-type">Serializable</span> &amp; Function&lt;<span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;, <span class="predefined-type">String</span><span class="type">[]</span>&gt;) e -&gt; e.getValue().split(<span class="string"><span class="delimiter">&quot;</span><span class="char">\\</span><span class="content">s</span><span class="delimiter">&quot;</span></span>))
         .flatMap((<span class="predefined-type">Serializable</span> &amp; Function&lt;<span class="predefined-type">String</span><span class="type">[]</span>, Stream&lt;<span class="predefined-type">String</span>&gt;&gt;) <span class="predefined-type">Arrays</span>::stream)
         .collect(CacheCollectors.serializableCollector(() -&gt; Collectors.groupingBy(Function.identity(), Collectors.counting())));
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>In this case it is pretty simple to do the word count from the previous example.</p> </div> <div class="paragraph"> <p>However what if we want to find the most frequent word in the example? If you take a second to think about this case you will realize you need to have all words counted and available locally first. Thus we actually have a few options.</p> </div> <div class="paragraph"> <p>We can use something akin to the old Collator from Map/Reduce by slightly tweaking our collector. Some redundant lines have been removed from the previous example.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">WordCountExample</span> {
   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
      <span class="comment">// Lines removed</span>

      <span class="predefined-type">String</span> mostFrequentWord = c1.entrySet().parallelStream()
         .map((<span class="predefined-type">Serializable</span> &amp; Function&lt;<span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;, <span class="predefined-type">String</span><span class="type">[]</span>&gt;) e -&gt; e.getValue().split(<span class="string"><span class="delimiter">&quot;</span><span class="char">\\</span><span class="content">s</span><span class="delimiter">&quot;</span></span>))
         .flatMap((<span class="predefined-type">Serializable</span> &amp; Function&lt;<span class="predefined-type">String</span><span class="type">[]</span>, Stream&lt;<span class="predefined-type">String</span>&gt;&gt;) <span class="predefined-type">Arrays</span>::stream)
         .collect(CacheCollectors.serializableCollector(() -&gt; Collectors.collectingAndThen(
            Collectors.groupingBy(Function.identity(), Collectors.counting()),
               wordCountMap -&gt; {
                  <span class="predefined-type">String</span> mostFrequent = <span class="predefined-constant">null</span>;
                  <span class="type">long</span> maxCount = <span class="integer">0</span>;
                     <span class="keyword">for</span> (<span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Long</span>&gt; e : wordCountMap.entrySet()) {
                        <span class="type">int</span> count = e.getValue().intValue();
                        <span class="keyword">if</span> (count &gt; maxCount) {
                           maxCount = count;
                           mostFrequent = e.getKey();
                        }
                     }
                     <span class="keyword">return</span> mostFrequent;
               })));

}</code></pre> </div> </div> <div class="paragraph"> <p>Unfortunately the last step is only going to be ran in a single thread, which if we have a lot of words could be quite slow. Maybe there is another way to parallelize this with Streams.</p> </div> <div class="paragraph"> <p>We mentioned before we are in the local node after processing, so we could actually use a stream on the map results. We can therefore use a parallel stream on the results.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">WordFrequencyExample</span> {
   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
      <span class="comment">// Lines removed</span>

      <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Long</span>&gt; wordCount = c1.entrySet().parallelStream()
              .map((<span class="predefined-type">Serializable</span> &amp; Function&lt;<span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;, <span class="predefined-type">String</span><span class="type">[]</span>&gt;) e -&gt; e.getValue().split(<span class="string"><span class="delimiter">&quot;</span><span class="char">\\</span><span class="content">s</span><span class="delimiter">&quot;</span></span>))
              .flatMap((<span class="predefined-type">Serializable</span> &amp; Function&lt;<span class="predefined-type">String</span><span class="type">[]</span>, Stream&lt;<span class="predefined-type">String</span>&gt;&gt;) <span class="predefined-type">Arrays</span>::stream)
              .collect(CacheCollectors.serializableCollector(() -&gt; Collectors.groupingBy(Function.identity(), Collectors.counting())));
      Optional&lt;<span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Long</span>&gt;&gt; mostFrequent = wordCount.entrySet().parallelStream().reduce(
              (e1, e2) -&gt; e1.getValue() &gt; e2.getValue() ? e1 : e2);</code></pre> </div> </div> <div class="paragraph"> <p>This way you can still utilize all of the cores locally when calculating the most frequent element.</p> </div> <div class="paragraph"> <p>Also remember that <code>Streams</code> are a JRE tool now and there are a multitude of examples that can be found all over. Just remember that your operations need to be Serializable in some fashion!</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="DistributedExecutor"><a class="anchor" href="#DistributedExecutor"></a>18. Distributed Execution Framework</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan provides distributed execution through a standard JDK <a href="http://docs.oracle.com/javase/6/docs/api/java/util/concurrent/ExecutorService.html">ExecutorService</a> interface. Tasks submitted for execution, instead of being executed in a local JVM, are executed on an entire cluster of Infinispan nodes. Every DistributedExecutorService is bound to one particular cache. Tasks submitted will have access to key/value pairs from that particular cache if and only if the task submitted is an instance of DistributedCallable. Also note that there is nothing preventing users from submitting a familiar Runnable or Callable just like to any other ExecutorService. However, DistributedExecutorService, as it name implies, will likely migrate submitted Callable or Runnable to another JVM in Infinispan cluster, execute it and return a result to task invoker. Due to a potential task migration to other nodes every Callable, Runnable and/or DistributedCallable submitted must be either Serializable or Externalizable. Also the value returned from a callable must be Serializable or Externalizable as well. If the value returned is not serializable a NotSerializableException will be thrown.</p> </div> <div class="paragraph"> <p>Infinispan&#8217;s distributed task executors use data from Infinispan cache nodes as input for execution tasks. Most other distributed frameworks do not have that leverage and users have to specify input for distributed tasks from some well known location. Furthermore, users of Infinispan distributed execution framework do not have to configure store for intermediate and final results thus removing another layer of complexity and maintenance.</p> </div> <div class="paragraph"> <p>Our distributed execution framework capitalizes on the fact input data in Infinispan data grid is already load balanced (in case of DIST mode). Since input data is already balanced execution tasks will be automatically balanced as well; users do not have to explicitly assign work tasks to specific Infinispan nodes. However, our framework accommodates users to specify arbitrary subset of cache keys as input for distributed execution tasks.</p> </div> <div class="sect2"> <h3 id="distributedcallable_api"><a class="anchor" href="#distributedcallable_api"></a>18.1. DistributedCallable API</h3> <div class="paragraph"> <p>In case users needs access to Infinispan cache data for an execution of a task we recommend that you encapsulate task in <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/distexec/DistributedCallable.html">DistributedCallable</a> interface. DistributedCallable is a subtype of the existing Callable from java.util.concurrent package; DistributedCallable can be executed in a remote JVM and receive input from Infinispan cache. Task&#8217;s main algorithm could essentially remain unchanged, only the input source is changed. Exisiting Callable implementations most likely get its input in a form of some Java object/primitive while DistributedCallable gets its input from Infinispan cache. Therefore, users who have already implemented Callable interface to describe their task units would simply extend DistributedCallable and use keys from Infinispan execution environment as input for the task. Implentation of DistributedCallable can in fact continue to support implementation of an already existing Callable while simultaneously be ready for distribited execution by extending DistributedCallable.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">DistributedCallable</span>&lt;K, V, T&gt; <span class="directive">extends</span> <span class="predefined-type">Callable</span>&lt;T&gt; {

   <span class="comment">/**
    * Invoked by execution environment after DistributedCallable
    * has been migrated for execution to a specific Infinispan node.
    *
    * @param cache
    *           cache whose keys are used as input data for this
    *           DistributedCallable task
    * @param inputKeys
    *           keys used as input for this DistributedCallable task
    */</span>
   <span class="directive">public</span> <span class="type">void</span> setEnvironment(Cache&lt;K, V&gt; cache, <span class="predefined-type">Set</span>&lt;K&gt; inputKeys);

}</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="callable_and_cdi"><a class="anchor" href="#callable_and_cdi"></a>18.2. Callable and CDI</h3> <div class="paragraph"> <p>Users that do not want or can not implement DistributedCallable yet need a reference to input cache used in DistributedExecutorService have an option of the input cache being injected by CDI mechanism. Upon arrival of user&#8217;s Callable to an Infinispan executing node, Infinispan CDI mechanism will provide appropriate cache reference and inject it to executing Callable. All one has to do is to declare a Cache field in Callable and annotate it with org.infinispan.cdi.Input annotation along with mandatory @Inject annotation.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"> <span class="directive">public</span> <span class="type">class</span> <span class="class">CallableWithInjectedCache</span> <span class="directive">implements</span> <span class="predefined-type">Callable</span>&lt;<span class="predefined-type">Integer</span>&gt;, <span class="predefined-type">Serializable</span> {
<span class="error">Â </span> <span class="error">Â </span> <span class="error">Â </span>
<span class="error">Â </span> <span class="error">Â </span> <span class="error">Â </span> <span class="annotation">@Inject</span>
      <span class="annotation">@Input</span>
<span class="error">Â </span> <span class="error">Â </span> <span class="error">Â </span> <span class="directive">private</span> Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache;


<span class="error">Â </span> <span class="error">Â </span> <span class="error">Â </span> <span class="annotation">@Override</span>
<span class="error">Â </span> <span class="error">Â </span> <span class="error">Â </span> <span class="directive">public</span> <span class="predefined-type">Integer</span> call() <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="comment">//use injected cache reference</span>
        <span class="keyword">return</span> <span class="integer">1</span>;
<span class="error">Â </span> <span class="error">Â </span> <span class="error">Â </span> }
}</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="distributedexecutorservice_distributedtaskbuilder_and_distributedtask_api"><a class="anchor" href="#distributedexecutorservice_distributedtaskbuilder_and_distributedtask_api"></a>18.3. DistributedExecutorService, DistributedTaskBuilder and DistributedTask API</h3> <div class="paragraph"> <p><a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/distexec/DistributedExecutorService.html">DistributedExecutorService</a> is a simple extension of a familiar <a href="http://docs.oracle.com/javase/6/docs/api/java/util/concurrent/ExecutorService.html">ExecutorService</a> from java.util.concurrent package. However, advantages of DistributedExecutorService are not to be overlooked. Existing Callable tasks, instead of being executed in JDK&#8217;s ExecutorService, are also eligible for execution on Infinispan cluster. Infinispan execution environment would migrate a task to execution node(s), run the task and return the result(s) to the calling node. Of course, not all Callable tasks would benefit from parallel distributed execution. Excellent candidates are long running and computationally intensive tasks that can run concurrently and/or tasks using input data that can be processed concurrently. For more details about good candidates for parallel execution and parallel algorithms in general refer to <a href="https://computing.llnl.gov/tutorials/parallel_comp/">Introduction to Parallel Computing</a> .</p> </div> <div class="paragraph"> <p>The second advantage of the DistributedExecutorService is that it allows a quick and simple implementation of tasks that take input from Infinispan cache nodes, execute certain computation and return results to the caller. Users would specify which keys to use as input for specified DistributedCallable and submit that callable for execution on Infinispan cluster. Infinispan runtime would locate the appriate keys, migrate DistributedCallable to target execution node(s) and finally return a list of results for each executed Callable. Of course, users can omit specifying input keys in which case Infinispan would execute DistributedCallable on all keys for a specified cache.</p> </div> <div class="paragraph"> <p>Lets see how we can use DistributedExecutorService If you already have Callable/Runnable tasks defined! Well, simply submit them to an instance of DefaultExecutorService for execution!</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">ExecutorService</span> des = <span class="keyword">new</span> DefaultExecutorService(cache);
<span class="predefined-type">Future</span>&lt;<span class="predefined-type">Boolean</span>&gt; future = des.submit(<span class="keyword">new</span> SomeCallable());
<span class="predefined-type">Boolean</span> r = future.get();</code></pre> </div> </div> <div class="paragraph"> <p>In case you need to specify more task parameters like task timeout, custom failover policy or execution policy use <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/distexec/DistributedTaskBuilder.html">DistributedTaskBuilder</a> and <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/distexec/DistributedTask.html">DistributedTask</a> API.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">DistributedExecutorService des = <span class="keyword">new</span> DefaultExecutorService(cache);
DistributedTaskBuilder&lt;<span class="predefined-type">Boolean</span>&gt; taskBuilder = des.createDistributedTaskBuilder(<span class="keyword">new</span> SomeCallable());
taskBuilder.timeout(<span class="integer">10</span>,<span class="predefined-type">TimeUnit</span>.SECONDS);
...
...
DistributedTask&lt;<span class="predefined-type">Boolean</span>&gt; distributedTask = taskBuilder.build();
<span class="predefined-type">Future</span>&lt;<span class="predefined-type">Boolean</span>&gt; future = des.submit(distributedTask);
<span class="predefined-type">Boolean</span> r = future.get();</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="distributed_task_failover"><a class="anchor" href="#distributed_task_failover"></a>18.4. Distributed task failover</h3> <div class="paragraph"> <p>Distributed execution framework supports task failover. By default no failover policy is installed and task&#8217;s Runnable/Callable/DistributedCallable will simply fail. Failover mechanism is invoked in the following cases:</p> </div> <div class="paragraph"> <p>a) Failover due to a node failure where task is executing</p> </div> <div class="paragraph"> <p>b) Failover due to a task failure (e.g. Callable task throws Exception).</p> </div> <div class="paragraph"> <p>Infinispan provides random node failover policy which will attempt execution of a part of distributed task on another random node, if such node is available. However, users that have a need to implement a more sophisticated failover policy can implement <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/distexec/DistributedTaskFailoverPolicy.html">DistributedTaskFailoverPolicy</a> interface. For example, users might want to use consistent hashing (CH) mechanism for failover of uncompleted tasks. CH based failover might for example migrate failed task T to cluster node(s) having a backup of input data that was executed on a failed node F.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * DistributedTaskFailoverPolicy allows pluggable fail over target selection for a failed remotely
 * executed distributed task.
 *
 */</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">DistributedTaskFailoverPolicy</span> {

   <span class="comment">/**
    * As parts of distributively executed task can fail due to the task itself throwing an exception
    * or it can be an Infinispan system caused failure (e.g node failed or left cluster during task
    * execution etc).
    *
    * @param failoverContext
    *           the FailoverContext of the failed execution
    * @return result the Address of the Infinispan node selected for fail over execution
    */</span>
   Address failover(FailoverContext context);

   <span class="comment">/**
    * Maximum number of fail over attempts permitted by this DistributedTaskFailoverPolicy
    *
    * @return max number of fail over attempts
    */</span>
   <span class="type">int</span> maxFailoverAttempts();
}</code></pre> </div> </div> <div class="paragraph"> <p>Therefore one could for example specify random failover execution policy simply by:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">DistributedExecutorService des = <span class="keyword">new</span> DefaultExecutorService(cache);
DistributedTaskBuilder&lt;<span class="predefined-type">Boolean</span>&gt; taskBuilder = des.createDistributedTaskBuilder(<span class="keyword">new</span> SomeCallable());
taskBuilder.failoverPolicy(DefaultExecutorService.RANDOM_NODE_FAILOVER);
DistributedTask&lt;<span class="predefined-type">Boolean</span>&gt; distributedTask = taskBuilder.build();
<span class="predefined-type">Future</span>&lt;<span class="predefined-type">Boolean</span>&gt; future = des.submit(distributedTask);
<span class="predefined-type">Boolean</span> r = future.get();</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="distributed_task_execution_policy"><a class="anchor" href="#distributed_task_execution_policy"></a>18.5. Distributed task execution policy</h3> <div class="paragraph"> <p><a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/distexec/DistributedTaskExecutionPolicy.html">DistributedTaskExecutionPolicy</a> is an enum that allows tasks to specify its custom task execution policy across Infinispan cluster. DistributedTaskExecutionPolicy effectively scopes execution of tasks to a subset of nodes. For example, someone might want to exclusively execute tasks on a local network site instead of a backup remote network centre as well. Others might, for example, use only a dedicated subset of a certain Infinispan rack nodes for specific task execution. DistributedTaskExecutionPolicy is set per instance of DistributedTask.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">DistributedExecutorService des = <span class="keyword">new</span> DefaultExecutorService(cache);
DistributedTaskBuilder&lt;<span class="predefined-type">Boolean</span>&gt; taskBuilder = des.createDistributedTaskBuilder(<span class="keyword">new</span> SomeCallable());
taskBuilder.executionPolicy(DistributedTaskExecutionPolicy.SAME_RACK);
DistributedTask&lt;<span class="predefined-type">Boolean</span>&gt; distributedTask = taskBuilder.build();
<span class="predefined-type">Future</span>&lt;<span class="predefined-type">Boolean</span>&gt; future = des.submit(distributedTask);
<span class="predefined-type">Boolean</span> r = future.get();</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="examples_4"><a class="anchor" href="#examples_4"></a>18.6. Examples</h3> <div class="paragraph"> <p>Pi approximation can greatly benefit from parallel distributed execution in DistributedExecutorService. Recall that area of the square is Sa = 4r2 and area of the circle is Ca=pi*r2. Substituting r2 from the second equation into the first one it turns out that pi = 4 * Ca/Sa. Now, image that we can shoot very large number of darts into a square; if we take ratio of darts that land inside a circle over a total number of darts shot we will approximate Ca/Sa value. Since we know that pi = 4 * Ca/Sa we can easily derive approximate value of pi. The more darts we shoot the better approximation we get. In the example below we shoot 10 million darts but instead of "shooting" them serially we parallelize work of dart shooting across entire Infinispan cluster.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">  <span class="directive">public</span> <span class="type">class</span> <span class="class">PiAppx</span> {

   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main (<span class="predefined-type">String</span> <span class="type">[]</span> arg){
      <span class="predefined-type">List</span>&lt;Cache&gt; caches = ...;
      Cache cache = ...;

      <span class="type">int</span> numPoints = <span class="integer">10000000</span>;
      <span class="type">int</span> numServers = caches.size();
      <span class="type">int</span> numberPerWorker = numPoints / numServers;

      DistributedExecutorService des = <span class="keyword">new</span> DefaultExecutorService(cache);
      <span class="type">long</span> start = <span class="predefined-type">System</span>.currentTimeMillis();
      CircleTest ct = <span class="keyword">new</span> CircleTest(numberPerWorker);
      <span class="predefined-type">List</span>&lt;<span class="predefined-type">Future</span>&lt;<span class="predefined-type">Integer</span>&gt;&gt; results = des.submitEverywhere(ct);
      <span class="type">int</span> countCircle = <span class="integer">0</span>;
      <span class="keyword">for</span> (<span class="predefined-type">Future</span>&lt;<span class="predefined-type">Integer</span>&gt; f : results) {
         countCircle += f.get();
      }
      <span class="type">double</span> appxPi = <span class="float">4.0</span> * countCircle / numPoints;

      <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Distributed PI appx is </span><span class="delimiter">&quot;</span></span> + appxPi +
      <span class="string"><span class="delimiter">&quot;</span><span class="content"> completed in </span><span class="delimiter">&quot;</span></span> + (<span class="predefined-type">System</span>.currentTimeMillis() - start) + <span class="string"><span class="delimiter">&quot;</span><span class="content"> ms</span><span class="delimiter">&quot;</span></span>);
   }

   <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">CircleTest</span> <span class="directive">implements</span> <span class="predefined-type">Callable</span>&lt;<span class="predefined-type">Integer</span>&gt;, <span class="predefined-type">Serializable</span> {

      <span class="comment">/** The serialVersionUID */</span>
      <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">long</span> serialVersionUID = <span class="integer">3496135215525904755L</span>;

      <span class="directive">private</span> <span class="directive">final</span> <span class="type">int</span> loopCount;

      <span class="directive">public</span> CircleTest(<span class="type">int</span> loopCount) {
         <span class="local-variable">this</span>.loopCount = loopCount;
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="predefined-type">Integer</span> call() <span class="directive">throws</span> <span class="exception">Exception</span> {
         <span class="type">int</span> insideCircleCount = <span class="integer">0</span>;
         <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; loopCount; i++) {
            <span class="type">double</span> x = <span class="predefined-type">Math</span>.random();
            <span class="type">double</span> y = <span class="predefined-type">Math</span>.random();
            <span class="keyword">if</span> (insideCircle(x, y))
               insideCircleCount++;
         }
         <span class="keyword">return</span> insideCircleCount;
      }

      <span class="directive">private</span> <span class="type">boolean</span> insideCircle(<span class="type">double</span> x, <span class="type">double</span> y) {
         <span class="keyword">return</span> (<span class="predefined-type">Math</span>.pow(x - <span class="float">0.5</span>, <span class="integer">2</span>) + <span class="predefined-type">Math</span>.pow(y - <span class="float">0.5</span>, <span class="integer">2</span>))
         &lt;= <span class="predefined-type">Math</span>.pow(<span class="float">0.5</span>, <span class="integer">2</span>);
      }
   }
}</code></pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="management_tooling"><a class="anchor" href="#management_tooling"></a>19. Management Tooling</h2> <div class="sectionbody"> <div class="paragraph"> <p>Management of Infinispan instances is all about exposing as much relevant statistical information that allows administrators to get a view of the state of each Infinispan instance. Taking in account that a single installation could be made up of several tens or hundreds Infinispan instances, providing clear and concise information in an efficient manner is imperative. The following sections dive into the range of management tooling that Infinispan provides.</p> </div> <div class="sect2"> <h3 id="jmx"><a class="anchor" href="#jmx"></a>19.1. JMX</h3> <div class="paragraph"> <p>Over the years, <a href="http://www.oracle.com/technetwork/java/javase/tech/javamanagement-140525.html">JMX</a> has become the de facto standard for management and administration of middleware and as a result, the Infinispan team has decided to standardize on this technology for the exposure of management and statistical information.</p> </div> <div class="sect3"> <h4 id="understanding_the_exposed_mbeans"><a class="anchor" href="#understanding_the_exposed_mbeans"></a>19.1.1. Understanding The Exposed MBeans</h4> <div class="paragraph"> <p>By connecting to the VM(s) where Infinispan is running with a standard JMX GUI such as <a href="http://docs.oracle.com/javase/6/docs/technotes/guides/management/jconsole.html">JConsole</a> or <a href="http://docs.oracle.com/javase/6/docs/technotes/guides/visualvm/">VisualVM</a> you should find the following MBeans:</p> </div> <div class="ulist"> <ul> <li> <p>For CacheManager level JMX statistics, without further configuration, you should see an MBean called <em>org.infinispan:type=CacheManager,name="DefaultCacheManager"</em> with <a href="http://docs.jboss.org/infinispan/8.2/apidocs/jmxComponents.html#CacheManager">properties specified by the CacheManager MBean</a> .</p> </li> <li> <p>Using the cacheManagerName attribute in globalJmxStatistics XML element, or using the corresponding GlobalJmxStatisticsConfigurationBuilder.cacheManagerName(String cacheManagerName) call, you can name the cache manager in such way that the name is used as part of the JMX object name. So, if the name had been "Hibernate2LC", the JMX name for the cache manager would have been: <em>org.infinispan:type=CacheManager,name="Hibernate2LC"</em> . This offers a nice and clean way to manage environments where multiple cache managers are deployed, which follows <a href="http://www.oracle.com/technetwork/java/javase/tech/best-practices-jsp-136021.html">JMX best practices</a> .</p> </li> <li> <p>For Cache level JMX statistics, you should see several different MBeans depending on which configuration options have been enabled. For example, if you have configured a write behind cache store, you should see an MBean exposing properties belonging to the cache store component. All Cache level MBeans follow the same format though which is the following: <code>org.infinispan:type=Cache,name="${name-of-cache}(${cache-mode})",manager="${name-of-cache-manager}",component=${component-name}</code> where:</p> </li> <li> <p>${name-of-cache} has been substituted by the actual cache name. If this cache represents the default cache, its name will be <code>___defaultCache</code>.</p> </li> <li> <p>${cache-mode} has been substituted by the cache mode of the cache. The cache mode is represented by the lower case version of the possible enumeration values shown <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/configuration/cache/CacheMode">here</a>.</p> </li> <li> <p>${name-of-cache-manager} has been substituted by the name of the cache manager to which this cache belongs. The name is derived from the <em>cacheManagerName</em> attribute value in <code>globalJmxStatistics</code> element.</p> </li> <li> <p>${component-name} has been substituted by one of the JMX component names in the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/jmxComponents.html">JMX reference documentation</a> .</p> </li> </ul> </div> <div class="paragraph"> <p>For example, the cache store JMX component MBean for a default cache configured with synchronous distribution would have the following name: <code>org.infinispan:type=Cache,name="___defaultcache(dist_sync)",manager="DefaultCacheManager",component=CacheStore</code></p> </div> <div class="paragraph"> <p>Please note that cache and cache manager names are quoted to protect against illegal characters being used in these user-defined names.</p> </div> </div> <div class="sect3"> <h4 id="enabling_jmx_statistics"><a class="anchor" href="#enabling_jmx_statistics"></a>19.1.2. Enabling JMX Statistics</h4> <div class="paragraph"> <p>The MBeans mentioned in the previous section are always created and registered in the MBeanServer allowing you to manage your caches but some of their attributes do not expose meaningful values unless you take the extra step of enabling collection of statistics. Gathering and reporting statistics via JMX can be enabled at 2 different levels:</p> </div> <div class="paragraph"> <div class="title">CacheManager level</div> <p>The CacheManager is the entity that governs all the cache instances that have been created from it. Enabling CacheManager statistics collections differs depending on the configuration style:</p> </div> <div class="ulist"> <ul> <li> <p>If configuring the CacheManager via XML, make sure you add the following XML under the <code>&lt;cache-container /&gt;</code> element:</p> <div class="literalblock"> <div class="content"> <pre>&lt;cache-container statistics="true"/&gt;</pre> </div> </div> </li> <li> <p>If configuring the CacheManager programmatically, simply add the following code:</p> <div class="literalblock"> <div class="content"> <pre>GlobalConfigurationBuilder globalConfigurationBuilder = ...
globalConfigurationBuilder.globalJmxStatistics().enable();</pre> </div> </div> </li> </ul> </div> <div class="paragraph"> <div class="title">Cache level</div> <p>At this level, you will receive management information generated by individual cache instances. Enabling Cache statistics collections differs depending on the configuration style:</p> </div> <div class="ulist"> <ul> <li> <p>If configuring the Cache via XML, make sure you add the following XML under the one of the top level cache elements, such as <code>&lt;local-cache /&gt;</code>:</p> <div class="literalblock"> <div class="content"> <pre>&lt;local-cache statistics="true"/&gt;</pre> </div> </div> </li> <li> <p>If configuring the Cache programmatically, simply add the following code:</p> <div class="literalblock"> <div class="content"> <pre>ConfigurationBuilder configurationBuilder = ...
configurationBuilder.jmxStatistics().enable();</pre> </div> </div> </li> </ul> </div> </div> <div class="sect3"> <h4 id="multiple_jmx_domains"><a class="anchor" href="#multiple_jmx_domains"></a>19.1.3. Multiple JMX Domains</h4> <div class="paragraph"> <p>There can be situations where several CacheManager instances are created in a single VM, or Cache names belonging to different CacheManagers under the same VM clash.</p> </div> <div class="paragraph"> <p>Using different JMX domains for multi cache manager environments should be last resort. Instead, it&#8217;s possible to name a cache manager in such way that it can easily be identified and used by monitoring tools such as RHQ. For example:</p> </div> <div class="ulist"> <ul> <li> <p>Via XML:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;cache-container</span> <span class="attribute-name">statistics</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Hibernate2LC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="ulist"> <ul> <li> <p>Programmatically:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder globalConfigurationBuilder = ...
globalConfigurationBuilder.globalJmxStatistics()
    .enable()
    .cacheManagerName(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hibernate2LC</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>Using either of these options should result on the CacheManager MBean name being: <code>org.infinispan:type=CacheManager,name="Hibernate2LC"</code></p> </div> <div class="paragraph"> <p>For the time being, you can still set your own jmxDomain if you need to and we also allow duplicate domains, or rather duplicate JMX names, but these should be limited to very special cases where different cache managers within the same JVM are named equally.</p> </div> </div> <div class="sect3"> <h4 id="registering_mbeans_in_non_default_mbean_servers"><a class="anchor" href="#registering_mbeans_in_non_default_mbean_servers"></a>19.1.4. Registering MBeans In Non-Default MBean Servers</h4> <div class="paragraph"> <p>Let&#8217;s discuss where Infinispan registers all these MBeans. By default, Infinispan registers them in the <a href="http://docs.oracle.com/javase/6/docs/api/java/lang/management/ManagementFactory.html#getPlatformMBeanServer()">standard JVM MBeanServer platform</a> . However, users might want to register these MBeans in a different MBeanServer instance. For example, an application server might work with a different MBeanServer instance to the default platform one. In such cases, users should implement the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/jmx/MBeanServerLookup.html">MBeanServerLookup interface</a> provided by Infinispan so that the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/jmx/MBeanServerLookup.html#getMBeanServer()">getMBeanServer() method</a> returns the MBeanServer under which Infinispan should register the management MBeans. You can find an example in the default <a href="http://anonsvn.jboss.org/repos/infinispan/tags/4.0.0.FINAL/core/src/main/java/org/infinispan/jmx/PlatformMBeanServerLookup.java">PlatformMBeanServerLookup class</a> used by Infinispan. So, once you have your implementation ready, simply configure Infinispan with the fully qualified name of this class. For example:</p> </div> <div class="ulist"> <ul> <li> <p>Via XML:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;cache-container</span> <span class="attribute-name">statistics</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;jmx</span> <span class="attribute-name">mbean-server-lookup</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.acme.MyMBeanServerLookup</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/cache-container&gt;</span></code></pre> </div> </div> <div class="ulist"> <ul> <li> <p>Programmatically:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder globalConfigurationBuilder = ...
globalConfigurationBuilder.globalJmxStatistics()
    .enable()
    .mBeanServerLookup(<span class="keyword">new</span> com.acme.MyMBeanServerLookup());</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="mbeans_added_in_infinispan_5_0"><a class="anchor" href="#mbeans_added_in_infinispan_5_0"></a>19.1.5. MBeans added in Infinispan 5.0</h4> <div class="paragraph"> <p>There has been a couple of noticeable additions in Infinispan 5.0 in terms of exposed MBeans:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>MBeans related to Infinispan servers are now available that for the moment focus on the transport layer. A new MBean named <code>org.infinispan:type=Server,name={Memcached|HotRod},component=Transport</code> offers information such as: host name, port, bytes read, byte written, number of worker threads, etc.</p> </li> <li> <p>When global JMX statistics are enabled, the JGroups channel MBean is also registered automatically under the name <code>org.infinispan:type=channel,cluster={name-of-your-cluster}</code>, so you can get key information of the group communication transport layer that&#8217;s used to cluster Infinispan instances. To find out more about the information provided, check the <a href="http://community.jboss.org/docs/10938">JGroups JMX documentation</a>.</p> </li> </ol> </div> </div> </div> <div class="sect2"> <h3 id="rhq"><a class="anchor" href="#rhq"></a>19.2. RHQ</h3> <div class="paragraph"> <p>The preferred way to manage multiple Infinispan instances spread across different servers is to use RHQ, which is JBoss' enterprise management solution. Thanks to RHQ&#8217;s agent and auto discovery capabilities, monitoring both Cache Manager and Cache instances is a very simple task. With RHQ, administrators have access to graphical views of key runtime parameters or statistics and can also be notified be these exceed or go below certain limits. The Infinispan specific statistics shown by RHQ are a reflection of the JMX information exposed by Infinispan which has been formatted for consumption by RHQ. Please follow these steps to get started with RHQ and have Infinispan instances monitored with it:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Firstly, download and install an RHQ server and install and start at least one RHQ agent. The job of the RHQ agent is to send information about the Infinispan instance back to the server which is the one that shows the information via a nice GUI. You can find detailed information on the installation process in <a href="https://docs.jboss.org/author/display/RHQ/Installation">RHQ&#8217;s installation guide</a> and you can find information on how to run an agent in the <a href="https://docs.jboss.org/author/display/RHQ/Running+the+RHQ+Agent">Running the RHQ Agent</a> .</p> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> <div class="title">Careful with H2 database installation</div> If you&#8217;re just building a demo or testing RHQ server, you can avoid the need to install a fully fledged database and use an in-memory H2 database instead. However, you might encounter issues after testing database connection as shown <a href="https://lists.fedorahosted.org/pipermail/rhq-users/2010-June/000045.html">here</a>. Simply repeating the installation avoiding testing the connection should work. </td> </tr> </table> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Where do I install the RHQ agent?</div> The most common set up is to have the RHQ agent installed in the same machine where Infinispan is running. If you have multiple machines, an agent can be installed in each machine. </td> </tr> </table> </div> </li> <li> <p>By now, you should have an RHQ server and agent running. It&#8217;s time now to download the latest Infinispan binary distribution (*-bin.zip or *-all.zip should do) from the <a href="http://infinispan.org/download/">downloads</a> section and locate the RHQ plugin jar file which should be named something like infinispan-rhq-plugin.jar. This is located under the modules/rhq-plugin directory.</p> </li> <li> <p>The <a href="https://docs.jboss.org/author/display/RHQ/Agent+Plugin+Administration">adding and updating plugins section</a> on the RHQ guide contains some more detailed information on how to update both RHQ servers and agents with new plugins, but essentially, this process involves uploading a new plugin to the RHQ server and then pushing the plugin to one, or several, RHQ agents.</p> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Speeding up plugin installation</div> If you&#8217;re simply demoing or testing and you only have a single agent, once the plugin has been uploaded to the server, simply go to the agent command line interface and type: plugins update .This will force the agent to retrieve the latest plugins from the server. Doing this can be considerably faster than some of the other alternatives. </td> </tr> </table> </div> </li> <li> <p>At this point, RHQ is ready to start monitoring Infinispan instances, but before firing them up, make sure you start them with the following system properties so that RHQ agents can discover them:</p> <div class="literalblock"> <div class="content"> <pre>-Dcom.sun.management.jmxremote.port=6996 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false</pre> </div> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Remote JMX port value</div> The actual port value used does not really matter here, but what matters is that a port is given, otherwise Infinispan instances cannot be located. So, you can easily start multiple Infinispan instances in a single machine, each with a different remote JMX port, and a locally running agent will be able to discover them all without any problems. </td> </tr> </table> </div> </li> <li> <p>Once Infinispan instances have been discovered, you should see a new resource for each of the cache manager running appearing in the <a href="https://docs.jboss.org/author/display/RHQ/Initial+Auto-discovery+and+Import">Inventory/Discovery Queue</a> of the RHQ server. Simply import it now and you should see each cache manager appearing with as many child cache resources as caches are running in each cache manager. You&#8217;re now ready to monitor Infinispan!</p> </li> </ol> </div> <div class="sect3"> <h4 id="rhq_monitoring_tips"><a class="anchor" href="#rhq_monitoring_tips"></a>19.2.1. RHQ monitoring tips</h4> <div class="paragraph"> <p>This section focuses on the lessons learned while developing the Infinispan RHQ plugin that are likely to be useful to anyone using RHQ.</p> </div> <div class="ulist"> <ul> <li> <p>By default, at least in version 2.3.1 of RHQ, the RHQ agent sends an availability report of any managed resources every 5 minutes. The problem with this is that if you&#8217;re testing whether your Infinispan instance is automatically discovered by the RHQ server, it can take up to 5 minutes to do so! Also, it can take 5 minutes for the RHQ server to figure out that you&#8217;ve shutdown your Infinispan instance. You can change this setting by the following property (default value is 300 seconds) in <code>rhq-agent/conf/agent-configuration.xml</code>. For example, if you wanted the availability to be sent every 1 minute, simply change the value to 60:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rhq.agent.plugins.availability-scan.period-secs</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">60</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> <div class="title">Careful with agent configuration changes</div> Please bear in mind the instructions given in the <a href="https://docs.jboss.org/author/display/RHQ/RHQ+Agent+Installation">RHQ agent installation</a> and more specifically the paragraph below with regards to changes made to properties in agent-configuration.xml: </td> </tr> </table> </div> <div class="quoteblock"> <blockquote> <div class="paragraph"> <p>Once the agent is configured, it persists its configuration in the Java Preferences backing store. Once this happens, agent-configuration.xml is no longer needed or used. Editing agent-configuration.xml will no longer have any effect on the agent, even if you restart the agent. If you want the agent to pick up changes you make to agent-configuration.xml, you must either restart the agent with the "--cleanconfig" command line option or use the "config --import" agent prompt command.</p> </div> </blockquote> </div> </div> </div> <div class="sect2"> <h3 id="hawt_io"><a class="anchor" href="#hawt_io"></a>19.3. Hawt.io</h3> <div class="paragraph"> <p><a href="http://hawt.io">Hawt.io</a>, a slick, fast, HTML5-based open source management console, also has support for Infinispan. Refer to <a href="http://hawt.io/plugins/infinispan/">Hawt.io&#8217;s documentation</a> for information regarding this plugin.</p> </div> </div> <div class="sect2"> <h3 id="writing_plugins_for_other_management_tools"><a class="anchor" href="#writing_plugins_for_other_management_tools"></a>19.4. Writing plugins for other management tools</h3> <div class="paragraph"> <p>As mentioned in the previous section, RHQ consumes the JMX data exposed by Infinispan, and in similar fashion, plugins could be written for other 3rd party management tools that were able to transform these data into the correct representation in these tools, for example graphs, etc.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="cdi_support"><a class="anchor" href="#cdi_support"></a>20. CDI Support</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan includes integration with <a href="http://docs.oracle.com/javaee/6/tutorial/doc/giwhb.html">Contexts and Dependency Injection (better known as CDI)</a> via Infinispan&#8217;s <code>infinispan-cdi</code> module. Configuration and injection of Infinispan&#8217;s Cache interface is provided, and it is planned to bridge Cache listeners to the CDI event system as well. The module also provide partial support of the JCache (JSR-107) caching annotations - for further details see <a href="https://docs.google.com/document/d/1YZ-lrH6nW871Vd9Z34Og_EqbX_kxxJi55UrSn4yL2Ak/edit?hl=en&amp;amp;pli=1#heading=h.jdfazu3s6oly">Chapter 8</a> of the JCACHE specification.</p> </div> <div class="sect2"> <h3 id="maven_dependencies_2"><a class="anchor" href="#maven_dependencies_2"></a>20.1. Maven Dependencies</h3> <div class="paragraph"> <p>To include CDI support for Infinispan in your project:</p> </div> <div class="listingblock"> <div class="title">pom.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>infinispan-cdi<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>${infinispan.version}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre> </div> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Which version of Infinispan should I use?</div> We recommend using the latest final version of the infinispan-cdi module. </td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="embedded_cache_integration"><a class="anchor" href="#embedded_cache_integration"></a>20.2. Embedded cache integration</h3> <div class="sect3"> <h4 id="inject_an_embedded_cache"><a class="anchor" href="#inject_an_embedded_cache"></a>20.2.1. Inject an embedded cache</h4> <div class="paragraph"> <p>By default you can inject the default Infinispan cache. Let&#8217;s look at the following example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">...
import javax.inject.Inject;

<span class="directive">public</span> <span class="type">class</span> <span class="class">GreetingService</span> {
    <span class="annotation">@Inject</span>
    <span class="directive">private</span> Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache;

    <span class="directive">public</span> <span class="predefined-type">String</span> greet(<span class="predefined-type">String</span> user) {
        <span class="predefined-type">String</span> cachedValue = cache.get(user);
        <span class="keyword">if</span> (cachedValue == <span class="predefined-constant">null</span>) {
            cachedValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello </span><span class="delimiter">&quot;</span></span> + user;
            cache.put(user, cachedValue);
        }
        <span class="keyword">return</span> cachedValue;
    }
}</code></pre> </div> </div> <div class="paragraph"> <p>If you want to use a specific cache rather than the default one, you just have to provide your own cache configuration and cache qualifier. For example, if you want to use a custom cache for the GreetingService you should write your own qualifier (such as GreetingCache) and define its configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">...
import javax.inject.Qualifier;

<span class="annotation">@Qualifier</span>
<span class="annotation">@Target</span>({<span class="predefined-type">ElementType</span>.FIELD, <span class="predefined-type">ElementType</span>.PARAMETER, <span class="predefined-type">ElementType</span>.METHOD})
<span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
<span class="annotation">@Documented</span>
<span class="directive">public</span> <span class="annotation">@interface</span> GreetingCache {
}</code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">...
import org.infinispan.configuration.cache.Configuration;
<span class="keyword">import</span> <span class="include">org.infinispan.configuration.cache.ConfigurationBuilder</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.cdi.ConfigureCache</span>;
<span class="keyword">import</span> <span class="include">javax.enterprise.inject.Produces</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {
    <span class="annotation">@ConfigureCache</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">greeting-cache</span><span class="delimiter">&quot;</span></span>) <span class="comment">// This is the cache name.</span>
    <span class="annotation">@GreetingCache</span> <span class="comment">// This is the cache qualifier.</span>
    <span class="annotation">@Produces</span>
    <span class="directive">public</span> <span class="predefined-type">Configuration</span> greetingCacheConfiguration() {
        <span class="keyword">return</span> <span class="keyword">new</span> ConfigurationBuilder()
                    .eviction()
                        .strategy(EvictionStrategy.LRU)
                        .maxEntries(<span class="integer">1000</span>)
                    .build();
    }

    <span class="comment">// The same example without providing a custom configuration.</span>
    <span class="comment">// In this case the default cache configuration will be used.</span>
    <span class="annotation">@ConfigureCache</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">greeting-cache</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@GreetingCache</span>
    <span class="annotation">@Produces</span>
    <span class="directive">public</span> <span class="predefined-type">Configuration</span> greetingCacheConfiguration;
}</code></pre> </div> </div> <div class="paragraph"> <p>To use this cache in the GreetingService add the @GeetingCache qualifier on your cache injection point. Simple!</p> </div> </div> <div class="sect3"> <h4 id="override_the_default_embedded_cache_manager_and_configuration"><a class="anchor" href="#override_the_default_embedded_cache_manager_and_configuration"></a>20.2.2. Override the default embedded cache manager and configuration</h4> <div class="paragraph"> <p>You can override the default cache configuration used by the default embedded cache manager. For that, you just have to create one Configuration producer with the @Default qualifier as illustrated in the following snippet:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {
    <span class="comment">// By default CDI adds the @Default qualifier if no other qualifier is provided.</span>
    <span class="annotation">@Produces</span>
    <span class="directive">public</span> <span class="predefined-type">Configuration</span> defaultEmbeddedCacheConfiguration() {
        <span class="keyword">return</span> <span class="keyword">new</span> ConfigurationBuilder()
                    .eviction()
                        .strategy(EvictionStrategy.LRU)
                        .maxEntries(<span class="integer">100</span>)
                    .build();
    }
}</code></pre> </div> </div> <div class="paragraph"> <p>It&#8217;s also possible to override the default embedded cache manager used. The new default cache manager produced must have the @Default qualifier and the scope @ApplicationScoped .</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">...
import javax.enterprise.context.ApplicationScoped;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {
    <span class="annotation">@Produces</span>
    <span class="annotation">@ApplicationScoped</span>
    <span class="directive">public</span> EmbeddedCacheManager defaultEmbeddedCacheManager() {
      <span class="keyword">return</span> <span class="keyword">new</span> DefaultCacheManager(<span class="keyword">new</span> ConfigurationBuilder()
                                          .eviction()
                                              .strategy(EvictionStrategy.LRU)
                                              .maxEntries(<span class="integer">100</span>)
                                          .build());
   }
}</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="configure_the_transport_for_clustered_use"><a class="anchor" href="#configure_the_transport_for_clustered_use"></a>20.2.3. Configure the transport for clustered use</h4> <div class="paragraph"> <p>To use Infinispan in a clustered mode you have to configure the transport with the GlobalConfiguration. To achieve that override the default cache manager as explained in the previous section. Look at the following snippet:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">...
package org.infinispan.configuration.global.GlobalConfigurationBuilder;

<span class="annotation">@Produces</span>
<span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> EmbeddedCacheManager defaultClusteredCacheManager() {
    <span class="keyword">return</span> <span class="keyword">new</span> DefaultCacheManager(
        <span class="keyword">new</span> GlobalConfigurationBuilder().transport().defaultTransport().build(),
        <span class="keyword">new</span> ConfigurationBuilder().eviction().maxEntries(<span class="integer">7</span>).build()
    );
}</code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="remote_cache_integration"><a class="anchor" href="#remote_cache_integration"></a>20.3. Remote cache integration</h3> <div class="sect3"> <h4 id="inject_a_remote_cache"><a class="anchor" href="#inject_a_remote_cache"></a>20.3.1. Inject a remote cache</h4> <div class="paragraph"> <p>With the CDI integration it&#8217;s also possible to use a remote cache. For example you can inject the default RemoteCache as illustrated in the following snippet:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">GreetingService</span> {
    <span class="annotation">@Inject</span>
    <span class="directive">private</span> RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache;

    <span class="directive">public</span> <span class="predefined-type">String</span> greet(<span class="predefined-type">String</span> user) {
        <span class="predefined-type">String</span> cachedValue = cache.get(user);
        <span class="keyword">if</span> (cachedValue == <span class="predefined-constant">null</span>) {
            cachedValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello </span><span class="delimiter">&quot;</span></span> + user;
            cache.put(user, cachedValue);
        }
        <span class="keyword">return</span> cachedValue;
    }
}</code></pre> </div> </div> <div class="paragraph"> <p>If you want to use another cache, for example the greeting-cache, add the @Remote qualifier on the cache injection point which contains the cache name.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">GreetingService</span> {
    <span class="annotation">@Inject</span> <span class="annotation">@Remote</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">greeting-cache</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache;

    ...
}</code></pre> </div> </div> <div class="paragraph"> <p>Adding the @Remote cache qualifier on each injection point might be error prone. That&#8217;s why the remote cache integration provides another way to achieve the same goal. For that you have to create your own qualifier annotated with @Remote :</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Remote</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">greeting-cache</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Qualifier</span>
<span class="annotation">@Target</span>({<span class="predefined-type">ElementType</span>.FIELD, <span class="predefined-type">ElementType</span>.PARAMETER, <span class="predefined-type">ElementType</span>.METHOD})
<span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
<span class="annotation">@Documented</span>
<span class="directive">public</span> <span class="annotation">@interface</span> RemoteGreetingCache {
}</code></pre> </div> </div> <div class="paragraph"> <p>To use this cache in the GreetingService add the qualifier @RemoteGreetingCache qualifier on your cache injection.</p> </div> </div> <div class="sect3"> <h4 id="override_the_default_remote_cache_manager"><a class="anchor" href="#override_the_default_remote_cache_manager"></a>20.3.2. Override the default remote cache manager</h4> <div class="paragraph"> <p>Like the embedded cache integration, the remote cache integration comes with a default remote cache manager producer. This default remote cache manager can be overridden as illustrated in the following snippet:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {
    <span class="annotation">@Produces</span>
    <span class="annotation">@ApplicationScoped</span>
    <span class="directive">public</span> RemoteCacheManager defaultRemoteCacheManager() {
        <span class="keyword">return</span> <span class="keyword">new</span> RemoteCacheManager(localhost, <span class="integer">1544</span>);
    }
}</code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="use_a_custom_remote_embedded_cache_manager_for_one_or_more_cache"><a class="anchor" href="#use_a_custom_remote_embedded_cache_manager_for_one_or_more_cache"></a>20.4. Use a custom remote/embedded cache manager for one or more cache</h3> <div class="paragraph"> <p>It&#8217;s possible to use a custom cache manager for one or more cache. You just need to annotate the cache manager producer with the cache qualifiers. Look at the following example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {
   <span class="annotation">@GreetingCache</span>
   <span class="annotation">@Produces</span>
   <span class="annotation">@ApplicationScoped</span>
   <span class="directive">public</span> EmbeddedCacheManager specificEmbeddedCacheManager() {
      <span class="keyword">return</span> <span class="keyword">new</span> DefaultCacheManager(<span class="keyword">new</span> ConfigurationBuilder()
                                          .expiration()
                                              .lifespan(<span class="integer">60000l</span>)
                                          .build());
   }

   <span class="annotation">@RemoteGreetingCache</span>
   <span class="annotation">@Produces</span>
   <span class="annotation">@ApplicationScoped</span>
   <span class="directive">public</span> RemoteCacheManager specificRemoteCacheManager() {
       <span class="keyword">return</span> <span class="keyword">new</span> RemoteCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span>, <span class="integer">1544</span>);
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>With the above code the GreetingCache or the RemoteGreetingCache will be associated with the produced cache manager.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="title">Producer method scope</div> To work properly the producers must have the scope @ApplicationScoped . Otherwise each injection of cache will be associated to a new instance of cache manager. </td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="use_a_jboss_as_7_configured_cache"><a class="anchor" href="#use_a_jboss_as_7_configured_cache"></a>20.5. Use a JBoss AS 7 configured cache</h3> <div class="paragraph"> <p>With JBoss AS 7, you can setup an Infinispan cache manager in the server configuration file. This allows you to externalize your Infinispan configuration and also to lookup the cache manager from JNDI, normally with the @Resource annotation.</p> </div> <div class="paragraph"> <p>As we mentioned earlier, you can override the default cache manager used by the Infinispan CDI extension. To use a JBoss AS 7 configured cache, you need to use the cache manager defined in JBoss AS 7. You only need to annotate the default cache manager producer with @Resource. The following example shows how use an embedded cache manager configured in JBoss AS 7.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">...
import javax.annotation.Resource;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {
    <span class="annotation">@Produces</span>
    <span class="annotation">@ApplicationScoped</span>
    <span class="annotation">@Resource</span>(lookup=<span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/infinispan/my-container-name</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> EmbeddedCacheManager defaultCacheManager;
}</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="use_jcache_caching_annotations"><a class="anchor" href="#use_jcache_caching_annotations"></a>20.6. Use JCache caching annotations</h3> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> There is now a separate module for JSR 107 (JCACHE) integration, including API. See <a href="#_using_infinispan_as_a_jsr107_jcache_provider">this chapter</a> for details. </td> </tr> </table> </div> <div class="paragraph"> <p>The infinispan-cdi module provides a partial support of JCache caching annotations. These annotations provide a simple way to handle common use cases. The following caching annotations are defined in this specification:</p> </div> <div class="ulist"> <ul> <li> <p>@CacheResult caches the result of a method call</p> </li> <li> <p>@CachePut caches a method parameter</p> </li> <li> <p>@CacheRemoveEntry removes an entry from a cache</p> </li> <li> <p>@CacheRemoveAll removes all entries from a cache</p> </li> </ul> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> <div class="title">Annotations target type</div> These annotations must only be used on methods. </td> </tr> </table> </div> <div class="paragraph"> <p>To use these annotations the following interceptors must be declared in your application beans.xml .</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/javaee</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/beans_1_0.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;interceptors&gt;</span>
        <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.InjectedCacheResultInterceptor<span class="tag">&lt;/class&gt;</span>
        <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.InjectedCachePutInterceptor<span class="tag">&lt;/class&gt;</span>
        <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.InjectedCacheRemoveEntryInterceptor<span class="tag">&lt;/class&gt;</span>
        <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.InjectedCacheRemoveAllInterceptor<span class="tag">&lt;/class&gt;</span>
    <span class="tag">&lt;/interceptors&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The following snippet of code illustrates the use of @CacheResult annotation. As you can see it simplifies the caching of the Greetingservice#greet method results.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.cache.interceptor.CacheResult</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">GreetingService</span> {
    <span class="annotation">@CacheResult</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> greet(<span class="predefined-type">String</span> user) {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello</span><span class="delimiter">&quot;</span></span> + user;
    }
}</code></pre> </div> </div> <div class="paragraph"> <p>The first version of the GreetingService and the above version have exactly the same behavior. The only difference is the cache used. By default it&#8217;s the fully qualified name of the annotated method with its parameter types (e.g. org.infinispan.example.GreetingService.greet(java.lang.String) ).</p> </div> <div class="paragraph"> <div class="title">Can I use a different cache?</div> <p>To use another cache specify its name with the cacheName attribute of the cache annotation. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@CacheResult</span>(cacheName = <span class="string"><span class="delimiter">&quot;</span><span class="content">greeting-cache</span><span class="delimiter">&quot;</span></span>)</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="use_cache_events_and_cdi"><a class="anchor" href="#use_cache_events_and_cdi"></a>20.7. Use Cache events and CDI</h3> <div class="paragraph"> <p>It is possible to receive Cache and Cache Manager level events using CDI Events. You can achieve it using @Observes annotation as shown in the following snippet:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.enterprise.event.Observes</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachemanagerlistener.event.CacheStartedEvent</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.event</span>.*;

<span class="directive">public</span> <span class="type">class</span> <span class="class">GreetingService</span> {

    <span class="comment">// Cache level events</span>
    <span class="directive">private</span> <span class="type">void</span> entryRemovedFromCache(<span class="annotation">@Observes</span> CacheEntryCreatedEvent event) {
        ...
    }

    <span class="comment">// Cache Manager level events</span>
    <span class="directive">private</span> <span class="type">void</span> cacheStarted(<span class="annotation">@Observes</span> CacheStartedEvent event) {
        ...
    }
}</code></pre> </div> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> Check <a href="#_Listeners_and_notifications_section">Listeners and Notifications section</a> for more information about event types. </td> </tr> </table> </div> </div> </div> </div> <div class="sect1"> <h2 id="_custom_interceptors_chapter"><a class="anchor" href="#_custom_interceptors_chapter"></a>21. Custom Interceptors</h2> <div class="sectionbody"> <div class="paragraph"> <p>It is possible to add custom interceptors to Infinispan, both declaratively and programatically. Custom interceptors are a way of extending Infinispan by being able to influence or respond to any modifications to cache. Example of such modifications are: elements are added/removed/updated or transactions are committed. For a detailed list refer to <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/interceptors/base/CommandInterceptor.html">CommandInterceptor</a> API.</p> </div> <div class="sect2"> <h3 id="adding_custom_interceptors_declaratively"><a class="anchor" href="#adding_custom_interceptors_declaratively"></a>21.1. Adding custom interceptors declaratively</h3> <div class="paragraph"> <p>Custom interceptors can be added on a per named cache basis. This is because each named cache have its own interceptor stack. Following xml snippet depicts the ways in which a custom interceptor can be added.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml">Â Â  <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cacheWithCustomInterceptors</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â Â Â Â  <span class="comment">&lt;!--
Â Â Â Â Â  Define custom interceptors.Â  All custom interceptors need to extend org.jboss.cache.interceptors.base.CommandInterceptor
Â Â Â Â Â  --&gt;</span>
Â Â Â Â Â  <span class="tag">&lt;custom-interceptors&gt;</span>
Â Â Â Â Â Â Â Â  <span class="tag">&lt;interceptor</span> <span class="attribute-name">position</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FIRST</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">attributeOne</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>value1<span class="tag">&lt;/property&gt;</span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">attributeTwo</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>value2<span class="tag">&lt;/property&gt;</span>
Â Â Â Â Â Â Â Â  <span class="tag">&lt;/interceptor&gt;</span>
Â Â Â Â Â Â Â Â  <span class="tag">&lt;interceptor</span> <span class="attribute-name">position</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LAST</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
Â Â Â Â Â Â Â Â  <span class="tag">&lt;interceptor</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
Â Â Â Â Â Â Â Â  <span class="tag">&lt;interceptor</span> <span class="attribute-name">before</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispanpan.interceptors.CallInterceptor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
Â Â Â Â Â Â Â Â  <span class="tag">&lt;interceptor</span> <span class="attribute-name">after</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispanpan.interceptors.CallInterceptor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
Â Â Â Â Â  <span class="tag">&lt;/custom-interceptors&gt;</span>
Â Â  <span class="tag">&lt;/local-cache&gt;</span></code></pre> </div> </div> </div> <div class="sect2"> <h3 id="adding_custom_interceptors_programatically"><a class="anchor" href="#adding_custom_interceptors_programatically"></a>21.2. Adding custom interceptors programatically</h3> <div class="paragraph"> <p>In order to do that one needs to obtain a reference to the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/AdvancedCache.html">AdvancedCache</a> . This can be done ass follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">CacheManager cm = getCacheManager();<span class="comment">//magic</span>
Cache aCache = cm.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">aName</span><span class="delimiter">&quot;</span></span>);
AdvancedCache advCache = aCache.getAdvancedCache();</code></pre> </div> </div> <div class="paragraph"> <p>Then one of the <em>addInterceptor()</em> methods should be used to add the actual interceptor. For further documentation refer to <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/AdvancedCache.html">AdvancedCache</a> javadoc.</p> </div> </div> <div class="sect2"> <h3 id="custom_interceptor_design"><a class="anchor" href="#custom_interceptor_design"></a>21.3. Custom interceptor design</h3> <div class="paragraph"> <p>When writing a custom interceptor, you need to abide by the following rules.</p> </div> <div class="ulist"> <ul> <li> <p>Custom interceptors must extend <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/interceptors/base/BaseCustomInterceptor.html">BaseCustomInterceptor</a></p> </li> <li> <p>Custom interceptors must declare a public, empty constructor to enable construction.</p> </li> <li> <p>Custom interceptors will have setters for any property defined through property tags used in the XML configuration.</p> </li> </ul> </div> </div> </div> </div> <div class="sect1"> <h2 id="running_infinispan_on_amazon_web_services"><a class="anchor" href="#running_infinispan_on_amazon_web_services"></a>22. Running Infinispan on Amazon Web Services</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan can be used on the Amazon Web Service (AWS) platform and similar cloud based environment in several ways. As Infinispan uses JGroups as the underlying communication technology, the majority of the configuration work is done JGroups. The default auto discovery won&#8217;t work on EC2 as multicast is not allowed, but JGroups provides several other discovery protocols so we only have to choose one.</p> </div> <div class="sect2"> <h3 id="tcpping_gossiprouter_s3_ping"><a class="anchor" href="#tcpping_gossiprouter_s3_ping"></a>22.1. TCPPing, GossipRouter, S3_PING</h3> <div class="paragraph"> <p>The TCPPing approach contains a static list of the IP address of each member of the cluster in the JGroups configuration file. While this works it doesn&#8217;t really help when cluster nodes are dynamically added to the cluster.</p> </div> <div class="listingblock"> <div class="title">Sample TCPPing configuration</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;config&gt;</span>
Â Â Â Â Â  <span class="tag">&lt;TCP</span> <span class="attribute-name">bind_port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">7800</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
Â Â Â Â Â  <span class="tag">&lt;TCPPING</span> <span class="attribute-name">timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3000</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">initial_hosts</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jgroups.tcpping.initial_hosts:localhost[7800],localhost[7801]}</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">port_range</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">num_initial_members</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
...
...
<span class="tag">&lt;/config&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>See <a href="http://community.jboss.org/wiki/JGroupsTCPPING" class="bare">http://community.jboss.org/wiki/JGroupsTCPPING</a> for more information about TCPPing.</p> </div> </div> <div class="sect2"> <h3 id="gossiprouter"><a class="anchor" href="#gossiprouter"></a>22.2. GossipRouter</h3> <div class="paragraph"> <p>Another approach is to have a central server (Gossip, which each node will be configured to contact. This central server will tell each node in the cluster about each other node.</p> </div> <div class="paragraph"> <p>The address (ip:port) that the Gossip router is listening on can be injected into the JGroups configuration used by Infinispan. To do this pass the gossip routers address as a system property to the JVM e.g. <code>-DGossipRouterAddress="10.10.2.4[12001]"</code> and reference this property in the JGroups configuration that Infinispan is using e.g.</p> </div> <div class="listingblock"> <div class="title">Sample TCPGOSSIP configuration</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;config&gt;</span>
Â Â Â  <span class="tag">&lt;TCP</span> <span class="attribute-name">bind_port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">7800</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
Â Â Â  <span class="tag">&lt;TCPGOSSIP</span> <span class="attribute-name">timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">initial_hosts</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${GossipRouterAddress}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">num_initial_members</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
...
...
<span class="tag">&lt;/config&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>More on Gossip Router @ <a href="http://community.jboss.org/docs/DOC-10890"><a href="http://www.jboss.org/community/wiki/JGroupsGossipRouter" class="bare">http://www.jboss.org/community/wiki/JGroupsGossipRouter</a></a></p> </div> </div> <div class="sect2"> <h3 id="s3_ping"><a class="anchor" href="#s3_ping"></a>22.3. S3_PING</h3> <div class="paragraph"> <p>Finally you can configure your JGroups instances to use a shared storage to exchange the details of the cluster nodes. S3_PING was added to JGroups in 2.6.12 and 2.8, and allows the Amazon S3 to be used as the shared storage. It is experimental at the moment but offers another method of clustering without a central server. Be sure that you have signed up for Amazon S3 as well as EC2 to use this method.</p> </div> <div class="listingblock"> <div class="title">Sample S3PING configuration</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;config&gt;</span>
    <span class="tag">&lt;TCP</span> <span class="attribute-name">bind_port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">7800</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;S3_PING</span>
            <span class="attribute-name">secret_access_key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replace this with you secret access key</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">access_key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replace this with your access key</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replace this with your S3 bucket location</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/config&gt;</span></code></pre> </div> </div> </div> <div class="sect2"> <h3 id="jdbc_ping"><a class="anchor" href="#jdbc_ping"></a>22.4. JDBC_PING</h3> <div class="paragraph"> <p>A similar approach to S3_PING, but using a JDBC connection to a shared database. On EC2 that is quite easy using Amazon RDS. See the <a href="http://community.jboss.org/wiki/JDBCPING">JDBC_PING Wiki page</a> for details.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="default_values_for_property_based_attributes"><a class="anchor" href="#default_values_for_property_based_attributes"></a>23. Default Values For Property Based Attributes</h2> <div class="sectionbody"> <div class="paragraph"> <p>The aim of this article is to complement the <a href="http://docs.jboss.org/infinispan/5.1/configdocs">configuration reference</a> documentation with information on default values that could not be automatically generated. Please find below the name of the XML elements and their corresponding property default values:</p> </div> <div class="ulist"> <div class="title">asyncListenerExecutor</div> <ul> <li> <p>maxThreads = 1</p> </li> <li> <p>threadNamePrefix = "notification-thread"</p> </li> </ul> </div> <div class="ulist"> <div class="title">asyncTransportExecutor</div> <ul> <li> <p>maxThreads = 25</p> </li> <li> <p>threadNamePrefix = "transport-thread"</p> </li> </ul> </div> <div class="ulist"> <div class="title">evictionScheduledExecutor</div> <ul> <li> <p>maxThreads = 1 (cannot be changed)</p> </li> <li> <p>threadNamePrefix = "eviction-thread"</p> </li> </ul> </div> <div class="ulist"> <div class="title">replicationQueueScheduledExecutor</div> <ul> <li> <p>maxThreads = 1 (cannot be changed)</p> </li> <li> <p>threadNamePrefix = "replicationQueue-thread"</p> </li> </ul> </div> </div> </div> <div class="sect1"> <h2 id="_CLI_chapter"><a class="anchor" href="#_CLI_chapter"></a>24. Command-Line Interface (CLI)</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan offers a simple Command-Line Interface (CLI) with which it is possible to interact with the data within the caches and with most of the internal components (e.g. transactions, cross-site backups, rolling upgrades).</p> </div> <div class="paragraph"> <p>The CLI is built out of two elements: a server-side module and the client command tool. The server-side module (<code>infinispan-cli-server-$VERSION.jar</code>) provides the actual interpreter for the commands and needs to be included alongside your application. Infinispan Server includes CLI support out of the box.</p> </div> <div class="paragraph"> <p>Currently the server (and the client) use the JMX protocol to communicate, but in a future release we plan to support other communication protocols (in particular our own Hot Rod).</p> </div> <div class="paragraph"> <p>The CLI offers both an interactive and a batch mode. To invoke the client, just run the provided <em>bin/ispn-cli.[sh|bat]</em> script. The following is a list of command-line switches which affect how the CLI can be started:</p> </div> <div class="listingblock"> <div class="content"> <pre>-c, --connect=URLÂ Â Â Â Â Â  connects to a running instance of Infinispan.
 Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  JMX over RMI jmx://[username[:password]]@host:port[/container[/cache]]
                        JMX over JBoss remoting remoting://[username[:password]]@host:port[/container[/cache]]
-f, --file=FILEÂ Â Â Â Â Â Â Â  reads input from the specified file instead of using Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
                        interactive mode. If FILE is '-', then commands will be read
                        from stdin
-h, --helpÂ Â Â Â Â Â Â Â Â Â Â Â Â  shows this help pageÂ 
-v, --versionÂ Â Â Â Â Â Â Â Â Â  shows version information</pre> </div> </div> <div class="ulist"> <ul> <li> <p>JMX over RMI is the traditional way in which JMX clients connect to MBeanServers. Please refer to the <a href="http://docs.oracle.com/javase/6/docs/technotes/guides/management/agent.html">JDK Monitoring and Management</a> documentation for details on how to configure the process to be monitored</p> </li> <li> <p>JMX over JBoss Remoting is the protocol of choice when your Infinispan application is running within JBoss AS7 or EAP6.</p> </li> </ul> </div> <div class="paragraph"> <p>The connection to the application can also be initiated from within the CLI using the connect command.</p> </div> <div class="listingblock"> <div class="content"> <pre>[disconnected//]&gt; connect jmx://localhost:12000
[jmx://localhost:12000/MyCacheManager/&gt;</pre> </div> </div> <div class="paragraph"> <p>The CLI prompt will show the active connection information, including the currently selected CacheManager. Initially no cache is selected so, before performing any cache operations, one must be selected. For this the <em>cache</em> command is used. The CLI supports tab-completion for all commands and options and for most parameters where it makes sense to do so. Therefore typing <em>cache</em> and pressing TAB will show a list of active caches:</p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/&gt; cache
___defaultcacheÂ  namedCache
[jmx://localhost:12000/MyCacheManager/]&gt; cache ___defaultcache
[jmx://localhost:12000/MyCacheManager/___defaultcache]&gt;</pre> </div> </div> <div class="paragraph"> <p>Pressing TAB at an empty prompt will show the list of all available commands:</p> </div> <div class="listingblock"> <div class="content"> <pre>aliasÂ Â Â Â Â Â  cacheÂ Â Â Â Â Â  containerÂ Â  encodingÂ Â Â  getÂ Â Â Â Â Â Â Â  locateÂ Â Â Â Â  removeÂ Â Â Â Â  siteÂ Â Â Â Â Â Â  upgradeÂ Â Â  Â 
abortÂ Â Â Â Â Â  clearcacheÂ  createÂ Â Â Â Â  endÂ Â Â Â Â Â Â Â  helpÂ Â Â Â Â Â Â  putÂ Â Â Â Â Â Â Â  replaceÂ Â Â Â  startÂ Â Â Â Â Â  versionÂ Â Â  Â 
beginÂ Â Â Â Â Â  commitÂ Â Â Â Â  disconnectÂ  evictÂ Â Â Â Â Â  infoÂ Â Â Â Â Â Â  quitÂ Â Â Â Â Â Â  rollbackÂ Â Â  statsÂ Â Â Â Â </pre> </div> </div> <div class="paragraph"> <p>The CLI is based on <a href="https://github.com/aeshell/aesh">Ãsh</a> and therefore offers many keyboard shortcuts to navigate and search the history of commands, to manipulate the cursor at the prompt, including both Emacs and VI modes of operation.</p> </div> <div class="sect2"> <h3 id="commands"><a class="anchor" href="#commands"></a>24.1. Commands</h3> <div class="sect3"> <h4 id="abort"><a class="anchor" href="#abort"></a>24.1.1. abort</h4> <div class="paragraph"> <p>The <em>abort</em> command is used to abort a running batch initiated by the <em>start</em> command</p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; start
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; abort
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; get a
null</pre> </div> </div> </div> <div class="sect3"> <h4 id="begin"><a class="anchor" href="#begin"></a>24.1.2. begin</h4> <div class="paragraph"> <p>The <em>begin</em> command starts a transaction. In order for this command to work, the cache(s) on which the subsequent operations are invoked must have transactions enabled.</p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; begin
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put b b
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; commit</pre> </div> </div> </div> <div class="sect3"> <h4 id="cache"><a class="anchor" href="#cache"></a>24.1.3. cache</h4> <div class="paragraph"> <p>The <em>cache</em> command selects the cache to use as default for all subsequent operations. If it is invoked without parameters it shows the currently selected cache.</p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; cache ___defaultcache
[jmx://localhost:12000/MyCacheManager/___defaultcache]&gt; cache
___defaultcache
[jmx://localhost:12000/MyCacheManager/___defaultcache]&gt;</pre> </div> </div> </div> <div class="sect3"> <h4 id="clearcache"><a class="anchor" href="#clearcache"></a>24.1.4. clearcache</h4> <div class="paragraph"> <p>The <em>clearcache</em> command clears a cache from all content.</p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; clearcache
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; get a
null</pre> </div> </div> </div> <div class="sect3"> <h4 id="commit"><a class="anchor" href="#commit"></a>24.1.5. commit</h4> <div class="paragraph"> <p>The <em>commit</em> command commits an ongoing transaction</p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; begin
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put b b
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; commit</pre> </div> </div> </div> <div class="sect3"> <h4 id="container"><a class="anchor" href="#container"></a>24.1.6. container</h4> <div class="paragraph"> <p>The <em>container</em> command selects the default container (cache manager). Invoked without parameters it lists all available containers</p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; container
MyCacheManager OtherCacheManager
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; container OtherCacheManager
[jmx://localhost:12000/OtherCacheManager/]&gt;</pre> </div> </div> </div> <div class="sect3"> <h4 id="create"><a class="anchor" href="#create"></a>24.1.7. create</h4> <div class="paragraph"> <p>The <em>create</em> command creates a new cache based on the configuration of an existing cache definition</p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; create newCache like namedCache
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; cache newCache
[jmx://localhost:12000/MyCacheManager/newCache]&gt;</pre> </div> </div> </div> <div class="sect3"> <h4 id="deny"><a class="anchor" href="#deny"></a>24.1.8. deny</h4> <div class="paragraph"> <p>When authorization is enabled and the role mapper has been configured to be the ClusterRoleMapper, principal to role mappings are stored within the cluster registry (a replicated cache available to all nodes). The <em>deny</em> command can be used to deny roles previously assigned to a principal:</p> </div> <div class="listingblock"> <div class="content"> <pre>[remoting://localhost:9999]&gt; deny supervisor to user1</pre> </div> </div> </div> <div class="sect3"> <h4 id="disconnect"><a class="anchor" href="#disconnect"></a>24.1.9. disconnect</h4> <div class="paragraph"> <p>The <em>disconnect</em> command disconnects the currently active connection allowing the CLI to connect to another instance.</p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; disconnect
[disconnected//]</pre> </div> </div> </div> <div class="sect3"> <h4 id="encoding"><a class="anchor" href="#encoding"></a>24.1.10. encoding</h4> <div class="paragraph"> <p>The <em>encoding</em> command is used to set a default codec to use when reading/writing entries from/to a cache. When invoked without arguments it shows the currently selected codec. This command is useful since currently remote protocols such as HotRod and Memcached wrap keys and values in specialized structures.</p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; encoding
none
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; encoding --list
memcached
hotrod
none
rest
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; encoding hotrod</pre> </div> </div> </div> <div class="sect3"> <h4 id="end"><a class="anchor" href="#end"></a>24.1.11. end</h4> <div class="paragraph"> <p>The <em>end</em> command is used to successfully end a running batch initiated by the <em>start</em> command</p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; start
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; end
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; get a
a</pre> </div> </div> </div> <div class="sect3"> <h4 id="evict"><a class="anchor" href="#evict"></a>24.1.12. evict</h4> <div class="paragraph"> <p>The <em>evict</em> command is used to evict from the cache the entry associated with a specific key.</p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; evict a</pre> </div> </div> </div> <div class="sect3"> <h4 id="get"><a class="anchor" href="#get"></a>24.1.13. get</h4> <div class="paragraph"> <p>The <em>get</em> command is used to show the value associated to a specified key. For primitive types and Strings, the <em>get</em> command will simply print the default representation. For other objects, a JSON representation of the object will be printed.</p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; get a
a</pre> </div> </div> </div> <div class="sect3"> <h4 id="grant"><a class="anchor" href="#grant"></a>24.1.14. grant</h4> <div class="paragraph"> <p>When authorization is enabled and the role mapper has been configured to be the ClusterRoleMapper, principal to role mappings are stored within the cluster registry (a replicated cache available to all nodes). The <em>grant</em> command can be used to grant new roles to a principal:</p> </div> <div class="listingblock"> <div class="content"> <pre>[remoting://localhost:9999]&gt; grant supervisor to user1</pre> </div> </div> </div> <div class="sect3"> <h4 id="info"><a class="anchor" href="#info"></a>24.1.15. info</h4> <div class="paragraph"> <p>The <em>info</em> command is used to show the configuration of the currently selected cache or container.</p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; info
GlobalConfiguration{asyncListenerExecutor=ExecutorFactoryConfiguration{factory=org.infinispan.executors.DefaultExecutorFactory@98add58}, asyncTransportExecutor=ExecutorFactoryConfiguration{factory=org.infinispan.executors.DefaultExecutorFactory@7bc9c14c}, evictionScheduledExecutor=ScheduledExecutorFactoryConfiguration{factory=org.infinispan.executors.DefaultScheduledExecutorFactory@7ab1a411}, replicationQueueScheduledExecutor=ScheduledExecutorFactoryConfiguration{factory=org.infinispan.executors.DefaultScheduledExecutorFactory@248a9705}, globalJmxStatistics=GlobalJmxStatisticsConfiguration{allowDuplicateDomains=true, enabled=true, jmxDomain='jboss.infinispan', mBeanServerLookup=org.jboss.as.clustering.infinispan.MBeanServerProvider@6c0dc01, cacheManagerName='local', properties={}}, transport=TransportConfiguration{clusterName='ISPN', machineId='null', rackId='null', siteId='null', strictPeerToPeer=false, distributedSyncTimeout=240000, transport=null, nodeName='null', properties={}}, serialization=SerializationConfiguration{advancedExternalizers={1100=org.infinispan.server.core.CacheValue$Externalizer@5fabc91d, 1101=org.infinispan.server.memcached.MemcachedValue$Externalizer@720bffd, 1104=org.infinispan.server.hotrod.ServerAddress$Externalizer@771c7eb2}, marshaller=org.infinispan.marshall.VersionAwareMarshaller@6fc21535, version=52, classResolver=org.jboss.marshalling.ModularClassResolver@2efe83e5}, shutdown=ShutdownConfiguration{hookBehavior=DONT_REGISTER}, modules={}, site=SiteConfiguration{localSite='null'}}</pre> </div> </div> </div> <div class="sect3"> <h4 id="locate"><a class="anchor" href="#locate"></a>24.1.16. locate</h4> <div class="paragraph"> <p>The <em>locate</em> command shows the physical location of a specified entry in a distributed cluster.</p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; locate a
[host/node1,host/node2]</pre> </div> </div> </div> <div class="sect3"> <h4 id="put"><a class="anchor" href="#put"></a>24.1.17. put</h4> <div class="paragraph"> <p>The <em>put</em> command inserts an entry in the cache. If the cache previously contained a mapping for the key, the old value is replaced by the specified value. The user can control the type of data that the CLI will use to store the key and value. See the <a href="#_data_types">Data Types</a> section.</p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put b 100
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put c 4139l
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put d true
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put e { "package.MyClass": {"i": 5, "x": null, "b": true } }</pre> </div> </div> <div class="paragraph"> <p>The put command can optionally specify a lifespan and a maximum idle time.</p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a expires 10s
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a expires 10m maxidle 1m</pre> </div> </div> </div> <div class="sect3"> <h4 id="replace"><a class="anchor" href="#replace"></a>24.1.18. replace</h4> <div class="paragraph"> <p>The <em>replace</em> command replaces an existing entry in the cache. If an old value is specified, then the replacement happens only if the value in the cache coincides.</p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; replace a b
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; get a
b
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; replace a b c
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; get a
c
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; replace a b d
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; get a
c</pre> </div> </div> </div> <div class="sect3"> <h4 id="roles"><a class="anchor" href="#roles"></a>24.1.19. roles</h4> <div class="paragraph"> <p>When authorization is enabled and the role mapper has been configured to be the ClusterRoleMapper, principal to role mappings are stored within the cluster registry (a replicated cache available to all nodes). The <em>roles</em> command can be used to list the roles associated to a specific user, or to all users if one is not given:</p> </div> <div class="listingblock"> <div class="content"> <pre>[remoting://localhost:9999]&gt; roles user1
[supervisor, reader]</pre> </div> </div> </div> <div class="sect3"> <h4 id="rollback"><a class="anchor" href="#rollback"></a>24.1.20. rollback</h4> <div class="paragraph"> <p>The <em>rollback</em> command rolls back an ongoing transaction</p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; begin
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put b b
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; rollback</pre> </div> </div> </div> <div class="sect3"> <h4 id="site"><a class="anchor" href="#site"></a>24.1.21. site</h4> <div class="paragraph"> <p>The <em>site</em> command performs operations related to the administration of cross-site replication. It can be used to obtain information related to the status of a site and to change the status (online/offline)</p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; site --status NYC
online
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; site --offline NYC
ok
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; site --status NYC
offline
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; site --online NYC</pre> </div> </div> </div> <div class="sect3"> <h4 id="start"><a class="anchor" href="#start"></a>24.1.22. start</h4> <div class="paragraph"> <p>The <em>start</em> command initiates a batch of operations.</p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; start
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put b b
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; end</pre> </div> </div> </div> <div class="sect3"> <h4 id="stats"><a class="anchor" href="#stats"></a>24.1.23. stats</h4> <div class="paragraph"> <p>The <em>stats</em> command displays statistics about a cache</p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; stats
Statistics: {
  averageWriteTime: 143
  evictions: 10
  misses: 5
  hitRatio: 1.0
  readWriteRatio: 10.0
  removeMisses: 0
  timeSinceReset: 2123
  statisticsEnabled: true
  stores: 100
  elapsedTime: 93
  averageReadTime: 14
  removeHits: 0
  numberOfEntries: 100
  hits: 1000
}
LockManager: {
  concurrencyLevel: 1000
  numberOfLocksAvailable: 0
  numberOfLocksHeld: 0
}</pre> </div> </div> </div> <div class="sect3"> <h4 id="upgrade"><a class="anchor" href="#upgrade"></a>24.1.24. upgrade</h4> <div class="paragraph"> <p>The <em>upgrade</em> command performs operations used during the rolling upgrade procedure. For a detailed description of this procedure please see <a href="#_rolling_upgrades">Rolling Upgrades</a></p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; upgrade --synchronize=hotrod --all
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; upgrade --disconnectsource=hotrod --all</pre> </div> </div> </div> <div class="sect3"> <h4 id="version"><a class="anchor" href="#version"></a>24.1.25. version</h4> <div class="paragraph"> <p>The <em>version</em> command displays version information about both the CLI client and the server</p> </div> <div class="listingblock"> <div class="content"> <pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; version
Client Version 5.2.1.Final
Server Version 5.2.1.Final</pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="data_types"><a class="anchor" href="#data_types"></a>24.2. Data Types</h3> <div class="paragraph"> <p>The CLI understands the following types:</p> </div> <div class="ulist"> <ul> <li> <p>string strings can either be quoted between single (') or double (") quotes, or left unquoted. In this case it must not contain spaces, punctuation and cannot begin with a number e.g. 'a string', key001</p> </li> <li> <p>int an integer is identified by a sequence of decimal digits, e.g. 256</p> </li> <li> <p>long a long is identified by a sequence of decimal digits suffixed by 'l', e.g. 1000l</p> </li> <li> <p>double</p> <div class="ulist"> <ul> <li> <p>a double precision number is identified by a floating point number(with optional exponent part) and an optional 'd' suffix, e.g.3.14</p> </li> </ul> </div> </li> <li> <p>float</p> <div class="ulist"> <ul> <li> <p>a single precision number is identified by a floating point number(with optional exponent part) and an 'f' suffix, e.g. 10.3f</p> </li> </ul> </div> </li> <li> <p>boolean a boolean is represented either by the keywords true and false</p> </li> <li> <p>UUID a UUID is represented by its canonical form XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</p> </li> <li> <p>JSON serialized Java classes can be represented using JSON notation, e.g. {"package.MyClass":{"i":5,"x":null,"b":true}}. Please note that the specified class must be available to the CacheManager&#8217;s class loader.</p> </li> </ul> </div> </div> <div class="sect2"> <h3 id="time_values"><a class="anchor" href="#time_values"></a>24.3. Time Values</h3> <div class="paragraph"> <p>A time value is an integer number followed by time unit suffix: days (d), hours (h), minutes (m), seconds (s), milliseconds (ms).</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="infinispan_for_http_session_clustering_and_caching"><a class="anchor" href="#infinispan_for_http_session_clustering_and_caching"></a>25. Infinispan for HTTP session clustering and caching</h2> <div class="sectionbody"> <div class="paragraph"> <p>One popular use case for data grids is to cache and cluster HTTP sessions in servlet containers. This provides servlet containers and Java EE application servers with the following features:</p> </div> <div class="ulist"> <ul> <li> <p>Fast access to HTTP sessions, as they&#8217;re cached in memory</p> </li> <li> <p>Distribution of HTTP sessions across a cluster. Allows for failover and high availability between servlet container or app server nodes.</p> </li> </ul> </div> <div class="sect2"> <h3 id="jboss_as_and_wildfly"><a class="anchor" href="#jboss_as_and_wildfly"></a>25.1. JBoss AS and WildFly</h3> <div class="paragraph"> <p><a href="http://www.jboss.org/jbossas">JBoss AS</a> and <a href="http://www.wildfly.org">WildFly</a> already use Infinispan for HTTP session caching and clustering.</p> </div> </div> <div class="sect2"> <h3 id="jetty"><a class="anchor" href="#jetty"></a>25.2. Jetty</h3> <div class="paragraph"> <p><a href="http://www.eclipse.org/jetty">Jetty</a> can be set up to use Infinispan for HTTP session management, using <a href="https://code.google.com/p/infinispan-http-session-manager/wiki/Home">this adapter</a> .</p> </div> </div> <div class="sect2"> <h3 id="other_application_servers_and_servlet_containers"><a class="anchor" href="#other_application_servers_and_servlet_containers"></a>25.3. Other application servers and servlet containers</h3> <div class="paragraph"> <p>Creating plugins for other servlet containers and app servers should be easy enough, following the pattern used by JBossAS/WildFly/Jetty above. Please see the open tasks below, contributions accepted!</p> </div> <div class="ulist"> <ul> <li> <p><a href="https://issues.jboss.org/browse/ISPN-462">ISPN-462 HTTP and EJB session management for WebSphere</a></p> </li> <li> <p><a href="https://issues.jboss.org/browse/ISPN-463">ISPN-463 HTTP and EJB session management for WebLogic</a></p> </li> <li> <p><a href="https://issues.jboss.org/browse/ISPN-464">ISPN-464 HTTP and EJB session management for Glassfish</a></p> </li> <li> <p><a href="https://issues.jboss.org/browse/ISPN-465">ISPN-465 HTTP session management for Tomcat</a></p> </li> </ul> </div> </div> </div> </div> <div class="sect1"> <h2 id="integration_with_other_frameworks"><a class="anchor" href="#integration_with_other_frameworks"></a>26. Integration with other frameworks</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan can be integrated with a number of other frameworks, as detailed below.</p> </div> <div class="sect2"> <h3 id="using_infinispan_as_jpa_hibernate_second_level_cache_provider"><a class="anchor" href="#using_infinispan_as_jpa_hibernate_second_level_cache_provider"></a>26.1. Using Infinispan as JPA-Hibernate Second Level Cache Provider</h3> <div class="paragraph"> <p>Following some of the principles set out by Brian Stansberry in <a href="http://community.jboss.org/docs/14247">Using JBoss Cache 3 as a Hibernate 3.5 Second Level Cache</a> and taking in account improvements introduced by Infinispan, an Infinispan JPA/Hibernate second level cache provider has been developed. This wiki explains how to configure JPA/Hibernate to use the Infinispan and for those keen on lower level details, the key design decisions made and differences with previous JBoss Cache based cache providers.</p> </div> <div class="paragraph"> <p>If you&#8217;re unfamiliar with JPA/Hibernate Second Level Caching, I&#8217;d suggest you to read Chapter 2.1 in <a href="http://www.jboss.org/jbossclustering/docs/hibernate-jbosscache-guide-3.pdf">this guide</a> which explains the different types of data that can be cached.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="title">On Caching</div> Query result caching, or entity caching, <em>may or may not improve</em> application performance. Be sure to benchmark your application with and without caching. </td> </tr> </table> </div> <div class="sect3"> <h4 id="configuration_14"><a class="anchor" href="#configuration_14"></a>26.1.1. Configuration</h4> <div class="paragraph"> <p>1. First of all, to enable JPA/Hibernate second level cache with query result caching enabled, add either of the following:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.use_second_level_cache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.use_query_cache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.use_second_level_cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>true<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.use_query_cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>true<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>2. Now, configure the Infinispan cache region factory using one of the two options below:</p> </div> <div class="ulist"> <ul> <li> <p>If the Infinispan CacheManager instance happens to be bound to JNDI select JndiInfinispanRegionFactory as the cacheregion factory and add the cache manager&#8217;s JNDI name:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.region.factory_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.cache.infinispan.JndiInfinispanRegionFactory</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.cachemanager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java:CacheManager</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.region.factory_class</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>org.hibernate.cache.infinispan.JndiInfinispanRegionFactory<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.cachemanager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>java:CacheManager/entity<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="title">JBoss Application Server</div> JBoss Application Server 6 and 7 deploy a shared Infinispan cache manager that can be used by all services, so when trying to configure applications with Infinispan second level cache, you should use the JNDI name for the cache manager responsible for the second level cache. By default, this is "java:CacheManager/entity". In any other application server, you can deploy your own cache manager and bind the CacheManager to JNDI, but in this cases it&#8217;s generally preferred that the following method is used. </td> </tr> </table> </div> <div class="ulist"> <ul> <li> <p>If running JPA/Hibernate and Infinispan standalone or within third party Application Server, select the <em>InfinispanRegionFactory</em> as the cache region factory:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.region.factory_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.cache.infinispan.InfinispanRegionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.region.factory_class</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>org.hibernate.cache.infinispan.InfinispanRegionFactory<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>This is all the configuration you need to have JPA/Hibernate use Infinispan as cache provider with the default settings. You will still need to define which entities and queries need to be cached as defined in the Hibernate reference documentation, but that configuration aspect is not peculiar to Infinispan. This default configuration should suit the majority of use cases but sometimes, further configuration is required and to help with such situations, please check the following section where more advanced settings are discussed.</p> </div> </div> <div class="sect3"> <h4 id="default_configuration_explained"><a class="anchor" href="#default_configuration_explained"></a>26.1.2. Default Configuration Explained</h4> <div class="paragraph"> <p>The aim of this section is to explain the default settings for each of the different global data type (entity, collection, query and timestamps) caches, why these were chosen and what are the available alternatives.</p> </div> <div class="sect4"> <h5 id="defaults_for_entity_collection_caching"><a class="anchor" href="#defaults_for_entity_collection_caching"></a>Defaults for Entity/Collection Caching</h5> <div class="ulist"> <ul> <li> <p>For all entities and collections, whenever a new <em>entity or collection is read from database</em> and needs to be cached, <em>it&#8217;s only cached locally</em> in order to reduce intra-cluster traffic. This option cannot be changed.</p> </li> <li> <p>All <em>entities and collections are configured to use a synchronous invalidation</em> as clustering mode. This means that when an entity is updated, the updated cache will send a message to the other members of the cluster telling them that the entity has been modified. Upon receipt of this message, the other nodes will remove this data from their local cache, if it was stored there. This option can be changed to use replication by configuring entities or collections to use "replicated-entity" cache but it&#8217;s generally not a recommended choice.</p> </li> <li> <p>All <em>entities and collections have initial state transfer disabled</em> since there&#8217;s no need for it. It&#8217;s not recommended that this is enabled.</p> </li> <li> <p><em>entities and collections are configured to use READ_COMMITTED</em> as cache isolation level. It would only make sure to configure REPEATABLE_READ if the application evicts/clears entities from the Hibernate Session and then expects to repeatably re-read them in the same transaction. Otherwise, the Session&#8217;s internal cache provides repeatable-read semantics. If you really need to use REPEATABLE_READ, you can simply configure entities or collections to use "entity-repeatable" cache.</p> </li> <li> <p>Entities and collections are configured with the following eviction settings. You can change these settings on a per entity or collection basis or per individual entity or collection type. More information in the "Advanced Configuration" section below.</p> <div class="ulist"> <ul> <li> <p>Eviction wake up interval is 5 seconds.</p> </li> <li> <p>Max number of entries are 10,000</p> </li> <li> <p>Max idle time before expiration is 100 seconds</p> </li> </ul> </div> </li> <li> <p><em>entites and collections are configured with lazy deserialization</em> which helps deserialization when entities or collections are stored in isolated deployments. If you&#8217;re sure you&#8217;ll never deploy your entities or collections in classloader isolated deployment archives, you can disable this setting.</p> </li> </ul> </div> </div> <div class="sect4"> <h5 id="defaults_for_query_caching"><a class="anchor" href="#defaults_for_query_caching"></a>Defaults for Query Caching</h5> <div class="ulist"> <ul> <li> <p>The query cache is configured so that <em>queries are only cached locally</em> . Alternatively, you can configure query caching to use replication by selecting the "replicated-query" as query cache name. However, replication for query cache only makes sense if, and only if, all of this conditions are true:</p> <div class="ulist"> <ul> <li> <p>Performing the query is quite expensive.</p> </li> <li> <p>The same query is very likely to be repeatedly executed on different cluster nodes.</p> </li> <li> <p>The query is unlikely to be invalidated out of the cache (Note: Hibernate must aggressively invalidate query results from the cache any time any instance of one of the entity types targeted by the query. All such query results are invalidated, even if the change made to the specific entity instance would not have affected the query result)</p> </li> </ul> </div> </li> <li> <p><em>query cache</em> uses the <em>same cache isolation levels and eviction/expiration settings as for entities/collections</em> .</p> </li> <li> <p><em>query cache has initial state transfer disabled</em> . It is not recommended that this is enabled.</p> </li> </ul> </div> </div> <div class="sect4"> <h5 id="defaults_for_timestamps_cache"><a class="anchor" href="#defaults_for_timestamps_cache"></a>Defaults for Timestamps Cache</h5> <div class="ulist"> <ul> <li> <p>The <em>timestamps cache is configured with asynchronous replication</em> as clustering mode. Local or invalidated cluster modes are not allowed, since all cluster nodes must store all timestamps. As a result, <em>no eviction/expiration is allowed for timestamp caches either</em> .</p> </li> <li> <p>The <em>timestamps cache is configured with a cluster cache loader (in Hibernate 3.6.0 or earlier it had state transfer enabled)</em> so that joining nodes can retrieve all timestamps. You shouldn&#8217;t attempt to disable the cluster cache loader for the timestamps cache.</p> </li> </ul> </div> </div> </div> <div class="sect3"> <h4 id="jta_transactions_configuration"><a class="anchor" href="#jta_transactions_configuration"></a>26.1.3. JTA Transactions Configuration</h4> <div class="paragraph"> <p>It is highly recommended that Hibernate is configured with JTA transactions so that both Hibernate and Infinispan cooperate within the same transaction and the interaction works as expected.</p> </div> <div class="paragraph"> <p>Otherwise, if Hibernate is configured for example with JDBC transactions, Hibernate will create a Transaction instance via java.sql.Connection and Infinispan will create a transaction via whatever TransactionManager returned by hibernate.transaction.manager_lookup_class. If hibernate.transaction.manager_lookup_class has not been populated, it will default on the dummy transaction manager. So, any work on the 2nd level cache will be done under a different transaction to the one used to commit the stuff to the database via Hibernate. In other words, your operations on the database and the 2LC are not treated as a single unit. Risks here include failures to update the 2LC leaving it with stale data while the database committed data correctly. It has also been observed that under some circumstances where JTA was not used, commit/rollbacks are not propagated to Infinispan.</p> </div> <div class="paragraph"> <p>To sum up, if you configure Hibernate with Infinispan, apply the following changes to your configuration file:</p> </div> <div class="paragraph"> <p>1. Unless your application uses JPA, you need to select the correct Hibernate transaction factory via the property <em>hibernate.transaction.factory_class</em> :</p> </div> <div class="ulist"> <ul> <li> <p>If you&#8217;re running within an application server, it&#8217;s recommended that you use:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.factory_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.transaction.CMTTransactionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.factory_class</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>org.hibernate.transaction.CMTTransactionFactory<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> <div class="ulist"> <ul> <li> <p>If you&#8217;re running in a standalone environment and you wanna enable JTA transaction factory, use:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.factory_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.transaction.JTATransactionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.factory_class</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>org.hibernate.transaction.JTATransactionFactory<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The reason why JPA does not require a transaction factory class to be set up is because the entity manager already sets it to a variant of CMTTransactionFactory.</p> </div> <div class="paragraph"> <p>2. Select the correct Hibernate transaction manager lookup:</p> </div> <div class="ulist"> <ul> <li> <p>If you&#8217;re running within an application server, select the appropriate lookup class according to <a href="http://docs.jboss.org/hibernate/core/3.3/reference/en/html/session-configuration.html#configuration-optional-transactionstrategy">"JTA Transaction Managers" table</a> .</p> </li> </ul> </div> <div class="paragraph"> <p>For example if you were running with the JBoss Application Server you would set:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"> <span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.manager_lookup_class</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.transaction.JBossTransactionManagerLookup</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.manager_lookup_class</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â  org.hibernate.transaction.JBossTransactionManagerLookup
<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> <div class="ulist"> <ul> <li> <p>If you are running standalone and you want to add a JTA transaction manager lookup, things get a bit more complicated. Due to a current limitation, Hibernate does not support injecting a JTA TransactionManager or JTA UserTransaction that are not bound to JNDI. In other words, if you want to use JTA, Hibernate expects your TransactionManager to be bound to JNDI and it also expects that UserTransaction instances are retrieved from JNDI. This means that in a standalone environment, you need to add some code that binds your TransactionManager and UserTransaction to JNDI. With this in mind and with the help of one of our community contributors, we&#8217;ve created an example that does just that: <a href="http://anonsvn.jboss.org/repos/hibernate/core/trunk/cache-infinispan/src/test/java/org/hibernate/test/cache/infinispan/tm/JBossStandaloneJtaExampleTest.java">JBoss Standalone JTA Example</a> . Once you have the code in place, it&#8217;s just a matter of selecting the correct Hibernate transaction manager lookup class, based on the JNDI names given. If you take <em>JBossStandaloneJtaExample</em> as an example, you simply have to add:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"> <span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.manager_lookup_class</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.transaction.JBossTransactionManagerLookup</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.manager_lookup_class</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â  org.hibernate.transaction.JBossTransactionManagerLookup
<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>As you probably have noted through this section, there wasn&#8217;t a single mention of the need to configure <a href="http://docs.jboss.org/infinispan/5.0/apidocs/config.html#ce_default_transaction">Infinispan&#8217;s transaction manager lookup</a> and there&#8217;s a good reason for that. Basically, the code within Infinispan cache provider takes the transaction manager that has been configured at the Hibernate level and uses that. Otherwise, if no Hibernate transaction manager lookup class has been defined, Infinispan uses a default dummy transaction manager.</p> </div> <div class="paragraph"> <p>Since Hibernate 4.0, the way Infinispan hooks into the transaction manager can be configured. By default, since 4.0, Infinispan interacts with the transaction manager as a JTA synchronization, resulting <a href="#_transactions">in a faster interaction with the 2LC thanks to some key optimisations that the transaction manager can apply</a>. However if desired, users can configure Infinispan to act as an XA resource (just like it did in 3.6 and earlier) by disabling the use of the synchronization. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml: --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.use_synchronization</span><span class="delimiter">&quot;</span></span><span class="error">Â </span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml: --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.use_synchronization</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â  false
<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> </div> <div class="sect3"> <h4 id="advanced_configuration_2"><a class="anchor" href="#advanced_configuration_2"></a>26.1.4. Advanced Configuration</h4> <div class="paragraph"> <p>Infinispan has the capability of exposing statistics via JMX and since Hibernate 3.5.0.Beta4, you can enable such statistics from the Hibernate/JPA configuration file. By default, Infinispan statistics are turned off but when these are disabled via the following method, statistics for the Infinispan Cache Manager and all the managed caches (entity, collection, etc) are enabled:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.statistics</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml: --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.statistics</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>true<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The Infinispan cache provider jar file contains an Infinispan configuration file, which is the one used by default when configuring the Infinispan standalone cache region factory. This file contains default cache configurations for all Hibernate data types that should suit the majority of use cases. However, if you want to use a different configuration file, you can configure it via the following property:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.cfg</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/home/infinispan/cacheprovider-configs.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml: --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.cfg</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â  /home/infinispan/cacheprovider-configs.xml
<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>For each Hibernate cache data types, Infinispan cache region factory has defined a default cache name to look up in either the default, or the user defined, Infinispan cache configuration file. These default values can be found in the <a href="http://docs.jboss.org/hibernate/core/4.0/javadocs/constant-values.html#org.hibernate.cache.infinispan.InfinispanRegionFactory.INFINISPAN_CONFIG_RESOURCE_PROP">Infinispan cache provider javadoc</a> . You can change these cache names using the following properties:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml: --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.cfg</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">custom-entity</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.collection.cfg</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">custom-collection</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.query.cfg</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">custom-collection</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.timestamp.cfg</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">custom-timestamp</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.cfg</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â  custom-entity
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.collection.cfg</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â  custom-collection
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.query.cfg</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â  custom-collection
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.timestamp.cfg</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â  custom-timestamp
<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>One of the key improvements brought in by Infinispan is the fact that cache instances are more lightweight than they used to be in JBoss Cache. This has enabled a radical change in the way entity/collection type cache management works. With the Infinispan cache provider, each entity/collection type gets each own cache instance, whereas in old JBoss Cache based cache providers, all entity/collection types would be sharing the same cache instance. As a result of this, locking issues related to updating different entity/collection types concurrently are avoided completely.</p> </div> <div class="paragraph"> <p>This also has an important bearing on the meaning of hibernate.cache.infinispan.entity.cfg and hibernate.cache.infinispan.collection.cfg properties. These properties define the template cache name that should be used for all entity/collection data types. So, with the above hibernate.cache.infinispan.entity.cfg configuration, when a region needs to be created for entity com.acme.Person, the cache instance to be assigned to this entity will be based on a "custom-entity" named cache.</p> </div> <div class="paragraph"> <p>On top of that, this finer grained cache definition enables users to define cache settings on a per entity/collection basis. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.cfg</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">person-entity</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.addresses.cfg</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">addresses-collection</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.cfg</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â  person-entity
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.addresses.cfg</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â  addresses-collection
<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="fa icon-important" title="Important"></i> </td> <td class="content"> For any entity or collection specific properties, if you are running within JBoss Application Server, JBoss EAP, or Widlfly, providing just the entity name is not enough. You need to add unit name and deployment name as well to each property in the following format: <code>hibernate.cache.infinispan.&lt;warname&gt;.&lt;unitname&gt;.&lt;FQN of entity&gt;&#8230;&#8203;..</code> </td> </tr> </table> </div> <div class="paragraph"> <p>Here, we&#8217;re configuring the Infinispan cache provider so that for com.acme.Person entity type, the cache instance assigned will be based on a "person-entity" named cache, and for com.acme.Person.addresses collection type, the cache instance assigned will be based on a "addresses-collection" named cache. If either of these two named caches did not exist in the Infinispan cache configuration file, the cache provider would create a cache instance for com.acme.Person entity and com.acme.Person.addresses collection based on the default cache in the configuration file.</p> </div> <div class="paragraph"> <p>Furthermore, thanks to the excellent feedback from the Infinispan community and in particular, Brian Stansberry, we&#8217;ve decided to allow users to define the most commonly tweaked Infinispan cache parameters via hibernate.cfg.xml or persistence.xml, for example eviction/expiration settings. So, with the Infinispan cache provider, you can configure eviction/expiration this way:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.eviction.strategy</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">LRU</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.eviction.wake_up_interval</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">2000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.eviction.max_entries</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.expiration.lifespan</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">60000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.expiration.max_idle</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">30000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.eviction.strategy</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â  LRU
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.eviction.wake_up_interval</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â  2000
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.eviction.max_entries</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â  5000
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.expiration.lifespan</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â  60000
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.expiration.max_idle</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â  30000
<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>With the above configuration, you&#8217;re overriding whatever eviction/expiration settings were defined for the default entity cache name in the Infinispan cache configuration used, regardless of whether it&#8217;s the default one or user defined. More specifically, we&#8217;re defining the following:</p> </div> <div class="ulist"> <ul> <li> <p>All entities to use LRU eviction strategy</p> </li> <li> <p>The eviction thread to wake up every 2000 milliseconds</p> </li> <li> <p>The maximum number of entities for each entity type to be 5000 entries</p> </li> <li> <p>The lifespan of each entity instance to be 600000 milliseconds</p> </li> <li> <p>The maximum idle time for each entity instance to be 30000</p> </li> </ul> </div> <div class="paragraph"> <p>You can also override eviction/expiration settings on a per entity/collection type basis in such way that the overriden settings only afftect that particular entity (i.e. com.acme.Person) or collection type (i.e. com.acme.Person.addresses). For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.eviction.strategy</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">FIFO</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.eviction.wake_up_interval</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">2500</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.eviction.max_entries</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">5500</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.expiration.lifespan</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">65000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.expiration.max_idle</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">35000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.eviction.strategy</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â  FIFO
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.eviction.wake_up_interval</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â  2500
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.eviction.max_entries</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â  5500
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.expiration.lifespan</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â  65000
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.expiration.max_idle</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â  35000
<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The aim of these configuration capabilities is to reduce the number of files needed to modify in order to define the most commonly tweaked parameters. So, by enabling eviction/expiration configuration on a per generic Hibernate data type or particular entity/collection type via hibernate.cfg.xml or persistence.xml, users don&#8217;t have to touch to Infinispan&#8217;s cache configuration file any more. We believe users will like this approach and so, if you there are any other Infinispan parameters that you often tweak and these cannot be configured via hibernate.cfg.xml or persistence.xml, please let the Infinispan team know by sending an email to <a href="mailto:infinispan-dev@lists.jboss.org">infinispan-dev@lists.jboss.org</a> .</p> </div> <div class="paragraph"> <p>Please note that query/timestamp caches work the same way they did with JBoss Cache based cache providers. In other words, there&#8217;s a query cache instance and timestamp cache instance shared by all. It&#8217;s worth noting that eviction/expiration settings are allowed for query cache but not for timestamp cache. So configuring an eviction strategy other than NONE for timestamp cache would result in a failure to start up.</p> </div> <div class="paragraph"> <p>Finally, from Hibernate 3.5.4 and 3.6 onwards, queries with specific cache region names are stored under matching cache instances. This means that you can now set query cache region specific settings. For example, assuming you had a query like this:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Query</span> query = session.createQuery(
<span class="error">Â </span> <span class="string"><span class="delimiter">&quot;</span><span class="content">select account.branch from Account as account where account.holder = ?</span><span class="delimiter">&quot;</span></span>);
query.setCacheable(<span class="predefined-constant">true</span>);
query.setCacheRegion(<span class="string"><span class="delimiter">&quot;</span><span class="content">AccountRegion</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>The query would be stored under "AccountRegion" cache instance and users could control settings in similar fashion to what was done with entities and collections. So, for example, you could define specific eviction settings for this particular query region doing something like this:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.AccountRegion.eviction.strategy</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">FIFO</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.AccountRegion.eviction.wake_up_interval</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">10000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.AccountRegion.eviction.strategy</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â  FIFO
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.AccountRegion.eviction.wake_up_interval</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â  10000
<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> </div> <div class="sect3"> <h4 id="handling_custom_identifiers_types"><a class="anchor" href="#handling_custom_identifiers_types"></a>26.1.5. Handling custom identifiers types</h4> <div class="paragraph"> <p>When custom identifier types are used in Hibernate/JPA entities, specially in the case of composite identifiers, the resulting cache keys can end up holding references to <code>SessionFactory</code> instances. Serializing those properly in a clustered environment depends on being able to resolve the proper <code>SessionFactory</code> reference on deserialization, which can happen based on UUID (same JVM) or name (across JVMs).</p> </div> <div class="paragraph"> <p>When the resolution does not succeed, it&#8217;s common to see errors similar to this:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">java.io.InvalidObjectException: Could not find a SessionFactory [uuid=<span class="float">0d</span><span class="integer">0</span>cdf26-dfe6-<span class="integer">4285</span>-<span class="integer">9725</span>-dfaa4821ecba,name=<span class="predefined-constant">null</span>]
    at org.hibernate.internal.SessionFactoryImpl.locateSessionFactoryOnDeserialization(SessionFactoryImpl.java:<span class="integer">1781</span>)
    at org.hibernate.internal.SessionFactoryImpl.readResolve(SessionFactoryImpl.java:<span class="integer">1761</span>)</code></pre> </div> </div> <div class="paragraph"> <p>The way to get around these error is by locking down the name of the <code>SessionFactory</code> across JVMs. This can be done by adding the following properties in the clustered application&#8217;s configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">hibernate.session_factory_name = MySessionFactory
hibernate.session_factory_name_is_jndi = <span class="predefined-constant">false</span></code></pre> </div> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> These properties are not necessary if deploying in JBoss Application Server, Wildfly or EAP containers, since the integration code already populates session factory name based on deployment unit information. </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="integration_with_jboss_application_server"><a class="anchor" href="#integration_with_jboss_application_server"></a>26.1.6. Integration with JBoss Application Server</h4> <div class="paragraph"> <p>In JBoss Application Server 7, Infinispan is the default second level cache provider and you can find details about its configuration <a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=8094254">the AS7 JPA reference guide</a> .</p> </div> <div class="paragraph"> <p>Infinispan based Hibernate 2LC was developed as part of Hibernate 3.5 release and so it currently only works within AS 6 or higher. Hibernate 3.5 is not designed to work with AS/EAP 5.x or lower. To be able to run Infinispan based Hibernate 2LC in a lower AS version such as 5.1, the Infinispan 2LC module would require porting to Hibernate 3.3.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> Looking to integrate Infinispan with Hibernate in JBoss AS/EAP 5.x? <a href="#_infinispan_as_hibernate_2nd_level_cache_in_jboss_as_5_x">Read this section</a>! </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="using_infinispan_as_remote_second_level_cache"><a class="anchor" href="#using_infinispan_as_remote_second_level_cache"></a>26.1.7. Using Infinispan as remote Second Level Cache?</h4> <div class="paragraph"> <p>Lately, several questions ( <a href="http://community.jboss.org/message/575814#575814">here</a> and <a href="http://community.jboss.org/message/585841#585841">here</a> ) have appeared in the Infinispan user forums asking whether it&#8217;d be possible to have an Infinispan second level cache that instead of living in the same JVM as the Hibernate code, it resides in a remote server, i.e. an Infinispan Hot Rod server. It&#8217;s important to understand that trying to set up second level cache in this way is generally not a good idea for the following reasons:</p> </div> <div class="ulist"> <ul> <li> <p>The purpose of a JPA/Hibernate second level cache is to store entities/collections recently retrieved from database or to maintain results of recent queries. So, part of the aim of the second level cache is to have data accessible locally rather than having to go to the database to retrieve it everytime this is needed. Hence, if you decide to set the second level cache to be remote as well, you&#8217;re losing one of the key advantages of the second level cache: the fact that the cache is local to the code that requires it.</p> </li> <li> <p>Setting a remote second level cache can have a negative impact in the overall performance of your application because it means that cache misses require accessing a remote location to verify whether a particular entity/collection/query is cached. With a local second level cache however, these misses are resolved locally and so they are much faster to execute than with a remote second level cache.</p> </li> </ul> </div> <div class="paragraph"> <p>There are however some edge cases where it might make sense to have a remote second level cache, for example:</p> </div> <div class="ulist"> <ul> <li> <p>You are having memory issues in the JVM where JPA/Hibernate code and the second level cache is running. Off loading the second level cache to remote Hot Rod servers could be an interesting way to separate systems and allow you find the culprit of the memory issues more easily.</p> </li> <li> <p>Your application layer cannot be clustered but you still want to run multiple application layer nodes. In this case, you can&#8217;t have multiple local second level cache instances running because they won&#8217;t be able to invalidate each other for example when data in the second level cache is updated. In this case, having a remote second level cache could be a way out to make sure your second level cache is always in a consistent state, will all nodes in the application layer pointing to it.</p> </li> <li> <p>Rather than having the second level cache in a remote server, you want to simply keep the cache in a separate VM still within the same machine. In this case you would still have the additional overhead of talking across to another JVM, but it wouldn&#8217;t have the latency of across a network. The benefit of doing this is that:</p> </li> <li> <p>Size the cache separate from the application, since the cache and the application server have very different memory profiles. One has lots of short lived objects, and the other could have lots of long lived objects.</p> </li> <li> <p>To pin the cache and the application server onto different CPU cores (using <em>numactl</em> ), and even pin them to different physically memory based on the NUMA nodes.</p> </li> </ul> </div> </div> </div> <div class="sect2"> <h3 id="implementing_standalone_jpa_jta_hibernate_application_outside_j2ee_server_using_infinispan_2nd_level_cache"><a class="anchor" href="#implementing_standalone_jpa_jta_hibernate_application_outside_j2ee_server_using_infinispan_2nd_level_cache"></a>26.2. Implementing standalone JPA JTA Hibernate application outside J2EE server using Infinispan 2nd level cache</h3> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="fa icon-important" title="Important"></i> </td> <td class="content"> From Hibernate 4.0.1 onwards, Infinispan now interacts as a synchronization rather than as an XA resource with the transaction manager when used as second-level cache, so there&#8217;s no longer need to apply any of the changes suggested below! </td> </tr> </table> </div> <div class="paragraph"> <p>Infinispans predecessor <a href="http://www.jboss.org/file-access/default/members/jbossclustering/freezone/docs/hibernate-caching/3.3/en-US/html/introduction-requirements.html">JBoss Cache</a> requires integration with JTA when used as 2L-cache for a Hibernate application. At the moment of writing this article (Hibernate 3.5.0.Beta3) also Infinispan requires integration with JTA. Hibernate integrated with JTA is already largely used in EJB applications servers, but most users using Hibernate with Java SE outside any EJB container, still use the plain JDBC approach instead to use JTA.</p> </div> <div class="paragraph"> <p>According Hibernate documentation it should also possible to integrate JTA in a standalone application outside any EJB container, but I did hardly find any documentation how to do that in detail. (probably the reason is, that probably 95% of people is using hibernate within a EJB app. server or using SPRING). This article should give you some example how to realize a standalone Hibernate app. outside of a EJB container with JTA integration (and using Infinispan 2nd level cache).</p> </div> <div class="paragraph"> <p>As first thing you have to choose which implementation of TransactionManager to take. This article comes with examples for following OpenSource TransactionManagers:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>JBoss</p> </li> <li> <p>JOTM</p> </li> <li> <p>Bitronix</p> </li> <li> <p>Atomikos</p> </li> </ol> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="title">Datasource/Transaction interaction</div> A very important aspect is not forgetting to couple the datasource with your transaction manager. In other words, the corresponding XAResource must be onto the transaction manager, otherwise only DML-statements but no commits/rollbacks are propagated to your database. </td> </tr> </table> </div> <div class="sect3"> <h4 id="jboss_transactions"><a class="anchor" href="#jboss_transactions"></a>26.2.1. JBoss Transactions</h4> <div class="paragraph"> <p>The example with JBoss Transactions Transaction Manager was the most complex to implement, as JBoss&#8217;s TransactionManager and UserTransaction objects are not declared serializable whilst its JNDI-server isn&#8217;t able to bind non serializable objects out of the box. Special use of NonSerializableFactory is needed, requiring some additional custom code:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">hello.A</span>;<span class="error">Â </span> <span class="comment">// a persistent class</span>
<span class="keyword">import</span> <span class="include">java.io.Serializable</span>;
<span class="keyword">import</span> <span class="include">java.sql.Connection</span>;
<span class="keyword">import</span> <span class="include">java.sql.SQLException</span>;
<span class="keyword">import</span> <span class="include">java.util.Properties</span>;

<span class="keyword">import</span> <span class="include">javax.naming.Context</span>;
<span class="keyword">import</span> <span class="include">javax.naming.InitialContext</span>;
<span class="keyword">import</span> <span class="include">javax.naming.Name</span>;
<span class="keyword">import</span> <span class="include">javax.naming.NameNotFoundException</span>;
<span class="keyword">import</span> <span class="include">javax.naming.Reference</span>;
<span class="keyword">import</span> <span class="include">javax.naming.StringRefAddr</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.EntityManager</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.Persistence</span>;
<span class="keyword">import</span> <span class="include">javax.transaction.TransactionManager</span>;
<span class="keyword">import</span> <span class="include">javax.transaction.UserTransaction</span>;

<span class="keyword">import</span> <span class="include">org.enhydra.jdbc.standard.StandardXADataSource</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.Session</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.SessionFactory</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.ejb.HibernateEntityManagerFactory</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.transaction.JBossTransactionManagerLookup</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.transaction.lookup.JBossStandaloneJTAManagerLookup</span>;
<span class="keyword">import</span> <span class="include">org.jboss.util.naming.NonSerializableFactory</span>;
<span class="keyword">import</span> <span class="include">org.jnp.interfaces.NamingContext</span>;
<span class="keyword">import</span> <span class="include">org.jnp.server.Main</span>;
<span class="keyword">import</span> <span class="include">org.jnp.server.NamingServer</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">JTAStandaloneExampleJBossTM</span><span class="error">Â </span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">static</span> JBossStandaloneJTAManagerLookup _ml =<span class="error">Â </span> <span class="keyword">new</span> JBossStandaloneJTAManagerLookup();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">try</span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// Create an in-memory jndi</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> NamingServer namingServer = <span class="keyword">new</span> NamingServer();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> NamingContext.setLocal(namingServer);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> Main namingMain = <span class="keyword">new</span> Main();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> namingMain.setInstallGlobalService(<span class="predefined-constant">true</span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> namingMain.setPort(-<span class="integer">1</span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> namingMain.start();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">Properties</span> props = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> props.put(<span class="predefined-type">Context</span>.INITIAL_CONTEXT_FACTORY, <span class="string"><span class="delimiter">&quot;</span><span class="content">org.jnp.interfaces.NamingContextFactory</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">java.naming.factory.url.pkgs</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">org.jboss.naming:org.jnp.interfaces</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">InitialContext</span> ictx = <span class="keyword">new</span> <span class="predefined-type">InitialContext</span>( props );
<span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// as JBossTransactionManagerLookup extends JNDITransactionManagerLookup we must also register the TransactionManager</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">java:/TransactionManager</span><span class="delimiter">&quot;</span></span>, _ml.getTransactionManager(), _ml.getTransactionManager().getClass(), ictx);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// also the UserTransaction must be registered on jndi: org.hibernate.transaction.JTATransactionFactory#getUserTransaction() requires this</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> bind(<span class="keyword">new</span> JBossTransactionManagerLookup().getUserTransactionName(),_ml.getUserTransaction(),_ml.getUserTransaction().getClass(), ictx);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> ExtendedXADataSource xads = <span class="keyword">new</span> ExtendedXADataSource();<span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> xads.setDriverName(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hsqldb.jdbcDriver</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> xads.setDriverName(<span class="string"><span class="delimiter">&quot;</span><span class="content">com.p6spy.engine.spy.P6SpyDriver</span><span class="delimiter">&quot;</span></span>); <span class="comment">// comment this line if you don't want p6spy-logging</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> xads.setUrl(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:hsqldb:hsql://localhost</span><span class="delimiter">&quot;</span></span>);<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">//xads.setTransactionManager(_ml.getTransactionManager()); useless here as this information is not serialized</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> ictx.bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">java:/MyDatasource</span><span class="delimiter">&quot;</span></span>, xads);<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">final</span> HibernateEntityManagerFactory emf =<span class="error">Â </span> (HibernateEntityManagerFactory) Persistence.createEntityManagerFactory(<span class="string"><span class="delimiter">&quot;</span><span class="content">helloworld</span><span class="delimiter">&quot;</span></span>);<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> UserTransaction userTransaction = _ml.getUserTransaction();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> userTransaction.setTransactionTimeout(<span class="integer">300000</span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">//SessionFactory sf = (SessionFactory) ictx.lookup(&quot;java:/hibernate/MySessionFactory&quot;); // if hibernate.session_factory_name set</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">final</span> SessionFactory sf = emf.getSessionFactory();

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> userTransaction.begin();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> EntityManager em = emf.createEntityManager();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// do here your persistent work</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> A a = <span class="keyword">new</span> A();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> a.name= <span class="string"><span class="delimiter">&quot;</span><span class="content">firstvalue</span><span class="delimiter">&quot;</span></span>;
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> em.persist(a);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> em.flush();<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// do manually flush here as apparently FLUSH_BEFORE_COMPLETION seems not work, bug ?</span>

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="content">Created and flushed instance a with id : </span><span class="delimiter">&quot;</span></span> + a.oid + <span class="string"><span class="delimiter">&quot;</span><span class="content">Â  a.name set to:</span><span class="delimiter">&quot;</span></span> + a.name);

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Calling userTransaction.commit() (Please check if the commit is effectively executed!)</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> userTransaction.commit();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> ictx.close();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> namingMain.stop();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> emf.close();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> e.printStackTrace();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">System</span>.exit(<span class="integer">0</span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span> <span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">ExtendedXADataSource</span> <span class="directive">extends</span> StandardXADataSource { <span class="comment">// XAPOOL</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="annotation">@Override</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">public</span> <span class="predefined-type">Connection</span> getConnection() <span class="directive">throws</span> <span class="exception">SQLException</span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">if</span> (getTransactionManager() == <span class="predefined-constant">null</span>) { <span class="comment">// although already set before, it results null again after retrieving the datasource by jndiÂ </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> TransactionManager tm;<span class="error">Â </span> <span class="comment">// this is because the TransactionManager information is not serialized.</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">try</span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> tm = _ml.getTransactionManager();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">SQLException</span>(e);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> setTransactionManager(tm);<span class="error">Â </span> <span class="comment">//Â  resets the TransactionManager on the datasource retrieved by jndi,</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">//Â  this makes the datasource JTA-aware</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// According to Enhydra documentation, here we must return the connection of our XAConnection</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// see http://cvs.forge.objectweb.org/cgi-bin/viewcvs.cgi/xapool/xapool/examples/xapooldatasource/DatabaseHelper.java?sortby=rev</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">return</span> <span class="local-variable">super</span>.getXAConnection().getConnection();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">/**
Â Â Â Â  * Helper method that binds the a non serializable object to the JNDI tree.
Â Â Â Â  *
Â Â Â Â  * @param jndiName Name under which the object must be bound
Â Â Â Â  * @param who Object to bind in JNDI
Â Â Â Â  * @param classType Class type under which should appear the bound object
Â Â Â Â  * @param ctx Naming context under which we bind the object
Â Â Â Â  * @throws Exception Thrown if a naming exception occurs during binding
Â Â Â Â  */</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">private</span> <span class="directive">static</span> <span class="type">void</span> bind(<span class="predefined-type">String</span> jndiName, <span class="predefined-type">Object</span> who, <span class="predefined-type">Class</span> classType, <span class="predefined-type">Context</span> ctx) <span class="directive">throws</span> <span class="exception">Exception</span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// Ah ! This service isn't serializable, so we use a helper class</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> NonSerializableFactory.bind(jndiName, who);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">Name</span> n = ctx.getNameParser(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>).parse(jndiName);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">while</span> (n.size() &gt; <span class="integer">1</span>) {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">String</span> ctxName = n.get(<span class="integer">0</span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">try</span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> ctx = (<span class="predefined-type">Context</span>) ctx.lookup(ctxName);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> } <span class="keyword">catch</span> (<span class="exception">NameNotFoundException</span> e) {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Creating subcontext:</span><span class="delimiter">&quot;</span></span> + ctxName);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> ctx = ctx.createSubcontext(ctxName);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> n = n.getSuffix(<span class="integer">1</span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// The helper class NonSerializableFactory uses address type nns, we go on to</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// use the helper class to bind the service object in JNDI</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">StringRefAddr</span> addr = <span class="keyword">new</span> <span class="predefined-type">StringRefAddr</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">nns</span><span class="delimiter">&quot;</span></span>, jndiName);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">Reference</span> ref = <span class="keyword">new</span> <span class="predefined-type">Reference</span>(classType.getName(), addr, NonSerializableFactory.class.getName(), <span class="predefined-constant">null</span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> ctx.rebind(n.get(<span class="integer">0</span>), ref);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">private</span> <span class="directive">static</span> <span class="type">void</span> unbind(<span class="predefined-type">String</span> jndiName, <span class="predefined-type">Context</span> ctx) <span class="directive">throws</span> <span class="exception">Exception</span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> NonSerializableFactory.unbind(jndiName);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> ctx.unbind(jndiName);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }

}</code></pre> </div> </div> <div class="paragraph"> <p>The content of the corresponding complete persistence.xml:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/persistence</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span><span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_1_0.xsd</span><span class="delimiter">&quot;</span></span><span class="error">Â </span> <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â  <span class="tag">&lt;persistence-unit</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">helloworld</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">transaction-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">JTA</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â Â Â Â  <span class="tag">&lt;jta-data-source&gt;</span>java:/MyDatasource<span class="tag">&lt;/jta-data-source&gt;</span>
Â Â Â Â Â  <span class="tag">&lt;properties&gt;</span>
Â Â Â Â Â Â  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.hbm2ddl.auto</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">create</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
Â Â Â Â Â Â  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.archive.autodetection</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">class, hbm</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
Â Â Â Â Â Â Â Â Â Â  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.dialect</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.dialect.HSQLDialect</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

Â Â Â Â Â Â Â Â Â Â  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.jndi.class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jnp.interfaces.NamingContextFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
Â Â Â Â Â Â Â Â Â Â  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.manager_lookup_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.transaction.JBossTransactionManagerLookup</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

Â Â Â Â Â Â Â  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">current_session_context_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jta</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
Â Â Â Â Â Â Â Â Â Â  <span class="comment">&lt;!-- &lt;property name=&quot;hibernate.session_factory_name&quot; value=&quot;java:/hibernate/MySessionFactory&quot;/&gt; optional --&gt;</span>
Â Â Â Â Â Â Â Â Â Â  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.factory_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.transaction.JTATransactionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
Â Â Â Â Â Â Â Â Â Â  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.connection.release_mode</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">auto</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
Â Â Â Â Â Â Â Â Â Â  <span class="comment">&lt;!-- setting above is important using XA-DataSource on SQLServer,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  otherwise SQLServerException: The function START: has failed. No transaction cookie was returned.--&gt;</span>

Â Â Â Â Â Â Â Â  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.use_second_level_cache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
Â Â Â Â Â Â Â Â Â Â Â  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.use_query_cache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
Â Â Â Â 
Â Â Â Â Â Â Â Â  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.region.factory_class</span><span class="delimiter">&quot;</span></span><span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.cache.infinispan.InfinispanRegionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
Â Â Â Â Â Â Â Â 
Â Â Â Â Â  <span class="tag">&lt;/properties&gt;</span>
Â Â  <span class="tag">&lt;/persistence-unit&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> </div> <div class="sect3"> <h4 id="jotm"><a class="anchor" href="#jotm"></a>26.2.2. JOTM</h4> <div class="paragraph"> <p>The example with JOTM is more simple, but apparently its JNDI implementation is not useable without wasting any rmi port. So it is not completely 'standalone' as the JNDI service is exposed outside your virtual machine.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">hello.A</span>; <span class="comment">// a persistent class</span>

<span class="keyword">import</span> <span class="include">java.sql.Connection</span>;
<span class="keyword">import</span> <span class="include">java.sql.SQLException</span>;
<span class="keyword">import</span> <span class="include">java.util.Properties</span>;

<span class="keyword">import</span> <span class="include">javax.naming.Context</span>;
<span class="keyword">import</span> <span class="include">javax.naming.InitialContext</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.EntityManager</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.EntityManagerFactory</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.Persistence</span>;
<span class="keyword">import</span> <span class="include">javax.transaction.TransactionManager</span>;
<span class="keyword">import</span> <span class="include">javax.transaction.UserTransaction</span>;

<span class="keyword">import</span> <span class="include">org.enhydra.jdbc.standard.StandardXADataSource</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.transaction.JOTMTransactionManagerLookup</span>;
<span class="keyword">import</span> <span class="include">org.objectweb.jotm.Jotm</span>;
<span class="keyword">import</span> <span class="include">org.objectweb.transaction.jta.TMService</span>;


<span class="directive">public</span> <span class="type">class</span> <span class="class">JTAExampleJOTM</span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
 <span class="directive">static</span> JOTMTransactionManagerLookup _ml =<span class="error">Â </span> <span class="keyword">new</span> JOTMTransactionManagerLookup();

 <span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">ExtendedXADataSource</span> <span class="directive">extends</span> StandardXADataSource { <span class="comment">// XAPOOLÂ Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="annotation">@Override</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">public</span> <span class="predefined-type">Connection</span> getConnection() <span class="directive">throws</span> <span class="exception">SQLException</span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">if</span> (getTransactionManager() == <span class="predefined-constant">null</span>) { <span class="comment">// although already set before, it results null again after retrieving the datasource by jndiÂ </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> TransactionManager tm;<span class="error">Â </span> <span class="comment">// this is because the TransactionManager information is not serialized.</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">try</span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> tm = _ml.getTransactionManager(<span class="predefined-constant">null</span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">SQLException</span>(e);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> setTransactionManager(tm);<span class="error">Â </span> <span class="comment">//Â  resets the TransactionManager on the datasource retrieved by jndi,</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">//Â  this makes the datasource JTA-aware</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// According to Enhydra documantation, here we must return the connection of our XAConnection</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// see http://cvs.forge.objectweb.org/cgi-bin/viewcvs.cgi/xapool/xapool/examples/xapooldatasource/DatabaseHelper.java?sortby=rev</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">return</span> <span class="local-variable">super</span>.getXAConnection().getConnection();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main( <span class="predefined-type">String</span><span class="type">[]</span> args )
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">try</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> java.rmi.registry.LocateRegistry.createRegistry(<span class="integer">1099</span>); <span class="comment">// also possible to lauch by command line rmiregistry</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">RMI registry ready.</span><span class="delimiter">&quot;</span></span>);

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// following properties can be left out if specifying thes values in a file jndi.properties located into classpath</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">Properties</span> props = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> props.put(<span class="predefined-type">Context</span>.INITIAL_CONTEXT_FACTORY, <span class="string"><span class="delimiter">&quot;</span><span class="content">org.ow2.carol.jndi.spi.MultiOrbInitialContextFactory</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">InitialContext</span> jndiCtx = <span class="keyword">new</span> <span class="predefined-type">InitialContext</span>(props);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// XAPOOL</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> ExtendedXADataSource xads = <span class="keyword">new</span> ExtendedXADataSource();<span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> xads.setDriverName(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hsqldb.jdbcDriver</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> xads.setDriverName(<span class="string"><span class="delimiter">&quot;</span><span class="content">com.p6spy.engine.spy.P6SpyDriver</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> xads.setUrl(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:hsqldb:hsql://localhost</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> jndiCtx.bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">java:/MyDatasource</span><span class="delimiter">&quot;</span></span>, xads);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">/* startup JOTM */</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> TMService jotm = <span class="keyword">new</span> Jotm(<span class="predefined-constant">true</span>, <span class="predefined-constant">false</span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> jotm.getUserTransaction().setTransactionTimeout(<span class="integer">36000</span>); <span class="comment">// secs, important JOTM default is only 60 secs !</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">/* and get a UserTransaction */</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> UserTransaction userTransaction = jotm.getUserTransaction();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> jndiCtx.bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">java:comp/UserTransaction</span><span class="delimiter">&quot;</span></span>, jotm.getUserTransaction()); <span class="comment">// this is needed by hibernates JTATransactionFactory</span>

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">/* get the Hibernate SessionFactory */</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> EntityManagerFactory emf =<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> Persistence.createEntityManagerFactory(<span class="string"><span class="delimiter">&quot;</span><span class="content">helloworld</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">//SessionFactory sf = (SessionFactory) jndiCtx.lookup(&quot;java:/hibernate/MySessionFactory&quot;);</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// begin a new Transaction</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> userTransaction.begin();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> EntityManager em = emf.createEntityManager();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> A a = <span class="keyword">new</span> A();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> a.name= <span class="string"><span class="delimiter">&quot;</span><span class="content">firstvalue</span><span class="delimiter">&quot;</span></span>;
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> em.persist(a);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> em.flush();<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// do manually flush here as apparently FLUSH_BEFORE_COMPLETION seems not work, bug ?</span>

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Calling userTransaction.commit() (Please check if the commit is effectively executed!)</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> userTransaction.commit();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// stop the transaction manager</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> jotm.stop();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> jndiCtx.close();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> emf.close();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">catch</span>( <span class="exception">Exception</span> e )
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> e.printStackTrace();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">System</span>.exit(<span class="integer">0</span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }

}</code></pre> </div> </div> <div class="paragraph"> <p>Adjust following 2 properties in your persistence.xml:</p> </div> <div class="listingblock"> <div class="title">persistence.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.jndi.class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.ow2.carol.jndi.spi.MultiOrbInitialContextFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.manager_lookup_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.transaction.JOTMTransactionManagerLookup</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>For using the JTA Hibernate application as servlet in tomcat please readÂ  <a href="http://jotm.objectweb.org/current/jotm/doc/howto-tomcat-jotm.html" class="bare">http://jotm.objectweb.org/current/jotm/doc/howto-tomcat-jotm.html</a> and also <a href="https://forum.hibernate.org/viewtopic.php?f=1&amp;amp;t=1003866" class="bare">https://forum.hibernate.org/viewtopic.php?f=1&amp;amp;t=1003866</a></p> </div> </div> <div class="sect3"> <h4 id="bitronix"><a class="anchor" href="#bitronix"></a>26.2.3. Bitronix</h4> <div class="paragraph"> <p>The Transaction Manager comes bundled with a fake in memory jndi-implementation which is ideal for standalone purpose. To integrate with Infinispan I did need a ad-hoc pre-alpha improvement (see attached <a href="https://docs.jboss.org/author/download/attachments/68355081/btm-ispn.jar?version=1&amp;amp;modificationDate=1308852871000">btm-ispn.jar</a> by courtesy ofÂ  Mr. Ludivic Orban). BitronixTM offers the so-called Last Resource Commit optimization (aka Last Resource Gambit or Last Agent optimization) and it allows a single non-XA database to participate in a XA transaction by cleverly ordering the resources. "Last Resource Commit" is not part of the XA spec as it doesn&#8217;t cover the transaction-recovery aspect, so if your database does not support XA (or if you don&#8217;t wish to have the Xa-driver performance overhead against the plain jdbc) then the "Last Resource Commit" feature should be ideal for the combination 1 single database plus infinispan.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">hello.A</span>; <span class="comment">// a persistent class</span>

<span class="keyword">import</span> <span class="include">java.util.Properties</span>;

<span class="keyword">import</span> <span class="include">javax.naming.Context</span>;
<span class="keyword">import</span> <span class="include">javax.naming.InitialContext</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.EntityManager</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.Persistence</span>;
<span class="keyword">import</span> <span class="include">javax.transaction.UserTransaction</span>;

<span class="keyword">import</span> <span class="include">org.hibernate.cache.infinispan.InfinispanRegionFactory</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.ejb.HibernateEntityManagerFactory</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.impl.SessionFactoryImpl</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.manager.CacheManager</span>;

<span class="keyword">import</span> <span class="include">bitronix.tm.resource.ResourceRegistrar</span>;
<span class="keyword">import</span> <span class="include">bitronix.tm.resource.infinispan.InfinispanCacheManager</span>;
<span class="keyword">import</span> <span class="include">bitronix.tm.resource.jdbc.PoolingDataSource</span>;



<span class="directive">public</span> <span class="type">class</span> <span class="class">JTAExampleBTM</span><span class="error">Â </span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">try</span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">Properties</span> props = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> props.put(<span class="predefined-type">Context</span>.INITIAL_CONTEXT_FACTORY, <span class="string"><span class="delimiter">&quot;</span><span class="content">bitronix.tm.jndi.BitronixInitialContextFactory</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// Attention: BitronixInitialContextFactory is'nt a real jndi implementation: you can't do explicit bindings</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// It is ideal for hiberante standalone usage, as it automatically 'binds' the needed things: datasource + usertransaction</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">create initial context</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">InitialContext</span> ictx = <span class="keyword">new</span> <span class="predefined-type">InitialContext</span>(props);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> PoolingDataSource myDataSource = <span class="keyword">new</span> PoolingDataSource();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> myDataSource.setClassName(<span class="string"><span class="delimiter">&quot;</span><span class="content">bitronix.tm.resource.jdbc.lrc.LrcXADataSource</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> myDataSource.setMaxPoolSize(<span class="integer">5</span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> myDataSource.setAllowLocalTransactions(<span class="predefined-constant">true</span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> myDataSource.getDriverProperties().setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">driverClassName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">com.p6spy.engine.spy.P6SpyDriver</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> myDataSource.getDriverProperties().setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">url</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:hsqldb:hsql://localhost</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> myDataSource.getDriverProperties().setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> myDataSource.getDriverProperties().setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> myDataSource.setUniqueName(<span class="string"><span class="delimiter">&quot;</span><span class="content">java:/MyDatasource</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> myDataSource.setAutomaticEnlistingEnabled(<span class="predefined-constant">true</span>); <span class="comment">// important to keep it to true (default), otherwise commits/rollbacks are not propagated</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> myDataSource.init(); <span class="comment">// does also register the datasource on the Fake-JNDI with Unique Name</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> org.hibernate.transaction.BTMTransactionManagerLookup lokhiberante = <span class="keyword">new</span> org.hibernate.transaction.BTMTransactionManagerLookup();

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> HibernateEntityManagerFactory emf =<span class="error">Â </span> (HibernateEntityManagerFactory)<span class="error">Â </span> Persistence.createEntityManagerFactory(<span class="string"><span class="delimiter">&quot;</span><span class="content">helloworld</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> SessionFactoryImpl sfi = (SessionFactoryImpl) emf.getSessionFactory();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> InfinispanRegionFactory infinispanregionfactory = (InfinispanRegionFactory) sfi.getSettings().getRegionFactory();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> CacheManager manager = infinispanregionfactory.getCacheManager();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// register Inifinispan as a BTM resource</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> InfinispanCacheManager icm = <span class="keyword">new</span> InfinispanCacheManager();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> icm.setUniqueName(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> ResourceRegistrar.register(icm);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> icm.setManager(manager);

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">final</span> UserTransaction userTransaction = (UserTransaction) ictx.lookup(lokhiberante.getUserTransactionName());

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// begin a new Transaction</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> userTransaction.begin();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> EntityManager em = emf.createEntityManager();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> A a = <span class="keyword">new</span> A();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> a.name= <span class="string"><span class="delimiter">&quot;</span><span class="content">firstvalue</span><span class="delimiter">&quot;</span></span>;
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> em.persist(a);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> em.flush();<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// do manually flush here as apparently FLUSH_BEFORE_COMPLETION seems not work, bug ?</span>

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Calling userTransaction.commit() (Please check if the commit is effectively executed!)</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> userTransaction.commit();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> emf.close();

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> e.printStackTrace();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">System</span>.exit(<span class="integer">1</span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">System</span>.exit(<span class="integer">0</span>);
<span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }
}</code></pre> </div> </div> <div class="paragraph"> <p>Adjust following 2 properties in your corresponding persistence.xml:</p> </div> <div class="listingblock"> <div class="title">persistence.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.jndi.class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bitronix.tm.jndi.BitronixInitialContextFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.manager_lookup_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.transaction.BTMTransactionManagerLookup</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> </div> <div class="sect3"> <h4 id="atomikos"><a class="anchor" href="#atomikos"></a>26.2.4. Atomikos</h4> <div class="paragraph"> <p>Last but not least, the Atomikos Transaction manager. It is currently the unique Transaction manager I&#8217;ve found with a online-documentation on <a href="http://www.atomikos.com/Documentation/HibernateIntegration#Without_Spring">how to integrate with Hiberante</a> <a href="http://www.atomikos.com/Documentation/HibernateIntegration#Without_Spring">without Spring, outside any J2EE container.</a> . It seems to be the unique supporting XaDataSource together with Pooling, so it doesn&#8217;t matter that It does not come with its own JNDI implementation (we will use the one of JBoss in following example).</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">hello.A</span>; <span class="comment">// a persistent class</span>

<span class="keyword">import</span> <span class="include">java.io.Serializable</span>;
<span class="keyword">import</span> <span class="include">java.sql.Connection</span>;
<span class="keyword">import</span> <span class="include">java.sql.SQLException</span>;
<span class="keyword">import</span> <span class="include">java.util.Properties</span>;

<span class="keyword">import</span> <span class="include">javax.naming.Context</span>;
<span class="keyword">import</span> <span class="include">javax.naming.InitialContext</span>;
<span class="keyword">import</span> <span class="include">javax.naming.Name</span>;
<span class="keyword">import</span> <span class="include">javax.naming.NameNotFoundException</span>;
<span class="keyword">import</span> <span class="include">javax.naming.Reference</span>;
<span class="keyword">import</span> <span class="include">javax.naming.StringRefAddr</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.EntityManager</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.Persistence</span>;
<span class="keyword">import</span> <span class="include">javax.transaction.TransactionManager</span>;
<span class="keyword">import</span> <span class="include">javax.transaction.UserTransaction</span>;

<span class="keyword">import</span> <span class="include">org.hibernate.Session</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.SessionFactory</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.ejb.HibernateEntityManagerFactory</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.impl.SessionFactoryImpl</span>;

<span class="keyword">import</span> <span class="include">org.jboss.util.naming.NonSerializableFactory</span>;
<span class="keyword">import</span> <span class="include">org.jnp.interfaces.NamingContext</span>;
<span class="keyword">import</span> <span class="include">org.jnp.server.Main</span>;
<span class="keyword">import</span> <span class="include">org.jnp.server.NamingServer</span>;

<span class="keyword">import</span> <span class="include">com.atomikos.icatch.jta.hibernate3.TransactionManagerLookup</span>;
<span class="keyword">import</span> <span class="include">com.atomikos.jdbc.AtomikosDataSourceBean</span>;
<span class="keyword">import</span> <span class="include">com.atomikos.jdbc.SimpleDataSourceBean</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">JTAStandaloneExampleAtomikos</span><span class="error">Â </span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">try</span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// Create an in-memory jndi</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> NamingServer namingServer = <span class="keyword">new</span> NamingServer();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> NamingContext.setLocal(namingServer);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> Main namingMain = <span class="keyword">new</span> Main();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> namingMain.setInstallGlobalService(<span class="predefined-constant">true</span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> namingMain.setPort(-<span class="integer">1</span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> namingMain.start();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">Properties</span> props = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> props.put(<span class="predefined-type">Context</span>.INITIAL_CONTEXT_FACTORY, <span class="string"><span class="delimiter">&quot;</span><span class="content">org.jnp.interfaces.NamingContextFactory</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">java.naming.factory.url.pkgs</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">org.jboss.naming:org.jnp.interfaces</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">InitialContext</span> ictx = <span class="keyword">new</span> <span class="predefined-type">InitialContext</span>( props );
<span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> AtomikosDataSourceBean ds = <span class="keyword">new</span> AtomikosDataSourceBean();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> ds.setUniqueResourceName(<span class="string"><span class="delimiter">&quot;</span><span class="content">sqlserver_ds</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> ds.setXaDataSourceClassName(<span class="string"><span class="delimiter">&quot;</span><span class="content">com.microsoft.sqlserver.jdbc.SQLServerXADataSource</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">Properties</span> p = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> p.setProperty ( <span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span> , <span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span> );
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> p.setProperty ( <span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span> , <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> );
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> p.setProperty ( <span class="string"><span class="delimiter">&quot;</span><span class="content">serverName</span><span class="delimiter">&quot;</span></span> , <span class="string"><span class="delimiter">&quot;</span><span class="content">myserver</span><span class="delimiter">&quot;</span></span> );
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> ds.setXaProperties ( p );
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> ds.setPoolSize(<span class="integer">5</span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">java:/MyDatasource</span><span class="delimiter">&quot;</span></span>, ds, ds.getClass(), ictx);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> TransactionManagerLookup _ml = <span class="keyword">new</span> TransactionManagerLookup();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> UserTransaction userTransaction = <span class="keyword">new</span> com.atomikos.icatch.jta.UserTransactionImp();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">java:/TransactionManager</span><span class="delimiter">&quot;</span></span>, _ml.getTransactionManager(<span class="predefined-constant">null</span>), _ml.getTransactionManager(<span class="predefined-constant">null</span>).getClass(), ictx);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">java:comp/UserTransaction</span><span class="delimiter">&quot;</span></span>, userTransaction, userTransaction.getClass(), ictx);

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> HibernateEntityManagerFactory emf =<span class="error">Â </span> (HibernateEntityManagerFactory) Persistence.createEntityManagerFactory(<span class="string"><span class="delimiter">&quot;</span><span class="content">helloworld</span><span class="delimiter">&quot;</span></span>);<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// begin a new Transaction</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> userTransaction.begin();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> EntityManager em = emf.createEntityManager();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> A a = <span class="keyword">new</span> A();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> a.name= <span class="string"><span class="delimiter">&quot;</span><span class="content">firstvalue</span><span class="delimiter">&quot;</span></span>;
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> em.persist(a);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> em.flush();<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// do manually flush here as apparently FLUSH_BEFORE_COMPLETION seems not work, bug ?</span>

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Calling userTransaction.commit() (Please check if the commit is effectively executed!)</span><span class="delimiter">&quot;</span></span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> userTransaction.commit();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> emf.close();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> e.printStackTrace();
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">System</span>.exit(<span class="integer">1</span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">System</span>.exit(<span class="integer">0</span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">/**
Â Â Â Â  * Helper method that binds the a non serializable object to the JNDI tree.
Â Â Â Â  *
Â Â Â Â  * @param jndiName Name under which the object must be bound
Â Â Â Â  * @param who Object to bind in JNDI
Â Â Â Â  * @param classType Class type under which should appear the bound object
Â Â Â Â  * @param ctx Naming context under which we bind the object
Â Â Â Â  * @throws Exception Thrown if a naming exception occurs during binding
Â Â Â Â  */</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">private</span> <span class="directive">static</span> <span class="type">void</span> bind(<span class="predefined-type">String</span> jndiName, <span class="predefined-type">Object</span> who, <span class="predefined-type">Class</span>&lt;?&gt; classType, <span class="predefined-type">Context</span> ctx) <span class="directive">throws</span> <span class="exception">Exception</span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// Ah ! This service isn't serializable, so we use a helper class</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> NonSerializableFactory.bind(jndiName, who);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">Name</span> n = ctx.getNameParser(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>).parse(jndiName);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">while</span> (n.size() &gt; <span class="integer">1</span>) {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">String</span> ctxName = n.get(<span class="integer">0</span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="keyword">try</span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> ctx = (<span class="predefined-type">Context</span>) ctx.lookup(ctxName);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> } <span class="keyword">catch</span> (<span class="exception">NameNotFoundException</span> e) {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Creating subcontext:</span><span class="delimiter">&quot;</span></span> + ctxName);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> ctx = ctx.createSubcontext(ctxName);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> n = n.getSuffix(<span class="integer">1</span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }

<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// The helper class NonSerializableFactory uses address type nns, we go on to</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="comment">// use the helper class to bind the service object in JNDI</span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">StringRefAddr</span> addr = <span class="keyword">new</span> <span class="predefined-type">StringRefAddr</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">nns</span><span class="delimiter">&quot;</span></span>, jndiName);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="predefined-type">Reference</span> ref = <span class="keyword">new</span> <span class="predefined-type">Reference</span>(classType.getName(), addr, NonSerializableFactory.class.getName(), <span class="predefined-constant">null</span>);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> ctx.rebind(n.get(<span class="integer">0</span>), ref);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="directive">private</span> <span class="directive">static</span> <span class="type">void</span> unbind(<span class="predefined-type">String</span> jndiName, <span class="predefined-type">Context</span> ctx) <span class="directive">throws</span> <span class="exception">Exception</span> {
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> NonSerializableFactory.unbind(jndiName);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> ctx.unbind(jndiName);
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> }

}</code></pre> </div> </div> <div class="paragraph"> <p>Adjust follwing 2 properties in your corresponding persistence.xml:</p> </div> <div class="listingblock"> <div class="title">persistence.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.jndi.class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jnp.interfaces.NamingContextFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>Â Â 
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.manager_lookup_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.atomikos.icatch.jta.hibernate3.TransactionManagerLookup</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>And create a file named jta.properties in your classpath with following content:</p> </div> <div class="listingblock"> <div class="title">jta.properties</div> <div class="content"> <pre>com.atomikos.icatch.service=com.atomikos.icatch.standalone.UserTransactionServiceFactory
com.atomikos.icatch.automatic_resource_registration=false
com.atomikos.icatch.console_log_level=WARN
com.atomikos.icatch.force_shutdown_on_vm_exit=true
com.atomikos.icatch.enable_logging=false</pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="infinispan_as_hibernate_2nd_level_cache_in_jboss_as_5_x"><a class="anchor" href="#infinispan_as_hibernate_2nd_level_cache_in_jboss_as_5_x"></a>26.3. Infinispan as Hibernate 2nd-Level Cache in JBoss AS 5.x</h3> <div class="paragraph"> <p>A JBoss AS 5.x application can be configured to use Infinispan 4.x as the Hibernate 2nd-level cache, replacing JBoss Cache.</p> </div> <div class="paragraph"> <p>1. Add the attached jar files to the ear lib directory. These include the core 4.1.0.GA Infinispan jar (infinispan-core.jar), the Hibernate/Infinispan integration jar back-ported from Hibernate 3.5 (hibernate-infinispan-3.3.2.GA_CP03.jar), the JGroups jar required by Infinispan 4.1.0 (jgroups-2.10.0.GA.jar), and other required 3rd party jars (river-1.2.3.GA.jar, marshalling-api-1.2.3.GA.jar)</p> </div> <div class="paragraph"> <p>2. Isolate the classloading to be ear-scoped by adding <code>META-INF/jboss-classloading.xml</code></p> </div> <div class="listingblock"> <div class="title">META-INF/jboss-classloading.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;classloading</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:classloading:1.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">domain</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">simple-scoped</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent-first</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>3. Configure persistence.xml to use Infinispan instead of JBoss Cache:</p> </div> <div class="listingblock"> <div class="title">persistence.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;persistence</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/persistence</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_1_0.xsd</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;persistence-unit</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jpa-test</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
Â Â Â  <span class="tag">&lt;jta-data-source&gt;</span>java:/PostgresDS<span class="tag">&lt;/jta-data-source&gt;</span>
Â Â Â Â Â Â Â  <span class="tag">&lt;properties&gt;</span>
Â Â Â Â Â Â Â Â Â Â Â  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.dialect</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.dialect.HSQLDialect</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

Â Â Â Â Â Â Â Â Â Â Â  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.session_factory_name</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SessionFactories/infinispan</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

Â Â Â Â Â Â Â Â Â Â Â  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.use_query_cache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
Â Â Â Â Â Â Â Â Â Â Â  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.use_second_level_cache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
Â Â Â Â Â Â Â Â Â Â Â  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.generate_statistics</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
Â Â Â Â Â Â Â Â Â Â Â  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.use_structured_entries</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

Â Â Â Â Â Â Â Â Â Â Â  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.region_prefix</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

Â Â Â Â Â Â Â Â Â Â Â  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.show_sql</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

Â Â Â Â Â Â Â Â Â Â Â  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.hbm2ddl.auto</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">validate</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

            <span class="comment">&lt;!-- Infinispan second level cache configuration --&gt;</span>
Â Â Â Â Â Â Â Â Â Â Â  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.region.factory_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.cache.infinispan.InfinispanRegionFactory</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
Â Â Â Â Â Â Â  <span class="tag">&lt;/properties&gt;</span>
Â Â Â  <span class="tag">&lt;/persistence-unit&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> </div> <div class="sect2"> <h3 id="using_infinispan_as_a_spring_cache_provider"><a class="anchor" href="#using_infinispan_as_a_spring_cache_provider"></a>26.4. Using Infinispan as a Spring Cache provider</h3> <div class="paragraph"> <p>Starting with version 3.1, the <a href="http://spring.io/">Spring Framework</a> offers a <a href="http://docs.spring.io/spring-framework/docs/4.1.1.RELEASE/spring-framework-reference/html/cache.html">cache abstraction</a>, enabling users to declaratively add caching support to applications via two simple annotations, <code>@Cacheable</code> and <code>@CacheEvict</code>. While out of the box Spring 3.1&#8217;s caching support is backed by <a href="http://ehcache.org">EHCache</a> it has been designed to easily support different cache providers. To that end Spring 3.1 defines a simple and straightforward SPI other caching solutions may implement. Infinispan&#8217;s very own spring modules do - amongst other things - exactly this and therefore users invested in Spring&#8217;s programming model may easily have all their caching needs fulfilled through Infinispan.</p> </div> <div class="paragraph"> <p>Here&#8217;s how.</p> </div> <div class="sect3"> <h4 id="activating_spring_cache_support"><a class="anchor" href="#activating_spring_cache_support"></a>26.4.1. Activating Spring Cache support</h4> <div class="paragraph"> <p>You activate Spring&#8217;s cache support using xml:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/cache</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span>
        <span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
        <span class="content">http://www.springframework.org/schema/cache http://www.springframework.org/schema/cache/spring-cache.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

        <span class="tag">&lt;cache:annotation-driven</span> <span class="tag">/&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>somewhere in your application context. This enable the cache annotations in Spring. Alternatively, it can be done programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@EnableCaching</span> <span class="annotation">@Configuration</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {
}</code></pre> </div> </div> <div class="paragraph"> <p>Now, assuming you&#8217;ve already got Infinispan and its dependencies on your classpath, all that&#8217;s left to do is installing <code>infinispan-spring</code> and <code>spring</code>. For Maven users this translates into</p> </div> <div class="listingblock"> <div class="title">pom.xml for Spring 4</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml">Â Â Â Â  <span class="tag">&lt;dependency&gt;</span>
Â Â Â Â Â Â Â Â  <span class="tag">&lt;groupId&gt;</span>org.springframework<span class="tag">&lt;/groupId&gt;</span>
Â Â Â Â Â Â Â Â  <span class="tag">&lt;artifactId&gt;</span>spring-context<span class="tag">&lt;/artifactId&gt;</span>
Â Â Â Â Â Â Â Â  <span class="tag">&lt;version&gt;</span>4.1.1.RELEASE<span class="tag">&lt;/version&gt;</span>
Â Â Â Â Â  <span class="tag">&lt;/dependency&gt;</span>
Â Â Â Â Â  <span class="tag">&lt;dependency&gt;</span>
Â Â Â Â Â Â Â Â  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
Â Â Â Â Â Â Â Â  <span class="tag">&lt;artifactId&gt;</span>infinispan-spring4<span class="tag">&lt;/artifactId&gt;</span>
Â Â Â Â Â Â Â Â  <span class="tag">&lt;version&gt;</span>${infinispan.version}<span class="tag">&lt;/version&gt;</span>
Â Â Â Â Â  <span class="tag">&lt;/dependency&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="title">pom.xml for Spring 3</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml">Â Â Â Â  <span class="tag">&lt;dependency&gt;</span>
Â Â Â Â Â Â Â Â  <span class="tag">&lt;groupId&gt;</span>org.springframework<span class="tag">&lt;/groupId&gt;</span>
Â Â Â Â Â Â Â Â  <span class="tag">&lt;artifactId&gt;</span>spring-context<span class="tag">&lt;/artifactId&gt;</span>
Â Â Â Â Â Â Â Â  <span class="tag">&lt;version&gt;</span>3.2.9.RELEASE<span class="tag">&lt;/version&gt;</span>
Â Â Â Â Â  <span class="tag">&lt;/dependency&gt;</span>
Â Â Â Â Â  <span class="tag">&lt;dependency&gt;</span>
Â Â Â Â Â Â Â Â  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
Â Â Â Â Â Â Â Â  <span class="tag">&lt;artifactId&gt;</span>infinispan-spring<span class="tag">&lt;/artifactId&gt;</span>
Â Â Â Â Â Â Â Â  <span class="tag">&lt;version&gt;</span>${infinispan.version}<span class="tag">&lt;/version&gt;</span>
Â Â Â Â Â  <span class="tag">&lt;/dependency&gt;</span></code></pre> </div> </div> </div> <div class="sect3"> <h4 id="telling_spring_to_use_infinispan_as_its_caching_provider"><a class="anchor" href="#telling_spring_to_use_infinispan_as_its_caching_provider"></a>26.4.2. Telling Spring to use Infinispan as its caching provider</h4> <div class="paragraph"> <p>Spring cache provider SPI comprises two interfaces, <code>org.springframework.cache.CacheManager</code> and <code>org.springframework.cache.Cache</code> where a <code>CacheManager</code> serves as a factory for named <code>Cache</code> instances. By default Spring will look at runtime for a <code>CacheManager</code> implementation having the bean name "cacheManager" in an application&#8217;s application context. So by putting</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Infinispan cache manager --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cacheManager</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.spring.provider.SpringEmbeddedCacheManagerFactoryBean</span><span class="delimiter">&quot;</span></span>
<span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span><span class="error">Â </span> <span class="attribute-name">p:configurationFileLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:/org/infinispan/spring/provider/sample/books-infinispan-config.xml</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>or using java config:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@EnableCaching</span>
<span class="annotation">@Configuration</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {

   <span class="annotation">@Bean</span>
   <span class="directive">public</span> CacheManager cacheManager() {
      <span class="keyword">return</span> <span class="keyword">new</span> SpringEmbeddedCacheManager(infinispanCacheManager());
   }

   <span class="directive">private</span> EmbeddedCacheManager infinispanCacheManager() {
      <span class="keyword">return</span> <span class="keyword">new</span> DefaultCacheManager();
   }

}</code></pre> </div> </div> <div class="paragraph"> <p>somewhere in your application context you tell Spring to henceforth use Infinispan as its caching provider.</p> </div> </div> <div class="sect3"> <h4 id="adding_caching_to_your_application_code"><a class="anchor" href="#adding_caching_to_your_application_code"></a>26.4.3. Adding caching to your application code</h4> <div class="paragraph"> <p>As outlined above enabling caching in your application code is as simple as adding <code>@Cacheable</code> and <code>@CacheEvict</code> to select methods. Suppose you&#8217;ve got a DAO for, say, books and you want book instances to be cached once they&#8217;ve been loaded from the underlying database using <code>BookDao#findBook(Integer bookId)</code>. To that end you annotate <code>findBook(Integer bookId)</code> with <code>@Cacheable</code>, as in</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Transactional</span>
<span class="annotation">@Cacheable</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span>, key = <span class="string"><span class="delimiter">&quot;</span><span class="content">#bookId</span><span class="delimiter">&quot;</span></span>)
<span class="predefined-type">Book</span> findBook(<span class="predefined-type">Integer</span> bookId) {...}</code></pre> </div> </div> <div class="paragraph"> <p>This will tell Spring to cache Book instances returned from calls to <code>findBook(Integer bookId)</code> in a named cache "books", using the parameter&#8217;s "bookId" value as a cache key. Here, "#bookId" is an expression in the <a href="http://static.springsource.org/spring/docs/current/spring-framework-reference/html/expressions.html">Spring Expression Language</a> that evaluates to the <code>bookId</code> argument. If you don&#8217;t specify the <code>key</code> attribute Spring will generate a hash from the supplied method arguments - in this case only <code>bookId</code> - and use that as a cache key. Essentially, you relinquish control over what cache key to use to Spring. Which may or may not be fine depending on your application&#8217;s needs.Though the notion of actually deleting a book will undoubtedly seem alien and outright abhorrent to any sane reader there might come the time when your application needs to do just that. For whatever reason. In this case you will want for such a book to be removed not only from the underlying database but from the cache, too. So you annotate <code>deleteBook(Integer bookId)</code> with <code>@CacheEvict</code> as in</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Transactional</span>
<span class="annotation">@CacheEvict</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span>, key = <span class="string"><span class="delimiter">&quot;</span><span class="content">#bookId</span><span class="delimiter">&quot;</span></span>)
<span class="type">void</span> deleteBook(<span class="predefined-type">Integer</span> bookId) {...}</code></pre> </div> </div> <div class="paragraph"> <p>and you may rest assured that no stray books be left in your application once you decide to remove them.</p> </div> </div> <div class="sect3"> <h4 id="conclusion"><a class="anchor" href="#conclusion"></a>26.4.4. Conclusion</h4> <div class="paragraph"> <p>Hopefully you enjoyed our quick tour of Infinispan&#8217;s support for Spring&#8217;s cache abstraction and saw how easy it is for all your caching woes to be taken care of by Infinispan. More information may be found in Spring&#8217;s <a href="http://docs.spring.io/spring-framework/docs/4.1.1.RELEASE/spring-framework-reference/html/cache.html">reference documentation</a>. Also see <a href="http://spring.io/blog/2011/02/23/spring-3-1-m1-cache-abstraction">this link</a> - a very nice posting on the official Spring blog for a somewhat more comprehensive introduction to Spring&#8217;s cache abstraction.</p> </div> </div> </div> <div class="sect2"> <h3 id="infinispan_modules_for_jboss_as_7_x"><a class="anchor" href="#infinispan_modules_for_jboss_as_7_x"></a>26.5. Infinispan modules for JBoss AS 7.x</h3> <div class="paragraph"> <p>Since Infinispan 5.2, the distribution includes a set of modules for JBoss AS 7.x. By installing these modules, it is possible to deploy user applications without packaging the Infinispan JARs within the deployments (WARs, EARs, etc), thus minimizing their size. In order not to conflict with the Infinispan modules which are already present within an AS installation, the modules provided by the Infinispan distribution are located within their own slot identified by the <em>major.minor</em> versions (e.g. slot="5.2").</p> </div> <div class="paragraph"> <p>In order to tell the AS deployer that we want to use the Infinispan APIs within our application, we need to add explicit dependencies to the deployment&#8217;s MANIFEST:</p> </div> <div class="listingblock"> <div class="title">MANIFEST.MF</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="JSON"><span class="error">M</span><span class="error">a</span><span class="error">n</span><span class="error">i</span><span class="error">f</span><span class="error">e</span><span class="error">s</span><span class="error">t</span><span class="error">-</span><span class="error">V</span><span class="error">e</span><span class="error">r</span><span class="error">s</span><span class="error">i</span><span class="error">o</span><span class="error">n</span>: <span class="float">1.0</span>
<span class="error">D</span><span class="error">e</span><span class="error">p</span><span class="error">e</span><span class="error">n</span><span class="error">d</span><span class="error">e</span><span class="error">n</span><span class="error">c</span><span class="error">i</span><span class="error">e</span><span class="error">s</span>: <span class="error">o</span><span class="error">r</span><span class="error">g</span><span class="error">.</span><span class="error">i</span><span class="error">n</span><span class="error">f</span><span class="error">i</span><span class="error">n</span><span class="error">i</span><span class="error">s</span><span class="error">p</span><span class="error">a</span><span class="error">n</span>:<span class="float">5.2</span> <span class="error">s</span><span class="error">e</span><span class="error">r</span><span class="error">v</span><span class="error">i</span><span class="error">c</span><span class="error">e</span><span class="error">s</span></code></pre> </div> </div> <div class="paragraph"> <p>If you are using Maven to generate your artifacts, mark the Infinispan dependencies as <em>provided</em> and configure your artifact archiver to generate the appropriate MANIFEST.MF file:</p> </div> <div class="listingblock"> <div class="title">pom.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencies&gt;</span>
  <span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>infinispan-core<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>5.2.0.Final<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;scope&gt;</span>provided<span class="tag">&lt;/scope&gt;</span>
  <span class="tag">&lt;/dependency&gt;</span>
  <span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>infinispan-cachestore-jdbc<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>5.2.0.Final<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;scope&gt;</span>provided<span class="tag">&lt;/scope&gt;</span>
  <span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;build&gt;</span>
  <span class="tag">&lt;plugins&gt;</span>
     <span class="tag">&lt;plugin&gt;</span>
       <span class="tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/groupId&gt;</span>
       <span class="tag">&lt;artifactId&gt;</span>maven-war-plugin<span class="tag">&lt;/artifactId&gt;</span>
       <span class="tag">&lt;configuration&gt;</span>
         <span class="tag">&lt;archive&gt;</span>
           <span class="tag">&lt;manifestEntries&gt;</span>
             <span class="tag">&lt;Dependencies&gt;</span>org.infinispan:5.2 services, org.infinispan.cachestore.jdbc:5.2 services<span class="tag">&lt;/Dependencies&gt;</span>
           <span class="tag">&lt;/manifestEntries&gt;</span>
         <span class="tag">&lt;/archive&gt;</span>
      <span class="tag">&lt;/configuration&gt;</span>
    <span class="tag">&lt;/plugin&gt;</span>
  <span class="tag">&lt;/plugins&gt;</span>
<span class="tag">&lt;/build&gt;</span></code></pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="grid_file_system"><a class="anchor" href="#grid_file_system"></a>27. Grid File System</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan&#8217;s GridFileSystem is a new, experimental API that exposes an Infinispan-backed data grid as a file system.</p> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> This is an <em>experimental</em> API. Use at your own risk. </td> </tr> </table> </div> <div class="paragraph"> <p>Specifically, the API works as an extension to the JDK&#8217;s <a href="http://docs.oracle.com/javase/6/docs/api/java/io/File.html">File</a> , <a href="http://docs.oracle.com/javase/6/docs/api/java/io/InputStream.html">InputStream</a> and <a href="http://docs.oracle.com/javase/6/docs/api/java/io/OutputStream.html">OutputStream</a> classes: specifically, <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/io/GridFile.html">GridFile</a>, <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/io/GridInputStream.html">GridInputStream</a> and <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/io/GridOutputStream.html">GridOutputStream</a>. A helper class, <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/io/GridFilesystem.html">GridFilesystem</a>, is also included.</p> </div> <div class="paragraph"> <p>Essentially, the <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/io/GridFilesystem.html">GridFilesystem</a> is backed by 2 Infinispan caches - one for metadata (typically replicated) and one for the actual data (typically distributed). The former is replicated so that each node has metadata information locally and would not need to make RPC calls to list files, etc. The latter is distributed since this is where the bulk of storage space is used up, and a scalable mechanism is needed here. Files themselves are chunked and each chunk is stored as a cache entry, as a byte array.</p> </div> <div class="paragraph"> <p>Here is a quick code snippet demonstrating usage:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Cache&lt;<span class="predefined-type">String</span>,<span class="type">byte</span><span class="type">[]</span>&gt; data = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">distributed</span><span class="delimiter">&quot;</span></span>);
Cache&lt;<span class="predefined-type">String</span>,GridFile.Metadata&gt; metadata = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">replicated</span><span class="delimiter">&quot;</span></span>);
GridFilesystem fs = <span class="keyword">new</span> GridFilesystem(data, metadata);

<span class="comment">// Create directories</span>
<span class="predefined-type">File</span> file=fs.getFile(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/testfile/stuff</span><span class="delimiter">&quot;</span></span>);
fs.mkdirs(); <span class="comment">// creates directories /tmp/testfile/stuff</span>

<span class="comment">// List all files and directories under &quot;/usr/local&quot;</span>
file=fs.getFile(<span class="string"><span class="delimiter">&quot;</span><span class="content">/usr/local</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">File</span><span class="type">[]</span> files=file.listFiles();

<span class="comment">// Create a new file</span>
file=fs.getFile(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/testfile/stuff/README.txt</span><span class="delimiter">&quot;</span></span>);
file.createNewFile();</code></pre> </div> </div> <div class="paragraph"> <p>Copying stuff to the grid file system:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">InputStream</span> in=<span class="keyword">new</span> <span class="predefined-type">FileInputStream</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/my-movies/dvd-image.iso</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">OutputStream</span> out=fs.getOutput(<span class="string"><span class="delimiter">&quot;</span><span class="content">/grid-movies/dvd-image.iso</span><span class="delimiter">&quot;</span></span>);
<span class="type">byte</span><span class="type">[]</span> buffer=<span class="keyword">new</span> <span class="type">byte</span>[<span class="integer">20000</span>];
<span class="type">int</span> len;
<span class="keyword">while</span>((len=in.read(buffer, <span class="integer">0</span>, buffer.length)) != -<span class="integer">1</span>) out.write(buffer, <span class="integer">0</span>, len);
in.close();
out.close();</code></pre> </div> </div> <div class="paragraph"> <p>Reading stuff from the grid:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">InputStream</span> in=in.getInput(<span class="string"><span class="delimiter">&quot;</span><span class="content">/grid-movies/dvd-image.iso</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">OutputStream</span> out=<span class="keyword">new</span> <span class="predefined-type">FileOutputStream</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/my-movies/dvd-image.iso</span><span class="delimiter">&quot;</span></span>);
<span class="type">byte</span><span class="type">[]</span> buffer=<span class="keyword">new</span> <span class="type">byte</span>[<span class="integer">200000</span>];
<span class="type">int</span> len;
<span class="keyword">while</span>((len=in.read(buffer, <span class="integer">0</span>, buffer.length)) != -<span class="integer">1</span>) out.write(buffer, <span class="integer">0</span>, len);
in.close();
out.close();</code></pre> </div> </div> <div class="sect2"> <h3 id="webdav_demo"><a class="anchor" href="#webdav_demo"></a>27.1. WebDAV demo</h3> <div class="paragraph"> <p>Infinispan ships with a demo <a href="http://en.wikipedia.org/wiki/WebDAV">WebDAV</a> application that makes use of the grid file system APIs. This demo app is packaged as a <a href="http://en.wikipedia.org/wiki/WAR_(Sun_file_format)">WAR</a> file which can be deployed in a servlet container, such as JBoss AS or Tomcat, and exposes the grid as a file system over WebDAV. This could then be mounted as a remote drive on your operating system.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="CrossSiteReplication"><a class="anchor" href="#CrossSiteReplication"></a>28. Cross site replication</h2> <div class="sectionbody"> <div class="paragraph"> <p>Cross site (x-site) replication allows backing up the data from one cluster to other clusters, potentially situated in different geographical location. The cross-site replication is built on top of JGroups' <a href="http://www.jgroups.org/manual-3.x/html/user-advanced.html#Relay2Advanced">RELAY2 protocol</a> . <a href="https://community.jboss.org/wiki/DesignForCrossSiteReplication">This document</a> describes the technical design of cross site replication in more detail.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Cross site replication needs the backup cache running in the site master node(s) (i.e. node which receives the backup and applies it). The backup cache starts automatically when it receives the first backup request. </td> </tr> </table> </div> <div class="sect2"> <h3 id="sample_deployment"><a class="anchor" href="#sample_deployment"></a>28.1. Sample deployment</h3> <div class="paragraph"> <p>The diagram below depicts a possible setup of replicated sites, followed by a description of individual elements present in the deployment. Options are then explained at large in future paragraphs. Comments on the diagram above:</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/xdc.png" alt="xdc"> </div> </div> <div class="ulist"> <ul> <li> <p>there are 3 sites: LON, NYC and SFO.</p> </li> <li> <p>in each site there is a running Infinispan cluster with a (potentially) different number of physical nodes: 3 nodes in LON, 4 nodes in NYC and 3 nodes in SFO</p> </li> <li> <p>the "users" cache is active in LON, NYC and SFO. Updates on the "users" cache in any of these sites gets replicated to the other sites as well</p> </li> <li> <p>it is possible to use different replication mechanisms between sites. E.g. One can configure SFO to backup data synchronously to NYC and asynchronously to LON</p> </li> <li> <p>the "users" cache can have a different configuration from one site to the other. E.g. it might be configured as distributed with numOwners=2 in the LON site, REPL in the NYC site and distributed with numOwners=1 in the SFO site</p> </li> <li> <p>JGroups is used for both inter-site and intra-site communication. <a href="http://www.jgroups.org/manual-3.x/html/user-advanced.html#Relay2Advanced">RELAY2</a> is used for inter-site communication</p> </li> <li> <p>"orders" is a site local to LON, i.e. updates to the data in "orders" don&#8217;t get replicated to the remote sites The following sections discuss specific aspects of cross site replication into more detail. The foundation of the cross-site replication functionality is RELAY2 so it highly recommended to read JGroups' <a href="http://www.jgroups.org/manual-3.x/html/user-advanced.html#Relay2Advanced">RELAY2</a> documentation before moving on into cross-site. Configuration</p> </li> </ul> </div> <div class="paragraph"> <p>The cross-site replication configuration spreads over the following files:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>the backup policy for each individual cache is defined in infinispan&#8217;s .xml configuration file (<a href="https://gist.github.com/maniksurtani/cdd5420af764c907e342">infinispan.xml</a>)</p> </li> <li> <p>cluster&#8217;s JGroups xml configuration file: <a href="http://www.jgroups.org/manual-3.x/html/user-advanced.html#Relay2Advanced">RELAY2</a> protocol needs to be added to the JGroups protocol stack (<a href="https://gist.github.com/maniksurtani/409fe5ece5fe4bcf679f">jgroups.xml</a>)</p> </li> <li> <p>RELAY2 configuration file: RELAY2 has an own configuration file ( <a href="https://gist.github.com/maniksurtani/8c7238dae7921d2c883e">relay2.xml</a> )</p> </li> <li> <p>the JGroups channel that is used by RELAY2 has its own configuration file (<a href="https://gist.github.com/maniksurtani/cbc1a297a367b1176feb">jgroups-relay2.xml</a>) Infinispan XML configuration file</p> </li> </ol> </div> <div class="paragraph"> <p>The local site is defined in the the global configuration section. The local is the site where the node using this configuration file resides (in the example above local site is "LON").</p> </div> <div class="listingblock"> <div class="title">infinispan.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;transport</span> <span class="attribute-name">site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LON</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The same setup can be achieved programatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder lonGc = GlobalConfigurationBuilder.defaultClusteredBuilder();
lonGc.site().localSite(<span class="string"><span class="delimiter">&quot;</span><span class="content">LON</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>The names of the site (case sensitive) should match the name of a site as defined within JGroups' RELAY2 protocol configuration file. Besides the global configuration, each cache specifies its backup policy in the "site" element:</p> </div> <div class="listingblock"> <div class="title">infinispan.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;backups&gt;</span>
    <span class="tag">&lt;backup</span> <span class="attribute-name">site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NYC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">failure-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">WARN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">strategy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">12000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;backup</span> <span class="attribute-name">site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SFO</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">failure-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">IGNORE</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">strategy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ASYNC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;backup</span> <span class="attribute-name">site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LON</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">strategy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/backups&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The "users" cache backups its data to the "NYC" and "SFO" sites. Even though the "LON" appears as a backup site, it has the "enabled" attribute set to <em>false</em> so it will be ignored . For each site backup, the following configuration attributes can be specified:</p> </div> <div class="ulist"> <ul> <li> <p><em>strategy</em> - the strategy used for backing up data, either "SYNC" or "ASYNC". Defaults to "ASYNC"</p> </li> <li> <p><em>failure-policy</em> - Decides what the system would do in case of failure during backup. Possible values are:</p> <div class="ulist"> <ul> <li> <p><em>IGNORE</em> - allow the local operation/transaction to succeed</p> </li> <li> <p><em>WARN</em> - same as IGNORE but also logs a warning message. Default.</p> </li> <li> <p><em>FAIL</em> - only in effect if "strategy" is "SYNC" - fails local cluster operation/transaction by throwing an exception to the user</p> </li> <li> <p><em>CUSTOM</em> - user provided, see "failurePolicyClass" below</p> </li> </ul> </div> </li> <li> <p>failurePolicyClass - If the 'failure-policy' is set to 'CUSTOM' then this attribute is required and should contain the fully qualified name of a class implementing org.infinispan.xsite.CustomFailurePolicy</p> </li> <li> <p>timeout - The timeout(milliseconds) to be used when backing up data remotely. Defaults to 10000 (10 seconds)</p> </li> </ul> </div> <div class="paragraph"> <p>The same setup can be achieved programatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder lon = <span class="keyword">new</span> ConfigurationBuilder();
lon.sites().addBackup()
      .site(<span class="string"><span class="delimiter">&quot;</span><span class="content">NYC</span><span class="delimiter">&quot;</span></span>)
      .backupFailurePolicy(BackupFailurePolicy.WARN)
      .strategy(BackupConfiguration.BackupStrategy.SYNC)
      .replicationTimeout(<span class="integer">12000</span>)
      .sites().addInUseBackupSite(<span class="string"><span class="delimiter">&quot;</span><span class="content">NYC</span><span class="delimiter">&quot;</span></span>)
    .sites().addBackup()
      .site(<span class="string"><span class="delimiter">&quot;</span><span class="content">SFO</span><span class="delimiter">&quot;</span></span>)
      .backupFailurePolicy(BackupFailurePolicy.IGNORE)
      .strategy(BackupConfiguration.BackupStrategy.ASYNC)
      .sites().addInUseBackupSite(<span class="string"><span class="delimiter">&quot;</span><span class="content">SFO</span><span class="delimiter">&quot;</span></span>)</code></pre> </div> </div> <div class="paragraph"> <p>The "users" cache above doesn&#8217;t know on which cache on the remote sites its data is being replicated. By default the remote site writes the backup data to a cache having the same name as the originator, i.e. "users". This behaviour can be overridden with an "backupFor" element. For example the following configuration in SFO makes the "usersLONBackup" cache act as the backup cache for the "users" cache defined above in the LON site:</p> </div> <div class="listingblock"> <div class="title">infinispan.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
  <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">usersLONBackup</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;backup-for</span> <span class="attribute-name">remote-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">remote-site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LON</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;/distributed-cache&gt;</span>
  <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The same setup can be achieved programatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder cb = <span class="keyword">new</span> ConfigurationBuilder();
cb.sites().backupFor().remoteCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span>).remoteSite(<span class="string"><span class="delimiter">&quot;</span><span class="content">LON</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="sect3"> <h4 id="local_cluster_s_jgroups_xml_configuration"><a class="anchor" href="#local_cluster_s_jgroups_xml_configuration"></a>28.1.1. Local cluster&#8217;s jgroups .xml configuration</h4> <div class="paragraph"> <p>This is the configuration file for the local (intra-site) infinispan cluster. It is referred from the infinispan configuration file, see "configurationFile" below:</p> </div> <div class="listingblock"> <div class="title">infinispan.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
  <span class="tag">&lt;jgroups&gt;</span>
     <span class="tag">&lt;stack-file</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">external-file</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/jgroups&gt;</span>
Â  <span class="tag">&lt;cache-container&gt;</span>
Â Â Â  <span class="tag">&lt;transport</span> <span class="attribute-name">stack</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">external-file</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
Â  <span class="tag">&lt;/cache-container&gt;</span>

Â  ...

<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>In order to allow inter-site calls, the RELAY2 protocol needs to be added to the protocol stack defined in the jgroups configuration (see attached <a href="https://gist.github.com/maniksurtani/409fe5ece5fe4bcf679f">jgroups.xml</a> for an example).</p> </div> </div> <div class="sect3"> <h4 id="relay2_configuration_file"><a class="anchor" href="#relay2_configuration_file"></a>28.1.2. RELAY2 configuration file</h4> <div class="paragraph"> <p>The RELAY2 configuration file is linked from the jgroups.xml (see attached <a href="https://gist.github.com/maniksurtani/8c7238dae7921d2c883e">relay2.xml</a>). It defines the sites seen by this cluster and also the JGroups configuration file that is used by RELAY2 in order to communicate with the remote sites.</p> </div> </div> </div> <div class="sect2"> <h3 id="data_replication"><a class="anchor" href="#data_replication"></a>28.2. Data replication</h3> <div class="paragraph"> <p>For both transactional and non-transactional caches, the backup calls are performed in parallel with local cluster calls, e.g. if we write data to node N1 in LON then replication to the local nodes N2 and N3 and remote backup sites SFO and NYC happen in parallel.</p> </div> <div class="sect3"> <h4 id="non_transactional_caches_2"><a class="anchor" href="#non_transactional_caches_2"></a>28.2.1. Non transactional caches</h4> <div class="paragraph"> <p>In the case of non-transactional caches the replication happens during each operation. Given that data is sent in parallel to backups and local caches, it is possible for the operations to succeed locally and fail remotely, or the other way, causing inconsistencies</p> </div> </div> <div class="sect3"> <h4 id="transactional_caches"><a class="anchor" href="#transactional_caches"></a>28.2.2. Transactional caches</h4> <div class="paragraph"> <p>For synchronous transactional caches, Infinispan internally uses a two phase commit protocol: lock acquisition during the 1st phase (prepare) and apply changes during the 2nd phase (commit). For asynchronous caches the two phases are merged, the "apply changes" message being sent asynchronously to the owners of data. This 2PC protocol maps to 2PC received from the JTA transaction manager. For transactional caches, both optimistic and pessimistic, the backup to remote sites happens during the prepare and commit phase only.</p> </div> <div class="sect4"> <h5 id="synchronous_local_cluster_with_async_backup"><a class="anchor" href="#synchronous_local_cluster_with_async_backup"></a>Synchronous local cluster with async backup</h5> <div class="paragraph"> <p>In this scenario the backup call happens during local commit phase(2nd phase). That means that if the local prepare fails, no remote data is being sent to the remote backup.</p> </div> </div> <div class="sect4"> <h5 id="synchronous_local_cluster_with_sync_backup"><a class="anchor" href="#synchronous_local_cluster_with_sync_backup"></a>Synchronous local cluster with sync backup</h5> <div class="paragraph"> <p>In this case there are two backup calls:</p> </div> <div class="ulist"> <ul> <li> <p>during prepare a message is sent across containing all the modifications that happened within this transaction</p> </li> <li> <p>if the remote backup cache is transactional then a transaction is started remotely and all these modifications are being written within this transaction&#8217;s scope. The transaction is not committed yet (see below)</p> </li> <li> <p>if the remote backup cache is not transactional, then the changes are applied remotely</p> </li> <li> <p>during the commit/rollback, a commit/rollback message is sent across</p> </li> <li> <p>if the remote backups cache is transactional then the transaction started at the previous phase is committed/rolled back</p> </li> <li> <p>if the remote backup is not transactional then this call is ignored</p> </li> </ul> </div> <div class="paragraph"> <p>Both the local and the backup call(if the "backupFailurePolicy" is set to "FAIL") can veto transaction&#8217;s prepare outcome</p> </div> </div> <div class="sect4"> <h5 id="asynchronous_local_cluster"><a class="anchor" href="#asynchronous_local_cluster"></a>Asynchronous local cluster</h5> <div class="paragraph"> <p>In the case of asynchronous local clusters, the backup data is sent during the commit phase. If the backup call fails and the "backupFailurePolicy" is set to "FAIL" then the user is notified through an exception.</p> </div> </div> </div> </div> <div class="sect2"> <h3 id="taking_a_site_offline"><a class="anchor" href="#taking_a_site_offline"></a>28.3. Taking a site offline</h3> <div class="paragraph"> <p>If backing up to a site fails for a certain number of times during a time interval, then it is possible to automatically mark that site as offline. When a site is marked as offline the local site won&#8217;t try to backup data to it anymore. In order to be taken online a system administrator intervention being required.</p> </div> <div class="sect3"> <h4 id="configuration_15"><a class="anchor" href="#configuration_15"></a>28.3.1. Configuration</h4> <div class="paragraph"> <p>The taking offline of a site can be configured as follows:</p> </div> <div class="listingblock"> <div class="title">infinispan.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bestEffortBackup</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   ...
   <span class="tag">&lt;backups&gt;</span>
     <span class="tag">&lt;backup</span> <span class="attribute-name">site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NYC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">strategy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">failure-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAIL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;take-offline</span> <span class="attribute-name">after-failures</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">500</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">min-wait</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;/backup&gt;</span>
   <span class="tag">&lt;/backups&gt;</span>
    ...
<span class="tag">&lt;/replicated-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The <em>take-offline</em> element under the <em>backup</em> configures the taking offline of a site:</p> </div> <div class="ulist"> <ul> <li> <p><em>after-failures</em> - the number of failed backup operations after which this site should be taken offline. Defaults to 0 (never). A negative value would mean that the site will be taken offline after <em>minTimeToWait</em></p> </li> <li> <p><em>min-wait</em> - the number of milliseconds in which a site is not marked offline even if it is unreachable for 'afterFailures' number of times. If smaller or equal to 0, then only <em>afterFailures</em> is considered.</p> </li> </ul> </div> <div class="paragraph"> <p>The equivalent programmatic configuration is:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">lon.sites().addBackup()
      .site(<span class="string"><span class="delimiter">&quot;</span><span class="content">NYC</span><span class="delimiter">&quot;</span></span>)
      .backupFailurePolicy(BackupFailurePolicy.FAIL)
      .strategy(BackupConfiguration.BackupStrategy.SYNC)
      .takeOffline()
         .afterFailures(<span class="integer">500</span>)
         .minTimeToWait(<span class="integer">10000</span>);</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="taking_a_site_back_online"><a class="anchor" href="#taking_a_site_back_online"></a>28.3.2. Taking a site back online</h4> <div class="paragraph"> <p>In order to bring a site back online after being taken offline, one can use the JMX console and invoke the "bringSiteOnline(siteName)" operation on the <em>XSiteAdmin</em> managed bean. At the moment this method would need to be invoked on all the nodes within the site(further releases will overcome this limitation).</p> </div> </div> </div> <div class="sect2"> <h3 id="state_transfer_between_sites"><a class="anchor" href="#state_transfer_between_sites"></a>28.4. State Transfer between sites</h3> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> This feature is available since Infinispan <strong>7.0.0.Alpha2</strong> </td> </tr> </table> </div> <div class="paragraph"> <p>When a new site is bough back online, it is necessary to re-sync the site with the most recent updates. This feature allows state to be transferred from one site to another.</p> </div> <div class="paragraph"> <p>The state transfer is triggered manually by a system administrator (or other responsible entity) via JMX. The operation can be found over the XSiteAdminOperations managed bean and it is named pushState(String). The system administrator should invoke this operation in the provider site (i.e. the site that will send the state) and set the name of the consumer site (i.e. the site that will receive the state). The figure below shows where to find the pushState(String) operation using JConsole:</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/xsite-state-transfer.png" alt="JConsole pushState operation" width="720" height="495"> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> The pushState(siteName) operation will automatically bring the new site online. The system administrator does not need to bring the site online first. </td> </tr> </table> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> The receiver site can only receive state from a single site. </td> </tr> </table> </div> <div class="paragraph"> <p>The consumer site can be in any state (online or offline) in respect to the provider site and the system administrator can trigger the push state at any time. The system will ignore multiple invocations if the provider site is already pushing state to the consumer site.</p> </div> <div class="paragraph"> <p>It is worth to refer that it is not necessary to consumer site to be in an empty state. But be aware, the existing keys can be overwritten but they are never deleted. In other words, if a key K does not exists in the provider site but it exists in consumer site, it will not be deleted. In other way, if a key K exists in both sites, it will be overwritten in the consumer site.</p> </div> <div class="sect3"> <h4 id="handling_join_leave_nodes"><a class="anchor" href="#handling_join_leave_nodes"></a>28.4.1. Handling join/leave nodes</h4> <div class="paragraph"> <p>The current implementation automatically handles the topology changes in producer or consumer site. Also, the cross-site state transfer can run in parallel with a local site state transfer.</p> </div> </div> <div class="sect3"> <h4 id="handling_broken_link_between_sites"><a class="anchor" href="#handling_broken_link_between_sites"></a>28.4.2. Handling broken link between sites</h4> <div class="paragraph"> <p>A System Administrator action is needed if the link between the producer and consumer site is broken during the cross-site state transfer (data consistency is not ensured in consumer site). The producer site retries for a while before giving up. Then, it gets back to normal state. However, the consumer site is not able to get back to normal state and, here, an action from System Administrator is need. The System Administrator should use the operation cancelReceiveState(String siteName) to bring the consumer site to normal state.</p> </div> </div> <div class="sect3"> <h4 id="system_administrator_operations"><a class="anchor" href="#system_administrator_operations"></a>28.4.3. System Administrator Operations</h4> <div class="paragraph"> <p>A set of operations can be performed to control the cross-site state transfer:</p> </div> <div class="ulist"> <ul> <li> <p>pushState(String siteName) - It starts the cross-site state transfer to the site name specified;</p> </li> <li> <p>cancelPushState(String siteName) - It cancels the cross-site state transfer to the site name specified;</p> </li> <li> <p>getRunningStateTransfer() - It returns a list of site name to which this site is pushing the state;</p> </li> <li> <p>getSendingSiteName() - It returns the site name that is pushing state to this site;</p> </li> <li> <p>cancelReceiveState(String siteName) - It restores the site to normal state. Should be used when the link between the sites is broken during the state transfer (as described above);</p> </li> <li> <p>getPushStateStatus() - It returns the status of completed cross-site state transfer;</p> </li> <li> <p>clearPushStateStatus() - It clears the status of completed cross-site state transfer.</p> </li> </ul> </div> <div class="paragraph"> <p>For more technical information, you can check the Cross Site design document (See <a href="#x-site-reference">Reference</a>).</p> </div> </div> <div class="sect3"> <h4 id="x-site-st-configuration"><a class="anchor" href="#x-site-st-configuration"></a>28.4.4. Configuration</h4> <div class="paragraph"> <p>State transfer between sites cannot be enabled or disabled but it allows to tune some parameters. The values shown below are the default values:</p> </div> <div class="listingblock"> <div class="title">infinispan.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xSiteStateTransfer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   ...
   <span class="tag">&lt;backups&gt;</span>
      <span class="tag">&lt;backup</span> <span class="attribute-name">site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NYC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">strategy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">failure-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAIL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;state-transfer</span> <span class="attribute-name">chunk-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">512</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1200000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-retries</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">30</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">wait-time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;/backup&gt;</span>
   <span class="tag">&lt;/backups&gt;</span>
    ...
<span class="tag">&lt;/replicated-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The equivalent programmatic configuration is:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">lon.sites().addBackup()
      .site(<span class="string"><span class="delimiter">&quot;</span><span class="content">NYC</span><span class="delimiter">&quot;</span></span>)
      .backupFailurePolicy(BackupFailurePolicy.FAIL)
      .strategy(BackupConfiguration.BackupStrategy.SYNC)
      .stateTransfer()
         .chunkSize(<span class="integer">512</span>)
         .timeout(<span class="integer">1200000</span>)
         .maxRetries(<span class="integer">30</span>)
         .waitingTimeBetweenRetries(<span class="integer">2000</span>);</code></pre> </div> </div> <div class="paragraph"> <p>Below, it is the parameters description:</p> </div> <div class="ulist"> <ul> <li> <p><em>chunk-size</em> - The number of keys to batch before sending them to the consumer site. A negative or a zero value is <strong>not</strong> a valid value. Default value is 512 keys.</p> </li> <li> <p><em>timeout</em> - The time (in milliseconds) to wait for the consumer site acknowledge the reception and appliance of a state chunk. A negative or zero value is <strong>not</strong> a valid value. Default value is 20 minutes.</p> </li> <li> <p><em>max-retries</em> - The maximum number of retries when a push state command fails. A negative or a zero value means that the command will not retry in case of failure. Default value is 30.</p> </li> <li> <p><em>wait-time</em> - The waiting time (in milliseconds) between each retry. A negative or a zero value is <strong>not</strong> a valid value. Default value is 2 seconds.</p> </li> </ul> </div> </div> </div> <div class="sect2"> <h3 id="x-site-reference"><a class="anchor" href="#x-site-reference"></a>28.5. Reference</h3> <div class="paragraph"> <p><a href="https://community.jboss.org/wiki/DesignForCrossSiteReplication">This document</a> (Sept 2012) describes the technical design of cross site replication in more detail.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="_Rolling_chapter"><a class="anchor" href="#_Rolling_chapter"></a>29. Rolling upgrades</h2> <div class="sectionbody"> <div class="paragraph"> <p>Rolling upgrades is the process by which an Infinispan installation is upgraded without a service shutdown. In the case of Infinispan library/embedded mode, it refers to an installation to the nodes where Infinispan is running in library/embedded mode. For Infinispan servers, it refers to the server side components, not the client side. The upgrade could involve hardware change, or software change, such as upgrading the Infinispan version in use.</p> </div> <div class="paragraph"> <p>Rolling upgrades can be done in Infinispan installations using Infinispan in embedded or library mode, or in server mode. Here are the instructions for each use case:</p> </div> <div class="sect2"> <h3 id="rolling_upgrades_for_infinispan_library_embedded_mode"><a class="anchor" href="#rolling_upgrades_for_infinispan_library_embedded_mode"></a>29.1. Rolling upgrades for Infinispan library/embedded mode</h3> <div class="paragraph"> <p>Rolling upgrades for Infinispan library/embedded mode are done taking advantage of the Command-Line Interface (CLI) that Infinispan provides in order to interact with a remote Infinispan cluster. When a new cluster is started, it will get the data from the existing cluster using the CLI, so the existing cluster must be ready to receive CLI requests. Please check the <a href="#_CLI_chapter">Command-Line Interface (CLI) chapter</a> for information on how to set up a cluster to receive CLI requests.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Rolling upgrades for Infinispan library/embedded mode are only supported for caches using standard JDK types as keys. Custom keys are not currently supported. Custom value types are supported, using JSON as the format to ship them between source and target cluster. </td> </tr> </table> </div> <div class="sect3"> <h4 id="steps"><a class="anchor" href="#steps"></a>29.1.1. Steps</h4> <div class="olist arabic"> <ol class="arabic"> <li> <p>Start a new cluster ( <em>Target Cluster</em> ) with the new version of Infinispan, using either different network settings or JGroups cluster name so that the old cluster ( <em>Source Cluster</em> ) and the new one don&#8217;t overlap.</p> </li> <li> <p>For each cache to be migrated, the <em>Target Cluster</em> is configured with a Command-Line Interface cache loader which will retrieve data from the source cluster, with these settings:</p> </li> <li> <p><em>connection</em>: JMX connection string to use to connect to <em>Source Cluster</em>. The connection string specifies how to connect to one of the source cluster members. Connection to one of the nodes is enough, there&#8217;s no need to specify connection information for all nodes in the <em>Source Cluster</em>. The connection URL contains cache name information and this name must coincide with the name of the cache on the Source Cluster. The URL might change depending on the set up, check the Command-Line Interface chapter for more information. Here is a sample connection value: <code>jmx://1.1.1.1:4444/MyCacheManager/myCache</code></p> </li> <li> <p>Configure clients to point to the <em>Target Cluster</em> instead of the <em>Source Cluster</em> , and one by one, restart each client node. Gradually, all requests will be handled by the <em>Target Cluster</em> rather than the <em>Source Cluster</em> . The <em>Target Cluster</em> will lazily load data from the <em>Source Cluster</em> on demand via the Command-Line Interface cache loader.</p> </li> <li> <p>Once all connections have switched to using the <em>Target Cluster</em> the keyset on the <em>Source Cluster</em> must be dumped. This can be achieved either via a JMX operation or via the CLI:</p> </li> <li> <p>JMX: invoke the <em>recordKnownGlobalKeyset</em> operation on the <em>RollingUpgradeManager</em> MBean on the <em>Source Cluster</em> for all of the caches that need to be migrated</p> </li> <li> <p>CLI: invoke the <em>upgrade --dumpkeys</em> command on the <em>Source Cluster</em> for all of the caches that need to be migrated (additionally the <em>--all</em> switch can be used to dump all caches in the cluster)</p> </li> <li> <p>At this point the <em>Target Cluster</em> needs to fetch all remaining data from the <em>Source Cluster</em> :</p> </li> <li> <p>JMX: invoke the <em>synchronizeData</em> operation specifying the "cli" parameter on the <em>RollingUpgradeManager</em> MBean on the <em>Target Cluster</em> for all of the caches that need to be migrated</p> </li> <li> <p>CLI: invoke the <em>upgrade --synchronize=cli</em> command on the <em>Target Cluster</em> for all of the caches that need to be migrated (additionally the <em>--all</em> switch can be used to synchronize all caches in the cluster)</p> </li> <li> <p>Once the above operation is complete, the <em>CLInterfaceLoader</em> on the <em>Target Cluster</em> must be disabled as follows:</p> </li> <li> <p>JMX: invoke the <em>disconnectSource</em> operation specifying the "cli" parameter on the <em>RollingUpgradeManager</em> MBean on the <em>Target Cluster</em> for all of the caches that have been migrated</p> </li> <li> <p>CLI: invoke the <em>upgrade --disconnectsource=cli</em> command on the <em>Target Cluster</em> for all of the caches that have been migrated (additionally the <em>--all</em> switch can be used to disconnect all caches in the cluster)</p> </li> <li> <p>The <em>Source Cluster</em> can be decomissioned now.</p> </li> </ol> </div> </div> </div> <div class="sect2"> <h3 id="rolling_upgrades_for_infinispan_servers"><a class="anchor" href="#rolling_upgrades_for_infinispan_servers"></a>29.2. Rolling upgrades for Infinispan Servers</h3> <div class="paragraph"> <p>This process is used for installations making use of Infinispan as a remote grid, via Hot Rod. This assumes an upgrade of the Infinispan grid, and <em>not</em> the client application.</p> </div> <div class="paragraph"> <p>In the following description we will refer to the Source and Target clusters, where the Source cluster is the old cluster which is currently in use and the Target cluster is the new cluster to which the data will be migrated to.</p> </div> </div> <div class="sect2"> <h3 id="steps_2"><a class="anchor" href="#steps_2"></a>29.3. Steps</h3> <div class="olist arabic"> <ol class="arabic"> <li> <p>Start a new cluster ( <em>Target Cluster</em> ) with the new version of Infinispan, using either different network settings or JGroups cluster name so that the old cluster ( <em>Source Cluster</em> ) and the new one don&#8217;t overlap.</p> </li> <li> <p>For each cache to be migrated, the <em>Target Cluster</em> is configured with a RemoteCacheStore with the following settings:</p> <div class="olist loweralpha"> <ol class="loweralpha" type="a"> <li> <p><em>servers</em> should point to the <em>Source Cluster</em></p> </li> <li> <p><em>remoteCacheName</em> must coincide with the name of the cache on the <em>Source Cluster</em></p> </li> <li> <p><em>hotRodWrapping</em> must be enabled ( <em>true</em> )</p> </li> <li> <p><em>shared</em> should be <em>true</em></p> </li> </ol> </div> </li> <li> <p>Configure clients to point to the <em>Target Cluster</em> instead of the <em>Source Cluster</em> , and one by one, restart each client node. Gradually, all requests will be handled by the <em>Target Cluster</em> rather than the <em>Source Cluster</em> . The <em>Target Cluster</em> will lazily load data from the <em>Source Cluster</em> on demand via the RemoteCacheStore.</p> </li> <li> <p>If the <em>Source Cluster</em> version is <strong>older than 8.2</strong>, its keyset must be dumped. This can be achieved either via a JMX operation or via the CLI:</p> <div class="olist loweralpha"> <ol class="loweralpha" type="a"> <li> <p>JMX: invoke the <em>recordKnownGlobalKeyset</em> operation on the <em>RollingUpgradeManager</em> MBean on the <em>Source Cluster</em> for all of the caches that need to be migrated</p> </li> <li> <p>CLI: invoke the <em>upgrade --dumpkeys</em> command on the <em>Source Cluster</em> for all of the caches that need to be migrated (additionally the <em>--all</em> switch can be used to dump all caches in the cluster)</p> </li> </ol> </div> </li> <li> <p>At this point the <em>Target Cluster</em> needs to fetch all remaining data from the <em>Source Cluster</em> . This can be achieved either via a JMX operation or via the CLI:</p> <div class="olist loweralpha"> <ol class="loweralpha" type="a"> <li> <p>JMX: invoke the <em>synchronizeData</em> operation specifying the "hotrod" parameter on the <em>RollingUpgradeManager</em> MBean on the <em>Target Cluster</em> for all of the caches that need to be migrated</p> </li> <li> <p>CLI: invoke the <em>upgrade --synchronize=hotrod</em> command on the <em>Target Cluster</em> for all of the caches that need to be migrated (additionally the <em>--all</em> switch can be used to synchronize all caches in the cluster)</p> </li> </ol> </div> </li> <li> <p>Once the above operation is complete, the <em>RemoteCacheStore</em> on the <em>Target Cluster</em> must be disabled either via JMX or CLI:</p> <div class="olist loweralpha"> <ol class="loweralpha" type="a"> <li> <p>JMX: invoke the <em>disconnectSource</em> operation specifying the "hotrod" parameter on the <em>RollingUpgradeManager</em> MBean on the <em>Target Cluster</em> for all of the caches that have been migrated</p> </li> <li> <p>CLI: invoke the <em>upgrade --disconnectsource=hotrod</em> command on the <em>Target Cluster</em> for all of the caches that have been migrated (additionally the <em>--all</em> switch can be used to disconnect all caches in the cluster)</p> </li> </ol> </div> </li> <li> <p>The <em>Source Cluster</em> can be decomissioned now.</p> </li> </ol> </div> </div> </div> </div> <div class="sect1"> <h2 id="infinispan_command_line_console"><a class="anchor" href="#infinispan_command_line_console"></a>30. Infinispan Command-line Console</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan ships with a command-line console which can be used to interact with a running grid.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Documentation for ispncon version 0.8.1 </td> </tr> </table> </div> <div class="sect2"> <h3 id="what_is_ispncon"><a class="anchor" href="#what_is_ispncon"></a>30.1. What is ispncon ?</h3> <div class="paragraph"> <p>Ispncon (Infinispan Command-Line Console) is a simple command-line interface to infinispan cache written in python. It accesses the cache in client/server fashion, requiring one of the Infinispan <a href="#_server_modules">server modules</a> to have to be properly configured. Once you have a running instance of Infinispan with one of the server modules, you can issue simple cache requests via command line, like:</p> </div> <div class="literalblock"> <div class="content"> <pre>$ ispncon put keyA "Sample value under keyA"
$ ispncon get keyA
$ ispncon delete keyA</pre> </div> </div> <div class="paragraph"> <p>Furthermore it creates an abstraction above the specifics of the client/server protocol you use to access the cache. The basic commands look the same whether you use Hot Rod, memcached or REST. The client/protocol specifics are handled via protocol-specific configuration options or command arguments.</p> </div> <div class="paragraph"> <p>Your shell scripts should look basically the same for all the client modes, if you don&#8217;t use any protocol specific features.</p> </div> <div class="paragraph"> <p>Behind the scenes the console tool uses existing python clients to handle the communication with particular server modules. The implementations are listed in the following table:</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 33%;"> <col style="width: 33%;"> <col style="width: 33%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Client</em></th> <th class="tableblock halign-left valign-top"><em>Client implementation</em></th> <th class="tableblock halign-left valign-top"><em>Web</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Hot Rod</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">python-client for hotrod</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/infinispan/python-client" class="bare">https://github.com/infinispan/python-client</a></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Memcached</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">python-memcached</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://launchpad.net/python-memcached" class="bare">https://launchpad.net/python-memcached</a></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">REST</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">httplib (standard module for python)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://docs.python.org/library/httplib.html" class="bare">http://docs.python.org/library/httplib.html</a></p></td> </tr> </tbody> </table> <div class="paragraph"> <p>The source code and issue reporting for ispncon can be found here: <a href="https://github.com/infinispan/ispncon" class="bare">https://github.com/infinispan/ispncon</a></p> </div> </div> <div class="sect2"> <h3 id="installation"><a class="anchor" href="#installation"></a>30.2. Installation</h3> <div class="paragraph"> <p>Ispncon requires</p> </div> <div class="ulist"> <ul> <li> <p>python 2.6</p> </li> <li> <p>python modules: python-devel, setuptools, infinispan, python-memcached</p> </li> </ul> </div> <div class="paragraph"> <p>Installation steps:</p> </div> <div class="literalblock"> <div class="content"> <pre>$ git clone https://github.com/infinispan/ispncon.git
$ cd ispncon/src
$ sudo python setup.py install</pre> </div> </div> <div class="paragraph"> <p>Make this part of your <code>.bashrc</code> or whatever so you have ispncon command on path</p> </div> <div class="listingblock"> <div class="title">.bashrc</div> <div class="content"> <pre class="CodeRay highlight"><code>export ISPNCON_HOME=/path/to/ispncon
export PATH=$ISPNCON_HOME/bin:$PATH</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="basic_usage"><a class="anchor" href="#basic_usage"></a>30.3. Basic usage</h3> <div class="listingblock"> <div class="title">Format</div> <div class="content"> <pre>ispncon [options] &lt;operation&gt; [operation_options] &lt;op_arguments&gt;</pre> </div> </div> <table class="tableblock frame-all grid-all spread"> <caption class="title">Table 12. Options</caption> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Option</em></th> <th class="tableblock halign-left valign-top"><em>Meaning</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-c --client</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Client to use, possible values: memcached, rest, hotrod (default) Configuration key: ispncon.client_type</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-h --host &lt;host&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Host/ip address to connect to. Default: localhost. Configuration key: ispncon.host</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-p --port &lt;port&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Port to connect to. Default: 11222 (hotrod default port) Configuration key: ispncon.port</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-C --cache-name &lt;name&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Named cache to use. Default: use default cache (no value) Configuration key: ispncon.cache</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-v --version</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Print ispncon version and exit</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-e --exit-on-error</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If true and operation fails, then fail with an exit code. If false just print ERROR message and continue. This mostly makes sense for batch files.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-P --config "&lt;key&gt; &lt;value&gt;"</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">override configuration option &lt;key&gt; with value &lt;value&gt;. NOTE: the quotes are necessary, because getopt parser needs to get these as one string.</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>The possible Operations are <em>put, get, delete, clear, exists, help, config, include</em> and each one is described in the sections <em>Cache operations</em> and <em>Other commands</em> .</p> </div> </div> <div class="sect2"> <h3 id="configuration_16"><a class="anchor" href="#configuration_16"></a>30.4. Configuration</h3> <div class="paragraph"> <p>On start-up ispncon reads the file ~/.ispncon to configure some of the default values to use, so that the user doesn&#8217;t have to enter the options like host, port, client type and cache name everytime he types a cache command.</p> </div> <div class="paragraph"> <p>The format of the config file is like this:</p> </div> <div class="listingblock"> <div class="title">~/.ispncon</div> <div class="content"> <pre>[ispncon]
host = localhost
port = 8080
client_type = rest
cache =
exit_on_error = False
default_codec = None
[rest]
server_url = /infinispan-server-rest/rest
content_type = text/plain
[hotrod]
use_river_string_keys = True</pre> </div> </div> <div class="paragraph"> <p>The config parameters in the section <em>ispncon</em> are described in the_Basic usage_ section. The rest is described here:</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Config key</em></th> <th class="tableblock halign-left valign-top"><em>Meaning</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">rest.server_url</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">location of the REST server service, in the above example the HTTP requests would be sent to <a href="http://localhost:8080/infinispan-server-rest/rest" class="bare">http://localhost:8080/infinispan-server-rest/rest</a></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">rest.content_type</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">default MIME content type for entries stored via REST interface</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">default_codec</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Default codec to use to encode/decode values. Possible values: None, RiverString, RiverByteArray see section Interoperability with java clients for further info</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">hotrod.use_river_string_keys</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If set to True, hotrod client will encode keys with RiverString codec - this is necessary to be able to access the same data as via Java HotRod Client using the same string keys. see section Interoperability with java clients for further info</p></td> </tr> </tbody> </table> </div> <div class="sect2"> <h3 id="cache_operations_2"><a class="anchor" href="#cache_operations_2"></a>30.5. Cache operations</h3> <div class="sect3"> <h4 id="put_2"><a class="anchor" href="#put_2"></a>30.5.1. put</h4> <div class="paragraph"> <p>Put data under a specified key.</p> </div> <div class="listingblock"> <div class="title">Format</div> <div class="content"> <pre>put [options] &lt;key&gt; &lt;value&gt;</pre> </div> </div> <table class="tableblock frame-all grid-all spread"> <caption class="title">Table 13. Options</caption> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Option</em></th> <th class="tableblock halign-left valign-top"><em>Meaning</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-i --input-filename &lt;filename&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Don&#8217;t specify the value, instead put the contents of the specified file.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-v --version &lt;version&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Put only if version equals version given. Version format differs between protocols: HotRod: 64-bit integer version number Memcached: 64-bit integer unique version id REST: ETag string Not yet implemented for REST client in infinispan, watch <a href="https://issues.jboss.org/browse/ISPN-1084">ISPN-1084</a> for more info.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-l --lifespan &lt;seconds&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Specifies lifespan of the entry. Integer, number of seconds.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-I --max-idle &lt;seconds&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Specifies max idle time for the entry. Integer, number of seconds.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-a --put-if-absent</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Return CONFLICT if value already exists and don&#8217;t put anything in that case</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-e --encode &lt;codec&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Encode value using the specified codec</p></td> </tr> </tbody> </table> <table class="tableblock frame-all grid-all spread"> <caption class="title">Table 14. Return values</caption> <colgroup> <col style="width: 33%;"> <col style="width: 33%;"> <col style="width: 33%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Exit code</em></th> <th class="tableblock halign-left valign-top"><em>Output</em></th> <th class="tableblock halign-left valign-top"><em>Result description</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">STORED</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry was stored sucessfully</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ERROR &lt;msg&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">General error occurred</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">NOT_FOUND</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">-v option was used and entry doesn&#8217;t exist</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">CONFLICT</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">-a option was used and the entry already exists, or -v was used and versions don&#8217;t match</p></td> </tr> </tbody> </table> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> memcached client won&#8217;t distinguish between states NOT_FOUND, CONFLICT and ERROR and always will return ERROR if operation wasn&#8217;t successful. this is a limitation of python-memcached client. </td> </tr> </table> </div> <div class="sect4"> <h5 id="issues"><a class="anchor" href="#issues"></a>Issues</h5> <div class="paragraph"> <p>See <a href="https://bugs.launchpad.net/python-memcached/+bug/684689">684689</a> and <a href="https://bugs.launchpad.net/python-memcached/+bug/684690">684690</a> for discussion.</p> </div> <div class="paragraph"> <p>In later ispncon versions python-memcached client might get replaced by a customized version.</p> </div> </div> </div> <div class="sect3"> <h4 id="get_2"><a class="anchor" href="#get_2"></a>30.5.2. get</h4> <div class="paragraph"> <p>Get the data stored under the specified key.</p> </div> <div class="listingblock"> <div class="title">Format</div> <div class="content"> <pre>get [options] &lt;key&gt;</pre> </div> </div> <table class="tableblock frame-all grid-all spread"> <caption class="title">Table 15. Options</caption> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Option</em></th> <th class="tableblock halign-left valign-top"><em>Meaning</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-o --output-filename &lt;filename&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Stores the output of the get operation into the file specified.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-v --version</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Get version along with the data. Version format differs between protocols: HotRod: 64-bit integer version number Memcached: 64-bit integer unique version id REST: ETag string</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-d --decode &lt;codec&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Decode the value using the specified codec.</p></td> </tr> </tbody> </table> <table class="tableblock frame-all grid-all spread"> <caption class="title">Table 16. Return values</caption> <colgroup> <col style="width: 33%;"> <col style="width: 33%;"> <col style="width: 33%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Exit code</em></th> <th class="tableblock halign-left valign-top"><em>Output</em></th> <th class="tableblock halign-left valign-top"><em>Result description</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">In case no filename was specified: &lt;data, possibly multi-line&gt; (NOTE: the data might contain binary content, that is not suitable for reading in terminal) In case a filename was specified, nothing is printed on standard output. In case -v was specified, the output is prepended with one line: VERSION &lt;version&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry was found and is returned.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ERROR &lt;msg&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">General error occurred</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">NOT_FOUND</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Requested entry wasn&#8217;t found in the cache</p></td> </tr> </tbody> </table> </div> <div class="sect3"> <h4 id="delete"><a class="anchor" href="#delete"></a>30.5.3. delete</h4> <div class="paragraph"> <p>Delete the entry with the specified key.</p> </div> <div class="listingblock"> <div class="title">Format</div> <div class="content"> <pre>delete [options] &lt;key&gt;</pre> </div> </div> <table class="tableblock frame-all grid-all spread"> <caption class="title">Table 17. Options</caption> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Option</em></th> <th class="tableblock halign-left valign-top"><em>Meaning</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-v --version &lt;version&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Deletes only if the specified version matches the version in the cache NOTE: versioned delete is not supported with memcached client. attempt to delete with -v flag will end in ERROR message. with REST client the situation is different, the protocol allows this, but it&#8217;s not yet implemented in infinispan, watch <a href="https://issues.jboss.org/browse/ISPN-1084">ISPN-1084</a> for more info</p></td> </tr> </tbody> </table> <table class="tableblock frame-all grid-all spread"> <caption class="title">Table 18. Return values</caption> <colgroup> <col style="width: 33%;"> <col style="width: 33%;"> <col style="width: 33%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Exit code</em></th> <th class="tableblock halign-left valign-top"><em>Output</em></th> <th class="tableblock halign-left valign-top"><em>Result description</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">DELETED</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry was successfully deleted</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ERROR &lt;msg&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">General error occurred</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">NOT_FOUND</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry wasn&#8217;t found in the cache.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">CONFLICT</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Option -v was used and versions don&#8217;t match</p></td> </tr> </tbody> </table> </div> <div class="sect3"> <h4 id="clear"><a class="anchor" href="#clear"></a>30.5.4. clear</h4> <div class="paragraph"> <p>Clear the cache</p> </div> <div class="listingblock"> <div class="title">Format</div> <div class="content"> <pre>clear</pre> </div> </div> <table class="tableblock frame-all grid-all spread"> <caption class="title">Table 19. Return values</caption> <colgroup> <col style="width: 33%;"> <col style="width: 33%;"> <col style="width: 33%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Exit code</em></th> <th class="tableblock halign-left valign-top"><em>Output</em></th> <th class="tableblock halign-left valign-top"><em>Result description</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">DELETED</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Cache was sucessfully cleared</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ERROR &lt;msg&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">General error occurred</p></td> </tr> </tbody> </table> </div> <div class="sect3"> <h4 id="exists"><a class="anchor" href="#exists"></a>30.5.5. exists</h4> <div class="paragraph"> <p>Verify if the entry exists in the cache</p> </div> <div class="listingblock"> <div class="title">Format</div> <div class="content"> <pre>exists &lt;key&gt;</pre> </div> </div> <table class="tableblock frame-all grid-all spread"> <caption class="title">Table 20. Options</caption> <colgroup> <col style="width: 33%;"> <col style="width: 33%;"> <col style="width: 33%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Exit code</em></th> <th class="tableblock halign-left valign-top"><em>Output</em></th> <th class="tableblock halign-left valign-top"><em>Result description</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">EXISTS</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry with the given key exists</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ERROR &lt;msg&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">General error occurred</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">NOT_FOUND</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry with the given key wasn&#8217;t found in the cache</p></td> </tr> </tbody> </table> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> memcached protocol doesn&#8217;t support querying for existence of an entry in the cache so exists operation is implemented (inefficiently) by get opeartion, that gets the whole entry with all the data from the server. </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="version_2"><a class="anchor" href="#version_2"></a>30.5.6. version</h4> <div class="paragraph"> <p>Get version of the entry. Version format differs between protocols:</p> </div> <div class="ulist"> <ul> <li> <p>HotRod: 64-bit integer version number</p> </li> <li> <p>Memcached: 64-bit integer unique version id</p> </li> <li> <p>REST: ETag string</p> </li> </ul> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> The purpose of this command is to facilitate the parsing of the version string. HotRod and Memcached client don&#8217;t support efficient implementation of this operation. They transfer the whole entry from the server to determine the version, so if applicable you are encouraged to use "get -v" command to obtain version together with the data. </td> </tr> </table> </div> <div class="paragraph"> <p>REST client implements this operation efficiently by executing HEAD method.</p> </div> <div class="listingblock"> <div class="title">Format</div> <div class="content"> <pre>version &lt;key&gt;</pre> </div> </div> <table class="tableblock frame-all grid-all spread"> <caption class="title">Table 21. Return values</caption> <colgroup> <col style="width: 33%;"> <col style="width: 33%;"> <col style="width: 33%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Exit code</em></th> <th class="tableblock halign-left valign-top"><em>Output</em></th> <th class="tableblock halign-left valign-top"><em>Result description</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">&lt;version&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If the entry exists.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ERROR &lt;msg&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">General error occurred</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">NOT_FOUND</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Requested entry wasn&#8217;t found in the cache</p></td> </tr> </tbody> </table> </div> </div> <div class="sect2"> <h3 id="other_commands"><a class="anchor" href="#other_commands"></a>30.6. Other commands</h3> <div class="sect3"> <h4 id="help"><a class="anchor" href="#help"></a>30.6.1. help</h4> <div class="paragraph"> <p>Print help about an operation</p> </div> <div class="listingblock"> <div class="title">Format</div> <div class="content"> <pre>help &lt;operation&gt;</pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> if no operation is supplied, prints list of supported operations </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="config"><a class="anchor" href="#config"></a>30.6.2. config</h4> <div class="paragraph"> <p>Change internal state/config of the client. This operation has only client-side effect.</p> </div> <div class="listingblock"> <div class="title">Format</div> <div class="content"> <pre>configÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â  - to print current config
config saveÂ Â Â Â Â Â Â Â Â Â  - to save config to ~/.ispncon
config &lt;key&gt; &lt;value&gt;Â  - to change config for currently running session</pre> </div> </div> <div class="sect4"> <h5 id="configuration_values"><a class="anchor" href="#configuration_values"></a>Configuration values</h5> <div class="paragraph"> <p>see section Configuration for the meaning of different configuration options. Currently supported keys are:</p> </div> <div class="ulist"> <ul> <li> <p>cache</p> </li> <li> <p>host</p> </li> <li> <p>port</p> </li> <li> <p>client_type</p> </li> <li> <p>exit_on_error</p> </li> <li> <p>rest.server_url</p> </li> <li> <p>rest.content_type</p> </li> </ul> </div> <div class="paragraph"> <p>These values directly correspond to the keys in the ~/.ispncon config file. The format of the key is</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;section&gt;.&lt;config_key&gt;</pre> </div> </div> <div class="paragraph"> <p>If no section is given, "ispncon" is implied.</p> </div> <table class="tableblock frame-all grid-all spread"> <caption class="title">Table 22. Return values</caption> <colgroup> <col style="width: 33%;"> <col style="width: 33%;"> <col style="width: 33%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Exit code</em></th> <th class="tableblock halign-left valign-top"><em>Output</em></th> <th class="tableblock halign-left valign-top"><em>Result description</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">STORED</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If configuration/client state was updated successfully.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">multi-line output with config values</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If config command with no parameters was entered.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ERROR &lt;msg&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">General error occurred</p></td> </tr> </tbody> </table> </div> </div> <div class="sect3"> <h4 id="include"><a class="anchor" href="#include"></a>30.6.3. include</h4> <div class="paragraph"> <p>Process cache commands from the specified batch file. The commands will be processed line by line.</p> </div> <div class="listingblock"> <div class="title">Format</div> <div class="content"> <pre>include &lt;filename&gt;</pre> </div> </div> <table class="tableblock frame-all grid-all spread"> <caption class="title">Table 23. Return values</caption> <colgroup> <col style="width: 33%;"> <col style="width: 33%;"> <col style="width: 33%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Exit code</em></th> <th class="tableblock halign-left valign-top"><em>Output</em></th> <th class="tableblock halign-left valign-top"><em>Result description</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">exit code of the last command in the file.</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The output depends on the commands present in the input file</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">depends on the commands in the batch file</p></td> </tr> </tbody> </table> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> The name of this command and its behaviour is going to change in the next version. </td> </tr> </table> </div> </div> </div> <div class="sect2"> <h3 id="interoperability_with_java_clients"><a class="anchor" href="#interoperability_with_java_clients"></a>30.7. Interoperability with java clients</h3> <div class="sect3"> <h4 id="over_rest"><a class="anchor" href="#over_rest"></a>30.7.1. Over REST</h4> <div class="paragraph"> <p>When exchanging data via REST interface, the values are interpreted by any client as sequence of bytes. The meaning is given to this byte-sequence by using MIME type specified via "Content-Type" HTTP header. No special interoperability measures are needed here.</p> </div> </div> <div class="sect3"> <h4 id="over_hot_rod"><a class="anchor" href="#over_hot_rod"></a>30.7.2. Over Hot Rod</h4> <div class="paragraph"> <p>If we want to read in ispncon the entries that were put with Hot Rod Java client, we need to use a special option <code>hotrod.use_river_string_keys = True</code>. This will cause the string keys to be encoded the same way the Java client does it.</p> </div> <div class="paragraph"> <p>Using <code>hotrod.use_river_string_keys = True</code> we&#8217;re able to access the data that has been written by the java client, but we still see the raw binary values. To be able to see a value that has been put by Hot Rod java client in a readable form and vice versa - to be able to see in Hot Rod Java client what we&#8217;ve put via ispncon we need to use a <em>codec</em> . Currently there are two types of codecs: <em>RiverString</em> and <em>RiverByteArray</em></p> </div> <div class="ulist"> <ul> <li> <p><em>RiverString</em> - will decode a value that has been put as java.lang.String and vice versa - a value encoded with this codec will be returned as java.lang.String on the java side</p> </li> <li> <p><em>RiverByteArray</em> - analogous to RiverString but works with byte[] (java byte array)</p> </li> </ul> </div> <div class="paragraph"> <p>Codecs can be used either by specifying a <em>default_codec</em> option in the ~/.ispncon config file (in section ispncon) or by specifying a codec on each put resp get using <em>-e (--encode)</em> resp <em>-d (--decode) options</em> .</p> </div> </div> <div class="sect3"> <h4 id="spymemcached_java_client"><a class="anchor" href="#spymemcached_java_client"></a>30.7.3. SpyMemcached Java Client</h4> <div class="paragraph"> <p>Tested with <a href="http://code.google.com/p/spymemcached/">spymemcached</a> 2.7.</p> </div> <div class="paragraph"> <p>Values stored by ispncon is interpreted as an UTF-8 string, meaning if we store data using ispncon, it will be interpreted by the Java client as a String by calling <code>new java.lang.String(bytes, "UTF-8")</code>.</p> </div> <div class="paragraph"> <p>This also works in reverse: values stored in Java as <code>java.lang.String</code> will be returned as UTF-8 bytes in ispncon</p> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="using_infinispan_as_a_jsr107_jcache_provider"><a class="anchor" href="#using_infinispan_as_a_jsr107_jcache_provider"></a>31. Using Infinispan as a JSR107 (JCache) provider</h2> <div class="sectionbody"> <div class="paragraph"> <p>Starting with version 7.0.0, Infinispan provides an implementation of JCache 1.0.0 API ( <a href="http://www.jcp.org/en/jsr/detail?id=107">JSR-107</a> ). JCache specifies a standard Java API for caching temporary Java objects in memory. Caching java objects can help get around bottlenecks arising from using data that is expensive to retrieve (i.e. DB or web service), or data that is hard to calculate. Caching these type of objects in memory can help speed up application performance by retrieving the data directly from memory instead of doing an expensive roundtrip or recalculation. This document specifies how to use JCache with Infinispan&#8217;s implementation of the specification, and explains key aspects of the API.</p> </div> <div class="sect2"> <h3 id="dependencies_2"><a class="anchor" href="#dependencies_2"></a>31.1. Dependencies</h3> <div class="paragraph"> <p>In order to start using Infinispan JCache implementation, a single dependency needs to be added to the Maven pom.xml file:</p> </div> <div class="listingblock"> <div class="title">pom.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>infinispan-jcache<span class="tag">&lt;/artifactId&gt;</span>
   <span class="tag">&lt;version&gt;</span>...<span class="tag">&lt;/version&gt;</span> <span class="comment">&lt;!-- i.e. 7.0.0.Final --&gt;</span>
   <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre> </div> </div> </div> <div class="sect2"> <h3 id="create_a_local_cache"><a class="anchor" href="#create_a_local_cache"></a>31.2. Create a local cache</h3> <div class="paragraph"> <p>Creating a local cache, using default configuration options as defined by the JCache API specification, is as simple as doing the following:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.cache</span>.*;
<span class="keyword">import</span> <span class="include">javax.cache.configuration</span>.*;

<span class="comment">// Retrieve the system wide cache manager</span>
CacheManager cacheManager = Caching.getCachingProvider().getCacheManager();
<span class="comment">// Define a named cache with default JCache configuration</span>
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheManager.createCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span>,
      <span class="keyword">new</span> MutableConfiguration&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;());</code></pre> </div> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> By default, the JCache API specifies that data should be stored as <code>storeByValue</code>, so that object state mutations outside of operations to the cache, won&#8217;t have an impact in the objects stored in the cache. Infinispan has so far implemented this using serialization/marshalling to make copies to store in the cache, and that way adhere to the spec. Hence, if using default JCache configuration with Infinispan, data stored <a href="#_plugging_infinispan_with_user_defined_externalizers">must be marshallable</a>. </td> </tr> </table> </div> <div class="paragraph"> <p>Alternatively, JCache can be configured to store data by reference (just like Infinispan or JDK Collections work). To do that, simply call:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheManager.createCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span>,
      <span class="keyword">new</span> MutableConfiguration&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;().setStoreByValue(<span class="predefined-constant">false</span>));</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="store_and_retrieve_data"><a class="anchor" href="#store_and_retrieve_data"></a>31.3. Store and retrieve data</h3> <div class="paragraph"> <p>Even though JCache API does not extend neither <a href="http://docs.oracle.com/javase/7/docs/api/java/util/Map.html">java.util.Map</a> not <a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ConcurrentMap.html">java.util.concurrent.ConcurrentMap</a>, it providers a key/value API to store and retrieve data:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.cache</span>.*;
<span class="keyword">import</span> <span class="include">javax.cache.configuration</span>.*;

CacheManager cacheManager = Caching.getCacheManager();
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheManager.createCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span>,
      <span class="keyword">new</span> MutableConfiguration&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;());
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">world</span><span class="delimiter">&quot;</span></span>); <span class="comment">// Notice that javax.cache.Cache.put(K) returns void!</span>
<span class="predefined-type">String</span> value = cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>); <span class="comment">// Returns &quot;world&quot;</span></code></pre> </div> </div> <div class="paragraph"> <p>Contrary to standard <a href="http://docs.oracle.com/javase/7/docs/api/java/util/Map.html">java.util.Map</a>, <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0-RC1/src/main/java/javax/cache/Cache.java">javax.cache.Cache</a> comes with two basic put methods called put and getAndPut. The former returns <code>void</code> whereas the latter returns the previous value associated with the key. So, the equivalent of <a href="http://docs.oracle.com/javase/7/docs/api/java/util/Map.html#put(K,%20V)">java.util.Map.put(K)</a> in JCache is <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0-RC1/src/main/java/javax/cache/Cache.java#L230">javax.cache.Cache.getAndPut(K)</a>.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> Even though JCache API only covers standalone caching, it can be plugged with a persistence store, and has been designed with clustering or distribution in mind. The reason why javax.cache.Cache offers two put methods is because standard java.util.Map put call forces implementors to calculate the previous value. When a persistent store is in use, or the cache is distributed, returning the previous value could be an expensive operation, and often users call standard <a href="http://docs.oracle.com/javase/7/docs/api/java/util/Map.html#put(K, V)">java.util.Map.put(K)</a> without using the return value. Hence, JCache users need to think about whether the return value is relevant to them, in which case they need to call <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0-RC1/src/main/java/javax/cache/Cache.java#L230">javax.cache.Cache.getAndPut(K)</a> , otherwise they can call <a href="http://docs.oracle.com/javase/7/docs/api/java/util/Map.html#put(K,%20V)">java.util.Map.put(K)</a> which avoids returning the potentially expensive operation of returning the previous value. </td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="comparing_java_util_concurrent_concurrentmap_and_javax_cache_cache_apis"><a class="anchor" href="#comparing_java_util_concurrent_concurrentmap_and_javax_cache_cache_apis"></a>31.4. Comparing java.util.concurrent.ConcurrentMap and javax.cache.Cache APIs</h3> <div class="paragraph"> <p>Here&#8217;s a brief comparison of the data manipulation APIs provided by <a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ConcurrentMap.html">java.util.concurrent.ConcurrentMap</a> and <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0-RC1/src/main/java/javax/cache/Cache.java">javax.cache.Cache</a> APIs.</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 33%;"> <col style="width: 33%;"> <col style="width: 33%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Operation</th> <th class="tableblock halign-left valign-top"><code>java.util.concurrent.ConcurrentMap&lt;K, V&gt;</code></th> <th class="tableblock halign-left valign-top"><code>javax.cache.Cache&lt;K, V&gt;</code></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">store and no return</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>void put(K key)</code></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">store and return previous value</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>V put(K key)</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>V getAndPut(K key)</code></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">store if not present</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>V putIfAbsent(K key, V value)</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean putIfAbsent(K key, V value)</code></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">retrieve</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>V get(Object key)</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>V get(K key)</code></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">delete if present</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>V remove(Object key)</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean remove(K key)</code></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">delete and return previous value</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>V remove(Object key)</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>V getAndRemove(K key)</code></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">delete conditional</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean remove(Object key, Object value)</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean remove(K key, V oldValue)</code></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">replace if present</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>V replace(K key, V value)</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean replace(K key, V value)</code></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">replace and return previous value</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>V replace(K key, V value)</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>V getAndReplace(K key, V value)</code></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">replace conditional</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean replace(K key, V oldValue, V newValue)</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean replace(K key, V oldValue, V newValue)</code></p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Comparing the two APIs, it&#8217;s obvious to see that, where possible, JCache avoids returning the previous value to avoid operations doing expensive network or IO operations. This is an overriding principle in the design of JCache API. In fact, there&#8217;s a set of operations that are present in <a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ConcurrentMap.html">java.util.concurrent.ConcurrentMap</a> , but are not present in the <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0-RC1/src/main/java/javax/cache/Cache.java">javax.cache.Cache</a> because they could be expensive to compute in a distributed cache. The only exception is iterating over the contents of the cache:</p> </div> <table class="tableblock frame-all grid-all spread"> <colgroup> <col style="width: 33%;"> <col style="width: 33%;"> <col style="width: 33%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Operation</th> <th class="tableblock halign-left valign-top"><code>java.util.concurrent.ConcurrentMap&lt;K, V&gt;</code></th> <th class="tableblock halign-left valign-top"><code>javax.cache.Cache&lt;K, V&gt;</code></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">calculate size of cache</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>int size()</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Â N/A</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">return all keys in the cache</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>Set&lt;K&gt; keySet()</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Â N/A</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">return all values in the cache</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>Collection&lt;V&gt; values()</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Â N/A</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">return all entries in the cache</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>Set&lt;Map.Entry&lt;K, V&gt;&gt; entrySet()</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Â N/A</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">iterate over the cache</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">use <code>iterator()</code> method on keySet, values or entrySet</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>Iterator&lt;Cache.Entry&lt;K, V&gt;&gt; iterator()</code></p></td> </tr> </tbody> </table> </div> <div class="sect2"> <h3 id="clustering_jcache_instances"><a class="anchor" href="#clustering_jcache_instances"></a>31.5. Clustering JCache instances</h3> <div class="paragraph"> <p>Infinispan JCache implementation goes beyond the specification in order to provide the possibility to cluster caches using the standard API. Given a Infinispan configuration file configured to replicate caches like this:</p> </div> <div class="listingblock"> <div class="title">infinispan.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
   <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;transport</span> <span class="attribute-name">cluster</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jcache-cluster</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>You can create a cluster of caches using this code:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.cache</span>.*;
<span class="keyword">import</span> <span class="include">java.net.URI</span>;

<span class="comment">// For multiple cache managers to be constructed with the standard JCache API</span>
<span class="comment">// and live in the same JVM, either their names, or their classloaders, must</span>
<span class="comment">// be different.</span>
<span class="comment">// This example shows how to force their classloaders to be different.</span>
<span class="comment">// An alternative method would have been to duplicate the XML file and give</span>
<span class="comment">// it a different name, but this results in unnecessary file duplication.</span>
<span class="predefined-type">ClassLoader</span> tccl = <span class="predefined-type">Thread</span>.currentThread().getContextClassLoader();
CacheManager cacheManager1 = Caching.getCachingProvider().getCacheManager(
      <span class="predefined-type">URI</span>.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-jcache-cluster.xml</span><span class="delimiter">&quot;</span></span>), <span class="keyword">new</span> TestClassLoader(tccl));
CacheManager cacheManager2 = Caching.getCachingProvider().getCacheManager(
      <span class="predefined-type">URI</span>.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-jcache-cluster.xml</span><span class="delimiter">&quot;</span></span>), <span class="keyword">new</span> TestClassLoader(tccl));

Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache1 = cacheManager1.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span>);
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache2 = cacheManager2.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span>);

cache1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">world</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">String</span> value = cache2.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>); <span class="comment">// Returns &quot;world&quot; if clustering is working</span>

<span class="comment">// --</span>

<span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">TestClassLoader</span> <span class="directive">extends</span> <span class="predefined-type">ClassLoader</span> {
  <span class="directive">public</span> TestClassLoader(<span class="predefined-type">ClassLoader</span> parent) {
     <span class="local-variable">super</span>(parent);
  }
}</code></pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="total_order_based_commit_protocol"><a class="anchor" href="#total_order_based_commit_protocol"></a>32. Total Order based commit protocol</h2> <div class="sectionbody"> <div class="paragraph"> <p>The Total Order based protocol is a multi-master scheme (in this context, multi-master scheme means that all nodes can update all the data) as the (optimistic/pessimist) locking model implemented in Infinispan. This commit protocol relies on the concept of totally ordered delivery of messages which, informally, implies that each node which delivers a set of messages, delivers them in the same order.</p> </div> <div class="paragraph"> <p>This protocol comes with this advantages.</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>transactions can be committed in one phase, as they are delivered in the same order by the nodes that receive them.</p> </li> <li> <p>it mitigates distributed deadlocks.</p> </li> </ol> </div> <div class="paragraph"> <p>The weaknesses of this approach are the fact that its implementation relies on a single thread per node which delivers the transaction and its modification, and the slightly higher number of messages exchanged by JGroups.</p> </div> <div class="paragraph"> <p>Thus, this protocol delivers best performance in scenarios of <em>high contention</em> , in which it can benefit from the single-phase commit and the deliver thread is not the bottleneck.</p> </div> <div class="paragraph"> <p>Currently, the Total Order based protocol is available only in <em>transactional</em> caches for <em>replicated</em> and <em>distributed</em> modes.</p> </div> <div class="sect2"> <h3 id="overview"><a class="anchor" href="#overview"></a>32.1. Overview</h3> <div class="paragraph"> <p>The Total Order based commit protocol only affects how transactions are committed and it depends of the isolation level configured, more precisely the <em>write skew check</em> . Note that it only provides the <em>same isolation levels</em> as the locking model, i.e. <em>read-committed</em> and <em>repeatable-read</em> . If the write skew check is not enabled, then all the transaction are committed in one phase (independently if Infinispan is enlisted as <em>Synchronization</em> or <em>XaResource</em> ). In this case, the isolation level is not violated because it is ensured during the transaction execution. Also the transactions always commit successfully because they do not need to perform any validation in prepare phase.</p> </div> <div class="paragraph"> <p>On other hand, when write skew check is enabled, the protocol adapts using one phase commit when it is safe. However, if Infinispan is enlisted as <em>Synchronization</em> , it always commit in two phases, because the <em>Transaction Manager</em> does not provide any information if Infinispan is the only resource enlisted or not. In <em>XaResource</em> enlistment, we can use one phase if the <em>Transaction Manager</em> request a commit in one phase (i.e. one-phase optimization, usually used when the transaction has a single <em>XaResource</em> registered, see <a href="http://docs.jboss.org/jbossas/javadoc/4.0.5/j2ee/javax/transaction/xa/XAResource.html#commit(javax.transaction.xa.Xid, boolean)">XaResource.commit()</a> ) and the Infinispan cache is configured in replicated mode or in distributed mode (the last one, when the <em>writeSkew==false</em> ). This optimization is not safe in distributed mode when <em>writeSkew==true</em> because each node performs the validation in different keys subset.</p> </div> <div class="sect3"> <h4 id="commit_in_one_phase"><a class="anchor" href="#commit_in_one_phase"></a>32.1.1. Commit in one phase</h4> <div class="paragraph"> <p>When the transaction ends, Infinispan sends the transaction (and its modification) in total order. This ensures all the transactions are deliver in the same order in all the involved Infinispan nodes. As a result, when a transaction is delivered, it performs a deterministic validation over the same state, leading to the same outcome (transaction commit or rollback). Also, if the transactional mode is configured with <em>syncCommitPhase==false</em> , the node that sent the transaction still needs to wait for the self-deliver of the transaction because it needs to know the transaction outcome. In other hand, it does not need to wait for the replies from other nodes because they will reply with the same outcome. Although, if <em>syncCommitPhase==true</em> , it needs to wait for the replies in order to respect the semantic of the flag.</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/fig1.png" alt="fig1"> </div> </div> <div class="paragraph"> <p>The figure above demonstrates a high level example with 3 nodes. <em>Node1</em> and <em>Node3</em> are running one transaction each and lets assume that both transaction writes on the same key. To make it more interesting, lets assume that both nodes tries to commit at the same time, represented by the first colored circle in the figure. The <em>blue</em> circle represents the transaction <em>tx1</em> and the <em>green</em> the transaction <em>tx2</em> . Both nodes do a remote invocation in total order ( <em>to-send</em> ) with the transaction&#8217;s modifications. At this moment, all the nodes will agree in the same deliver order, for example, <em>tx1</em> followed by <em>tx2</em> . Then, each node delivers <em>tx1</em> , perform the validation and commits the modifications. The same steps are performed for <em>tx2</em> but, in this case, the validation will fail and the transaction is rollback in all the involved nodes.</p> </div> </div> <div class="sect3"> <h4 id="commit_in_two_phases"><a class="anchor" href="#commit_in_two_phases"></a>32.1.2. Commit in two phases</h4> <div class="paragraph"> <p>The first phase is the same as described above except that the nodes will not apply the modifications after the validation, including the modifications sent in total order and the same scheme to wait for the replies. As soon as it has the confirmation that all keys are successfully validated, it give a positive response to the <em>Transaction Manager</em> (remember that the <em>Transaction Manager</em> is responsive to invoke the <em>prepare()</em> of the transaction). On other hand, if it receives a negative reply, it returns a negative response to the <em>Transaction Manager</em> . Finally, the transaction is committed or aborted in the second phase depending of the <em>Transaction Manager</em> .</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/fig2.png" alt="fig2"> </div> </div> <div class="paragraph"> <p>The figure above shows the scenario described in the first figure but now committing the transactions using two phases. When <em>tx1</em> is deliver, it performs the validation and it replies to the <em>Transaction Manager</em> . Next, lets assume that <em>tx2</em> is deliver before the <em>Transaction Manager</em> request the second phase for <em>tx1</em> . In this case, <em>tx2</em> will be enqueued and it will be validated only when <em>tx1</em> is completed. Eventually, the <em>Transaction Manager</em> for <em>tx1</em> will request the second phase (the commit) and all the nodes are free to perform the validation of <em>tx2</em> .</p> </div> </div> <div class="sect3"> <h4 id="transaction_recovery_2"><a class="anchor" href="#transaction_recovery_2"></a>32.1.3. Transaction Recovery</h4> <div class="paragraph"> <p><a href="#_transaction_recovery">Transaction recovery</a> is currently not available for Total Order based commit protocol</p> </div> </div> <div class="sect3"> <h4 id="total_order_executor_service"><a class="anchor" href="#total_order_executor_service"></a>32.1.4. Total order executor service</h4> <div class="paragraph"> <p>As previous said, only one thread is delivering the transactions, which makes this thread a possible bottleneck of the system. Although, only conflicting transactions (i.e. which the write set intercepts) needs to be validated in order. For example, if a node delivers <em>tx1(write(A))</em> , <em>tx2(write(A))</em> and <em>tx3(write(B))</em> , <em>tx2</em> must wait until the <em>tx1</em> is completed, but <em>tx3</em> can be validated concurrently with <em>tx1</em> and <em>tx2</em> . After analyzing the transaction dependencies, is possible to enqueue the transactions that conflicts to non-completed transactions and move to a executor service the transaction that can be concurrently validated.</p> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> The total order executor service needs an <em>ExecutorService</em> (see the Configuration section). Please make sure that the <em>ExecutorService</em> <em>does not reject tasks</em> otherwise your data becomes <em>inconsistent</em>. </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="state_transfer"><a class="anchor" href="#state_transfer"></a>32.1.5. State Transfer</h4> <div class="paragraph"> <p>For simplicity reasons, the total order based commit protocol uses a blocking version of the current state transfer. The main differences are:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>enqueue the transaction deliver while the state transfer is in progress;</p> </li> <li> <p>the state transfer control messages ( <em>CacheTopologyControlCommand</em> ) are sent in total order.</p> </li> </ol> </div> <div class="paragraph"> <p>This way, it provides a synchronization between the state transfer and the transactions deliver that is the same all the nodes. Although, the transactions caught in the middle of state transfer (i.e. sent before the state transfer start and deliver after it) needs to be re-sent to find a new total order involving the new joiners.</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/fig3.png" alt="fig3"> </div> </div> <div class="paragraph"> <p>The figure above describes a node joining. In the scenario, the <em>tx2</em> is sent in <em>topologyId=1</em> but when it is received, it is in <em>topologyId=2</em> . So, the transaction is re-sent involving the new nodes.</p> </div> </div> </div> <div class="sect2"> <h3 id="configuration_17"><a class="anchor" href="#configuration_17"></a>32.2. Configuration</h3> <div class="paragraph"> <p>To use Total Order based commit protocol in your Infinispan cache, you need to configure a couple of thing:</p> </div> <div class="ulist"> <ul> <li> <p>add the total order protocols in JGroups configuration file:</p> </li> </ul> </div> <div class="listingblock"> <div class="title">jgroups.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;SEQUENCER</span> <span class="tag">/&gt;</span>
<span class="tag">&lt;tom.TOA</span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Check the JGroups manual for more detail in here: <a href="http://jgroups.org/manual-3.x/html/index.html">JGroups Manual</a></p> </div> <div class="ulist"> <ul> <li> <p>configure the Infinispan cache as a transactional cache and set the transaction protocol to total order:</p> </li> </ul> </div> <div class="listingblock"> <div class="title">infinispan.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;local-cache&gt;</span>
  <span class="tag">&lt;transaction</span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NON_XA</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">protocol</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TOTAL_ORDER</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>You can build the same configuration programmatically in the following way:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder cb = <span class="keyword">new</span> ConfigurationBuilder();
cb.transaction().transactionMode(TransactionMode.TRANSACTIONAL).transactionProtocol(TransactionProtocol.TOTAL_ORDER);</code></pre> </div> </div> <div class="paragraph"> <p>Optionally, you can configure the total order executor to use your own executor services. By default, it creates an executor service with <em>coreThreads=1</em> and <em>maxThreads=32</em> . It can be configured in the following way:</p> </div> <div class="listingblock"> <div class="title">infinispan.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
   <span class="tag">&lt;threads&gt;</span>
      <span class="tag">&lt;blocking-bounded-queue-thread-pool</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">custom-totalorder</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">core-threads</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-threads</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">32</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/threads&gt;</span>
   <span class="tag">&lt;cache-container&gt;</span>
      <span class="tag">&lt;transport</span> <span class="attribute-name">total-order-executor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">custom-totalorder</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>or programmaticaly:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder gcb = <span class="keyword">new</span> GlobalConfigurationBuilder();
gcb.transport().totalOrderThreadPool().threadPoolFactory(
   <span class="keyword">new</span> BlockingThreadPoolExecutorFactory(<span class="integer">32</span>, <span class="integer">1</span>, <span class="integer">10000</span>, <span class="integer">60000</span>));</code></pre> </div> </div> <div class="paragraph"> <p>Beside the <em>coreThreads</em> and the <em>maxThreads</em> , the <em>DefaultExecutorFactory</em> also accepts as properties as the <em>queueSize</em> , <em>keepAliveTime</em> (in milliseconds), <em>threadPriority</em> , <em>threadNamePrefix</em> and <em>threadNameSuffix</em> . Note that, this parameters are used by the <em>ExecutorService</em> . The total order executor uses an unbouded queue. Also, when you provide an <em>ExecutorService</em> , make sure that <em>it will no reject tasks</em> , otherwise your data can became <em>inconsistent</em> .</p> </div> </div> <div class="sect2"> <h3 id="total_order_support_in_jgroups"><a class="anchor" href="#total_order_support_in_jgroups"></a>32.3. Total Order support in JGroups.</h3> <div class="sect3"> <h4 id="sequencer"><a class="anchor" href="#sequencer"></a>32.3.1. SEQUENCER</h4> <div class="paragraph"> <p>The <em>SEQUENCER</em> protocol ensures total order involving all the members in the cluster. It is a sequencer-based implementation in which the sender forwards the messages to a sequencer (the current cluster coordinator), and the sequencer sends it back to the cluster on behalf of the original sender. Because it is always the same sender (whose messages are delivered in FIFO order), a global (or total) order is established.</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/fig4.png" alt="fig4"> </div> </div> <div class="paragraph"> <p>The figure above shows the the communication steps to total order broadcast two messages <em>M1</em> and <em>M2</em> from different senders. Below, the figure shows the communication steps needed to commit a single transaction, when two phase are used. The dotted line represents the communications steps performed by the <em>SEQUENCER</em> . As it is possible to see, ensure total order is not a cheap operation and it has a cost of an extra communication step comparing with the lock based implementation.</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/fig5.png" alt="fig5"> </div> </div> <div class="paragraph"> <p>More information about the <em>SEQUENCER</em> in JGroups manual: <a href="http://jgroups.org/manual-3.x/html/protlist.html#SEQUENCER">SEQUENCER - JGroups Manual page</a></p> </div> </div> <div class="sect3"> <h4 id="toa_total_order_anycast"><a class="anchor" href="#toa_total_order_anycast"></a>32.3.2. TOA - Total Order Anycast</h4> <div class="paragraph"> <p>The <em>TOA</em> protocol is implemented based on the Skeen Algorithm. Each node has an ordered (by the message logical clock) queue with the messages and a local logical clock and it works in a centralized way. The sender sends <em>N</em> unicast messages with the data to all destination nodes. When the message is received, each replica increments it logical clock and it sends back the value to the sender. Meanwhile, the message is put on the queue with the value of logical clock and marked as <em>temporary</em> . The sender collects all values and calculates the maximum value of them. Finally it sends other <em>N</em> unicast message with the final value of the message. This number indicates the final order number of deliver for the message. Each replica updates it logical clock, if the value is lower than the final value received, and updates the message in the queue, re-ordered if necessary. Then the message is marked as <em>final</em> . The messages are delivered when it is on the top of the queue and is <em>final</em> . The figure below explains in a graphical way how it is done.</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/Multicast-3-phases.png" alt="Multicast 3 phases"> </div> </div> <div class="paragraph"> <p>The next figure show one transaction to be committed in detail, including all the communication steps. The dotted line represents the messages exchanged by <em>TOA</em> and the solid lines a single unicast message. This figure shows that the total order protocol has 2 more communications steps than the lock based implementation.</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/fig6.png" alt="fig6"> </div> </div> <div class="paragraph"> <p>More information about the Total Order Anycast in JGroups manual: <a href="http://jgroups.org/manual-3.x/html/protlist.html#TOA">TOA - JGroups Manual page</a></p> </div> </div> </div> <div class="sect2"> <h3 id="benchmark_results"><a class="anchor" href="#benchmark_results"></a>32.4. Benchmark results</h3> <div class="paragraph"> <p>In order to compare the performance of total order with the locking model, <a href="https://github.com/radargun/radargun/wiki">RadarGun</a> was used to perform a benchmark evaluation in two different scenarios: a <em>no contention</em> scenario and a <em>contention</em> scenario.</p> </div> <div class="paragraph"> <p>The Infinispan configuration used is:</p> </div> <div class="listingblock"> <div class="title">infinispan.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
   <span class="tag">&lt;jgroups&gt;</span>
      <span class="tag">&lt;stack-file</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">external</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups/jgroups.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/jgroups&gt;</span>
   <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;transport</span> <span class="attribute-name">cluster</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">x</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">stack</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">external</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">remote-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10000</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;transaction</span> <span class="attribute-name">transaction-manager-lookup</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.transaction.lookup.GenericTransactionManagerLookup</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NON_XA</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">protocol</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TOTAL_ORDER</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   Â  Â  Â  Â  <span class="tag">&lt;locking</span> <span class="attribute-name">concurrency-level</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">striping</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">isolation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">REPEATABLE_READ</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">write-skew</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- write-skew=&quot;false&quot; for the no write skew experiments --&gt;</span>
   Â  Â  Â  Â  <span class="tag">&lt;state-transfer</span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/replicated-cache&gt;</span>
   Â  Â <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">testCache</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>and the benchmark configuration, using <a href="https://github.com/radargun/radargun">Radar Gun</a>, is:</p> </div> <div class="listingblock"> <div class="title">benchmark.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml">...
    <span class="tag">&lt;benchmark</span> <span class="attribute-name">initSize</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">maxSize</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${10:slaves}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">increment</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;DestroyWrapper</span> <span class="attribute-name">runOnAllSlaves</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;StartCluster</span> <span class="attribute-name">staggerSlaveStartup</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">delayAfterFirstSlaveStarts</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">delayBetweenStartingSlaves</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">500</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;ClusterValidation</span> <span class="attribute-name">partialReplication</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;StressTestWarmup</span> <span class="attribute-name">duration</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1m</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">opsCountStatusLog</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">numThreads</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">8</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">transactionSize</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">useTransactions</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writePercentage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">50</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">numEntries</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">sharedKeys</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;StressTest</span> <span class="attribute-name">duration</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5m</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">opsCountStatusLog</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">numThreads</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">8</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">transactionSize</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">useTransactions</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writePercentage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">50</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">numEntries</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">sharedKeys</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;CsvReportGeneration</span> <span class="attribute-name">targetDir</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">no_contention</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;ClearCluster</span><span class="tag">/&gt;</span>
        <span class="tag">&lt;StressTestWarmup</span> <span class="attribute-name">duration</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1m</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">opsCountStatusLog</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">numThreads</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">8</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">transactionSize</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">useTransactions</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writePercentage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">50</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">numEntries</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">sharedKeys</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;StressTest</span> <span class="attribute-name">duration</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5m</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">opsCountStatusLog</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">numThreads</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">8</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">transactionSize</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">useTransactions</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writePercentage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">50</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">numEntries</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">sharedKeys</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;CsvReportGeneration</span> <span class="attribute-name">targetDir</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">contention</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/benchmark&gt;</span>
...</code></pre> </div> </div> <div class="paragraph"> <p>The difference between the contention and no contention is the pool of key. In the first case the pool of keys are shared among all the threads (and nodes) and in the last case each threads has it own private pool of keys.</p> </div> <div class="paragraph"> <p>The first group of plots shows the performance in the <em>contented</em> scenario:</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/contention.png" alt="contention"> </div> </div> <div class="paragraph"> <p>and the next group of plots the <em>no contended</em> scenario:</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/no-contention.png" alt="no contention"> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="storing_objects_e_g_arrays_with_custom_equivalence_functions"><a class="anchor" href="#storing_objects_e_g_arrays_with_custom_equivalence_functions"></a>33. Storing objects (e.g. arrays) with custom Equivalence functions</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="the_problem_of_caching_arrays"><a class="anchor" href="#the_problem_of_caching_arrays"></a>33.1. The Problem of Caching Arrays</h3> <div class="paragraph"> <p>There are times when users want to store data into Infinispan caches whose default equals() and/or hashCode() implementations produce undesirable results. One of those data types are arrays. When users want to store arrays into Infinispan caches, the big majority of users want equals() function to be calculated based on the contents of the arrays as opposed to comparing the object reference, so if we take byte arrays are example, users would like to call up the static java.util.Arrays.equals(byte[], byte[]) method instead of Object.equals() . The same thing happens with hashCode() . The default implementation of Object.hashCode() for arrays suffers from the same issue, because the result is not produced based on the contents of the array, but rather based on the object reference to the array.</p> </div> </div> <div class="sect2"> <h3 id="old_workaround_wrapper_classes"><a class="anchor" href="#old_workaround_wrapper_classes"></a>33.2. Old workaround: Wrapper Classes</h3> <div class="paragraph"> <p>Until Infinispan 5.2, the way to get around these issues was by wrapping arrays, or any other object whose equals()/hashCode() implementations are not best suited for being stored in Infinispan caches, around another object which would override Object.equals() and Object.hashCode() to do the correct calculations. This is where classes such as <a href="https://github.com/infinispan/infinispan/blob/5.3.x/core/src/main/java/org/infinispan/util/ByteArrayKey.java">ByteArrayKey</a> originated:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">ByteArrayKey</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {

   <span class="directive">private</span> <span class="directive">final</span> <span class="type">byte</span><span class="type">[]</span> data;
   <span class="directive">private</span> <span class="directive">final</span> <span class="type">int</span> hashCode;

   <span class="directive">public</span> ByteArrayKey(<span class="type">byte</span><span class="type">[]</span> data) {
      <span class="local-variable">this</span>.data = data;
      <span class="local-variable">this</span>.hashCode = <span class="integer">41</span> + <span class="predefined-type">Arrays</span>.hashCode(data);
   }

   <span class="directive">public</span> <span class="type">byte</span><span class="type">[]</span> getData() {
      <span class="keyword">return</span> data;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">boolean</span> equals(<span class="predefined-type">Object</span> obj) {
      <span class="keyword">if</span> (<span class="local-variable">this</span> == obj) <span class="keyword">return</span> <span class="predefined-constant">true</span>;
      <span class="keyword">if</span> (obj == <span class="predefined-constant">null</span> || ByteArrayKey.class != obj.getClass()) <span class="keyword">return</span> <span class="predefined-constant">false</span>;
      ByteArrayKey key = (ByteArrayKey) obj;
      <span class="keyword">return</span> <span class="predefined-type">Arrays</span>.equals(key.data, <span class="local-variable">this</span>.data);
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">int</span> hashCode() {
      <span class="keyword">return</span> hashCode;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">String</span> toString() {
      <span class="keyword">return</span> <span class="keyword">new</span> <span class="predefined-type">StringBuilder</span>().append(<span class="string"><span class="delimiter">&quot;</span><span class="content">ByteArrayKey</span><span class="delimiter">&quot;</span></span>).append(<span class="string"><span class="delimiter">&quot;</span><span class="content">{</span><span class="delimiter">&quot;</span></span>)
         .append(<span class="string"><span class="delimiter">&quot;</span><span class="content">data=</span><span class="delimiter">&quot;</span></span>).append(<span class="predefined-type">Util</span>.printArray(data, <span class="predefined-constant">true</span>))
         .append(<span class="string"><span class="delimiter">&quot;</span><span class="content">}</span><span class="delimiter">&quot;</span></span>).toString();
   }

}</code></pre> </div> </div> <div class="paragraph"> <p>The problem with these classes is that they result in extra memory consumption due to the extra objects required to support data types such as arrays and really, these classes just a workaround for the lack of ability to provide a way to pass in a function that specifies how two byte arrays are are compared, or how to calculate the hash code of a given array.</p> </div> </div> <div class="sect2"> <h3 id="new_solution_plugging_equivalence_functions"><a class="anchor" href="#new_solution_plugging_equivalence_functions"></a>33.3. New solution: Plugging Equivalence functions</h3> <div class="paragraph"> <p>Starting with Infinispan 5.3, Infinispan users can provide these functions for both keys and values implementing the new <a href="https://github.com/infinispan/infinispan/blob/master/commons/src/main/java/org/infinispan/commons/equivalence/Equivalence.java"><code>Equivalence&lt;T&gt;</code></a> interface:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Equivalence</span>&lt;T&gt; <span class="directive">extends</span> <span class="predefined-type">Serializable</span> {

   <span class="comment">/**
    * Returns a hash code value for the object passed.
    *
    * As an example, implementors can provide an alternative implementation
    * for the hash code calculation for arrays. So, instead of relying on
    * {@link Object#hashCode()}, call {@link java.util.Arrays.hashCode()}.
    *
    * @param obj instance to calculate hash code for
    * @return a hash code value for the object passed as parameter
    */</span>
   <span class="type">int</span> hashCode(<span class="predefined-type">Object</span> obj);

   <span class="comment">/**
    * Indicates whether the objects passed are &quot;equal to&quot; each other.
    *
    * As an example, implementors can provide an alternative implementation
    * for the equals for arrays. So, instead of relying on
    * {@link Object#equals(Object)}}, call {@link java.util.Arrays.equals())}.
    *
    * @param obj to be compared with second parameter
    * @param otherObj to be compared with first parameter
    * @return &lt;code&gt;true&lt;/code&gt; if both objects are the same;
    *         &lt;code&gt;false&lt;/code&gt; otherwise
    */</span>
   <span class="type">boolean</span> equals(T obj, <span class="predefined-type">Object</span> otherObj);

   <span class="comment">/**
    * Returns a string representation of the given object.
    *
    * @param obj whose string representation is to be returned
    * @return a string representation of the passed object
    */</span>
   <span class="predefined-type">String</span> toString(<span class="predefined-type">Object</span> obj);

   <span class="comment">/**
    * Returns whether the given object is comparable. In other words, if
    * given an instance of the object, a sensible comparison can be computed
    * using {@link #compare(Object, Object)} method.
    *
    * @param obj instance to check if it's comparable
    * @return &lt;code&gt;true&lt;/code&gt; if the object is comparable;
    *         &lt;code&gt;false&lt;/code&gt; otherwise
    */</span>
   <span class="type">boolean</span> isComparable(<span class="predefined-type">Object</span> obj); <span class="comment">// For future support for objects that are not comparable, i.e. arrays</span>

   <span class="comment">/**
    * Compares the two given objects for order. Returns a negative integer,
    * zero, or a positive integer as the first object is less than, equal to,
    * or greater than the second object.
    *
    * @param obj first object to be compared
    * @param otherObj second object to be compared
    * @return a negative integer, zero, or a positive integer as the
    *         first object is less than, equal to, or greater than the
    *         second object
    */</span>
   <span class="type">int</span> compare(<span class="predefined-type">Object</span> obj, <span class="predefined-type">Object</span> otherObj); <span class="comment">// For future support for objects that are not comparable, i.e. arrays</span>

}</code></pre> </div> </div> <div class="paragraph"> <p>Implementations of these function can be pretty flexible. On one side, they could focus on a single, particular type, such as ByteArrayEquivalence below which expects nothing else other than byte arrays, such as in the case of Hot Rod based Infinispan remote caches:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.acme</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">ByteArrayEquivalence</span> <span class="directive">implements</span> Equivalence&lt;<span class="type">byte</span><span class="type">[]</span>&gt; {

   <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> Equivalence&lt;<span class="type">byte</span><span class="type">[]</span>&gt; INSTANCE = <span class="keyword">new</span> ByteArrayEquivalence();

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">int</span> hashCode(<span class="predefined-type">Object</span> obj) {
      <span class="keyword">return</span> <span class="integer">41</span> + <span class="predefined-type">Arrays</span>.hashCode((<span class="type">byte</span><span class="type">[]</span>) obj);
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">boolean</span> equals(<span class="type">byte</span><span class="type">[]</span> obj, <span class="predefined-type">Object</span> otherObj) {
      <span class="keyword">if</span> (obj == otherObj) <span class="keyword">return</span> <span class="predefined-constant">true</span>;
      <span class="keyword">if</span> (obj == <span class="predefined-constant">null</span>) <span class="keyword">return</span> <span class="predefined-constant">false</span>;
      <span class="keyword">if</span> (otherObj == <span class="predefined-constant">null</span> || <span class="type">byte</span><span class="type">[]</span>.class != otherObj.getClass()) <span class="keyword">return</span> <span class="predefined-constant">false</span>;
      <span class="type">byte</span><span class="type">[]</span> otherByteArray = (<span class="type">byte</span><span class="type">[]</span>) otherObj;
      <span class="keyword">return</span> <span class="predefined-type">Arrays</span>.equals(obj, otherByteArray);
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">String</span> toString(<span class="predefined-type">Object</span> obj) {
      <span class="keyword">return</span> <span class="predefined-type">Arrays</span>.toString((<span class="type">byte</span><span class="type">[]</span>) obj);
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">boolean</span> isComparable(<span class="predefined-type">Object</span> obj) {
      <span class="keyword">return</span> <span class="predefined-constant">false</span>;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">int</span> compare(<span class="predefined-type">Object</span> obj, <span class="predefined-type">Object</span> otherObj) {
      <span class="keyword">return</span> <span class="integer">0</span>; <span class="comment">// irrelevant</span>
   }

}</code></pre> </div> </div> <div class="paragraph"> <p>Or you could have implementations that support multiple different types, in case you store varied information, for example <a href="https://github.com/infinispan/infinispan/blob/master/server/integration/infinispan/src/main/java/org/jboss/as/clustering/infinispan/equivalence/AnyServerEquivalence.java">AnyServerEquivalence</a> which supports both arrays and normal objects:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">AnyServerEquivalence</span> <span class="directive">implements</span> Equivalence&lt;<span class="predefined-type">Object</span>&gt; {

    <span class="directive">private</span> <span class="directive">static</span> <span class="type">boolean</span> isByteArray(<span class="predefined-type">Object</span> obj) {
        <span class="keyword">return</span> <span class="type">byte</span><span class="type">[]</span>.class == obj.getClass();
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">int</span> hashCode(<span class="predefined-type">Object</span> obj) {
        <span class="keyword">if</span> (isByteArray(obj)) {
            <span class="keyword">return</span> <span class="integer">41</span> + <span class="predefined-type">Arrays</span>.hashCode((<span class="type">byte</span><span class="type">[]</span>) obj);
        } <span class="keyword">else</span> {
            <span class="keyword">return</span> obj.hashCode();
        }
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> equals(<span class="predefined-type">Object</span> obj, <span class="predefined-type">Object</span> otherObj) {
        <span class="keyword">if</span> (obj == otherObj)
            <span class="keyword">return</span> <span class="predefined-constant">true</span>;
        <span class="keyword">if</span> (obj == <span class="predefined-constant">null</span> || otherObj == <span class="predefined-constant">null</span>)
            <span class="keyword">return</span> <span class="predefined-constant">false</span>;
        <span class="keyword">if</span> (isByteArray(obj) &amp;&amp; isByteArray(otherObj))
            <span class="keyword">return</span> <span class="predefined-type">Arrays</span>.equals((<span class="type">byte</span><span class="type">[]</span>) obj, (<span class="type">byte</span><span class="type">[]</span>) otherObj);
        <span class="keyword">return</span> obj.equals(otherObj);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> toString(<span class="predefined-type">Object</span> obj) {
        <span class="keyword">if</span> (isByteArray(obj))
            <span class="keyword">return</span> <span class="predefined-type">Arrays</span>.toString((<span class="type">byte</span><span class="type">[]</span>) obj);
        <span class="keyword">else</span>
            <span class="keyword">return</span> obj.toString();
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> isComparable(<span class="predefined-type">Object</span> obj) {
        <span class="keyword">return</span> obj <span class="keyword">instanceof</span> <span class="predefined-type">Comparable</span>;
    }

    <span class="annotation">@Override</span>
    <span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">unchecked</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">int</span> compare(<span class="predefined-type">Object</span> obj, <span class="predefined-type">Object</span> otherObj) {
       <span class="keyword">return</span> ((<span class="predefined-type">Comparable</span>&lt;<span class="predefined-type">Object</span>&gt;) obj).compareTo(otherObj);
    }

}</code></pre> </div> </div> <div class="sect3"> <h4 id="configuring_equivalence_functions"><a class="anchor" href="#configuring_equivalence_functions"></a>33.3.1. Configuring Equivalence functions</h4> <div class="sect4"> <h5 id="using_xml"><a class="anchor" href="#using_xml"></a>Using XML</h5> <div class="paragraph"> <p>The way to configure Infinispan with these Equivalence implementations is by adding them to the <code>&lt;data-container /&gt;</code> XML element. For example, if we wanted to have byte array based keys, but the values would be normal objects, we&#8217;d define:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dataContainer</span> <span class="attribute-name">keyEquivalence</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.acme.ByteArrayEquivalence</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>If you were trying to store both byte arrays as keys and values, you&#8217;d configure valueEquivalence attribute in <code>&lt;dataContainer /&gt;</code> XML element:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dataContainer</span> <span class="attribute-name">keyEquivalence</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.acme.ByteArrayEquivalence</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">valueEquivalence</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.acme.ByteArrayEquivalence</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>If no key or value equivalence is configured, they default to <a href="https://github.com/infinispan/infinispan/blob/master/commons/src/main/java/org/infinispan/commons/equivalence/AnyEquivalence.java">org.infinispan.commons.equivalence.AnyEquivalence</a>, which behaves like any standard java object, delegating the equals/hashCode() calls to the objects themselves.</p> </div> </div> <div class="sect4"> <h5 id="using_programmatic_configuration"><a class="anchor" href="#using_programmatic_configuration"></a>Using Programmatic Configuration</h5> <div class="paragraph"> <p>Key and/or value equivalence could also have been configured programmatically, for example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager cacheManager = ...;
ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder.dataContainer()
   .keyEquivalence(com.acme.ByteArrayEquivalence.INSTANCE)
   .valueEquivalence(com.acme.ByteArrayEquivalence.INSTANCE);
cacheManager.defineConfiguration(<span class="string"><span class="delimiter">&quot;</span><span class="content">myCache</span><span class="delimiter">&quot;</span></span>, builder.build());</code></pre> </div> </div> </div> </div> <div class="sect3"> <h4 id="byte_array_storage_example"><a class="anchor" href="#byte_array_storage_example"></a>33.3.2. Byte array storage example</h4> <div class="paragraph"> <p>Assuming you&#8217;ve configured both keyEquivalence (via XML, or programmatically) to be com.acme.ByteArrayEquivalence , you should now be able to write code like this and get the assertion to succeed. If keyEquivalence has not been configured correctly, this test will fail:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Cache&lt;<span class="type">byte</span><span class="type">[]</span>, <span class="type">byte</span><span class="type">[]</span>&gt; cache = ...
byte<span class="type">[]</span> key = {<span class="integer">1</span>, <span class="integer">2</span>, <span class="integer">3</span>};
<span class="type">byte</span><span class="type">[]</span> value = {<span class="integer">4</span>, <span class="integer">5</span>, <span class="integer">6</span>};
cache.put(key, value);

<span class="type">byte</span><span class="type">[]</span> expectedValue = {<span class="integer">4</span>, <span class="integer">5</span>, <span class="integer">6</span>};
<span class="type">byte</span><span class="type">[]</span> lookupKey = {<span class="integer">1</span>, <span class="integer">2</span>, <span class="integer">3</span>};
<span class="keyword">assert</span> <span class="predefined-type">Arrays</span>.equals(expectedValue, cache.get(lookupKey));</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="other_methods_in_equivalence_interface"><a class="anchor" href="#other_methods_in_equivalence_interface"></a>33.3.3. Other methods in Equivalence interface</h4> <div class="paragraph"> <p>Finally, Equivalence defines some extra methods, such as toString(Object obj) , isComparable(Object obj) and compare(Object obj, Object otherObj) , which again can be used to provide different implementations to the ones provided for the JDK. For example, the toString() method can be used to provide a different String representation of the object, which is again useful for arrays since the default JDK implementation does not print the array contents. The comparable functions are not yet used by Infinispan but they&#8217;ve been defined in order to help with potential future support of tree-based storage in inner data structures.</p> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="interoperability_between_embedded_and_remote_server_endpoints"><a class="anchor" href="#interoperability_between_embedded_and_remote_server_endpoints"></a>34. Interoperability between Embedded and Remote Server Endpoints</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan offers the possibility to store and retrieve data in a <a href="#_the_cache_interface">local embedded way</a>, and also <a href="#_server_modules">remotely thanks to the multiple endpoints offered</a>, but until now if you choose one way to access the data, you were stuck with it. For example, you could not store data using the embedded interface and retrieve it via REST.</p> </div> <div class="paragraph"> <p>Starting with Infinispan 5.3, it is now possible to configure Infinispan caches to work in a special, compatibility mode for those users interested in accessing Infinispan in multiple ways. Achieving such compatibility requires extra work from Infinispan in order to make sure that contents are converted back and forth between the different formats of each endpoint and this is the reason why compatibility mode is disabled by default.</p> </div> <div class="sect2"> <h3 id="enable_compatibility_mode"><a class="anchor" href="#enable_compatibility_mode"></a>34.1. Enable Compatibility Mode</h3> <div class="paragraph"> <p>For compatibility mode to work as expected, all endpoints need to be configured with the same cache manager, and need to talk to the same cache. If you&#8217;re using the brand new <a href="http://www.jboss.org/infinispan/downloads">Infinispan Server distribution</a> , this is all done for you. If you&#8217;re in the mood to experiment with this in a standalone unit test, <a href="https://github.com/infinispan/infinispan/blob/master/integrationtests/compatibility-mode-it/src/test/java/org/infinispan/it/compatibility/CompatibilityCacheFactory.java">this class</a> shows you how you can start multiple endpoints from a single class.</p> </div> <div class="paragraph"> <p>So, to get started using Infinispan&#8217;s compatibility mode, it needs to be enabled, either via XML:</p> </div> <div class="listingblock"> <div class="title">infinispan.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;local-cache&gt;</span>
   <span class="tag">&lt;compatibility</span><span class="tag">/&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Or programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = ...
builder.compatibility().enable();</code></pre> </div> </div> <div class="paragraph"> <p>The key thing to remember about Infinispan&#8217;s compatibility mode is that where possible, it tries to store data unmarshalling or deserializing it. It does so because the most common use case is for it to store Java objects and having Java objects stored in deserialized form means that they&#8217;re very easy to use from an embedded cache. With this in mind, it makes some assumptions. For example, if something is stored via Hot Rod, it&#8217;s most likely coming from the reference Hot Rod client, which is written in Java, and which uses a marshaller that keeps binary payloads very compact. So, when the Hot Rod operation reaches the compatibility layer, it will try to unmarshall it, by default using the same default marshaller used by the Java Hot Rod client, hence providing good out-of-the-box support for the majority of cases.</p> </div> <div class="sect3"> <h4 id="optional_configuring_compatibility_marshaller"><a class="anchor" href="#optional_configuring_compatibility_marshaller"></a>34.1.1. Optional: Configuring Compatibility Marshaller</h4> <div class="paragraph"> <p>It could happen though the client might be using a Hot Rod client written for another language other than Java, say <a href="https://github.com/infinispan/ruby-client">Ruby</a> or <a href="https://github.com/infinispan/python-client">Python</a> . In this case, some kind of custom marshaller needs to be configured that either translates that serialized payload into a Java object to be stored in the cache, or keeps it in serialized form. Both options are valid, but of course it will have an impact on what kind of objects are retrieved from Infinispan if using the embedded cache. The marshaller is expected to implement <a href="http://docs.jboss.org/infinispan/8.2/apidocs/org/infinispan/commons/marshall/Marshaller.html">this interface</a> . Configuring the compatibility marshaller is optional and can be done via XML:</p> </div> <div class="listingblock"> <div class="title">infinispan.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;local-cache&gt;</span>
   <span class="tag">&lt;compatibility</span> <span class="attribute-name">marshaller</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.acme.CustomMarshaller</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Or programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = ...
builder.compatibility().enable().marshaller(<span class="keyword">new</span> com.acme.CustomMarshaller());</code></pre> </div> </div> <div class="paragraph"> <p>One concrete example of this marshaller logic can be found in the <a href="https://github.com/infinispan/infinispan/blob/master/integrationtests/compatibility-mode-it/src/test/java/org/infinispan/it/compatibility/EmbeddedRestMemcachedHotRodTest.java#L161">SpyMemcachedCompatibleMarshaller</a> . <a href="https://code.google.com/p/spymemcached/">Spy Memcached</a> uses their own transcoders in order to marshall objects, so the compatibility marshaller created is in charge of marshalling/unmarshalling data stored via Spy Memcached client. If you want to retrieve data stored via Spy Memcached via say Hot Rod, you can <a href="#_java_hot_rod_client">configure the Java Hot Rod client to use this same marshaller</a>, and this is precisely what the test where the Spy Memcached marshaller is located is demonstrating.</p> </div> </div> </div> <div class="sect2"> <h3 id="code_examples"><a class="anchor" href="#code_examples"></a>34.2. Code examples</h3> <div class="paragraph"> <p>The best code examples available showing compatibility in action can be found in the <a href="https://github.com/infinispan/infinispan/tree/master/integrationtests/compatibility-mode-it/src/test/java/org/infinispan/it/compatibility">Infinispan Compatibility Mode testsuite</a>, but more will be developed in the near future.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="security"><a class="anchor" href="#security"></a>35. Security</h2> <div class="sectionbody"> <div class="paragraph"> <p>Security within Infinispan is implemented at several layers:</p> </div> <div class="ulist"> <ul> <li> <p>within the core library, to provide coarse-grained access control to CacheManagers, Caches and data</p> </li> <li> <p>over remote protocols, to obtain credentials from remote clients and to secure the transport using encryption</p> </li> <li> <p>between nodes in a cluster, so that only authorized nodes can join and to secure the transport using encryption</p> </li> </ul> </div> <div class="paragraph"> <p>In order to maximize compatibility and integration, Infinispan uses widespread security standards where possible and appropriate, such as X.509 certificates, SSL/TLS encryption and Kerberos/GSSAPI. Also, to avoid pulling in any external dependencies and to increase the ease of integration with third party libraries and containers, the implementation makes use of any facilities provided by the standard Java security libraries (JAAS, JSSE, JCA, JCE, SASL, etc). For this reason, the Infinispan core library only provides interfaces and a set of basic implementations.</p> </div> <div class="sect2"> <h3 id="embedded_security"><a class="anchor" href="#embedded_security"></a>35.1. Embedded Security</h3> <div class="paragraph"> <p>Applications interact with Infinispan using its API within the same JVM. The two main components which are exposed by the Infinispan API are CacheManagers and Caches. If an application wants to interact with a secured CacheManager and Cache, it should provide an identity which Infinispanâs security layer will validate against a set of required roles and permissions. If the identity provided by the user application has sufficient permissions, then access will be granted, otherwise an exception indicating a security violation will be thrown. The identity is represented by the javax.security.auth.Subject class which is a wrapper around multiple Principals, e.g. a user and all the groups it belongs to. Since the Principal name is dependent on the owning system (e.g. a Distinguished Name in LDAP), Infinispan needs to be able to map Principal names to roles. Roles, in turn, represent one or more permissions. The following diagram shows the relationship between the various elements:</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/SecurityRolesPermissions.png" alt="Roles/Permissions mapping"> </div> <div class="title">Figure 5. Roles/Permissions mapping</div> </div> <div class="sect3"> <h4 id="embedded_permissions"><a class="anchor" href="#embedded_permissions"></a>35.1.1. Embedded Permissions</h4> <div class="paragraph"> <p>Access to a cache manager or a cache is controlled by using a list of required permissions. Permissions are concerned with the type of action that is performed on one of the above entities and not with the type of data being manipulated. Some of these permissions can be narrowed to specifically named entities, where applicable (e.g. a named cache). Depending on the type of entity, there are different types of permission available:</p> </div> <div class="sect4"> <h5 id="cache_manager_permissions"><a class="anchor" href="#cache_manager_permissions"></a>Cache Manager permissions</h5> <div class="ulist"> <ul> <li> <p>CONFIGURATION (defineConfiguration): whether a new cache configuration can be defined</p> </li> <li> <p>LISTEN (addListener): whether listeners can be registered against a cache manager</p> </li> <li> <p>LIFECYCLE (stop): whether the cache manager can be stopped</p> </li> <li> <p>ALL: a convenience permission which includes all of the above</p> </li> </ul> </div> </div> <div class="sect4"> <h5 id="cache_permissions"><a class="anchor" href="#cache_permissions"></a>Cache permissions</h5> <div class="ulist"> <ul> <li> <p>READ (get, contains): whether entries can be retrieved from the cache</p> </li> <li> <p>WRITE (put, putIfAbsent, replace, remove, evict): whether data can be written/replaced/removed/evicted from the cache</p> </li> <li> <p>EXEC (distexec, mapreduce): whether code execution can be run against the cache</p> </li> <li> <p>LISTEN (addListener): whether listeners can be registered against a cache</p> </li> <li> <p>BULK_READ (keySet, values, entrySet, query): whether bulk retrieve operations can be executed</p> </li> <li> <p>BULK_WRITE (clear, putAll): whether bulk write operations can be executed</p> </li> <li> <p>LIFECYCLE (start, stop): whether a cache can be started / stopped</p> </li> <li> <p>ADMIN (getVersion, addInterceptor*, removeInterceptor, getInterceptorChain, getEvictionManager, getComponentRegistry, getDistributionManager, getAuthorizationManager, evict, getRpcManager, getCacheConfiguration, getCacheManager, getInvocationContextContainer, setAvailability, getDataContainer, getStats, getXAResource): whether access to the underlying components/internal structures is allowed</p> </li> <li> <p>ALL: a convenience permission which includes all of the above</p> </li> <li> <p>ALL_READ: combines READ and BULK_READ</p> </li> <li> <p>ALL_WRITE: combines WRITE and BULK_WRITE</p> </li> </ul> </div> <div class="paragraph"> <p>Some permissions might need to be combined with others in order to be useful. For example, suppose you want to allow only "supervisors" to be able to run stream operations, while "standard" users can only perform puts and gets, you would define the following mappings:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">standard</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">permission</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">READ WRITE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;role</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">supervisors</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">permission</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">READ WRITE EXEC BULK</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> </div> </div> <div class="sect3"> <h4 id="embedded_api"><a class="anchor" href="#embedded_api"></a>35.1.2. Embedded API</h4> <div class="paragraph"> <p>When a DefaultCacheManager has been constructed with security enabled using either the programmatic or declarative configuration, it returns a SecureCache which will check the security context before invoking any operations on the underlying caches. A SecureCache also makes sure that applications cannot retrieve lower-level insecure objects (such as DataContainer). In Java, executing code with a specific identity usually means wrapping the code to be executed within a PrivilegedAction:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.security.Security</span>;

<span class="predefined-type">Security</span>.doAs(subject, <span class="keyword">new</span> <span class="predefined-type">PrivilegedExceptionAction</span>&lt;<span class="predefined-type">Void</span>&gt;() {
<span class="directive">public</span> <span class="predefined-type">Void</span> run() <span class="directive">throws</span> <span class="exception">Exception</span> {
    cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
}
});</code></pre> </div> </div> <div class="paragraph"> <p>If you are using Java 8, the above call can be simplified to:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Security</span>.doAs(mySubject, <span class="predefined-type">PrivilegedAction</span>&lt;<span class="predefined-type">String</span>&gt;() -&gt; cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>));</code></pre> </div> </div> <div class="paragraph"> <p>Notice the use of Security.doAs() in place of the typical Subject.doAs(). While in Infinispan you can use either, unless you really need to modify the AccessControlContext for reasons specific to your application&#8217;s security model, using Security.doAs() provides much better performance. If you need the current Subject, use the following:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Security</span>.getSubject();</code></pre> </div> </div> <div class="paragraph"> <p>which will automatically retrieve the Subject either from the Infinispan&#8217;s context or from the AccessControlContext.</p> </div> <div class="paragraph"> <p>Infinispan also fully supports running under a full-blown SecurityManager. The Infinispan distribution contains an example security.policy file which you should customize with the appropriate paths before supplying it to your JVM.</p> </div> </div> <div class="sect3"> <h4 id="embedded_configuration"><a class="anchor" href="#embedded_configuration"></a>35.1.3. Embedded Configuration</h4> <div class="paragraph"> <p>There are two levels of configuration: global and per-cache. The global configuration defines the set of roles/permissions mappings while each cache can decide whether to enable authorization checks and the required roles.</p> </div> <div class="listingblock"> <div class="title">Programmatic</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">  GlobalConfigurationBuilder global = <span class="keyword">new</span> GlobalConfigurationBuilder();
  global
     .security()
        .authorization()
           .principalRoleMapper(<span class="keyword">new</span> IdentityRoleMapper())
           .role(<span class="string"><span class="delimiter">&quot;</span><span class="content">admin</span><span class="delimiter">&quot;</span></span>)
              .permission(CachePermission.ALL)
           .role(<span class="string"><span class="delimiter">&quot;</span><span class="content">supervisor</span><span class="delimiter">&quot;</span></span>)
              .permission(CachePermission.EXEC)
              .permission(CachePermission.READ)
              .permission(CachePermission.WRITE)
           .role(<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>)
              .permission(CachePermission.READ);
  ConfigurationBuilder config = <span class="keyword">new</span> ConfigurationBuilder();
  config
     .security()
        .enable()
        .authorization()
           .role(<span class="string"><span class="delimiter">&quot;</span><span class="content">admin</span><span class="delimiter">&quot;</span></span>)
           .role(<span class="string"><span class="delimiter">&quot;</span><span class="content">supervisor</span><span class="delimiter">&quot;</span></span>)
           .role(<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="listingblock"> <div class="title">Declarative</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
   <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;security&gt;</span>
         <span class="tag">&lt;authorization</span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;identity-role-mapper</span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;role</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">admin</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">permissions</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;role</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">permissions</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">READ</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;role</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">permissions</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">WRITE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;role</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">supervisor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">permissions</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">READ WRITE EXEC BULK</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;/authorization&gt;</span>
      <span class="tag">&lt;/security&gt;</span>
      <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;security&gt;</span>
            <span class="tag">&lt;authorization</span> <span class="attribute-name">roles</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">admin reader writer supervisor</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;/security&gt;</span>
      <span class="tag">&lt;/local-cache&gt;</span>
   <span class="tag">&lt;/cache-container&gt;</span>

<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> <div class="sect4"> <h5 id="role_mappers"><a class="anchor" href="#role_mappers"></a>Role Mappers</h5> <div class="paragraph"> <p>In order to convert the Principals in a Subject into a set of roles to be used when authorizing, a suitable PrincipalRoleMapper must be specified in the global configuration. Infinispan comes with 3 mappers and also allows you to provide a custom one:</p> </div> <div class="ulist"> <ul> <li> <p>IdentityRoleMapper (Java: org.infinispan.security.impl.IdentityRoleMapper, XML: &lt;identity-role-mapper /&gt;): this mapper just uses the Principal name as the role name</p> </li> <li> <p>CommonNameRoleMapper (Java: org.infinispan.security.impl.CommonRoleMapper, XML: &lt;common-name-role-mapper /&gt;): if the Principal name is a Distinguished Name (DN), this mapper extracts the Common Name (CN) and uses it as a role name. For example the DN cn=managers,ou=people,dc=example,dc=com will be mapped to the role managers</p> </li> <li> <p>ClusterRoleMapper (Java: org.infinispan.security.impl.ClusterRoleMapper XML: &lt;cluster-role-mapper /&gt;): a mapper which uses the ClusterRegistry to store principal to role mappings. This allows the use of the CLI&#8217;s GRANT and DENY commands to add/remove roles to a principal.</p> </li> <li> <p>Custom role mappers (XML: &lt;custom-role-mapper class="a.b.c" /&gt;): just supply the fully-qualified class name of an implementation of org.infinispan.security.PrincipalRoleMapper</p> </li> </ul> </div> </div> </div> </div> <div class="sect2"> <h3 id="security_audit"><a class="anchor" href="#security_audit"></a>35.2. Security Audit</h3> <div class="paragraph"> <p>Infinispan offers a pluggable audit logger which tracks whether a cache or a cache manager operation was allowed or denied. The audit logger is configured at the cache container authorization level:</p> </div> <div class="listingblock"> <div class="title">Programmatic</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">  GlobalConfigurationBuilder global = <span class="keyword">new</span> GlobalConfigurationBuilder();
  global
     .authorization()
        .auditLogger(<span class="keyword">new</span> LoggingAuditLogger());</code></pre> </div> </div> <div class="listingblock"> <div class="title">Declarative</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
   <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;security&gt;</span>
         <span class="tag">&lt;authorization</span> <span class="attribute-name">audit-logger</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.security.impl.LoggingAuditLogger</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            ...
         <span class="tag">&lt;/authorization&gt;</span>
      <span class="tag">&lt;/security&gt;</span>
      ...
   <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>In embedded mode the default audit logger is org.infinispan.security.impl.NullAuditLogger which does nothing. Infinispan also comes with the org.infinispan.security.impl.LoggingAuditLogger which outputs audit logs through the available logging framework (e.g. Log4J) at level TRACE and category AUDIT. These logs look like:</p> </div> <div class="listingblock"> <div class="content"> <pre>[ALLOW|DENY] user READ cache[defaultCache]</pre> </div> </div> <div class="paragraph"> <p>Using an appropriate logging appender it is possible to send the AUDIT category either to a log file, a JMS queue, a database, etc. The user which is included in the log above is the name of the first non-java.security.acl.Group principal in the Subject.</p> </div> </div> <div class="sect2"> <h3 id="cluster_security"><a class="anchor" href="#cluster_security"></a>35.3. Cluster security</h3> <div class="paragraph"> <p>JGroups can be configured so that nodes need to authenticate each other when joining / merging. The authentication uses SASL and is setup by adding the SASL protocol to your JGroups XML configuration above the GMS protocol, as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;SASL</span> <span class="attribute-name">mech</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DIGEST-MD5</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">client_name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node_user</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">client_password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node_password</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">server_callback_handler_class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.example.infinispan.security.JGroupsSaslServerCallbackHandler</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">client_callback_handler_class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.example.infinispan.security.JGroupsSaslClientCallbackHandler</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">sasl_props</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.sun.security.sasl.digest.realm=test_realm</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>In the above example, the SASL mech will be DIGEST-MD5. Each node will need to declare the user and password it will use when joining the cluster. The behaviour of a node differs depending on whether it is the coordinator or any other node. The coordinator acts as the SASL server, whereas joining/merging nodes act as SASL clients. Therefore two different CallbackHandlers are required, the server_callback_handler_class will be used by the coordinator, and the client_callback_handler_class will be used by the other nodes. The SASL protocol in JGroups is only concerned with the authentication process. If you wish to implement node authorization, you can do so within the server callback handler, by throwing an Exception. The following example shows how this can be done:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">AuthorizingServerCallbackHandler</span> <span class="directive">implements</span> <span class="predefined-type">CallbackHandler</span> {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> handle(<span class="predefined-type">Callback</span><span class="type">[]</span> callbacks) <span class="directive">throws</span> <span class="exception">IOException</span>, <span class="exception">UnsupportedCallbackException</span> {
        <span class="keyword">for</span> (<span class="predefined-type">Callback</span> callback : callbacks) {
            ...
            if (callback <span class="keyword">instanceof</span> <span class="predefined-type">AuthorizeCallback</span>) {
                <span class="predefined-type">AuthorizeCallback</span> acb = (<span class="predefined-type">AuthorizeCallback</span>) callback;
                UserProfile user = UserManager.loadUser(acb.getAuthenticationID());
                <span class="keyword">if</span> (!user.hasRole(<span class="string"><span class="delimiter">&quot;</span><span class="content">myclusterrole</span><span class="delimiter">&quot;</span></span>)) {
                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">SecurityException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Unauthorized node </span><span class="delimiter">&quot;</span></span> +user);
                }
            }
            ...
        }
    }
}</code></pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="functional_map_api"><a class="anchor" href="#functional_map_api"></a>36. Functional Map API</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan 8 introduces a new experimental API for interacting with your data which takes advantage of the functional programming additions and improved asynchronous programming capabilities available in Java 8.</p> </div> <div class="paragraph"> <p>Infinispan&#8217;s <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.html">Functional Map API</a> is a distilled map-like asynchronous API which uses functions to interact with data.</p> </div> <div class="sect2"> <h3 id="asynchronous_and_lazy"><a class="anchor" href="#asynchronous_and_lazy"></a>36.1. Asynchronous and Lazy</h3> <div class="paragraph"> <p>Being an asynchronous API, all methods that return a single result, return a CompletableFuture which wraps the result, so you can use the resources of your system more efficiently by having the possibility to receive callbacks when the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html"><code>CompletableFuture</code></a> has completed, or you can chain or compose them with other CompletableFuture.</p> </div> <div class="paragraph"> <p>For those operations that return multiple results, the API returns instances of a <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/Traversable.html"><code>âTraversable</code></a> interface which offers a lazy pull-style API for working with multiple results. <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/Traversable.html"><code>âTraversable</code></a> ,â being a lazy pull-style API, can still be asynchronous underneath since the user can decide to work on the traversable at a later stage, and the <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/Traversable.html"><code>âTraversable</code></a> implementation itself can decide when to compute those results.</p> </div> </div> <div class="sect2"> <h3 id="function_transparency"><a class="anchor" href="#function_transparency"></a>36.2. Function transparency</h3> <div class="paragraph"> <p>Since the content of the functions is transparent to Infinispan, the API has been split into 3 interfaces for readÂ­-only ( <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadOnlyMap.html"><code>RâeadOnlyMap</code></a> )â, readÂ­-write ( <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadWriteMap.html"><code>RâeadWriteMap</code></a> )â and writeÂ­-only ( <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html"><code>WâriteOnlyMap</code></a> )â operations respectively, in order to provide hints to the Infinispan internals on the type of work needed to support functions.</p> </div> </div> <div class="sect2"> <h3 id="constructing_functional_maps"><a class="anchor" href="#constructing_functional_maps"></a>36.3. Constructing Functional Maps</h3> <div class="paragraph"> <p>To construct any of the read-only, write-only or read-write map instances, an Infinispan <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/AdvancedCache.html"><code>AdvancedCache</code></a> is required, which is retrieved from the Cache Manager, and using the <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/AdvancedCache.html"><code>AdvancedCache</code></a> , static method factory methods are used to create <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadOnlyMap.html"><code>RâeadOnlyMap</code></a> , <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadWriteMap.html"><code>RâeadWriteMap</code></a> or <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html"><code>WâriteOnlyMap</code></a> :</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.impl</span>.*;

AdvancedCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = ...

FunctionalMapImpl&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; functionalMap = FunctionalMapImpl.create(cache);
ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ReadOnlyMapImpl.create(functionalMap);
WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = WriteOnlyMapImpl.create(functionalMap);
ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readWriteMap = ReadWriteMapImpl.create(functionalMap);</code></pre> </div> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> At this stage, the Functional Map API is experimental and hence the way FunctionalMap, ReadOnlyMap, WriteOnlyMap and ReadWriteMap are constructed is temporary. </td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="read_only_map_api"><a class="anchor" href="#read_only_map_api"></a>36.4. Read-Only Map API</h3> <div class="paragraph"> <p>Read-only operations have the advantage that no locks are acquired for the duration of the operation. Here&#8217;s an example on how to the equivalent operation for <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#get-java.lang.Object-">Map.get(K)</a> :</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;

ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...
CompletableFuture&lt;Optional&lt;<span class="predefined-type">String</span>&gt;&gt; readFuture = readOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, ReadEntryView::find);
readFuture.thenAccept(<span class="predefined-type">System</span>.out::println);</code></pre> </div> </div> <div class="paragraph"> <p>Read-only map also exposes operations to retrieve multiple keys in one go:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.Traversable</span>;

ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...

Set&lt;<span class="predefined-type">String</span>&gt; keys = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;&gt;(<span class="predefined-type">Arrays</span>.asList(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">key2</span><span class="delimiter">&quot;</span></span>));
Traversable&lt;<span class="predefined-type">String</span>&gt; values = readOnlyMap.evalMany(keys, ReadEntryView::get);
values.forEach(<span class="predefined-type">System</span>.out::println);</code></pre> </div> </div> <div class="paragraph"> <p>Finally, read-only map also exposes methods to read all existing keys as well as entries, which include both key and value information.</p> </div> <div class="sect3"> <h4 id="_read_only_entry_view"><a class="anchor" href="#_read_only_entry_view"></a>36.4.1. Read-Only Entry View</h4> <div class="paragraph"> <p>The function parameters for read-only maps provide the user with a <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/EntryView.ReadEntryView.html">read-only entry view</a> to interact with the data in the cache, which include these operations:</p> </div> <div class="ulist"> <ul> <li> <p><a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/EntryView.ReadEntryView.html#key--"><code>key()</code></a> method returns the key for which this function is being executed.</p> </li> <li> <p><a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/EntryView.ReadEntryView.html#find--"><code>find()</code></a> returns a Java 8 <code>Optional</code> wrapping the value if present, otherwise it returns an empty optional. Unless the value is guaranteed to be associated with the key, it&#8217;s recommended to use <code>find()</code> to verify whether there&#8217;s a value associated with the key.</p> </li> <li> <p><a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/EntryView.ReadEntryView.html#get--"><code>get()</code></a> returns the value associated with the key. If the key has no value associated with it, calling <code>get()</code> throws a <code>NoSuchElementException</code>. <code>get()</code> can be considered as a shortcut of <code>ReadEntryView.find().get()</code> which should be used only when the caller has guarantees that there&#8217;s definitely a value associated with the key.</p> </li> <li> <p><a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/MetaParam.Lookup.html#findMetaParam-java.lang.Class-"><code>findMetaParam(Class&lt;T&gt; type)</code></a> allows metadata parameter information associated with the cache entry to be looked up, for example: entry lifespan, last accessed time&#8230;&#8203;etc. See <a href="#_meta_parameter">Metadata Parameter Handling section</a> to find out more.</p> </li> </ul> </div> </div> </div> <div class="sect2"> <h3 id="write_only_map_api"><a class="anchor" href="#write_only_map_api"></a>36.5. Write-Only Map API</h3> <div class="paragraph"> <p>Write-only operations include operations that insert or update data in the cache and also removals. Crucially, a write-only operation does not attempt to read any previous value associated with the key. This is an important optimization since that means neither the cluster nor any persistence stores will be looked up to retrieve previous values. In the main Infinispan Cache, this kind of optimization was achieved using a local-only per-invocation flag, but the use case is so common that in this new functional API, this optimization is provided as a first-class citizen.</p> </div> <div class="paragraph"> <p>Using <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html">write-only map API</a> , an operation equivalent to <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>javax.cache.Cache</code> (<code>JCache</code>)</a> 's void returning <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java#L194"><code>put</code></a> can be achieved this way, followed by an attempt to read the stored value using the read-only map API:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...
ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; writeFuture = writeOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>,
   (v, view) -&gt; view.set(v));
CompletableFuture&lt;<span class="predefined-type">String</span>&gt; readFuture = writeFuture.thenCompose(r -&gt;
   readOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, ReadEntryView::get));
readFuture.thenAccept(<span class="predefined-type">System</span>.out::println);</code></pre> </div> </div> <div class="paragraph"> <p>Multiple key/value pairs can be stored in one go using <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html#evalMany-java.util.Map-java.util.function.BiConsumer-"><code>evalMany</code></a> API:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...

Map&lt;K, <span class="predefined-type">String</span>&gt; data = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
data.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>);
data.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value2</span><span class="delimiter">&quot;</span></span>);
CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; writerAllFuture = writeOnlyMap.evalMany(data, (v, view) -&gt; view.set(v));
writerAllFuture.thenAccept(x -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">Write completed</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>To remove all contents of the cache, there are two possibilities with different semantics. If using <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html#evalAll-java.util.function.Consumer-"><code>evalAll</code></a> each cached entry is iterated over and the function is called with that entry&#8217;s information. Using this method also results in listeners (see <a href="#_functional_listeners">functional listeners section</a> for more information) being invoked:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; removeAllFuture = writeOnlyMap.evalAll(WriteEntryView::remove);
removeAllFuture.thenAccept(x -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">All entries removed</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>The alternative way to remove all entries is to call <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html#truncate--"><code>truncate</code></a> operation which clears the entire cache contents in one go without invoking any listeners and is best-effort:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; truncateFuture = writeOnlyMap.truncate();
truncateFuture.thenAccept(x -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">Cache contents cleared</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="sect3"> <h4 id="_write_only_entry_view"><a class="anchor" href="#_write_only_entry_view"></a>36.5.1. Write-Only Entry View</h4> <div class="paragraph"> <p>The function parameters for write-only maps provide the user with a <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/EntryView.WriteEntryView.html">write-only entry view</a> to modify the data in the cache, which include these operations:</p> </div> <div class="ulist"> <ul> <li> <p><a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/EntryView.WriteEntryView.html#set-V-org.infinispan.commons.api.functional.MetaParam.Writable&#8230;&#8203;-"><code>set(V, MetaParam.Writable&#8230;&#8203;)</code></a> method allows for a new value to be associated with the cache entry for which this function is executed, and it optionally takes zero or more metadata parameters to be stored along with the value (see <a href="#_meta_parameter">Metadata Parameter Handling section</a> to find out more).</p> </li> <li> <p><a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/EntryView.WriteEntryView.html#remove--"><code>remove()</code></a> method removes the cache entry, including both value and metadata parameters associated with this key.</p> </li> </ul> </div> </div> </div> <div class="sect2"> <h3 id="read_write_map_api"><a class="anchor" href="#read_write_map_api"></a>36.6. Read-Write Map API</h3> <div class="paragraph"> <p>The final type of operations we have are readÂ­write operations, and within this category CAS-like (CompareÂ­AndÂ­Swap) operations can be found. This type of operations require previous value associated with the key to be read and for locks to be acquired before executing the function. The vast majority of operations within <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html"><code>ConcurrentMap</code></a> and <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>JCache</code></a> APIs fall within this category, and they can easily be implemented using the <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadWriteMap.html">read-write map API</a> . Moreover, with <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadWriteMap.html">read-write map API</a> , you can make CASÂ­like comparisons not only based on value equality but based on metadata parameter equality such as version information, and you can send back previous value or boolean instances to signal whether the CASÂ­like comparison succeeded.</p> </div> <div class="paragraph"> <p>Implementing a write operation that returns the previous value associated with the cache entry is easy to achieve with the read-write map API:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;

ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readWriteMap = ...

CompletableFuture&lt;Optional&lt;<span class="predefined-type">String</span>&gt;&gt; readWriteFuture = readWriteMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>,
   (v, view) -&gt; {
      Optional&lt;V&gt; prev = rw.find();
      view.set(v);
      <span class="keyword">return</span> prev;
   });
readWriteFuture.thenAccept(<span class="predefined-type">System</span>.out::println);</code></pre> </div> </div> <div class="paragraph"> <p><a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html#replace-K-V-V-"><code>ConcurrentMap.replace(K, V, V)</code></a> is a replace function that compares the value present in the map and if it&#8217;s equals to the value passed in as first parameter, the second value is stored, returning a boolean indicating whether the replace was successfully completed. This operation can easily be implemented using the read-write map API:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readWriteMap = ...

String oldValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">old-value</span><span class="delimiter">&quot;</span></span>;
CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; replaceFuture = readWriteMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>, (v, view) -&gt; {
   <span class="keyword">return</span> view.find().map(prev -&gt; {
      <span class="keyword">if</span> (prev.equals(oldValue)) {
         rw.set(v);
         <span class="keyword">return</span> <span class="predefined-constant">true</span>; <span class="comment">// previous value present and equals to the expected one</span>
      }
      <span class="keyword">return</span> <span class="predefined-constant">false</span>; <span class="comment">// previous value associated with key does not match</span>
   }).orElse(<span class="predefined-constant">false</span>); <span class="comment">// no value associated with this key</span>
});
replaceFuture.thenAccept(replaced -&gt; <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Value was replaced? %s%n</span><span class="delimiter">&quot;</span></span>, replaced));</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> The function in the example above captures <code>oldValue</code> which is an external value to the function which is valid use case. </td> </tr> </table> </div> <div class="paragraph"> <p>Read-write map API contains <code>evalMany</code> and <code>evalAll</code> operations which behave similar to the write-only map offerings, except that they enable previous value and metadata parameters to be read.</p> </div> <div class="sect3"> <h4 id="_read_write_entry_view"><a class="anchor" href="#_read_write_entry_view"></a>36.6.1. Read-Write Entry View</h4> <div class="paragraph"> <p>The function parameters for read-write maps provide the user with the possibility to query the information associated with the key, including value and metadata parameters, and the user can also use this <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/EntryView.ReadWriteEntryView.html">read-write entry view</a> to modify the data in the cache.</p> </div> <div class="paragraph"> <p>The operations are exposed by read-write entry views are a union of the operations exposed by <a href="#_read-only_entry_view">read-only entry views</a> and <a href="#_write_only_entry_view">write-only entry views</a></p> </div> </div> </div> <div class="sect2"> <h3 id="_meta_parameter"><a class="anchor" href="#_meta_parameter"></a>36.7. Metadata Parameter Handling</h3> <div class="paragraph"> <p><a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/MetaParam.html">Metadata parameters</a> provide extra information about the cache entry, such as version information, lifespan, last accessed/used time&#8230;&#8203;etc. Some of these can be provided by the user, e.g. version, lifespan&#8230;&#8203;etc, but some others are computed internally and can only be queried, e.g. last accessed/used time.</p> </div> <div class="paragraph"> <p>The functional map API provides a flexible way to store metadata parameters along with an cache entry. To be able to store a metadata parameter, it must extend <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/MetaParam.Lookup.html"><code>MetaParam.Writable</code></a> interface, and implement the methods to allow the internal logic to extra the data. Storing is done via the <code>set(V, MetaParam.Writable&#8230;&#8203;)</code> method in <a href="#_write_only_entry_view">write-only entry view</a> or <a href="#_read_write_entry_view">read-write entry view</a> function parameters.</p> </div> <div class="paragraph"> <p>Querying metadata parameters is available via the <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/MetaParam.Lookup.html#findMetaParam-java.lang.Class-"><code>findMetaParam(Class)</code></a> method available via <a href="#_read_write_entry_view">read-write entry view</a> or <a href="#_read_only_entry_view">read-only entry view</a> or function parameters.</p> </div> <div class="paragraph"> <p>Here is an example showing how to store metadata parameters and how to query them:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.time.Duration</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.MetaParam</span>.*;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...
ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; writeFuture = writeOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>,
   (v, view) -&gt; view.set(v, <span class="keyword">new</span> MetaLifespan(<span class="predefined-type">Duration</span>.ofHours(<span class="integer">1</span>).toMillis())));
CompletableFuture&lt;MetaLifespan&gt; readFuture = writeFuture.thenCompose(r -&gt;
   readOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, view -&gt; view.findMetaParam(MetaLifespan.class).get()));
readFuture.thenAccept(<span class="predefined-type">System</span>.out::println);</code></pre> </div> </div> <div class="paragraph"> <p>If the metadata parameter is generic, for example <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/MetaParam.MetaEntryVersion.html"><code>MetaEntryVersion&lt;T&gt;</code></a> , retrieving the metadata parameter along with a specific type can be tricky if using <code>.class</code> static helper in a class because it does not return a <code>Class&lt;T&gt;</code> but only <code>Class</code>, and hence any generic information in the class is lost:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">String</span>&gt; readFuture = readOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, view -&gt; {
   <span class="comment">// If caller depends on the typed information, this is not an ideal way to retrieve it</span>
   <span class="comment">// If the caller does not depend on the specific type, this works just fine.</span>
   Optional&lt;MetaEntryVersion&gt; version = view.findMetaParam(MetaEntryVersion.class);
   <span class="keyword">return</span> view.get();
});</code></pre> </div> </div> <div class="paragraph"> <p>When generic information is important the user can define a static helper method that coerces the static class retrieval to the type requested, and then use that helper method in the call to <code>findMetaParam</code>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">MetaEntryVersion</span>&lt;T&gt; <span class="directive">implements</span> MetaParam.Writable&lt;EntryVersion&lt;T&gt;&gt; {
   ...
   public <span class="directive">static</span> &lt;T&gt; T type() { <span class="keyword">return</span> (T) MetaEntryVersion.class; }
   ...
}

ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">String</span>&gt; readFuture = readOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, view -&gt; {
   <span class="comment">// The caller wants guarantees that the metadata parameter for version is numeric</span>
   <span class="comment">// e.g. to query the actual version information</span>
   Optional&lt;MetaEntryVersion&lt;<span class="predefined-type">Long</span>&gt;&gt; version = view.findMetaParam(MetaEntryVersion.type());
   <span class="keyword">return</span> view.get();
});</code></pre> </div> </div> <div class="paragraph"> <p>Finally, users are free to create new instances of metadata parameters to suit their needs. They are stored and retrieved in the very same way as done for the metadata parameters already provided by the functional map API.</p> </div> </div> <div class="sect2"> <h3 id="_invocation_parameter"><a class="anchor" href="#_invocation_parameter"></a>36.8. Invocation Parameter</h3> <div class="paragraph"> <p><a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/Param.html">Per-invocation parameters</a> are applied to regular functional map API calls to alter the behaviour of certain aspects. Adding per invocation parameters is done using the <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.html#withParams-org.infinispan.commons.api.functional.Param&#8230;&#8203;-"><code>withParams(Param&lt;?&gt;&#8230;&#8203;)</code></a> method.</p> </div> <div class="paragraph"> <p><a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/Param.FutureMode.html"><code>Param.FutureMode</code></a> tweaks whether a method returning a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html"><code>CompletableFuture</code></a> will span a thread to invoke the method, or instead will use the caller thread. By default, whenever a call is made to a method returning a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html"><code>CompletableFuture</code></a> , a separate thread will be span to execute the method asynchronously. However, if the caller will immediately block waiting for the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html"><code>CompletableFuture</code></a> to complete, spanning a different thread is wasteful, and hence <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/Param.FutureMode.html#COMPLETED"><code>Param.FutureMode.COMPLETED</code></a> can be passed as per-invocation parameter to avoid creating that extra thread. Example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.Param</span>.*;

ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...
ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMapCompleted = readOnlyMap.withParams(FutureMode.COMPLETED);
Optional&lt;<span class="predefined-type">String</span>&gt; readFuture = readOnlyMapCompleted.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, ReadEntryView::find).get();</code></pre> </div> </div> <div class="paragraph"> <p>Param.PersistenceMode controls whether a write operation will be propagated to a persistence store. The default behaviour is for all write-operations to be propagated to the persistence store if the cache is configured with a persistence store. By passing PersistenceMode.SKIP as parameter, the write operation skips the persistence store and its effects are only seen in the in-memory contents of the cache. PersistenceMode.SKIP can be used to implement an <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/Cache.html#evict-K-"><code>Cache.evict()</code></a> method which removes data from memory but leaves the persistence store untouched:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.Param</span>.*;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...
WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; skiPersistMap = writeOnlyMap.withParams(PersistenceMode.SKIP);
CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; removeFuture = skiPersistMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, WriteEntryView::remove);</code></pre> </div> </div> <div class="paragraph"> <p>Note that there&#8217;s no need for another PersistenceMode option to skip reading from the persistence store, because a write operation can skip reading previous value from the store by calling a write-only operation via the WriteOnlyMap.</p> </div> <div class="paragraph"> <p>Finally, new Param implementations are normally provided by the functional map API since they tweak how the internal logic works. So, for the most part of users, they should limit themselves to using the Param instances exposed by the API. The exception to this rule would be advanced users who decide to add new interceptors to the internal stack. These users have the ability to query these parameters within the interceptors.</p> </div> </div> <div class="sect2"> <h3 id="_functional_listeners"><a class="anchor" href="#_functional_listeners"></a>36.9. Functional Listeners</h3> <div class="paragraph"> <p>The functional map offers a listener API, where clients can register for and get notified when events take place. These notifications are post-event, so that means the events are received after the event has happened.</p> </div> <div class="paragraph"> <p>The listeners that can be registered are split into two categories: <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/Listeners.WriteListeners.html">write listeners</a> and <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/Listeners.ReadWriteListeners.html">read-write listeners</a>.</p> </div> <div class="sect3"> <h4 id="write_listeners"><a class="anchor" href="#write_listeners"></a>36.9.1. Write Listeners</h4> <div class="paragraph"> <p><a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/Listeners.WriteListeners.html">Write listeners</a> enable user to register listeners for any cache entry write events that happen in either a read-write or write-only functional map.</p> </div> <div class="paragraph"> <p>Listeners for write events cannot distinguish between cache entry created and cache entry modify/update events because they don&#8217;t have access to the previous value. All they know is that a new non-null entry has been written.</p> </div> <div class="paragraph"> <p>However, write event listeners can distinguish between entry removals and cache entry create/modify-update events because they can query what the new entry&#8217;s value via <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/EntryView.ReadEntryView.html#find--"><code>ReadEntryView.find()</code></a> method.</p> </div> <div class="paragraph"> <p>Adding a write listener is done via the WriteListeners interface which is accessible via both <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadWriteMap.html#listeners--"><code>ReadWriteMap.listeners()</code></a> and <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html#listeners--"><code>WriteOnlyMap.listeners()</code></a> method.</p> </div> <div class="paragraph"> <p>A write listener implementation can be defined either passing a function to <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/Listeners.WriteListeners.html#onWrite-java.util.function.Consumer-"><code>onWrite(Consumer&lt;ReadEntryView&lt;K, V&gt;&gt;)</code></a> method, or passing a WriteListener implementation to <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/Listeners.WriteListeners.html#add-org.infinispan.commons.api.functional.Listeners.WriteListeners.WriteListener-"><code>add(WriteListener&lt;K, V&gt;)</code></a> method. Either way, all these methods return an <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/AutoCloseable.html">AutoCloseable</a> instance that can be used to de-register the function listener:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.Listeners.WriteListeners.WriteListener</span>;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; woMap = ...

AutoCloseable writeFunctionCloseHandler = woMap.listeners().onWrite(written -&gt; {
   <span class="comment">// `written` is a ReadEntryView of the written entry</span>
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Written: %s%n</span><span class="delimiter">&quot;</span></span>, written.get());
});
AutoCloseable writeCloseHanlder = woMap.listeners().add(<span class="keyword">new</span> WriteListener&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;() {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> onWrite(ReadEntryView&lt;K, V&gt; written) {
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Written: %s%n</span><span class="delimiter">&quot;</span></span>, written.get());
   }
});

<span class="comment">// Either wrap handler in a try section to have it auto close...</span>
<span class="keyword">try</span>(writeFunctionCloseHandler) {
   <span class="comment">// Write entries using read-write or write-only functional map API</span>
   ...
}
<span class="comment">// Or close manually</span>
writeCloseHanlder.close();</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="read_write_listeners"><a class="anchor" href="#read_write_listeners"></a>36.9.2. Read-Write Listeners</h4> <div class="paragraph"> <p><a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/Listeners.ReadWriteListeners.html">Read-write listeners</a> enable users to register listeners for cache entry created, modified and removed events, and also register listeners for any cache entry write events.</p> </div> <div class="paragraph"> <p>Entry created, modified and removed events can only be fired when these originate on a read-write functional map, since this is the only one that guarantees that the previous value has been read, and hence the differentiation between create, modified and removed can be fully guaranteed.</p> </div> <div class="paragraph"> <p>Adding a read-write listener is done via the <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/Listeners.ReadWriteListeners.html"><code>ReadWriteListeners</code></a> interface which is accessible via <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadWriteMap.html#listeners--"><code>ReadWriteMap.listeners()</code></a> method.</p> </div> <div class="paragraph"> <p>If interested in only one of the event types, the simplest way to add a listener is to pass a function to either <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/Listeners.ReadWriteListeners.ReadWriteListener.html#onCreate-org.infinispan.commons.api.functional.EntryView.ReadEntryView-"><code>onCreate</code></a> , <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/Listeners.ReadWriteListeners.ReadWriteListener.html#onModify-org.infinispan.commons.api.functional.EntryView.ReadEntryView-org.infinispan.commons.api.functional.EntryView.ReadEntryView-"><code>onModify</code></a> or <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/Listeners.ReadWriteListeners.ReadWriteListener.html#onRemove-org.infinispan.commons.api.functional.EntryView.ReadEntryView-"><code>onRemove</code></a> methods. All these methods return an AutoCloseable instance that can be used to de-register the function listener:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;

ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; rwMap = ...
AutoCloseable createClose = rwMap.listeners().onCreate(created -&gt; {
   <span class="comment">// `created` is a ReadEntryView of the created entry</span>
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Created: %s%n</span><span class="delimiter">&quot;</span></span>, created.get());
});
AutoCloseable modifyClose = rwMap.listeners().onModify((before, after) -&gt; {
   <span class="comment">// `before` is a ReadEntryView of the entry before update</span>
   <span class="comment">// `after` is a ReadEntryView of the entry after update</span>
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Before: %s%n</span><span class="delimiter">&quot;</span></span>, before.get());
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">After: %s%n</span><span class="delimiter">&quot;</span></span>, after.get());
});
AutoCloseable removeClose = rwMap.listeners().onRemove(removed -&gt; {
   <span class="comment">// `removed` is a ReadEntryView of the removed entry</span>
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Removed: %s%n</span><span class="delimiter">&quot;</span></span>, removed.get());
});
AutoCloseable writeClose = woMap.listeners().onWrite(written -&gt; {
   <span class="comment">// `written` is a ReadEntryView of the written entry</span>
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Written: %s%n</span><span class="delimiter">&quot;</span></span>, written.get());
});
...
<span class="comment">// Either wrap handler in a try section to have it auto close...</span>
try(createClose) {
   <span class="comment">// Create entries using read-write functional map API</span>
   ...
}
<span class="comment">// Or close manually</span>
modifyClose.close();</code></pre> </div> </div> <div class="paragraph"> <p>If listening for two or more event types, it&#8217;s better to pass in an implementation of <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/Listeners.WriteListeners.WriteListener.html"><code>ReadWriteListener</code></a> interface via the <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/Listeners.ReadWriteListeners.html#add-org.infinispan.commons.api.functional.Listeners.ReadWriteListeners.ReadWriteListener-"><code>ReadWriteListeners.add()</code></a> method. <code>ReadWriteListener</code> offers the same <code>onCreate</code>/<code>onModify</code>/<code>onRemove</code> callbacks with default method implementations that are empty:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.Listeners.ReadWriteListeners.ReadWriteListener</span>;

ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; rwMap = ...
AutoCloseable readWriteClose = rwMap.listeners.add(<span class="keyword">new</span> ReadWriteListener&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;() {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> onCreate(ReadEntryView&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; created) {
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Created: %s%n</span><span class="delimiter">&quot;</span></span>, created.get());
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> onModify(ReadEntryView&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; before, ReadEntryView&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; after) {
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Before: %s%n</span><span class="delimiter">&quot;</span></span>, before.get());
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">After: %s%n</span><span class="delimiter">&quot;</span></span>, after.get());
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> onRemove(ReadEntryView&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; removed) {
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Removed: %s%n</span><span class="delimiter">&quot;</span></span>, removed.get());
   }
);
AutoCloseable writeClose = rwMap.listeners.add(<span class="keyword">new</span> WriteListener&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;() {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> onWrite(ReadEntryView&lt;K, V&gt; written) {
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Written: %s%n</span><span class="delimiter">&quot;</span></span>, written.get());
   }
);

<span class="comment">// Either wrap handler in a try section to have it auto close...</span>
<span class="keyword">try</span>(readWriteClose) {
   <span class="comment">// Create/update/remove entries using read-write functional map API</span>
   ...
}
<span class="comment">// Or close manually</span>
writeClose.close();</code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="marshalling_of_functions"><a class="anchor" href="#marshalling_of_functions"></a>36.10. Marshalling of Functions</h3> <div class="paragraph"> <p>Running functional map in a cluster of nodes involves marshalling and replication of the operation parameters under certain circumstances.</p> </div> <div class="paragraph"> <p>To be more precise, when write operations are executed in a cluster, regardless of read-write or write-only operations, all the parameters to the method and the functions are replicated to other nodes.</p> </div> <div class="paragraph"> <p>There are multiple ways in which a function can be marshalled. The simplest way, which is also the most costly option in terms of payload size, is to mark the function as <a href="http://docs.oracle.com/javase/8/docs/api/java/io/Serializable.html"><code>Serializable</code></a> :</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...

<span class="comment">// Force a function to be Serializable</span>
Consumer&lt;WriteEntryView&lt;<span class="predefined-type">String</span>&gt;&gt; function =
   (Consumer&lt;WriteEntryView&lt;<span class="predefined-type">String</span>&gt;&gt; &amp; <span class="predefined-type">Serializable</span>) wv -&gt; wv.set(<span class="string"><span class="delimiter">&quot;</span><span class="content">one</span><span class="delimiter">&quot;</span></span>);

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; writeFuture = writeOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, function);</code></pre> </div> </div> <div class="paragraph"> <p>A more economical way to marshall a function is to provide an Infinispan <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/marshall/Externalizer.html"><code>Externalizer</code></a> for it:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.marshall.Externalizer</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.marshall.SerializeFunctionWith</span>;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...

<span class="comment">// Force a function to be Serializable</span>
Consumer&lt;WriteEntryView&lt;<span class="predefined-type">String</span>&gt;&gt; function = <span class="keyword">new</span> SetStringConstant&lt;&gt;();
CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; writeFuture = writeOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, function);

<span class="annotation">@SerializeFunctionWith</span>(value = SetStringConstant.Externalizer0.class)
<span class="type">class</span> <span class="class">SetStringConstant</span> <span class="directive">implements</span> Consumer&lt;WriteEntryView&lt;<span class="predefined-type">String</span>&gt;&gt; {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> accept(WriteEntryView&lt;<span class="predefined-type">String</span>&gt; view) {
      view.set(<span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>);
   }

   <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">Externalizer0</span> <span class="directive">implements</span> Externalizer&lt;<span class="predefined-type">Object</span>&gt; {
      <span class="directive">public</span> <span class="type">void</span> writeObject(<span class="predefined-type">ObjectOutput</span> oo, <span class="predefined-type">Object</span> o) {
         <span class="comment">// No-op</span>
      }
      <span class="directive">public</span> <span class="predefined-type">Object</span> readObject(<span class="predefined-type">ObjectInput</span> input) {
         <span class="keyword">return</span> <span class="keyword">new</span> SetStringConstant&lt;&gt;();
      }
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>To help users take advantage of the tiny payloads generated by <code>Externalizer</code>-based functions, the functional API comes with a helper class called <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/marshall/MarshallableFunctions.html"><code>org.infinispan.commons.marshall.MarshallableFunctions</code></a> which provides marshallable functions for some of the most commonly user functions.</p> </div> <div class="paragraph"> <p>In fact, all the functions required to implement <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html"><code>ConcurrentMap</code></a> and <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>JCache</code></a> using the functional map API have been defined in <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/marshall/MarshallableFunctions.html"><code>MarshallableFunctions</code></a>. For example, here is an implementation of JCache&#8217;s <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java#L283"><code>boolean putIfAbsent(K, V)</code></a> using functional map API which can be run in a cluster:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.marshall.MarshallableFunctions</span>;

ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readWriteMap = ...

CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; future = readWriteMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1,
   MarshallableFunctions.setValueIfAbsentReturnBoolean());
future.thenAccept(stored -&gt; System.out.printf(</span><span class="delimiter">&quot;</span></span>Value was put? %s%n<span class="string"><span class="delimiter">&quot;</span><span class="content">, stored));</span></span></code></pre> </div> </div> </div> <div class="sect2"> <h3 id="use_cases_for_functional_api"><a class="anchor" href="#use_cases_for_functional_api"></a>36.11. Use cases for Functional API</h3> <div class="paragraph"> <p>This new API is meant to complement existing Key/Value Infinispan API offerings, so you&#8217;ll still be able to use <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html"><code>ConcurrentMap</code></a> or <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>JCache</code></a> standard APIs if that&#8217;s what suits your use case best.</p> </div> <div class="paragraph"> <p>The target audience for this new API is either:</p> </div> <div class="ulist"> <ul> <li> <p>Distributed or persistent caching/inÂ­memoryÂ­dataÂ­grid users that want to benefit from CompletableFuture and/or Traversable for async/lazy data grid or caching data manipulation. The clear advantage here is that threads do not need to be idle waiting for remote operations to complete, but instead these can be notified when remote operations complete and then chain them with other subsequent operations.</p> </li> <li> <p>Users wanting to go beyond the standard operations exposed by <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html"><code>ConcurrentMap</code></a> and <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>JCache</code></a> , for example, if you want to do a replace operation using metadata parameter equality instead of value equality, or if you want to retrieve metadata information from values&#8230;&#8203;etc. == Simple Cache</p> </li> </ul> </div> <div class="paragraph"> <p>Traditional local caches use the same architecture as clustered caches - interceptor stack. That way a lot of the implementation can be reused. However, if the advanced features are not needed and the performance is more important, the interceptor stack can be stripped away and simple cache can be used.</p> </div> <div class="paragraph"> <p>So, which features are stripped away? From the configuration perspective, simple cache does not support:</p> </div> <div class="ulist"> <ul> <li> <p>transactions and invocation batching</p> </li> <li> <p>persistence (cache stores and loaders)</p> </li> <li> <p>custom interceptors (there&#8217;s no interceptor stack!)</p> </li> <li> <p>indexing</p> </li> <li> <p>compatibility (embedded/server mode)</p> </li> <li> <p>store as binary (which is hardly useful for local caches)</p> </li> </ul> </div> <div class="paragraph"> <p>From the API perspective these features throw an exception:</p> </div> <div class="ulist"> <ul> <li> <p>adding custom interceptors</p> </li> <li> <p>Map Reduce Framework</p> </li> <li> <p>Distributed Executors Framework</p> </li> </ul> </div> <div class="paragraph"> <p>So, what&#8217;s left?</p> </div> <div class="ulist"> <ul> <li> <p>basic map-like API</p> </li> <li> <p>cache listeners (local ones)</p> </li> <li> <p>expiration</p> </li> <li> <p>eviction</p> </li> <li> <p>security</p> </li> <li> <p>JMX access</p> </li> <li> <p>statistics (though for max performance it is recommended to switch this off using statistics-available=false)</p> </li> </ul> </div> </div> <div class="sect2"> <h3 id="declarative_configuration"><a class="anchor" href="#declarative_configuration"></a>36.12. Declarative configuration</h3> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml">Â Â  <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mySimpleCache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">simple-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- expiration, eviction, security... --&gt;</span>
Â Â  <span class="tag">&lt;/local-cache&gt;</span></code></pre> </div> </div> </div> <div class="sect2"> <h3 id="programmatic_configuration"><a class="anchor" href="#programmatic_configuration"></a>36.13. Programmatic configuration</h3> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">CacheManager cm = getCacheManager();
ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder().simpleCache(<span class="predefined-constant">true</span>);
cm.defineConfiguration(<span class="string"><span class="delimiter">&quot;</span><span class="content">mySimpleCache</span><span class="delimiter">&quot;</span></span>, builder.build());
Cache cache = cm.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">mySimpleCache</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>Simple cache checks against features it does not support, if you configure it to use e.g. transactions, configuration validation will throw an exception.</p> </div> </div> </div> </div> </div> <div id="footer"> <div id="footer-text"> Last updated 2017-06-21 03:03:06 EDT </div> </div> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-8601422-1', 'auto');
  ga('send', 'pageview');

</script> </body> </html>